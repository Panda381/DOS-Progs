
;                              KIR_LINK.COM

; Program KIR_LINK.COM prov d¡ instalaci rezidentn¡ho driveru do pamˆti pro
; obsluhu spojen¡ s jin˜mi po‡¡ta‡i pomoc¡ standardn¡ch port– COM.
; Za specifikac¡ v p©¡kazov‚m © dku lze uv‚st tyto volby:
;     COMx       - ‡¡slo komun. portu (x=1 a‘ 8) (automat. COM1)
;     INTxx      - ‡¡slo p©eru¨. od portu (xx=12,11, pop©.10,13,14,15)(st.INT12)
;     /x         - p©enos. rychlost (x=1 a‘ 127) = 115200/x Baud (stand. x=1)
;     SHARE:xxx  - sd¡len‚ disky (seznam disk– bez mezer-max. 16, stand. A a‘ P)
;     DEBUG      - ladic¡ re‘im, zobrazuj¡ se chybov  hl ¨en¡
;     SERVER     - ozna‡en¡ po‡¡ta‡e jako ©¡dic¡ (mus¡ b˜t jeden z po‡¡ta‡–)
;     FIX:1      - opakovan  inicializace portu COM (lich‚ ‡¡slo)
;     PARITY     - kontrola paritou (pro p©enos se pou‘ije sud  parita)
;    (OUT12:x    - nastaven¡ ©¡dic¡ho registru modemu-sign ly OUT)
;    (DSR:x      - stavov˜ registr modemu-maska sign lu DDSR)
;    (DTR:x      - ©¡dic¡ registr modemu-maska sign lu DTR)

0100  e9022f         jmp    3005                 ; instalace programu

0103                 db     40h                  ; parametry programu
                                                 ; bit 6: 1=zobraz¡ s‚riov.‡¡slo
                                                 ; bit 7: 1=inicial. videom¢du

                                               ;* £vodn¡ text - r me‡ek
0110               * db     201,21 dup(205),187,13,10             ; horn¡ linka
0129                 db     186,'   KIRSCHBAUM-LINK   ',186,13,10 ; 2. © dek
0142                 db     186,'   Version 2.07 D    ',186,13,10 ; 3. © dek
015b                 db     200,21 dup(205),188,13,10             ; spodn¡ linka
                     db     0

0175                 db     151 dup(" ")
                     db     13,10
                     db     0

                                               ;* text copyright
020f               * db     '(c) 1987-1989 Information Modes',13,10
                     db     '(c) 1988-1989 Kirschbaum Software GmbH',13,10
                     db     0

0259                 db     13,10,0              ; text od© dkov n¡

                                               ;* s‚riov‚ ‡¡slo
025c               * db     'Serial# '
0264               * db     'KB1000018454',13,10,0

0273                 db     'N$25v2.3 6/29/89',0

0284                 db     ']/',131,'K7K',34
                     db     'K',171,'P\/\/\/\ '
                     db     'NOTICE: Author & Owner, '
                     db     'Don Jindra, '
                     db     '817-387-3339 USA '
                     db     '/\/\/\/\',0


02d4                 dd     0                    ; £schova adresy INT 08h
02d8                 dd     0                    ; £schova adresy INT 09h
02dc                 dd     0                    ; £schova adresy INT 13h
02e0                 dd     0                    ; £schova adresy INT 15h
02e4                 dd     0                    ; £schova adresy INT 1ch
02e8                 dd     0                    ; £schova adresy INT 21h
02ec                 dd     0                    ; £schova adresy INT 28h
02f0                 dd     0                    ; £schova adresy INT 5ch
02f4                 dd     0                    ; star  adresa vektoru COMx

02f8                 dd     0                    ; obsluha zp©¡stupnˆn¡ disku
                                                 ; (aktivace pomoc¡ INT 1ch)

0300   12 00 03 09 00 00 00 00 00 00 F8 03 00 00 00 00   ................

0300                 db     12h                  ; ‡¡ta‡ ‡asu pro inicial. portu
0301                 db     0                    ; bit 0: parametr FIX
0302                 db     3                    ; doba pro TIME-OUT
0303                 db     9                    ; doba pro TIME-OUT p©enosu
0304                 db     0                    ; ‡¡ta‡ pro TIME-OUT
0305                 db     0                    ; ‡¡ta‡ pro TIME-OUT
0307                 db     0                    ; ‡¡ta‡ pro TIME-OUT

030a                 dw     03f8h                ; adresa portu COM

030c                 db     0                    ; bit 0: 1=p©¡znak re‘imu DEBUG
                                                 ; bit 1: 1=prob¡h  DEBUG

030d                 dw     0                    ; ‡¡slo portu COM (0=COM1)

030f                 db     0                    ; bit 0: 1=p©¡znak SERVER

0310                 dw     0800h                ; max. d‚lka p©en ¨en‚ho bloku

0312                 dw     0800h                ; maxim ln¡ d‚lka sektoru

0310   00 08 00 08 03 00 00 00 00 00 00 21 25 00 00 00   ...........!%...

0314                 dw     0003h                ; verze oper. syst‚mu (=3.00)
0316                 db     0                    ; verze oper. syst‚mu * 2
                                                 ; bit 0:
0317                 db     0
0318                 db     0                    ; bit 1: 1=p©¡stup k ‡ sti dis.
                                                 ; bit 2: 1=p©enos velk‚ho disku
                                                 ; bit 6: 1=je p©¡stup COMPAQ
                                                 ; bit 7: 1=p©¡m˜ p©¡stup DOS 4.00

0319                 dw     0                    ; segment driveru NETUNITS.SYS

031b                 dw     2521h                ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
031d                 db     0                    ; bit 0: proveden reset disku
                                                 ; bit 1: je TIME-OUT
                                                 ; bit 2: po‘aduje se reset
                                                 ; bit 5: je TIME-OUT

031e                 db     0                    ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
031f                 db     0                    ; p©¡znak: bit 0=je INT 13h
                                                 ;          bit 1=po‘ad.op.s COM
0320                 db     0
0321                 db     0                    ; 1=p©¡znak testu INT 28h

0322                 dd     0                    ; adresa p©¡znaku aktivity funkce DOS


0320   00 00 00 00 00 00 6D 70 22 29 03 25 77 2D CD 20   ......mp").%w-.
0330   67 2D B6 2C 00 FA 2E F6 06 21 03 FF 75 6A 2E F6   g-.,.....!..uj..

0334                 db     0                    ; ‡¡slo funkce pro DOS INT 21h

; *****************************************************************************
;
;                         Obsluha p©eru¨en¡ INT
;
; *****************************************************************************




; -----------------------------------------------------------------------------
;                    Obsluha p©enosu aktivac¡ z INT 28h
; -----------------------------------------------------------------------------
0335                                           ;* vlastn¡ obsluha INT 28h
                                                 ; (‡asov n¡ £sek– DOS)
                                                 ; - toto p©eru¨en¡ vyvol  DOS
                                                 ; v‘dy, kdy‘ ‡ek  p©i funkc¡ch
                                                 ; men¨¡ch ne‘ 0ch na p©¡chod vnˆj¨¡
                                                 ; ud losti (nap©. stisk kl vesy)
                                                 ; - pou‘¡v  se pro dal¨¡ obsluhu
                                                 ; komunikace (vyvol n¡ SI+0bh)

0335  fa             cli                         ; z kaz p©eru¨en¡
0336  2ef6062103ff   test   cs:[0321],ff         ; 1=p©¡znak testu INT 28h
033c  756a           jnz    03a8                 ; obsluha INT 28h ji‘ prob¡h 
033e  2ef6061e0303   test   cs:[031e],03         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡ ?
0344  7531           jnz    0377                 ; byla chyba operace
0346  2ef6061d0304   test   cs:[031d],04         ; po‘aduje se reset disku ?
034c  7429           jz     0377
                                               ;* resetov n¡ diskov‚ho syst‚mu
034e  2e80261d03fb   and    cs:[031d],fb         ; zru¨en¡ po‘adavku resetov n¡ disku
0354  2e800e1d0301   or     cs:[031d],01         ; p©¡znak, ‘e byl reset
035a  50             push   ax                   ; £schova k¢du povelu
035b  9c             pushf
035c  b40d           mov    ah,0d                ; funkce resetov n¡ disku
035e  2eff1ee802     call   far cs:[02e8]        ; obsluha INT 21h - reset disku
0363  2e80261d03fb   and    cs:[031d],fb         ; zru¨en¡ po‘adavku pro reset
0369  2e800e1d0301   or     cs:[031d],01         ; p©¡znak, ‘e byl reset
036f  2e800e1d0380   or     cs:[031d],80         ; proveden reset
0375  58             pop    ax
0376  fa             cli

0377  2ef6062103ff * test   cs:[0321],ff         ; 1=p©¡znak testu INT 28h
037d  7529           jnz    03a8                 ; prob¡h  ji‘ obsluha INT 28h
037f  2ef6061d0320   test   cs:[031d],20         ; p©¡znak TIME-OUT
0385  7508           jnz    038f
0387  2ef6060703ff   test   cs:[0307],ff         ; ‡¡ta‡ pro TIME-OUT
038d  7519           jnz    03a8
038f  56           * push   si                   ; £schova SI
0390  2e8b361b03     mov    si,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
0395  2ef6440201   * test   cs:[si+02],01
039a  7514           jnz    03b0                 ; test modifikace programu
039c  2e8b74fc       mov    si,cs:[si-04]
03a0  2e3b361b03     cmp    si,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
03a5  75ee           jnz    0395                 ; nalezen¡ aktu ln¡ tabulky
03a7  5e             pop    si                   ; n vrat SI
03a8  2eff2eec02   * jmp    far cs:[02ec]        ; p–vodn¡ obsluha INT 28h

                                               ;* test modifikace licen‡. text–
03ad  fb           * sti                         ; povolen¡ p©eru¨en¡
03ae  75fd           jnz    03ad                 ; zablokov n¡ programu
03b0  2efe062103   * inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
03b5  fb             sti                         ; povolen¡ p©eru¨en¡
03b6  2e813eae02446f cmp    cs:[02ae],6f44       ; byla zmˆna licence ("Do") ?
03bd  75ee           jnz    03ad                 ; chyba - program modifikov n
03bf  2e813eb2024a69 cmp    cs:[02b2],694a       ; test textu "Ji"
03c6  75e5           jnz    03ad                 ; chyba - program modifikov n
03c8  2e813eba023831 cmp    cs:[02ba],3138       ; test textu "81"
03cf  75dc           jnz    03ad                 ; chyba - program modifikov n
03d1  2e813ec4023339 cmp    cs:[02c4],3933       ; test textu "39"
03d8  75d3           jnz    03ad                 ; chyba - program modifikov n

                                               ;* obsluha komunikace
03da  2eff5c0b       call   far cs:[si+0b]       ; obsluha dal¨¡ho vys¡l n¡/p©¡jmu
03de  5e             pop    si                   ; n vrat SI
03df  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
03e4  2eff2eec02     jmp    far cs:[02ec]        ; p–vodn¡ obsluha INT 28h

; -----------------------------------------------------------------------------
;                    Obsluha p©enosu aktivac¡ z INT 21h
; -----------------------------------------------------------------------------
                                               ;* obsluha INT 21h

03e9  50             push   ax                   ; AH=‡¡slo funkce
03ea  9c             pushf                       ; £schova registru p©¡znak–
03eb  2e88263403     mov    cs:[0334],ah         ; ‡¡slo funkce pro DOS INT 21h
03f0  2ef6061d0304   test   cs:[031d],04         ; po‘aduje se reset disku ?
03f6  7430           jz     0428                 ; nepo‘aduje se reset disku
03f8  2ef6061e0303   test   cs:[031e],03         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
03fe  7528           jnz    0428                 ; je chyba operace
                                               ;* resetov n¡ diskov‚ho syst‚mu
0400  50             push   ax                   ; £schova AX
0401  2e80261d03fb   and    cs:[031d],fb         ; zru¨en¡ po‘adavku resetu disku
0407  2e800e1d0301   or     cs:[031d],01
040d  b40d           mov    ah,0d                ; funkce resetov n¡ disku
040f  9c             pushf
0410  2eff1ee802     call   far cs:[02e8]        ; obsluha INT 21h - resetov n¡ disku
0415  2e80261d03fb   and    cs:[031d],fb         ; zru¨en¡ po‘adavku resetu disku
041b  2e800e1d0301   or     cs:[031d],01
0421  2e800e1d0380   or     cs:[031d],80
0427  58             pop    ax                   ; n vrat AX

0428  2ef6060703ff * test   cs:[0307],ff         ; ‡¡ta‡ pro TIME-OUT
042e  7508           jnz    0438
0430  2ef6060403ff   test   cs:[0304],ff         ; ‡¡ta‡ pro TIME-OUT
0436  7426           jz     045e
0438  2ef6061d0320 * test   cs:[031d],20         ; p©¡znak TIME-OUT
043e  7511           jnz    0451

0440  53             push   bx
0441  8adc           mov    bl,ah                ; ‡¡slo funkce
0443  81e37f00       and    bx,007f              ; ‡¡slo funkce DOS
0447  2ef687cd2001   test   cs:[bx+20cd],01      ; lze vyvol vat obsluhu z funkce DOS ?
044d  90             nop
044e  5b             pop    bx
044f  740d           jz     045e                 ; nen¡ z kaz vyvol v n¡ obsluhy

0451  2e800e1d0308 * or     cs:[031d],08
0457  9d             popf                        ; n vrat registru p©¡znak–
0458  58             pop    ax                   ; n vrat AX
0459  2eff2ee802     jmp    far cs:[02e8]        ; vol n¡ obsluhy INT 21h

045e  9d           * popf
045f  58             pop    ax
0460  9c           * pushf
0461  2e80261d03f7   and    cs:[031d],f7
0467  fa             cli
0468  2ef6061d0302   test   cs:[031d],02         ; p©¡znak TIME-OUT
046e  7415           jz     0485
0470  2e803e070300   cmp    cs:[0307],00         ; ‡¡ta‡ pro TIME-OUT
0476  750a           jnz    0482
0478  50             push   ax
0479  2ea00203       mov    al,cs:[0302]         ; doba pro TIME-OUT
047d  2ea20703       mov    cs:[0307],al         ; ‡¡ta‡ pro TIME-OUT
0481  58             pop    ax
0482  eb43         * jmp    04c7
0484  90             nop
0485  56           * push   si
0486  2e8b361b03     mov    si,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
048b  fa           * cli
048c  2ef6440201     test   cs:[si+02],01        ; vy‘aduje se obsluha ?
0491  750f           jnz    04a2
0493  fb             sti
0494  2e8b74fc       mov    si,cs:[si-04]        ; adresa dal¨¡ obsluhy
0498  2e3b361b03     cmp    si,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
049d  75ec           jnz    048b                 ; nen¡ posledn¡ - dal¨¡
049f  eb11           jmp    04b2                 ; nevy‘aduje se obsluha
04a1  90             nop
04a2  fb           * sti
04a3  fa             cli
04a4  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
04a9  2eff5c0b       call   far cs:[si+0b]       ; p©esmˆrov n¡ za©¡zen¡
04ad  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
04b2  5e           * pop    si
04b3  fb             sti
04b4  2ef6060403ff   test   cs:[0304],ff         ; ‡¡ta‡ pro TIME-OUT
04ba  740b           jz     04c7
04bc  2ef6061d0320   test   cs:[031d],20         ; p©¡znak TIME-OUT
04c2  7503           jnz    04c7
04c4  9d             popf
04c5  eb99           jmp    0460
04c7  2e80261d03fe * and    cs:[031d],fe
04cd  2e800e1d0308   or     cs:[031d],08
04d3  9d             popf
04d4  2eff2ee802     jmp    far cs:[02e8]        ; vol n¡ obsluhy INT 21h

; -----------------------------------------------------------------------------
;                          Obsluha INT 1ch
;
;           Slou‘¡ k aktivaci zp©¡stupnˆn¡ vlastn¡ho disku
;
; -----------------------------------------------------------------------------
                                               ;* vlastn¡ obsluha INT 1ch
                                                 ; (u‘ivatelsk˜ ‡asova‡)

04d9  fa             cli
04da  1e             push   ds
04db  53             push   bx

                                               ;* tato ‡ st je nadbyte‡n 
04dc  2e8a1e8906     mov    bl,cs:[0689]         ; po‘adovan  konstanta
04e1  2e881e8a06     mov    cs:[068a],bl         ; porovn van  konstanta

                                               ;* opakovan  inicializace portu
04e6  2ef606010301   test   cs:[0301],01         ; parametr FIX
04ec  7410           jz     04fe                 ; nen¡ po‘adavek FIX
04ee  2efe0e0003     dec    b/cs:[0300]          ; sn¡‘en¡ ‡¡ta‡e pro inicial.
04f3  7909           jns    04fe                 ; nevy‘aduje se je¨tˆ inicial.
04f5  2ec60600035a   mov    cs:[0300],5a         ; ‡as pro inicializaci 5 sekund
04fb  e88029         call   2e7e                 ; inicial. s‚riov‚ho portu COM

                                               ;* obsluha TIME-OUT
04fe  2e803e070300 * cmp    cs:[0307],00         ; ‡¡ta‡ pro TIME-OUT
0504  7413           jz     0519                 ; byl ji‘ TIME-OUT
0506  2efe0e0703     dec    b/cs:[0307]          ; ‡¡ta‡ pro TIME-OUT
050b  750c           jnz    0519                 ; nen¡ je¨tˆ TIME-OUT
050d  2e80261d03fd   and    cs:[031d],fd         ; p©¡znak TIME-OUT
0513  2e80261d03df   and    cs:[031d],df         ; p©¡znak TIME-OUT

                                               ;* obsluha TIME-OUT
0519  2e803e040300 * cmp    cs:[0304],00         ; ‡¡ta‡ pro TIME-OUT
051f  7413           jz     0534                 ; byl ji‘ TIME-OUT
0521  2efe0e0403     dec    b/cs:[0304]          ; ‡¡ta‡ pro TIME-OUT
0526  750c           jnz    0534                 ; nen¡ je¨tˆ TIME-OUT
0528  2e80261d03df   and    cs:[031d],df         ; p©¡znak TIME-OUT
052e  2e80261d03fd   and    cs:[031d],fd         ; p©¡znak TIME-OUT

                                               ;* obsluha TIME-OUT
0534  2e803e050300 * cmp    cs:[0305],00         ; ‡¡ta‡ pro TIME-OUT
053a  7424           jz     0560                 ; byl ji‘ TIME-OUT
053c  2efe0e0503     dec    b/cs:[0305]          ; sn¡‘en¡ ‡¡ta‡e TIME-OUT
0541  751d           jnz    0560                 ; nen¡ je¨tˆ TIME-OUT
0543  2ef6061d0310   test   cs:[031d],10
0549  740f           jz     055a
054b  2ec606050306   mov    cs:[0305],06         ; ‡¡ta‡ pro TIME-OUT
0551  2e80261d03ef   and    cs:[031d],ef
0557  eb07           jmp    0560
0559  90             nop
055a  2e800e1d0304 * or     cs:[031d],04         ; p©¡znak TIME-OUT


0560  2ec51e2203   * lds    bx,cs:[0322]         ; adresa p©¡znaku aktivity DOS
0565  803f00         cmp    [bx],00              ; je mo‘n‚ vyvolat funkci DOS ?
0568  5b             pop    bx
0569  1f             pop    ds
056a  7532           jnz    059e                 ; nen¡ mo‘n‚ vyvolat funkci DOS
056c  2ef6061d0308   test   cs:[031d],08
0572  742a           jz     059e
0574  2ef6060703ff   test   cs:[0307],ff         ; ‡¡ta‡ pro TIME-OUT
057a  7522           jnz    059e
057c  fa             cli
057d  2ef606200301   test   cs:[0320],01
0583  7519           jnz    059e
0585  2ef606a706ff   test   cs:[06a7],ff         ; prob¡h  obsluha p©eru¨en¡ kl vesnice ?
058b  90             nop
058c  7510           jnz    059e                 ; prob¡h  obsluha p©eru¨en¡ kl vesnice
058e  2ef6061f0301   test   cs:[031f],01         ; bit 0=prob¡h  INT 13h
0594  7508           jnz    059e                 ; prob¡h  INT 13h
0596  2e803e210300   cmp    cs:[0321],00         ; 1=p©¡znak testu INT 28h
059c  7403           jz     05a1                 ; neprob¡h  obsluha s¡Ÿov‚ho za©¡zen¡
059e  e99d00       * jmp    063e                 ; neprovede se obsluha


05a1  2e800e200301 * or     cs:[0320],01
05a7  2ef6061e0303   test   cs:[031e],03         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
05ad  7543           jnz    05f2
05af  2ef6061d0304   test   cs:[031d],04
05b5  743b           jz     05f2
05b7  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
05bc  2e80261d03fb   and    cs:[031d],fb
05c2  2e800e1d0301   or     cs:[031d],01

                                               ;* uvolnˆn¡ ©adi‡e p©eru¨en¡
05c8  50             push   ax
05c9  52             push   dx
05ca  ba2000         mov    dx,0020
05cd  8ac2           mov    al,dl
05cf  ee             out    dx,al                ; uvolnˆn¡ p©eru¨en¡
05d0  5a             pop    dx

                                               ;* resetov n¡ disku
05d1  9c             pushf
05d2  b40d           mov    ah,0d                ; funkce resetov n¡ disku
05d4  2eff1ee802     call   far cs:[02e8]        ; obsluha INT 21h - resetov n¡ disku
05d9  58             pop    ax

05da  fa             cli
05db  2e80261d03fb   and    cs:[031d],fb
05e1  2e800e1d0301   or     cs:[031d],01
05e7  2e800e1d0380   or     cs:[031d],80
05ed  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h

                                               ;* ‡ek n¡ na dokon‡en¡ operace
05f2  56           * push   si
05f3  2e8b361b03     mov    si,cs:[031b]         ; adresa tabulky param. p©¡jmu
05f8  2ef6440201   * test   cs:[si+02],01
05fd  7512           jnz    0611
05ff  2e8b74fc       mov    si,cs:[si-04]
0603  2e3b361b03     cmp    si,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
0608  75ee           jnz    05f8
060a  5e             pop    si
060b  eb31           jmp    063e
060d  90             nop

                                               ;* kontrola licen‡n¡ch informac¡
060e  fb           * sti
060f  75fd           jnz    060e                 ; program byl modifikov n
0611  2e813eb4026e64*cmp    cs:[02b4],646e       ;
0618  75f4           jnz    060e
061a  2e813eb6027261 cmp    cs:[02b6],6172
0621  75eb           jnz    060e
0623  fa             cli

0624  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h

                                               ;* uvolnˆn¡ ©adi‡e p©eru¨en¡
0629  50             push   ax
062a  52             push   dx
062b  ba2000         mov    dx,0020
062e  8ac2           mov    al,dl
0630  ee             out    dx,al
0631  5a             pop    dx
0632  58             pop    ax

0633  2eff5c0b       call   far cs:[si+0b]       ; p©esmˆrov n¡ za©¡zen¡
0637  fa             cli
0638  5e             pop    si
0639  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h

                                               ;* ukon‡en¡ obsluhy INT 1ch
063e  fa           * cli
063f  2e80262003fe   and    cs:[0320],fe
0645  2ef6068b0601   test   cs:[068b],01         ; 01=je nˆjak  akce ‡asova‡e ?
064b  90             nop
064c  7505           jnz    0653                 ; prob¡h  nˆjak  akce
064e  2eff2ee402     jmp    far cs:[02e4]        ; vol n¡ obsluhy INT 1ch

0653  cf           * iret

; -----------------------------------------------------------------------------
;                           obsluha INT 08h
;
;            Obsluha zp©¡stup¤uje disk pro extern¡ po‡¡ta‡e
; -----------------------------------------------------------------------------

0654                                             ; vlastn¡ obsluha INT 08h
                                                 ; (syst‚mov‚ hodiny)

                                               ;* tato ‡ st je nadbyte‡n 
0654  50             push   ax                   ; £schova AX
0655  2ea08906       mov    al,cs:[0689]         ; po‘adovan  konstanta
0659  2e3a068a06     cmp    al,cs:[068a]         ; byla funkce INT 1Ch ?
065e  58             pop    ax                   ; n vrat AX
065f  741e           jz     067f                 ; INT 1Ch ji‘ probˆhla

                                               ;* prob¡h  ji‘ obsluha funkce ?
0661  fa             cli
0662  2ef6068b0601   test   cs:[068b],01         ; 01=p©¡znak, ‘e akce prob¡h 
0668  90             nop
0669  7514           jnz    067f                 ; nˆjak  akce ji‘ prob¡h 

066b  2e800e8b0601   or     cs:[068b],01         ; 01=p©¡znak, ‘e akce prob¡h 
0671  90             nop
0672  9c             pushf                       ; simulace vol n¡ INT x
0673  2eff1ef802     call   far cs:[02f8]        ; obsluha zp©¡stupnˆn¡ disku
0678  2e80268b06fe   and    cs:[068b],fe         ; 00=p©¡znak, ‘e neprob¡h  akce
067e  90             nop

067f  2efe068906   * inc    b/cs:[0689]          ; zv˜¨en¡ porov vac¡ konstanty
0684  2eff2ed402     jmp    far cs:[02d4]        ; p–vodn¡ obsluha INT 08h

0689                 db     0                    ; ‡¡ta‡ ‡asu
068a                 db     0                    ; porov van  konstanta
068b                 db     0                    ; 01=p©¡znak, ‘e prob¡h  akce

; -----------------------------------------------------------------------------
;                      Monitorov n¡ obsluhy INT 09h
;
;         Tato obsluha slou‘¡ pouze k monitorov n¡ obsluhy INT 9
;
; -----------------------------------------------------------------------------
068c                                             ; vlastn¡ obsluha INT 09h
                                                 ; (p©eru¨en¡ od kl vesnice)

068c  2ef606a706ff   test   cs:[06a7],ff         ; prob¡h  obsluha kl vesnice ?
0692  90             nop
0693  7400           jz     0695                 ; neprob¡h  obsluha kl vesnice
0695  2efe06a706   * inc    b/cs:[06a7]          ; nastaven¡ p©¡znaku obsluhy
069a  9c             pushf                       ; simulace vol n¡ INT x
069b  2eff1ed802     call   far cs:[02d8]        ; p–vodn¡ obsluha INT 09h
06a0  fa             cli                         ; z kaz p©eru¨en¡
06a1  2efe0ea706     dec    b/cs:[06a7]          ; zru¨en¡ p©¡znaku obsluhy
06a6  cf             iret

06a7                 db     0                    ; p©¡znak obsluhy INT 09h

; -----------------------------------------------------------------------------
;                    Obsluha diskov˜ch operac¡ INT 13h
;
;        Tato obsluha monitoruje obsluhu INT 13h. Pokud byl bˆhem obsluhy
;     INT 13h p©ijat znak 1dh (po‘adavek na p©¡jem zpr vy), provede se tato
;          obsluha p©¡jmu dodate‡nˆ a‘ po ukon‡en¡ obsluhy INT 13h.
;
; -----------------------------------------------------------------------------

06a8                                           ;* vlastn¡ obsluha INT 13h
                                                 ; (diskov‚ operace)

                                               ;* p©¡znaky obsluhy
06a8  9c             pushf
06a9  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
06ae  2e800e1f0301   or     cs:[031f],01         ; p©¡znak - prob¡h  INT 13h
06b4  9d             popf

                                               ;* p–vodn¡ obsluha INT 13h
06b5  9c             pushf
06b6  2eff1edc02     call   far cs:[02dc]        ; p–vodn¡ obsluha INT 13h

                                               ;* test, zda se po‘aduje obsluha
06bb  9c             pushf
06bc  fa             cli
06bd  2e80261f03fe   and    cs:[031f],fe         ; p©¡znak - konec INT 13h
06c3  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
06c8  2ef6061f0302   test   cs:[031f],02         ; po‘adovan  operace s COM ?
06ce  7424           jz     06f4                 ; nen¡ po‘adovan 

                                               ;* p©¡jem paketu z COM
06d0  50             push   ax
06d1  53             push   bx
06d2  51             push   cx
06d3  52             push   dx
06d4  57             push   di
06d5  56             push   si
06d6  1e             push   ds
06d7  06             push   es
06d8  8cca           mov    dx,cs
06da  8eda           mov    ds,dx                ; DS <- CS
06dc  8ec2           mov    es,dx                ; ES <- CS
06de  8b160a03       mov    dx,[030a]            ; adresa portu COM
06e2  fc             cld
06e3  e87820         call   275e                 ; p©¡jem paketu z COM (adr. DX)
06e6  2e80261f03fd   and    cs:[031f],fd         ; zru¨en¡ po‘adavku p©¡jmu
06ec  07             pop    es
06ed  1f             pop    ds
06ee  5e             pop    si
06ef  5f             pop    di
06f0  5a             pop    dx
06f1  59             pop    cx
06f2  5b             pop    bx
06f3  58             pop    ax

06f4  9d           * popf                        ; n vrat registru p©¡znak–
06f5  ca0200         ret    far  0002            ; n vrat s ponech n¡m p©¡znak–

; -----------------------------------------------------------------------------
;                          Obsluha INT 15h
;
;         Tato obsluha nem  ‘ dn˜ £‡inek (a ani se neinstaluje)
;
; -----------------------------------------------------------------------------

06f8                                             ; vlastn¡ obsluha INT 15h
                                                 ; (roz¨i©uj¡c¡ a kazet. slu‘by)

06f8  9c             pushf
06f9  9d             popf
06fa  2eff2ee002     jmp    far cs:[02e0]        ; p–vodn¡ obsluha INT 15h


; *****************************************************************************
;
;                     Obsluha po‘adavku od vzd len‚ho po‡¡ta‡e
;                          (zve©ejnˆn¡ vlastn¡ho disku)
;
; *****************************************************************************



; -----------------------------------------------------------------------------
;
; -----------------------------------------------------------------------------

                                               ;* p©¡prava operace se za©¡zen¡m

06ff  2ec60600035a * mov    cs:[0300],5a         ; ‡¡ta‡ ‡asu pro inicializaci
0705  c47c03         les    di,[si+03]           ; adresa vˆty pro p©enos
0708  26807d0164     cmp    es:[di+01],64        ; je identifikace vˆty (=100) ?
070d  753b           jnz    074a                 ; nespr vn  identifikace vˆty
070f  26807d090d     cmp    es:[di+09],0d        ; max. ‡¡slo operace = 13 ?
0714  7334           jnc    074a                 ; velk‚ ‡¡slo operace - chyba
0716  33db           xor    bx,bx
0718  268a5d08       mov    bl,es:[di+08]        ; doba pro TIME-OUT
071c  d1e3           shl    bx,1
071e  80e33f         and    bl,3f
0721  2e881e0403     mov    cs:[0304],bl         ; ‡¡ta‡ pro TIME-OUT
0726  d0e7           shl    bh,1
0728  2e80261d03fd   and    cs:[031d],fd         ; p©¡znak TIME-OUT
072e  2e083e1d03     or     cs:[031d],bh
0733  d0e7           shl    bh,1
0735  d0e7           shl    bh,1
0737  2e083e1d03     or     cs:[031d],bh
073c  c7440b5f07     mov    [si+0b],075f         ; adresa obsluhy operace se za©¡zen¡m
0741  8c4c0d         mov    [si+0d],cs           ; segment pro obsluhu
0744  804c0201       or     [si+02],01
0748  f8             clc
0749  cb             ret    far

074a  e8cf13       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

074d                 db     'bad reot',7,10,13,0

0759  f9             stc
075a  c6440200       mov    [si+02],00
075e  cb             ret    far


                                               ;* obsluha za©¡zen¡

075f  9c             pushf                       ; £schova registru p©¡znak–
0760  fa             cli                         ; z kaz p©eru¨en¡
0761  2e8926d407     mov    cs:[07d4],sp         ; £schova ukazatele z sobn¡ku
0766  2e8c16d607     mov    cs:[07d6],ss         ; £schova segmentu z sobn¡ku
076b  8ccc           mov    sp,cs                ; SP <- CS
076d  8ed4           mov    ss,sp                ; SS <- SP
076f  bc9e08         mov    sp,089e              ; vlastn¡ adresa z sobn¡ku
0772  50             push   ax                   ; £schova AX
0773  53             push   bx                   ; £schova BX
0774  51             push   cx                   ; £schova CX
0775  52             push   dx                   ; £schova DX
0776  57             push   di                   ; £schova DI
0777  56             push   si                   ; £schova SI
0778  06             push   es                   ; £schova ES
0779  1e             push   ds                   ; £schova DS
077a  8ccf           mov    di,cs                ; DI <- CS
077c  8edf           mov    ds,di                ; DS <- CS
077e  806402fe       and    [si+02],fe           ; zru¨en¡ po‘adavku obsluhy
0782  c7440bff06     mov    [si+0b],06ff         ; adresa p©¡pravy obsluhy za©¡zen¡
0787  8c4c0d         mov    [si+0d],cs           ; segment
078a  f6061d0301     test   [031d],01            ; byl proveden reset disku ?
078f  751e           jnz    07af                 ; byl proveden reset disku
0791  f6061e0303     test   [031e],03            ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
0796  7517           jnz    07af                 ; je chyba
                                               ;* resetov n¡ diskov‚ho syst‚mu
0798  b40d           mov    ah,0d                ; funkce resetov n¡ disku
079a  9c             pushf                       ; simulace vol n¡ INT x
079b  ff1ee802       call   far [02e8]           ; vol n¡ obsluhy INT 21h
079f  fa             cli                         ; z kaz p©eru¨en¡
07a0  80261d03fb     and    [031d],fb
07a5  800e1d0301     or     [031d],01            ; p©¡znak resetov n¡ disku
07aa  800e1d0380     or     [031d],80

07af  c47c03       * les    di,[si+03]           ; adresa z hlav¡
07b2  33db           xor    bx,bx                ; BX <- 0000
07b4  268a5d09       mov    bl,es:[di+09]        ; ‡¡slo operace za©¡zen¡
07b8  d1e3           shl    bx,1                 ; ‡¡slo operace * 2
07ba  fc             cld                         ; smˆr p©enosu dat nahoru
07bb  ff97a008       call   [bx+08a0]            ; vol n¡ obsluhy funkce
07bf  fa             cli                         ; z kaz p©eru¨en¡
07c0  1f             pop    ds                   ; n vrat DS
07c1  07             pop    es                   ; n vrat ES
07c2  5e             pop    si                   ; n vrat SI
07c3  5f             pop    di                   ; n vrat DI
07c4  5a             pop    dx                   ; n vrat DX
07c5  59             pop    cx                   ; n vrat CX
07c6  5b             pop    bx                   ; n vrat BX
07c7  58             pop    ax                   ; n vrat AX
07c8  2e8b26d407     mov    sp,cs:[07d4]         ; n vrat ukazatele z sobn¡ku
07cd  2e8e16d607     mov    ss,cs:[07d6]         ; n vrat segmentu z sobn¡ku
07d2  9d             popf                        ; n vrat registru p©¡znak–
07d3  cb             ret    far

07d4                 dd     0                    ; £schova ukazatele SS:SP

07d8                 dw     99 dup(0)            ; z sobn¡k
089e                 dw     0                    ; vlastn¡ z sobn¡k
; -----------------------------------------------------------------------------


08a0                                             ; tabulka adres operac¡
08a0                 dw     08c4h                ; 00 (- inicializace za©¡zen¡)
08a2                 dw     08c7h                ; 01 - kontrola m‚dia
08a4                 dw     09afh                ; 02 - vystavˆn¡ bloku parametr– BPB
08a6                 dw     08c4h                ; 03 (- vstup kan lu pro ovl d n¡ za©¡zen¡)
08a8                 dw     0b1eh                ; 04 - vstup ze za©¡zen¡
08aa                 dw     08c4h                ; 05 (- nedestruktivn¡ vstup)
08ac                 dw     08c4h                ; 06 (- status vstupu)
08ae                 dw     08c4h                ; 07 (- vypr zdˆn¡ vstupu)
08b0                 dw     0cbah                ; 08 - z pis na za©¡zen¡
08b2                 dw     08c4h                ; 09 (- v˜stup s verifikac¡)
08b4                 dw     08c4h                ; 0a (- status v˜stupu)
08b6                 dw     08c4h                ; 0b (- vypr zdnˆn¡ v˜stupu)
08b8                 dw     08c4h                ; 0c (- v˜stup z kan lu IOCTL)
08ba                 dw     08c4h                ; 0d (- otev©en¡ za©¡zen¡)
08bc                 dw     08c4h                ; 0e (- uzav©en¡ za©¡zen¡)
08be                 dw     08c4h                ; 0f (- v˜mˆna m‚dia)
08c0                 dw     08c4h                ; 10
08c2                 dw     08c4h                ; 11

                                                 ; neobsluhovan  funkce
08c4                 xor    ax,ax
08c6                 ret
; -----------------------------------------------------------------------------
;     Funkce 01h:    Kontrola v˜mˆny m‚dia
; -----------------------------------------------------------------------------
                                                 ; FUNKCE 01 - kontrola m‚dia

                                               ;* struktura p©ijat‚ vˆty:
                                                 ;
                                               * Z hlav¡ vˆty:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 01h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 01h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - popisova‡ m‚dia
                                                 ; +0d:     - © d velik. sektoru
                                                 ; +0e-1f: ...... 0

08c7  1e           * push   ds
08c8  56             push   si
08c9  268a4508       mov    al,es:[di+08]        ; parametry TIME-OUT
08cd  2440           and    al,40                ; p©¡znak operace hled n¡
08cf  d0e8           shr    al,1
08d1  2e80261d03df   and    cs:[031d],df         ; p©¡znak TIME-OUT
08d7  2e08061d03     or     cs:[031d],al         ; p©¡znak pro hled n¡

                                               ;* inicializace z hlav¡ za©¡zen¡
08dc  b81601         mov    ax,0116              ; AL=d‚lka, AH=povel
08df  8d5520         lea    dx,[di+20]           ; adresa pro z hlav¡
08e2  e8cb1b         call   24b0                 ; vytvo©en¡ z hlav¡ za©¡zen¡

                                               ;* p©evod dat do z hlav¡
08e5  be7d1f         mov    si,1f7d              ; tabulka k transformaci dat
08e8  8cc0           mov    ax,es
08ea  8ed8           mov    ds,ax                ; DS <- ES
08ec  83c70a         add    di,000a              ; data ze z hlav¡
08ef  57             push   di
08f0  e89219         call   2285                 ; p©enos dat do z hlav¡ za©¡z.

                                               ;* nastaven¡ © du sektoru
08f3  8bda           mov    bx,dx                ; adresa z hlav¡ za©¡zen¡
08f5  5f             pop    di                   ; p©ijat  data
08f6  52             push   dx                   ; adresa z hlav¡ za©¡zen¡
08f7  8a4d03         mov    cl,[di+03]           ; © d sektoru
08fa  268b7f01       mov    di,es:[bx+01]        ; ‡¡slo disk. jednotky
08fe  81e7ff00       and    di,00ff              ; ‡¡slo disk. jednotky
0902  2e888d8d20     mov    cs:[di+208d],cl      ; tabulka © d– sektor– disk–

                                               ;* nastaven¡ d‚lky sektoru
0907  d1e7           shl    di,1                 ; ‡¡slo jednotky * 2
0909  b88000         mov    ax,0080              ; d‚lka sektoru 128 bajt–
090c  d3e0           shl    ax,cl                ; v˜po‡et d‚lky sektoru (bajt–)
090e  2e89856d20     mov    cs:[di+206d],ax      ; nastaven¡ d‚lky sektoru

                                               ;* omezen¡ velikosti sektoru
0913  33c9           xor    cx,cx                ; CX <- 0
0915  2e8b161203     mov    dx,cs:[0312]         ; maxim ln¡ d‚lka sektoru
091a  3bd0           cmp    dx,ax                ; sektor je men¨¡ ?
091c  7305           jnc    0923                 ; je men¨¡
091e  2e8b161003     mov    dx,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku

                                               ;* v˜po‡et po‡tu komun. blok–
0923  41           * inc    cx                   ; ‡¡ta‡ © du sektoru
0924  2bd0           sub    dx,ax
0926  73fb           jnc    0923
0928  4a             dec    dx
0929  2e898d9d20     mov    cs:[di+209d],cx      ; tabulka po‡tu komun. blok–

                                               ;* obsluha driveru po‘ad. disku
092e  5a             pop    dx
092f  e8b51a         call   23e7                 ; proveden¡ obsluhy driveru
0932  7303           jnc    0937                 ; operace probˆhla OK
0934  5e             pop    si
0935  1f             pop    ds
0936  c3             ret

                                               ;* blokov n¡ k¢du, ‘e nen¡ v˜mˆna
0937  268a470e     * mov    al,es:[bx+0e]        ; n vratov˜ k¢d m‚dia
093b  3cff           cmp    al,ff                ; bylo m‚dium vymˆnˆno ?
093d  7405           jz     0944                 ; m‚dium bylo vymˆnˆno
093f  26c6470e00     mov    es:[bx+0e],00        ; p©¡znak, ‘e nen¡ zn m  v˜mˆna

                                               ;* vymaz n¡ z hlav¡ zpr vy
0944  8bd3         * mov    dx,bx                ; adresa z hlav¡ za©¡zen¡
0946  8bfb           mov    di,bx                ; adresa z hlav¡ za©¡zen¡
0948  8cc0           mov    ax,es
094a  8ed8           mov    ds,ax                ; DS <- ES segment z hlav¡
094c  83ef20         sub    di,0020              ; p©ijat  zpr va
094f  b92000         mov    cx,0020              ; d‚lka z hlav¡ zpr vy
0952  33c0           xor    ax,ax                ; AX <- 0
0954  f3aa           rep    stosb                ; vymaz n¡ z hlav¡ zpr vy
0956  83ef20         sub    di,0020              ; n vrat adresy za‡ tku zpr vy

                                               ;* parametry z hlav¡ zpr vy
0959  c60530         mov    [di],30              ; 1. bajt identifikace
095c  c6450164       mov    [di+01],64           ; 2. bajt identifikace (=100)
0960  a01d03         mov    al,[031d]            ; p©¡znaky RESET a TIME-OUT
0963  884507         mov    [di+07],al           ; p©¡znaky RESET a TIME-OUT

                                               ;* ulo‘en¡ parametr– ze z hlav¡
0966  83c70a         add    di,000a              ; data v z hlav¡ za©¡zen¡
0969  be811f         mov    si,1f81              ; tabulka k p©evodu z hlav¡
096c  e83219         call   22a1                 ; p©enos po‘adavku ze z hlav¡

                                               ;* nastaven¡ parametr– vys¡l n¡
096f  5e             pop    si                   ; adresa definice zpr vy
0970  1f             pop    ds
0971  fa             cli
0972  c6440200       mov    [si+02],00
0976  8b4403         mov    ax,[si+03]
0979  8b5c05         mov    bx,[si+05]
097c  c7440bff06     mov    [si+0b],06ff         ; adresa p©¡pravy obsluhy
0981  8c4c0d         mov    [si+0d],cs           ; segment
0984  8b74fa         mov    si,[si-06]
0987  894403         mov    [si+03],ax
098a  895c05         mov    [si+05],bx
098d  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
0992  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0997  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
099c  c6440f14       mov    [si+0f],14           ; znak PREX1
09a0  c644101c       mov    [si+10],1c           ; znak PREX2
09a4  c644111e       mov    [si+11],1e           ; znak SYNCH

                                               ;* vysl n¡ odpovˆdi
09a8  fb             sti
09a9  b301           mov    bl,01
09ab  e87822         call   2c26                 ; vysl n¡ vˆty na protistanici
09ae  c3             ret

                                               * Z hlav¡ vˆty:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-06: ...... 0
                                                 ; +07: p©i.- RESET a TIME-OUT
                                                 ; +08: vys.- 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 01h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 01h - k¢d povelu
                                                 ; +0b:     - stavov‚ slovo
                                                 ; +0d:     - p©¡znak v˜mˆny
                                                 ; +0e-1f: ...... 0
                            ; ------------------------------------------------
                                                 ; parametry pro vysl n¡ zpr vy
                                                 ; -06: adresa zpr vy 2
                                                 ; 00
                                                 ; 01
                                                 ; 02 p©¡znaky operace p©enosu
                                                 ;  bit3=zpr va byla odesl na OK
                                                 ;  bit4=p©¡znak TIME-OUT
                                                 ;  bit5=v¡cen sobn˜ po‘adavek
                                                 ;  bit7=vysl n znak(11)
                                                 ; 03 adresa vys¡lan‚ zpr vy
                                                 ; 07 po‡et bajt– k vysl n¡
                                                 ; 09 ‡¡ta‡ ji‘ vyslan˜ch bajt–
                                                 ; 0b adresa dal¨¡ho programu
                                                 ; 0f znak PREX1 (15h)
                                                 ; 10 znak PREX2 (1ch)
                                                 ; 11 znak SYNCH (1eh)

; -----------------------------------------------------------------------------
;     Funkce 02h:    Vystavˆn¡ bloku BPB
; -----------------------------------------------------------------------------

                                                 ; FUNKCE 02 - vystavˆn¡ BPB

                                               ;* P©ijat  zpr va:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 02h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 02h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - popisova‡ m‚dia
                                                 ; +0d:     - popisova‡ z FAT
                                                 ; +0e-1f: ...... 0

09af  1e           * push   ds
09b0  56             push   si

                                               ;* vytvo©en¡ z hlav¡ za©¡zen¡
09b1  b81602         mov    ax,0216              ; AL=d‚lka z hlav¡, AH=povel
09b4  8d5520         lea    dx,[di+20]           ; ukl dac¡ adresa
09b7  e8f61a         call   24b0                 ; vytvo©en¡ z hlav¡ za©¡zen¡

                                               ;* p©¡znaky TIME-OUT
09ba  be851f         mov    si,1f85              ; konverzn¡ tabulka
09bd  8cc0           mov    ax,es
09bf  8ed8           mov    ds,ax                ; DS <- ES
09c1  2e80261803fd   and    cs:[0318],fd
09c7  268a4502       mov    al,es:[di+02]        ; mo‘n˜ p©¡stup k ‡ sti disku ?
09cb  d0e0           shl    al,1
09cd  2402           and    al,02                ; mo‘n˜ p©¡stup k ‡ sti disku ?
09cf  2e08061803     or     cs:[0318],al         ; mo‘n˜ p©¡stup k ‡ sti disku ?

                                               ;* adresa bufferu s FAT
09d4  83c70a         add    di,000a
09d7  8d4503         lea    ax,[di+03]           ; popisova‡ z FAT
09da  8bda           mov    bx,dx                ; adresa z hlav¡ za©¡zen¡
09dc  2689470e       mov    es:[bx+0e],ax        ; adresa bufferu FAT - LOW
09e0  268c5f10       mov    es:[bx+10],ds        ; adresa bufferu FAT - HIGH

                                               ;* nastaven¡ z hlav¡ za©¡zen¡
09e4  e89e18         call   2285                 ; p©enos dat do z hlav¡ za©¡z.

                                               ;* proveden¡ obsluhy disk. za©¡z.
09e7  8bfa           mov    di,dx                ; adresa z hlav¡ za©¡zen¡
09e9  26c74512c61f   mov    es:[di+12],1fc6      ; standardn¡ tabulka BPB
09ef  268c4d14       mov    es:[di+14],cs
09f3  8bdf           mov    bx,di                ; adresa z hlav¡ za©¡zen¡
09f5  e8ef19         call   23e7                 ; proveden¡ obsluhy driveru
09f8  7303           jnc    09fd                 ; operace OK
09fa  5e             pop    si
09fb  1f             pop    ds
09fc  c3             ret

                                               ;* £schova d‚lky sektoru
09fd  90           * nop
09fe  26c57712       lds    si,es:[bx+12]        ; adresa tabulky BPB
0a02  8b04           mov    ax,[si]              ; po‡et bajt– na sektor
0a04  268b7701       mov    si,es:[bx+01]        ; ‡¡slo disk. jednotky
0a08  81e6ff00       and    si,00ff              ; ‡¡slo disk. jednotky
0a0c  d1e6           shl    si,1                 ; ‡¡slo jednotky * 2
0a0e  2e89846d20     mov    cs:[si+206d],ax      ; nastaven¡ d‚lky sektoru

                                               ;* zji¨tˆn¡ © du velik. sektoru
0a13  d1ee           shr    si,1                 ; ‡¡slo jednotky
0a15  33c9           xor    cx,cx                ; CX <- 0 ‡¡ta‡ d‚lek
0a17  2e3b061003     cmp    ax,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku
0a1c  7707           ja     0a25                 ; sektor je p©¡li¨ dlouh˜
0a1e  41           * inc    cx
0a1f  d1e8           shr    ax,1
0a21  741d           jz     0a40                 ; nalezena d‚lka sektoru
0a23  73f9           jnc    0a1e                 ; nen¡ je¨tˆ p©ete‡en¡

                                               ;* chybn  d‚lka sektoru
0a25  e8f410       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
0a28                 db     'Sektorlange falsch',13,10,0
0a3e  b10a           mov    cl,0a                ; n hradn¡ © d sektoru

                                               ;* £schova © du velikosti sektoru
0a40  80e908       * sub    cl,08                ; normalizace © du sektoru
0a43  72e0           jc     0a25                 ; chyba - p©¡li¨ mal˜ sektor
0a45  2e888c8d20     mov    cs:[si+208d],cl      ; £schova © du sektoru

                                               ;* zji¨tˆn¡ d‚lky sektoru
0a4a  b88000         mov    ax,0080              ; d‚lka sektoru = 128 bajt–
0a4d  d3e0           shl    ax,cl                ; v˜po‡et d‚lky sektoru
0a4f  33c9           xor    cx,cx                ; CX <- 0
0a51  52             push   dx
0a52  2e8b161203     mov    dx,cs:[0312]         ; maxim ln¡ d‚lka sektoru
0a57  3bd0           cmp    dx,ax
0a59  7305           jnc    0a60
0a5b  2e8b161003     mov    dx,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku

                                               ;* zji¨tˆn¡ po‡tu komun. blok–
0a60  41           * inc    cx
0a61  2bd0           sub    dx,ax
0a63  73fb           jnc    0a60
0a65  5a             pop    dx
0a66  49             dec    cx
0a67  d1e6           shl    si,1
0a69  2e898c9d20     mov    cs:[si+209d],cx      ; tabulka po‡tu komun. blok–

                                               ;* vymaz n¡ zpr vy k vys¡l n¡
0a6e  8bd3           mov    dx,bx                ; adresa z hlav¡ za©¡zen¡
0a70  8bfb           mov    di,bx                ; adresa z hlav¡ za©¡zen¡
0a72  8cc0           mov    ax,es
0a74  8ed8           mov    ds,ax                ; DS <- ES segment z hlav¡ za©.
0a76  83ef20         sub    di,0020              ; adresa p©ijat‚ zpr vy
0a79  b92000         mov    cx,0020              ; d‚lka zpr vy
0a7c  33c0           xor    ax,ax
0a7e  f3aa           rep    stosb                ; vymaz n¡ zpr vy k vys¡l n¡
0a80  83ef20         sub    di,0020              ; n vrat za‡ tku zpr vy

0a83  c60530         mov    [di],30              ; identifika‡n¡ bajt
0a86  c6450164       mov    [di+01],64           ; identifika‡n¡ bajt

                                               ;* p©¡znaky za©¡zen¡
0a8a  2ea01803       mov    al,cs:[0318]
0a8e  2404           and    al,04
0a90  d0e8           shr    al,1
0a92  d0e8           shr    al,1
0a94  084502         or     [di+02],al

0a97  a01d03         mov    al,[031d]            ; stav TIME-OUT
0a9a  884507         mov    [di+07],al           ; stav TIME-OUT

                                               ;* p©enos dat ze z hlav¡
0a9d  83c70a         add    di,000a              ; pracovn¡ z hlav¡ za©¡zen¡
0aa0  be891f         mov    si,1f89              ; adresa tabulky k transformaci
0aa3  e8fb17         call   22a1                 ; p©enos po‘adavku ze z hlav¡

                                               ;* p©enos tabulky BPB
0aa6  06             push   es
0aa7  52             push   dx
0aa8  5e             pop    si
0aa9  1f             pop    ds
0aaa  c57412         lds    si,[si+12]           ; adresa bloku BPB
0aad  8bfa           mov    di,dx                ; adresa z hlav¡ za©¡zen¡
0aaf  83ef20         sub    di,0020              ; adresa z hlav¡ vˆty
0ab2  83c70c         add    di,000c              ; za‡ tek tabulky BPB
0ab5  b91400         mov    cx,0014              ; d‚lka tabulky BPB
0ab8  fc             cld
0ab9  57             push   di
0aba  56             push   si
0abb  f3a4           rep    movsb                ; p©enos tabulky BPB
0abd  5e             pop    si
0abe  5f             pop    di

                                               ;* parametry pro velk˜ disk
0abf  2ef606180304   test   cs:[0318],04         ; p©enos velk‚ho disku ?
0ac5  7419           jz     0ae0
0ac7  8b4408         mov    ax,[si+08]           ; celkov˜ po‡et sektor– disku
0aca  0bc0           or     ax,ax                ; je definov n ?
0acc  7512           jnz    0ae0                 ; je definov n
0ace  8b4415         mov    ax,[si+15]           ; po‡et sektor– - LOW
0ad1  26894508       mov    es:[di+08],ax        ; po‡et sektor–
0ad5  8b4417         mov    ax,[si+17]
0ad8  26886513       mov    es:[di+13],ah        ; po‡et sektor–
0adc  26884510       mov    es:[di+10],al
0ae0  5e           * pop    si
0ae1  1f             pop    ds

                                               ;* nastaven¡ parametr– vys¡l n¡
0ae2  c6440200       mov    [si+02],00
0ae6  8b4403         mov    ax,[si+03]
0ae9  8b5c05         mov    bx,[si+05]
0aec  c7440bff06     mov    [si+0b],06ff         ; adresa p©esmˆrov n¡ za©¡zen¡
0af1  8c4c0d         mov    [si+0d],cs           ; segment
0af4  8b74fa         mov    si,[si-06]
0af7  894403         mov    [si+03],ax
0afa  895c05         mov    [si+05],bx
0afd  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
0b02  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0b07  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
0b0c  c6440f14       mov    [si+0f],14           ; znak PREX1
0b10  c644101c       mov    [si+10],1c           ; znak PREX2
0b14  c644111e       mov    [si+11],1e           ; znak SYNCH

                                               ;* vysl n¡ odpovˆdi
0b18  b301           mov    bl,01
0b1a  e80921         call   2c26                 ; vysl n¡ vˆty na protistanici
0b1d  c3             ret

                                               ;* Vyslan  odpovˆƒ:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 02h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 02h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - tabulka BPB

; -----------------------------------------------------------------------------
;     Funkce 04h:    Vstup ze za©¡zen¡
; -----------------------------------------------------------------------------

                                                 ; FUNKCE 04 - vstup ze za©¡zen¡

                            ; -----------------------------------------------
                                               ;* struktura vˆty vystavˆn¡ BPB:
                                                 ; (2D7CH):
                                               * Z hlav¡ vˆty:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 04h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 04h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - popisova‡ m‚dia
                                                 ; +0d:     - po‡et sektor– 2B
                                                 ; +0f:     - ‡¡slo sektoru 2B
                                                 ;            (0ffffh = COMPAQ)
                                                 ; +11:     - ‡¡slo sektoru 4B
                                                 ; +15-1f: ...... 0
                            ; -----------------------------------------------

0b1e  1e           * push   ds
0b1f  56             push   si

                                               ;* nastaven¡ TIME-OUT
0b20  268a4508       mov    al,es:[di+08]        ; doba pro TIME-OUT
0b24  2440           and    al,40
0b26  d0e8           shr    al,1
0b28  2e80261d03df   and    cs:[031d],df         ; p©¡znak TIME-OUT
0b2e  2e08061d03     or     cs:[031d],al

                                               ;* vytvo©en¡ z hlav¡ za©¡zen¡
0b33  8ae3           mov    ah,bl                ; povel * 2
0b35  d0ec           shr    ah,1                 ; povel (04h)
0b37  b016           mov    al,16                ; d‚lka z hlav¡ za©¡zen¡
0b39  8d5520         lea    dx,[di+20]           ; ukl dac¡ adresa
0b3c  e87119         call   24b0                 ; vytvo©en¡ z hlav¡ za©¡zen¡


0b3f  be8c1f         mov    si,1f8c              ; transforma‡n¡ tabulka
0b42  8cc0           mov    ax,es
0b44  8ed8           mov    ds,ax                ; DS <- ES
0b46  2e80261803fd   and    cs:[0318],fd         ; mo‘n˜ p©¡stup k ‡ sti disku ?
0b4c  8a4502         mov    al,[di+02]
0b4f  d0e0           shl    al,1
0b51  2402           and    al,02                ; mo‘n˜ p©¡stup k ‡ sti disku ?
0b53  2e08061803     or     cs:[0318],al         ; mo‘n˜ p©¡stup k ‡ sti disku ?

                                               ;* p©enos dat do z hlav¡ za©¡zen¡
0b58  83c70a         add    di,000a
0b5b  e82717         call   2285                 ; p©enos dat do z hlav¡

                                               ;* stanoven¡ po‡tu blok–
0b5e  8bfa           mov    di,dx                ; adresa z hlav¡ za©¡zen¡
0b60  268b4d12       mov    cx,es:[di+12]        ; po‡et sektor– k p©enosu
0b64  268b7501       mov    si,es:[di+01]        ; ‡¡slo za©¡zen¡
0b68  81e6ff00       and    si,00ff              ; ‡¡slo za©¡zen¡
0b6c  d1e6           shl    si,1                 ; ‡¡slo za©¡zen¡ * 2
0b6e  2e3b8c9d20     cmp    cx,cs:[si+209d]      ; tabulka po‡tu komun. blok–
0b73  7205           jc     0b7a
0b75  2e8b8c9d20     mov    cx,cs:[si+209d]      ; tabulka po‡tu komun. blok–
0b7a  26894d12     * mov    es:[di+12],cx        ; omezen˜ po‡et blok–

                                               ;* test, zda bude COMPAQ
0b7e  5e             pop    si
0b7f  1f             pop    ds
0b80  2ef606180380   test   cs:[0318],80
0b86  752f           jnz    0bb7
0b88  2ef606180302   test   cs:[0318],02         ; mo‘n˜ p©¡stup k ‡ sti disku ?
0b8e  7427           jz     0bb7
0b90  26837d14ff     cmp    es:[di+14],ffff      ; je COMPAQ ?
0b95  7520           jnz    0bb7                 ; nen¡ COMPAQ

                                               ;* korekce pro COMPAQ
0b97  268b451a       mov    ax,es:[di+1a]        ; sektor 4B
0b9b  26894514       mov    es:[di+14],ax        ; sektor pro COMPAQ
0b9f  26837d1c00     cmp    es:[di+1c],0000      ; je sektor 4-bajtovˆ
0ba4  7411           jz     0bb7                 ; nen¡ 4-bajtovˆ
0ba6  26c745120000   mov    es:[di+12],0000
0bac  26c745030881   mov    es:[di+03],8108      ; chyba - sektor nenalezen
0bb2  1e             push   ds
0bb3  56             push   si
0bb4  eb1d           jmp    0bd3
0bb6  90             nop

                                               ;* obsluha driveru - ‡ten¡ dat
0bb7  1e           * push   ds
0bb8  56             push   si
0bb9  8b4413         mov    ax,[si+13]           ; p©enosov˜ buffer
0bbc  2689450e       mov    es:[di+0e],ax        ; adresa p©enosov‚ho bufferu
0bc0  8b4415         mov    ax,[si+15]
0bc3  26894510       mov    es:[di+10],ax        ; segment p©enosov‚ho bufferu
0bc7  8bdf           mov    bx,di
0bc9  e81b18         call   23e7                 ; proveden¡ obsluhy driveru
0bcc  8bfb           mov    di,bx
0bce  7303           jnc    0bd3
0bd0  5e             pop    si
0bd1  1f             pop    ds
0bd2  c3             ret

                                               ;* velikost dat v bajtech
0bd3  268b5d12     * mov    bx,es:[di+12]        ; po‡et na‡ten˜ch sektor–
0bd7  268b7501       mov    si,es:[di+01]        ; ‡¡slo jednotky
0bdb  81e6ff00       and    si,00ff              ; ‡¡slo jednotky
0bdf  2e8a8c8d20     mov    cl,cs:[si+208d]      ; tabulka © d– sektor– disk–
0be4  80c107         add    cl,07                ; korekce na © d sektoru
0be7  d3e3           shl    bx,cl                ; v˜po‡et d‚lky dat (v bajtech)

                                               ;* inicializace vˆty k vysl n¡
0be9  8bd7           mov    dx,di                ; adresa po‘adavku za©¡zen¡
0beb  8cc0           mov    ax,es
0bed  8ed8           mov    ds,ax
0bef  83ef20         sub    di,0020
0bf2  b92000         mov    cx,0020              ; d‚lka vˆty odpovˆdi
0bf5  33c0           xor    ax,ax
0bf7  f3aa           rep    stosb                ; vymaz n¡ vˆty odpovˆdi
0bf9  83ef20         sub    di,0020              ; n vrat za‡ tku vˆty

                                               ;* inicializace parametr– vˆty
0bfc  c60530         mov    [di],30              ; identifika‡n¡ bajt
0bff  c6450164       mov    [di+01],64           ; identifika‡n¡ bajt
0c03  a01d03         mov    al,[031d]
0c06  884507         mov    [di+07],al           ; stav RESET a TIME-OUT

                                               ;* n vrat po‡tu ‡ten˜ch sektor–
0c09  83c70a         add    di,000a              ; pracovn¡ adresa z hlav¡
0c0c  bea41f         mov    si,1fa4              ; tabulka pro transformaci
0c0f  e88f16         call   22a1                 ; p©enos po‘adavku ze z hlav¡
0c12  5e             pop    si
0c13  1f             pop    ds

                                               ;* sestaven¡ parametr– p©enosu
0c14  8b7cfa         mov    di,[si-06]
0c17  c6440200       mov    [si+02],00
0c1b  c6450200       mov    [di+02],00
0c1f  8b4403         mov    ax,[si+03]
0c22  894503         mov    [di+03],ax
0c25  8b4405         mov    ax,[si+05]
0c28  894505         mov    [di+05],ax
0c2b  8b4413         mov    ax,[si+13]
0c2e  894513         mov    [di+13],ax
0c31  8b4415         mov    ax,[si+15]
0c34  894515         mov    [di+15],ax
0c37  895d17         mov    [di+17],bx
0c3a  c7440bff06     mov    [si+0b],06ff         ; adresa p©esmˆrov n¡ za©¡zen¡
0c3f  8c4c0d         mov    [si+0d],cs           ; segment
0c42  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
0c47  c745072000     mov    [di+07],0020         ; po‡et bajt– k vysl n¡
0c4c  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0c51  c745090000     mov    [di+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0c56  c7450b700c     mov    [di+0b],0c70         ; adresa pokra‡ov n¡ programu
0c5b  8c4d0d         mov    [di+0d],cs
0c5e  c6450f14       mov    [di+0f],14           ; znak PREX1
0c62  c645101c       mov    [di+10],1c           ; znak PREX2
0c66  c645111e       mov    [di+11],1e           ; znak SYNCH
0c6a  b301           mov    bl,01
0c6c  e8b71f         call   2c26                 ; vysl n¡ vˆty na protistanici
0c6f  c3             ret

                                               ;* pokra‡ov n¡ p©enosu - data
0c70  c7440b0000     mov    [si+0b],0000         ; adresa pokra‡ov n¡ programu
0c75  f6440210       test   [si+02],10           ; operace OK ?
0c79  752c           jnz    0ca7                 ; chyba operace
0c7b  8b4413         mov    ax,[si+13]
0c7e  894403         mov    [si+03],ax
0c81  8b4415         mov    ax,[si+15]
0c84  894405         mov    [si+05],ax
0c87  8b4417         mov    ax,[si+17]
0c8a  894407         mov    [si+07],ax
0c8d  0bc0           or     ax,ax
0c8f  7415           jz     0ca6
0c91  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0c96  c6440f18       mov    [si+0f],18           ; znak PREX1
0c9a  c644101b       mov    [si+10],1b           ; znak PREX2
0c9e  c644111e       mov    [si+11],1e           ; znak SYNCH
0ca2  c6440220       mov    [si+02],20
0ca6  cb           * ret    far

                                               ;* chyba ‡ten¡ z disku
0ca7  e8720e       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

0caa                 db     'LESEFEHLER ',7,13,10,0

0cb9  cb             ret    far
; -----------------------------------------------------------------------------
þ
                                                 ; FUNKCE 08 - z pis na za©¡zen¡
0cba  1e           * push   ds
0cbb  56             push   si
0cbc  8ae3           mov    ah,bl
0cbe  d0ec           shr    ah,1                 ; identifika‡n¡ bajt
0cc0  b016           mov    al,16                ; d‚lka hlavi‡ky
0cc2  8d5520         lea    dx,[di+20]           ; ukl dac¡ adresa
0cc5  e8e817         call   24b0                 ; vytvo©en¡ z hlav¡ za©¡zen¡
0cc8  bea91f         mov    si,1fa9
0ccb  8cc0           mov    ax,es
0ccd  8ed8           mov    ds,ax
0ccf  2e80261803fd   and    cs:[0318],fd         ; mo‘n˜ p©¡stup k ‡ sti disku ?
0cd5  8a4502         mov    al,[di+02]
0cd8  d0e0           shl    al,1
0cda  2402           and    al,02
0cdc  2e08061803     or     cs:[0318],al         ; mo‘n˜ p©¡stup k ‡ sti disku ?
0ce1  8a4503         mov    al,[di+03]
0ce4  2ea21703       mov    cs:[0317],al
0ce8  83c70a         add    di,000a
0ceb  e89715         call   2285                 ; p©enos dat do z hlav¡ po‘adavku za©¡zen¡
0cee  8bfa           mov    di,dx
0cf0  268b4d12       mov    cx,es:[di+12]
0cf4  268b7501       mov    si,es:[di+01]
0cf8  81e6ff00       and    si,00ff
0cfc  d1e6           shl    si,1
0cfe  2e3b8c9d20     cmp    cx,cs:[si+209d]      ; tabulka po‡tu komun. blok–
0d03  7205           jc     0d0a
0d05  2e8b8c9d20     mov    cx,cs:[si+209d]      ; tabulka po‡tu komun. blok–
0d0a  26894d12       mov    es:[di+12],cx
0d0e  2ef606180380   test   cs:[0318],80
0d14  752a           jnz    0d40
0d16  2ef606180302   test   cs:[0318],02         ; mo‘n˜ p©¡stup k ‡ sti disku ?
0d1c  7422           jz     0d40
0d1e  26837d14ff     cmp    es:[di+14],ffff
0d23  751b           jnz    0d40
0d25  268b451a       mov    ax,es:[di+1a]
0d29  26894514       mov    es:[di+14],ax
0d2d  26837d1c00     cmp    es:[di+1c],0000
0d32  740c           jz     0d40
0d34  26c745120000   mov    es:[di+12],0000
0d3a  26c745030881   mov    es:[di+03],8108
0d40  2ea11603       mov    ax,cs:[0316]         ; verze oper. syst‚mu * 2
0d44  3ae0           cmp    ah,al
0d46  730c           jnc    0d54
0d48  26c745120000   mov    es:[di+12],0000
0d4e  26c74503cf81   mov    es:[di+03],81cf
0d54  5e             pop    si
0d55  1f             pop    ds
0d56  fa             cli
0d57  c6440200       mov    [si+02],00
0d5b  2ea1fc2d       mov    ax,cs:[2dfc]         ; adresa konce rezidentn¡ ‡ sti
0d5f  894403         mov    [si+03],ax
0d62  8c4c05         mov    [si+05],cs
0d65  8bc1           mov    ax,cx
0d67  56             push   si
0d68  268b7501       mov    si,es:[di+01]
0d6c  81e6ff00       and    si,00ff
0d70  2e8a8c8d20     mov    cl,cs:[si+208d]      ; tabulka © d– sektor– disk–
0d75  80c107         add    cl,07
0d78  d3e0           shl    ax,cl
0d7a  5e             pop    si
0d7b  894407         mov    [si+07],ax           ; po‡et bajt– k vysl n¡
0d7e  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0d83  c7440b900d     mov    [si+0b],0d90         ; adresa p©esmˆrov n¡ za©¡zen¡
0d88  8c4c0d         mov    [si+0d],cs
0d8b  e83a16         call   23c8
0d8e  fb             sti
0d8f  c3             ret
0d90  c7440bff06     mov    [si+0b],06ff         ; adresa p©esmˆrov n¡ za©¡zen¡
0d95  8c4c0d         mov    [si+0d],cs           ; segment
0d98  f6440210       test   [si+02],10
0d9c  750c           jnz    0daa
0d9e  c7440bab0d     mov    [si+0b],0dab         ; adresa p©esmˆrov n¡ za©¡zen¡
0da3  8c4c0d         mov    [si+0d],cs
0da6  804c0201       or     [si+02],01
0daa  cb             ret    far
0dab  2e8926d407     mov    cs:[07d4],sp
0db0  2e8c16d607     mov    cs:[07d6],ss
0db5  8ccc           mov    sp,cs
0db7  8ed4           mov    ss,sp
0db9  bc9e08         mov    sp,089e
0dbc  50             push   ax
0dbd  53             push   bx
0dbe  51             push   cx
0dbf  52             push   dx
0dc0  57             push   di
0dc1  56             push   si
0dc2  06             push   es
0dc3  1e             push   ds
0dc4  8ccf           mov    di,cs
0dc6  8edf           mov    ds,di
0dc8  806402fe       and    [si+02],fe
0dcc  c7440bff06     mov    [si+0b],06ff         ; adresa p©esmˆrov n¡ za©¡zen¡
0dd1  8c4c0d         mov    [si+0d],cs           ; segment
0dd4  f6061d0301     test   [031d],01
0dd9  751d           jnz    0df8
0ddb  f6061e0303     test   [031e],03            ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
0de0  7516           jnz    0df8
0de2  b40d           mov    ah,0d
0de4  9c             pushf
0de5  ff1ee802       call   far [02e8]           ; vol n¡ obsluhy INT 21h
0de9  80261d03fb     and    [031d],fb
0dee  800e1d0301     or     [031d],01
0df3  800e1d0380     or     [031d],80
0df8  8ccf           mov    di,cs
0dfa  8ec7           mov    es,di
0dfc  bfbc2d         mov    di,2dbc
0dff  fc             cld
0e00  8bdf           mov    bx,di
0e02  83c320         add    bx,0020
0e05  2ea1fc2d       mov    ax,cs:[2dfc]         ; adresa konce rezidentn¡ ‡ sti
0e09  2689470e       mov    es:[bx+0e],ax
0e0d  268c4f10       mov    es:[bx+10],cs
0e11  26f747030081   test   es:[bx+03],8100
0e17  7508           jnz    0e21
0e19  e8cb15         call   23e7                 ; proveden¡ obsluhy driveru
0e1c  7303           jnc    0e21
0e1e  eb66           jmp    0e86
0e20  90             nop
0e21  8bd3           mov    dx,bx
0e23  8bfb           mov    di,bx
0e25  8cc0           mov    ax,es
0e27  8ed8           mov    ds,ax
0e29  83ef20         sub    di,0020
0e2c  b92000         mov    cx,0020
0e2f  33c0           xor    ax,ax
0e31  f3aa           rep    stosb
0e33  83ef20         sub    di,0020
0e36  c60530         mov    [di],30
0e39  c6450164       mov    [di+01],64
0e3d  a01d03         mov    al,[031d]
0e40  884507         mov    [di+07],al
0e43  83c70a         add    di,000a
0e46  bec11f         mov    si,1fc1              ; transforma‡n¡ tabulka
0e49  e85514         call   22a1                 ; p©enos po‘adavku ze z hlav¡ za©¡zen¡
0e4c  be5225         mov    si,2552
0e4f  c6440200       mov    [si+02],00
0e53  8b440f         mov    ax,[si+0f]           ; znak PREX1,PREX2
0e56  8b5c11         mov    bx,[si+11]           ; znak SYNCH
0e59  8c4c0d         mov    [si+0d],cs
0e5c  8b74fa         mov    si,[si-06]
0e5f  894403         mov    [si+03],ax
0e62  895c05         mov    [si+05],bx
0e65  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
0e6a  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
0e6f  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
0e74  c6440f14       mov    [si+0f],14           ; znak PREX1
0e78  c644101c       mov    [si+10],1c           ; znak PREX2
0e7c  c644111e       mov    [si+11],1e           ; znak SYNCH
0e80  fb             sti
0e81  b301           mov    bl,01
0e83  e8a01d         call   2c26                 ; vysl n¡ vˆty na protistanici
0e86  fa             cli
0e87  1f             pop    ds
0e88  07             pop    es
0e89  5e             pop    si
0e8a  5f             pop    di
0e8b  5a             pop    dx
0e8c  59             pop    cx
0e8d  5b             pop    bx
0e8e  58             pop    ax
0e8f  2e8b26d407     mov    sp,cs:[07d4]
0e94  2e8e16d607     mov    ss,cs:[07d6]
0e99  cb             ret    far


; *****************************************************************************
;
;                   P©¡stup na extern¡ disk (vzd len˜)
;
; *****************************************************************************

0e9a                 dd     0                    ; £schova SS:SP

0e9e                 dw     98 dup(0)            ; z sobn¡k
0f62                 dw     0                    ; vlastn¡ z sobn¡k

; -----------------------------------------------------------------------------
;     Obsluha rutiny PžERU›EN‹ z driveru NETUNITS.SYS
; -----------------------------------------------------------------------------
                                               ;* obsluha rutiny PžERU›EN‹
                                               ;* z driveru NETUNITS.SYS
                                               ;* pou‘¡v  se pro p©¡stup
                                               ;* k d lkov˜m disk–m

                                               ;* definice z sobn¡ku
0f64  2e89269a0e   * mov    cs:[0e9a],sp         ; £schova SP
0f69  2e8c169c0e     mov    cs:[0e9c],ss         ; £schova SS
0f6e  fa             cli                         ; z kaz p©eru¨en¡
0f6f  8ccc           mov    sp,cs                ; SP <- CS
0f71  8ed4           mov    ss,sp                ; SS <- CS
0f73  bc620f         mov    sp,0f62              ; adresa vlastn¡ho z sobn¡ku
0f76  fb             sti                         ; povolen¡ p©eru¨en¡

                                               ;* £schova registr–
0f77  50             push   ax                   ; £schova AX
0f78  53             push   bx                   ; £schova BX
0f79  51             push   cx                   ; £schova CX
0f7a  52             push   dx                   ; £schova DX
0f7b  57             push   di                   ; £schova DI
0f7c  56             push   si                   ; £schova SI
0f7d  55             push   bp                   ; £schova BP
0f7e  1e             push   ds                   ; £schova DS
0f7f  06             push   es                   ; £schova ES

                                               ;* inicializace registr–
0f80  8ccb           mov    bx,cs                ; BX <- CS
0f82  8edb           mov    ds,bx                ; DS <- CS
0f84  c60600035a     mov    [0300],5a            ; ‡¡ta‡ ‡asu inicial.portu 5 s.
0f89  2ec43e1b10     les    di,cs:[101b]         ; adresa z hlav¡ po‘ad.za©¡zen¡
0f8e  33db           xor    bx,bx                ; BX <- 0
0f90  26895d03       mov    es:[di+03],bx        ; stavov‚ slovo za©¡zen¡ <- 0

                                               ;* kontrola ‡¡sla povelu
0f94  268a5d02       mov    bl,es:[di+02]        ; k¢d povelu
0f98  80fb0d         cmp    bl,0d                ; kontrola max. ‡¡sla povelu
0f9b  f5             cmc                         ; CF <- -CF
0f9c  b003           mov    al,03                ; k¢d chyby - nezn m˜ povel
0f9e  7218           jc     0fb8                 ; chyba - velk‚ ‡¡slo povelu

                                               ;* vyvol n¡ funkce
0fa0  d1e3           shl    bx,1                 ; ‡¡slo povelu * 2
0fa2  fc             cld                         ; smˆr p©enosu dat nahoru
0fa3  2ec6061e0300   mov    cs:[031e],00         ; 01=chyba operace s¡Ÿ.za©¡zen¡
0fa9  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
0fae  2eff970110     call   cs:[bx+1001]         ; vol n¡ obsluhy za©¡zen¡
0fb3  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h

                                               ;* n vrat parametr–
0fb8  2ec43e1b10   * les    di,cs:[101b]         ; adresa z hlav¡ po‘ad.za©¡zen¡
0fbd  b402           mov    ah,02                ; stavov‚ slovo * 2
0fbf  9c             pushf                       ; £schova registru p©¡znak–
0fc0  2ed0161e03     rcl    b/cs:[031e],1        ; nastaven¡ p©¡znaku chyby
0fc5  9d             popf                        ; n vrat registru p©¡znak–
0fc6  d0dc           rcr    ah,1                 ; rotace AH-nastav. bitu chyby
0fc8  26894503       mov    es:[di+03],ax        ; stavov‚ slovo za©¡zen¡
0fcc  2e80261d03fe   and    cs:[031d],fe         ; zru¨en¡ p©¡znaku RESET disk–
0fd2  2ef6060503ff   test   cs:[0305],ff         ; ‡¡ta‡ pro TIME-OUT
0fd8  7506           jnz    0fe0
0fda  2ec606050306   mov    cs:[0305],06         ; ‡¡ta‡ pro TIME-OUT

                                               ;* n vrat registr–
0fe0  07           * pop    es                   ; n vrat ES
0fe1  1f             pop    ds                   ; n vrat DS
0fe2  5d             pop    bp                   ; n vrat BP
0fe3  5e             pop    si                   ; n vrat SI
0fe4  5f             pop    di                   ; n vrat DI
0fe5  5a             pop    dx                   ; n vrat DX
0fe6  59             pop    cx                   ; n vrat CX
0fe7  5b             pop    bx                   ; n vrat BX
0fe8  58             pop    ax                   ; n vrat AX

0fe9  fa             cli                         ; z kaz p©eru¨en¡
0fea  2e8b269a0e     mov    sp,cs:[0e9a]         ; n vrat SP
0fef  2e8e169c0e     mov    ss,cs:[0e9c]         ; n vrat SS
0ff4  fb             sti                         ; povolen¡ p©eru¨en¡
0ff5  cb             ret    far
; -----------------------------------------------------------------------------
;     Obsluha rutiny STRATEGIE z driveru NETUNITS.SYS
; -----------------------------------------------------------------------------
                                               ;* obsluha rutiny STRATEGIE
                                               ;* z driveru NETUNITS.SYS
                                               ;* pou‘¡v  se pro p©¡stup
                                               ;* k d lkov˜m disk–m

0ff6  2e891e1b10   * mov    cs:[101b],bx         ; offset adresy z hlav¡ po‘adavku za©¡zen¡
0ffb  2e8c061d10     mov    cs:[101d],es         ; segment adresy z hlav¡ po‘adavku za©¡zen¡
1000  cb             ret    far
; -----------------------------------------------------------------------------
                                                 ; tabulka adres obsluh NETUNITS.SYS

1001                 dw     1aefh                ; 00 (- inicializace za©¡zen¡)
1003                 dw     1020h                ; 01 - kontrola m‚dia
1005                 dw     11abh                ; 02 - vystavˆn¡ bloku parametr– BPB
1007                 dw     1aefh                ; 03 (- vstup kan lu pro ovl d n¡ za©¡zen¡)
1009                 dw     13bch                ; 04 - vstup ze za©¡zen¡
100b                 dw     1aefh                ; 05 (- nedestruktivn¡ vstup)
100d                 dw     1aefh                ; 06 (- status vstupu)
100f                 dw     1aefh                ; 07 (- vypr zdˆn¡ vstupu)
1011                 dw     1798h                ; 08 - z pis na za©¡zen¡
1013                 dw     1798h                ; 09 - z pis s verifikac¡
1015                 dw     1aefh                ; 0a (- status v˜stupu)
1017                 dw     1aefh                ; 0b (- vypr zdnˆn¡ v˜stupu)
1019                 dw     1aefh                ; 0c (- v˜stup z kan lu IOCTL)

101b                 dd     0                    ; adresa z hlav¡ po‘ad.za©¡zen¡

101f  c3             ret
; -----------------------------------------------------------------------------
;     Funkce 01h: Kontrola v˜mˆny m‚dia
; -----------------------------------------------------------------------------

                                               ;* FUNKCE 01 - kontrola m‚dia

                                               ;* inicializace s‚riov‚ho portu
1020  2ef606010301   test   cs:[0301],01         ; parametr FIX
1026  740b           jz     1033                 ; nen¡ FIX - nen¡ inicializace
1028  2ef60600037f   test   cs:[0300],7f         ; ‡¡ta‡ ‡asu pro inicializaci
102e  7503           jnz    1033                 ; nen¡ t©eba inicializovat port
1030  e84b1e         call   2e7e                 ; inicializace s‚riov‚ho portu

                                               ;* nastaven¡ segment–
1033  8cc8         * mov    ax,cs                ; AX <- CS
1035  8ed8           mov    ds,ax                ; DS <- CS
1037  8ec0           mov    es,ax                ; ES <- CS

                                               ;* stanoven¡ doby TIME-OUT
1039  2e8a1e3403     mov    bl,cs:[0334]         ; ‡¡slo funkce pro DOS INT 21h
103e  81e37f00       and    bx,007f              ; ‡¡slo funkce pro DOS INT 21h
1042  b00f           mov    al,0f                ; dlouh  doba pro TIME-OUT
1044  2ef687cd2004   test   cs:[bx+20cd],04      ; je z pisov  funkce DOS ?
104a  90             nop
104b  7502           jnz    104f                 ; je z pisov  funkce DOS
104d  b009           mov    al,09                ; kr tk  doba pro TIME-OUT
104f  a20303       * mov    [0303],al            ; doba pro TIME-OUT p©enosu

                                               ;* vynulov n¡ vys¡lac¡ho bufferu
1052  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
1055  b92000         mov    cx,0020              ; d‚lka bufferu (32 bajt–)
1058  33c0           xor    ax,ax                ; AL <- 0 nulovac¡ bajt
105a  f3aa           rep    stosb                ; vynulov n¡ bufferu po‘adavku
105c  83ef20         sub    di,0020              ; n vrat ukazatele bufferu

                                               ;* sestaven¡ vˆty po‘adavku
105f  c60530         mov    [di],30              ; prvn¡ identifika‡n¡ bajt="0"
1062  c6450164       mov    [di+01],64           ; druh˜ indetifika‡n¡ bajt=100
1066  a01d03         mov    al,[031d]            ; stav TIME-OUT
1069  2480           and    al,80                ; stav bitu 7
106b  80261d037f     and    [031d],7f            ; zru¨en¡ bitu 7
1070  0a060303       or     al,[0303]            ; doba pro TIME-OUT p©enosu
1074  884508         mov    [di+08],al           ; doba pro TIME-OUT operace

                                               ;* p©¡znak operace hled n¡ soub.
1077  2e8a1e3403     mov    bl,cs:[0334]         ; ‡¡slo funkce pro DOS INT 21h
107c  81e37f00       and    bx,007f              ; ‡¡slo funkce pro DOS INT 21h
1080  2e8aa7cd20     mov    ah,cs:[bx+20cd]      ; p©¡znak funkce DOS
1085  80e440         and    ah,40                ; p©¡znak operace hled n¡
1088  086508         or     [di+08],ah           ; nastaven¡ p©¡znaku hled n¡

                                               ;* p©enos parametr– ze z hlav¡
108b  c6450901       mov    [di+09],01           ; ‡¡slo operace - kontrola
108f  83c70a         add    di,000a              ; data vˆty po‘adavku
1092  c4161b10       les    dx,[101b]            ; adresa z hlav¡ po‘ad. za©¡z.
1096  be7d1f         mov    si,1f7d              ; transform. tabulka funkce 01
1099  e80512         call   22a1                 ; p©enos po‘adavku ze z hlav¡

                                               ;* nastaven¡ velikosti sektoru
109c  8bda           mov    bx,dx                ; adresa z hlav¡ po‘adavku
109e  268b7701       mov    si,es:[bx+01]        ; ‡¡slo diskov‚ jednotky
10a2  81e6ff00       and    si,00ff              ; ‡¡slo diskov‚ jednotky
10a6  2e8a843d20     mov    al,cs:[si+203d]      ; © d sektoru (0=128 B...)
10ab  884503         mov    [di+03],al           ; © d sektoru (0=128 B...)

                                               ;* parametry pro vys¡l n¡ zpr vy
10ae  be3729         mov    si,2937              ; parametry pro vysl n¡ zpr vy
10b1  c6440200       mov    [si+02],00           ; inicializace p©¡znak–
10b5  c744037c2d     mov    [si+03],2d7c         ; adresa zpr vy k vysl n¡
10ba  8c4c05         mov    [si+05],cs           ; segment bufferu k vysl n¡ dat
10bd  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
10c2  c744090000     mov    [si+09],0000         ; ‡¡ta‡ ji‘ vyslan˜ch bajt–
10c7  c7440b0000     mov    [si+0b],0000         ; adresa dal¨¡ho kroku programu
10cc  c6440f15       mov    [si+0f],15           ; znak PREX1
10d0  c644101c       mov    [si+10],1c           ; znak PREX2
10d4  c644111e       mov    [si+11],1e           ; znak SYNCH

                                               ;* vysl n¡ zpr vy na protistanici
10d8  fa             cli                         ; z kaz p©eru¨en¡
10d9  33db           xor    bx,bx                ; BX <- 0
10db  e8481b         call   2c26                 ; vysl n¡ vˆty na protistanici

                            ; -----------------------------------------------
                                               ;* struktura vˆty kontroly m‚dia:
                                                 ; (2D7CH):
                                               * Z hlav¡ vˆty:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 01h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 01h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - popisova‡ m‚dia
                                                 ; +0d:     - © d velik. sektoru
                                                 ; +0e-1f: ...... 0
                            ; ------------------------------------------------
                                 (2937h):        ; parametry pro vysl n¡ zpr vy
                                                 ; 00
                                                 ; 01
                                                 ; 02 p©¡znaky operace p©enosu
                                                 ;  bit3=zpr va byla odesl na OK
                                                 ;  bit4=p©¡znak TIME-OUT
                                                 ;  bit5=v¡cen sobn˜ po‘adavek
                                                 ;  bit7=vysl n znak(11)
                                                 ; 03 adresa vys¡lan‚ zpr vy
                                                 ; 07 po‡et bajt– k vysl n¡
                                                 ; 09 ‡¡ta‡ ji‘ vyslan˜ch bajt–
                                                 ; 0b adresa dal¨¡ho programu
                                                 ; 0f znak PREX1 (15h)
                                                 ; 10 znak PREX2 (1ch)
                                                 ; 11 znak SYNCH (1eh)
                            ; -----------------------------------------------

                                               ;* p©¡jem odpovˆdi
10de  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
10e1  c6440200       mov    [si+02],00           ; parametry p©¡jmu
10e5  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
10ea  fb             sti                         ; povolen¡ p©eru¨en¡
10eb  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
10ee  b92c01         mov    cx,012c
10f1  e8cd11         call   22c1                 ; p©¡jem vˆty z protistanice

                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +02: 1   - k¢d odpovˆdi
                                                 ; +07:     - RESET a TIME-OUT
                                                 ; +0a:     - stavov‚ slovo
                                                 ; +0c:     - bajt v˜mˆny m‚dia

                                               ;* chyba p©¡jmu odpovˆdi
10f4  732a           jnc    1120                 ; p©ijata zpr va
10f6  e8230a         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "nep©ijata ‘ dn  odpovˆƒ"
10f9                 db     'keine Antwort empfangen   ',10,13,0

1116  2e800e1e0301 * or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
111c  b002           mov    al,02                ; chyba - za©¡zen¡ nen¡ p©ipraveno
111e  f9             stc
111f  c3             ret

                                               ;* chybn˜ identifik tor odpovˆdi
1120  f6440210     * test   [si+02],10           ; kontrola k¢du odpovˆdi
1124  7415           jz     113b                 ; odpovˆƒ OK
1126  e8f309         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "odpovˆƒ chybn "
1129                 db     'Antwort falsch ',10,13,0

                                               ;* kontrola spr vnosti odpovˆdi
113b  be811f       * mov    si,1f81              ; tabulka pro transformaci
113e  8ccf           mov    di,cs                ; DI <- CS
1140  8edf           mov    ds,di                ; DS <- CS
1142  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
1145  c4161b10       les    dx,[101b]            ; adresa z hlav¡ po‘adavku
1149  803d30         cmp    [di],30              ; je prvn¡ identifika‡n¡ bajt ?
114c  7534           jnz    1182                 ; nen¡ - chybn  odpovˆƒ
114e  807d0164       cmp    [di+01],64           ; je druh˜ identifika‡n¡ bajt ?
1152  752e           jnz    1182                 ; nen¡ - chybn  odpovˆƒ

                                               ;* p©¡znaky RESET a TIME-OUT
1154  8a4507         mov    al,[di+07]           ; p©¡znaky RESET a TIME-OUT
1157  d0e0           shl    al,1
1159  2410           and    al,10
115b  80261d03ef     and    [031d],ef
1160  08061d03       or     [031d],al            ; p©¡znaky RESET a TIME-OUT

                                               ;* ‡ten¡ dat do z hlav¡
1164  83c70a         add    di,000a              ; data zpr vy
1167  e81b11         call   2285                 ; p©enos dat do z hlav¡
116a  8bda           mov    bx,dx                ; z hlav¡ po‘adavku za©¡zen¡

                                               ;* star˜ p©¡znak v˜mˆny
116c  268b7f01       mov    di,es:[bx+01]        ; ‡¡slo jednotky
1170  81e7ff00       and    di,00ff              ; ‡¡slo jednotky
1174  32c0           xor    al,al                ; vynulov n¡ k¢du stavu m‚dia
1176  2e8685bd20     xchg   al,cs:[di+20bd]      ; vyjmut¡ p©¡znaku v˜mˆny
117b  2608470e       or     es:[bx+0e],al        ; nastaven¡ p©¡znaku v˜mˆny
117f  33c0           xor    ax,ax                ; n vratov˜ k¢d - OK
1181  c3             ret

                                               ;* chybn  odpovˆƒ spojen¡
1182  e89709       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "chybn  odpovˆƒ LINK bpb"
1185                 db     'Falsche LINK-Antwort      '
                     db     ', bpb',10,13,0

11a7  b00c         * mov    al,0c                ; k¢d chyby - v¨eobecn  chyba
11a9  f9             stc                         ; p©¡znak chyby
11aa  c3             ret

; -----------------------------------------------------------------------------
;     Funkce 02h: Vystavˆn¡ bloku parametr– BPB
; -----------------------------------------------------------------------------
                                                 ; FUNKCE 02 - vystavˆn¡ BPB

                                               ;* inicializace segment–
11ab  8cc8           mov    ax,cs                ; AX <- CS
11ad  8ed8           mov    ds,ax                ; DS <- CS
11af  8ec0           mov    es,ax                ; ES <- CS

                                               ;* vynulov n¡ vys¡lac¡ho bufferu
11b1  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
11b4  b92000         mov    cx,0020              ; d‚lka bufferu
11b7  33c0           xor    ax,ax                ; nulovac¡ slovo
11b9  f3aa           rep    stosb                ; vynulov n¡ bufferu
11bb  83ef20         sub    di,0020              ; n vrat adresy bufferu

                                               ;* inicializace z hlav¡ zpr vy
11be  c60530         mov    [di],30              ; prvn¡ identifika‡n¡ bajt
11c1  c6450164       mov    [di+01],64           ; druh˜ identifika‡n¡ bajt
11c5  2ea01803       mov    al,cs:[0318]         ; 04=je za©¡zen¡ STDOUT
11c9  d0c0           rol    al,1
11cb  2401           and    al,01
11cd  084502         or     [di+02],al           ; atributy za©¡zen¡
11d0  a01d03         mov    al,[031d]            ; doba TIME-OUT
11d3  2480           and    al,80                ; ‡ten¡ bitu 7
11d5  80261d037f     and    [031d],7f            ; vynulov n¡ bitu 7
11da  0a060303       or     al,[0303]            ; doba pro TIME-OUT p©enosu
11de  884508         mov    [di+08],al           ; doba TIME-OUT
11e1  c6450902       mov    [di+09],02           ; ‡¡slo operace - vystavˆn¡ BPB

                                               ;* p©enos parametr– ze z hlav¡
11e5  83c70a         add    di,000a              ; data zpr vy
11e8  c4161b10       les    dx,[101b]            ; adresa z hlav¡ za©¡zen¡
11ec  be851f         mov    si,1f85              ; transforma‡n¡ tabulka fce 02
11ef  e8af10         call   22a1                 ; p©enos po‘adavku ze z hlav¡

                                               ;* bajt popisova‡e z FAT
11f2  8bda           mov    bx,dx                ; adresa z hlav¡ za©¡zen¡
11f4  26c45f0e       les    bx,es:[bx+0e]        ; adresa bufferu s FAT
11f8  268a07         mov    al,es:[bx]           ; popisova‡ m‚dia za©¡zen¡
11fb  884503         mov    [di+03],al           ; popisova‡ m‚dia z FAT

                                               ;* parametry pro vysl n¡ zpr vy
11fe  be3729         mov    si,2937              ; parametry pro vysl n¡ zpr vy
1201  c6440200       mov    [si+02],00
1205  c744037c2d     mov    [si+03],2d7c         ; offset bufferu pro vysl n¡
120a  8c4c05         mov    [si+05],cs           ; segment bufferu pro vysl n¡
120d  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
1212  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
1217  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
121c  c6440f15       mov    [si+0f],15           ; znak PREX1
1220  c644101c       mov    [si+10],1c           ; znak PREX2
1224  c644111e       mov    [si+11],1e           ; znak SYNCH
1228  fa             cli
1229  33db           xor    bx,bx                ; BX <- 0
122b  e8f819         call   2c26                 ; vysl n¡ vˆty na protistanici

                            ; -----------------------------------------------
                                               ;* struktura vˆty vystavˆn¡ BPB:
                                                 ; (2D7CH):
                                               * Z hlav¡ vˆty:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 02h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 02h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - popisova‡ m‚dia
                                                 ; +0d:     - popisova‡ z FAT
                                                 ; +0e-1f: ...... 0
                            ; ------------------------------------------------
                                 (2937h):        ; parametry pro vysl n¡ zpr vy
                                                 ; 00
                                                 ; 01
                                                 ; 02 p©¡znaky operace p©enosu
                                                 ;  bit3=zpr va byla odesl na OK
                                                 ;  bit4=p©¡znak TIME-OUT
                                                 ;  bit5=v¡cen sobn˜ po‘adavek
                                                 ;  bit7=vysl n znak(11)
                                                 ; 03 adresa vys¡lan‚ zpr vy
                                                 ; 07 po‡et bajt– k vysl n¡
                                                 ; 09 ‡¡ta‡ ji‘ vyslan˜ch bajt–
                                                 ; 0b adresa dal¨¡ho programu
                                                 ; 0f znak PREX1 (15h)
                                                 ; 10 znak PREX2 (1ch)
                                                 ; 11 znak SYNCH (1eh)
                            ; -----------------------------------------------

122e  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
1231  c6440200       mov    [si+02],00
1235  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
123a  fb             sti
123b  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
123e  b92c01         mov    cx,012c
1241  e87d10         call   22c1                 ; p©¡jem vˆty z protistanice

                                               ;* P©ijat  odpovˆƒ:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 02h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 02h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - tabulka BPB

                                               ;* chyba operace
1244  732b           jnc    1271                 ; operace OK
1246  e8d308         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "Nep©i¨la odpovˆƒ BPB"
1249                 db     'bpb - Antwort kommt nicht  ',10,13,0

1267  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace
126d  b002           mov    al,02                ; k¢d chyby - za©¡z. nep©iprav.
126f  f9             stc                         ; p©¡znak chyby operace
1270  c3             ret

                                               ;* test chyby odpovˆdi
1271  f6440210     * test   [si+02],10           ; k¢d OK ?
1275  7416           jz     128d                 ; operace OK
1277  e8a208         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "Chybn  odpovˆƒ"
127a                 db     'Antwort-Fehler  ',10,13,0


                                               ;* kontrola odpovˆdi
128d  be891f         mov    si,1f89h             ; tabulka pro konverzi dat
1290  8ccf           mov    di,cs
1292  8edf           mov    ds,di                ; DS <- CS
1294  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
1297  c4161b10       les    dx,[101b]            ; adresa z hlav¡ za©¡zen¡
129b  803d30         cmp    [di],30              ; prvn¡ identifika‡n¡ bajt ?
129e  7506           jnz    12a6                 ; nesouhlas¡ - chyba
12a0  807d0164       cmp    [di+01],64           ; druh˜ identifika‡n¡ bajt
12a4  7424           jz     12ca                 ; souhlas¡ - OK

                                               ;* chybn  odpovˆƒ
12a6  e87308         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "Chybn  odpovˆƒ DOS"
12a9                 db     'falsche DOS-Antwort, bpb  ',10,13,0

12c6  b00c           mov    al,0ch               ; k¢d chyby - v¨eobecn  chyba
12c8  f9             stc                         ; p©¡znak chyby
12c9  c3             ret

                                               ;*
12ca  90           * nop
12cb  2e80261803fe   and    cs:[0318],fe
12d1  8a4502         mov    al,[di+02]           ; k¢d
12d4  2401           and    al,01
12d6  2e08061803     or     cs:[0318],al


12db  8a4507         mov    al,[di+07]
12de  d0e0           shl    al,1
12e0  2410           and    al,10
12e2  80261d03ef     and    [031d],ef
12e7  08061d03       or     [031d],al

                                               ;* navr cen‚ stavov‚ slovo
12eb  83c70a         add    di,000a              ; data p©enesen‚ vˆty
12ee  e8940f         call   2285                 ; p©enos dat do z hlav¡

                                               ;* nastaven¡ adresy BPB
12f1  8bda           mov    bx,dx                ; adresa z hlav¡
12f3  8d36882d       lea    si,[2d88]            ; tabulka BPB extern¡ho disku
12f7  bff91f         mov    di,1ff9              ; adresa bloku parametr– BPB
12fa  26897f12       mov    es:[bx+12],di        ; adresa bloku parametr– BPB
12fe  268c4f14       mov    es:[bx+14],cs        ; adresa bloku parametr– BPB

                                               ;* p©enos tabulky BPB
1302  06             push   es
1303  8cc8           mov    ax,cs                ; AX <- CS
1305  8ec0           mov    es,ax                ; ES <- CS
1307  b91400         mov    cx,0014              ; d‚lka bloku BPB
130a  fc             cld                         ; smˆr p©enosu dat nahoru
130b  f3a4           rep    movsb                ; p©enos tabulky BPB

                                               ;* inicializace po‡tu sektor–
130d  2ef606180301   test   cs:[0318],01
1313  7433           jz     1348
1315  33c0           xor    ax,ax                ; AX <- 0000
1317  ab             stosw                       ; nulov n¡ po‡tu sektor– 4B
1318  ab             stosw
1319  2e8e061d10     mov    es,cs:[101d]         ; segment z hlav¡ za©¡zen¡

                                               ;* oprava pro velk˜ disk
131e  26c57712       lds    si,es:[bx+12]        ; adresa bloku parametr– BPB
1322  866413         xchg   ah,[si+13]
1325  864410         xchg   al,[si+10]           ; vy¨¨¡ slovo po‡tu sektor–
1328  0bc0           or     ax,ax
132a  741c           jz     1348
132c  894417         mov    [si+17],ax           ; vy¨¨¡ slovo po‡tu sektor–
132f  33c0           xor    ax,ax
1331  874408         xchg   ax,[si+08]           ; po‡et sektor– na m‚diu = 0
1334  894415         mov    [si+15],ax           ; ni‘¨¡ slovo po‡tu sektor–
1337  2ef606180380   test   cs:[0318],80
133d  7509           jnz    1348
133f  bff91f         mov    di,1ff9              ; tabulka parametr– BPB
1342  2ec74508ffff   mov    cs:[di+08],ffff      ; celkov˜ po‡et sektor–

                                               ;* £schova velikosti sektoru
1348  07           * pop    es
1349  26c57712       lds    si,es:[bx+12]        ; adresa bloku parametr– BPB
134d  8b04           mov    ax,[si]              ; po‡et bajt– na sektor
134f  268b7701       mov    si,es:[bx+01]        ; ‡¡slo diskov‚ jednotky
1353  81e6ff00       and    si,00ff
1357  d1e6           shl    si,1                 ; ‡¡slo diskov‚ jednotky * 2
1359  2e89841d20     mov    cs:[si+201d],ax      ; po‡et bajt– na sektor

                                               ;* zji¨tˆn¡ © du sektoru
135e  d1ee           shr    si,1
1360  33c9           xor    cx,cx                ; ‡¡ta‡ © du sektoru
1362  2e3b061003     cmp    ax,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku
1367  7707           ja     1370                 ; je je¨tˆ vˆt¨¡
1369  41           * inc    cx                   ; zv˜¨en¡ ‡¡ta‡e © du sektoru
136a  d1e8           shr    ax,1                 ; d‚lka sektoru AX/2
136c  741d           jz     138b                 ; je ji‘ 0 = OK
136e  73f9           jnc    1369                 ; nen¡ je¨tˆ nalezena d‚lka sektoru

                                               ;* chybn  velikost sektoru
1370  e8a907       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "chybn  d‚lka sektoru"
1373                 db     'Sektorlaenge falsch',13,10,0

1389  b10a         * mov    cl,0a                ; © d d‚lky sektoru = 512 bajt–

                                               ;* ulo‘en¡ © du velikosti sektoru
138b  80e908       * sub    cl,08                ; normalizace © du sektoru
138e  72e0           jc     1370                 ; chyba - je © d < 128 B
1390  2e888c3d20     mov    cs:[si+203d],cl      ; nastaven¡ © du sektoru

                                               ;* zji¨tˆn¡ velikosti sektoru
1395  b88000         mov    ax,0080              ; d‚lka sektoru = 128 bajt–
1398  d3e0           shl    ax,cl                ; AX<-skute‡n  d‚lka sektoru
139a  33c9           xor    cx,cx                ; CX <- 0000
139c  52             push   dx
139d  2e8b161203     mov    dx,cs:[0312]         ; maxim ln¡ d‚lka sektoru
13a2  3bd0           cmp    dx,ax                ; = skute‡n  d‚lka sektoru ?
13a4  7305           jnc    13ab                 ;
13a6  2e8b161003     mov    dx,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku

                                               ;* po‡et komunik. blok–
13ab  41           * inc    cx                   ; ‡¡ta‡ p©en ¨en˜ch vˆt
13ac  2bd0           sub    dx,ax
13ae  73fb           jnc    13ab                 ; po‡et sektor– ve vˆtˆ
13b0  5a             pop    dx
13b1  49             dec    cx                   ; po‡et sektor– na vˆtu
13b2  d1e6           shl    si,1                 ; ‡¡slo disku * 2
13b4  2e898c4d20     mov    cs:[si+204d],cx      ; tabulka po‡tu komun. blok–
13b9  33c0           xor    ax,ax
13bb  c3             ret

; -----------------------------------------------------------------------------
;     Funkce 04h:    Vstup ze za©¡zen¡ (‡ten¡ sektor–)
; -----------------------------------------------------------------------------

                                                 ; FUNKCE 04 - vstup ze za©¡zen¡



                                               ;* adresa bufferu
13bc  26ff750e       push   es:[di+0e]           ; adresa bufferu pro p©enos
13c0  26ff7510       push   es:[di+10]           ; segment adresy bufferu DTA
13c4  26ff7512       push   es:[di+12]           ; po‡et sektor– k p©enosu
13c8  2e80261803fe   and    cs:[0318],fe

13ce  2ef606180380   test   cs:[0318],80
13d4  7420           jz     13f6
13d6  2ef606180340   test   cs:[0318],40         ; test, zda je vstupn¡ za©¡zen¡
13dc  7518           jnz    13f6                 ; je vstupn¡ za©¡zen¡
13de  26837d14ff     cmp    es:[di+14],ffff      ; platn‚ ‡¡slo po‡ te‡n¡ho sektoru ?
13e3  7511           jnz    13f6                 ; platn‚ ‡¡slo sektoru
13e5  2e800e180301   or     cs:[0318],01         ; p©¡znak - ‡¡slo po‡ t. sektoru 4-bajtovˆ
13eb  26ff751a       push   es:[di+1a]           ; ‡¡slo po‡ te‡n¡ho sektoru LOW
13ef  26ff751c       push   es:[di+1c]           ; ‡¡slo po‡ te‡n¡ho sektoru HIGH
13f3  eb17           jmp    140c
13f5  90             nop

13f6  26ff7514     * push   es:[di+14]           ; ‡¡slo po‡ te‡n¡ho sektoru
13fa  2ef606180340   test   cs:[0318],40
1400  740a           jz     140c
1402  26ff7516       push   es:[di+16]           ; adresa n vˆ¨t¡ disku
1406  2e800e180301   or     cs:[0318],01

140c  26ff7512     * push   es:[di+12]           ; po‡et sektor– k p©enosu

                                               ;* po‡et blok– k p©enosu
1410  268b4d12     * mov    cx,es:[di+12]        ; po‡et sektor– k p©enosu
1414  268b7501       mov    si,es:[di+01]        ; ‡¡slo diskov‚ jednotky
1418  81e6ff00       and    si,00ff              ; ‡¡slo diskov‚ jednotky
141c  d1e6           shl    si,1                 ; ‡¡slo jednotky * 2
141e  2e3b8c4d20     cmp    cx,cs:[si+204d]      ; tabulka po‡tu komun. blok–
1423  7205           jc     142a                 ; je men¨¡ - OK
1425  2e8b8c4d20     mov    cx,cs:[si+204d]      ; tabulka po‡tu komun. blok–
142a  26894d12     * mov    es:[di+12],cx        ; po‡et sektor– k p©enosu


142e  8cc8           mov    ax,cs                ; AX <- CS
1430  8ed8           mov    ds,ax                ; DS <- CS
1432  8ec0           mov    es,ax                ; ES <- CS

                                               ;* vymaz n¡ vˆty po‘adavku
1434  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
1437  b92000         mov    cx,0020              ; d‚lka vys¡lac¡ho bufferu
143a  33c0           xor    ax,ax                ; nulovac¡ slovo
143c  f3aa           rep    stosb                ; vynulov n¡ vys¡lac¡ho bufferu
143e  83ef20         sub    di,0020              ; p–vodn¡ adresa bufferu

                                               ;* sestaven¡ z hlav¡ vˆty
1441  c60530         mov    [di],30              ; prvn¡ identifika‡n¡ bajt
1444  c6450164       mov    [di+01],64           ; druh˜ identifika‡n¡ bajt
1448  2ea01803       mov    al,cs:[0318]
144c  2401           and    al,01
144e  084502         or     [di+02],al

                                               ;* stanoven¡ doby TIME-OUT
1451  a01d03         mov    al,[031d]
1454  2480           and    al,80
1456  80261d037f     and    [031d],7f
145b  0a060303       or     al,[0303]            ; doba pro TIME-OUT p©enosu
145f  884508         mov    [di+08],al           ; doba pro TIME-OUT

                                               ;* p©¡znak funkce vyhled v n¡
1462  2e8a1e3403     mov    bl,cs:[0334]         ; ‡¡slo funkce pro DOS INT 21h
1467  81e37f00       and    bx,007f
146b  2e8aa7cd20     mov    ah,cs:[bx+20cd]
1470  80e440         and    ah,40                ; p©¡znak funkce vyhled v n¡
1473  086508         or     [di+08],ah

1476  c6450904       mov    [di+09],04           ; ‡¡slo operace - vstup

147a  83c70a         add    di,000a

                                               ;* p©enos parametr– ze z hlav¡
147d  c4161b10       les    dx,[101b]            ; adresa z hlav¡ po‘adavku
1481  be8c1f         mov    si,1f8c              ; transform.
1484  2ef606180340   test   cs:[0318],40         ; je syst‚m COMPAQ
148a  740f           jz     149b                 ; nen¡ syst‚m COMPAQ
148c  be981f         mov    si,1f98              ; transforma‡n¡ tabulka COMPAQ
148f  e80f0e         call   22a1                 ; p©enos po‘adavku ze z hlav¡
1492  2ec74505ffff   mov    cs:[di+05],ffff      ; p©¡znak COMPAQ
1498  eb04           jmp    149e
149a  90             nop
149b  e8030e       * call   22a1                 ; p©enos po‘adavku ze z hlav¡

                                               ;* parametry pro p©enos
149e  be3729         mov    si,2937              ; parametry pro vysl n¡ zpr vy
14a1  c6440200       mov    [si+02],00
14a5  c744037c2d     mov    [si+03],2d7c         ; buffer pro vysl n¡ po‘adavku
14aa  8c4c05         mov    [si+05],cs
14ad  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
14b2  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
14b7  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
14bc  c6440f15       mov    [si+0f],15           ; znak PREX1
14c0  c644101c       mov    [si+10],1c           ; znak PREX2
14c4  c644111e       mov    [si+11],1e           ; znak SYNCH
14c8  fa             cli
14c9  33db           xor    bx,bx

14cb  e85817         call   2c26                 ; vysl n¡ vˆty na protistanici

                            ; -----------------------------------------------
                                               ;* struktura vˆty vystavˆn¡ BPB:
                                                 ; (2D7CH):
                                               * Z hlav¡ vˆty:
                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +03-07: ...... 0
                                                 ; +08:     - 0-5: doba TIME-OUT
                                                 ;          - bit 6: je hled n¡
                                                 ; +09: 04h - ‡¡slo povelu
                                               ;* Data ze z hlav¡ za©¡zen¡:
                                                 ; +0a: 04h - k¢d povelu
                                                 ; +0b:     - disk. jednotka
                                                 ; +0c:     - popisova‡ m‚dia
                                                 ; +0d:     - po‡et sektor– 2B
                                                 ; +0f:     - ‡¡slo sektoru 2B
                                                 ;            (0ffffh = COMPAQ)
                                                 ; +11:     - ‡¡slo sektoru 4B
                                                 ; +15-1f: ...... 0
                            ; ------------------------------------------------
                                 (2937h):        ; parametry pro vysl n¡ zpr vy
                                                 ; 00
                                                 ; 01
                                                 ; 02 p©¡znaky operace p©enosu
                                                 ;  bit3=zpr va byla odesl na OK
                                                 ;  bit4=p©¡znak TIME-OUT
                                                 ;  bit5=v¡cen sobn˜ po‘adavek
                                                 ;  bit7=vysl n znak(11)
                                                 ; 03 adresa vys¡lan‚ zpr vy
                                                 ; 07 po‡et bajt– k vysl n¡
                                                 ; 09 ‡¡ta‡ ji‘ vyslan˜ch bajt–
                                                 ; 0b adresa dal¨¡ho programu
                                                 ; 0f znak PREX1 (15h)
                                                 ; 10 znak PREX2 (1ch)
                                                 ; 11 znak SYNCH (1eh)
                            ; -----------------------------------------------

14ce  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
14d1  c6440200       mov    [si+02],00
14d5  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
14da  c744037c2d     mov    [si+03],2d7c         ; buffer pro vysl n¡ po‘adavku
14df  8c4c05         mov    [si+05],cs
14e2  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
14e7  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
14ec  fb             sti
14ed  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
14f0  b92c01         mov    cx,012c
14f3  e8cb0d         call   22c1                 ; p©¡jem vˆty z protistanice

                                                 ; +00: "0" - identifikace vˆty
                                                 ; +01: 100 - identifikace vˆty
                                                 ; +07:
                                                 ; +20:     - po‡et p©enesen˜ch sektor–
                                                 ; +22:     -
                                                 ; +23:     - k¢d povelu

                                               ;* chyba p©i ‡ten¡
14f6  7363           jnc    155b                 ; p©¡jem vˆty OK
14f8  e82106         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "nen¡ odpovˆƒ p©i ‡ten¡"
14fb                 db     'keine Antwort beim Lesen',10,13,0

1516  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace
151c  2ec43e1b10   * les    di,cs:[101b]         ; adresa z hlav¡ po‘adavku
1521  59             pop    cx
1522  2ef606180301   test   cs:[0318],01
1528  7417           jz     1541
152a  2ef606180340   test   cs:[0318],40
1530  750b           jnz    153d
1532  268f451c       pop    es:[di+1c]
1536  268f451a       pop    es:[di+1a]
153a  eb09           jmp    1545
153c  90             nop
153d  268f4516     * pop    es:[di+16]
1541  268f4514     * pop    es:[di+14]           ; n vrat ‡¡sla po‡ t. sektoru
1545  268f4512     * pop    es:[di+12]           ; n vrat po‡tu sektor–
1549  268f4510       pop    es:[di+10]           ; n vrat adresy bufferu
154d  268f450e       pop    es:[di+0e]           ; n vrat adresy bufferu
1551  33c9           xor    cx,cx                ; po‡et sektor– = 0
1553  26894d12       mov    es:[di+12],cx        ; po‡et sektor–
1557  b002           mov    al,02                ; k¢d chyby - nep©ipraveno
1559  f9             stc                         ; p©¡znak chyby
155a  c3             ret

                                               ;* chyba p©i ‡ten¡
155b  f6440210     * test   [si+02],10           ; kontrola ‡¡sla operace
155f  7415           jz     1576                 ; = 0 - OK
1561  e8b805         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "chyba ‡ten¡"
1564                 db     'Lesefehler   ',10,13,0
1574  eba6           jmp    151c                 ; n vrat z obsluhy

                                               ;* kontrola p©ijat‚ vˆty
1576  bea41f       * mov    si,1fa4
1579  8ccf           mov    di,cs
157b  8edf           mov    ds,di                ; DS <- CS
157d  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
1580  c4161b10       les    dx,[101b]            ; adresa z hlav¡ po‘adavku
1584  b00c           mov    al,0c                ; k¢d chyby - v¨eobecn  funkce
1586  803d30         cmp    [di],30              ; prvn¡ kontroln¡ bajt = "0"
1589  7506           jnz    1591                 ; nen¡ - chyba
158b  807d0164       cmp    [di+01],64           ; druh˜ kontroln¡ bajt = 100
158f  7427           jz     15b8                 ; shoda - OK
1591  e88805         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text - chyba paketu souboru
1594                 db     'Datenpaket wird erwartet',10,13,0

15af  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
15b5  e964ff         jmp    151c                 ; chybov˜ n vrat


                                               ;* p©¡znak RESET a TIME-OUT
15b8  8a4507       * mov    al,[di+07]
15bb  d0e0           shl    al,1
15bd  2410           and    al,10
15bf  80261d03ef     and    [031d],ef
15c4  08061d03       or     [031d],al

                                               ;* p©enos dat do z hlav¡
15c8  83c70a         add    di,000a              ; data vˆty
15cb  e8b70c         call   2285                 ; p©enos dat do z hlav¡

                                               ;* velikost p©enesen˜ch dat
15ce  8bda           mov    bx,dx                ; adresa z hlav¡ za©¡zen¡
15d0  268b4712       mov    ax,es:[bx+12]        ; po‡et p©enesen˜ch sektor–
15d4  268b7701       mov    si,es:[bx+01]        ; ‡¡slo jednotky
15d8  81e6ff00       and    si,00ff
15dc  2e8a8c3d20     mov    cl,cs:[si+203d]      ; © d sektoru (0=128 B...)
15e1  80c107         add    cl,07                ; © d sektoru * 128
15e4  d3e0           shl    ax,cl                ; d‚lka jednoho sektoru
15e6  8bc8           mov    cx,ax                ; d‚lka
15e8  0bc9           or     cx,cx                ; po‡et p©ijat˜ch bajt– = 0 ?
15ea  7555           jnz    1641                 ; nen¡ = 0

                                               ;* chyba - nejsou ‘ dn  data
15ec  e82d05         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "Nejsou data "
15ef                 db     'keine Daten !   ',10,13,0

1602  8bfb           mov    di,bx                ; adresa z hlav¡ po‘adavku
1604  59             pop    cx
1605  33c9           xor    cx,cx                ; CX <- 0000
1607  2ef606180301   test   cs:[0318],01
160d  7417           jz     1626
160f  2ef606180340   test   cs:[0318],40
1615  750b           jnz    1622
1617  268f451c       pop    es:[di+1c]
161b  268f451a       pop    es:[di+1a]
161f  eb09           jmp    162a
1621  90             nop
1622  268f4516     * pop    es:[di+16]
1626  268f4514     * pop    es:[di+14]
162a  268f4512     * pop    es:[di+12]
162e  268f4510       pop    es:[di+10]
1632  268f450e       pop    es:[di+0e]
1636  26894d12       mov    es:[di+12],cx
163a  268b4503       mov    ax,es:[di+03]
163e  d0e4           shl    ah,1
1640  c3             ret

                                               ;* p©¡jem dat
1641  fa           * cli
1642  2ec43e1b10     les    di,cs:[101b]         ; adresa z hlav¡ po‘adavku
1647  8cce           mov    si,cs
1649  8ede           mov    ds,si                ; DS <- CS
164b  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
164e  268b450e       mov    ax,es:[di+0e]        ; adresa bufferu pro p©enos
1652  894403         mov    [si+03],ax           ; adresa bufferu pro p©enos
1655  268b4510       mov    ax,es:[di+10]        ; adresa bufferu pro p©enos
1659  894405         mov    [si+05],ax           ; adresa bufferu pro p©enos
165c  894c07         mov    [si+07],cx           ; po‡et bajt– k vysl n¡
165f  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
1664  c6440200       mov    [si+02],00
1668  e85d0d         call   23c8                 ; p©¡jem dat
166b  fb             sti


166c  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
166f  b99001         mov    cx,0190
1672  e84c0c         call   22c1                 ; p©¡jem vˆty z protistanice
1675  7325           jnc    169c

                                               ;* chyba - data nep©ich zej¡
1677  e8a204         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

167a                 db     'Daten kommen nicht an ',13,10,0

1693  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
1699  e980fe         jmp    151c                 ; n vrat z programu


                                               ;* test p©ijat‚ vˆty dat
169c  f6440210     * test   [si+02],10
16a0  7430           jz     16d2
16a2  e87704         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

16a5                 db     'Fehler beim Lesen der Daten ',10,13,0

16c4  b004           mov    al,04
16c6  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
16cc  e94dfe         jmp    151c                 ; n vrat p©i chybˆ


16cf  e99300       * jmp    1765                 ; je konec p©enosu


                                               ;* sn¡‘en¡ ‡¡ta‡e sektor–
16d2  2ec43e1b10   * les    di,cs:[101b]         ; adresa z hlav¡ po‘adavku
16d7  59             pop    cx
16d8  268b4512       mov    ax,es:[di+12]        ; po‡et sektor– k p©enosu
16dc  2bc8           sub    cx,ax                ; sn¡‘en¡ po‡tu sektor–
16de  26894d12       mov    es:[di+12],cx        ; zbyl˜ po‡et sektor– k p©enosu
16e2  74eb           jz     16cf                 ; nen¡ ji‘ dal¨¡ sektor
16e4  72e9           jc     16cf                 ; nen¡ ji‘ dal¨¡ sektor

                                               ;* zv˜¨en¡ ukazatele sektor–
16e6  51             push   cx                   ; zbyl˜ po‡et sektor– k p©enosu
16e7  2ef606180301   test   cs:[0318],01
16ed  7420           jz     170f
16ef  2ef606180340   test   cs:[0318],40
16f5  750c           jnz    1703
16f7  2601451a       add    es:[di+1a],ax
16fb  2683551c00     adc    es:[di+1c],0000
1700  eb11           jmp    1713
1702  90             nop
1703  26014514     * add    es:[di+14],ax
1707  2683551600     adc    es:[di+16],0000
170c  eb05           jmp    1713
170e  90             nop
170f  26014514     * add    es:[di+14],ax

                                               ;* zv˜¨en¡ adresy bufferu
1713  268b7501     * mov    si,es:[di+01]
1717  81e6ff00       and    si,00ff
171b  2e8a8c3d20     mov    cl,cs:[si+203d]      ; © d sektoru (0=128 B...)
1720  80c103         add    cl,03
1723  d3e0           shl    ax,cl                ; d‚lka p©en ¨en˜ch dat
1725  26014510       add    es:[di+10],ax        ; zv˜¨en¡ adresy bufferu


1729  26f6450480     test   es:[di+04],80        ; byla operace OK ?
172e  b00c           mov    al,0c
1730  742f           jz     1761                 ; operace OK

                                               ;* chyba operace ‡ten¡ od DOS
1732  e8e703         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

1735                 db     'DOS-Zugriffsfehler beim Lessen   ',10,13,0

1758  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿ. za©¡z.
175e  e9bbfd         jmp    151c                 ; p©¡jem dal¨¡ho sektoru

                                               ;* p©enos dal¨¡ ‡ sti dat
1761  e9acfc       * jmp    1410                 ; p©enos dal¨¡ho paketu


1764  59             pop    cx

                                               ;* konec operace ‡ten¡
1765  90             nop
1766  2ef606180301   test   cs:[0318],01
176c  7417           jz     1785
176e  2ef606180340   test   cs:[0318],40
1774  750b           jnz    1781
1776  268f451c       pop    es:[di+1c]
177a  268f451a       pop    es:[di+1a]
177e  eb09           jmp    1789
1780  90             nop
1781  268f4516     * pop    es:[di+16]
1785  268f4514     * pop    es:[di+14]
1789  268f4512     * pop    es:[di+12]
178d  268f4510       pop    es:[di+10]
1791  268f450e       pop    es:[di+0e]
1795  33c0           xor    ax,ax
1797  c3             ret

; -----------------------------------------------------------------------------

                                                 ; FUNKCE 08,09 - z pis na za©¡zen¡

1798  26ff750e       push   es:[di+0e]
179c  26ff7510       push   es:[di+10]
17a0  26ff7512       push   es:[di+12]
17a4  2e80261803fe   and    cs:[0318],fe
17aa  2ef606180380   test   cs:[0318],80
17b0  7420           jz     17d2
17b2  2ef606180340   test   cs:[0318],40
17b8  7518           jnz    17d2
17ba  26837d14ff     cmp    es:[di+14],ffff
17bf  7511           jnz    17d2
17c1  2e800e180301   or     cs:[0318],01
17c7  26ff751a       push   es:[di+1a]
17cb  26ff751c       push   es:[di+1c]
17cf  eb17           jmp    17e8
17d1  90             nop
17d2  26ff7514       push   es:[di+14]
17d6  2ef606180340   test   cs:[0318],40
17dc  740a           jz     17e8
17de  26ff7516       push   es:[di+16]
17e2  2e800e180301   or     cs:[0318],01
17e8  26ff7512       push   es:[di+12]
17ec  268b4d12       mov    cx,es:[di+12]
17f0  268b7501       mov    si,es:[di+01]
17f4  81e6ff00       and    si,00ff
17f8  d1e6           shl    si,1
17fa  2e3b8c4d20     cmp    cx,cs:[si+204d]      ; tabulka po‡tu komun. blok–
17ff  7205           jc     1806
1801  2e8b8c4d20     mov    cx,cs:[si+204d]      ; tabulka po‡tu komun. blok–
1806  26894d12       mov    es:[di+12],cx
180a  8cc8           mov    ax,cs
180c  8ed8           mov    ds,ax
180e  8ec0           mov    es,ax
1810  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
1813  b92000         mov    cx,0020
1816  33c0           xor    ax,ax
1818  f3aa           rep    stosb
181a  83ef20         sub    di,0020
181d  c60530         mov    [di],30
1820  c6450164       mov    [di+01],64
1824  2ea01803       mov    al,cs:[0318]
1828  2401           and    al,01
182a  084502         or     [di+02],al
182d  2ea01603       mov    al,cs:[0316]         ; verze oper. syst‚mu * 2
1831  884503         mov    [di+03],al           ; verze OS * 2
1834  a01d03         mov    al,[031d]
1837  2480           and    al,80
1839  80261d037f     and    [031d],7f
183e  0a060303       or     al,[0303]            ; doba pro TIME-OUT p©enosu
1842  884508         mov    [di+08],al
1845  c6450908       mov    [di+09],08           ; ‡¡slo operace - z pis na za©¡zen¡
1849  83c70a         add    di,000a
184c  c4161b10       les    dx,[101b]            ; adresa z hlav¡ po‘adavku za©¡zen¡
1850  bea91f         mov    si,1fa9
1853  2ef606180340   test   cs:[0318],40
1859  740f           jz     186a
185b  beb51f         mov    si,1fb5
185e  e8400a         call   22a1                 ; p©enos po‘adavku ze z hlav¡ za©¡zen¡
1861  2ec74505ffff   mov    cs:[di+05],ffff
1867  eb05           jmp    186e
1869  90             nop
186a  90             nop
186b  e8330a         call   22a1                 ; p©enos po‘adavku ze z hlav¡ za©¡zen¡
186e  bf2125         mov    di,2521              ; parametry pro p©¡jem zpr vy
1871  c6450280       mov    [di+02],80
1875  be3729         mov    si,2937              ; parametry pro vysl n¡ zpr vy
1878  c6440200       mov    [si+02],00
187c  c744037c2d     mov    [si+03],2d7c         ; buffer pro vysl n¡ po‘adavku
1881  8c4c05         mov    [si+05],cs
1884  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
1889  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
188e  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
1893  c6440f15       mov    [si+0f],15           ; znak PREX1
1897  c644101c       mov    [si+10],1c           ; znak PREX2
189b  c644111e       mov    [si+11],1e           ; znak SYNCH
189f  33db           xor    bx,bx
18a1  e88213         call   2c26                 ; vysl n¡ vˆty na protistanici
18a4  be3729         mov    si,2937              ; parametry pro vysl n¡ zpr vy
18a7  b92c01         mov    cx,012c
18aa  e8140a         call   22c1                 ; p©¡jem vˆty z protistanice
18ad  7368           jnc    1917
18af  e86a02         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

18b2                 db     'keine Antwort beim Schreiben',10,13,0

18d1  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
18d7  b002           mov    al,02
18d9  8ccf           mov    di,cs
18db  8edf           mov    ds,di
18dd  c43e1b10       les    di,[101b]            ; adresa z hlav¡ po‘adavku za©¡zen¡
18e1  59             pop    cx
18e2  2ef606180301   test   cs:[0318],01
18e8  7417           jz     1901
18ea  2ef606180340   test   cs:[0318],40
18f0  750b           jnz    18fd
18f2  268f451c       pop    es:[di+1c]
18f6  268f451a       pop    es:[di+1a]
18fa  eb09           jmp    1905
18fc  90             nop
18fd  268f4516       pop    es:[di+16]
1901  268f4514       pop    es:[di+14]
1905  268f4512       pop    es:[di+12]
1909  268f4510       pop    es:[di+10]
190d  268f450e       pop    es:[di+0e]
1911  26294d12       sub    es:[di+12],cx
1915  f9             stc
1916  c3             ret

1917  fa             cli
1918  c43e1b10       les    di,[101b]            ; adresa z hlav¡ po‘adavku za©¡zen¡
191c  be3729         mov    si,2937              ; parametry pro vysl n¡ zpr vy
191f  c6440200       mov    [si+02],00
1923  268b450e       mov    ax,es:[di+0e]
1927  894403         mov    [si+03],ax
192a  268b4510       mov    ax,es:[di+10]
192e  894405         mov    [si+05],ax
1931  268b4512       mov    ax,es:[di+12]
1935  56             push   si
1936  268b7501       mov    si,es:[di+01]
193a  81e6ff00       and    si,00ff
193e  2e8a8c3d20     mov    cl,cs:[si+203d]      ; © d sektoru (0=128 B...)
1943  80c107         add    cl,07
1946  d3e0           shl    ax,cl
1948  5e             pop    si
1949  894407         mov    [si+07],ax           ; po‡et bajt– k vysl n¡
194c  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
1951  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
1956  c6440f19       mov    [si+0f],19           ; znak PREX1
195a  c644101b       mov    [si+10],1b           ; znak PREX2
195e  c644111e       mov    [si+11],1e           ; znak SYNCH
1962  bf2125         mov    di,2521              ; parametry pro p©¡jem zpr vy
1965  c6450200       mov    [di+02],00
1969  c745037c2d     mov    [di+03],2d7c         ; buffer pro vysl n¡ po‘adavku
196e  8c4d05         mov    [di+05],cs
1971  c745072000     mov    [di+07],0020         ; po‡et bajt– k vysl n¡
1976  c745090000     mov    [di+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
197b  c7450b0000     mov    [di+0b],0000
1980  33db           xor    bx,bx
1982  e8a112         call   2c26                 ; vysl n¡ vˆty na protistanici
1985  fb             sti
1986  be2125         mov    si,2521              ; parametry pro p©¡jem zpr vy
1989  b99001         mov    cx,0190
198c  e83209         call   22c1                 ; p©¡jem vˆty z protistanice
198f  7351           jnc    19e2
1991  e88801         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

1994                 'Schreiben ohne Antwort   ',10,13,0

19b0  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
19b6  b002           mov    al,02
19b8  e91eff         jmp    18d9
19bb  e85e01         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

19be                 db     'DOS-Paket erforderlich',10,13,0

19d7  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
19dd  b002           mov    al,02
19df  e9f7fe         jmp    18d9
19e2  bec11f         mov    si,1fc1
19e5  8ccf           mov    di,cs
19e7  8edf           mov    ds,di
19e9  bf7c2d         mov    di,2d7c              ; buffer pro vysl n¡ po‘adavku
19ec  c4161b10       les    dx,[101b]            ; adresa z hlav¡ po‘adavku za©¡zen¡
19f0  803d30         cmp    [di],30
19f3  75c6           jnz    19bb
19f5  807d0164       cmp    [di+01],64           ;
19f9  75c0           jnz    19bb
19fb  8a4507         mov    al,[di+07]
19fe  d0e0           shl    al,1
1a00  2410           and    al,10
1a02  80261d03ef     and    [031d],ef
1a07  08061d03       or     [031d],al
1a0b  83c70a         add    di,000a
1a0e  e87408         call   2285                 ; p©enos dat do z hlav¡ po‘adavku za©¡zen¡
1a11  2ec43e1b10     les    di,cs:[101b]         ; adresa z hlav¡ po‘adavku za©¡zen¡
1a16  59             pop    cx
1a17  268b4512       mov    ax,es:[di+12]        ; adresa bloku parametr– BPB
1a1b  2bc8           sub    cx,ax
1a1d  26894d12       mov    es:[di+12],cx
1a21  7703           ja     1a26
1a23  e99600         jmp    1abc
1a26  51             push   cx
1a27  2ef606180301   test   cs:[0318],01
1a2d  7420           jz     1a4f
1a2f  2ef606180340   test   cs:[0318],40
1a35  750c           jnz    1a43
1a37  2601451a       add    es:[di+1a],ax        ;
1a3b  2683551c00     adc    es:[di+1c],0000
1a40  eb11           jmp    1a53
1a42  90             nop
1a43  26014514       add    es:[di+14],ax
1a47  2683551600     adc    es:[di+16],0000
1a4c  eb05           jmp    1a53
1a4e  90             nop
1a4f  26014514       add    es:[di+14],ax
1a53  268b7501       mov    si,es:[di+01]        ; ‡¡slo diskov‚ jednotky
1a57  81e6ff00       and    si,00ff
1a5b  2e8a8c3d20     mov    cl,cs:[si+203d]      ; © d sektoru (0=128 B...)
1a60  80c103         add    cl,03
1a63  d3e0           shl    ax,cl                ; po‡et rotac¡
1a65  26014510       add    es:[di+10],ax        ;
1a69  26f6450480     test   es:[di+04],80        ; je blokov‚ za©¡zen¡ ?
1a6e  7448           jz     1ab8                 ; je blokov‚ za©¡zen¡
1a70  268a4503       mov    al,es:[di+03]        ; ni‘¨¡ bajt atributu za©¡zen¡
1a74  3ccf           cmp    al,cf                ;
1a76  7522           jnz    1a9a                 ; tisk hl ¨en¡ "chyba z pisu"
1a78  32c0           xor    al,al
1a7a  26884503       mov    es:[di+03],al        ; verze OS * 2
1a7e  e89b00         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "¨patn  verze DOS"
1a81                 db     'falsche DOS-Version ',10,13,0

1a9a  e87f00         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "Chyba z pisu"
1a9d                 db     'SCHREIBFEHLER',10,13,0

1aad  2e800e1e0301   or     cs:[031e],01         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
1ab3  32c0           xor    al,al
1ab5  e921fe         jmp    18d9
1ab8  e931fd         jmp    17ec
1abb  59             pop    cx
1abc  90             nop
1abd  2ef606180301   test   cs:[0318],01
1ac3  7417           jz     1adc
1ac5  2ef606180340   test   cs:[0318],40
1acb  750b           jnz    1ad8
1acd  268f451c       pop    es:[di+1c]
1ad1  268f451a       pop    es:[di+1a]
1ad5  eb09           jmp    1ae0
1ad7  90             nop
1ad8  268f4516       pop    es:[di+16]
1adc  268f4514       pop    es:[di+14]
1ae0  268f4512       pop    es:[di+12]
1ae4  268f4510       pop    es:[di+10]
1ae8  268f450e       pop    es:[di+0e]
1aec  33c0           xor    ax,ax
1aee  c3             ret
; -----------------------------------------------------------------------------

                                               ;* chybnˆ vyvolan  funkce

1aef  b003         * mov    al,03                ; k¢d chyby - nezn m˜ povel
1af1  f9             stc                         ; nastaven¡ p©¡znaku chyby
1af2  c3             ret

; -----------------------------------------------------------------------------

1af3                 db     0

                                                 ; zak¢dovan˜ text z adr. 0264h
1af4                 db     0fch,17h,26h,46h
1af8                 db     86h,7,4,0
1afc                 db     1ah,36h,6ch,0dah
1b00                 db     0c5h,0f5h,81h
1b03                 db     20h,20h,20h,20h

; -----------------------------------------------------------------------------

                                               ;* v˜stup textu na displej DEBUG
                                                 ; VSTUP: DS:SI=adresa textu

1b07  ac           * lodsb                       ; ‡ten¡ znaku k v˜stupu
1b08  0ac0           or     al,al                ; je ji‘ konec textu 00 ?
1b0a  740f           jz     1b1b                 ; je konec textu - n vrat
1b0c  b40e           mov    ah,0e                ; funkce v˜stupu znaku
1b0e  56             push   si                   ; £schova ukazatele textu SI
1b0f  f6060c0301     test   [030c],01            ; je zapnut re‘im DEBUG ?
1b14  7402           jz     1b18                 ; nem  prob¡hat v˜stup znaku
1b16  cd10           int    10                   ; v˜stup znaku na displej
1b18  5e           * pop    si                   ; n vrat ukazatele textu SI
1b19  ebec           jmp    1b07                 ; dal¨¡ znak k v˜stupu
1b1b  c3           * ret
; -----------------------------------------------------------------------------

                                               ;* tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; vytiskne se text, kter˜
                                                 ; n sleduje za instrukc¡ vol n¡

1b1c  fa           * cli                         ; z kaz p©eru¨en¡
1b1d  fc             cld                         ; smˆr p©enosu dat nahoru
1b1e  2ef6060c0302   test   cs:[030c],02         ; prob¡h  ji‘ v˜pis DEBUG ?
1b24  7416           jz     1b3c                 ; neprob¡h  v˜pis DEBUG
                                                ;* zde se pouze nalezne adresa
1b26  2e8936851b     mov    cs:[1b85],si         ; £schova SI
1b2b  8cce           mov    si,cs                ; SI <- CS
1b2d  8ede           mov    ds,si                ; DS <- CS
1b2f  5e           * pop    si                   ; n vratov  adresa
1b30  ac             lodsb                       ; na‡ten¡ znaku
1b31  0ac0           or     al,al                ; je ji‘ posledn¡ znak textu ?
1b33  75fa           jnz    1b2f                 ; nen¡ posledn¡ znak - dal¨¡
1b35  56             push   si                   ; n vratov  adresa do programu
1b36  2e8b36851b     mov    si,cs:[1b85]         ; n vrat obsahu SI
1b3b  c3             ret                         ; pokra‡uje na adrese za textem
                                                ;* zde pokra‡uje, pokud ji‘ nen¡
1b3c  2e800e0c0302 * or     cs:[030c],02         ; nastaven¡ p©¡znaku DEBUG
1b42  2e8936891b     mov    cs:[1b89],si         ; £schova SI
1b47  2e893e871b     mov    cs:[1b87],di         ; £schova DI
1b4c  2ea38b1b       mov    cs:[1b8b],ax         ; £schova AX
1b50  2e8c1e8d1b     mov    cs:[1b8d],ds         ; £schova DS
1b55  9e             sahf                        ; ulo‘en¡ registru p©¡znak–
1b56  2e88268f1b     mov    cs:[1b8f],ah         ; ulo‘en¡ registru p©¡znak–
1b5b  8cce           mov    si,cs                ; SI <- CS
1b5d  8ede           mov    ds,si                ; DS <- CS
1b5f  5e             pop    si                   ; n vratov  adresa do programu
1b60  e8a4ff         call   1b07                 ; v˜stup textu na displej
1b63  56             push   si                   ; nov  n vratov  adresa
1b64  2e8a268f1b     mov    ah,cs:[1b8f]         ; n vrat registru p©¡znak–
1b69  9f             lahf                        ; n vrat registru p©¡znak– z AH
1b6a  2e8e1e8d1b     mov    ds,cs:[1b8d]         ; n vrat registru DS
1b6f  2ea18b1b       mov    ax,cs:[1b8b]         ; n vrat registru AX
1b73  2e8b3e871b     mov    di,cs:[1b87]         ; n vrat registru DI
1b78  2e8b36891b     mov    si,cs:[1b89]         ; n vrat registru SI
1b7d  2e80260c03fd   and    cs:[030c],fd         ; zru¨en¡ p©¡znaku DEBUG
1b83  fa             cli                         ; z kaz p©eru¨en¡
1b84  c3             ret

1b85                 dw     0                    ; £schova registru SI (1)

1b87                 dw     0                    ; £schova registru DI (2)
1b89                 dw     0                    ; £schova registru SI (2)
1b8b                 dw     0                    ; £schova registru AX (2)
1b8d                 dw     0                    ; £schova registru DS (2)
1b8f                 db     0                    ; £schova registru p©¡znak– (2)


1b8f  0000           add    [bx+si],al
1b91  0000           add    [bx+si],al
1b93  0000           add    [bx+si],al

1b94                 dd     0                    ; adresa skoku

; -----------------------------------------------------------------------------

                                                 ; p©esmˆrov n¡ za©¡zen¡
1b98  c47c03       * les    di,[si+03]           ; adresa driveru za©¡zen¡ NET
1b9b  26807d0164     cmp    es:[di+01],64        ; je s¡Ÿov˜ driver ?
1ba0  751f           jnz    1bc1                 ; nen¡ - chyba p©esmˆrov n¡
1ba2  26807d0911     cmp    es:[di+09],11        ; je operace 11h
1ba7  740a           jz     1bb3                 ; je operace 11h - OK
1ba9  26807d0912     cmp    es:[di+09],12
1bae  7403           jz     1bb3                 ; je operace 12h - OK
1bb0  eb0f           jmp    1bc1                 ; chyba p©esmˆrov n¡
1bb2  90             nop
1bb3  c7440b501d   * mov    [si+0b],1d50         ; nastaven¡ adresy pro p©esmˆrov n¡ zpˆt
1bb8  8c4c0d         mov    [si+0d],cs           ; segment adresy p©esmˆrov n¡
1bbb  804c0201       or     [si+02],01           ; p©esmˆrov n¡ provedeno OK
1bbf  f8             clc
1bc0  cb             ret    far

1bc1  e858ff       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

1bc4                 db     'Fehler c_reot',10,13,0

1bd4  f9             stc
1bd5  c6440200       mov    [si+02],00           ; p©esmˆrov n¡ neprovedeno
1bd9  cb             ret    far
; -----------------------------------------------------------------------------

                                                 ; funkce NettBios INT 5ch/00
1bda  fa           * cli                         ; z kaz p©eru¨en¡
1bdb  2ef606262904   test   cs:[2926],04         ; obsluhovan‚ funkce p©enosu
1be1  7510           jnz    1bf3
1be3  2ef6067d2920   test   cs:[297d],20
1be9  7508           jnz    1bf3
1beb  b311           mov    bl,11
1bed  e83600         call   1c26
1bf0  e9dd00         jmp    1cd0
1bf3  fb           * sti
1bf4  90             nop
1bf5  90             nop
1bf6  ebe2           jmp    1bda

                                                 ; funkce NettBios INT 5ch/01
1bf8  2ef606262904 * test   cs:[2926],04         ; obsluhovan‚ funkce p©enosu
1bfe  7522           jnz    1c22
1c00  2ef6067d2920   test   cs:[297d],20
1c06  751a           jnz    1c22
1c08  2e803e210300   cmp    cs:[0321],00         ; 1=p©¡znak testu INT 28h
1c0e  7512           jnz    1c22                 ; prob¡h  obsluha s¡Ÿov‚ho za©¡zen¡
1c10  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
1c15  b312           mov    bl,12                ; k¢d
1c17  e80c00         call   1c26
1c1a  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
1c1f  33c0           xor    ax,ax
1c21  cf             iret
1c22  b8ffff       * mov    ax,ffff
1c25  cf             iret

1c26  2e893e901b   * mov    cs:[1b90],di
1c2b  2e8c06921b     mov    cs:[1b92],es
1c30  06             push   es
1c31  1f             pop    ds
1c32  8bf7           mov    si,di
1c34  8ccf           mov    di,cs
1c36  8ec7           mov    es,di
1c38  bffe2d         mov    di,2dfe
1c3b  b92000         mov    cx,0020
1c3e  33c0           xor    ax,ax
1c40  f3aa           rep    stosb
1c42  83ef20         sub    di,0020
1c45  26c60530       mov    es:[di],30
1c49  26c6450164     mov    es:[di+01],64
1c4e  57             push   di
1c4f  56             push   si
1c50  83c70d         add    di,000d
1c53  83c604         add    si,0004
1c56  b90800         mov    cx,0008
1c59  f3a4           rep    movsb
1c5b  5e             pop    si
1c5c  5f             pop    di
1c5d  c534           lds    si,[si]
1c5f  26885d09       mov    es:[di+09],bl
1c63  8a4402         mov    al,[si+02]
1c66  2688450a       mov    es:[di+0a],al
1c6a  8b4c12         mov    cx,[si+12]
1c6d  26894d15       mov    es:[di+15],cx
1c71  c5740e         lds    si,[si+0e]
1c74  8b04           mov    ax,[si]
1c76  26894518       mov    es:[di+18],ax
1c7a  8b4402         mov    ax,[si+02]
1c7d  2689451a       mov    es:[di+1a],ax
1c81  8b4404         mov    ax,[si+04]
1c84  2689451c       mov    es:[di+1c],ax
1c88  8b4406         mov    ax,[si+06]
1c8b  2689451e       mov    es:[di+1e],ax
1c8f  8cce           mov    si,cs
1c91  8ede           mov    ds,si
1c93  be7b29         mov    si,297b
1c96  c6440200       mov    [si+02],00
1c9a  c74403fe2d     mov    [si+03],2dfe
1c9f  8c4c05         mov    [si+05],cs
1ca2  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
1ca7  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
1cac  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
1cb1  c6440f17       mov    [si+0f],17           ; znak PREX1
1cb5  c644101c       mov    [si+10],1c           ; znak PREX2
1cb9  c644111e       mov    [si+11],1e           ; znak SYNCH
1cbd  bb0200         mov    bx,0002
1cc0  e8630f         call   2c26                 ; vysl n¡ vˆty na protistanici
1cc3  be8325         mov    si,2583
1cc6  c6440200       mov    [si+02],00
1cca  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
1ccf  c3             ret


1cd0  be8325       * mov    si,2583
1cd3  b92c01         mov    cx,012c
1cd6  e8e805         call   22c1                 ; p©¡jem vˆty z protistanice
1cd9  7321           jnc    1cfc
1cdb  e83efe         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

1cde                 db     'Fehler Zeicheneinheit  ',10,13,0

1cf8  b80280         mov    ax,8002
1cfb  cf             iret

1cfc  fa           * cli
1cfd  8cce           mov    si,cs
1cff  8ede           mov    ds,si
1d01  befe2d         mov    si,2dfe
1d04  803c30         cmp    [si],30
1d07  7543           jnz    1d4c
1d09  807c0164       cmp    [si+01],64
1d0d  753d           jnz    1d4c
1d0f  2ec43e901b     les    di,cs:[1b90]
1d14  26c43d         les    di,es:[di]
1d17  8b440b         mov    ax,[si+0b]           ; adresa p©esmˆrov n¡ za©¡zen¡
1d1a  26894503       mov    es:[di+03],ax
1d1e  268a4502       mov    al,es:[di+02]
1d22  3c04           cmp    al,04
1d24  740b           jz     1d31
1d26  3c03           cmp    al,03
1d28  7407           jz     1d31
1d2a  3c05           cmp    al,05
1d2c  7403           jz     1d31
1d2e  eb19           jmp    1d49
1d30  90             nop
1d31  268a6512       mov    ah,es:[di+12]
1d35  26c47d0e       les    di,es:[di+0e]
1d39  0ae4           or     ah,ah
1d3b  740c           jz     1d49
1d3d  8a4418         mov    al,[si+18]
1d40  268805         mov    es:[di],al
1d43  46             inc    si
1d44  47             inc    di
1d45  fecc           dec    ah
1d47  75f4           jnz    1d3d
1d49  33c0           xor    ax,ax
1d4b  cf             iret

1d4c  b80c80         mov    ax,800c
1d4f  cf             iret

                                                ;*
1d50  fa             cli                         ; z kaz p©eru¨en¡
1d51  fc             cld                         ; smˆr p©enosu dat nahoru
1d52  2e8926d407     mov    cs:[07d4],sp         ; £schova ukazatele z sobn¡ku
1d57  2e8c16d607     mov    cs:[07d6],ss         ; £schova segmentu z sobn¡ku
1d5c  8ccc           mov    sp,cs                ; SP <- CS
1d5e  8ed4           mov    ss,sp                ; SS <- CS
1d60  bc9e08         mov    sp,089e              ; vlastn¡ z sobn¡k
1d63  50             push   ax                   ; £schova AX
1d64  53             push   bx                   ; £schova BX
1d65  51             push   cx                   ; £schova CX
1d66  52             push   dx                   ; £schova DX
1d67  57             push   di                   ; £schova DI
1d68  56             push   si                   ; £schova SI
1d69  06             push   es                   ; £schova ES
1d6a  1e             push   ds                   ; £schova DS
1d6b  8ccf           mov    di,cs                ; DI <- CS
1d6d  8edf           mov    ds,di                ; DS <- DI
1d6f  806402fe       and    [si+02],fe
1d73  c7440b981b     mov    [si+0b],1b98         ; adresa p©esmˆrov n¡ za©¡zen¡
1d78  8c4c0d         mov    [si+0d],cs
1d7b  fb             sti
1d7c  8cca           mov    dx,cs
1d7e  8ec2           mov    es,dx
1d80  bf3e2e         mov    di,2e3e
1d83  8d5520         lea    dx,[di+20]           ; ukl dac¡ adresa
1d86  b016           mov    al,16                ; d‚lka halvi‡ky
1d88  8a650a         mov    ah,[di+0a]           ; identifika‡n¡ bajt
1d8b  e82207         call   24b0                 ; vytvo©en¡ z hlav¡ za©¡zen¡
1d8e  8d4518         lea    ax,[di+18]
1d91  89452e         mov    [di+2e],ax
1d94  8c4d30         mov    [di+30],cs
1d97  8b4515         mov    ax,[di+15]
1d9a  894532         mov    [di+32],ax
1d9d  2ec5361720     lds    si,cs:[2017]         ; adresa pracovn¡ DTA
                                                ;* nalezen¡ za©¡zen¡ NET
1da2  b80080       * mov    ax,8000              ; p©¡znak blokov‚ho za©¡zen¡
1da5  854404         test   [si+04],ax           ; je blokov‚ za©¡zen¡ ?
1da8  7424           jz     1dce                 ; nen¡ blokov‚ za©¡zen¡ - dal¨¡
1daa  8b440a         mov    ax,[si+0a]           ; identifikace po‘adovan‚ho za©¡zen¡
1dad  263b450d       cmp    ax,es:[di+0d]        ; je hledan‚ za©¡zen¡ ?
1db1  751b           jnz    1dce                 ; nen¡ hledan‚ za©¡zen¡ - dal¨¡ za©¡zen¡
1db3  8b440c         mov    ax,[si+0c]           ; identifikace po‘adovan‚ho za©¡zen¡
1db6  263b450f       cmp    ax,es:[di+0f]        ; je hledan‚ za©¡zen¡ ?
1dba  7512           jnz    1dce                 ; nen¡ hledan‚ za©¡zen¡ - dal¨¡ za©¡zen¡
1dbc  8b440e         mov    ax,[si+0e]           ; identifikace po‘adovan‚ho za©¡zen¡
1dbf  263b4511       cmp    ax,es:[di+11]        ; je hledan‚ za©¡zen¡ ?
1dc3  7509           jnz    1dce                 ; nen¡ hledan‚ za©¡zen¡ - dal¨¡ za©¡zen¡
1dc5  8b4410         mov    ax,[si+10]           ; identifikace po‘adovan‚ho za©¡zen¡
1dc8  263b4513       cmp    ax,es:[di+13]        ; je hledan‚ za©¡zen¡ ?
1dcc  7438           jz     1e06                 ; za©¡zen¡ nalezeno
1dce  c534         * lds    si,[si]              ; DS:SI <- adresa dal¨¡ho za©¡zen¡
1dd0  81feffff       cmp    si,ffff              ; je posledn¡ za©¡zen¡ ?
1dd4  75cc           jnz    1da2                 ; nen¡ posledn¡ za©¡zen¡ - dal¨¡ za©¡zen¡
1dd6  e843fd         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                ;* hl ¨en¡, ‘e za©¡zen¡ NET nenalezeno
1dd9                 db     'Net: Device nicht gefunden',10,13,0

1df6  b80181         mov    ax,8101
1df9  26894523       mov    es:[di+23],ax
1dfd  33c0           xor    ax,ax
1dff  26894532       mov    es:[di+32],ax
1e03  eb28           jmp    1e2d
1e05  90             nop

1e06  0e             push   cs
1e07  07             pop    es
1e08  bb5e2e         mov    bx,2e5e
1e0b  8b4406         mov    ax,[si+06]
1e0e  2ea3941b       mov    cs:[1b94],ax
1e12  2e8c1e961b     mov    cs:[1b96],ds
1e17  2eff1e941b     call   far cs:[1b94]
1e1c  8b4408         mov    ax,[si+08]
1e1f  2ea3941b       mov    cs:[1b94],ax
1e23  2e8c1e961b     mov    cs:[1b96],ds
1e28  2eff1e941b     call   far cs:[1b94]
1e2d  32e4         * xor    ah,ah
1e2f  8b7406         mov    si,[si+06]
1e32  817cfe3235     cmp    [si-02],3532
1e37  7402           jz     1e3b
1e39  fec4           inc    ah
1e3b  8ccf           mov    di,cs
1e3d  8edf           mov    ds,di
1e3f  bf3e2e         mov    di,2e3e
1e42  0ae4           or     ah,ah
1e44  751a           jnz    1e60
1e46  8b4523         mov    ax,[di+23]
1e49  3cff           cmp    al,ff
1e4b  7513           jnz    1e60
1e4d  fa             cli
1e4e  beb425         mov    si,25b4
1e51  c7440b501d     mov    [si+0b],1d50         ; adresa p©esmˆrov n¡ za©¡zen¡
1e56  8c4c0d         mov    [si+0d],cs
1e59  804c0201       or     [si+02],01
1e5d  eb51           jmp    1eb0
1e5f  90             nop
1e60  89450b         mov    [di+0b],ax
1e63  8b4532         mov    ax,[di+32]
1e66  894515         mov    [di+15],ax
1e69  fa             cli
1e6a  0e             push   cs
1e6b  1f             pop    ds
1e6c  beb425         mov    si,25b4
1e6f  c6440200       mov    [si+02],00
1e73  8b4403         mov    ax,[si+03]
1e76  8b5c05         mov    bx,[si+05]
1e79  8b74fa         mov    si,[si-06]
1e7c  894403         mov    [si+03],ax
1e7f  895c05         mov    [si+05],bx
1e82  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
1e87  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
1e8c  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
1e91  c6440f16       mov    [si+0f],16           ; znak PREX1
1e95  c644101c       mov    [si+10],1c           ; znak PREX2
1e99  c644111e       mov    [si+11],1e           ; znak SYNCH
1e9d  c57403         lds    si,[si+03]
1ea0  807c0912       cmp    [si+09],12
1ea4  740a           jz     1eb0
1ea6  fb             sti
1ea7  bb0300         mov    bx,0003
1eaa  e8790d         call   2c26                 ; vysl n¡ vˆty na protistanici
1ead  eb01           jmp    1eb0
1eaf  90             nop
1eb0  fa             cli
1eb1  1f             pop    ds
1eb2  07             pop    es
1eb3  5e             pop    si
1eb4  5f             pop    di
1eb5  5a             pop    dx
1eb6  59             pop    cx
1eb7  5b             pop    bx
1eb8  58             pop    ax
1eb9  2e8b26d407     mov    sp,cs:[07d4]
1ebe  2e8e16d607     mov    ss,cs:[07d6]
1ec3  fb             sti
1ec4  cb             ret    far


1ec5                 db     'imodes',0
1ecc                 db     0

; -----------------------------------------------------------------------------
;                         Obsluha INT 5ch
; -----------------------------------------------------------------------------

1ecd                                           ;* vlastn¡ obsluha INT 5ch
                                                 ; (slu‘by s¡Ÿov‚ho adapt‚ru BIOS)

1ecd  0ac0           or     al,al                ; ‡¡slo portu COM
1ecf  7416           jz     1ee7
1ed1  2e3a060d03     cmp    al,cs:[030d]         ; ‡¡slo portu COM (0=COM1)
1ed6  740f           jz     1ee7
1ed8  2e833ef00200   cmp    cs:[02f0],0000       ; byla p–vodnˆ nˆjak  obsluha INT 5ch ?
1ede  7407           jz     1ee7                 ; nebyla ‘ dn  obsluha
1ee0  9c             pushf
1ee1  2eff1ef002     call   far cs:[02f0]        ; byla obsluha - skok do n¡
1ee6  cf             iret

1ee7  0ae4         * or     ah,ah                ; ‡¡slo funkce = 0 ?
1ee9  7503           jnz    1eee
1eeb  e9ecfc         jmp    1bda                 ; funkce NettBios INT 5ch/00

1eee  80fc01       * cmp    ah,01                ; funkce = 01 ?
1ef1  7503           jnz    1ef6
1ef3  e902fd         jmp    1bf8                 ; funkce NettBios INT 5ch/01
1ef6  80fc02         cmp    ah,02                ; funkce = 02 ?
1ef9  7521           jnz    1f1c
1efb  e84300         call   1f41                 ; funkce NettBios INT 5ch/02 - test zanepr zdnˆn¡ po‡¡ta‡e
1efe  7218           jc     1f18
1f00  2ef606262904   test   cs:[2926],04         ; obsluhovan‚ funkce p©enosu
1f06  7510           jnz    1f18
1f08  2ef6067d2920   test   cs:[297d],20
1f0e  7508           jnz    1f18
1f10  2efe062103     inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
1f15  33c0           xor    ax,ax
1f17  cf             iret

1f18  b8ffff       * mov    ax,ffff              ; chyba
1f1b  cf             iret

1f1c  80fc03       * cmp    ah,03                ; funkce = 03 ?
1f1f  7506           jnz    1f27
1f21  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
1f26  cf             iret

1f27  80fc04       * cmp    ah,04                ; funkce = 04 ?
1f2a  7511           jnz    1f3d
1f2c  52             push   dx                   ; funkce NettBios INT 5ch/04
1f2d  2e8b160a03     mov    dx,cs:[030a]         ; adresa portu COM
1f32  0bd2           or     dx,dx                ; je definov n ?
1f34  b0ff           mov    al,ff                ; k¢d chyby inicializace
1f36  7403           jz     1f3b                 ; nen¡ definov n - chyba
1f38  e8230d         call   2c5e                 ; dotaz na p©ipravenost protistanice
1f3b  5a           * pop    dx
1f3c  cf             iret
1f3d  b80180       * mov    ax,8001              ; chyba - nezn m  funkce
1f40  cf             iret

                                                 ; funkce NettBios INT 5ch/02
                                                 ; - test zanepr zdnˆn¡ DOS

                                                 ; VSTUP: CY=DOS nebo BIOS je zanepr zdnˆn

1f41  1e           * push   ds                   ; £schova DS
1f42  53             push   bx                   ; £schova BX
1f43  2ec51e2203     lds    bx,cs:[0322]         ; adresa p©¡znaku aktivity funkce DOS
1f48  803f00         cmp    [bx],00              ; je aktivn¡ funkce DOS ?
1f4b  5b             pop    bx                   ; n vrat BX
1f4c  1f             pop    ds                   ; n vrat DS
1f4d  750a           jnz    1f59                 ; funkce DOS je aktivn¡
1f4f  2ef6062103ff   test   cs:[0321],ff         ; 1=p©¡znak testu INT 28h
1f55  7502           jnz    1f59                 ; prob¡h  obsluha s¡Ÿov‚ho za©¡zen¡
1f57  f8             clc                         ; p©¡znak, ‘e ‘ dn  operace neprob¡h 
1f58  c3             ret
1f59  f9           * stc                         ; nelze prov‚st - DOS je aktivn¡
1f5a  c3             ret


1F50   F6 06 21 03 FF 75 02 F8 C3 F9 C3 0C 43 31 1C 58   ..!..u......C1.X
1F60   2B 5A D2 65 EC FD DF 9B 13 00 34 44 A6 61 9C 69   +Z.e......4D.a.i
1F70   96 7E 20 20 20 49 62 42 52 13 4B 22 00

þ
1f7d                                           ;* 1 - kontrola m‚dia (dotaz)

                     db     3                    ; po‡et bajt– tabulky
                     db     2                    ; offset 2: k¢d povelu
                     db     1                    ; offset 1: ‡¡slo jednotky
                     db     13                   ; offset 13: popisova‡ m‚dia

1f81                                           ;* 1 - kontrola m‚dia (odpovˆƒ)

                     db     3                    ; po‡et bajt– tabulky
                     db     3                    ; 3: ni‘¨¡ bajt stavov‚ho slova
                     db     4                    ; 4: vy¨¨¡ bajt stavov‚ho slova
                     db     14                   ; 14h: p©¡znak v˜mˆny m‚dia


1f85                                           ;* 2 - vystavˆn¡ BPB (dotaz)
                     db     3                    ; po‡et bajt–
                     db     2                    ; 2: k¢d povelu
                     db     1                    ; 1: ‡¡slo jednotky
                     db     13                   ; 13h: popisova‡ m‚dia

1f89                                           ;* 2 - vystavˆn¡ BPB (odpovˆƒ)
                     db     2                    ; po‡et bajt–
                     db     3                    ; 3: stavov‚ slovo - LOW
                     db     4                    ; 4: stavov‚ slovo - HIGH

1f8c                                           ;* 4 - ‡ten¡ dat (DOS)
                     db     11                   ; po‡et bajt–
                     db     2                    ; 2: k¢d povelu
                     db     1                    ; 1: diskov  jednotka
                     db     0dh                  ; 0dh: popisova‡ m‚dia
                     db     12h                  ; 12h: po‡et sektor– 1.B
                     db     13h                  ; 13h: po‡et sektor– 2.B
                     db     14h                  ; 14h: ‡¡slo sektoru 1.B
                     db     15h                  ; 15h: ‡¡slo sektoru 2.B
                     db     1ah                  ; 1ah: (‡¡slo sektoru 1.B)
                     db     1bh                  ; 1bh: (‡¡slo sektoru 2.B)
                     db     1ch                  ; 1ch: (‡¡slo sektoru 3.B)
                     db     1dh                  ; 1dh: (‡¡slo sektoru 4.B)

1f98                                           ;* 4 - ‡ten¡ dat (COMPAQ)
                     db     11
                     db     2                    ; 2: k¢d povelu
                     db     1                    ; 1: diskov  jednotka
                     db     0dh                  ; 0dh: popisova‡ m‚dia
                     db     12h                  ; 12h: po‡et sektor– 1.B
                     db     13h                  ; 13h: po‡et sektor– 2.B
                     db     14h                  ; 14h: ‡¡slo sektoru 1.B
                     db     15h                  ; 15h: ‡¡slo sektoru 2.B
                     db     14h                  ; 14h: (‡¡slo sektoru 1.B)
                     db     15h                  ; 15h: (‡¡slo sektoru 2.B)
                     db     16h                  ; 16h: (‡¡slo sektoru 3.B)
                     db     17h                  ; 17h: (‡¡slo sektoru 4.B)

1fa4                                           ;* 4 - ‡ten¡ dat (odpovˆƒ)
                     db     4                    ; po‡et bajt–
                     db     12h                  ; 12h: po‡et na‡ten˜ch sektor–
                     db     13h                  ; 13h: po‡et na‡ten˜ch sektor–
                     db     0bh                  ; 0bh: ???
                     db     2                    ; 02: k¢d povelu

1fa9                 db     1
                     db     0dh

1fab


1FA0   14 15 16 17 04 03 04 12 13 0B 02 01 0D 12 13 14   ................
1FB0   15 1A 1B 1C 1D 0B 02 01 0D 12 13 14 15 14 15 16   ................
1FC0   17 04 03 04 12 13 00 02 02 01 00 02 70 00 A0 05   ............p...

                                                 ; standardn¡ tabulka BPB

1fc6                 dw     0200h                ; 00: po‡et bajt– na sektor
1fc8                 db     2                    ; 02: po‡et sektor– na aloka‡n¡ blok
1fc9                 dw     1                    ; 03: po‡et zav dˆc¡ch a rezervovan˜ch sektor–
1fcb                 db     2                    ; 05: po‡et aloka‡n¡ch tabulek FAT
1fcc                 dw     0070h                ; 06: max. po‡et polo‘ek z kl. adres ©e
1fce                 dw     05a0h                ; 08: po‡et sektor– na m‚diu (=1440=737 KB)
1fd0                 db     0fdh                 ; 0a: popisova‡ m‚dia (disketa 720 KB)
1fd1                 dw     3                    ; 0b: po‡et sektor– na tabulku FAT
1fd3                 dw     9                    ; 0d: po‡et sektor– na stopu
1fd5                 dw     2                    ; 0f: po‡et stran m‚dia
1fd7                 dw     0                    ; 11:

1fd9                 dw     16 dup(1fc6h)        ; tabulka adres BPB disk–

1ff9                 db     14h dup(0)           ; tabulka parametr– BPB


2000   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2010   00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00   ................

2017                 dd     0                    ; adresa pracovn¡ DTA

                                               ;* parametry extern¡ho disku
201d                 db     16 dup(200h)         ; tabulka d‚lek sektor– disk–
203d                 db     16 dup(2)            ; tabulka © d– sektor– disk–
204d                 dw     16 dup(2)            ; tabulka po‡tu komun. blok–

                                               ;* parametry zve©ejnˆn‚ho disku
206d                 dw     16 dup(200h)         ; tabulka d‚lek sektor– disk–
208d                 db     16 dup(2)            ; tabulka © d– sektor– disk–
209d                 dw     16 dup(2)            ; tabulka po‡tu komun. blok–

20bd                 db     16 dup(0ffh)         ; stavy v˜mˆny m‚di¡ ext. disk–

                                               ;* tabulka p©¡znak– funkc¡ DOS

20cd                 db     1,1,1,1              ; funkce 00h a‘ 03h
20d1                 db     1,1,1,1              ; funkce 04h a‘ 07h
20d5                 db     1,1,1,1              ; funkce 08h a‘ 0bh
20d9                 db     1,4,1,0              ; funkce 0ch a‘ 0fh
20dd                 db     4,41h,41h,4          ; funkce 10h a‘ 13h
20e1                 db     0,4,4,4              ; funkce 14h a‘ 17h
20e5                 db     0,1,1,1              ; funkce 18h a‘ 1bh
20e9                 db     1,0,0,1              ; funkce 1ch a‘ 1fh
20ed                 db     0,0,4,0              ; funkce 20h a‘ 23h
20f1                 db     1,1,1,0              ; funkce 24h a‘ 27h
20f5                 db     4,1,1,1              ; funkce 28h a‘ 2bh
20f9                 db     1,1,1,1              ; funkce 2ch a‘ 2fh
20fd                 db     1,1,1,1              ; funkce 30h a‘ 33h
2101                 db     1,1,41h,1            ; funkce 34h a‘ 37h
2105                 db     1,4,4,1              ; funkce 38h a‘ 3bh
2109                 db     4,0,4,0              ; funkce 3ch a‘ 3fh
210d                 db     4,4,0,4              ; funkce 40h a‘ 43h
2111                 db     4,0,0,1              ; funkce 44h a‘ 47h
2115                 db     1,1,1,41h            ; funkce 48h a‘ 4bh
2119                 db     1,1,41h,41h          ; funkce 4ch a‘ 4fh
211d                 db     1,1,1,0              ; funkce 50h a‘ 53h
2121                 db     1,1,4,1              ; funkce 54h a‘ 57h
2125                 db     1,4,4,4              ; funkce 58h a‘ 5bh
2129                 db     0,1,0,0              ; funkce 5ch a‘ 5fh
212d                 db     0,0,1,0              ; funkce 60h a‘ 63h
2131                 db     0,0,0,0              ; funkce 64h a‘ 67h
2135                 db     0,0,0,0              ; funkce 68h a‘ 6bh
2139                 db     0,0,0,0              ; funkce 6ch a‘ 6fh
213d                 db     0,0,1,0              ; funkce 70h a‘ 73h
2141                 db     0,0,0,0              ; funkce 74h a‘ 77h
2145                 db     0,0,0,0              ; funkce 78h a‘ 7bh
2149                 db     0,0,0,0              ; funkce 7ch a‘ 7fh


2150                 dd     0                    ; £schova ukazatele z sobn¡ku
2154                 dd     0

2158                 dw     60h dup(?)           ; pracovn¡ z sobn¡k

2218                 dw     0                    ; vlastn¡ z sobn¡k


; *****************************************************************************
;
;                 Obsluha komunikace - vys¡l n¡ a p©¡jem
;
; *****************************************************************************


þ
221a                                           ;* tabulka adres obsluh p©i p©eru¨en¡
221a                 dw     29bdh                ; 00 zmˆna stavu modemu
221c                 dw     2264h                ; 01 (nen¡ p©eru¨en¡ - n vrat)
221e                 dw     2264h                ; 02 (vys¡lac¡ buffer pr zdn˜)
2220                 dw     2264h                ; 03 (nen¡ p©eru¨en¡ - n vrat)
2222                 dw     25d7h                ; 04 byl p©ijat znak
2224                 dw     2264h                ; 05 (nen¡ p©eru¨en¡ - n vrat)
2226                 dw     28c9h                ; 06 zmˆna stavu p©ij¡mac¡ linky
2228                 dw     2264h                ; 07 (nen¡ p©eru¨en¡ - n vrat)


; -----------------------------------------------------------------------------
222a                 db     'pass'               ; identifika‡n¡ slovo COMx

; -----------------------------------------------------------------------------
;                   Obsluha komunika‡n¡ho portu COM
; -----------------------------------------------------------------------------

                                               ;* pracovn¡ z sobn¡k
222e  2e89265021     mov    cs:[2150],sp         ; £schova ukazatele z sobn¡ku
2233  2e8c165221     mov    cs:[2152],ss         ; £schova segmentu z sobn¡ku
2238  8ccc           mov    sp,cs
223a  8ed4           mov    ss,sp                ; vlastn¡ segment z sobn¡ku
223c  bc1822         mov    sp,2218              ; vlastn¡ z sobn¡k

                                               ;* £schova registr–
223f  50             push   ax                   ; £schova AX
2240  53             push   bx                   ; £schova BX
2241  51             push   cx                   ; £schova CX
2242  52             push   dx                   ; £schova DX
2243  56             push   si                   ; £schova SI
2244  57             push   di                   ; £schova DI
2245  06             push   es                   ; £schova ES
2246  1e             push   ds                   ; £schova DS
2247  8cc8           mov    ax,cs
2249  8ed8           mov    ds,ax                ; DS <- CS
224b  fc             cld                         ; smˆr p©enosu nahoru

                                               ;* zji¨tˆn¡ po‘adavku obsluhy
224c  8cc8         * mov    ax,cs
224e  8ed8           mov    ds,ax                ; DS <- CS
2250  8b160a03       mov    dx,[030a]            ; adresa portu COM
2254  42             inc    dx
2255  42             inc    dx                   ; stavov˜ registr p©eru¨en¡
2256  ec             in     al,dx                ; ‡ten¡ stavu p©eru¨en¡
2257  250700         and    ax,0007              ; stav p©eru¨en¡

                                               ;* obsluha podle stavu p©eru¨en¡
225a  8bf0           mov    si,ax                ; stav p©eru¨en¡
225c  d1e6           shl    si,1                 ; stav p©eru¨en¡ * 2
225e  ff941a22       call   [si+221a]            ; vol n¡ obsluhy p©eru¨en¡
2262  ebe8           jmp    224c                 ; dal¨¡ test

                                               ;* n vrat z p©eru¨en¡ COM
2264  5a             pop    dx                   ; zru¨en¡ n vratov‚ adresy
2265  fa             cli                         ; z kaz p©eru¨en¡

                                               ;* n sled. 3 instrukce jsou p©i
                                               ;* instalaci programu nahrazeny
                                               ;* NOP, pokud je ji‘ nainstalov n
                                               ;* KIR_LINK (pokra‡uje se v nˆm)

                                               ;* uvolnˆn¡ ©adi‡e p©eru¨en¡
2266  ba2000         mov    dx,0020              ; port ©adi‡e p©eru¨en¡
2269  8ac2           mov    al,dl                ; AL <- 20h ukon‡en¡ p©eru¨en¡
226b  ee             out    dx,al                ; ukon‡en¡ v¨ech p©eru¨en¡

                                               ;* n vrat registr– a z sobn¡ku
226c  1f             pop    ds                   ; n vrat DS
226d  07             pop    es                   ; n vrat ES
226e  5f             pop    di                   ; n vrat DI
226f  5e             pop    si                   ; n vrat SI
2270  5a             pop    dx                   ; n vrat DX
2271  59             pop    cx                   ; n vrat CX
2272  5b             pop    bx                   ; n vrat BX
2273  58             pop    ax                   ; n vrat AX
2274  2e8b265021     mov    sp,cs:[2150]         ; n vrat ukazatele z sobn¡ku
2279  2e8e165221     mov    ss,cs:[2152]         ; n vrat segmentu z sobn¡ku
227e  cf           * iret                        ; tato instrukce je nahrazena
                                                 ; NOP p©i instalaci, pokud je
                                                 ; nalezen v pamˆti KIR_LINK

                                               ;* pokra‡ov n¡ v druh‚m KIR_LINK
227f  fa             cli                         ; z kaz p©eru¨en¡
2280  2eff2ef402     jmp    far cs:[02f4]        ; skok na dal¨¡ KIR_LINK

; -----------------------------------------------------------------------------
;     P©enos dat z p©ijat‚ vˆty do z hlav¡ po‘adavku za©¡zen¡
; -----------------------------------------------------------------------------

                                                 ; VSTUP: DS:DI=p©ijat  vˆta
                                                 ;        CS:SI=transf. tabulka
                                                 ;        ES:DX=z hlav¡ za©¡zen¡

                                               ;* inicializace registr–
2285  33c0         * xor    ax,ax                ; AX <- 0
2287  33c9           xor    cx,cx                ; CX <- 0
2289  2e8a04         mov    al,cs:[si]           ; po‡et bajt– p©ev. tabulky
228c  46             inc    si                   ; za‡ tek dat p©evodn¡ tabulky
228d  8ac8           mov    cl,al                ; po‡et bajt– k p©enosu

                                               ;* p©evod 1 bajtu do z hlav¡
228f  2e8a04       * mov    al,cs:[si]           ; offset bajtu v tabulce
2292  46             inc    si                   ; dal¨¡ polo‘ka
2293  8bda           mov    bx,dx                ; adresa z hlav¡ za©¡zen¡
2295  03d8           add    bx,ax                ; adresa bajtu v z hlav¡ za©¡z.
2297  8a05           mov    al,[di]              ; p©en ¨en˜ bajt
2299  47             inc    di                   ; dal¨¡ polo‘ka
229a  268807         mov    es:[bx],al           ; ulo‘en¡ nov‚ hodnoty bajtu
229d  e2f0           loop   228f                 ; dal¨¡ polo‘ka

229f  f8             clc
22a0  c3             ret

; -----------------------------------------------------------------------------
;     P©enos dat ze z hlav¡ po‘adavku za©¡zen¡ do vys¡lan‚ vˆty
; -----------------------------------------------------------------------------

                                                 ; VSTUP: DS:DI=vys¡lan  vˆta
                                                 ;        CS:SI=transf. tabulka
                                                 ;        ES:DX=z hlav¡ za©¡zen¡

                                               ;* inicializace registr–
22a1  57           * push   di                   ; £schova DI
22a2  53             push   bx                   ; £schova BX
22a3  33c0           xor    ax,ax                ; AX <- 0
22a5  33c9           xor    cx,cx                ; CX <- 0
22a7  2e8a04         mov    al,cs:[si]           ; po‡et bajt– k transformaci
22aa  46             inc    si                   ; adresa za‡ tku dat tabulky
22ab  8ac8           mov    cl,al                ; po‡et bajt– k p©enosu

                                               ;* p©evod 1 bajtu ze z hlav¡
22ad  2e8a04       * mov    al,cs:[si]           ; offset polo‘ky ze z hlav¡
22b0  46             inc    si                   ; zv˜¨en¡ ukazatele
22b1  8bda           mov    bx,dx                ; adresa z hlav¡ za©¡zen¡
22b3  03d8           add    bx,ax                ; adresa polo‘ky v z hlav¡
22b5  268a07         mov    al,es:[bx]           ; bajt ze z hlav¡ za©¡zen¡
22b8  8805           mov    [di],al              ; ulo‘en¡ do vys¡lan‚ vˆty
22ba  47             inc    di                   ; dal¨¡ ukl dac¡ adresa
22bb  e2f0           loop   22ad                 ; dal¨¡ bajt k p©enosu

                                               ;* n vrat registr–
22bd  5b             pop    bx                   ; n vrat BX
22be  5f             pop    di                   ; n vrat DI
22bf  f8             clc                         ; nulov n¡ p©¡znaku chyby
22c0  c3             ret

; -----------------------------------------------------------------------------
;     P©¡jem vˆty z protistanice
; -----------------------------------------------------------------------------

                                               ;* VSTUP: CX=doba pro TIME-OUT

                                               ;* prvn¡ syst‚mov‚ho ‡¡ta‡e ‡asu
22c1  fb           * sti                         ; povolen¡ p©eru¨en¡
22c2  51             push   cx                   ; maxim ln¡ doba pro TIME-OUT
22c3  33c0           xor    ax,ax                ; funkce ‡ten¡ ‡¡ta‡e ‡asu
22c5  cd1a           int    1a                   ; ‡ten¡ syst‚mov‚ho ‡asova‡e
22c7  8bda           mov    bx,dx                ; ni‘¨¡ slovo ‡¡ta‡e ‡asu

                                               ;* smy‡ka ‡ek n¡ na p©¡jem
22c9  57           * push   di
22ca  2ef6060f0301   test   cs:[030f],01         ; 01=p©¡znak SERVER
22d0  7447           jz     2319                 ; nen¡ stanice SERVER
22d2  2e8b3e1b03     mov    di,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem


22d7  2ef6450201   * test   cs:[di+02],01        ; p©¡znak - prob¡h  vys¡l n¡
22dc  750e           jnz    22ec                 ; prob¡h  vys¡l n¡
22de  2e8b7dfc       mov    di,cs:[di-04]
22e2  2e3b3e1b03     cmp    di,cs:[031b]         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
22e7  75ee           jnz    22d7                 ; ‡ek n¡ na zmˆnu stavu
22e9  eb2e           jmp    2319
22eb  90             nop


22ec  2efe062103   * inc    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
22f1  2e800e1e0302   or     cs:[031e],02         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
22f7  87f7           xchg   si,di
22f9  2eff5c0b       call   far cs:[si+0b]       ; p©esmˆrov n¡ za©¡zen¡
22fd  87f7           xchg   si,di
22ff  2e8b7dfc       mov    di,cs:[di-04]
2303  2e893e1b03     mov    cs:[031b],di         ; adresa aktu ln¡ tabulky parametr– pro p©¡jem
2308  2e80261e03fd   and    cs:[031e],fd         ; 01=chyba operace s¡Ÿov‚ho za©¡zen¡
230e  2efe0e2103     dec    b/cs:[0321]          ; 1=p©¡znak testu INT 28h
2313  33c0           xor    ax,ax                ; funkce ‡ten¡ syst‚mov˜ch hodin
2315  cd1a           int    1a                   ; ‡ten¡ syst‚mov˜ch hodin
2317  8bda           mov    bx,dx                ; ni‘¨¡ ‡ st ‡¡ta‡e ‡asu

2319  8b7cfa       * mov    di,[si-06]
231c  fa             cli
231d  f6450280       test   [di+02],80
2321  5f             pop    di
2322  7522           jnz    2346


2324  f6440208       test   [si+02],08
2328  741c           jz     2346
232a  fb             sti
232b  e8eef7         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; hl ¨en¡ - odpovˆƒ je p©¡li¨ rychl 
232e                 db     'Antwort zu schnell',10,13,0

2343  eb2e           jmp    2373                 ; p©eru¨en¡ vys¡l n¡
2345  90             nop


2346  fb           * sti
2347  f6440280       test   [si+02],80           ; byla zpr va p©ijata OK ?
234b  7578           jnz    23c5                 ; zpr va byla p©ijata OK
234d  f6440210       test   [si+02],10
2351  7520           jnz    2373                 ; p©eru¨en¡ vys¡l n¡
2353  57             push   di
2354  8b7cfa         mov    di,[si-06]
2357  f6450210       test   [di+02],10
235b  5f             pop    di
235c  7515           jnz    2373                 ; chyba

                                               ;* kontrola doby pro TIME-OUT
235e  33c0           xor    ax,ax                ; ‡ten¡ syst‚mov‚ho ‡asova‡e
2360  53             push   bx                   ; £schova BX
2361  cd1a           int    1a                   ; ‡ten¡ syst‚mov‚ho ‡asova‡e
2363  5b             pop    bx                   ; n vrat BX
2364  2bd3           sub    dx,bx                ; rozd¡l ‡as– (ni‘¨¡ slovo)
2366  7902           jns    236a                 ; rozd¡l je kladn˜
2368  f7da           neg    dx                   ; absolutn¡ hodnota rozd¡lu
236a  59           * pop    cx                   ; doba pro TIME-OUT
236b  51             push   cx                   ; doba pro TIME-OUT
236c  3bd1           cmp    dx,cx                ; je doba vˆt¨¡ ne‘ povolen  ?
236e  7f03           jg     2373                 ; je TIME-OUT - chyba
2370  e956ff         jmp    22c9                 ; dal¨¡ ‡ek n¡ na p©¡jem

                                               ;* chyba - p©eru¨en¡ spojen¡
2373  c606262900   * mov    [2926],00            ; obsluhovan‚ funkce p©enosu
2378  90             nop
2379  804c0292       or     [si+02],92
237d  b87c2d         mov    ax,2d7c              ; buffer pro vysl n¡ po‘adavku
2380  894403         mov    [si+03],ax
2383  8c4c05         mov    [si+05],cs
2386  33c0           xor    ax,ax
2388  894407         mov    [si+07],ax           ; po‡et bajt– k vysl n¡
238b  894409         mov    [si+09],ax           ; ‡¡ta‡ vyslan˜ch bajt–

                                               ;* ‡ek n¡ na odesl n¡ znaku
238e  52             push   dx                   ; £schova DX
238f  fa             cli                         ; z kaz p©eru¨en¡
2390  8b160a03       mov    dx,[030a]            ; adresa portu COM
2394  80c205         add    dl,05                ; stavov˜ registr linky
2397  33c9           xor    cx,cx                ; max. doba pro ‡ek n¡
2399  ec           * in     al,dx                ; ‡ten¡ stavov‚ho registu linky
239a  a820           test   al,20                ; je znak odesl n ?
239c  7502           jnz    23a0                 ; znak byl odesl n
239e  e2f9           loop   2399                 ; ‡ek n¡ na odesl n¡ znaku

                                               ;* vysl n¡ znaku 1Ah (p©eru¨en¡)
23a0  80ea05       * sub    dl,05                ; datov˜ registru portu COM
23a3  b01a           mov    al,1a                ; znak 1AH = ^Z p©eru¨en¡
23a5  ee             out    dx,al                ; vysl n¡ znaku 1AH - p©eru¨en¡

                                               ;* chyba - vys¡l n¡ p©eru¨eno
23a6  e873f7         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; hl ¨en¡ - "vys¡l n¡ p©eru¨eno"
23a9                 db     'Senden Abbruch',10,13,0

                                               ;* prodleva, n vrat s chybou
23ba  33c9           xor    cx,cx                ; doba pro prodlevu po vysl n¡ znaku
23bc  e2fe         * loop   23bc                 ; prodleva po vysl n¡ znaku
23be  fb             sti                         ; povolen¡ p©eru¨en¡
23bf  5a             pop    dx                   ; n vrat DX
23c0  59             pop    cx                   ; n vrat CX
23c1  b002           mov    al,02                ; chybov˜ k¢d - vys¡l n¡ p©eru¨eno
23c3  f9             stc                         ; nastaven¡ p©¡znaku chyby
23c4  c3             ret

                                               ;* n vrat - vˆta p©ijata OK
23c5  59           * pop    cx
23c6  f8             clc
23c7  c3             ret

; -----------------------------------------------------------------------------
;
; -----------------------------------------------------------------------------

23c8  c6440200     * mov    [si+02],00
23cc  8a4401         mov    al,[si+01]
23cf  84060725       test   [2507],al
23d3  7411           jz     23e6
23d5  30060725       xor    [2507],al
23d9  39360925       cmp    [2509],si            ; tabulka parametr– pro p©¡jem
23dd  7507           jnz    23e6
23df  8b160a03       mov    dx,[030a]            ; adresa portu COM
23e3  e83502         call   261b                 ; inicializace registru modemu
23e6  c3           * ret

; -----------------------------------------------------------------------------
;                        Proveden¡ obsluhy driveru
; -----------------------------------------------------------------------------

                                                 ; proveden¡ obsluhy driveru
                                                 ; VSTUP: ES:BX=z hlav¡ za©¡zen¡

                                               ;* nalezen¡ disku v tabulce
23e7  57           * push   di                   ; £schova DI
23e8  268a4701       mov    al,es:[bx+01]        ; ‡¡slo diskov‚ jednotky
23ec  e8dc00         call   24cb                 ; nalezen¡ driveru pro disk AL
23ef  7308           jnc    23f9                 ; driver nalezen OK
23f1  c747030181     mov    [bx+03],8101         ; k¢d chyby - sektor nenalezen
23f6  5f             pop    di                   ; n vrat DI
23f7  f8             clc                         ; p©¡znak n vratu OK
23f8  c3             ret

                                               ;* nastaven¡ ‡¡sla disku
23f9  1e           * push   ds                   ; £schova DS
23fa  26ff7701       push   es:[bx+01]           ; £schova ‡¡sla disk. jednotky
23fe  26884701       mov    es:[bx+01],al        ; relativn¡ ‡¡slo disku driveru
2402  2e80261803fb   and    cs:[0318],fb         ; zru¨. p©¡znaku velk‚ho disku

                                               ;* test, zda je diskov‚ za©¡zen¡
2408  56             push   si                   ; £schova SI
2409  2e8e5d07       mov    ds,cs:[di+07]        ; segment z hlav¡ driveru
240d  2e8b7509       mov    si,cs:[di+09]        ; offset z hlav¡ driveru
2411  8b4404         mov    ax,[si+04]           ; atributy za©¡zen¡
2414  5e             pop    si                   ; n vrat SI
2415  f6c480         test   ah,80                ; je diskov‚ za©¡zen¡ ?
2418  7403           jz     241d                 ; je diskov‚ za©¡zen¡
241a  e98100         jmp    249e                 ; je znakov‚ za©¡zen¡ - obsluha

                                               ;* p©¡znak velk‚ho disku
241d  2402         * and    al,02                ; je operace s velk˜m diskem ?
241f  d0e0           shl    al,1                 ; AL*2
2421  2e08061803     or     cs:[0318],al         ; 4=p©¡znak velk‚ho disku

                                               ;* jsou datov‚ operace ?
2426  26807f0204     cmp    es:[bx+02],04        ; k¢d povelu - vstup ?
242b  740e           jz     243b                 ; je vstup ze za©¡zen¡
242d  26807f0208     cmp    es:[bx+02],08        ; k¢d povelu - v˜stup ?
2432  7407           jz     243b                 ; je v˜stup na za©¡zen¡
2434  26807f0209     cmp    es:[bx+02],09        ; je v˜stup s verifikac¡ ?
2439  7563           jnz    249e                 ; nen¡ v˜stup s verifikac¡


243b  a804         * test   al,04                ; je velk˜ disk ?
243d  7437           jz     2476                 ; nen¡ velk˜ disk
243f  2ef606180340   test   cs:[0318],40         ; je p©¡stup COMPAQ ?
2445  7421           jz     2468                 ; nen¡ p©¡stup COMPAQ

                                               ;* je p©¡stup COMPAQ
2447  33c0           xor    ax,ax                ; AX <- 0
2449  2687471a       xchg   ax,es:[bx+1a]        ; po‡ te‡n¡ sektor - LOW
244d  2ef606180302   test   cs:[0318],02         ; mo‘n˜ p©¡stup k ‡ sti disku ?
2453  7449           jz     249e                 ; nen¡ mo‘n˜ - obsluha driveru
2455  26894714       mov    es:[bx+14],ax        ; po‡ te‡n¡ sektor
2459  268b471c       mov    ax,es:[bx+1c]        ; po‡ t. sektor - HIGH
245d  26894716       mov    es:[bx+16],ax        ; po‡ te‡n¡ sektor - HIGH
2461  26800702       add    es:[bx],02           ; zv˜¨en¡ d‚lky po‘adavku
2465  eb37           jmp    249e                 ; obsluha driveru
2467  90             nop

                                               ;* je p©¡stup DOS 4
2468  26837f14ff   * cmp    es:[bx+14],ffff      ; je sektor 4-bajtovˆ ?
246d  752f           jnz    249e                 ; nen¡ sektor 4-bajtovˆ
246f  26800708       add    es:[bx],08           ; zv˜¨en¡ d‚lky po‘adavku
2473  eb29           jmp    249e                 ; vyvol n¡ obsluhy driveru
2475  90             nop

                                               ;* neum¡ pracovat s velk˜m diskem
2476  26837f14ff   * cmp    es:[bx+14],ffff      ; je po‡ t. sektor 4-bajtovˆ ?
247b  7521           jnz    249e                 ; po‡ t. sektor nen¡ 4-bajtovˆ
247d  2ef606180302   test   cs:[0318],02         ; mo‘n˜ p©¡stup k ‡ sti disku ?
2483  7419           jz     249e                 ; nen¡ mo‘n˜ - obsluha
2485  268b471a       mov    ax,es:[bx+1a]        ; ni‘¨¡ 2 bajty
2489  26894714       mov    es:[bx+14],ax        ; ni‘¨¡ 2 bajty
248d  268b471c       mov    ax,es:[bx+1c]        ; vy¨¨¡ 2 bajty
2491  0bc0           or     ax,ax                ; jsou vy¨¨¡ 2 bajty = 0 ?
2493  7409           jz     249e                 ; jsou 0 - OK
2495  26c747030881   mov    es:[bx+03],8108      ; chyba - sektor nenalezen
249b  eb0a           jmp    24a7                 ; konec obsluhy
249d  90             nop

                                               ;* proveden¡ obsluhy za©¡zen¡
249e  2eff5d01     * call   far cs:[di+01]       ; vol n¡ rutiny STRATEGIE
24a2  fb             sti                         ; povolen¡ p©eru¨en¡
24a3  2eff5d05       call   far cs:[di+05]       ; vol n¡ rutiny PžERU›EN‹

                                               ;* n vrat registr–
24a7  268f4701     * pop    es:[bx+01]           ; n vrat ‡¡sla diskov‚ jednotky
24ab  1f             pop    ds                   ; n vrat DS
24ac  5f             pop    di                   ; n vrat DI
24ad  fc             cld                         ; smˆr p©enosu dat nahoru
24ae  f8             clc                         ; zru¨en¡ p©¡znaku chyby
24af  c3             ret

; -----------------------------------------------------------------------------
;                     Vytvo©en¡ z hlav¡ za©¡zen¡
; -----------------------------------------------------------------------------

                                                 ; VSTUP: AL=d‚lka z hlav¡
                                                 ;        AH=k¢d povelu
                                                 ;        DX=adresa z hlav¡

24b0  57           * push   di
24b1  51             push   cx

                                               ;* d‚lka z hlav¡
24b2  33c9           xor    cx,cx                ; CX <- 0
24b4  8ac8           mov    cl,al                ; CX <- po‡et znak–
24b6  8bfa           mov    di,dx                ; DI <- adresa bufferu
24b8  aa             stosb                       ; ulo‘en¡ po‡tu znak–
24b9  49             dec    cx                   ; sn¡‘en¡ ‡¡ta‡e znak–

                                               ;* ‡¡slo diskov‚ jednotky
24ba  32c0           xor    al,al                ; vy¨¨¡ bajt po‡tu znak–
24bc  aa             stosb                       ; vy¨¨¡ bajt po‡tu znak–
24bd  49             dec    cx                   ; sn¡‘en¡ ‡¡ta‡e znak–

                                               ;* k¢d povelu
24be  86c4           xchg   al,ah                ; AL <- k¢d povelu
24c0  aa             stosb                       ; ulo‘en¡ k¢du povelu
24c1  49             dec    cx                   ; sn¡‘en¡ ‡¡ta‡e znak–

                                               ;* vymaz n¡ zbytku z hlav¡
24c2  86c4           xchg   al,ah                ; AL <- 0
24c4  f3aa           rep    stosb                ; vynulov n¡ zbytku z hlav¡

24c6  8bfa           mov    di,dx                ; p–vodn¡ ukl dac¡ adresa
24c8  59             pop    cx
24c9  5f             pop    di
24ca  c3             ret

; -----------------------------------------------------------------------------
;                Nalezen¡ driveru v tabulce diskov˜ch driver–
; -----------------------------------------------------------------------------

                                                 ; VSTUP: AL=‡¡slo disku SHARE
                                                 ; VSTUP: AL=disk driveru
                                                 ;         DI=adresa tabulky

                                               ;* p©e‡ten¡ disku z tabulky SHARE
24cb  53           * push   bx                   ; £schova BX
24cc  8ad8           mov    bl,al                ; relativn¡ ‡¡slo disku SHARE
24ce  81e30f00       and    bx,000f              ; relativn¡ ‡¡slo disku SHARE
24d2  2e8a87672d     mov    al,cs:[bx+2d67]      ; disk z tabulky SHARE

                                               ;* kontrola ‡¡sla disku
24d7  bfb72c         mov    di,2cb7              ; tabulka driver–
24da  2e8a0eb62c     mov    cl,cs:[2cb6]         ; celkov˜ po‡et disk–
24df  fec9           dec    cl                   ; maxim ln¡ ‡¡slo disku
24e1  3ac8           cmp    cl,al                ; kontrola max. ‡¡sla disku
24e3  fec1           inc    cl                   ; n vrat po‡tu disk–
24e5  7217           jc     24fe                 ; je p©¡li¨ velk‚ ‡¡slo disku

                                               ;* nalezen¡ disku v tabulce
24e7  2e803d00     * cmp    cs:[di],00           ; je konec tabulky driver– ?
24eb  7411           jz     24fe                 ; konec tabulky driver–
24ed  2e2a0d         sub    cl,cs:[di]           ; sn¡‘en¡ ‡¡sla disku
24f0  3ac1           cmp    al,cl                ; nalezen disk ?
24f2  7305           jnc    24f9                 ; disk vˆt¨¡ - driver nalezen
24f4  83c70b         add    di,000b              ; tabulka dal¨¡ho driveru
24f7  ebee           jmp    24e7                 ; test dal¨¡ho driveru

                                               ;* diskov˜ driver nalezen OK
24f9  2ac1         * sub    al,cl                ; rel. ‡¡slo disku v driveru
24fb  5b             pop    bx                   ; n vrat BX
24fc  f8             clc                         ; p©¡znak - operace OK
24fd  c3             ret

                                               ;* chybn‚ ‡¡slo disku
24fe  b001         * mov    al,01                ; k¢d chyby - chybn˜ disk
2500  5b             pop    bx                   ; n vrat BX
2501  f9             stc                         ; chyba - velk‚ ‡¡slo disku
2502  c3             ret

; -----------------------------------------------------------------------------

2503                 db     0ah                  ; doba pro TIME-OUT
2504                 db     14h                  ; doba pro TIME-OUT
2505                 db     1                    ; ©¡d.reg.modemu-sign l DTR
2506                 db     0ffh                 ; ©¡dic¡ reg.modemu-sign ly OUT

2508                 db     0                    ; ‡¡ta‡ test– portu COM
2509                 dw     2521h                ; tabulka parametr– pro p©¡jem

250b                 dw     2521h                ; znak 14h ; parametry pro p©¡jem zpr vy
250d                 dw     2521h                ; znak 15h ; parametry pro p©¡jem zpr vy
250f                 dw     2552h                ; znak 16h
2511                 dw     2583h                ; znak 17h


2500   5B F9 C3 0A 14 01 FF 00 00 21 25 21 25 52 25 83   [........!%!%R%.
2510   25 B4 25 72 64 76 63 31 2D 36 3A 37 29 52 25 52   %.%rdvc1-6:7)R%R
2520   25 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00   %...............

þ                                                 ; parametry pro p©¡jem zpr vy
251d                 dw     2552h                ; adresa n sleduj¡c¡ho popisova‡e
251f                 dw     2552h                ; adresa p©edchoz¡ho popisova‡e
                                                 ; (buffer pro p©¡jem odpovˆdi)
2521                 db     0                    ; 00h -
2522                 db     1                    ; 01h -
2523                 db     0                    ; 02h - p©¡znak (80h=p©ijat znak 1fh)
                                                 ;    01=vy‘aduje se obsluha p©enosu
                                                 ;    08=zpr va byla p©ijata OK
                                                 ;    10=p©¡znak TIME-OUT
                                                 ;    20=v¡cen sobn˜ po‘adavek
                                                 ;    80=vysl n znak(11)
2524                 dd     0                    ; 03h - buffer pro p©¡jem dat
2528                 dw     0                    ; 07h - po‡et bajt– k p©¡jmu
252a                 dw     0                    ; 09h - po‡et p©ijat˜ch bajt–
252c                 dd     0                    ; 0Bh - adresa dal¨¡ho pokra‡ov n¡ programu
                                                 ;       (vyvol v  se pomoc¡ INT 28h)
2530                 db     7ch                  ; 0FH - znak PREX1
2531                 db     2dh                  ; 10H - znak PREX2
2532                 db     0                    ; 11h - znak SYNCH

2541                 db     0                    ; 20H - pracovn¡ ‡¡tac TIME-OUT
2542                 db     0                    ; 21h - doba pro TIME-OUT
2543                 db     3                    ; 22h - doba pro TIME-OUT


2530   7C 2D 00 00 00 00 00 00 00 00 00 00 00 00 00 00   |-..............
2540   00 00 03 14 72 64 76 63 32 2D 36 3A 59 29 83 25   ....rdvc2-6:Y).%

2552                                             ; tabulka (viz 311f)
;311c  be5225         mov    si,2552
;311f  c7440bff06     mov    [si+0b],06ff         ; adresa obsluhy ; p©esmˆrov n¡ za©¡zen¡
;3124  c7441cff06     mov    [si+1c],06ff         ; adresa obsluhy
;3129  8c4c0d         mov    [si+0d],cs           ; segment adresy obsluhy
;312c  8c4c1e         mov    [si+1e],cs           ; segment adresy obsluhy

;3145  c7440fbc2d     mov    [si+0f],2dbc         ; adresa
;314a  8c4c11         mov    [si+11],cs           ; segment adresy
;314d  2ea1fc2d       mov    ax,cs:[2dfc]        ; adresa konce rezidentn¡ ‡ sti
;3151  894413         mov    [si+13],ax
;3154  8c4c15         mov    [si+15],cs


;                                                 ; parametry pro vysl n¡ zpr vy
;2937                 db     0                    ; 00
;2938                 db     1                    ; 01
;2939                 db     0                    ; 02 80=vysl n znak(11)
;293a                 dd     0                    ; 03 adresa textu k vysl n¡
;293e                 dw     0                    ; 07 po‡et sektor– na stopu
;2940                 dw     0                    ; 09 ukazatel vys¡lan‚ho bajtu
;2942                 dd     0                    ; 0b adresa k p©esmˆrov n¡ programu
;2946                 db     0                    ; 0f znak PREX1
;2947                 db     0                    ; 10 znak PREX2
;2948                 db     0                    ; 11
;                       ...  0

255d                 dd     0                    ; [SI+0bh] adresa p©esmˆrov n¡ za©¡zen¡
2561                 dd     00002dbch            ; [SI+0fh] adresa
2565                 dd     0                    ; [SI+13h] adresa

256e                 dd     0                    ; [SI+1ch] adresa


2550   83 25 01 02 00 00 00 00 00 00 00 00 00 00 00 00   .%..............
2560   00 BC 2D 00 00 00 00 00 00 00 00 00 00 00 00 00   ..-.............
2570   00 00 00 03 14 72 64 76 63 33 2D 36 3A 7B 29 B4   .....rdvc3-6:{).
2580   25 B4 25 02 04 00 00 00 00 00 00 00 00 00 00 00   %.%.............
2590   00 00 FE 2D 00 00 FE 2D 00 00 00 00 00 00 00 00   ...-...-........
25A0   00 00 00 00 03 14 72 64 76 63 34 2D 36 3A 9D 29   ......rdvc4-6:.)
25B0   21 25 21 25 03 08 00 00 00 00 00 00 00 00 00 00   !%!%............


25b4                                             ; tabulka
;312f  beb425         mov    si,25b4
;3132  c7440b981b     mov    [si+0b],1b98         ; adresa obsluhy ; p©esmˆrov n¡ za©¡zen¡
;3137  c7441c981b     mov    [si+1c],1b98         ; adresa obsluhy
;313c  8c4c0d         mov    [si+0d],cs           ; segment adresy obsluhy
;313f  8c4c1e         mov    [si+1e],cs           ; segment adresy obsluhy
;3157  beb425         mov    si,25b4
;315a  c7440f3e2e     mov    [si+0f],2e3e         ; adresa
;315f  8c4c11         mov    [si+11],cs           ; segment adresy
;3162  c744133e2e     mov    [si+13],2e3e         ; adresa
;3167  8c4c15         mov    [si+15],cs           ; segment adresy

25bf                 dd     0                    ; [SI+0bh] adresa p©esmˆrov n¡ za©¡zen¡
25c3                 dd     00002e3eh            ; [SI+0fh] adresa
25c7                 dd     00002e3eh            ; [SI+13h] adresa

25C0   00 00 00 3E 2E 00 00 3E 2E 00 00 00 00 00 00 00   ...>...>........

25d0                 dd     0                    ; [SI+1ch] adresa

25D0   00 00 00 00 00 03 14 8B 36 09 25 4A 4A EC A8 E0   ........6.%JJ...

; -----------------------------------------------------------------------------
;     Obsluha p©i p©¡jmu znaku z portu COM
; -----------------------------------------------------------------------------

                                               ;* VSTUP: DX=stav.registr p©eru¨.

                                               ;* p©¡jem datov‚ho bajtu z COM
25d7  8b360925       mov    si,[2509h]           ; tabulka parametr– pro p©¡jem
25db  4a             dec    dx
25dc  4a             dec    dx                   ; datov˜ registr COM
25dd  ec             in     al,dx                ; p©¡jem bajtu

                                               ;* test, zda je povolen˜ bajt
25de  a8e0           test   al,e0                ; je ©¡dic¡ znak ( < 20h) ?
25e0  7510           jnz    25f2                 ; nen¡ ©¡dic¡ znak - chyba
25e2  a810           test   al,10                ; je znak < 10h ?
25e4  740c           jz     25f2                 ; je znak < 10h - chyba

                                               ;* obsluha podle p©ijat‚ho bajtu
25e6  8ad8           mov    bl,al                ; p©ijat˜ ©¡dic¡ znak
25e8  81e30f00       and    bx,000f              ; maska -> bajt 0 a‘ 0fh
25ec  d1e3           shl    bx,1                 ; znak * 2
25ee  ffa78426       jmp    [bx+2684]            ; skok na obsluhu podle bajtu

                                               ;* chyba - p©ijat nepovolen˜ znak
25f2  804c0210     * or     [si+02],10           ; p©¡znak chyby-nespr vn˜ znak
25f6  e823f5         call   1b1c
                                                 ; text "... data bez k. sou‡tu"
25f9                 db     'Daten ohne Pruefsumme empfangen',10,13,0


                                               ;* ‡ek n¡ na ust len¡ reg. modemu
261b  80c204       * add    dl,04                ; ©¡dic¡ registr modemu
261e  2ec606082532   mov    cs:[2508],32         ; po‡et ‡ten¡ registru
2624  ec           * in     al,dx                ; ©¡dic¡ registr modemu
2625  8ae0           mov    ah,al                ; £schova na‡ten‚ hodnoty
2627  ec             in     al,dx                ; ‡ten¡ 2. vzorku reg. modemu
2628  3ae0           cmp    ah,al                ; je nˆjak  zmˆna ?
262a  740a           jz     2636                 ; nen¡ ‘ dn  zmˆna - OK
262c  2efe0e0825   * dec    b/cs:[2508]          ; sn¡‘en¡ ‡¡ta‡e pokus–
2631  75f1           jnz    2624                 ; dal¨¡ pokus testu
2633  eb2c           jmp    2661                 ; chybov‚ hl ¨en¡
2635  90             nop


2636  ec           * in     al,dx                ; dal¨¡ ‡ten¡ registru modemu
2637  3ae0           cmp    ah,al                ; je tak‚ shoda ?
2639  75f1           jnz    262c                 ; nen¡ shoda - dal¨¡ test

263b  2e22060525     and    al,cs:[2505]         ; ©¡d.reg.modemu-sign l DTR
2640  2e32060525     xor    al,cs:[2505]         ; ©¡d.reg.modemu-sign l DTR
2645  2e0a060625     or     al,cs:[2506]         ; ©¡dic¡ reg.modemu-sign ly OUT

                                               ;* nastaven¡ regisrtru modemu
264a  2ec606082532   mov    cs:[2508],32         ; nastaven¡ ‡¡ta‡e pokus–
2650  8ae0           mov    ah,al                ; nov  hodnota nastaven¡ modemu
2652  ee           * out    dx,al                ; nastaven¡ ©¡d. reg. modemu
2653  ec             in     al,dx                ; ‡ten¡ novˆ nastaven‚ hodnoty
2654  3ae0           cmp    ah,al                ; nastavila se nov  hodnota ?
2656  7426           jz     267e                 ; nov  hodnota OK

2658  8ac4         * mov    al,ah                ; po‘adovan  hodnota nastaven¡
265a  2efe0e0825     dec    b/cs:[2508]          ; sn¡‘en¡ ‡¡ta‡e pokus–
265f  75f1           jnz    2652                 ; dal¨¡ pokus testu

2661  e8b8f4       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

2664                 db     'COM ist zu langsam   ',10,13,0

267d  c3             ret


267e  ec           * in     al,dx                ; ‡ten¡ ©¡dic¡ho registru modemu
267f  3ae0           cmp    ah,al                ; je shoda s po‘adovanou hodnotou ?
2681  75d5           jnz    2658                 ; dal¨¡ nastaven¡
2683  c3             ret

                                                 ; tabulka adres akc¡ pro ©¡dic¡ znaky

2684                 dw     261bh                ; 10h neplatn˜ znak
2686                 dw     261bh                ; 11h neplatn˜ znak
2688                 dw     261bh                ; 12h neplatn˜ znak
268a                 dw     261bh                ; 13h neplatn˜ znak
268c                 dw     26a4h                ; 14h
268e                 dw     26a4h                ; 15h
2690                 dw     26a4h                ; 16h
2692                 dw     26a4h                ; 17h
2694                 dw     26c6h                ; 18h
2696                 dw     26d5h                ; 19h
2698                 dw     288fh                ; 1ah
269a                 dw     26e4h                ; 1bh
269c                 dw     270ah                ; 1ch
269e                 dw     2751h                ; 1dh
26a0                 dw     286bh                ; 1eh
26a2                 dw     28f8h                ; 1fh vysl n¡ znaku 1AH - test spojen¡



                                                 ; 00h -
                                                 ; 01h -
                                                 ; 02h - p©¡znak (80h=p©ijat znak 1fh)
                                                 ;    01=vy‘aduje se obsluha p©enosu
                                                 ;    08=zpr va byla p©ijata OK
                                                 ;    10=chyba p©¡jmu
                                                 ;    20=v¡cen sobn˜ po‘adavek
                                                 ;    80=byl SYNCH po paketu
                                                 ; 03h - buffer pro p©¡jem dat
                                                 ; 07h - po‡et bajt– k p©¡jmu
                                                 ; 09h - po‡et p©ijat˜ch bajt–
                                                 ; 0Bh - adresa pokra‡ov n¡
                                                 ;       (vyvol v  se z INT 28h)
                                                 ; 0FH - znak PREX1
                                                 ; 10H - znak PREX2
                                                 ; 11h - znak SYNCH
                                                 ; 20h - pracovn¡ ‡¡ta‡ TIME-OUT
                                                 ; 21h - doba pro TIME-OUT
                                                 ; 22h - doba pro TIME-OUT









                                                 ; p©¡jem znak– 14h a‘ 17h

26a4  80e306         and    bl,06                ; znak * 2
26a7  8bb70b25       mov    si,[bx+250b]         ; adresa tabulky
26ab  89360925       mov    [2509],si            ; tabulka parametr– pro p©¡jem
26af  f6440202       test   [si+02],02
26b3  7401           jz     26b6
26b5  c3             ret
26b6  c6440200     * mov    [si+02],00
26ba  8a4401         mov    al,[si+01]
26bd  f6d0           not    al
26bf  20060725       and    [2507],al
26c3  e955ff       * jmp    261b                 ; inicializace ©¡dic¡ho registru modemu


                                                 ; p©¡jem znaku 18h

26c6  8b360b25       mov    si,[250b]
26ca  89360925       mov    [2509],si            ; tabulka parametr– pro p©¡jem
26ce  f6440202       test   [si+02],02
26d2  74ef           jz     26c3                 ; inicializace ©¡dic¡ho registru modemu
26d4  c3             ret

                                                 ; p©¡jem znaku 19h

26d5  8b360d25       mov    si,[250d]
26d9  89360925       mov    [2509],si            ; tabulka parametr– pro p©¡jem
26dd  f6440202       test   [si+02],02
26e1  74e0           jz     26c3                 ; inicializace ©¡dic¡ho registru modemu
26e3  c3             ret

                                                 ; p©¡jem znaku 1bh

26e4  8b360925     * mov    si,[2509]            ; tabulka parametr– pro p©¡jem
26e8  f6440280       test   [si+02],80
26ec  7415           jz     2703
26ee  f6440202       test   [si+02],02
26f2  7401           jz     26f5
26f4  c3             ret
26f5  f6440210     * test   [si+02],10
26f9  7508           jnz    2703
26fb  8a4401         mov    al,[si+01]
26fe  08060725       or     [2507],al
2702  c3             ret
2703  c6440200     * mov    [si+02],00
2707  e911ff         jmp    261b                 ; inicializace ©¡dic¡ho registru modemu
; -----------------------------------------------------------------------------
                                               ;* p©¡jem znaku 1ch - PREX2

270a  8b360925       mov    si,[2509]            ; tabulka parametr– pro p©¡jem
270e  f6440280       test   [si+02],80           ; byl SYNCH po paketu ?
2712  7415           jz     2729                 ; nebyl SYNCH
2714  f6440202       test   [si+02],02
2718  7401           jz     271b
271a  c3             ret

271b  f6440210     * test   [si+02],10           ; byla chyba p©enosu ?
271f  7508           jnz    2729                 ; byla chyba p©enosu
2721  8a4401         mov    al,[si+01]
2724  08060725       or     [2507],al
2728  c3             ret

2729  c6440200     * mov    [si+02],00           ; zru¨en¡ SYNCH - bude zpr va
272d  8b441c         mov    ax,[si+1c]
2730  89440b         mov    [si+0b],ax           ; adresa p©esmˆrov n¡ za©¡zen¡
2733  8b441e         mov    ax,[si+1e]
2736  89440d         mov    [si+0d],ax
2739  8b440f         mov    ax,[si+0f]
273c  894403         mov    [si+03],ax           ; offset adresy bufferu
273f  8cc8           mov    ax,cs                ; AX <- CS
2741  894405         mov    [si+05],ax           ; segment adresy bufferu
2744  c744072000     mov    [si+07],0020         ; po‡et bajt– k vysl n¡
2749  c744090000     mov    [si+09],0000         ; ‡¡ta‡ vyslan˜ch bajt–
274e  e9cafe         jmp    261b                 ; inicializace ©¡d. reg. modemu

; -----------------------------------------------------------------------------
                                               ;* p©¡jem znaku 1dh - paket

2751  f6061f0301     test   [031f],01            ; bit 0=prob¡h  INT 13h ?
2756  7406           jz     275e                 ; ne - p©¡jem paketu z COM
2758  800e1f0302     or     [031f],02            ; po‘adavek operace s COM
275d  c3             ret

                                               ;* p©¡jem paketu (DX=adresa COM)

                                               ;* nastaven¡ dob TIME-OUT
275e  8b360925     * mov    si,[2509]            ; tabulka parametr– pro p©¡jem
2762  2ea00325       mov    al,cs:[2503]         ; doba pro TIME-OUT
2766  884421         mov    [si+21],al           ; doba pro TIME-OUT
2769  2ea00425       mov    al,cs:[2504]         ; doba pro TIME-OUT
276d  884422         mov    [si+22],al           ; doba pro TIME-OUT

                                               ;* adresa k na‡ten¡ dat
2770  51             push   cx
2771  06             push   es
2772  bb2000         mov    bx,0020              ; d‚lka dat
2775  c47c03         les    di,[si+03]           ; ES:DI=buffer pro ukl d n¡ dat
2778  8b4c09         mov    cx,[si+09]           ; ‡¡ta‡ p©ijat˜ch bajt–
277b  3b4c07         cmp    cx,[si+07]           ; po‡et bajt– k p©¡jmu
277e  7311           jnc    2791                 ; je p©ete‡en¡ bufferu
2780  037c09         add    di,[si+09]           ; adresa k ulo‘en¡ bajtu


                                               ;* nastaven¡ TIME-OUT
2783  33c9           xor    cx,cx
2785  8a4422         mov    al,[si+22]           ; doba pro TIME-OUT
2788  884420         mov    [si+20],al           ; pracovn¡ ‡¡ta‡ doby TIME-OUT


278b  f6440292       test   [si+02],92
278f  7406           jz     2797
2791  894c09       * mov    [si+09],cx           ; ‡¡ta‡ vyslan˜ch bajt–
2794  07             pop    es
2795  59             pop    cx
2796  c3             ret                         ; n vrat p©i chybˆ p©ete‡en¡

2797  e881fe       * call   261b                 ; inicializace ©¡d. reg. modemu
279a  42             inc    dx                   ; stavov˜ registr linky
279b  eb0c           jmp    27a9                 ; p©¡jem znaku
279d  90             nop

279e  80c205       * add    dl,05                ; stavov˜ registr linky
27a1  8a4421         mov    al,[si+21]           ; doba pro TIME-OUT
27a4  884420         mov    [si+20],al           ; pracovn¡ ‡¡ta‡ doby TIME-OUT
27a7  33c9           xor    cx,cx                ; ‡¡ta‡ pro TIME-OUT

                                               ;* zde se ‡ek  na p©¡chod znaku
                                               ;* nebo na chybov˜ stav
                                               ;* na‡¡taj¡ se data
                                               ;* BH=kon.sou‡et,BL=po‡et bajt–

                                               ;* je nˆjak˜ stav ?
27a9  ec           * in     al,dx                ; stavov˜ registr linky
27aa  a81f           test   al,1f                ; je chyba nebo jsou data ?
27ac  750d           jnz    27bb                 ; nastal stav pro p©¡jem
27ae  e2f9           loop   27a9                 ; dal¨¡ test - ‡ek n¡ na
27b0  fe4c20         dec    b/[si+20]            ; ‡¡ta‡ pro TIME-OUT
27b3  75f4           jnz    27a9                 ; dal¨¡ test

                                               ;* chyba TIME-OUT
27b5  80ea05         sub    dl,05                ; datov˜ registr
27b8  e98b00         jmp    2846                 ; chyba TIME-OUT

                                               ;* test - byla chyba p©¡jmu ?
27bb  80ea05       * sub    dl,05                ; datov˜ registr portu
27be  a81e           test   al,1e                ; je chybov˜ stav ?
27c0  7403           jz     27c5                 ; ne - jsou data
27c2  eb58           jmp    281c                 ; nastal stav chyby p©¡jmu
27c4  90             nop

                                               ;* p©¡jem datov‚ho bajtu
27c5  ec           * in     al,dx                ; na‡ten¡ bajtu dat
27c6  aa             stosb                       ; ulo‘en¡ bajtu dat
27c7  02f8           add    bh,al                ; kontroln¡ sou‡et dat
27c9  fecb           dec    bl                   ; ‡¡ta‡ pro p©¡jem znak–
27cb  75d1           jnz    279e                 ; p©¡jem dal¨¡ho znaku


                                                ;* ‡ek n¡ na p©¡jem kon. sou‡tu
27cd  80c205         add    dl,05                ; stavov˜ registr linky
27d0  8a4421         mov    al,[si+21]           ; doba pro TIME-OUT
27d3  884420         mov    [si+20],al           ; pracovn¡ ‡¡ta‡ doby TIME-OUT
27d6  33c9           xor    cx,cx                ; ‡¡ta‡ pro TIME-OUT
27d8  ec           * in     al,dx                ; stavov˜ registr linky
27d9  a81f           test   al,1f                ; je chyba, nebo jsou data ?
27db  750d           jnz    27ea                 ; je chyba, nebo jsou data
27dd  e2f9           loop   27d8                 ; ‡ek n¡ na zmˆnu stavu linky
27df  fe4c20         dec    b/[si+20]            ; sn¡‘en¡ ‡¡ta‡e pro TIME-OUT
27e2  75f4           jnz    27d8                 ; nen¡ TIME-OUT - dal¨¡ pokus
27e4  80ea05         sub    dl,05                ; datov˜ registr portu
27e7  eb5d           jmp    2846                 ; je chyba TIME-OUT
27e9  90             nop

                                               ;* p©¡jem kontroln¡ho sou‡tu
27ea  80ea05       * sub    dl,05                ; datov˜ registr portu
27ed  a81e           test   al,1e                ; nastala chyba linky ?
27ef  752b           jnz    281c                 ; nastala chyba linky
27f1  ec             in     al,dx                ; p©¡jem kontroln¡ho sou‡tu
27f2  02f8           add    bh,al                ; p©i‡ten¡ kontroln¡ho sou‡tu
27f4  750b           jnz    2801                 ; kontroln¡ sou‡et nesouhlas¡

                                               ;* paket p©ijat OK
27f6  804c0208       or     [si+02],08           ; p©¡znak p©ijet¡ paketu OK
27fa  83440920       add    [si+09],0020         ; zv˜¨en¡ ‡¡ta‡e bajt–
27fe  eb41           jmp    2841                 ; n vrat z obsluhy
2800  90             nop
; ------------
                                               ;* chyba kontroln¡ho sou‡tu
2801  e818f3       * call   1b1c                 ; hl ¨en¡ - chyba CRC v paketu

2804                 db     'CRC-Fehler im Paket',10,13,0

281a  b000           mov    al,00
281c  804c0210     * or     [si+02],10           ; chyba CRC
2820  e8f9f2         call   1b1c                 ; hl ¨en¡ - chyba p©¡jmu

2823                 db     'RCVR-Fehler beim Empfang   ',10,13,0

2841  07             pop    es
2842  59             pop    cx
2843  e9d5fd         jmp    261b                 ; inicializace ©¡d. reg. modemu
; ------------
                                               ;* chyba TIME-OUT p©¡jmu
2846  804c0210     * or     [si+02],10           ; p©¡znak chyby
284a  07             pop    es
284b  59             pop    cx
284c  e8cdf2         call   1b1c                 ; hl ¨en¡ - je chyba TIME-OUT

284f                 db     'RCVR Zeitfehler       ',10,13,0

2868  e9b0fd         jmp    261b                 ; inicializace ©¡d. reg. modemu

; -----------------------------------------------------------------------------
                                               ;* p©¡jem znaku 1EH -> SYNCH

286b  8b360925       mov    si,[2509]            ; tabulka parametr– pro p©¡jem
286f  f6440208       test   [si+02],08           ; byl p©ijat paket OK ?
2873  7416           jz     288b                 ; paket nebyl p©ijat - ignor.
2875  f6440211       test   [si+02],11           ; byla chyba p©¡jmu ?
2879  7510           jnz    288b                 ; byla chyba p©¡jmu
287b  804c0280       or     [si+02],80           ; p©¡znak SYNCH po paketu

                                               ;* vyvol n¡ dal¨¡ obsluhy
287f  f7440bffff     test   [si+0b],ffff         ; adresa p©esmˆrov n¡ za©¡zen¡
2884  7406           jz     288c                 ; nen¡ dal¨¡ funkce
2886  ff5c0b         call   far [si+0b]          ; p©esmˆrov n¡ za©¡zen¡
2889  7301           jnc    288c                 ; operace OK
288b  c3           * ret
288c  e98cfd       * jmp    261b                 ; inicializace ©¡d. reg. modemu

; -----------------------------------------------------------------------------
                                               ;* p©¡jem znaku 1AH - p©eru¨en¡

288f  e88af2         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "P©eru¨en¡"
2892                 db     'Abbruch  ',10,13,0

                                               ;* zru¨en¡ p©¡znak– p©ij¡ma‡e
289e  be5225         mov    si,2552
28a1  c6440200       mov    [si+02],00
28a5  8b441c         mov    ax,[si+1c]
28a8  89440b         mov    [si+0b],ax           ; adresa p©esmˆrov n¡ za©¡zen¡
28ab  8c4c0d         mov    [si+0d],cs

                                               ;* zru¨en¡ p©¡znak– vys¡la‡e
28ae  be5929         mov    si,2959
28b1  c6440200       mov    [si+02],00
28b5  c7440b0000     mov    [si+0b],0000         ; adresa p©esmˆrov n¡ za©¡zen¡
28ba  c744070000     mov    [si+07],0000         ; po‡et bajt– k vysl n¡
28bf  c7440f0000     mov    [si+0f],0000         ; znak PREX1,PREX2
28c4  c6441100       mov    [si+11],00           ; znak SYNCH
28c8  c3             ret

; -----------------------------------------------------------------------------
                                               ;* p©eru¨en¡ stavem p©ij. linky

28c9  80c203       * add    dl,03                ; stavov˜ registr linky
28cc  ec             in     al,dx                ; zru¨en¡ po‘adavku p©eru¨en¡
28cd  8ae0           mov    ah,al                ; stavov˜ registr linky
28cf  80ea05         sub    dl,05                ; datov˜ kan l portu
28d2  ec             in     al,dx                ; p©e‡ten¡ p©ijat‚ho znaku
28d3  42             inc    dx
28d4  42             inc    dx                   ; stav registru p©eru¨en¡
28d5  8b360925       mov    si,[2509]            ; tabulka parametr– pro p©¡jem
28d9  804c0290       or     [si+02],90
28dd  2ef606010301   test   cs:[0301],01         ; parametr FIX
28e3  7403           jz     28e8                 ; nen¡ nastaven parametr FIX
28e5  e89605         call   2e7e                 ; inicializace s‚r. portu COM
28e8  e831f2       * call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "Stav p©ij¡mac¡ linky"
28eb                 db     'RLSTATUS ',10,13,0

28f7  c3             ret
; -----------------------------------------------------------------------------
                                               ;* p©¡jem 1FH -> test spojen¡

28f8  fa             cli                         ; z kaz p©eru¨en¡
28f9  80c205         add    dl,05                ; stavov˜ registr linky
28fc  51             push   cx                   ; £schova CX

                                               ;* ‡ek n¡ na uvolnˆn¡ vys¡la‡e
28fd  33c9           xor    cx,cx                ; doba pro TIME-OUT
28ff  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2900  a820           test   al,20                ; je vys¡lac¡ registr pr zdn˜ ?
2902  e1fb           loopz  28ff                 ; ‡ek n¡ na uvolnˆn¡ vys¡la‡e

                                               ;* vysl n¡ znaku 1AH (odpovˆƒ)
2904  80ea05         sub    dl,05                ; datov˜ registr portu
2907  b01a           mov    al,1a                ; znak 1AH (=^Z)
2909  ee             out    dx,al                ; vysl n¡ znaku 1AH

                                               ;* ‡ek n¡ na uvolnˆn¡ vys¡la‡e
290a  33c9           xor    cx,cx                ; doba pro TIME-OUT
290c  80c205         add    dl,05                ; stavov˜ registr linky
290f  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2910  a820           test   al,20                ; je vys¡lac¡ registr pr zdn˜ ?
2912  e1fb           loopz  290f                 ; ‡ek n¡ na uvolnˆn¡ vys¡la‡e

                                               ;* ‡ek n¡ na odesl n¡ znaku
2914  33c9           xor    cx,cx                ; doba pro TIME-OUT
2916  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2917  a840           test   al,40                ; je znak odeslan˜ ?
2919  e1fb           loopz  2916                 ; ‡ek n¡ na odesl n¡ znaku

291b  59             pop    cx                   ; n vrat CX
291c  80ea05         sub    dl,05                ; datov˜ registr portu COM
291f  e9f9fc         jmp    261b                 ; inicializace ©¡d. reg. modemu

; -----------------------------------------------------------------------------

2922                 db     6                    ; po‡et cykl– pro ‡ek n¡ na vysl n¡ znaku

2923                 db     2                    ; stav.reg.modemu-maska DDSR
2924                 db     22h                  ; stav.reg.modemu-DDSR a DSR
2925                 db     20h                  ; stav.reg.modemu-maska DSR

2926                 db                          ; obsluhovan‚ funkce p©enosu


2927                 dw     2937h                ; aktu ln¡ tabulka vys¡la‡e

                                               ;* tabulky pro vys¡l n¡
2929                 dw     2937h                ; parametry pro vysl n¡ zpr vy
292b                 dw     2959h
292d                 dw     297bh
292f                 dw     299dh
2931                 dw     2521h
2933                 dw     0000h


2935                 dw     2959h                ;-02: p©edchoz¡ tabulka
                                               ;* parametry pro vysl n¡ zpr vy
2937                 db     0                    ; 00
2938                 db     1                    ; 01
2939                 db     0                    ; 02
                                                 ;    08=zpr va byla odesl na OK
                                                 ;    10=p©¡znak TIME-OUT
                                                 ;    20=v¡cen sobn˜ po‘adavek
                                                 ;    80=vysl n znak(11)
293a                 dd     0                    ; 03 adresa bufferu dat (64 bajt–)
293e                 dw     0                    ; 07 po‡et bajt– k vysl n¡
2940                 dw     0                    ; 09 po‡et ji‘ vyslan˜ch bajt–
2942                 dd     0                    ; 0b adresa k p©esmˆrov n¡ programu
2946                 db     0                    ; 0f znak PREX1
2947                 db     0                    ; 10 znak PREX2
2948                 db     0                    ; 11 znak SYNCH

                       ...  0



2957                 dw     297bh

2959                 db     1
295a                 db     2
295b                 dw     15 dup(0)



2979                 dw     299dh

297b                 db     2
297c                 db     4
297d                 dw     15 dup(0)



299b                 dw     2937h                ; parametry pro vysl n¡ zpr vy

299d                 db     3
299e                 db     8
299f                 dw     15 dup(0)

; -----------------------------------------------------------------------------
;                 P©eru¨en¡ zmˆnou stavu modemu - vysl n¡ zpr vy
; -----------------------------------------------------------------------------
                                               ;* VSTUP: DX=port COM + 2

29bd  8b362729       mov    si,[2927]            ; aktu ln¡ tabulka vys¡la‡e
29c1  80c204         add    dl,4                 ; stavov˜ registr modemu
29c4  ec             in     al,dx                ; zru¨en¡ p©¡znaku p©eru¨en¡
29c5  80ea06         sub    dl,06                ; datov˜ registr COM
29c8  2e84062329     test   cs:[2923],al         ; stav.reg.modemu-maska DDSR
29cd  7501           jnz    29d0                 ; nastala zmˆna-vysl n¡ zpr vy
29cf  c3             ret                         ; nen¡ zmˆna sign lu DSR

; -----------------------------------------------------------------------------
;                    Vysl n¡ paketu na port COM
; -----------------------------------------------------------------------------
                                               ;* obsluha vys¡l n¡ zpr vy
                                                 ; VSTUP: DS:SI=tabulka zpr vy
                                                 ;        DX=komunika‡n¡ port

                                               ;* parametry pro vysl n¡ zpr vy
                                                 ;-02: n sleduj¡c¡ tabulka
                                                 ; 00:
                                                 ; 01:
                                                 ; 02:
                                                 ;    08=zpr va byla odesl na OK
                                                 ;    10=p©¡znak TIME-OUT
                                                 ;    20=po‘aduje se obsluha
                                                 ;    80=obsluha byla provedena
                                                 ; 03:adresa bufferu (64 bajt–)
                                                 ; 07:po‡et bajt– k vysl n¡
                                                 ; 09:‡¡ta‡ ji‘ vyslan˜ch bajt–
                                                 ; 0b:obsluha zve©ejnˆn‚ho disku
                                                 ; 0f:znak PREX1
                                                 ; 10:znak PREX2
                                                 ; 11:znak SYNCH

                                               ;* test, zda je dal¨¡ znak
29d0  8b4409       * mov    ax,[si+09]           ; ‡¡ta‡ vyslan˜ch bajt–
29d3  2b4407         sub    ax,[si+07]           ; po‡et bajt– k vysl n¡
29d6  7255           jc     2a2d                 ; jsou znaky k vys¡l n¡

                                               ;* nejsou dal¨¡ znaky - rozli¨¡
                                               ;* se, zda je zpr va p©ipravena,
                                               ;* jinak se nalezne dal¨¡ zpr va,
                                               ;* kter  ‡ek  na vysl n¡

                                               ;* nen¡ zpr va - synchronizace
29d8  8a6411         mov    ah,[si+11]           ; znak SYNCH k vysl n¡
29db  0ae4           or     ah,ah                ; byla ji‘ zpr va odesl na ?
29dd  7533           jnz    2a12                 ; nebyla-vysl n¡ zpr vy na port
29df  804c0280       or     [si+02],80           ; p©¡znak odesl n¡ zpr vy

                                               ;* obsluha zve©ejnˆn‚ho disku
29e3  c606262900     mov    [2926],00            ; obsluhovan‚ funkce p©enosu=0
29e8  837c0b00       cmp    [si+0b],0000         ; m  b˜t obsluha disku ?
29ec  7403           jz     29f1                 ; nen¡ obsluha disku
29ee  ff5c0b         call   far [si+0b]          ; obsluha zve©ejnˆn‚ho disku

                                               ;* nalezen¡ dal¨¡ tabulky
29f1  8bde         * mov    bx,si                ; aktu ln¡ tabulka parametr–
29f3  f6440220     * test   [si+02],20           ; je po‘adavek obsluhy ?
29f7  7508           jnz    2a01                 ; je po‘adavek obsluhy
29f9  8b74fe         mov    si,[si-02]           ; n sleduj¡c¡ tabulka
29fc  3bf3           cmp    si,bx                ; je opˆt stejn  tabulka ?
29fe  75f3           jnz    29f3                 ; nejsou je¨tˆ v¨echny tabulky
2a00  c3             ret                         ; nepo‘aduje se obsluha

                                               ;* odkaz na dal¨¡ tabulku
2a01  89362729     * mov    [2927],si            ; nov  aktu ln¡ tab. parametr–
2a05  806402df       and    [si+02],df           ; zru¨en¡ po‘adavku obsluhy
2a09  8a4401         mov    al,[si+01]
2a0c  08062629       or     [2926],al            ; obsluhovan‚ funkce p©enosu
2a10  ebbe           jmp    29d0                 ; opakov n¡ obsluhy

                                               ;* p©¡prava registr– pro vysl n¡
2a12  51           * push   cx                   ; £schova CX
2a13  33c9           xor    cx,cx                ; max. doba pro TIME-OUT
2a15  884c11         mov    [si+11],cl           ; zru¨en¡ znaku SYNCH
2a18  80c205         add    dl,05                ; stavov˜ registr linky

                                               ;* ‡ek n¡ na p©ipravenost vys¡l.
2a1b  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2a1c  a820           test   al,20                ; vys¡lac¡ registr pr zdn˜ ?
2a1e  7505           jnz    2a25                 ; vys¡lac¡ registr je pr zdn˜
2a20  e2f9           loop   2a1b                 ; ‡ek n¡ na p©ipravenost
2a22  e9de01         jmp    2c03                 ; chyba TIME-OUT vys¡la‡e

                                               ;* vysl n¡ znaku SYNCH na port
2a25  80ea05       * sub    dl,05                ; datov˜ registr
2a28  8ac4           mov    al,ah                ; znak k vysl n¡
2a2a  ee             out    dx,al                ; vysl n¡ znaku SYNCH
2a2b  59             pop    cx                   ; n vrat CX
2a2c  c3             ret                         ; konec


                                               ;* je PREX1 nebo PREX2 ?
2a2d  8b440f       * mov    ax,[si+0f]           ; znak PREX1 a PREX2
2a30  0bc0           or     ax,ax                ; je znak k vysl n¡ ?
2a32  7503           jnz    2a37                 ; je nˆjak˜ znak k vysl n¡
2a34  eb61           jmp    2a97                 ; nen¡ znak PREX1 ani PREX2
2a36  90             nop

                                               ;* je vysl n¡ znak– PREX1, PREX2
2a37  0ac0         * or     al,al                ; je znak PREX1 k vysl n¡ ?
2a39  7430           jz     2a6b                 ; nen¡ PREX1 - vysl n¡ PREX2
2a3b  32e4           xor    ah,ah                ; AH <- 00 (zru¨en¡ PREX2)
2a3d  86c4           xchg   al,ah                ; AH<-PREX1, AL<-00
2a3f  88440f         mov    [si+0f],al           ; znak PREX1 = 0

                                                ;* vysl n¡ znaku PREX1
2a42  80c205         add    dl,05                ; stavov˜ registr linky
2a45  ec             in     al,dx                ; ‡ten¡ stav. registru linky
2a46  80ea05         sub    dl,05                ; datov˜ registr
2a49  a820           test   al,20                ; je vys¡la‡ p©ipraven ?
2a4b  751a           jnz    2a67                 ; vys. p©ipraven-vysl n¡ znaku
2a4d  e8ccf0         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                               ;* chyba - PREX1 p©¡li¨ brzo
2a50                 db     'Prex1 zu frueh - S  ',10,13,0

                                               ;* vysl n¡ znaku PREX1
2a67  86e0         * xchg   ah,al                ; AH=znak k vysl n¡
2a69  ee             out    dx,al                ; vysl n¡ znaku PREX1
2a6a  c3             ret


                                               ;* vysl n¡ znaku PREX2
2a6b  884410       * mov    [si+10],al           ; vynulov n¡ znaku PREX2
2a6e  80c205         add    dl,05                ; stavov˜ registr linky
2a71  ec             in     al,dx                ; ‡ten¡ stav. registru linky
2a72  80ea05         sub    dl,05                ; datov˜ registr
2a75  a820           test   al,20                ; je vys¡la‡ pr zdn˜ ?
2a77  751a           jnz    2a93                 ; vys¡la‡ je pr zdn˜
2a79  e8a0f0         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                               ;* chyba - PREX2 p©¡li¨ brzo
2a7c                 db     'Prex2 zu frueh - S  ',10,13,0

                                               ;* vysl n¡ znaku PREX2
2a93  8ac4         * mov    al,ah                ; znak k vysl n¡
2a95  ee             out    dx,al                ; vysl n¡ znaku PREX2
2a96  c3             ret

                                               ;* vysl n¡ znaku 1Dh
2a97  80c205       * add    dl,05                ; stavov˜ registr linky
2a9a  ec             in     al,dx                ; ‡ten¡ stav. registru linky
2a9b  80ea05         sub    dl,05                ; datov˜ registr portu
2a9e  a840           test   al,40                ; je vys¡la‡ pr zdn˜ ?
2aa0  7517           jnz    2ab9                 ; vys¡la‡ je pr zdn˜
2aa2  e877f0         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                               ;* chyba - 1Dh p©¡li¨ brzo
2aa5                 db     '1D zu frueh - S  ',10,13,0

                                               ;* test, zda se vynuloval DDSR
2ab9  51           * push   cx                   ; £schova CX
2aba  33c9           xor    cx,cx                ; CX <- 0 doba pro TIME-OUT
2abc  80c206       * add    dl,06                ; stavov˜ registr modemu
2abf  ec             in     al,dx                ; ‡ten¡ stav. registru modemu
2ac0  80ea06         sub    dl,06                ; datov˜ registr portu

                                               ;* vynuloval se sign l DDSR ?
2ac3  2e84062329     test   cs:[2923],al         ; stav.reg.modemu-maska DDSR
2ac8  7432           jz     2afc                 ; nenastala zmˆna sign lu DSR
2aca  e84ff0         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

                                               ;* chyba - DDSR je st le je¨tˆ 1
2acd                 db     'delta dsr_int noch ein',10,13,0

2ae6  e2d4           loop   2abc                 ; nov˜ test sign lu DSR

                                               ;* chyba obvodu 8250
2ae8  e831f0         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

2aeb                 db     '8250-Fehler   ',10,13,0

                                               ;* zmˆna DSR-‡ten¡ sign lu DSR
2afc  59           * pop    cx
2afd  80c206         add    dl,06                ; stavov˜ registr modemu
2b00  ec             in     al,dx                ; ‡ten¡ stav. registru modemu
2b01  2e22062529     and    al,cs:[2925]         ; stav.reg.modemu-maska DSR

                                               ;* vysl n¡ 1dh - za‡ tek dat
2b06  50             push   ax                   ; £schova sign lu DSR
2b07  80ea06         sub    dl,06                ; datov˜ registr
2b0a  b01d           mov    al,1d                ; znak 1dh
2b0c  ee             out    dx,al                ; vysl n¡ znaku 1dh na port
2b0d  58             pop    ax                   ; n vrat sign lu DSR

                                               ;* nastaven¡ ukazat. vys¡l n¡ dat
2b0e  51             push   cx                   ; £schova CX
2b0f  8bfe           mov    di,si                ; tabulka parametr– k vys¡l n¡
2b11  bb2000         mov    bx,0020              ; d‚lka dat k vysl n¡
2b14  c57503         lds    si,[di+03]           ; adresa dat k vysl n¡
2b17  2e037509       add    si,cs:[di+09]        ; +po‡et=adresa vys¡l. bajtu
2b1b  80c206         add    dl,06                ; stavov˜ registr modemu
2b1e  2e8a262229     mov    ah,cs:[2922]         ; po‡et cykl– pro ‡ek n¡
2b23  33c9           xor    cx,cx                ; CX <- 0 max. po‡et znak–

                                               ;* test zmˆny sign lu DDSR
2b25  50           * push   ax                   ; £schova DDSR a ‡¡t. TIME-OUT
2b26  8ae0           mov    ah,al                ; p–vodn¡ hodnota sig. DDSR,DSR
2b28  ec             in     al,dx                ; ‡ten¡ stav. registru modemu
2b29  32c4           xor    al,ah                ; zmˆna sign l– DDSR,DSR ?
2b2b  2e84062429     test   cs:[2924],al         ; stav.reg.modemu-DDSR a DSR
2b30  58             pop    ax                   ; n vrat DDSR a ‡¡t. TIME-OUT
2b31  754a           jnz    2b7d                 ; byla zmˆna sign lu DDSR

                                               ;* test p©ijat‚ho znaku (SERVER)
2b33  2ef6060f0301   test   cs:[030f],01         ; 01=p©¡znak SERVER
2b39  741f           jz     2b5a                 ; nen¡ SERVER
2b3b  50             push   ax                   ; £schova stavu sign lu DDSR
2b3c  4a             dec    dx                   ; stavov˜ registr linky
2b3d  ec             in     al,dx                ; stavov˜ registr linky
2b3e  42             inc    dx                   ; stavov˜ registr modemu
2b3f  a801           test   al,01                ; je p©ijat nˆjak˜ znak ?
2b41  58             pop    ax                   ; n vrat stavu sign lu DDSR
2b42  7416           jz     2b5a                 ; nen¡ p©ijat ‘ dn˜ znak

                                               ;* p©¡jem jednoho znaku (SERVER)
2b44  50             push   ax                   ; £schova AX
2b45  53             push   bx                   ; £schova BX
2b46  51             push   cx                   ; £schova CX
2b47  52             push   dx                   ; £schova DX
2b48  56             push   si                   ; £schova SI
2b49  57             push   di                   ; £schova DI
2b4a  1e             push   ds                   ; £schova DS
2b4b  80ea04         sub    dl,04                ; identif. registr p©eru¨en¡
2b4e  0e             push   cs
2b4f  1f             pop    ds                   ; DS <- CS
2b50  e884fa         call   25d7                 ; obsluha p©¡jmu znaku z COM
2b53  1f             pop    ds                   ; n vrat DS
2b54  5f             pop    di                   ; n vrat DI
2b55  5e             pop    si                   ; n vrat SI
2b56  5a             pop    dx                   ; n vrat DX
2b57  59             pop    cx                   ; n vrat CX
2b58  5b             pop    bx                   ; n vrat BX
2b59  58             pop    ax                   ; n vrat AX

                                               ;* ‡ek n¡ na sign l DDSR
2b5a  e2c9         * loop   2b25                 ; dal¨¡ ‡ek n¡ na DDSR,DSR
2b5c  fecc           dec    ah                   ; sn¡‘en¡ ‡¡ta‡e pro ‡ek n¡
2b5e  75c5           jnz    2b25                 ; dal¨¡ ‡ek n¡ na vysl n¡ znaku

                                               ;* hl ¨en¡ - ‡ek n¡ na START
2b60  e8b9ef         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG
                                                 ; text "‡ek n¡ na za‡ tek paketu"
2b63                 db     'Warte auf Paketstart',10,13,0
2b7a  e98600         jmp    2c03                 ; chybov‚ hl ¨en¡ TIME-OUT

                                               ;* ‡ek n¡ na vynulov n¡ DDSR
2b7d  33c9           xor    cx,cx                ; doba pro TIME-OUT
2b7f  ec           * in     al,dx                ; ‡ten¡ stav. registru modemu
2b80  2e84062329     test   cs:[2923],al         ; stav.reg.modemu-maska DDSR
2b85  7410           jz     2b97                 ; je konec sign lu DDSR
2b87  e2f6           loop   2b7f                 ; ‡ek n¡ na vynulov n¡ DDSR

                                               ;* chyba obvodu 8250 - DDSR
2b89  e890ef         call   1b1c                 ; chybov‚ hl ¨en¡ - chyba obvodu 8250
                                                 ; text "chyba obvodu 8250"
2b8c                 db     '8250 ERR',10,13,0

                                               ;* zde se vy¨lou data od DS:SI
                                               ;* BL=po‡et bajt– k vysl n¡
                                               ;* BH=v˜choz¡ hodnota k. sou‡tu

2b97  80ea06       * sub    dl,06                ; datov˜ registr portu COM

                                               ;* ‡ek n¡ na uvolnˆn¡ vys¡la‡e
2b9a  80c205       * add    dl,05                ; stavov˜ registr linky
2b9d  33c9           xor    cx,cx                ; doba pro TIME-OUT
2b9f  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2ba0  a820           test   al,20                ; je vys¡lac¡ registr pr zdn˜ ?
2ba2  7505           jnz    2ba9                 ; vys¡lac¡ registr je pr zdn˜
2ba4  e2f9           loop   2b9f                 ; ‡ek n¡ na vypr zdnˆn¡ vys¡lac¡ho registru
2ba6  eb5b           jmp    2c03                 ; chybov‚ hl ¨en¡ TIME-OUT
2ba8  90             nop

                                               ;* vysl n¡ datov‚ho bajtu
2ba9  80ea05       * sub    dl,05                ; datov˜ registr portu COM
2bac  ac             lodsb                       ; znak k vysl n¡
2bad  02f8           add    bh,al                ; p©i‡ten¡ znaku ke k. sou‡tu
2baf  8ae0           mov    ah,al                ; znak k vysl n¡
2bb1  ee             out    dx,al                ; vysl n¡ znaku na port COM

                                               ;* ‡ek n¡ na odesl n¡ znaku
2bb2  80c205         add    dl,05                ; stavov˜ registr linky
2bb5  33c9           xor    cx,cx                ; doba pro ‡ek n¡ na vysl n¡
2bb7  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2bb8  a820           test   al,20                ; je vys¡lac¡ registr pr zdn˜ ?
2bba  7505           jnz    2bc1                 ; vys¡lac¡ registr je pr zdn˜
2bbc  e2f9           loop   2bb7                 ; ‡ek n¡ na vypr zdnˆn¡ vys¡l.
2bbe  eb43           jmp    2c03                 ; chybov‚ hl ¨en¡ TIME-OUT
2bc0  90             nop

                                               ;* dal¨¡ bajt k vysl n¡
2bc1  80ea05       * sub    dl,05                ; datov˜ registr
2bc4  fecb           dec    bl                   ; sn¡‘en¡ ‡¡ta‡e bajt–
2bc6  75d2           jnz    2b9a                 ; dal¨¡ bajt k vysl n¡

                                               ;* ‡ek n¡ na uvolnˆn¡ vys¡la‡e
2bc8  f6df           neg    bh                   ; - kontroln¡ sou‡et dat
2bca  80c205         add    dl,05                ; stavov˜ registr linky
2bcd  33c9           xor    cx,cx                ; doba pro TIME-OUT
2bcf  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2bd0  a820           test   al,20                ; je vys¡lac¡ registr pr zdn˜ ?
2bd2  7505           jnz    2bd9                 ; vys¡lac¡ registr je pr zdn˜
2bd4  e2f9           loop   2bcf                 ; ‡ek n¡ na vypr zdnˆn¡ vys¡l.
2bd6  eb2b           jmp    2c03                 ; chyba TIME-OUT vys¡l.
2bd8  90             nop

                                               ;* vysl n¡ kontroln¡ho sou‡tu
2bd9  80ea05       * sub    dl,05                ; datov˜ registr portu COM
2bdc  8ac7           mov    al,bh                ; kontroln¡ sou‡et dat
2bde  ee             out    dx,al                ; vysl n¡ kontroln¡ho sou‡tu
2bdf  80c205         add    dl,05                ; stavov˜ registr linky

                                               ;* ‡ek n¡ na vysl n¡ bajtu
2be2  33c9           xor    cx,cx                ; doba pro TIME-OUT
2be4  ec           * in     al,dx                ; ‡ten¡ stav. registru linky
2be5  a820           test   al,20                ; je vys¡lac¡ registr pr zdn˜ ?
2be7  7505           jnz    2bee                 ; vys¡lac¡ registr je pr zdn˜
2be9  e2f9           loop   2be4                 ; ‡ek n¡ na vypr zdnˆn¡ vys¡l.
2beb  eb16           jmp    2c03                 ; chybov‚ hl ¨en¡ TIME-OUT
2bed  90             nop

                                               ;* ukon‡en¡ vys¡l n¡ paketu - OK
2bee  42           * inc    dx                   ; stavov˜ registr modemu
2bef  ec             in     al,dx                ; zru¨en¡ po‘adavk– p©eru¨en¡
2bf0  80ea06         sub    dl,06                ; datov˜ registr portu COM
2bf3  8cce           mov    si,cs                ; SI <- CS
2bf5  8ede           mov    ds,si                ; DS <- CS
2bf7  8bf7           mov    si,di                ; SI <- DI
2bf9  804c0208       or     [si+02],08           ; p©¡znak - zpr va odesl na OK
2bfd  83440920       add    [si+09],0020         ; ‡¡ta‡ vyslan˜ch bajt– (+32)
2c01  59             pop    cx                   ; n vrat CX
2c02  c3             ret

                                               ;* chyba TIME-OUT vys¡l n¡
2c03  8cce         * mov    si,cs                ; SI <- CS
2c05  8ede           mov    ds,si                ; DS <- SI
2c07  8bf7           mov    si,di                ; SI <- DI
2c09  804c0210       or     [si+02],10           ; p©¡znak TIME-OUT
2c0d  c606262900     mov    [2926],00            ; obsluhovan‚ funkce p©enosu
2c12  59             pop    cx
2c13  e806ef         call   1b1c                 ; tisk chybov‚ho hl ¨en¡ DEBUG

2c16                 db     'tmtr timeout',10,13,0

2c25  c3             ret
; -----------------------------------------------------------------------------
;                      Vysl n¡ vˆty na protistanici
; -----------------------------------------------------------------------------
                                                 ; VSTUP: BL=‡¡slo tabulky

                                               ;* adresa tabulky parametr–
2c26  fa           * cli                         ; z kaz p©eru¨en¡
2c27  8cce           mov    si,cs                ; SI <- CS
2c29  8ede           mov    ds,si                ; DS <- CS
2c2b  32ff           xor    bh,bh                ; BH <- 00
2c2d  d1e3           shl    bx,1                 ; BX * 2
2c2f  8bb72929       mov    si,[bx+2929]         ; adresa tabulky parametr–


2c33  8a3e2629       mov    bh,[2926]            ; obsluhovan‚ funkce p©enosu
2c37  0a7c01         or     bh,[si+01]           ; OR 1
2c3a  327c01         xor    bh,[si+01]           ; zmˆna bitu
2c3d  7518           jnz    2c57                 ; prob¡h  jin  obsluha
2c3f  89362729       mov    [2927],si            ; aktu ln¡ tabulka parametr–

2c43  0a7c01         or     bh,[si+01]           ; zpˆtn‚ nastaven¡ bitu
2c46  883e2629       mov    [2926],bh            ; nov‚ nastaven¡ bitu
2c4a  806402df       and    [si+02],df           ; zru¨en¡ p©¡znaku vysl n¡ 11h

                                               ;* vysl n¡ dat podle tabulky
2c4e  8b160a03       mov    dx,[030a]            ; adresa portu COM
2c52  e87bfd         call   29d0                 ; vysl n¡ dat na port COMx:
2c55  f8             clc
2c56  c3             ret

2c57  804c0220     * or     [si+02],20           ; p©¡znak - obsluha ji‘ prob¡h 
2c5b  f8             clc
2c5c  c3             ret

; -----------------------------------------------------------------------------

2c5d                 db     0                    ; 1=p©¡znak p©eru¨en¡ 1ah
; -----------------------------------------------------------------------------
;                       Test p©ipravenosti protistanice
; -----------------------------------------------------------------------------
                                               ;* (vy¨le 1fh a ‡ek  na 1ah)

                                                 ; VSTUP: DX=adresa portu COM
                                                 ;        CL=doba pro TIME-OUT

                                               ;* p©¡prava registr–
2c5e  fa           * cli                         ; z kaz p©eru¨en¡
2c5f  8ae1           mov    ah,cl                ; hodnota pro TIME-OUT
2c61  2ec7062222a12c mov    cs:[2222],2ca1       ; p©echodn  adresa p©¡jmu
2c68  2ec6065d2c00   mov    cs:[2c5d],00         ; nulov n¡ p©¡znaku 1ah
2c6e  fb             sti                         ; povolen¡ p©eru¨en¡

                                               ;* vysl n¡ znaku 1Fh
2c6f  b01f           mov    al,1f                ; znak <US>
2c71  ee             out    dx,al                ; vysl n¡ znaku <US>
2c72  83c205         add    dx,0005              ; stavov˜ registr linky

                                                ;* zji¨tˆn¡ doby pro 1 znak
2c75  33c9           xor    cx,cx                ; CX <- 0 ‡¡ta‡ pro ‡ek n¡
2c77  ec           * in     al,dx                ; ‡ten¡ stavu linky
2c78  a840           test   al,40                ; byl ji‘ znak odesl n ?
2c7a  e1fb           loopz  2c77                 ; ‡ek n¡ na odesl n¡ znaku
2c7c  e314           jcxz   2c92                 ; je TIME-OUT vys¡la‡e
2c7e  f7d9           neg    cx                   ; doba pro odesl n¡ 1 znaku

                                                ;* ‡ek n¡ na znak max. CL znak–
2c80  8bd1         * mov    dx,cx                ; doba pro odesl n¡ 1 znaku
2c82  2ef6065d2c01 * test   cs:[2c5d],01         ; byl p©ijat znak ^Z (1AH) ?
2c88  e1f8           loopz  2c82                 ; ‡ek n¡ na p©¡jem znaku konce souboru
2c8a  8bca           mov    cx,dx                ; doba pro odesl n¡ 1 znaku
2c8c  7509           jnz    2c97                 ; byl p©ijat znak ^Z
2c8e  fecc           dec    ah                   ; ‡¡ta‡ pro TIME-OUT p©¡jmu
2c90  75ee           jnz    2c80                 ; dal¨¡ pokus o p©¡jem znaku

                                               ;* chyba TIME-OUT vys¡la‡e
2c92  b0ff         * mov    al,ff                ; k¢d chyby portu (TIME-OUT)
2c94  eb03           jmp    2c99                 ; n vrat
2c96  90             nop
                                               ;* p©¡jem OK
2c97  b000         * mov    al,00                ; p©¡znak - operace probˆhla OK
2c99  2ec7062222d725*mov    cs:[2222],25d7       ; n vrat adresy p©¡jmu znaku
2ca0  c3             ret
; -----------------------------------------------------------------------------
                                               ;* p©echodn  obsluha p©¡jmu znaku
2ca1  4a           * dec    dx
2ca2  4a             dec    dx                   ; adresa dat portu
2ca3  ec             in     al,dx                ; p©¡jem znaku z portu
2ca4  3c1a           cmp    al,1a                ; je znak ^Z (konec souboru) ?
2ca6  750d           jnz    2cb5                 ; nen¡ konec souboru
2ca8  80c205         add    dl,05                ; stavov˜ registr linky
2cab  ec             in     al,dx                ; stavov˜ registr linky
2cac  a81e           test   al,1e                ; je stav chyby ?
2cae  7505           jnz    2cb5                 ; je stav chyby
2cb0  800e5d2c01     or     [2c5d],01            ; p©¡znak - byl p©ijat znak 1ah
2cb5  c3           * ret

; -----------------------------------------------------------------------------
;                                  Data
; -----------------------------------------------------------------------------

2cb6                 db     0                    ; celkov˜ po‡et disk–

                                               ;* tato tabulka se pou‘¡v  pro
                                               ;* p©¡stup k za©¡zen¡ od d lkov‚ho
                                               ;* u‘ivatele

2cb7                 db     16 dup(11 dup(0))    ; tabulka disk. za©¡zen¡
                                                 ; ka‘d‚ za©¡zen¡ m  vyhra‘enou
                                                 ; tabulku dlouhou 11 bajt–:
;                    db     0                    ; 00: po‡et obsluhovan˜ch disk–
;                    dd     0                    ; 01: adresa rutiny STRATEGIE
;                    dd     0                    ; 05: adresa rutiny PžERU›EN‹
;                    dw     0                    ; 09: offset za‡ tku z hlav¡
                                                 ; konec tabulky: 00: 0
                                                 ; disky jsou uspo© d ny od
                                                 ; posledn¡ho disku k prvn¡mu

2d67                 db     0,1,2,3,4,5,6,7      ; sd¡len‚ disky SHARE (A a‘ P)
                     db     8,9,10,11,12,13,14,15; (FF=disk nen¡ sd¡len˜)

2d77                 db     0ch                  ; ‡¡slo p©eru¨en¡ INT od portu
2d78                 db     1                    ; dˆlic¡ konstanta rychlosti
2d79                 db     0                    ; nastaven¡ parity (18h=sud )

2d7a                 dw     0800h

2d7c                 db     40h dup(0)           ; buffer pro vysl n¡ po‘adavku

2d88                                             ; tabulka BPB extern¡ho disku
                     db

2dbc                 db     40h dup(0)           ; buffer pro p©¡jem po‘adavku

2dfc                 dw     2ef3h                ; adresa konce rezidentn¡ ‡ sti

2dfe                 db     40h dup(0)           ; buffer pro p©¡jem zpr vy
2e3e                 db     40h dup(0)           ; buffer pro vysl n¡ zpr vy

; -----------------------------------------------------------------------------
;                 Opakovan  inicializace s‚riov‚ho portu COM
; -----------------------------------------------------------------------------

2e7e  9c           * pushf                       ; £schova registru p©¡znak–
2e7f  fa             cli                         ; z kaz p©eru¨en¡
2e80  1e             push   ds                   ; £schova DS
2e81  52             push   dx                   ; £schova DX
2e82  53             push   bx                   ; £schova BX
2e83  50             push   ax                   ; £schova AX

                                               ;* nastaven¡ rychlosti p©enosu
2e84  2e8b160a03     mov    dx,cs:[030a]         ; adresa portu COM
2e89  80c203         add    dl,03                ; ©¡dic¡ registr linky
2e8c  b080           mov    al,80                ; bajt pro zapnut¡ sign lu DLAB
2e8e  ee             out    dx,al                ; zapnut¡ sign lu DLAB
2e8f  80ea03         sub    dl,03                ; adr. ni‘¨¡ho bajtu rychlosti
2e92  2ea0782d       mov    al,cs:[2d78]         ; dˆlic¡ konstanta rychlosti
2e96  ee             out    dx,al                ; nastaven¡ rychlosti p©enosu
2e97  32c0           xor    al,al                ; vy¨¨¡ bajt rychlosti = 0
2e99  42             inc    dx                   ; vy¨¨¡ bajt rychlosti p©enosu
2e9a  ee             out    dx,al                ; vy¨¨¡ bajt rychlosti p©enosu

                                               ;* nastaven¡ ©¡d. registru linky
2e9b  80c202         add    dl,02                ; ©¡dic¡ registr linky
2e9e  b003           mov    al,03                ; 8 bit–/1 stop-bit/bez parity
2ea0  2e0a06792d     or     al,cs:[2d79]         ; nastaven¡ parity (18h=sud )
2ea5  ee             out    dx,al                ; nastaven¡ ©¡d. registru linky

                                               ;* nastaven¡ ©¡d. registru modemu
2ea6  42             inc    dx                   ; adresa ©¡d. registru modemu
2ea7  ec             in     al,dx                ; stav ©¡dic¡ho registru modemu
2ea8  2e0a060625     or     al,cs:[2506]         ; ©¡dic¡ reg.modemu-sign ly OUT
2ead  ee             out    dx,al                ; nastaven¡ ©¡d. reg. modemu

                                               ;* nastaven¡ registru p©eru¨en¡
2eae  83ea03         sub    dx,0003              ; registr maskov n¡ p©eru¨en¡
2eb1  b00d           mov    al,0d                ; povolen¡ p©eru¨en¡ pro v¨echny stavy kromˆ vys¡la‡e
2eb3  ee             out    dx,al                ; nastaven¡ registru masky p©eru¨en¡

                                               ;* nastaven¡ adresy obsluhy COMx
2eb4  33db           xor    bx,bx                ; BX <- 0000
2eb6  8edb           mov    ds,bx                ; DS <- 0000
2eb8  2e8a1e772d     mov    bl,cs:[2d77]         ; ‡¡slo p©eru¨en¡ INT od portu
2ebd  d1e3           shl    bx,1                 ; BX * 2
2ebf  d1e3           shl    bx,1                 ; BX * 4 = adresa vektoru INT
2ec1  ba2e22         mov    dx,222e              ; adresa obsluhy COM
2ec4  8917           mov    [bx],dx              ; nastaven¡ offsetu obsluhy COM
2ec6  8c4f02         mov    [bx+02],cs           ; nastaven¡ segmentu obsluhy

                                               ;* nastaven¡ ©adi‡e p©eru¨en¡
2ec9  ba2100         mov    dx,0021              ; registr masky p©eru¨en¡
2ecc  ec             in     al,dx                ; ‡ten¡ masky p©eru¨en¡
2ecd  2e8a0e772d     mov    cl,cs:[2d77]         ; ‡¡slo p©eru¨en¡ INT od portu
2ed2  80e908         sub    cl,08                ; po©ad¡ sign lu p©eru¨en¡
2ed5  80f908         cmp    cl,08                ; kontrola p©ekro‡en¡ ‡¡sla
2ed8  7309           jnc    2ee3                 ; p©¡li¨ velk‚ nebo mal‚ ‡¡slo
2eda  b401           mov    ah,01                ; bit pro nastaven¡ bitu
2edc  d2e4           shl    ah,cl                ; posuv o dan˜ po‡et pozic
2ede  f6d4           not    ah                   ; negace - bit se bude nulovat
2ee0  22c4           and    al,ah                ; povolen¡ p©eru¨en¡ od COM
2ee2  ee             out    dx,al                ; nov  hodnota masky p©eru¨en¡

2ee3  58           * pop    ax                   ; n vrat AX
2ee4  5b             pop    bx                   ; n vrat BX
2ee5  5a             pop    dx                   ; n vrat DX
2ee6  1f             pop    ds                   ; n vrat DS
2ee7  9d             popf                        ; n vrat registru p©¡znak–
2ee8  c3             ret

; -----------------------------------------------------------------------------

2ee9                 db     'lastbyte:'

2ef2                 db      0                   ; posledn¡ bajt programu

; *****************************************************************************
;                   Konec rezidentn¡ ‡ sti programu
; *****************************************************************************

2ef3                 db     0

2ef4                 db     0                    ; 1=byla instalace NETUNITS.SYS

                                               ;* FCB souboru NET0
2ef5                 db     0                    ; k¢d diskov‚ jednotky souboru
2ef6                 db     'NET0       '        ; jm‚no a p©¡pona souboru
2f01                 dw     0                    ; aktu ln¡ blok
2f03                 dw     0                    ; d‚lka 1 z znamu
2f05                 dd     0                    ; velikost souboru
2f09                 dw     0                    ; datum posledn¡ho z pisu
2f0b                 dw     0                    ; ‡as posledn¡ho z pisu
2f0d                 db     0,0,0,0,0,0,0,0
2f15                 db     0                    ; aktu ln¡ z znam
2f16                 dd     0                    ; relativn¡ z znam

2f1a                 db     15 dup(0)

; *****************************************************************************
;        Obsluha INT 21h - jednor zovˆ spu¨tˆn  p©i ukon‡en¡ programu
;
;        Tato obsluha slou‘¡ ke kontrole z sahu do licen‡n¡ch text–.
; *****************************************************************************

                                               ;* instalace spr vn‚ obsluhy 21h
2f29  50             push   ax                   ; £schova AX
2f2a  51             push   cx                   ; £schova CX
2f2b  1e             push   ds                   ; £schova DS
2f2c  33c0           xor    ax,ax                ; AX <- 0000
2f2e  8ed8           mov    ds,ax                ; DS <- 0000
2f30  b8e903         mov    ax,03e9              ; nov  obsluha INT 21h
2f33  a38400         mov    [0084],ax            ; nastaven¡ nov‚ adresy INT 21h

                                               ;* Zde se otestuje z sah do lic.
                                               ;* text– um¡stˆn˜ch na za‡ tku
                                               ;* programu porovn n¡m s jejich
                                               ;* zak¢dovan˜mi kopiemi na konci.
                                               ;* Pokud byly texty modifikov ny,
                                               ;* program se zablokuje.

2f36  e82100         call   2f5a                 ; test textu 1
2f39  e83400         call   2f70                 ; test textu 2
2f3c  e84700         call   2f86                 ; test textu 3

                                               ;* spr vn˜ konec programu
2f3f  baf22e         mov    dx,2ef2              ; koncov  adresa programu
2f42  83c211         add    dx,0011              ; rezerva
2f45  2e03161003     add    dx,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku
2f4a  d1ea           shr    dx,1                 ; DX/2
2f4c  d1ea           shr    dx,1                 ; DX/4
2f4e  d1ea           shr    dx,1                 ; DX/8
2f50  d1ea           shr    dx,1                 ; p©epo‡et na odstavce

                                               ;* pokra‡ov n¡ v INT 21h
2f52  1f             pop    ds                   ; n vrat DS
2f53  59             pop    cx                   ; n vrat CX
2f54  58             pop    ax                   ; n vrat AX
2f55  2eff2ee802     jmp    far cs:[02e8]        ; vol n¡ obsluhy INT 21h

; -----------------------------------------------------------------------------
;     Kontrola licen‡n¡ho textu 1 - £vodn¡ text (r me‡ek)
; -----------------------------------------------------------------------------

2f5a  8ccf         * mov    di,cs                ; DI <- CS
2f5c  8edf           mov    ds,di                ; DS <- CS
2f5e  b96400         mov    cx,0064              ; korekce adres text–
2f61  bfac00         mov    di,00ac              ; kontrolovan˜ text 0110h
2f64  beb636         mov    si,36b6              ; zak¢dovan˜ text 371ah
2f67  b456           mov    ah,56                ; konstanta pro rozk¢dov n¡
2f69  e83000         call   2f9c                 ; ovˆ©en¡ textu
2f6c  fb             sti                         ; povolen¡ p©eru¨en¡
2f6d  72eb           jc     2f5a                 ; chyba - zablokov n¡ programu
2f6f  c3             ret

; -----------------------------------------------------------------------------
;     Kontrola licen‡n¡ho textu 2 - texty COPYRIGHT
; -----------------------------------------------------------------------------

2f70  8ccf         * mov    di,cs                ; DI <- CS
2f72  8edf           mov    ds,di                ; DS <- CS
2f74  b9c800         mov    cx,00c8              ; korekce adres text–
2f77  bf4701         mov    di,0147              ; kontrolovan˜ text 020fh
2f7a  be0636         mov    si,3606              ; zak¢dovan˜ text 36ceh
2f7d  b41a           mov    ah,1a                ; konstanta pro rozk¢dov n¡
2f7f  e81a00         call   2f9c                 ; ovˆ©en¡ textu
2f82  fb             sti                         ; povolen¡ p©eru¨en¡
2f83  72eb           jc     2f70                 ; chyba - zablokov n¡ programu
2f85  c3             ret

; -----------------------------------------------------------------------------
;     Kontrola licen‡n¡ho textu 3 - s‚riov‚ ‡¡slo
; -----------------------------------------------------------------------------

2f86  8ccf           mov    di,cs                ; DI <- CS
2f88  8edf           mov    ds,di                ; DS <- CS
2f8a  b92c01         mov    cx,012c              ; korekce adres text–
2f8d  bf3801         mov    di,0138              ; kontrolovan˜ text 0264h
2f90  bec819         mov    si,19c8              ; zak¢dovan˜ text 1af4h
2f93  b46a           mov    ah,6a                ; konstanta pro rozk¢dov n¡
2f95  e80400         call   2f9c                 ; ovˆ©en¡ textu
2f98  fb             sti                         ; povolen¡ p©eru¨en¡
2f99  72eb           jc     2f86                 ; chyba - zablokov n¡ programu
2f9b  c3             ret

; -----------------------------------------------------------------------------
;     Ovˆ©en¡ textu - porovn n¡ se zak¢dovan˜m vzorem a p©¡p. zablokov n¡
; -----------------------------------------------------------------------------

                                                 ; VSTUP: DS:SI=porovn van˜ text
                                                 ;        ES:DI=zak¢dovan˜ text
                                                 ;        CX=korekce adres text–
                                                 ;        AH=konst. rozk¢dov n¡

2f9c  fc             cld                         ; smˆr p©enosu nahoru
2f9d  03f1           add    si,cx                ; adresa porovn van‚ho textu
2f9f  03f9           add    di,cx                ; adresa referen‡n¡ho textu
2fa1  8aec           mov    ch,ah                ; konstanta pro rozk¢dov n¡
2fa3  32c9           xor    cl,cl                ; po‡ te‡n¡ znak
2fa5  ac           * lodsb                       ; na‡ten¡ znaku
2fa6  8ae0           mov    ah,al                ; £schova na‡ten‚ho znaku
2fa8  32c5           xor    al,ch                ; konstanta pro rozk¢dov n¡
2faa  d0c8           ror    al,1                 ; rotace AL vpravo
2fac  32c1           xor    al,cl                ; p©edchoz¡ znak
2fae  8acc           mov    cl,ah                ; £schova na‡ten‚ho znaku
2fb0  3805           cmp    [di],al              ; je znak shodn˜
2fb2  7507           jnz    2fbb                 ; nen¡ shoda - chyba
2fb4  47             inc    di                   ; zv˜¨en¡ c¡lov‚ho ukazatele
2fb5  0ac0           or     al,al                ; je ji‘ konec textu ?
2fb7  75ec           jnz    2fa5                 ; nen¡ konec - dal¨¡ znak
2fb9  f8             clc                         ; p©¡znak - text OK
2fba  c3             ret
                                               ;* zobrazen¡ chybov‚ho hl ¨en¡
                                               ;* "FILE IS CORRUPTED"

2fbb  be2935       * mov    si,3529              ; adresa textu hl ¨en¡ 36b9h
2fbe  b99001         mov    cx,0190              ; korekce adresy textu
2fc1  b41a           mov    ah,1a                ; v˜choz¡ znak pro rozk¢dov n¡
2fc3  e80200         call   2fc8                 ; zobrazen¡ chybov‚ho hl ¨en¡
2fc6  f9             stc                         ; p©¡znak chyby
2fc7  c3             ret

; -----------------------------------------------------------------------------
;     Zobrazen¡ chybov‚ho hl ¨en¡, zablokov n¡ programu
; -----------------------------------------------------------------------------
                                               ;* zobrazen¡ chybov‚ho hl ¨en¡
                                                 ; VSTUP: DS:SI=tabulka text–
                                                 ;        CX=offset textu v tabulce
                                                 ;        AH=konstanta k rozk¢dov n¡

                                               ;* p©¡prava registr–
2fc8  fc           * cld                         ; smˆr p©enosu dat nahoru
2fc9  03f1           add    si,cx                ; zdrojov  adresa textu
2fcb  8ccf           mov    di,cs                ; DI <- CS
2fcd  8ec7           mov    es,di                ; ES <- CS
2fcf  bf5c00         mov    di,005c              ; ukl dac¡ adresa k v˜stupu
2fd2  8aec           mov    ch,ah                ; konstanta pro rozk¢dov n¡
2fd4  32c9           xor    cl,cl                ; v˜choz¡ znak pro rozk¢dov n¡

                                               ;* rozk¢dov n¡ textu hl ¨en¡
2fd6  ac           * lodsb                       ; na‡ten¡ znaku
2fd7  8ae0           mov    ah,al                ; na‡ten˜ znak
2fd9  32c5           xor    al,ch                ; konstanta pro rozk¢dov n¡
2fdb  d0c8           ror    al,1                 ; rotace AL doprava
2fdd  32c1           xor    al,cl                ; p©edchoz¡ na‡ten˜ znak
2fdf  8acc           mov    cl,ah                ; na‡ten˜ znak
2fe1  aa             stosb                       ; ulo‘en¡ znaku
2fe2  0ac0           or     al,al                ; je ji‘ konec textu ?
2fe4  75f0           jnz    2fd6                 ; nen¡ je¨tˆ konec textu

                                               ;* p©¡prava adresy ke skoku
2fe6  be5c00         mov    si,005c              ; rozk¢dovan˜ text k zobrazen¡
2fe9  bf6034         mov    di,3460              ; program k zobrazen¡ hl ¨en¡
2fec  8dbd2c02       lea    di,[di+022c]         ; DI <- DI+022ch = 368ch
2ff0  8bec           mov    bp,sp                ; BP <- ukazatel z sobn¡ku
2ff2  33c0           xor    ax,ax                ; AX <- 0000
2ff4  894600         mov    [bp+00],ax           ; zru¨en¡ n vratov‚ adresy
2ff7  894602         mov    [bp+02],ax           ; zru¨en¡ n vratov‚ adresy
2ffa  894604         mov    [bp+04],ax           ; zru¨en¡ n vratov‚ adresy
2ffd  894606         mov    [bp+06],ax           ; zru¨en¡ n vratov‚ adresy
3000  894608         mov    [bp+08],ax           ; zru¨en¡ n vratov‚ adresy
3003  57             push   di                   ; adresa skoku = 368ch
3004  c3             ret                         ; skok na zobrazen¡ chybov‚ho
                                                 ; hl ¨en¡ SI (adresa 368ch)

; *****************************************************************************
;
;                          Instalace programu KIR_LINK
;
; *****************************************************************************
                                               ;* instalace programu LINK

3005  0e             push   cs                   ;
3006  1f             pop    ds                   ; DS <- CS
3007  0e             push   cs                   ;
3008  07             pop    es                   ; ES <- CS

                                               ;* inicializace videom¢du
3009  f606030180     test   [0103],80            ; m  se nastavit videom¢d ?
300e  7405           jz     3015                 ; nem  se nastavit videom¢d ?
3010  b80200         mov    ax,0002              ; funkce nastaven¡ videom¢du 2
3013  cd10           int    10                   ; nastaven¡ videom¢du 2

                                               ;* £vodn¡ text, copyright
3015  be1001       * mov    si,0110              ; £vodn¡ text
3018  e86306         call   367e                 ; v˜stup textu na displej
301b  be0f02         mov    si,020f              ; text copyright
301e  e85d06         call   367e                 ; v˜stup textu na displej
3021  be5902         mov    si,0259              ; text od© dkov n¡
3024  e85706         call   367e                 ; od© dkov n¡

                                               ;* zobrazen¡ s‚riov‚ho ‡¡sla
3027  f606030140     test   [0103],40            ; zobraz¡ se s‚riov‚ ‡¡slo ?
302c  7406           jz     3034                 ; nezobraz¡ se s‚riov‚ ‡¡slo
302e  be5c02         mov    si,025c              ; text - s‚riov‚ ‡¡slo
3031  e84a06         call   367e                 ; v˜stup textu na displej

                                               ;* inicializace portu, parametry
3034  e8ee02       * call   3325                 ; inicializace portu, parametry
3037  7305           jnc    303e                 ; inicializace OK
3039  b8014c         mov    ax,4c01              ; n vrat z programu s chybou
303c  cd21           int    21                   ; ukon‡en¡ programu

                                               ;* inicializace disk. driver–
303e  0e           * push   cs                   ; CS -> stack
303f  1f             pop    ds                   ; DS <- CS
3040  e8a701         call   31ea                 ; inic. obsluh disk. driver–

; ------------------ instalace obsluh p©eru¨en¡ INT

                                               ;* definice obsluh INTx
3043  0e             push   cs
3044  1f             pop    ds                   ; DS <- CS
3045  fa             cli                         ; z kaz p©eru¨en¡
3046  33c0           xor    ax,ax                ; AX <- 0000
3048  8ed8           mov    ds,ax                ; DS <- 0000

                                               ;* nastaven¡ obsluhy INT 28h
304a  a1a000         mov    ax,[00a0]            ; offset adresy obsluhy INT 28h
304d  2ea3ec02       mov    cs:[02ec],ax         ; offset star‚ obsluhy INT 28h
3051  a1a200         mov    ax,[00a2]            ; segment adresy INT 28h
3054  2ea3ee02       mov    cs:[02ee],ax         ; segment star‚ obsluhy INT 28h
3058  b83503         mov    ax,0335              ; vlastn¡ obsluha INT 28h
305b  a3a000         mov    [00a0],ax            ; nastaven¡ obsluhy INT 28h
305e  8c0ea200       mov    [00a2],cs            ; segment nov‚ obsluhy INT 28h

                                               ;* nastaven¡ obsluhy INT 13h
3062  a14c00         mov    ax,[004c]            ; offset adresy obsluhy INT 13h
3065  2ea3dc02       mov    cs:[02dc],ax         ; offset star‚ obsluhy INT 13h
3069  a14e00         mov    ax,[004e]            ; segment adresy INT 13h
306c  2ea3de02       mov    cs:[02de],ax         ; segment star‚ obsluhy INT 13h
3070  b8a806         mov    ax,06a8              ; vlastn¡ obsluha INT 13h
3073  a34c00         mov    [004c],ax            ; nastaven¡ obsluhy INT 13h
3076  8c0e4e00       mov    [004e],cs            ; segment nov‚ obsluhy INT 13h

                                               ;* nastaven¡ obsluhy INT 15h
307a  a15400         mov    ax,[0054]            ; offset adresy obsluhy INT 15h
307d  2ea3e002       mov    cs:[02e0],ax         ; offset star‚ obsluhy INT 15h
3081  a15600         mov    ax,[0056]            ; segment adresy INT 15h
3084  2ea3e202       mov    cs:[02e2],ax         ; segment star‚ obsluhy INT 15h
3088  b8f806         mov    ax,06f8              ; vlastn¡ obsluha INT 15h

                                               ;* nastaven¡ obsluhy INT 21h
308b  a18400         mov    ax,[0084]            ; offset adresy obsluhy INT 21h
308e  2ea3e802       mov    cs:[02e8],ax         ; offset star‚ obsluhy INT 21h
3092  a18600         mov    ax,[0086]            ; segment adresy INT 21h
3095  2ea3ea02       mov    cs:[02ea],ax         ; segment star‚ obsluhy INT 21h
3099  b8292f         mov    ax,2f29              ; vlastn¡ obsluha INT 21h
309c  a38400         mov    [0084],ax            ; nastaven¡ obsluhy INT 21h
309f  8c0e8600       mov    [0086],cs            ; segment nov‚ obsluhy INT 21h

                                               ;* nastaven¡ obsluhy INT 1Ch
30a3  a17000         mov    ax,[0070]            ; offset adresy obsluhy INT 1Ch
30a6  2ea3e402       mov    cs:[02e4],ax         ; offset star‚ obsluhy INT 1Ch
30aa  a17200         mov    ax,[0072]            ; segment adresy INT 1Ch
30ad  2ea3e602       mov    cs:[02e6],ax         ; segment star‚ obsluhy INT 1Ch
30b1  b8d904         mov    ax,04d9              ; vlastn¡ obsluha INT 1Ch
30b4  a37000         mov    [0070],ax            ; nastaven¡ obsluhy INT 1Ch
30b7  8c0e7200       mov    [0072],cs            ; segment nov‚ obsluhy INT 1Ch

                                               ;* obsluha zve©ejnˆn¡ disku
30bb  2e8c0efa02     mov    cs:[02fa],cs         ; segment adresy obsluhy disku

                                               ;* nastaven¡ obsluhy INT 08h
30c0  a12000         mov    ax,[0020]            ; offset adresy obsluhy INT 08h
30c3  2ea3d402       mov    cs:[02d4],ax         ; offset star‚ obsluhy INT 08h
30c7  a12200         mov    ax,[0022]            ; segment adresy INT 08h
30ca  2ea3d602       mov    cs:[02d6],ax         ; segment star‚ obsluhy INT 08h
30ce  b85406         mov    ax,0654              ; vlastn¡ obsluha INT 08h
30d1  a32000         mov    [0020],ax            ; nastaven¡ obsluhy INT 08h
30d4  8c0e2200       mov    [0022],cs            ; segment nov‚ obsluhy INT 08h

                                               ;* nastaven¡ obsluhy INT 09h
30d8  a12400         mov    ax,[0024]            ; offset adresy obsluhy INT 09h
30db  2ea3d802       mov    cs:[02d8],ax         ; offset star‚ obsluhy INT 09h
30df  a12600         mov    ax,[0026]            ; segment adresy INT 09h
30e2  2ea3da02       mov    cs:[02da],ax         ; segment star‚ obsluhy INT 09h
30e6  b88c06         mov    ax,068c              ; vlastn¡ obsluha INT 09h
30e9  a32400         mov    [0024],ax            ; nastaven¡ obsluhy INT 09h
30ec  8c0e2600       mov    [0026],cs            ; segment nov‚ obsluhy INT 09h

                                               ;* nastaven¡ obsluhy INT 5Ch
30f0  a17001         mov    ax,[0170]            ; offset adresy obsluhy INT 5Ch
30f3  2ea3f002       mov    cs:[02f0],ax         ; offset star‚ obsluhy INT 5Ch
30f7  a17201         mov    ax,[0172]            ; segment adresy INT 5Ch
30fa  2ea3f202       mov    cs:[02f2],ax         ; segment star‚ obsluhy INT 5Ch
30fe  b8cd1e         mov    ax,1ecd              ; vlastn¡ obsluha INT 5ch
3101  a37001         mov    [0170],ax            ; nastaven¡ obsluhy INT 5Ch
3104  8c0e7201       mov    [0172],cs            ; segment nov‚ obsluhy INT 5Ch

                                               ;* p©¡znak aktivity DOS
3108  0e             push   cs                   ; CS -> stack
3109  1f             pop    ds                   ; DS <- CS
310a  b434           mov    ah,34
310c  9c             pushf                       ; simulace vol n¡ INT x
310d  2eff1ee802     call   far cs:[02e8]        ; vol n¡ obsluhy INT 21h
3112  891e2203       mov    [0322],bx            ; p©¡znak aktivity funkce DOS
3116  8c062403       mov    [0324],es            ; p©¡znak aktivity funkce DOS

; ------------------ instalace adres pro zpracov n¡ zpr v

311a  0e             push   cs                   ; CS -> stack
311b  1f             pop    ds                   ; DS <- CS
311c  be5225         mov    si,2552
311f  c7440bff06     mov    [si+0b],06ff         ; adresa obsluhy ; p©esmˆrov n¡ za©¡zen¡
3124  c7441cff06     mov    [si+1c],06ff         ; adresa obsluhy
3129  8c4c0d         mov    [si+0d],cs           ; segment adresy obsluhy
312c  8c4c1e         mov    [si+1e],cs           ; segment adresy obsluhy

312f  beb425         mov    si,25b4
3132  c7440b981b     mov    [si+0b],1b98         ; adresa obsluhy ; p©esmˆrov n¡ za©¡zen¡
3137  c7441c981b     mov    [si+1c],1b98         ; adresa obsluhy
313c  8c4c0d         mov    [si+0d],cs           ; segment adresy obsluhy
313f  8c4c1e         mov    [si+1e],cs           ; segment adresy obsluhy

3142  be5225         mov    si,2552
3145  c7440fbc2d     mov    [si+0f],2dbc         ; adresa
314a  8c4c11         mov    [si+11],cs           ; segment adresy
314d  2ea1fc2d       mov    ax,cs:[2dfc]         ; adresa konce rezidentn¡ ‡ sti
3151  894413         mov    [si+13],ax
3154  8c4c15         mov    [si+15],cs

3157  beb425         mov    si,25b4
315a  c7440f3e2e     mov    [si+0f],2e3e         ; adresa
315f  8c4c11         mov    [si+11],cs           ; segment adresy
3162  c744133e2e     mov    [si+13],2e3e         ; adresa
3167  8c4c15         mov    [si+15],cs           ; segment adresy

; ------------------ rozli¨en¡ opera‡n¡ho syst‚mu

                                               ;* zji¨tˆn¡ verze syst‚mu
316a  2e8e061903     mov    es,cs:[0319]         ; segment driveru NETUNITS.SYS
316f  b430           mov    ah,30                ; verze OS
3171  9c             pushf                       ; simulace vol n¡ INT x
3172  2eff1ee802     call   far cs:[02e8]        ; vol n¡ obsluhy INT 21h
3177  2ea31403       mov    cs:[0314],ax         ; verze opera‡n¡ho syst‚mu
317b  d0e0           shl    al,1                 ; verze syst‚mu * 2
317d  2ea21603       mov    cs:[0316],al         ; verze oper. syst‚mu * 2

                                               ;* nastaven¡ p©¡znaku COMPAQ
3181  26f606040002   test   es:[0004],02         ; atribut-je volba COMPAQ ?
3187  7421           jz     31aa                 ; nen¡ volba COMPAQ
3189  2e803e140304   cmp    cs:[0314],04         ; je verze syst‚mu 4.x ?
318f  741d           jz     31ae                 ; je verze syst‚mu 4.x
3191  3c04           cmp    al,04                ; je verze syst‚mu 2.x ?
3193  7425           jz     31ba                 ; je syst‚m 2.x - nelze COMPAQ
3195  80fc1f         cmp    ah,1f                ; je verze 3.30 ?
3198  7220           jc     31ba                 ; je 3.30 nebo men¨¡ - nelze

                                               ;* p©¡znak re‘imu COMPAQ
319a  2e800e180340   or     cs:[0318],40         ; je p©¡stup k disku COMPAQ
31a0  2e810e16030100 or     cs:[0316],0001       ; verze syst‚mu * 2 + 1
31a7  eb05           jmp    31ae
31a9  90             nop

31aa  3c08         * cmp    al,08                ; je verze 4.x ?
31ac  720c           jc     31ba                 ; je men¨¡ verze ne‘ 4.x

                                               ;* p©¡znak mo‘nosti velk‚ho disku
31ae  26800e040002 * or     es:[0004],02         ; p©¡znak - m–‘e b˜t velk˜ disk
31b4  2e800e180380   or     cs:[0318],80         ; p©¡znak - m–‘e b˜t velk˜ disk

                                               ;* zvˆt¨en¡ bloku dat k p©enosu
31ba  bb1400       * mov    bx,0014              ; identifik tor NETUNITS.SYS
31bd  26817ffe646a   cmp    es:[bx-02],6a64      ; identifikace "dj"
31c3  7513           jnz    31d8                 ; nen¡ identifikace
31c5  268b1f         mov    bx,es:[bx]           ; adresa po‡tu sektor– HIGH
31c8  268b5702       mov    dx,es:[bx+02]        ; po‡et skryt˜ch sektor– - HIGH
31cc  2e3b161003     cmp    dx,cs:[0310]         ; max. d‚lka p©en ¨en‚ho bloku
31d1  7205           jc     31d8                 ; ‡¡slo je men¨¡
31d3  2e89161003     mov    cs:[0310],dx         ; max. d‚lka p©en ¨en‚ho bloku

                                               ;* ukon‡en¡ programu s instalac¡
31d8  baa536       * mov    dx,36a5              ; fiktivn¡ konec rezid. ‡ sti
31db  d1ea           shr    dx,1
31dd  d1ea           shr    dx,1
31df  d1ea           shr    dx,1
31e1  d1ea           shr    dx,1                 ; d‚lka rez. ‡ sti programu/16
31e3  b431           mov    ah,31                ; funkce rez. ukon‡en¡ programu
31e5  b001           mov    al,01                ; n vratov˜ k¢d
31e7  fb             sti                         ; povolen¡ p©eru¨en¡
31e8  cd21           int    21                   ; ukon‡en¡ rezid. programu

                                               ;* - p©i vol n¡ p©eru¨en¡ INT 21h
                                               ;* se vyvol  nejd©¡ve obsluha na
                                               ;* adrese 2f29h, kde se nastav¡
                                               ;* nov  koncov  adresa DX. Potom
                                               ;* se nastav¡ INT 21h na 03e9h

; -----------------------------------------------------------------------------
;     Inicializace obsluh diskov˜ch driver–
; -----------------------------------------------------------------------------

                                               ;* nalezen¡ driveru NET00000.SYS
31ea  8cca         * mov    dx,cs                ; DX <- CS
31ec  8eda           mov    ds,dx                ; DS <- CS
31ee  baf52e         mov    dx,2ef5              ; FCB souboru 'NET0 '
31f1  b40f           mov    ah,0f                ; otev©en¡ souboru NET0
31f3  cd21           int    21                   ; otev©en¡ souboru NET0
31f5  0ac0           or     al,al                ; byl soubor nalezen ?
31f7  740e           jz     3207                 ; soubor byl £spˆ¨nˆ otev©en

                                               ;* chyba-NET00000 nenainstalov n
31f9  b410           mov    ah,10                ; funkce uzav©en¡ souboru
31fb  cd21           int    21                   ; uzav©en¡ souboru NET0
31fd  becf32         mov    si,32cf              ; text "NET00000 nicht geladen"
3200  e87b04         call   367e                 ; v˜stup textu na displej
3203  b44c           mov    ah,4c                ; funkce ukon‡en¡ programu
3205  cd21           int    21                   ; konec - k¢d n vratu = 0

                                               ;* nastaven¡ adresy pro ‡ten¡
3207  8cca         * mov    dx,cs                ; DX <- CS
3209  8eda           mov    ds,dx                ; DS <- CS
320b  ba1720         mov    dx,2017              ; adresa pracovn¡ DTA
320e  b41a           mov    ah,1a                ; funkce nastaven¡ adresy DTA
3210  cd21           int    21                   ; nastaven¡ adresy pracovn¡ DTA

                                               ;* ‡ten¡ z znamu ze za©¡zen¡ NET0
3212  baf52e         mov    dx,2ef5              ; FCB souboru NET0
3215  b414           mov    ah,14                ; sekven‡n¡ ‡ten¡ ze souboru
3217  cd21           int    21                   ; sekven‡n¡ ‡ten¡ ze souboru

                                               ;* uzav©en¡ NET0
3219  b410           mov    ah,10                ; uzav©en¡ souboru
321b  cd21           int    21                   ; uzav©en¡ souboru NET0

                                               ;* posledn¡ driver - NET00000.SYS
321d  2ec41e1720     les    bx,cs:[2017]         ; ES:BX adresa driveru NET0
3222  32c9           xor    cl,cl                ; CL <- 0 ‡¡ta‡ disk–
3224  bfb72c         mov    di,2cb7              ; informace o disk. driverech



                                               ;* zde se mapuj¡ v¨echny drivery;
                                               ;* pokud je nalezen disk. driver,
                                               ;* uschovaj¡ se informace o nˆm
                                               ;* a p©i‡te se po‡et jeho disk–

                                               ;* test, zda byl posledn¡ driver
3227  81fbffff     * cmp    bx,ffff              ; offset - je posledn¡ driver ?
322b  7503           jnz    3230                 ; nen¡ je¨tˆ posledn¡ driver
322d  e98a00         jmp    32ba                 ; je posledn¡ driver
3230  8cc0         * mov    ax,es                ; segment adresy driveru
3232  3dffff         cmp    ax,ffff              ; je ji‘ posledn¡ driver ?
3235  7503           jnz    323a                 ; nen¡ je¨tˆ posledn¡ driver
3237  e98000         jmp    32ba                 ; je ji‘ posledn¡ driver

                                               ;* test, zda je diskov‚ za©¡zen¡
323a  26f747040080 * test   es:[bx+04],8000      ; atrib. - je znak. za©¡zen¡ ?
3240  7572           jnz    32b4                 ; je znakov‚ za©¡zen¡ - dal¨¡

                                               ;* £schova po‡tu disk–
3242  268a470a       mov    al,es:[bx+0a]        ; po‡et obsluhovan˜ch disk–
3246  0ac0           or     al,al                ; je nˆjak˜ disk ?
3248  746a           jz     32b4                 ; nen¡ ‘ dn˜ disk - dal¨¡
324a  02c8           add    cl,al                ; zv˜¨en¡ ukazatele disk–
324c  8805           mov    [di],al              ; po‡et obsluhovan˜ch disk–

                                               ;* £schova adres driveru
324e  268b4708       mov    ax,es:[bx+08]        ; offset rutiny PžERU›EN‹
3252  894505         mov    [di+05],ax           ; offset rutiny PžERU›EN‹
3255  268b4706       mov    ax,es:[bx+06]        ; offset rutiny STRATEGIE
3259  894501         mov    [di+01],ax           ; offset rutiny STRATEGIE
325c  8c4503         mov    [di+03],es           ; segment rutiny STRATEGIE
325f  8c4507         mov    [di+07],es           ; segment rutiny PžERU›EN‹
3262  895d09         mov    [di+09],bx           ; offset z hlav¡ driveru

                                               ;* ukazatel na dal¨¡ driver
3265  83c70b         add    di,000b              ; DI+0bh - dal¨¡ driver v tabulce

                                               ;* test, zda je driver NETUNITS
3268  53             push   bx                   ; £schova offsetu z hlav¡
3269  268b5f06       mov    bx,es:[bx+06]        ; offset rutiny STRATEGIE
326d  26807ffc4e     cmp    es:[bx-04],4e        ; je znak "N" ?
3272  753f           jnz    32b3                 ; nen¡ driver NETUNITS.SYS
3274  26807ffd24     cmp    es:[bx-03],24        ; je znak "$" ?
3279  7538           jnz    32b3                 ; nen¡ driver NETUNITS.SYS
327b  f606f42e01     test   [2ef4],01            ; byl nalezen NETUNITS.SYS ?
3280  7531           jnz    32b3                 ; NETUNITS.SYS byl ji‘ nalezen

                                               ;* ozna‡en¡ NETUNITS jako pou‘it˜
3282  26c647fc6e     mov    es:[bx-04],6e        ; je pou‘it - ozna‡en¡ "n"

                                               ;* instalace obsluhy STRATEGIE
3287  26c607ea       mov    es:[bx],ea           ; k¢d instrukce JMP FAR
328b  26c74701f60f   mov    es:[bx+01],0ff6      ; offset obsluhy STRATEGIE
3291  268c4f03       mov    es:[bx+03],cs        ; segment obsluhy STRATEGIE

                                               ;* instalace obsluhy PžERU›EN‹
3295  5b             pop    bx                   ; offset z hlav¡ driveru
3296  53             push   bx                   ; offset z hlav¡ driveru
3297  268b5f08       mov    bx,es:[bx+08]        ; offset rutiny PžERU›EN‹
329b  26c607ea       mov    es:[bx],ea           ; k¢d instrukce JMP FAR
329f  26c74701640f   mov    es:[bx+01],0f64      ; offsetov obsluhy PžERU›EN‹
32a5  268c4f03       mov    es:[bx+03],cs        ; segment obsluhy PžERU›EN‹

                                               ;* p©¡znak, ‘e byl nainstalov n
32a9  800ef42e01     or     [2ef4],01            ; NETUNITS.SYS nainstalov n
32ae  2e8c061903     mov    cs:[0319],es         ; segment driveru NETUNITS.SYS

                                               ;* nastaven¡ dal¨¡ho driveru
32b3  5b           * pop    bx                   ; n vrat offsetu adresy driveru
32b4  26c41f       * les    bx,es:[bx]           ; adresa dal¨¡ho driveru za©¡z.
32b7  e96dff         jmp    3227                 ; test dal¨¡ho driveru


                                               ;* zde byl ji‘ posledn¡ driver
32ba  880eb62c     * mov    [2cb6],cl            ; celkov˜ po‡et disk–

32be  beec32         mov    si,32ec              ; text "Fehler: zugrif..."
32c1  f606f42e01     test   [2ef4],01            ; nainstalov n NETUNITS.SYS ?
32c6  7403           jz     32cb                 ; NETUNITS.SYS nenalezen-chyba
32c8  be0c33         mov    si,330c              ; text "LINK wurde geladen"
32cb  e8b003       * call   367e                 ; v˜stup textu na displej
32ce  c3             ret

32cf                 db     'NET00000 nicht geladen !  ',10,13,0
32ec                 db     'Fehler: Zugriff erfolglos    ',10,13,0
330c                 db     'LINK wurde geladen    ',10,13,0

; -----------------------------------------------------------------------------
;     Inicializace programu - rozbor parametr–, inicializace
; -----------------------------------------------------------------------------

                                                ;* rozbor zad n¡
3325  fa           * cli                         ; z kaz p©eru¨en¡
3326  e81401         call   343d                 ; rozk¢dov n¡ p©¡kazov‚ho © dku

3329  fa             cli                         ; z kaz p©eru¨en¡
332a  0e             push   cs
332b  1f             pop    ds                   ; DS <- CS

                                               ;* nastaven¡ ©¡d. reg. modemu
332c  803e0625ff     cmp    [2506],ff            ; je nastaven ©¡d.reg. modemu ?
3331  7505           jnz    3338                 ; ©¡d. reg. modemu byl nastaven
3333  c606062508     mov    [2506],08            ; jinak zapnut sign l OUT2

                                               ;* zji¨tˆn¡ adresy portu COM
3338  2e8b1e0d03   * mov    bx,cs:[030d]         ; ‡¡slo portu COM (0=COM1)
333d  2eff060d03     inc    w/cs:[030d]          ; ‡¡slo portu COM + 1 (1=COM1)
3342  d1e3           shl    bx,1                 ; ‡¡slo portu * 2 = offset
3344  b84000         mov    ax,0040              ; datov˜ segment BIOS
3347  8ed8           mov    ds,ax                ; datov˜ semgent BIOS
3349  8b17           mov    dx,[bx]              ; adresa portu COM
334b  2e89160a03     mov    cs:[030a],dx         ; adresa portu COM

                                               ;* kontrola existence portu COM
3350  0bd2           or     dx,dx                ; existuje adresa portu COM ?
3352  750a           jnz    335e                 ; adresa existuje OK
3354  0e             push   cs                   ; CS -> stack
3355  1f             pop    ds                   ; DS <- CS
3356  be9736         mov    si,3697              ; text 'COMx: nicht gefunden'
3359  e82203         call   367e                 ; v˜stup textu na displej
335c  f9             stc                         ; p©¡znak chyby
335d  c3             ret

                                               ;* inicializace portu COMx:
335e  42           * inc    dx                   ; [DX+1] registr p©eru¨en¡
335f  b000           mov    al,00                ; z kaz v¨ech p©eru¨en¡
3361  ee             out    dx,al                ; z kaz p©eru¨en¡ od SIO
3362  80c202         add    dl,02                ; [DX+3] ©¡dic¡ registr linky
3365  b080           mov    al,80                ; hodnota pro nastaven¡ DLAB
3367  ee             out    dx,al                ; nastaven¡ bitu DLAB
3368  80ea03         sub    dl,03                ; [DX] ni‘¨¡ bajt rychl.p©enosu
336b  2ea0782d       mov    al,cs:[2d78]         ; dˆlic¡ konstanta rychlosti
336f  ee             out    dx,al                ; ni‘¨¡ bajt rychlosti p©enosu
3370  32c0           xor    al,al                ; 0=vy¨¨¡ bajt rychlosti
3372  42             inc    dx                   ; [DX+1] vy¨¨¡ bajt rychlosti
3373  ee             out    dx,al                ; vy¨¨¡ bajt rychl. p©enosu = 0
3374  80c202         add    dl,02                ; [DX+3] ©¡dic¡ registr linky
3377  b003           mov    al,03                ; d‚lka slova = 8 bit–
3379  2e0a06792d     or     al,cs:[2d79]         ; nastaven¡ parity (18h=sud )
337e  ee             out    dx,al                ; nastaven¡ ©¡d. registru linky
337f  42             inc    dx                   ; [DX+4] ©¡dic¡ registr modemu
3380  2ea00625       mov    al,cs:[2506]         ; ©¡dic¡ reg.modemu-sign ly OUT
3384  ee             out    dx,al                ; nastaven¡ sign l– modemu OUT
3385  32c0           xor    al,al                ; 0 = nastaven¡ stav.reg.linky
3387  42             inc    dx                   ; [DX+5] stavov˜ registr linky
3388  ee             out    dx,al                ; nulov n¡ stav. reg. linky
3389  42             inc    dx                   ; [DX+6] stavov˜ registr modemu
338a  ee             out    dx,al                ; nulov n¡ stav. reg. modemu
338b  80ea05         sub    dl,05                ; [DX+1] reg. masky p©eru¨en¡
338e  b00d           mov    al,0d                ; p©eru¨en¡-v¨e kromˆ vys¡la‡e
3390  ee             out    dx,al                ; povolen¡ p©eru¨en¡

                                               ;* instalace obsluhy COMx
3391  8cca           mov    dx,cs                ; DX <- CS
3393  8eda           mov    ds,dx                ; DS <- CS
3395  a0772d         mov    al,[2d77]            ; ‡¡slo p©eru¨en¡ INT od portu
3398  b435           mov    ah,35                ; poskytnut¡ vektoru COMx
339a  cd21           int    21                   ; ‡ten¡ vektoru p©eru¨en¡ COMx
339c  891ef402       mov    [02f4],bx            ; £schova adresy vektoru COMx
33a0  8c06f602       mov    [02f6],es            ; segment adresy vektoru COMx
33a4  26817ffc7061   cmp    es:[bx-04],"ap"      ; je ji‘ nainstalov n ?
33aa  751b           jnz    33c7                 ; nen¡ identifikace "pass"
33ac  26817ffe7373   cmp    es:[bx-02],"ss"      ; kontrola instalace programu
33b2  7513           jnz    33c7                 ; nen¡ identifikace "pass"
33b4  ba9090         mov    dx,9090              ; nastaven¡ instrukc¡ NOP
33b7  88167e22       mov    [227e],dl            ; zru¨en¡ instrukce IRET
33bb  89166622       mov    [2266],dx            ; zru¨en¡ instrukc¡ ukon‡en¡
33bf  89166822       mov    [2268],dx            ; zru¨.p©eru¨en¡ v obsluze COMx
33c3  89166a22       mov    [226a],dx
33c7  ba2e22       * mov    dx,222e              ; vlastn¡ obsluha p©eru¨en¡
33ca  b425           mov    ah,25                ; nastaven¡ vektoru p©eru¨en¡
33cc  a0772d         mov    al,[2d77]            ; ‡¡slo p©eru¨en¡ INT od portu
33cf  cd21           int    21                   ; nastaven¡ obsluhy COMx

                                               ;* nastaven¡ ©adi‡e p©eru¨en¡
33d1  fa             cli                         ; z kaz p©eru¨en¡
33d2  ba2100         mov    dx,0021              ; registr masky p©eru¨en¡
33d5  ec             in     al,dx                ; ‡ten¡ reg. masky p©eru¨en¡
33d6  2e8a0e772d     mov    cl,cs:[2d77]         ; ‡¡slo p©eru¨en¡ INT od portu
33db  80e908         sub    cl,08                ; 0ch-8=4
33de  80f908         cmp    cl,08                ; je ‡¡slo INT v mez¡ch ?
33e1  7309           jnc    33ec                 ; ‡¡slo INT je mimo meze
33e3  b401           mov    ah,01                ; bit pro nastaven¡ masky
33e5  d2e4           shl    ah,cl                ; rotace na bit p©eru¨en¡
33e7  f6d4           not    ah                   ; maska p©eru¨en¡ - bit je 0
33e9  22c4           and    al,ah                ; povolen¡ p©eru¨en¡ (bit -> 0)
33eb  ee             out    dx,al                ; povolen¡ p©eru¨en¡ od COM

                                               ;* pokud je volba DEBUG,
                                               ;* provede se test p©eru¨en¡
                                               ;* od portu SIO
33ec  2ef6060c0301 * test   cs:[030c],01         ; je parametr DEBUG ?
33f2  7503           jnz    33f7                 ; je p©¡znak volby DEBUG
33f4  eb43           jmp    3439                 ; nen¡ DEBUG - n vrat
33f6  90             nop

                                               ;* p©¡prava pro test
33f7  2e80260c03fe * and    cs:[030c],fe         ; p©echodn‚ zru¨en¡ DEBUG
33fd  fb             sti                         ; povolen¡ p©eru¨en¡
33fe  b9e803         mov    cx,03e8              ; po‡et opakov n¡ = 1000

                                               ;* p©eru¨en¡ stavem modemu
3401  2e8b160a03   * mov    dx,cs:[030a]         ; adresa portu COM
3406  42             inc    dx
3407  42             inc    dx                   ; [DX+2] stav. reg. p©eru¨en¡
3408  ec             in     al,dx                ; ‡ten¡ stavu p©eru¨en¡
3409  2407           and    al,07                ; informa‡n¡ bity p©eru¨en¡
340b  3c00           cmp    al,00                ; je p©eru¨en¡ stavem modemu ?
340d  7507           jnz    3416                 ; nen¡ p©eru¨en¡ stavem modemu
340f  83c204         add    dx,0004              ; [DX+6] stavov˜ registr modemu
3412  ec             in     al,dx                ; zru¨en¡ p©eru¨en¡ od modemu
3413  eb16           jmp    342b                 ; dal¨¡ test
3415  90             nop

                                               ;* p©eru¨en¡ p©¡jmem znaku
3416  3c04         * cmp    al,04                ; bylo p©eru¨en¡ p©¡j¡ma‡em ?
3418  7506           jnz    3420                 ; nen¡ p©eru¨en¡ p©ij¡ma‡em
341a  4a             dec    dx
341b  4a             dec    dx                   ; [DX] datov˜ registr
341c  ec             in     al,dx                ; zru¨en¡ p©eru¨en¡ p©ij¡ma‡em
341d  eb0c           jmp    342b                 ; dal¨¡ test
341f  90             nop

                                               ;* p©eru¨en¡ stavem linky
3420  3c06         * cmp    al,06                ; p©eru¨en¡ stavem linky ?
3422  7507           jnz    342b                 ; nen¡ p©eru¨en¡ stavem linky
3424  83c203         add    dx,0003              ; [DX+5] stavov˜ registr linky
3427  ec             in     al,dx                ; p©eru¨en¡ stavem linky
3428  32c0           xor    al,al                ; AL <- 0 hodnota pro nulov n¡
342a  ee             out    dx,al                ; nul. sign l– stav. reg. linky

                                               ;* uvolnˆn¡ ©adi‡e, dal¨¡ test
342b  ba2000       * mov    dx,0020              ; port ©adi‡e p©eru¨en¡
342e  8ac2           mov    al,dl                ; uvolnˆn¡ ©adi‡e p©eru¨en¡ 20h
3430  ee             out    dx,al                ; ukon‡en¡ v¨ech p©eru¨en¡
3431  e2ce           loop   3401                 ; dal¨¡ test p©eru¨en¡

3433  2e800e0c0301   or     cs:[030c],01         ; n vrat nastaven¡ DEBUG

                                               ;* n vrat z inicializace
3439  fb           * sti                         ; povolen¡ p©eru¨en¡
343a  f8             clc                         ; nulov n¡ p©¡znaku chyby CF
343b  c3             ret

; -----------------------------------------------------------------------------
343c  0a

; -----------------------------------------------------------------------------
;     Rozbor zad n¡ z p©¡kazov‚ho © dku
; -----------------------------------------------------------------------------

                                               ;* p©¡prava registr–
343d  0e           * push   cs
343e  07             pop    es                   ; ES <- CS
343f  0e             push   cs
3440  1f             pop    ds                   ; DS <- CS
3441  33c9           xor    cx,cx                ; CX <- 0000 ‡¡ta‡ znak–
3443  be8100         mov    si,0081              ; offset p©¡kazov‚ho © dku
3446  8a4cff         mov    cl,[si-01]           ; d‚lka p©¡kazov‚ho © dku

                                                ;* na‡ten¡ prvn¡ho znaku param.
3449  e8f501       * call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
344c  7301           jnc    344f                 ; znak na‡ten OK
344e  c3             ret                         ; je konec textu - n vrat

                                                ;* parametr "COMx"
344f  3c43         * cmp    al,"C"               ; je znak "C" ?
3451  7527           jnz    347a                 ; nen¡ znak "C" - dal¨¡ p©¡kaz
3453  e8eb01         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3456  3c4f           cmp    al,"O"               ; je znak "O" ?
3458  75f5           jnz    344f                 ; nen¡ znak "O" - znovu
345a  e8e401         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
345d  3c4d           cmp    al,"M"               ; je znak "M" ?
345f  75ee           jnz    344f                 ; nen¡ znak "M" - znovu
3461  e8f601         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
3464  4a             dec    dx                   ; na‡ten˜ ‡¡seln˜ parametr - 1
3465  2e89160d03     mov    cs:[030d],dx         ; ‡¡slo portu COM (0=COM1)
346a  80e201         and    dl,01                ; 0=COM1, 1=COM2
346d  2ec606772d0c   mov    cs:[2d77],0c         ; ‡¡slo p©eru¨en¡ INT od portu
3473  2e2816772d     sub    cs:[2d77],dl         ; nastaven¡ ‡¡sla p©eru¨en¡
3478  ebcf           jmp    3449                 ; dal¨¡ parametr

                                                ;* parametr "/x" (rychlost)
347a  3c2f         * cmp    al,"/"               ; je znak "/" ?
347c  7514           jnz    3492                 ; nen¡ znak "/" - dal¨¡ p©¡kaz
347e  e8d901         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
3481  0bd2           or     dx,dx                ; na‡ten˜ ‡¡seln˜ parametr
3483  74c4           jz     3449                 ; chyba (=0) - dal¨¡ parametr
3485  81fa8000       cmp    dx,0080              ; kontrola p©enosov‚ rychlosti
3489  73be           jnc    3449                 ; moc velk  konstanta - dal¨¡
348b  2e8816782d     mov    cs:[2d78],dl         ; dˆlic¡ konstanta rychlosti
3490  ebb7           jmp    3449                 ; dal¨¡ parametr

                                                ;* parametr "PARITY"
3492  3c50         * cmp    al,"P"               ; je znak "P" ?
3494  752d           jnz    34c3                 ; nen¡ znak "P" - dal¨¡ p©¡kaz
3496  e8a801         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3499  3c41           cmp    al,"A"               ; je znak "A" ?
349b  7524           jnz    34c1                 ; nen¡ znak "A" - nov˜ test
349d  e8a101         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34a0  3c52           cmp    al,"R"               ; je znak "R" ?
34a2  751d           jnz    34c1                 ; nen¡ znak "R" - nov˜ test
34a4  e89a01         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34a7  3c49           cmp    al,"I"               ; je znak "I" ?
34a9  7516           jnz    34c1                 ; nen¡ znak "I" - nov˜ test
34ab  e89301         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34ae  3c54           cmp    al,"T"               ; je znak "T" ?
34b0  750f           jnz    34c1                 ; nen¡ znak "T" - nov˜ test
34b2  e88c01         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34b5  3c59           cmp    al,"Y"               ; je znak "Y" ?
34b7  7508           jnz    34c1                 ; nen¡ znak "Y" - nov˜ test
34b9  2e800e792d18   or     cs:[2d79],18         ; nastaven¡ parity (18h=sud )
34bf  eb88           jmp    3449                 ; dal¨¡ parametr
34c1  eb8c         * jmp    344f                 ; dal¨¡ parametr

                                                ;* parametr "OUT12:x"
34c3  3c4f         * cmp    al,"O"               ; je znak "O" ?
34c5  7531           jnz    34f8                 ; nen¡ znak "O" - dal¨¡ p©¡kaz
34c7  e87701         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34ca  3c55           cmp    al,"U"               ; je znak "U" ?
34cc  7527           jnz    34f5                 ; nen¡ znak "U" - nov˜ test
34ce  e87001         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34d1  3c54           cmp    al,"T"               ; je znak "T" ?
34d3  7520           jnz    34f5                 ; nen¡ znak "T" - nov˜ test
34d5  e86901         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34d8  3c31           cmp    al,"1"               ; je znak "1" ?
34da  7519           jnz    34f5                 ; nen¡ znak "1" - nov˜ test
34dc  e86201         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34df  3c32           cmp    al,"2"               ; je znak "2" ?
34e1  7512           jnz    34f5                 ; nen¡ znak "2" - nov˜ test
34e3  e85b01         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34e6  3c3a           cmp    al,":"               ; je znak ":" ?
34e8  750b           jnz    34f5                 ; nen¡ znak ":" - nov˜ test
34ea  e86d01         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
34ed  2e88160625     mov    cs:[2506],dl         ; ©¡dic¡ reg.modemu-sign ly OUT
34f2  e954ff         jmp    3449                 ; test dal¨¡ho p©¡kazu
34f5  e957ff       * jmp    344f                 ; nov˜ test p©¡kazu

                                                ;* parametr "SHARE:x"
34f8  3c53         * cmp    al,"S"               ; je znak "S" ?
34fa  757d           jnz    3579                 ; nen¡ znak "S" - dal¨¡ p©¡kaz
34fc  e84201         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
34ff  3c48           cmp    al,"H"               ; je znak "H" ?
3501  754d           jnz    3550                 ; nen¡ znak "H" - p©¡kaz SERVER
3503  e83b01         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3506  3c41           cmp    al,"A"               ; je znak "A" ?
3508  7540           jnz    354a                 ; nen¡ znak "A" - nov˜ test
350a  e83401         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
350d  3c52           cmp    al,"R"               ; je znak "R" ?
350f  7539           jnz    354a                 ; nen¡ znak "A" - nov˜ test
3511  e82d01         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3514  3c45           cmp    al,"E"               ; je znak "E" ?
3516  7532           jnz    354a                 ; nen¡ znak "E" - nov˜ test
3518  e82601         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
351b  3c3a           cmp    al,":"               ; je znak ":" ?
351d  752b           jnz    354a                 ; nen¡ znak ":" - nov˜ test
351f  b0ff           mov    al,ff                ; nulovac¡ hodnota pro SHARE
3521  bf672d         mov    di,2d67              ; tabulka disk– pro SHARE
3524  51             push   cx                   ; £schova CX
3525  b91000         mov    cx,0010              ; d‚lka tabulky disk– SHARE
3528  f3aa           rep    stosb                ; vynulov n¡ tabulky disk–
352a  59             pop    cx                   ; n vrat CX
352b  e81301       * call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
352e  721d           jc     354d                 ; konec p©¡kazov‚ho © dku
3530  2c41           sub    al,"A"               ; p©evod p¡smene na ‡¡slo
3532  7219           jc     354d                 ; nen¡ platn‚ p¡smeno
3534  2e8b1e7c36     mov    bx,cs:[367c]         ; po‡et disk– pro SHARE
3539  2e8887672d     mov    cs:[bx+2d67],al      ; nastaven¡ disku pro SHARE
353e  43             inc    bx                   ; zv˜¨en¡ po‡tu disk– SHARE
353f  81e30f00       and    bx,000f              ; omezen¡ na 15 disk–
3543  2e891e7c36     mov    cs:[367c],bx         ; po‡et disk– pro SHARE
3548  ebe1           jmp    352b                 ; nastaven¡ dal¨¡ho disku SHARE
354a  e902ff       * jmp    344f                 ; nov˜ test p©¡kazu
354d  e9f9fe       * jmp    3449                 ; test dal¨¡ho p©¡kazu

                                                ;* parametr "SERVER"
3550  3c45         * cmp    al,"E"               ; je znak "E" ?
3552  75f6           jnz    354a                 ; nen¡ znak "E" - nov˜ test
3554  e8ea00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3557  3c52           cmp    al,"E"               ; je znak "R" ?
3559  75ef           jnz    354a                 ; nen¡ znak "R" - nov˜ test
355b  e8e300         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
355e  3c56           cmp    al,"V"               ; je znak "V" ?
3560  75e8           jnz    354a                 ; nen¡ znak "V" - nov˜ test
3562  e8dc00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3565  3c45           cmp    al,"E"               ; je znak "E" ?
3567  75e1           jnz    354a                 ; nen¡ znak "E" - nov˜ test
3569  e8d500         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
356c  3c52           cmp    al,"R"               ; je znak "R" ?
356e  75da           jnz    354a                 ; nen¡ znak "R" - nov˜ test
3570  2ec6060f0301   mov    cs:[030f],01         ; nastaven¡ p©¡znaku SERVER
3576  e9d0fe         jmp    3449                 ; test dal¨¡ho p©¡kazu

                                                ;* parametr "INTx"
3579  3c49         * cmp    al,"I"               ; je znak "I" ?
357b  751c           jnz    3599                 ; nen¡ znak "I" - dal¨¡ p©¡kaz
357d  e8c100         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3580  3c4e           cmp    al,"N"               ; je znak "N" ?
3582  7512           jnz    3596                 ; nen¡ znak "N" - nov˜ test
3584  e8ba00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3587  3c54           cmp    al,"T"               ; je znak "T" ?
3589  750b           jnz    3596                 ; nen¡ znak "T" - nov˜ test
358b  e8cc00         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
358e  2e8816772d     mov    cs:[2d77],dl         ; ‡¡slo p©eru¨en¡ INT od portu
3593  e9b3fe         jmp    3449                 ; test dal¨¡ho p©¡kazu
3596  e9b6fe       * jmp    344f                 ; nov˜ test

                                                ;* parametr "FIX:x"
3599  3c46         * cmp    al,"F"               ; je znak "F" ?
359b  7520           jnz    35bd                 ; nen¡ znak "F" - dal¨¡ p©¡kaz
359d  e8a100         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35a0  3c49           cmp    al,"I"               ; je znak "I" ?
35a2  75f2           jnz    3596                 ; nen¡ znak "I" - nov˜ test
35a4  e89a00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35a7  3c58           cmp    al,"X"               ; je znak "X" ?
35a9  75eb           jnz    3596                 ; nen¡ znak "X" - nov˜ test
35ab  e89300         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35ae  3c3a           cmp    al,":"               ; je znak ":" ?
35b0  75e4           jnz    3596                 ; nen¡ znak ":" - nov˜ test
35b2  e8a500         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
35b5  2e88160103     mov    cs:[0301],dl         ; nastaven¡ parametru FIX (=1)
35ba  e98cfe         jmp    3449                 ; test dal¨¡ho p©¡kazu

                                                ;* parametr "DEBUG"
35bd  3c44         * cmp    al,"D"               ; je znak "D" ?
35bf  7528           jnz    35e9                 ; nen¡ znak "D" - dal¨¡ p©¡kaz
35c1  e87d00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35c4  3c45           cmp    al,"E"               ; je znak "E" ?
35c6  7524           jnz    35ec                 ; nen¡ znak "E" - dal¨¡ p©¡kaz
35c8  e87600         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35cb  3c42           cmp    al,"B"               ; je znak "B" ?
35cd  7517           jnz    35e6                 ; nen¡ znak "B" - nov˜ test
35cf  e86f00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35d2  3c55           cmp    al,"U"               ; je znak "U" ?
35d4  7510           jnz    35e6                 ; nen¡ znak "U" - nov˜ test
35d6  e86800         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35d9  3c47           cmp    al,"G"               ; je znak "G" ?
35db  7509           jnz    35e6                 ; nen¡ znak "G" - nov˜ test
35dd  2e800e0c0301   or     cs:[030c],01         ; parametr DEBUG
35e3  e963fe         jmp    3449                 ; test dal¨¡ho p©¡kazu
35e6  e966fe       * jmp    344f                 ; nov˜ test
35e9  e95dfe       * jmp    3449                 ; test dal¨¡ho p©¡kazu

                                                ;* parametr "DSR:x"
35ec  3c53         * cmp    al,"S"               ; je znak "S" ?
35ee  752d           jnz    361d                 ; nen¡ znak "S" - dal¨¡ p©¡kaz
35f0  e84e00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35f3  3c52           cmp    al,"R"               ; je znak "R" ?
35f5  e84900         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
35f8  3c3a           cmp    al,":"               ; je znak ":" ?
35fa  75ea           jnz    35e6                 ; nen¡ znak ":" - nov˜ test
35fc  e85b00         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
35ff  2e88162329     mov    cs:[2923],dl         ; stav.reg.modemu-maska DDSR
3604  8af2           mov    dh,dl                ; maska sign lu DDSR
3606  d0e6           shl    dh,1
3608  d0e6           shl    dh,1
360a  d0e6           shl    dh,1
360c  d0e6           shl    dh,1                 ; DDSR*16 = maska sign lu DSR
360e  2e88362529     mov    cs:[2925],dh         ; stav.reg.modemu-maska DSR
3613  0af2           or     dh,dl                ; maska sign l– DSR a DDSR
3615  2e88362429     mov    cs:[2924],dh         ; stav.reg.modemu-DDSR a DSR
361a  e92cfe         jmp    3449                 ; dal¨¡ p©¡kaz

                                                ;* test p©¡kazu "DTR:x"
361d  3c54         * cmp    al,"T"               ; je znak "T" ?
361f  751d           jnz    363e                 ; nen¡ znak "T" - dal¨¡ test
3621  e81d00         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
3624  3c52           cmp    al,"R"               ; je znak "R" ?
3626  7516           jnz    363e                 ; nen¡ znak "R" - dal¨¡ test
3628  e81600         call   3641                 ; na‡ten¡ znaku z p©¡kaz. © dku
362b  3c3a           cmp    al,":"               ; je znak ":" ?
362d  750f           jnz    363e                 ; nen¡ znak ":" - dal¨¡ test
362f  e82800         call   365a                 ; na‡ten¡ ‡¡seln‚ho parametru
3632  0ad2           or     dl,dl                ; na‡ten˜ parametr
3634  7408           jz     363e                 ; nen¡ zad n parametr - konec
3636  2e88160525     mov    cs:[2505],dl         ; ©¡d.reg.modemu-sign l DTR
363b  e90bfe         jmp    3449                 ; dal¨¡ p©¡kaz
363e  e90efe       * jmp    344f                 ; dal¨¡ test

; -----------------------------------------------------------------------------
;     Na‡ten¡ znaku z p©¡kazov‚ho © dku
; -----------------------------------------------------------------------------
                                                 ; VSTUP: DS:SI=ukazatel textu
                                                 ;        CX=‡¡ta‡ znak–
                                                 ; VSTUP: CY=nen¡ dal¨¡ znak

3641  e315         * jcxz   3658                 ; nen¡ ji‘ dal¨¡ znak textu
3643  ac             lodsb                       ; na‡ten¡ znaku
3644  49             dec    cx                   ; sn¡‘en¡ ‡¡ta‡e znak–
3645  3c0d           cmp    al,0d                ; je znak <CR> ?
3647  740c           jz     3655                 ; je znak <CR> - konec textu
3649  3c61           cmp    al,61                ; je znak men¨¡ ne‘ "a" ?
364b  7206           jc     3653                 ; je znak men¨¡ ne‘ "a"
364d  3c7b           cmp    al,7b                ; je znak vˆt¨¡ ne‘ "z" ?
364f  7302           jnc    3653                 ; je znak vˆt¨¡ ne‘ "z"
3651  3420           xor    al,20                ; zmˆna mal‚ho na velk‚ p¡smeno
3653  f8           * clc                         ; nulov n¡ p©¡znaku konce © dku
3654  c3             ret
3655  4e           * dec    si                   ; n vrat ukazatele textu
3656  33c9           xor    cx,cx                ; ‡¡ta‡ textu = 0
3658  f9           * stc                         ; nastaven¡ p©¡znaku konce © dku
3659  c3             ret

; -----------------------------------------------------------------------------
;     Na‡ten¡ ‡¡sla parametru
; -----------------------------------------------------------------------------
                                                 ; VSTUP: DS:SI=ukazatel textu
                                                 ;        CX=‡¡ta‡ znak–
                                                 ; VSTUP: DX=na‡ten‚ ‡¡slo

365a  33d2         * xor    dx,dx                ; po‡ te‡n¡ nastaven¡ st©ada‡e
365c  e31d         * jcxz   367b                 ; nen¡ ji‘ dal¨¡ znak
365e  ac             lodsb                       ; na‡ten¡ znaku z p©¡kaz. © dku
365f  49             dec    cx                   ; sn¡‘en¡ ‡¡ta‡e znak–
3660  8ae0           mov    ah,al                ; £schova na‡ten‚ho znaku
3662  80ec30         sub    ah,30                ; p©evod ‡¡slice na dek. ‡¡slo
3665  7212           jc     3679                 ; je men¨¡ ne‘ "0" - neplat¡
3667  80fc0a         cmp    ah,0a                ; je vˆt¨¡ ne‘ "9" ?
366a  730d           jnc    3679                 ; je vˆt¨¡ - neplatn˜ znak
366c  92             xchg   ax,dx                ; AX <- st© dan‚ ‡¡slo
366d  b40a           mov    ah,0a                ; n sobek 10*
366f  f6e4           mul    ah                   ; vyn soben¡ ‡¡sla * 10
3671  92             xchg   ax,dx                ; DX <- st© dan‚ ‡¡slo
3672  02d4           add    dl,ah                ; p©i‡ten¡ na‡ten‚ ‡¡slice
3674  80d600         adc    dh,00                ; p©i‡ten¡ p©enosu
3677  ebe3           jmp    365c                 ; na‡ten¡ dal¨¡ho znaku
3679  4e           * dec    si                   ; n vrat ukazatele textu
367a  41             inc    cx                   ; n vrat ‡¡ta‡e znak–
367b  c3           * ret

; -----------------------------------------------------------------------------

367c  0000           dw     0                    ; po‡et disk– pro SHARE

; -----------------------------------------------------------------------------
;     Zobrazen¡ textu DS:SI na displej
; -----------------------------------------------------------------------------
                                                 ; VSTUP: DS:SI=text k zobrazen¡

367e  ac           * lodsb                       ; na‡ten¡ znaku k zobrazen¡
367f  0ac0           or     al,al                ; je ji‘ konec textu ?
3681  7408           jz     368b                 ; je ji‘ konec textu
3683  b40e           mov    ah,0e                ; funkce zobrazen¡ znaku
3685  56             push   si                   ; £schova ukazatele SI
3686  cd10           int    10                   ; zobrazen¡ znaku v CTTY m¢du
3688  5e             pop    si                   ; n vrat ukazatele SI
3689  ebf3           jmp    367e                 ; dal¨¡ znak k zobrazen¡
368b  c3           * ret

; -----------------------------------------------------------------------------
;     Chybov‚ hl ¨en¡ a zablokov n¡ po‡¡ta‡e
; -----------------------------------------------------------------------------
                                               ;* zobrazen¡ chybov‚ho hl ¨en¡
                                                 ; VSTUP: DS:SI=text k zobrazen¡

368c  e8efff       * call   367e                 ; v˜stup textu na displej
368f  32c0           xor    al,al                ; nulov n¡ p©¡znaku ZF
3691  fa           * cli                         ; z kaz p©eru¨en¡
3692  90             nop
3693  74fc           jz     3691                 ; zablokov n¡ po‡¡ta‡e
3695  c3             ret

; -----------------------------------------------------------------------------

3696                 db     0

3697                 db     13,10,'COMx: nicht gefunden       ',7,13,10,0

36b8                 db     0

                                                 ; zak¢dovan˜ text hl ¨en¡
                                                 ; 'File is corrupted',13,10,0
36b9                 db     96h,0e5h,9,0c2h
                     db     0dfh,77h,12h,7eh
                     db     20h,84h,0f7h,11h
                     db     0d2h,5fh,4ch,48h
36c9                 db     42h,84h,7,14h

36cd                 db     0


                                                 ; zak¢dovan˜ text z adr. 020fh
36ce                 db     4ah,48h,0d8h,0ebh
                     db     0afh,37h,4,7ch
                     db     0b8h,9,7ah,9eh
                     db     55h,0f0h,69h,14h
36de                 db     0feh,39h,8ch,0d9h
                     db     6bh,24h,80h,0c5h
                     db     4dh,0c0h,1,0c6h
                     db     5fh,6eh,20h,40h
36ee                 db     8eh,57h,72h,0ach
                     db     3,7eh,94h,43h
                     db     0ech,99h,4bh,0feh
                     db     97h,47h,0d4h,25h
36fe                 db     82h,0fbh,0bh,0cah
                     db     5fh,60h,18h,0c0h
                     db     41h,0d8h,0dh,0deh
                     db     6bh,24h,0bch,0a1h
370e                 db     0bdh,0abh,0dh,8eh
                     db     0ddh,65h,40h,80h
                     db     0fh,4

3718                 db     3ch
3719                 db     0
                                                 ; zak¢dovan˜ text z adr. 0110h
371a                 db     0c5h,46h,41h,4fh
                     db     53h,6bh,1bh,0fbh
                     db     3ah,0b9h,0beh,0b0h
                     db     0ach,94h,0e4h,4
372a                 db     0c5h,46h,41h,4fh
                     db     53h,6bh,0f7h,0a3h
                     db     5,29h,44h,9eh
                     db     2bh,96h,0e9h,21h
373a                 db     0b2h,0b5h,0adh,89h
                     db     0c7h,73h,2ah,58h
                     db     7eh,38h,0bah,0b5h
                     db     7dh,0ech,0cfh,0bch
374a                 db     35h,28h,73h,0f0h
                     db     0f7h,0f9h,9,8eh
                     db     0afh,0efh,5bh,3eh
                     db     0f6h,0fbh,0c5h,81h
375a                 db     35h,52h,0b2h,0bbh
                     db     61h,0d4h,0bfh,69h
                     db     0f1h,0afh,1dh,0fdh
                     db     36h,0a1h,8eh,0d0h
376a                 db     6ch,15h,0e7h,2
                     db     0c9h,5eh,71h,2fh
                     db     93h,0eah,18h,0fdh
                     db     36h,0a1h,8eh,0d0h
377a                 db     06ch,0f7h,0a3h,5
                     db     5ch
