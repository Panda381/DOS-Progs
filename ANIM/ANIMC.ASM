
; *****************************************************************************
;
;                                A N I M C
;
;          kompil tor anima‡n¡ho programu ANIM (vy‘aduje 180 KB pamˆti)
;
; *****************************************************************************

Code     SEGMENT   para
         ASSUME    cs:Code,ds:Data,ss:Stack

PUBLIC   Animc
Animc:                                      ; start programu (kompil toru)

; ------ p©edefinov n¡ z sobn¡ku na vrchol pamˆti

         cli                                ; z kaz p©eru¨en¡
         mov       ax,ds:[2]                ; segment s koncem pamˆti
         sub       ax,1000h                 ; rezerva 64 KB
         mov       ss,ax                    ; segment z sobn¡ku
         mov       sp,0fff8h                ; offset z sobn¡ku
         sti                                ; povolen¡ p©eru¨en¡

; ------ ozna‡en¡ konce zad n¡ p©¡kazov‚ho © dku

         mov       bl,ds:[80h]              ; po‡et znak– p©¡kazu
         mov       bh,0
         mov       byte ptr ds:[bx+81h],0   ; ozna‡en¡ konce textu

; ------ kontrola voln‚ pamˆti, inicializace segmentov˜ch registr–

         mov       dx,offset MemTxt         ; text - nedostatek pamˆti
         mov       ax,SEG Interp            ; segment s interpreterem
         add       ax,2800h                 ; rezerva 160 KB
         cmp       ax,ds:[2]                ; je dostatek pamˆti ?
         mov       ax,SEG Data              ; datov˜ segment
         mov       ds,ax                    ; DS <- datov˜ segment
         jae       Animc8                   ; chyba - nedostatek pamˆti
         mov       ds:[SegPSP],es           ; £schova segmentu PSP
         mov       es,ax                    ; datov˜ segment

; ------ zobrazen¡ £vodn¡ho textu

         mov       dx,offset UvTxt          ; £vodn¡ text
         mov       ah,9
         int       21h                      ; zobrazen¡ £vodn¡ho textu

; ------ rozbor zad n¡ zdrojov‚ho souboru

         cld                                ; smˆr nahoru
         mov       si,81h                   ; za‡ tek textu
         call      RozbSpc                  ; vypustˆn¡ oddˆlova‡– z textu
         mov       dx,offset ZdrojTxt       ; text - zadejte soubor
         jc        Animc8                   ; chyba - nen¡ nic zad no
         mov       di,offset Soubor         ; buffer k ulo‘en¡ jm‚na souboru
Animc1:  call      RozbCh                   ; ‡ten¡ znaku ze souboru
         jc        Animc3                   ; nen¡ dal¨¡ znak
         cmp       al,"/"                   ; je oddˆlova‡ parametr– ?
         je        Animc2                   ; jsou parametry
         cmp       al,","                   ; je oddˆlovac¡ ‡ rka ?
         je        Animc2                   ; je oddˆlovac¡ ‡ rka
         cmp       al," "                   ; je oddˆlova‡ ?
         jbe       Animc2                   ; je oddˆlova‡
         stosb                              ; ulo‘en¡ znaku do bufferu
         jmp       short Animc1             ; dal¨¡ znak
Animc2:  dec       si                       ; n vrat posledn¡ho znaku
Animc3:  xor       al,al                    ; ukon‡ovac¡ bajt 0
         mov       bx,di                    ; £schova konce jm‚na
         stosb                              ; ulo‘en¡ uko‡ovac¡ho bajtu 0

; ------ nalezen¡ p©¡padn‚ p©¡pony jm‚na souboru

Animc4:  dec       di                       ; nastaven¡ na posledn¡ znak
         cmp       byte ptr ds:[di],"."     ; je p©¡pona zadan  ?
         je        Animc6                   ; p©¡pona je zadan 
         cmp       byte ptr ds:[di],"\"     ; je oddˆlova‡ cesty ?
         je        Animc5                   ; p©¡pona nen¡ zadan 
         cmp       di,offset Soubor         ; bude ji‘ p©ed za‡ tkem jm‚na ?
         ja        Animc4                   ; nebude je¨tˆ p©ed za‡ tkem jm‚na

; ------ nastaven¡ implicitn¡ p©¡pony

Animc5:  mov       di,bx                    ; konec specifikace souboru
         mov       si,offset PripAni        ; implicitn¡ p©¡pona .ANI
         mov       cx,5                     ; po‡et bajt– p©¡pony
         cld                                ; smˆr nahoru
         rep       movsb                    ; nastaven¡ implicitn¡ p©¡pony
         mov       di,bx                    ; adresa p©¡pony

; ------ otev©en¡ zdrojov‚ho souboru

Animc6:  mov       dx,offset Soubor         ; jm‚no zdrojov‚ho souboru
         mov       ax,3d00h                 ; funkce otev©en¡ pro ‡ten¡
         int       21h                      ; otev©en¡ souboru pro ‡ten¡
         mov       ds:[ZdrojId],ax          ; identifik tor zdrojov‚ho souboru
         jnc       Animc9                   ; soubor otev©en OK

; ------ chyba zad n¡ zdrojov‚ho souboru, jin  chyba

Animc7:  mov       dx,offset FndTxt         ; text - soubor nenalezen
Animc8:  mov       ah,9
         int       21h                      ; zobrazen¡ chybov‚ho textu
         mov       ax,4c01h
         int       21h                      ; n vrat s chybou

; ------ sestaven¡ jm‚na c¡lov‚ho souboru

Animc9:  mov       si,offset PripExe        ; p©¡pona v˜stupn¡ho souboru EXE
         mov       cx,5
         rep       movsb                    ; nastaven¡ p©¡pony souboru EXE

; ------ vytvo©en¡ c¡lov‚ho souboru

         mov       ah,3ch                   ; funkce vytvo©en¡ souboru
         xor       cx,cx                    ; atributy souboru
         int       21h                      ; vytvo©en¡ c¡lov‚ho souboru
         mov       dx,offset CilTxt         ; text - soubor nelze vytvo©it
         jc        Animc8                   ; chybn‚ zad n¡ jm‚na souboru
         mov       ds:[CilId],ax            ; identifik tor c¡lov‚ho souboru

; ------ ulo‘en¡ interpreteru programu

         push      ds
         mov       ax,SEG Interp            ; segment s interpreterem
         mov       ds,ax                    ; segment z hlav¡ interpreteru
         mov       cx,ax                    ; segment z hlav¡ interpreteru
         add       cx,ds:[8]                ; zv˜¨en¡ segmentu o z hlav¡ EXE
         mov       ds,cx                    ; segment s interpreterem
         add       cx,ds:[2]                ; segment konce interpreteru
         sub       cx,ax                    ; d‚lka interpreteru v odstavc¡ch
         shl       cx,1
         shl       cx,1
         shl       cx,1
         shl       cx,1                     ; d‚lka interpreteru v bajtech
         pop       ds
         call      WritProg                 ; ulo‘en¡ interpeteru do souboru

; ------ inicializace buffer– programu

         mov       ax,SEG Interp            ; segment s interpreterem
         add       ax,1000h                 ; buffer 64 KB
         mov       ds:[FlagBuf],ax          ; segment s tabulkou n vˆ¨t¡
         add       ax,1000h                 ; buffer 64 KB
         mov       ds:[SrcBuf],ax           ; segment vstupn¡ho bufferu 2000h B.

; ------ inicializace bufferu pro p©eklad programu (datov  ‡ st)

         mov       word ptr ds:[ProgNum],2  ; inicializace ukazatele v bufferu
         push      ds
         mov       ds,ds:[ProgSeg]          ; segment s bufferem programu
         mov       word ptr ds:[0],2        ; d‚lka datov‚ho bufferu programu
         pop       ds

; ------ kompilace programu

         call      Compil                   ; kompilace programu

; ------ z pis programu do souboru

         mov       cx,ds:[ProgNum]          ; po‡et bajt– v bufferu
         cmp       cx,ds:[SizProg]
         jbe       Anixx1
         mov       ds:[SizProg],cx          ; £schova velikosti programu
Anixx1:  call      WritProg                 ; z pis dat. promˆnn˜ch do souboru

; ------ z pis koncov‚ho objektu 0

         push      ds
         mov       ds,ds:[ProgSeg]          ; segment s programem
         mov       word ptr ds:[0],0        ; ‡¡slo objektu 0
         pop       ds
         mov       cx,2                     ; po‡et bajt– k z pisu
         call      WritProg                 ; z pis koncov‚ho objektu 0

; ------ nastaven¡ z hlav¡ programu

         mov       bx,ds:[CilId]            ; c¡lov˜ soubor
         xor       cx,cx
         xor       dx,dx
         mov       ax,4202h
         int       21h                      ; zji¨tˆn¡ velikosti programu

         mov       cx,512
         div       cx                       ; p©epo‡et na str nky
         or        dx,dx                    ; je bajt v posledn¡ str nce ?
         jz        Animca                   ; v posledn¡ str nce nen¡ bajt
         inc       ax                       ; str nka + 1
Animca:
         mov       word ptr ds:[CilSize],dx ; velikost v˜stupn¡ho souboru
         mov       word ptr ds:[CilSize+2],ax

         mov       dx,2
         mov       cx,0
         mov       ax,4200h
         int       21h                      ; ukazatel na offset souboru 2

         mov       dx,offset CilSize
         mov       ah,40h
         mov       cx,4
         int       21h                      ; z pis nov‚ velikosti programu

; ------ kontrola, zda byl program

         mov       dx,offset ErrMain        ; chyba - nen¡ procedura MAIN
         cmp       byte ptr ds:[ParMain],0  ; byla hlavn¡ procedura ?
         je        Navrat0                  ; nebyla hlavn¡ procedura
         mov       dx,offset ErrClos        ; chyba - procedura neuzav©ena
         cmp       byte ptr ds:[ProgLev],2  ; z–stala otev©en  procedura ?
         je        Navrat0                  ; z–stala otev©en  procedura

         jmp       short Navrat

; ------ chyba

PUBLIC   Navrat0
Navrat0: mov       ah,9
         int       21h                      ; zobrazen¡ chybov‚ho textu
         inc       word ptr ds:[CitChyb]    ; zv˜¨en¡ ‡¡ta‡e chyb


PUBLIC   Navrat
Navrat:

; ------ zobrazen¡ voln‚ho m¡sta

         mov       dx,offset FreeTxt        ; text - Voln˜ prostor
         mov       ah,9
         int       21h                      ; zobrazen¡ textu
         mov       ax,ds:[SizProg]          ; po‡et bajt– programu
         neg       ax                       ; voln‚ m¡sto
         call      DispNum                  ; zobrazen¡ voln‚ho prostoru
         mov       dx,offset FreeTxt1       ; text "data"
         mov       ah,9
         int       21h
         mov       ax,ds:[SizDat]           ; po‡et bajt– datov‚ho segmentu
         neg       ax                       ; voln‚ m¡sto
         call      DispNum                  ; zobrazen¡ voln‚ho prostoru
         mov       dx,offset FreeTxt2       ; text "Symboly"
         mov       ah,9
         int       21h
         mov       ax,-70                   ; maxim ln¡ konec tabulky symbol–
         sub       ax,ds:[FlagNum]          ; voln‚ m¡sto
         call      DispNum                  ; zobrazen¡ voln‚ho m¡sta
         mov       dx,offset FreeTxt3       ; zbytek textu
         mov       ah,9
         int       21h                      ; od© dkov n¡

; ------ zobrazen¡ po‡tu chyb

         mov       dx,offset Err000         ; text - Po‡et chyb
         mov       ah,9
         int       21h                      ; zobrazen¡ textu chyby
         mov       ax,ds:[CitChyb]          ; po‡et chyb
         push      ax                       ; £schova po‡tu chyb
         call      DispNum                  ; zobrazen¡ po‡tu chyb
         mov       dx,offset UvTxt1         ; text od© dkov n¡
         mov       ah,9
         int       21h                      ; od© dkov n¡ textu

; ------ uzav©en¡ soubor–

         mov       bx,ds:[ZdrojId]          ; identifik tor zdrojov‚ho souboru
         mov       ah,3eh
         int       21h                      ; uzav©en¡ zdrojov‚ho souboru
         mov       bx,ds:[CilId]            ; identifik tor c¡lov‚ho souboru
         mov       ah,3eh
         int       21h                      ; uzav©en¡ c¡lov‚ho souboru

; ------ konec programu

         pop       ax                       ; n vrat po‡tu chyb
         or        al,ah                    ; byla nˆjak  chyba ?
         jz        Animcx                   ; nebyla ‘ dn  chyba
         mov       dx,offset Soubor         ; jm‚no v˜stupn¡ho souboru
         mov       ah,41h                   ; funkce zru¨en¡ souboru
         int       21h                      ; zru¨en¡ v˜stupn¡ho souboru
         mov       al,1                     ; k¢d chyby 1
Animcx:  mov       ah,4ch
         int       21h                      ; n vrat z programu bez chyby

; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;
;                      Rozbor p©¡kazov‚ho © dku
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°

; -----------------------------------------------------------------------------
;        Vypustˆn¡ oddˆlova‡– z p©¡kazov‚ho © dku
; -----------------------------------------------------------------------------

PUBLIC   RozbSpc
RozbSpc: call      RozbCh
         je        RozbSpc                  ; je mezera - vypustˆn¡
         jc        RozbSpc2                 ; je konec textu
         dec       si                       ; n vrat posledn¡ho znaku
RozbSpc2:ret

; -----------------------------------------------------------------------------
;        Vstup znaku z p©¡kazov‚ho © dku SI (CY=konec)
; -----------------------------------------------------------------------------

PUBLIC   RozbCh
RozbCh:  push      ds
         mov       ds,ds:[SegPSP]           ; segment PSP
         cld                                ; smˆr nahoru
         lodsb                              ; ‡ten¡ znaku
         call      UpCase                   ; p©evod znaku na velk‚ p¡smeno

; ------ n hrada tabel toru mezerou

         cmp       al,9                     ; je tabel tor ?
         jne       RozbCh2                  ; nen¡ tabel tor
         mov       al," "                   ; n hrada mezerou

; ------ kontrola, zda je oddˆlova‡

RozbCh2: cmp       al," "                   ; je oddˆlova‡ ?
         jae       RozbCh3                  ; nen¡ oddˆlova‡
         dec       si                       ; konec - n vrat posledn¡ho znaku

RozbCh3: pop       ds
         ret

; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;
;                            Kompil tor
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°


; -----------------------------------------------------------------------------
;        Kompilace programu
; -----------------------------------------------------------------------------

PUBLIC   Compil
Compil:  xor       ax,ax                    ; AX <- 0
         push      ax                       ; identifik tor konce ©etˆzce cykl–

; ------ nalezen¡ dal¨¡ho p©¡kazu

Compil0: call      InpSpc                   ; nalezen¡ za‡ tku dal¨¡ho slova
         jnc       Compil01                 ; je dal¨¡ znak
Compil00:jmp       CompRet                  ; nen¡ dal¨¡ znak
Compil01:cmp       al,";"                   ; je pr zdn˜ p©¡kaz ?
         je        Compil0                  ; je pr zdn˜ p©¡kaz - dal¨¡
         call      RetCh                    ; n vrat nalezen‚ho znaku

; ------ £schova odkazu na © dek s p©¡kazem (pro zobrazen¡ chyby)

Compil1: mov       ax,word ptr ds:[UkazRad] ; sou‡asn˜ ukazatel © dku - LOW
         mov       word ptr ds:[ErrARad],ax ; ukazatel © dku s chybou - LOW
         mov       ax,word ptr ds:[UkazRad+2] ; sou‡asn˜ ukazatel © dku - HIGH
         mov       word ptr ds:[ErrARad+2],ax ; ukazatel © dku s chybou - HIGH
         mov       ax,ds:[CitRad]           ; sou‡asn‚ ‡¡slo © dku
         mov       ds:[ErrNRad],ax          ; ‡¡slo © dku s chybou

; ------ na‡ten¡ identifik toru povelu, identifikace konce p©ekladu

         mov       bp,sp                    ; ukazatel na cykly v z sobn¡ku
         call      ReadIdnt                 ; ‡ten¡ identifik toru
         jnc       Compil4                  ; je platn˜ identifik tor

; ------ chyba - neplatn˜ symbol (hl ¨en¡ chyby a nalezen¡ konce p©¡kazu)

Compil2: mov       dx,offset Err001         ; chyba - Neplatn˜ symbol
Compil3: call      DispErr                  ; zobrazen¡ textu chyby
Compil32:call      InpSpc                   ; zru¨en¡ znak– oddˆlova‡e
         jc        Compil00                 ; nen¡ dal¨¡ znak
         cmp       al,";"                   ; je konec p©¡kazu ?
         jne       Compil32                 ; nalezen¡ konce p©¡kazu
         jmp       short Compil0            ; p©eklad dal¨¡ho znaku

; ------ nalezen¡ identifik toru v tabulce vnit©n¡ch procedur

Compil4: call      SrcIdnt                  ; nalezen¡ slova v intern¡ tabulce
         jc        Compil5                  ; intern¡ identifik tor nenalezen

; ------ je intern¡ kl¡‡ov‚ slovo - kontrola opr vnˆnosti

                                          ;* deklara‡n¡ ‡ st programu
         mov       bl,ds:[ProgLev]          ; stupe¤ programu
         cmp       bl,0                     ; je za‡ tek programu ?
         jne       Comp43                   ; nen¡ za‡ tek programu

         mov       dx,offset Err019         ; LINK nesm¡ b˜t v deklar. ‡ sti
         cmp       al,0                     ; je LINK ?
         je        Compil3                  ; chyba - LINK nen¡ povoleno
         cmp       al,5                     ; maxim lnˆ povoleno PROC
         jbe       Comp4c                   ; povoleno
         jmp       short Compil3            ; chyba - nesm¡ b˜t v deklar. ‡ sti

                                          ;* vnit©n¡ ‡ st, PROC nen¡ otev©ena
Comp43:  cmp       bl,1                     ; je vnit©n¡ ‡ st - uzav©en  PROC ?
         jne       Comp46                   ; nen¡ vnit©n¡ ‡ st

         cmp       al,0                     ; je LINK ?
         je        Comp4c                   ; je LINK - OK
         cmp       al,5                     ; je PROC ?
         je        Comp4c                   ; je PROC - OK
         jb        Comp47                   ; je men¨¡ - test opr vnˆnosti
Comp44:  mov       dx,offset Err011         ; text - mus¡ b˜t v procedu©e
         jmp       short Compil3            ; hl ¨en¡ chyby

                                          ;* vnit©n¡ ‡ st, PROC je otev©ena
Comp46:  cmp       bl,2                     ; je vnit©n¡ ‡ st - otev©en  PROC ?
         jne       Comp49                   ; nen¡ vnit©n¡ ‡ st

         mov       dx,offset Err008         ; text - LINK nesm¡ b˜t uvnit© proc.
         cmp       al,0                     ; je LINK ?
         je        Compil3                  ; zobrazen¡ chybov‚ho hl ¨en¡

Comp47:  mov       dx,offset Err003         ; text - BYTE sm¡ b˜t jen v deklar.
         cmp       al,2                     ; je BYTE ?
         jb        Comp4c                   ; je INCLUDE - OK
         cmp       al,4                     ; je STRING ?
         jbe       Compil3                  ; chyba - nesm¡ b˜t
         jmp       short Comp4c             ; ostatn¡ OK

                                          ;* je konec programu
Comp49:  cmp       al,0                     ; je povoleno pouze LINK
         je        Comp4c                   ; povolen  funkce

                                          ;* chyba - za LINK je program
         mov       dx,offset Err007         ; chyba - nesmi n sledovat program
         call      DispErr                  ; zobrazen¡ textu chyby
         jmp       short CompRet            ; konec programu

; ------ intern¡ identifik tor nalezen a povolen

Comp4c:  mov       ds:[LastIdn],al          ; £schova identifik toru
         call      OutCh                    ; ulo‘en¡ identifik toru povelu
         mov       bh,0
         mov       bl,ds:[si]               ; d‚lka slova
         mov       ax,ss:[bp]               ; k¢d konstrukce v z sobn¡ku
         call      word ptr ds:[si+bx+1]    ; vyvol n¡ obsluhy procedury
         cmp       byte ptr ds:[LastIdn],24 ; je procedura ?
         jb        Compil02                 ; nen¡ bˆ‘n  procedura
         call      TestKon                  ; test, zda je konec p©¡kazu
Compil02:jmp       Compil0                  ; p©eklad dal¨¡ho slova

; ------ nen¡ vnit©n¡ identifik tor - pokus o nalezen¡ v u‘ivatelsk‚ tabulce

Compil5: xor       al,al                    ; p©¡znak - n vˆ¨t¡ nedefinov no
         call      StorFlg                  ; pokus o nalezen¡ v tabulce
         jnc       Compil53                 ; n vˆ¨t¡ nebylo v tabulce nalezeno
         test      al,1                     ; bylo jm‚no definov no ?
         jz        Compil53                 ; jm‚no nebylo dosud definov no

; ------ je u‘ivatelsk  procedura

         test      al,2                     ; je to procedura ?
         jz        Compil51                 ; je to promˆnn 
         mov       al,0ffh                  ; p©¡znak u‘ivatelsk‚ procedury
         call      OutCh                    ; ulo‘en¡ p©¡znak u‘ivat. procedury
         mov       ax,es:[di+1]             ; adresa symbolu
         call      OutWrd                   ; ulo‘en¡ adresy
         call      TestKon                  ; test konce p©¡kazu ";"
         jmp       short Compil02           ; dal¨¡ slovo

; ------ je promˆnn  - sestaven¡ k¢du promˆnn‚

Compil51:mov       al,0f8h                  ; p©¡znak promˆnn‚
         test      byte ptr es:[di],4       ; je WORD ?
         jz        Compil56                 ; je BYTE
         or        al,1                     ; p©¡znak WORD
Compil56:test      byte ptr es:[di],10h     ; je index ?
         jz        Compil57                 ; nen¡ index
         or        al,2                     ; p©¡znak indexu
Compil57:call      OutCh                    ; ulo‘en¡ p©¡znaku promˆnn‚

; ------ adresa promˆnn‚

         mov       ax,es:[di+1]             ; adresa symbolu
         call      OutWrd                   ; ulo‘en¡ adresy

; ------ pro indexovanou polo‘ku definice argumentu

         test      byte ptr es:[di],10h     ; je index ?
         jz        Compil58                 ; nen¡ index
         mov       cx,1                     ; 1 argument
         call      Argum                    ; dek¢dov n¡ argumentu

; ------ test p©i©azen¡

Compil58:call      InpPri                   ; test, zda n sleduje p©¡©azen¡ ":="
         mov       dx,offset Err004         ; chyba - :=
         jc        Compil35                 ; chyba definice promˆnn‚
         call      Vyraz                    ; ulo‘en¡ v˜razu do programu
         jc        Compil35                 ; chyba v˜razu
         call      TestKon                  ; test konce p©¡kazu ";"
         jmp       short Compil02           ; dal¨¡ p©¡kaz

; ------ chyba - nezn m‚ jm‚no procedury nebo promˆnn‚

Compil53:mov       dx,offset Err002         ; text chyby - identifik. nenalezen
Compil35:jmp       Compil3                  ; hl ¨en¡ chyby

; ------ n vrat - zji¨tˆn¡ neukon‡en˜ch cykl– a podm¡nek

; V z sobn¡ku 4 slova:
; SS:[BP+n+4] (DWORD)   ukazatel © dku v souboru
; SS:[BP+n+2] (WORD)    ‡¡slo © dku se za‡ tkem konstrukce
; SS:[BP+2]  n*(WORD)   adresy k proveden¡ relokace konstrukce
; SS:[BP+1] (BYTE)      po‡et slov adres k relokaci (=n)
; SS:[BP+0] (BYTE)      00h - konec vno©en˜ch konstrukc¡
;
;                       10h - PROC
;                                       ;(; v z sob.:<- xENDPROC (pro RETURN))
;
;                       20h - IF-THEN       ; v z sob.:<- ENDIF,ELSE (IF nespl.)
;                       21h - IF-THEN-ELSE  ; v z sob.:<- ENDIF (konec THEN)
;
;                       30h - DO            ; v z sob.:<- xENDDO (ON)
;                                           ; v z sob.: za‡ tek cyklu pro ENDDO
;                       (31h - FOR)
;
;                       40h - CASE-IN       ; v z sob.:<- ENDCASE,IN,OUT (ne-IN)
;                       41h - OUT           ; v z sob.:<- ENDCASE (konec IN)

; ------ test uzav©en¡ procedur a funkc¡

PUBLIC   CompRet
CompRet: mov       bp,sp
         call      ClosIf                   ; uzav©en¡ podm¡nek a cykl–
         call      ClosProc                 ; uzav©en¡ procedur
         cmp       byte ptr ss:[bp],0       ; je ji‘ konec ?
         jne       CompRet                  ; nen¡ konec - dal¨¡

         pop       ax                       ; zru¨en¡ identifik toru 0
         ret

; -----------------------------------------------------------------------------
;        Test ukon‡en¡ procedur (v z sobn¡ku sm¡ b˜t jen n vratov  adresa)
; -----------------------------------------------------------------------------

PUBLIC   ClosProc
ClosProc:pop       word ptr ds:[RetClose]   ; £schova n vratov‚ adresy

; ------ test, zda je procedura otev©ena

ClosPrc1:mov       bp,sp
         mov       ax,ss:[bp]               ; identifik tor konstrukce
         cmp       al,10h                   ; je identifik tor PROC ?
         jne       ClosPrc9                 ; nen¡ PROC - konec

; ------ zobrazen¡ textu chyby

         mov       dx,offset Err010         ; text - procedura nen¡ uzav©ena
         call      ClosDisp                 ; zobrazen¡ textu chyby
         jmp       short ClosPrc1           ; dal¨¡ test

ClosPrc9:jmp       word ptr ds:[RetClose]   ; n vrat z procedury

; -----------------------------------------------------------------------------
;        Test ukon‡en¡ konstrukc¡ (v z sobn¡ku sm¡ b˜t jen n vratov  adresa)
; -----------------------------------------------------------------------------

PUBLIC   ClosIf
ClosIf:  pop       word ptr ds:[RetClose]   ; £schova n vratov‚ adresy

; ------ test, zda je nˆkter  konstrukce otev©ena

ClosIf1: mov       bp,sp
         mov       ax,ss:[bp]               ; identifik tor konstrukce
         cmp       al,20h                   ; je identifik tor PROC ?
         jb        ClosIf9                  ; je PROC nebo konec - OK

; ------ zji¨tˆn¡ textu chyby

         mov       dx,offset Err020         ; text - IF neuzav©en
         cmp       al,30h                   ; je otev©en IF ?
         jb        ClosIf3                  ; je otev©en IF
         mov       dx,offset Err031         ; text - DO neuzav©en
         cmp       al,30h                   ; je cyklus DO ?
         jb        ClosIf3                  ; je otev©en DO
         mov       dx,offset Err040         ; text - CASE neuzav©eno
ClosIf3: call      ClosDisp                 ; zobrazen¡ textu chyby
         jmp       short ClosIf1            ; dal¨¡ konstrukce

ClosIf9: jmp       word ptr ds:[RetClose]   ; n vrat z procedury

; -----------------------------------------------------------------------------
;        Zobrazen¡ chyby neuzav©en¡ (v z sobn¡ku sm¡ b˜t jen n vratov  adresa)
; -----------------------------------------------------------------------------

PUBLIC   ClosDisp
ClosDisp:pop       word ptr ds:[RetDisp]    ; £schova n vratov‚ adresy

; ------ n vrat parametr– textu chyby

         pop       ax                       ; zru¨en¡ k¢du konstrukce
         or        ah,ah                    ; je nˆjak‚ slovo ?
         jz        ClosDis2                 ; nen¡ ‘ dn‚ slovo
ClosDis1:pop       cx                       ; zru¨en¡ slova ze z sobn¡ku
         dec       ah                       ; sn¡‘en¡ ‡¡ta‡e slov
         jnz       ClosDis1                 ; dal¨¡ slovo
ClosDis2:pop       cx                       ; n vrat ‡¡sla © dku
         pop       ax                       ; n vrat adresy © dku - LOW
         pop       bx                       ; n vrat adresy © dku - HIGH

; ------ £schova sou‡asn˜ch parametr– © dku

         push      word ptr ds:[ErrARad+2]  ; adresa © dku - HIGH
         push      word ptr ds:[ErrARad]    ; adresa © dku - LOW
         push      word ptr ds:[ErrNRad]    ; ‡¡slo © dku

; ------ nastaven¡ nov˜ch ukazatel– © dku

         mov       ds:[ErrNRAd],cx          ; ‡¡slo © dku
         mov       word ptr ds:[ErrARad],ax ; adresa © dku - LOW
         mov       word ptr ds:[ErrARad+2],bx ; adresa © dku - HIGH

; ------ zobrazen¡ chybov‚ho hl ¨en¡

         call      DispErr                  ; zobrazen¡ chybov‚ho hl ¨en¡

; ------ n vrat ukazatel– © dku

         pop       word ptr ds:[ErrNRad]    ; ‡¡slo © dku
         pop       word ptr ds:[ErrARad]    ; adresa © dku - LOW
         pop       word ptr ds:[ErrARad+2]  ; adresa © dku - HIGH

         jmp       word ptr ds:[RetDisp]    ; n vrat z procedury

; -----------------------------------------------------------------------------
;        Definice argumentu (CX=po‡et polo‘ek)
; -----------------------------------------------------------------------------

PUBLIC   Argum

Argum:   call      TestLeft                 ; test, zda je lev  z vorka
         jc        Argum2                   ; nen¡ lev  z vorka
Argum1:  call      Vyraz                    ; vstup prvn¡ho v˜razu
         jc        Argum3                   ; chybn˜ v˜raz v argumentu
         dec       cx
         jcxz      Argum5                   ; m  b˜t konec
         call      TestCar                  ; test, zda je ‡ rka
         jc        Argum2                   ; chybn˜ argument
         jmp       short Argum1             ; dal¨¡ argument

Argum5:  call      TestRght                 ; test, zda je prav  z vorka
         jnc       Argum4                   ; je prav  z vorka OK

Argum2:  mov       dx,offset Err01b         ; text - chybn˜ argument
Argum3:  call      DispErr                  ; zobrazen¡ textu chyby
         stc
Argum4:  ret

; -----------------------------------------------------------------------------
;        Definice v˜razu
; -----------------------------------------------------------------------------
;           0 - konec v˜razu
;           1 - (
;           2 - )
;           3 - ^
;           4 - *
;           5 - /
;           6 - MOD
;           7 - <<
;           8 - >>
;           9 - +
;          10 - -
;          11 - =
;          12 - <>
;          13 - <
;          14 - >
;          15 - <=
;          16 - >=
;          17 - NOT
;          18 - AND
;          19 - OR
;          20 - XOR
;         81h - ‡¡seln  konstanta (v BX hodnota konstanty)
;         82h - intern¡ procedura (v BL ‡¡slo procedury)
;         83h - u‘ivatelsk  procedura (v BX adresa procedury)
;         84h - BYTE bez indexu (v BX adresa promˆnn‚)
;         85h - WORD bez indexu (v BX adresa promˆnn‚)
;         86h - BYTE s indexem (v BX adresa promˆnn‚, n sleduje index)
;         87h - WORD s indexem (v BX adresa promˆnn‚, n sleduje index)
; -----------------------------------------------------------------------------
;þ
PUBLIC   Vyraz
Vyraz:
         call      Vyraz0
         pushf
         mov       al,0
         call      OutCh                    ; ozna‡en¡ konce v˜razu
         popf
         ret


PUBLIC   Vyraz0
Vyraz0:

; ------ dek¢dov n¡ prvn¡ho operandu

         call      VyrUn                    ; dek¢dov n¡ operandu
         jc        Vyraz9                   ; chyba

; ------ dek¢dov n¡ oper toru

Vyraz1:  call      GetOper                  ; dek¢dov n¡ oper toru
         cmc
         jnc       Vyraz9                   ; nen¡ dal¨¡ oper tor - nevad¡

; ------ test, zda je konec v˜razu

         cmp       al,2                     ; je prav  z vorka ?
         jne       Vyraz2                   ; nen¡ prav  z vorka
         mov       al,")"                   ; p–vodn¡ prav  z vorka
         call      RetCh                    ; n vrat prav‚ z vorky
         jmp       short Vyraz9             ; konec v˜razu

; ------ ulo‘en¡ k¢du oper toru

Vyraz2:  call      OutCh                    ; ulo‘en¡ k¢du oper toru

; ------ dek¢dov n¡ druh‚ho operandu

         call      VyrUn                    ; dek¢dov n¡ druh‚ho operandu
         jnc       Vyraz1                   ; OK, tak‘e dal¨¡ oper tor


Vyraz9:  mov       dx,offset Err005         ; text - cbybn˜ v˜raz
         ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ jednoduch‚ho v˜razu (s un rn¡m oper torem)
; -----------------------------------------------------------------------------

PUBLIC   VyrUn

VyrUn:   push      bx
         push      cx

; ------ dek¢dov n¡ un rn¡ho oper toru

VyrUn1:  call      GetOper                  ; dek¢dov n¡ p©¡padn‚ho oper toru
         jc        VyrUn4                   ; nen¡ platn˜ oper tor
         cmp       al,9                     ; je un rn¡ + ?
         je        VyrUn1                   ; je un rn¡ + (ignoruje se)
         cmp       al,10                    ; je un rn¡ - ?
         je        VyrUn2                   ; je un rn¡ - (ulo‘¡ se)
         cmp       al,17                    ; je un rn¡ NOT ?
         jne       VyrUn3                   ; nen¡ un rn¡ NOT - test z vorky
VyrUn2:  call      OutCh                    ; ulo‘en¡ un rn¡ho oper toru
         jmp       short VyrUn1             ; dal¨¡ un rn¡ oper tor

; ------ dek¢dov n¡ v˜razu v z vorce

VyrUn3:  cmp       al,1                     ; je lev  z vorka ?
         stc                                ; p©¡znak chyby
         jne       VyrUn9                   ; nen¡ platn˜ oper tor - chyba
         call      Outch                    ; ulo‘en¡ k¢du lev‚ z vorky
         call      Vyraz0                   ; dek¢dov n¡ v˜razu v z vorce
         jc        VyrUn9                   ; byla nˆjak  chyba
         call      GetOper                  ; test dal¨¡ho oper toru
         jc        VyrUn9                   ; nen¡ prav  z vorka - chyba
         cmp       al,2                     ; je prav  z vorka ?
         stc                                ; p©¡znak chyby
         jne       VyrUn9                   ; chyba - nen¡ prav  z vorka
         call      OutCh                    ; ulo‘en¡ k¢du prav‚ z vorky
         jmp       short VyrUn8             ; n vrat

; ------ dek¢dov n¡ operandu

VyrUn4:  call      GetOpn                   ; dek¢dov n¡ operandu
         jc        VyrUn9                   ; chyba - neplatn˜ operand
         call      OutCh                    ; ulo‘en¡ k¢du operandu
         xchg      al,bl                    ; AL <- ni‘¨¡ bajt parametru
         call      OutCh                    ; ulo‘en¡ ni‘¨¡ho bajtu parametru
         cmp       bl,82h                   ; je intern¡ procedura ?
         jne       VyrUn5                   ; nen¡ intern¡ procedura
         cmp       al,24                    ; je funkce ?
         jb        VyrUn8                   ; zak zan  procedura

; ------ nalezen¡ adresy intern¡ procedury

         mov       bx,offset TabKey         ; tabulka slov
VyrUn6:  add       bl,ds:[bx]               ; p©i‡ten¡ d‚lky slova
         adc       bh,0                     ; p©enos do vy¨¨¡ho bajtu
         add       bx,3                     ; p©esko‡en¡ bajtu d‚lky a adresy
         cmp       al,0                     ; procedura nalezena ?
         je        VyrUn62                  ; nalezena
         dec       al                       ; sn¡‘en¡ ‡¡ta‡e procedur
         jmp       short VyrUn6             ; dal¨¡ slovo

; ------ vyvol n¡ obsluhy procedury

VyrUn62: call      word ptr ds:[bx-2]       ; vyvol n¡ obsluhy procedury
         jmp       short VyrUn8

VyrUn5:  mov       al,bh                    ; vy¨¨¡ bajt k ulo‘en¡
         call      OutCh                    ; ulo‘en¡ vy¨¨¡ho bajtu

         cmp       bl,86h
         je        VyrUn7
         cmp       bl,87h
         jne       VyrUn8
VyrUn7:  mov       cx,1
         call      Argum                    ; argument prvku vektoru

VyrUn8:  clc                                ; p©¡znak - operace OK
VyrUn9:  pop       cx
         pop       bx
         ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ operandu (CY=neplatn˜ operand)
; -----------------------------------------------------------------------------
; AL = typ operandu (bit 7 = 1):
;            0h - neplatn˜ operand
;           81h - ‡¡seln  konstanta (v BX hodnota konstanty)
;           82h - intern¡ procedura (v BL ‡¡slo procedury)
;           83h - u‘ivatelsk  procedura (v BX adresa procedury)
;           84h - BYTE bez indexu (v BX adresa promˆnn‚)
;           85h - WORD bez indexu (v BX adresa promˆnn‚)
;           86h - BYTE s indexem (v BX adresa promˆnn‚, n sleduje index)
;           87h - WORD s indexem (v BX adresa promˆnn‚, n sleduje index)
; BX = adresa nebo hodnota operandu
; -----------------------------------------------------------------------------

PUBLIC   GetOpn
GetOpn:

; ------ £schova registr–

         push      si
         push      di
         push      es

; ------ pokus o na‡ten¡ jm‚na promˆnn‚ nebo funkce

         call      ReadIdnt                 ; ‡ten¡ jm‚na operandu
         jc        GetOpn6                  ; nen¡ platn‚ jm‚no

; ------ pokus o nalezen¡ v intern¡ tabulce funkc¡

         call      SrcIdnt                  ; nalezen¡ v intern¡ tabulce
         jc        GetOpn3                  ; nen¡ slovo intern¡ tabulky
         mov       bl,al                    ; ‡¡slo procedury
         mov       al,82h                   ; p©¡znak, ‘e je intern¡ procedura
         cmp       bl,24                    ; m–‘e b˜t jako funkce ?
         jae       GetOpn9                  ; m–‘e b˜t pou‘it - OK

; ------ n vrat slova, proto‘e je neplatn‚

         call      RetIdnt                  ; n vrat jm‚na funkce
         jmp       short GetOpn8            ; n vrat s chybou

; ------ pokus o nalezen¡ slova v u‘ivatelsk‚ tabulce

GetOpn3: mov       al,0                     ; p©¡znak, ‘e jm‚no nen¡ definov no
         call      StorFlg                  ; nalezen¡ jm‚na v tabulce
         jnc       GetOpn8                  ; nen¡ definov no - to je chyba
         test      al,1                     ; je definov no ?
         jz        GetOpn8                  ; slovo nen¡ definov no

; ------ je u‘ivatelsk  procedura

         mov       bx,es:[di+1]             ; adresa procedury nebo promˆnn‚
         test      al,2                     ; je procedura ?
         jz        GetOpn5                  ; nen¡ procedura
         mov       al,83h                   ; p©¡znak u‘ivatelsk‚ procedury
         jmp       short GetOpn9            ; n vrat

; ------ stanoven¡ typu promˆnn‚

GetOpn5: test      al,8                     ; je OBJECT ?
         jnz       GetOpn8                  ; nen¡ povolen  promˆnn 
         shr       al,1
         shr       al,1                     ; p©¡znak WORD z bitu 2 na bit 0
         test      al,4                     ; je index ?
         jz        GetOpn4                  ; nen¡ index
         or        al,2                     ; p©¡znak indexu
GetOpn4: and       al,3                     ; typ
         or        al,84h
         jmp       short GetOpn9

; ------ pokus o interpretaci jako ‡¡slo

GetOpn6: call      Numb                     ; interpretace jako ‡¡slo
         mov       bx,ax                    ; hodnota konstanty
         mov       al,81h                   ; p©¡znak ‡¡seln‚ konstanty
         jnc       GetOpn9                  ; je ‡¡seln˜ operand

; ------ chyba - neplatn˜ operand

GetOpn8: mov       al,0                     ; p©¡znak - neplatn˜ operand
         mov       bx,0
         stc                                ; p©¡znak chyby

; ------ n vrat registr–

GetOpn9: pop       es
         pop       di
         pop       si
         ret

; -----------------------------------------------------------------------------
;        Vstup znaku oper toru (CY=neplatn˜ oper tor)
; -----------------------------------------------------------------------------
; AL = oper tor (bit 7 = 0):
;           0 - neplatn˜ oper tor
;           1 - (
;           2 - )
;           3 - ^
;           4 - *
;           5 - /
;           6 - MOD
;           7 - <<
;           8 - >>
;           9 - +
;          10 - -
;          11 - =
;          12 - <>
;          13 - <
;          14 - >
;          15 - <=
;          16 - >=
;          17 - NOT
;          18 - AND
;          19 - OR
;          20 - XOR
;          (21 - un rn¡ -)
; -----------------------------------------------------------------------------

PUBLIC   GetOper
GetOper:

; ------ £schova registr–

         push      cx
         push      si
         push      di
         push      es

         push      ds
         pop       es
         cld

; ------ na‡ten¡ max. 3 znak– oper toru

         mov       di,offset BufOper        ; buffer oper toru
         mov       cx,3                     ; 3 znaky
         xor       al,al
         stosb                              ; po‡et bajt– zat¡m je 0
         call      InpSpc                   ; vstup s vypu¨tˆn¡m mezer
         jc        GetOper2                 ; nen¡ dal¨¡ znak
         cmp       al,'"'
         je        GetOpr11                 ; jsou uvozovky
GetOper1:stosb                              ; ulo‘en¡ znaku
         inc       byte ptr ds:[BufOper]    ; zv˜¨en¡ ‡¡ta‡e po‡tu znak–
         dec       cx
         jcxz      GetOper2
         call      InpChU                   ; vstup dal¨¡ho znaku
         cmp       al,'"'
         jne       GetOper1
GetOpr11:call      RetCh                    ; n vrat znaku "

; ------ test, zda se provede hled n¡ v tabulce

GetOper2:mov       al,0                     ; p©ednastaven¡ - oper tor nenalezen
         cmp       byte ptr ds:[BufOper],0  ; je je¨tˆ nˆco v bufferu ?
         stc                                ; p©¡znak chyby, ‘e nic nen¡
         je        GetOper6                 ; slovo nenalezeno

; ------ tabulka bude prohled na

         mov       si,offset BufOper        ; buffer s oper torem
         mov       di,offset TabOper        ; tabulka oper tor–

; ------ test, zda je konec tabulky

GetOper3:inc       al                       ; zv˜¨en¡ ukazatele slov v tabulce
         mov       cl,ds:[di]               ; d‚lka oper toru v tabulce
         jcxz      GetOper4                 ; je ji‘ konec tabulky
         inc       cl                       ; porovn  se i d‚lka

; ------ porovn n¡ jedn‚ polo‘ky v tabulce

         cld
         push      si
         push      di
         push      cx
         repe      cmpsb                    ; porovn n¡ s polo‘kou tabulky
         pop       cx
         pop       di
         pop       si
         je        GetOper6                 ; polo‘ka nalezena OK

; ------ nastaven¡ na dal¨¡ polo‘ku tabulky

         add       di,cx                    ; adresa dal¨¡ polo‘ky v tabulce
         jmp       short GetOper3           ; test dal¨¡ polo‘ky tabulky

; ------ n vrat posledn¡ho znaku z bufferu

GetOper4:mov       cl,ds:[si]               ; po‡et znak– v buferu
         dec       byte ptr ds:[si]         ; sn¡‘en¡ po‡tu znak– v bufferu
         add       si,cx                    ; adresa znaku v bufferu
         mov       al,ds:[si]               ; znak v bufferu
         call      RetCh                    ; n vrat znaku do bufferu
         jmp       short GetOper2           ; dal¨¡ porovn n¡ oper toru

; ------ n vrat registr–

GetOper6:pop       es
         pop       di
         pop       si
         pop       cx
         ret

; -----------------------------------------------------------------------------
;        Zji¨tˆn¡, zda n sleduje znak p©i©azen¡ := (CY=nen sleduje)
; -----------------------------------------------------------------------------

PUBLIC   InpPri
InpPri:
         push      ax
         call      InpSpc                   ; vstup prvn¡ho znaku
         jc        InpPri3                  ; nen¡ dal¨¡ znak
         cmp       al,":"                   ; je znak ":" ?
         jne       InpPri2                  ; prvn¡ znak nen¡ ":"
         call      InpCh                    ; dal¨¡ znak
         jc        InpPri1                  ; nen¡ dal¨¡ znak - chyba
         cmp       al,"="                   ; je znak "=" ?
         je        InpPri3                  ; je znak "=" - OK
         call      RetCh                    ; n vrat druh‚ho znaku
InpPri1: mov       al,":"                   ; znak ":"
InpPri2: call      RetCh                    ; n vrat znaku ":"
         stc                                ; p©¡znak chyby - nen¡ ":="
InpPri3: pop       ax
         ret

; -----------------------------------------------------------------------------
;        Test konce p©¡kazu (znak ;)
; -----------------------------------------------------------------------------

PUBLIC   TestKon
TestKon: call      InpSpc
         jc        TestKon1                 ; p©¡kaz nen¡ ukon‡en
         cmp       al,";"
         je        TestKon2
         call      RetCh                    ; n vrat znaku
TestKon1:mov       dx,offset Err01a         ; text - chyb¡ st©edn¡k
         call      DispErr                  ; zobrazen¡ chyby
TestKon2:ret

; -----------------------------------------------------------------------------
;        Test, zda je lev  z vorka "("
; -----------------------------------------------------------------------------

PUBLIC   TestLeft
TestLeft:call      InpSpc                   ; na‡ten¡ dal¨¡ho znaku
         jc        TestLft2                 ; chyba - nen¡ lev  z vorka
         cmp       al,"("                   ; je lev  z vorka ?
         je        TestLft2                 ; je lev  z vorka - OK
         call      RetCh                    ; n vrat znaku
         stc                                ; p©¡znak chyby
TestLft2:ret

; -----------------------------------------------------------------------------
;        Test, zda je oddˆlovac¡ ‡ rka ","
; -----------------------------------------------------------------------------

PUBLIC   TestCar
TestCar: call      InpSpc                   ; na‡ten¡ dal¨¡ho znaku
         jc        TestCar2                 ; chyba - nen¡ ‡ rka
         cmp       al,","                   ; je ‡ rka ?
         je        TestCar2                 ; je ‡ rka - OK
         call      RetCh                    ; n vrat znaku
         stc                                ; p©¡znak chyby
TestCar2:ret

; -----------------------------------------------------------------------------
;        Test, zda je oddˆlovac¡ dvojte‡ka ":"
; -----------------------------------------------------------------------------

PUBLIC   TestDvj
TestDvj: call      InpSpc                   ; na‡ten¡ dal¨¡ho znaku
         jc        TestDvj2                 ; chyba - nen¡ dvojte‡ka
         cmp       al,":"                   ; je dvojte‡ka ?
         je        TestDvj2                 ; je dvojte‡ka - OK
         call      RetCh                    ; n vrat znaku
         stc                                ; p©¡znak chyby
TestDvj2:ret

; -----------------------------------------------------------------------------
;        Test, zda je prav  z vorka ")"
; -----------------------------------------------------------------------------

PUBLIC   TestRght
TestRght:call      InpSpc                   ; na‡ten¡ dal¨¡ho znaku
         jc        TestRgh2                 ; chyba - nen¡ prav  z vorka
         cmp       al,")"                   ; je prav  z vorka ?
         je        TestRgh2                 ; je prav  z vorka - OK
         call      RetCh                    ; n vrat znaku
         stc                                ; p©¡znak chyby
TestRgh2:ret

; -----------------------------------------------------------------------------
;        Test, zda je oddˆlova‡ intervalu
; -----------------------------------------------------------------------------

PUBLIC   TestInt
TestInt: push      ax
         call      InpCh                    ; ‡ten¡ dal¨¡ho znaku
         jc        TestInt3                 ; nen¡ dal¨¡ znak
         cmp       al,"."                   ; je interval ?
         stc                                ; p©¡znak, ‘e nen¡ interval
         jne       TestInt2                 ; nen¡ interval
         call      InpCh                    ; ‡ten¡ dal¨¡ho znaku
         jc        TestInt1                 ; nen¡ dal¨¡ znak
         cmp       al,"."                   ; je interval ?
         je        TestInt3                 ; je interval
         stc                                ; p©¡znak, ‘e nen¡ interval
         call      RetCh                    ; n vrat znaku
TestInt1:mov       al,"."
TestInt2:call      RetCh
TestInt3:pop       ax
         ret

; -----------------------------------------------------------------------------
;        Zji¨tˆn¡ dimenze promˆnn‚ (vrac¡ AX,BX=velikost)
; -----------------------------------------------------------------------------

PUBLIC   CompI
CompI:   mov       bx,1                     ; velikost promˆnn‚ = 1
         call      InpCh                    ; ‡ten¡ dal¨¡ho znaku
         cmc
         jnc       CompI6                   ; nen¡ dal¨¡ znak (to nevad¡)
         cmp       al,"("                   ; jsou parametry ?
         clc
         jne       CompI5                   ; nen¡ dimenze - OK (bude 1)
         call      Numb                     ; ‡ten¡ ‡¡sla
         jc        CompI6                   ; chybn‚ ‡¡slo
         mov       bx,ax                    ; nov  velikost promˆnn‚
         call      InpCh                    ; ‡ten¡ dal¨¡ho znaku
         jc        CompI6                   ; nen¡ dal¨¡ znak
         cmp       al,")"                   ; uzav©en¡ parametru ?
         je        CompI6                   ; v¨e je OK
         stc                                ; p©¡znak chyby syntaxe
CompI5:  call      RetCh                    ; n vrat znaku

CompI6:  jnc       CompI7                   ; v¨e je OK
         mov       dx,offset Err014         ; text - chybn  dimenze
         call      DispErr                  ; zobrazen¡ chyby
CompI7:  mov       ax,bx                    ; velikost promˆnn‚
         ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ ‡¡sla se znam‚nkem
; -----------------------------------------------------------------------------

PUBLIC   NumbS
NumbS:   call      InpSpc                   ; vstup prvn¡ho znaku
         jc        NumbS9
         cmp       al,"+"
         je        NumbS                    ; + se ignoruje
         cmp       al,"-"
         jne       NumbS1                   ; nen¡ ‡¡slo se znam‚nkem

                                          ;* je ‡¡slo s "-"
         call      NumbS
         jc        NumbS2
         neg       ax
         clc
NumbS9:  ret

NumbS2:  mov       al,"-"
         call      RetCh
         ret

NumbS1:  call      RetCh
         call      Numb
         ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ textov‚ho ‡¡sla
; -----------------------------------------------------------------------------

PUBLIC   Numbt
Numbt:   push      bx
         xor       bx,bx
Numbt0:  call      InpCh                    ; vstup prvn¡ho znaku
         jc        Numbt5                   ; chyba - nen¡ ‘ dn˜ znak
         call      RetCh                    ; n vrat znaku
         call      Numbt00                  ; vstup prvn¡ho znaku
         jc        Numbt5                   ; chyba - nen¡ platn˜ znak

; ------ je platn˜ dal¨¡ znak

Numbt1:  cmp       bh,0                     ; bude p©ete‡en¡ ?
         stc
         jne       Numbt5                   ; bylo by p©ete‡en¡
         mov       bh,bl                    ; p©edchoz¡ znak
         mov       bl,al                    ; ulo‘en¡ nov‚ho znaku
         call      Numbt00                  ; vstup dal¨¡ho znaku
         jnc       Numbt1                   ; je dal¨¡ platn˜ znak
         clc                                ; p©¡znak - v¨e OK
Numbt5:  mov       ax,bx
         pop       bx
         ret

; -----------------------------------------------------------------------------
;        Vstup textov‚ho znaku (CY=konec, zru¨¡ koncov‚ uvozovky)
; -----------------------------------------------------------------------------

PUBLIC   Numbt00
Numbt00: call      InpCh                    ; vstup znaku
         jc        Numbt05                  ; nen¡ dal¨¡ znak
         cmp       al,'"'                   ; jsou uvozovky ?
         clc
         jne       Numbt05                  ; nejsou uvozovky - OK
         call      InpCh                    ; vstup dal¨¡ho znaku
         cmp       al,'"'                   ; jsou zdvojen‚ uvozovky ?
         je        Numbt05                  ; zdvojen‚ uvozovky - OK
         call      RetCh                    ; n vrat znaku
         stc                                ; p©¡znak konce textu
Numbt05: ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ ‡¡sla (AX <-)
; -----------------------------------------------------------------------------

PUBLIC   Numb
                                          ;* test, zda je prvn¡ znak ‡¡slice
Numb:
         push      bx
         xor       bx,bx                    ; BX <- 0 st©ada‡ ‡¡sla
         call      InpSpc                   ; vypu¨tˆn¡ mezer z textu
         jc        Numb9                    ; nen¡ dal¨¡ znak - chyba
         cmp       al,"?"                   ; je konstanta 8000h ?
         jne       Numb0                    ; nen¡ konstanta 8000h
         mov       bx,8000h                 ; konstanta 8000h
         jmp       short Numb9              ; n vrat
Numb0:   cmp       al,"$"                   ; je hexadecim ln¡ ‡¡slo ?
         je        Numbh0                   ; vstup hexadecim ln¡ho ‡¡sla
         cmp       al,"%"                   ; je bin rn¡ ‡¡slo ?
         je        Numbb0                   ; vstup bin rn¡ho ‡¡sla
         cmp       al,'"'                   ; je textov‚ ‡¡slo ?
         je        Numbt0                   ; dek¢dov n¡ textov‚ho ‡¡sla

         call      Numb00                   ; test, zda je znak ‡¡slice
         jc        Numb8                    ; nen¡ ‡¡slice

         mov       bl,al                    ; prvn¡ ‡¡slice
Numb1:   call      InpCh                    ; vstup dal¨¡ho znaku
         cmc
         jnc       Numb9                    ; nen¡ dal¨¡ znak
         call      Numb00                   ; test, zda je to ‡¡slice
         cmc
         jnc       Numb8                    ; nen¡ to ‡¡slice
         push      ax
         mov       ax,10
         mul       bx                       ; star‚ ‡¡slo * 10
         pop       bx                       ; nov  ‡¡slice
         or        dx,dx                    ; je p©ete‡en¡ ‡¡sla ?
         stc                                ; p©¡znak p©ete‡en¡ ‡¡sla
         jnz       Numb9                    ; chyba - p©ete‡en¡ ‡¡sla
         mov       bh,0
         add       bx,ax                    ; p©i‡ten¡ ‡¡slice k st©ada‡i
         jc        Numb9                    ; chyba - p©ete‡en¡ ‡¡sla
         jmp       short Numb1              ; vstup dal¨¡ ‡¡slice

Numb8:   call      RetCh                    ; n vrat znaku do bufferu
Numb9:   mov       ax,bx                    ; na‡ten‚ ‡¡slo
         pop       bx
         ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ hexadecim ln¡ho ‡¡sla (AX <-)
; -----------------------------------------------------------------------------

PUBLIC   Numbh
                                          ;* test, zda je prvn¡ znak ‡¡slice
Numbh:   push      bx
         xor       bx,bx                    ; BX <- 0 st©ada‡ ‡¡sla
Numbh0:  call      InpSpc                   ; vypu¨tˆn¡ mezer z textu
         jc        Numbh9                   ; nen¡ dal¨¡ znak - chyba
         call      Numbh00                  ; test, zda je znak ‡¡slice
         jc        Numbh8                   ; nen¡ ‡¡slice

Numbh1:  add       bl,al                    ; p©i‡ten¡ ‡¡slice
         call      InpChU                   ; vstup dal¨¡ho znaku
         cmc
         jnc       Numbh9                   ; nen¡ dal¨¡ znak
         call      Numbh00                  ; test, zda je to ‡¡slice
         cmc
         jnc       Numbh8                   ; nen¡ to ‡¡slice
         shl       bx,1
         jc        Numbh9                   ; p©ete‡en¡ ‡¡sla
         shl       bx,1
         jc        Numbh9                   ; p©ete‡en¡ ‡¡sla
         shl       bx,1
         jc        Numbh9                   ; p©ete‡en¡ ‡¡sla
         shl       bx,1                     ; star‚ ‡¡slo * 16
         jc        Numbh9                   ; p©ete‡en¡ ‡¡sla
         jmp       short Numbh1             ; vstup dal¨¡ ‡¡slice

Numbh8:  call      RetCh                    ; n vrat znaku do bufferu
Numbh9:  mov       ax,bx                    ; na‡ten‚ ‡¡slo
         pop       bx
         ret

; -----------------------------------------------------------------------------
;        Dek¢dov n¡ bin rn¡ho ‡¡sla (AX <-)
; -----------------------------------------------------------------------------

PUBLIC   Numbb
                                          ;* test, zda je prvn¡ znak ‡¡slice
Numbb:   push      bx
         xor       bx,bx                    ; BX <- 0 st©ada‡ ‡¡sla
Numbb0:  call      InpSpc                   ; vypu¨tˆn¡ mezer z textu
         jc        Numbb9                   ; nen¡ dal¨¡ znak - chyba
         call      Numbb00                  ; test, zda je znak ‡¡slice
         jc        Numbb8                   ; nen¡ ‡¡slice

Numbb1:  add       bl,al                    ; p©i‡ten¡ ‡¡slice
         call      InpChU                   ; vstup dal¨¡ho znaku
         cmc
         jnc       Numbb9                   ; nen¡ dal¨¡ znak
         call      Numbb00                  ; test, zda je to ‡¡slice
         cmc
         jnc       Numbb8                   ; nen¡ to ‡¡slice
         shl       bx,1                     ; ‡¡slo * 2
         jc        Numbb9                   ; p©ete‡en¡ ‡¡sla
         jmp       short Numbb1             ; vstup dal¨¡ ‡¡slice

Numbb8:  call      RetCh                    ; n vrat znaku do bufferu
Numbb9:  mov       ax,bx                    ; na‡ten‚ ‡¡slo
         pop       bx
         ret

; -----------------------------------------------------------------------------
;        Test, zda je platn  dekadick  ‡¡slice
; -----------------------------------------------------------------------------

PUBLIC   Numb00

Numb00:  cmp       al,"0"
         jb        Numb01                   ; nen¡ ‡¡slice
         cmp       al,"9"+1
         cmc
         jc        Numb01
         sub       al,"0"
Numb01:  ret

; -----------------------------------------------------------------------------
;        Test, zda je platn  ‡¡slice HEX
; -----------------------------------------------------------------------------

PUBLIC   Numbh00
Numbh00: cmp       al,"0"
         jb        Numbh02                  ; nen¡ ‡¡slice

         cmp       al,"9"
         jbe       Numbh01                  ; je ‡¡slice

         cmp       al,"F"+1
         cmc
         jc        Numbh02                  ; nen¡ ‡¡slice HEX

         cmp       al,"A"
         jb        Numbh02                  ; nen¡ ‡¡slice HEX
         sub       al,7                     ; korekce na ‡¡slici HEX

Numbh01: sub       al,"0"                   ; korekce na bin rn¡ ‡¡slo
Numbh02: ret

; -----------------------------------------------------------------------------
;        Test, zda je platn  ‡¡slice BIN
; -----------------------------------------------------------------------------

PUBLIC   Numbb00
Numbb00: cmp       al,"0"
         jb        Numbb02                  ; nen¡ ‡¡slice

         cmp       al,"2"
         cmc
         jc        Numbb02                  ; je ‡¡slice

         sub       al,"0"                   ; korekce na bin rn¡ ‡¡slo
Numbb02: ret

; -----------------------------------------------------------------------------
;        Ulo‘en¡ identifik toru konstrukce (v z sob. 2 n vrat. adresy)
; -----------------------------------------------------------------------------

PUBLIC   PushKod
PushKod: pop       word ptr ds:[RetPush]
         pop       word ptr ds:[RetComp]

         push      word ptr ds:[ErrARad+2]  ; adresa © dku - vy¨¨¡ slovo
         push      word ptr ds:[ErrARad]    ; adresa © dku - ni‘¨¡ slovo
         push      word ptr ds:[ErrNRad]    ; ‡¡slo © dku
         mov       ah,0                     ; nen¡ ‘ dn  adresa v bufferu
         push      ax                       ; ulo‘en¡ k¢du adresy
         sub       bp,8                     ; nov  adresa ukazatele

         push      word ptr ds:[RetComp]
         jmp       word ptr ds:[RetPush]

; -----------------------------------------------------------------------------
;        Ulo‘en¡ adresy AX do bufferu (v z sob. 2 n vrat. adresy) (ni‡¡ BX)
; -----------------------------------------------------------------------------

PUBLIC   PushAdrX
PushAdrX:mov       ax,ds:[ProgNum]          ; ukazatel

PUBLIC   PushAdr
PushAdr: pop       word ptr ds:[RetPush]
         pop       word ptr ds:[RetComp]

         pop       bx                       ; ‡¡ta‡ a p©¡znak
         push      ax                       ; ulo‘en¡ adresy
         inc       bh                       ; zv˜¨en¡ ‡¡ta‡e
         push      bx                       ; ulo‘en¡ k¢du adresy
         sub       bp,2                     ; nov  adresa ukazatele

         push      word ptr ds:[RetComp]
         jmp       word ptr ds:[RetPush]

; -----------------------------------------------------------------------------
;        Zru¨en¡ identif. konstrukce (v z sob. 2 n vrat. adresy) (ni‡¡ BX, AX)
; -----------------------------------------------------------------------------

PUBLIC   PopKod
PopKod:  pop       word ptr ds:[RetPush]
         pop       word ptr ds:[RetComp]

PopKod1: pop       ax                       ; ‡¡ta‡ a p©¡znaky
         or        ah,ah                    ; je je¨tˆ nˆjak‚ slovo ?
         jz        PopKod3                  ; nen¡ dal¨¡ slovo

         pop       bx                       ; adresa promˆnn‚
         dec       ah                       ; sn¡‘en¡ ‡¡ta‡e
         push      ax                       ; £schova ‡¡ta‡e
         add       bp,2                     ; zv˜¨en¡ ukazatele

         push      es                       ; £schova ES
         mov       es,ds:[ProgSeg]          ; segment s programem
         mov       ax,ds:[ProgNum]          ; ukazatel programu
         mov       es:[bx],ax               ; nastaven¡ po‘adovan‚ adresy
         pop       es                       ; n vrat ES

         jmp       short PopKod1            ; dal¨¡ adresa

PopKod3: pop       ax                       ; ‡¡slo © dku
         pop       ax                       ; adresa © dku - LOW
         pop       ax                       ; adresa © dku - HIGH
         add       bp,8                     ; posledn¡ posun ukazatele

         push      word ptr ds:[RetComp]
         jmp       word ptr ds:[RetPush]

; -----------------------------------------------------------------------------
;        Nastaven¡ jedn‚ adresy (ni‡¡ AX a BX)
; -----------------------------------------------------------------------------

SetAdr:  pop       word ptr ds:[RetPush]
         pop       word ptr ds:[RetComp]

         pop       ax
         or        ah,ah
         jz        SetAdr3                  ; nen¡ ‘ dn‚ slovo

         pop       bx                       ; adresa promˆnn‚
         dec       ah                       ; sn¡‘en¡ ‡¡ta‡e
         add       bp,2                     ; zv˜¨en¡ ukazatele

         push      es                       ; £schova ES
         push      ax
         mov       es,ds:[ProgSeg]          ; segment s programem
         mov       ax,ds:[ProgNum]          ; ukazatel programu
         mov       es:[bx],ax               ; nastaven¡ po‘adovan‚ adresy
         pop       ax
         pop       es                       ; n vrat ES

SetAdr3: push      ax
         push      word ptr ds:[RetComp]
         jmp       word ptr ds:[RetPush]

; -----------------------------------------------------------------------------
;        Vyjmut¡ adresy z bufferu (CY=nen¡) (v z sob. 2 n vrat.adresy) (ni‡¡ BX)
; -----------------------------------------------------------------------------

PUBLIC   PopAdr
PopAdr:  pop       word ptr ds:[RetPush]
         pop       word ptr ds:[RetComp]

         pop       bx                       ; ‡¡ta‡ a p©¡znak
         or        bh,bh                    ; je dal¨¡ slovo ?
         stc                                ; p©¡znak - nen¡ dal¨¡ slovo
         jz        PopAdr2                  ; nen¡ dal¨¡ slovo

         pop       ax                       ; vyjmut¡ adresy
         dec       bh                       ; sn¡‘en¡ ‡¡ta‡e
         add       bp,2                     ; nov  adresa ukazatele
         clc                                ; p©¡znak, ‘e je v¨e OK

PopAdr2: push      bx                       ; n vrat ‡¡ta‡e

         push      word ptr ds:[RetComp]
         jmp       word ptr ds:[RetPush]


; *****************************************************************************
;
;                Obsluha intern¡ch kl¡‡ov˜ch slov
;
; *****************************************************************************

; -----------------------------------------------------------------------------
;        LINK - p©ipojen¡ objektu
; -----------------------------------------------------------------------------

XLink78: jmp       XLink7

PUBLIC   XLInk
XLink:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         mov       byte ptr ds:[ProgLev],3  ; p©¡znak konce programu

; ------ ulo‘en¡ programu na disk

         mov       cx,ds:[ProgNum]          ; po‡et bajt– v bufferu
         cmp       cx,ds:[SizProg]
         jbe       XLink1
         mov       ds:[SizProg],cx          ; £schova velikosti programu
XLink1:  call      WritProg                 ; z pis dat. promˆnn˜ch do souboru
         mov       word ptr ds:[ProgNum],2  ; zru¨en¡ programu

; ------ test, zda je prvn¡ znak z vorka "("

         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XLink78                  ; chyba - nejsou parametry

; ------ definice objektu

         call      DefObj                   ; definice ‡¡sla objektu

; ------ oddˆlovac¡ ‡ rka parametr–

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XLink78                  ; chyba - neplatn˜ znak

; ------ definice jm‚na souboru

         mov       dx,ds:[ProgNum]          ; za‡ tek jm‚na souboru
         call      DefTxt                   ; definice jm‚na
         jc        XLink78                  ; chybn‚ jm‚no souboru

; ------ test, zda je prav  z vorka ")"

         call      TestRght                 ; test, zda je prav  z vorka
         jc        XLink78                  ; chyba - nen¡ prav  z vorka

; ------ otev©en¡ zadan‚ho souboru

         push      ds
         mov       ds,ds:[ProgSeg]          ; segment se jm‚nem souboru
         mov       ax,3d00h                 ; funkce otev©en¡ souboru pro ‡ten¡
         int       21h                      ; otev©en¡ souboru pro ‡ten¡
         pop       ds
XLink3:  mov       dx,offset Err016         ; text - chybn‚ jm‚no souboru
         mov       ds:[LinkId],ax           ; identifik tor souboru
         mov       bx,ax                    ; identifik tor souboru
         mov       ax,4202h                 ; funkce p©esunut¡ na konec
         jc        XLink77                  ; chyba - soubor nenalezen

; ------ zji¨tˆn¡ velikosti linkovan‚ho souboru

         xor       cx,cx                    ; CX <- 0
         xor       dx,dx                    ; DX <- 0
         int       21h                      ; poskytnut¡ velikosti
         jc        XLink3                   ; chyba souboru
         add       ax,15                    ; zaokrouhlen¡ na odstavec
         adc       dx,0                     ; p©enos do vy¨¨¡ho slova

; ------ p©epo‡et velikosti na odstavce

         shr       dx,1
         rcr       ax,1
         shr       dx,1
         rcr       ax,1
         shr       dx,1
         rcr       ax,1
         shr       dx,1
         rcr       ax,1                     ; p©epo‡et na odstavce

; ------ nastaven¡ ukazatele opˆt na za‡ tek souboru

         push      ax
         xor       cx,cx
         xor       dx,dx
         mov       ax,4200h
         int       21h                      ; nastaven¡ na za‡ tek souboru
         pop       ax
         jc        XLink3                   ; chyba souboru

; ------ kopie prvn¡ho bloku souboru

         push      ds
         push      ax                       ; velikost souboru v odstavc¡ch
         mov       bx,ds:[LinkId]           ; zdrojov˜ soubor
         mov       ds,ds:[ProgSeg]          ; datov˜ segment
         push      word ptr ds:[2]          ; £schova ‡¡sla objektu
         xor       dx,dx                    ; ukl dac¡ adresa - offset
         mov       cx,0e000h                ; maxim ln¡ velikost bloku
         mov       ah,3fh                   ; funkce ‡ten¡ ze souboru
         int       21h                      ; ‡ten¡ bloku ze souboru
         mov       cx,ax                    ; po‡et na‡ten˜ch bajt–
         pop       word ptr ds:[0]          ; n vrat ‡¡sla objektu
         pop       word ptr ds:[2]          ; nastaven¡ velikosti souboru
         pop       ds
         jc        XLink3                   ; chyba ‡ten¡
         call      WritProg                 ; ulo‘en¡ prvn¡ho bloku souboru

; ------ kopie dal¨¡ch blok– souboru

XLink4:  push      ds
         mov       bx,ds:[LinkId]           ; zdrojov˜ soubor
         mov       ds,ds:[ProgSeg]          ; datov˜ segment
         xor       dx,dx                    ; ukl dac¡ adresa - offset
         mov       cx,0e000h                ; maxim ln¡ velikost bloku
         mov       ah,3fh                   ; funkce ‡ten¡ ze souboru
         int       21h                      ; ‡ten¡ bloku ze souboru
         mov       cx,ax                    ; po‡et na‡ten˜ch bajt–
         pop       ds
         jc        XLink3                   ; chyba ‡ten¡
         call      WritProg                 ; ulo‘en¡ bloku souboru
         jcxz      XLink83                  ; konec souboru
         jmp       short XLink4             ; kopie dal¨¡ho bloku

XLink83: mov       ah,3eh
         mov       bx,ds:[LinkId]           ; zdrojov˜ soubor
         int       21h                      ; uzav©en¡ v˜stupn¡ho souboru
         jmp       short XLink8

; ------ chyba syntaxe p©¡kazu LINK

XLink7:  mov       dx,offset Err015         ; text - chyba syntaxe
XLink77: call      DispErr                  ; zobrazen¡ textu chyby

; ------ n vrat z obsluhy

XLink8:  mov       word ptr ds:[ProgNum],0  ; zru¨en¡ na‡ten‚ho textu
         call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        Definice odkazu na objekt
; -----------------------------------------------------------------------------

PUBLIC   DefObj
DefObj:  call      ReadIdnt                 ; ‡ten¡ jm‚na objektu
         jc        DefObj4                  ; chyba - neplatn‚ jm‚no
         mov       al,0dh                   ; identifik tor objektu
         call      StorFlg                  ; ulo‘en¡ identifik toru
         mov       dx,offset Err009         ; chyba - v¡cen sobn‚ pou‘it¡ jm‚na
         cmp       al,0dh                   ; je identifik tor objektu ?
         jne       DefObj5                  ; nen¡ objekt - chyba
         mov       ax,di                    ; adresa objektu v tabulce
         inc       ax                       ; bude ‡¡slo 1 a v˜¨e
         call      OutWrd                   ; ulo‘en¡ ‡¡sla objektu
         clc                                ; p©¡znak operace OK
         ret

DefObj4: mov       dx,offset Err012         ; text - neplatn‚ jm‚no objektu
DefObj5: call      DispErr                  ; zobrazen¡ textu chyby
         stc                                ; p©¡znak chyby
DefObj6: ret

; -----------------------------------------------------------------------------
;        Definice textu v uvozovk ch jako ASCIIZ (CY=nen¡ text v uvozovk ch)
; -----------------------------------------------------------------------------

PUBLIC   DefTxt
DefTxt:

; ------ test, zda je platn˜ za‡ tek textu

         call      InpSpc                   ; vypustˆn¡ mezer z textu
         jc        DefTxt6                  ; chyba - nen¡ dal¨¡ znak
         cmp       al,'"'                   ; jsou uvozovky ?
         stc
         jne       DefTxt5                  ; nejsou uvozovky - neplatn˜ text

; ------ na‡ten¡ znaku textu

DefTxt1: call      InpCh                    ; vstup dal¨¡ho znaku
         jc        DefTxt4                  ; nen¡ dal¨¡ znak
         cmp       al,'"'                   ; jsou uvozovky ?
         je        DefTxt3                  ; je znak uvozovek
DefTxt2: call      OutCh                    ; ulo‘en¡ znaku
         jmp       short DefTxt1            ; dal¨¡ znak textu

; ------ test, zda je platn˜ znak uvozovek

DefTxt3: call      InpCh                    ; ‡ten¡ dal¨¡ho znaku
         jc        DefTxt4                  ; nen¡ dal¨¡ znak
         cmp       al,'"'                   ; jsou uvozovky ?
         je        DefTxt2                  ; jsou zdvojen‚ uvozovky
         clc                                ; p©¡znak - konec textu OK

; ------ ozna‡en¡ konce textu ASCIIZ

DefTxt4: push      ax
         mov       al,0
         call      OutCh                    ; ulo‘en¡ ukon‡ovac¡ho bajtu 0
         pop       ax
         clc
DefTxt5: call      RetCh                    ; n vrat posledn¡ho znaku
DefTxt6: ret

; -----------------------------------------------------------------------------
;        INCLUDE - vno©en¡ textov‚ho souboru
; -----------------------------------------------------------------------------

PUBLIC   XInclud
XInclud:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu

         call      TestKon                  ; test, zda je konec

         ret

; -----------------------------------------------------------------------------
;        EXEC - proveden¡ p©¡kazu DOS
; -----------------------------------------------------------------------------

PUBLIC   XExec
XExec:  ; call      DefTxt
        ; jnc       XExec3                   ; zad n¡ p©¡kazu OK
        ;
        ; mov       dx,offset Err017         ; text - chyb¡ p©¡kaz
        ; call      DispErr                  ; zobrazen¡ chyby

XExec3:
         ret

; -----------------------------------------------------------------------------
;        IF - podm¡nka
; -----------------------------------------------------------------------------

PUBLIC   XIf
XIf:
         mov       al,20h                   ; identifik tor IF
         call      PushKod                  ; ulo‘en¡ identifik toru do z sob.

; ------ ulo‘en¡ v˜razu jako podm¡nka funkce

         call      Vyraz                    ; ulo‘en¡ v˜razu (podm¡nka)
         jnc       XIf5
         call      DispErr
XIf5:

; ------ kontrola, zda n sleduje THEN

         call      ReadIdnt                 ; na‡ten¡ identifik toru THEN
         jc        XIf2                     ; chyba - neplatn‚ jm‚no
         call      SrcIdnt                  ; nalezen¡ identifik toru v tabulce
         jc        XIf4                     ; neplatn‚ jm‚no
         cmp       al,10                    ; je jm‚no THEN ?
         je        XIf3                     ; je jm‚no THEN - OK

; ------ chyba - nen sleduje THEN

XIf4:    call      RetIdnt                  ; n vrat n vˆ¨t¡ do bufferu
XIf2:    mov       dx,offset Err021         ; text - mus¡ n sledovat THEN
         call      DispErr                  ; zobrazen¡ textu chyby

; ------ ulo‘en¡ adresy pro vˆtven¡ IF (podm¡nka nesplnˆna)

XIf3:    call      PushAdrX                 ; ulo‘en¡ adresy ukazatele
         call      OutWrd                   ; rezerva pro ulo‘en¡ adresy
         ret

; -----------------------------------------------------------------------------
;        THEN - za‡ tek p©¡kaz– v podm¡nce IF (nelze v¡cen sobnˆ)
; -----------------------------------------------------------------------------

PUBLIC   XThen
XThen:   mov       dx,offset Err023         ; text - THEN mus¡ b˜t za IF
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; -----------------------------------------------------------------------------
;        ELSE - za‡ tek p©¡kaz– (podm¡nka IF nesplnˆna)
; -----------------------------------------------------------------------------

PUBLIC   XElse
XElse:   mov       dx,offset Err022         ; text - ELSE bez podm¡nky IF
         cmp       al,20h                   ; je otev©en‚ IF ?
         jne       XElse5                   ; zobrazen¡ textu chyby
         mov       dx,offset Err025         ; text - ELSE nesm¡ b˜t v¡ckr t
         cmp       al,21h                   ; bylo ji‘ ELSE ?
         je        XElse5                   ; zobrazen¡ textu chyby

; ------ ELSE je povoleno

         mov       byte ptr ss:[bp],21h     ; p©¡znak ELSE
         call      PopAdr                   ; vyjmut¡ adresy za IF
         mov       si,ax                    ; adresa v programu
         call      PushAdrX                 ; adresa pro nastaven¡ odkazu
         add       ax,2                     ; m¡sto pro n vratovou adresu
         push      ds
         mov       ds,ds:[ProgSeg]          ; segment s programem
         mov       ds:[si],ax               ; ozna‡en¡ adresy za ELSE
         pop       ds
         call      OutWrd                   ; rezerva m¡sta pro adresu
         ret

XElse5:  call      DispErr                  ; zobrazen¡ chyby
         ret

; -----------------------------------------------------------------------------
;        ENDIF - konec podm¡nky IF
; -----------------------------------------------------------------------------

PUBLIC   XEndif
XEndif:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         cmp       al,20h                   ; je IF ?
         je        XEndif1                  ; je IF-THEN
         cmp       al,21h                   ; je IF-THEN-ELSE ?
         jne       XEndif2                  ; nen¡ IF

; ------ je otev©en‚ IF - uklizen¡

XEndif1: call      PopKod                   ; zru¨en¡ k¢du ze z sobn¡ku
         call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; ------ chyba - nen¡ otev©en‚ IF

XEndif2: mov       dx,offset Err022         ; text - nebyla podm¡nka IF
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; -----------------------------------------------------------------------------
;        FOR - cyklus s parametrem
; -----------------------------------------------------------------------------

PUBLIC   XFor
XFor:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         ret


; -----------------------------------------------------------------------------
;        TO - koncov  hodnota cyklu s parametrem
; -----------------------------------------------------------------------------

PUBLIC   XTo
XTo:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         ret

; -----------------------------------------------------------------------------
;        STEP - krok cyklu s parametrem
; -----------------------------------------------------------------------------

PUBLIC   XStep
XStep:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         ret

; -----------------------------------------------------------------------------
;        DO - cyklus
; -----------------------------------------------------------------------------

PUBLIC   XDo
XDo:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         mov       al,30h                   ; identifik tor DO
         call      PushKod                  ; ulo‘en¡ identifik toru do z sob.

         call      PushAdrX                 ; ulo‘en¡ adresy za‡ tku cyklu
         ret

; -----------------------------------------------------------------------------
;        ON - podm¡nka cyklu
; -----------------------------------------------------------------------------

PUBLIC   XOn
XOn:     cmp       al,30h                   ; je otev©en cyklus DO ?
         je        XOn2                     ; je otev©en cyklus FOR/DO

XOn1:    mov       dx,offset Err031         ; text - WHILE bez DO
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ ulo‘en¡ v˜razu jako podm¡nka funkce

XOn2:    call      Vyraz                    ; ulo‘en¡ v˜razu (podm¡nka)
         jnc       XOn6
         call      DispErr
XOn6:

; ------ ulo‘en¡ adresy pro p©¡pad nesplnˆn¡ podm¡nky

         call      PopAdr                   ; adresa za‡ tku cyklu DO
         mov       cx,ax                    ; adresa za‡ tku cyklu
         call      PushAdrX                 ; ulo‘en¡ adresy
         call      OutWrd                   ; rezerva pro ulo‘en¡ adresy
         mov       ax,cx                    ; adresa za‡ tku cyklu
         call      PushAdr                  ; adresa za‡ tku cyklu do z sobn¡ku

; ------ kontrola, zda n sleduje EXIT

         call      ReadIdnt                 ; na‡ten¡ identifik toru EXIT
         jc        XOn3                     ; chyba - neplatn‚ jm‚no
         call      SrcIdnt                  ; nalezen¡ identifik toru v tabulce
         jc        XOn5                     ; neplatn‚ jm‚no
         cmp       al,19                    ; je jm‚no EXIT ?
         je        XOn4                     ; je jm‚no EXIT - OK

; ------ chyba - nen sleduje EXIT

XOn5:    call      RetIdnt                  ; n vrat n vˆ¨t¡ do bufferu

XOn3:    mov       dx,offset Err032         ; text - mus¡ n sledovat EXIT
         call      DispErr                  ; zobrazen¡ textu chyby

XOn4:
         ret

; -----------------------------------------------------------------------------
;        ENDDO - konec cyklu
; -----------------------------------------------------------------------------

PUBLIC   XEnddo
XEnddo:  cmp       al,30h                   ; je otev©en cyklus DO ?
         jne       XOn1                     ; chyba - nen¡ otev©en cyklus

         call      PopAdr                   ; adresa za‡ tku cyklu
         call      OutWrd                   ; nastaven¡ adresy za‡ tku cyklu

         call      PopKod                   ; zru¨en¡ k¢du ze z sobn¡ku
         call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        EXIT - ukon‡en¡ cyklu
; -----------------------------------------------------------------------------

PUBLIC   XExit
XExit:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         mov       dx,offset Err033         ; text - EXIT sm¡ b˜t jen za ON
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; -----------------------------------------------------------------------------
;        CASE - v¡cen sobn‚ vˆtven¡
; -----------------------------------------------------------------------------

PUBLIC   XCase
XCase:
         mov       al,40h
         call      PushKod

; ------ ulo‘en¡ v˜razu jako podm¡nka funkce

         call      Vyraz                    ; ulo‘en¡ v˜razu (podm¡nka)
         jnc       XCase4
         call      DispErr

XCase4:

; ------ kontrola, zda n sleduje IN

         call      ReadIdnt                 ; na‡ten¡ identifik toru IN
         jc        XCase2                   ; chyba - neplatn‚ jm‚no
         call      SrcIdnt                  ; nalezen¡ identifik toru v tabulce
         jc        XCase2                   ; neplatn‚ jm‚no
         cmp       al,21                    ; je jm‚no IN ?
         je        XCase3                   ; je jm‚no IN - OK

; ------ chyba - nen sleduje IN

XCase2:  mov       dx,offset Err046         ; text - mus¡ n sledovat IN
         call      DispErr                  ; zobrazen¡ textu chyby

; ------ ulo‘en¡ adresy pro vˆtven¡ IN (podm¡nka nesplnˆna)

XCase3:  call      OutCh                    ; ulo‘en¡ k¢du IN
         jmp       short XIn1               ; zpracov n¡ IN

; -----------------------------------------------------------------------------
;        IN - podm¡nka v¡cen sobn‚ho vˆtven¡
; -----------------------------------------------------------------------------

PUBLIC   XIn
XIn:     cmp       al,41h                   ; bylo ji‘ OUT ?
         jne       XIn01                    ; nebylo OUT - OK

; ------ chyba - IN je neopr vnˆnˆ

         mov       dx,offset Err043         ; text - nesm¡ b˜t IN po OUT
XIn00:   call      DispErr                  ; zobrazen¡ textu chyby
         ret


XIn01:   cmp       al,40h                   ; je CASE-IN ?
         mov       dx,offset Err041         ; text - IN bez CASE
         jne       XIn00                    ; nebylo CASE-IN - chyba

; ------ nastaven¡ adresy pokra‡ov n¡ ©etˆzce IN

XIn1:    call      OutRet                   ; zru¨en¡ bajtu z bufferu
         call      SetAdr                   ; nastaven¡ adresy
         call      OutInc                   ; zv˜¨en¡ ukazatele

; ------ zji¨tˆn¡ intervalu hodnot promˆnn‚

XIn11:   call      NumbS                    ; ‡ten¡ ‡¡sla spodn¡ho okraje
         jc        XIn2                     ; chybn  mez
         call      OutWrd                   ; ulo‘en¡ spodn¡ meze
         call      OutWrd                   ; p©ednastaven¡ jako horn¡ mez
         call      TestInt                  ; test, zda je oddˆlova‡ intervalu
         jc        XIn5                     ; nen¡ interval
         call      NumbS                    ; ‡ten¡ ‡¡sla horn¡ho okraje
         jc        XIn2                     ; chyba - chybn‚ ‡¡slo
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         call      OutWrd                   ; nastaven¡ horn¡ meze
         jmp       short XIn5               ; v¨e je OK

; ------ chybn‚ zad n¡ intervalu

XIn2:    mov       dx,offset Err047         ; text - chybn‚ meze
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ rezervace adresy pro pokra‡ov n¡ ©etˆzce IN

XIn5:    call      PushAdrX                 ; £schova adresy
         call      OutWrd                   ; rezerva m¡sta pro adresu

; ------ test, zda n sleduje dvoute‡ka ":"

         call      TestDvj
         jc        XIn2                     ; nen¡ dvojte‡ka - chyba
         ret

; -----------------------------------------------------------------------------
;        OUT - nesplnˆna podm¡nka CASE
; -----------------------------------------------------------------------------

PUBLIC   XOut
XOut:

; ------ test opr vnˆnosti funkce

         mov       dx,offset Err044         ; text - bylo ji‘ OUT
         cmp       al,41h                   ; bylo ji‘ OUT ?
         je        XOut1                    ; bylo ji‘ OUT
         mov       dx,offset Err041         ; text - OUT bez CASE
         cmp       al,40h                   ; bylo CASE-IN ?
         je        XOut2                    ; bylo CASE-IN
XOUt1:   call      DispErr                  ; zobrazen¡ chyby
         ret

; ------ nastaven¡ adresy pokra‡ov n¡

XOut2:
         call      OutRet                   ; zru¨en¡ bajtu z bufferu
         call      SetAdr
         call      OutInc                   ; zv˜¨en¡ ukazatele

; ------ rezervace adresy pro pokra‡ov n¡ ©etˆzce IN

         call      PushAdrX                 ; £schova adresy
         call      OutWrd                   ; rezerva m¡sta pro adresu

         mov       byte ptr ss:[bp],41h     ; p©¡znak OUT
         ret

; -----------------------------------------------------------------------------
;        ENDCASE - konec vˆtven¡
; -----------------------------------------------------------------------------

PUBLIC   XEndCAse
XEndCase:mov       dx,offset Err045         ; text - ENDCASE bez CASE
         cmp       al,40h                   ; je CASE ?
         je        XEndCas1                 ; bylo CASE
         cmp       al,41h
         jne       XEndCas2                 ; nebylo CASE
XEndCas1:call      PopKod                   ; zru¨en¡ k¢du ze z sobn¡ku
         ret

XEndCas2:call      DispErr
         call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        PROC - definice procedury
; -----------------------------------------------------------------------------

PUBLIC   XProc
XProc:   call      OutRet                   ; zru¨en¡ bajtu z bufferu

; ------ test uzav©en¡ procedur a funkc¡

         pop       word ptr ds:[RetProc]
XProc1:  call      ClosIf                   ; uzav©en¡ podm¡nek a cykl–
         call      ClosProc                 ; uzav©en¡ procedur
         cmp       word ptr ss:[bp],0       ; je ji‘ konec ?
         jne       XProc1                   ; nen¡ konec - dal¨¡
         push      word ptr ds:[RetProc]    ; n vrat n vratov‚ adresy

; ------ z pis datov‚ho bufferu na disk, inicializace programov‚ho bufferu

         cmp       byte ptr ds:[ProgLev],0  ; byla deklara‡n¡ ‡ st ?
         jne       XProc2                   ; nebyla deklara‡n¡ ‡ st
         mov       cx,ds:[ProgNum]          ; po‡et bajt– bloku
         cmp       cx,ds:[SizDat]
         jbe       XProc12
         mov       ds:[SizDat],cx           ; £schova velikosti programu
XProc12: call      WritProg                 ; z pis datov‚ho bloku na disk
         mov       word ptr ds:[ProgNum],4  ; zru¨en¡ dat v bufferu
         push      ds
         mov       ds,ds:[ProgSeg]          ; segment s programem
         mov       word ptr ds:[0],4        ; d‚lka bloku
         mov       word ptr ds:[2],0        ; startovac¡ adresa nedefinov na
         pop       ds

; ------ definice nov‚ho jm‚na procedury

XProc2:  call      ReadIdnt                 ; ‡ten¡ jm‚na procedury
         jc        XProc4                   ; chyba - neplatn‚ jm‚no

; ------ test, zda je procedura MAIN

         cmp       byte ptr ds:[DelIdent],4 ; d‚lka n vˆ¨t¡ = 4 ?
         jne       XProc3                   ; nen¡ procedura MAIN
         cmp       word ptr ds:[BufIdent],"AM" ; je MAIN ?
         jne       XProc3                   ; nen¡ MAIN
         cmp       word ptr ds:[BufIdent+2],"NI" ; je MAIN ?
         jne       XProc3                   ; nen¡ MAIN
         inc       byte ptr ds:[ParMain]    ; p©¡znak, ‘e byla procedura MAIN
         push      ds
         mov       ax,ds:[ProgNum]          ; ukazatel programu
         mov       ds,ds:[ProgSeg]          ; segment s programem
         mov       ds:[2],ax                ; startovac¡ adresa programu
         pop       ds

; ------ test, zda je rezervovan‚ jm‚no procedury

XProc3:  call      SrcIdnt                  ; nalezen¡ v intern¡ tabulce
         mov       dx,offset Err013         ; text, ‘e jm‚no je rezervov no
         jnc       XProc5                   ; slovo nalezeno - chyba

; ------ za©azen¡ jm‚na do tabulky

         mov       al,3                     ; p©¡znak definovan‚ procedury
         call      StorFlg                  ; ulo‘en¡ identifik toru
         mov       dx,offset Err009         ; chyba - v¡cen sobn‚ pou‘it¡ jm‚na
         jc        XProc5                   ; chyba - jm‚no ji‘ existuje
         mov       ax,ds:[ProgNum]          ; adresa procedury
         mov       es:[di+1],ax             ; £schova adresy procedury
         jmp       short XProc6

; ------ chybn‚ zad n¡ jm‚na procedury

XProc4:  mov       dx,offset Err018         ; text - neplatn‚ jm‚no procedury
XProc5:  call      DispErr                  ; zobrazen¡ textu chyby

; ------ inicializace identifik toru v z sobn¡ku

XProc6:  mov       al,10h
         call      PushKod
         mov       byte ptr ds:[ProgLev],2  ; p©¡znak otev©en¡ procedury
         ret

; -----------------------------------------------------------------------------
;        RETURN - n vrat z procedury
; -----------------------------------------------------------------------------

PUBLIC   XRet
XRet:
         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XRet1                    ; nen¡ lev  z vorka
         call      Vyraz                    ; dek¢dov n¡ v˜razu
         jc        XRet2                    ; chybn˜ v˜raz
         call      TestRght                 ; test, zda je prav  z vorka
         jnc       XRet3                    ; je prav  z vorka OK

XRet1:   mov       dx,offset Err01b         ; text - chybn˜ argument
XRet2:   call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ rezervace adresy pro konec

XRet3:   call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        ENDP - konec definice procedury
; -----------------------------------------------------------------------------

PUBLIC   XEndp
XEndp:

; ------ test uzav©en¡ procedur a funkc¡

         pop       word ptr ds:[RetProc]
         call      ClosIf                   ; uzav©en¡ v¨ech konstrukc¡
         push      word ptr ds:[RetProc]    ; n vrat n vratov‚ adresy

; ------ test, zda je otev©ena procedura

XEndp4:  cmp       byte ptr ss:[bp],10h     ; je otev©ena procedura ?
         je        XEndp5                   ; je otev©ena procedura

         mov       dx,offset Err011         ; text - nen¡ ‘ dn  procedura
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

XEndp5:  call      OutRet                   ; n vrat ukazatele
         call      PopKod                   ; zru¨en¡ k¢du ze z sobn¡ku
         call      OutInc                   ; posun ukazatele
         mov       byte ptr ds:[ProgLev],1  ; p©¡znak uzav©en¡ procedury
         call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        BYTE - definice bajtov‚ promˆnn‚
; -----------------------------------------------------------------------------

PUBLIC   XBYte
XByte:

; ------ test, zda je povolen‚ jm‚no

XByte1:  call      ReadIdnt                 ; ‡ten¡ jm‚na promˆnn‚
         mov       dx,offset Err001         ; text - neplatn‚ jm‚no
         jc        XByte6                   ; chybn‚ jm‚no
         call      SrcIdnt                  ; nalezen¡ v intern¡ tabulce
         mov       dx,offset Err013         ; text - jm‚no rezervov no
         jnc       XByte6                   ; jm‚no je rezervov no

; ------ zji¨tˆn¡ rozmˆr– promˆnn‚

         call      CompI                    ; zji¨tˆn¡ rozmˆr– promˆnn‚
         mov       cx,bx                    ; po‡et bajt– promˆnn‚
         mov       al,1                     ; p©¡znak - definovan˜ bajt
         cmp       cx,1                     ; je 1 bajt ?
         je        XByte2                   ; je 1 bajt
         mov       al,11h                   ; p©¡znak indexovan‚ promˆnn‚

;------- definice jm‚na promˆnn‚

XByte2:  call      StorFlg                  ; ulo‘en¡ jm‚na promˆnn‚
         mov       dx,offset Err009         ; chyba - v¡cen sobn‚ pou‘it¡
         jc        XByte6                   ; promˆnn  byla ji‘ definov na

; ------ zji¨tˆn¡, zda je promˆnn  ur‡en 

         call      InpPri                   ; test, zda je promˆnn  ur‡en 
         jc        XByte7                   ; promˆnn  nen¡ ur‡en 

; ------ vstup jednotliv˜ch defini‡n¡ch bajt–

         call      TestLeft                 ; test, zda je lev  z vorka
         jnc       XByte3                   ; je lev  z vorka
         mov       dx,offset Err004         ; text - chybn‚ naplnˆn¡ promˆnn‚
         cmp       bx,1                     ; je 1 prvek ?
         jne       XByte6                   ; chybn˜ z pis - je v¡ce prvk–

XByte3:  mov       dx,offset Err01c         ; text - p©¡li¨ mnoho £daj–
         jcxz      XByte6                   ; jsou v¨echny hodnoty - p©eplnˆn¡
         call      InpSpc                   ; vstup prvn¡ho znaku
         jc        XByte7                   ; nen¡ dal¨¡ znak
         cmp       al,'"'                   ; je text ?
         jne       XByte4                   ; nen¡ text

; ------ vstup textu

XByte32: call      InpCh                    ; vstup dal¨¡ho bajtu
         jc        XByte5                   ; nen¡ dal¨¡ znak
         cmp       al,'"'                   ; jsou uvozovky ?
         je        XByte35                  ; jsou uvozovky
XByte33: jcxz      XByte3                   ; chyba - mnoho argument–
         call      OutCh                    ; ulo‘en¡ dal¨¡ho bajtu
         dec       cx
         jmp       short XByte32            ; dal¨¡ znak

XByte35: call      InpCh
         jc        XByte5                   ; nen¡ dal¨¡ znak
         cmp       al,'"'                   ; jsou zdvojen‚ uvozovky ?
         je        XByte33                  ; je platn˜ znak
         call      RetCh                    ; n vrat znaku
         jmp       short XByte5             ; dal¨¡ argument

; ------ vstup ‡¡seln‚ promˆnn‚

XByte4:  call      RetCh                    ; n vrat znaku
         call      NumbS                    ; vstup ‡¡sla se znam‚nkem
         mov       dx,offset Err01b         ; text - chybn˜ argument
         jc        XByte6                   ; chyba
         call      OutCh                    ; z pis bajtu
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e bajt–

; ------ test, zda je dal¨¡ hodnota

XByte5:  call      TestRght                 ; je konec ?
         jnc       XByte7                   ; je konec argumentu - OK
         cmp       bx,1                     ; m  b˜t jen jeden argument ?
         je        XByte7                   ; m  b˜t jen jeden argument - konec
         call      TestCar                  ; test, zda je ‡ rka
         jnc       XByte3                   ; vstup dal¨¡ho bajtu
         mov       dx,offset Err01b         ; text - chybn˜ argument

; ------ hl ¨en¡ chyby a nalezen¡ konce p©¡kazu

XByte6:  call      DispErr                  ; zobrazen¡ textu chyby
Xbyte62: call      InpSpc
         jc        XByte63                  ; nen¡ dal¨¡ znak
         cmp       al,";"                   ; je konec p©¡kazu ?
         jne       XByte62                  ; nalezen¡ konce p©¡kazu
XByte63: ret

; ------ vymaz n¡ zbytku promˆnn‚

XByte7:  jcxz      XByte72                  ; nen¡ dal¨¡ bajt
         xor       al,al                    ; inicializa‡n¡ bajt 0
         call      OutCh                    ; z pis bajtu
         loop      XByte7                   ; dal¨¡ bajt

; ------ test, zda je dal¨¡ promˆnn 

XByte72: call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XByte8
         jmp       XByte1                   ; definice dal¨¡ promˆnn‚

XByte8:  call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        WORD - definice slovn¡ promˆnn‚
; -----------------------------------------------------------------------------

PUBLIC   XWord
XWord:
; ------ test, zda je povolen‚ jm‚no

XWord1:  call      ReadIdnt                 ; ‡ten¡ jm‚na promˆnn‚
         mov       dx,offset Err001         ; text - neplatn‚ jm‚no
         jc        XWord6                   ; chybn‚ jm‚no
         call      SrcIdnt                  ; nalezen¡ v intern¡ tabulce
         mov       dx,offset Err013         ; text - jm‚no rezervov no
         jnc       XWord6                   ; jm‚no je rezervov no

; ------ zji¨tˆn¡ rozmˆr– promˆnn‚

         call      CompI                    ; zji¨tˆn¡ rozmˆr– promˆnn‚
         mov       cx,bx                    ; po‡et slov promˆnn‚
         mov       al,5                     ; p©¡znak - definovan‚ slovo
         cmp       cx,1                     ; je 1 slovo ?
         je        XWord2                   ; je 1 slovo
         mov       al,15h                   ; p©¡znak indexovan‚ promˆnn‚

;------- definice jm‚na promˆnn‚

XWord2:  call      StorFlg                  ; ulo‘en¡ jm‚na promˆnn‚
         mov       dx,offset Err009         ; chyba - v¡cen sobn‚ pou‘it¡
         jc        XWord6                   ; promˆnn  byla ji‘ definov na

; ------ zji¨tˆn¡, zda je promˆnn  ur‡en 

         call      InpPri                   ; test, zda je promˆnn  ur‡en 
         jc        XWord7                   ; promˆnn  nen¡ ur‡en 

; ------ vstup jednotliv˜ch defini‡n¡ch slovo–

         call      TestLeft                 ; test, zda je lev  z vorka
         jnc       XWord3                   ; je lev  z vorka
         mov       dx,offset Err004         ; text - chybn‚ naplnˆn¡ promˆnn‚
         cmp       bx,1                     ; je 1 prvek ?
         jne       XWord6                   ; chybn˜ z pis - je v¡ce prvk–

XWord3:  mov       dx,offset Err01c         ; text - p©¡li¨ mnoho £daj–
         jcxz      XWord6                   ; jsou v¨echny hodnoty - p©eplnˆn¡

; ------ vstup ‡¡seln‚ promˆnn‚

XWord4:  call      NumbS                    ; vstup ‡¡sla se znam‚nkem
         mov       dx,offset Err01b         ; text - chybn˜ argument
         jc        XWord6                   ; chyba
         call      OutWrd                   ; z pis slova
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e slov

; ------ test, zda je dal¨¡ hodnota

XWord5:  call      TestRght                 ; je konec ?
         jnc       XWord7                   ; je konec
         cmp       bx,1                     ; m  b˜t jen jeden argument ?
         je        XWord7                   ; m  b˜t jen jeden argument - konec
         call      TestCar                  ; test, zda je ‡ rka
         jnc       XWord3                   ; vstup dal¨¡ho slovou
         mov       dx,offset Err01b         ; text - chybn˜ argument

; ------ hl ¨en¡ chyby a nalezen¡ konce p©¡kazu

XWord6:  call      DispErr                  ; zobrazen¡ textu chyby
XWord62: call      InpSpc
         jc        XWord63                  ; nen¡ dal¨¡ znak
         cmp       al,";"                   ; je konec p©¡kazu ?
         jne       XWord62                  ; nalezen¡ konce p©¡kazu
XWord63: ret

; ------ vymaz n¡ zbytku promˆnn‚

XWord7:  jcxz      XWord72                  ; nen¡ dal¨¡ slovo
         xor       ax,ax                    ; inicializa‡n¡ slovo 0
         call      OutWrd                   ; z pis slova
         loop      XWord7                   ; dal¨¡ slovo

; ------ test, zda je dal¨¡ promˆnn 

XWord72: call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jnc       XWord1                   ; definice dal¨¡ promˆnn‚

XWord8:  call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        STRING - definice textov‚ promˆnn‚
; -----------------------------------------------------------------------------

PUBLIC   XString
XString:
         call      TestKon                  ; test, zda je konec p©¡kazu
         ret

; -----------------------------------------------------------------------------
;        VAL - konverze ©etˆzce na ‡¡slo
; -----------------------------------------------------------------------------

PUBLIC   XVal
XVal:
         ret

; -----------------------------------------------------------------------------
;        STR - konverze ‡¡sla na ©etˆzec
; -----------------------------------------------------------------------------

PUBLIC   XStr
XStr:
         ret

; -----------------------------------------------------------------------------
;        LEN - d‚lka ©etˆzce
; -----------------------------------------------------------------------------

PUBLIC   XLen
XLen:
         ret

; -----------------------------------------------------------------------------
;        CARD - test grafick‚ karty
; -----------------------------------------------------------------------------

PUBLIC   XCard
XCard:
         ret

; -----------------------------------------------------------------------------
;        VIDEO - nastaven¡ videom¢du
; -----------------------------------------------------------------------------

PUBLIC   XVideo
XVideo:
         mov       cx,1                     ; 1 argument
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        GETVIDEO - zji¨tˆn¡ videom¢du
; -----------------------------------------------------------------------------

PUBLIC   XGVideo
XGVideo:
         ret

; -----------------------------------------------------------------------------
;        MODE - nastaven¡ m¢du displeje
; -----------------------------------------------------------------------------

PUBLIC   XMode
XMode:
         mov       cx,1                     ; 1 argument
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        PAGE - nastaven¡ str nek displeje
; -----------------------------------------------------------------------------

PUBLIC   XPage
XPage:
         mov       cx,2                     ; 2 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        XPAGE - z mˆna str nek displeje
; -----------------------------------------------------------------------------

PUBLIC   XXPage
XXPage:
         ret

; -----------------------------------------------------------------------------
;        WINDOW - definice v˜stupn¡ho okna
; -----------------------------------------------------------------------------

PUBLIC   XWind
XWind:
         mov       cx,4                     ; 4 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        PALETTE - definice palet displeje
; -----------------------------------------------------------------------------

PUBLIC   XPal
XPal:
         mov       cx,17                    ; 17 argument–
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        XCOLOR - z mˆna barvy v oknˆ
; -----------------------------------------------------------------------------

PUBLIC   XXCOl
XXCol:
         mov       cx,2                     ; 2 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        SETCURS - nastaven¡ pozice kurzoru
; -----------------------------------------------------------------------------

PUBLIC   XSetCur
XSetCur:
         mov       cx,2                     ; 2 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        CURSOFF - vypnut¡ kurzoru
; -----------------------------------------------------------------------------

PUBLIC   XCurOff
XCurOff:
         ret

; -----------------------------------------------------------------------------
;        LOAD - na‡ten¡ objektu do pamˆti
; -----------------------------------------------------------------------------

PUBLIC   XLoad
XLoad:

; ------ test, zda je prvn¡ znak z vorka "("

         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XLoad7                   ; chyba - nejsou parametry

; ------ definice objektu

         call      DefObj                   ; definice ‡¡sla objektu

; ------ oddˆlovac¡ ‡ rka parametr–

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XLoad7                   ; chyba - neplatn˜ znak

; ------ definice jm‚na souboru

         call      DefTxt                   ; definice jm‚na
         jc        XLoad7                   ; chybn‚ jm‚no souboru

; ------ test, zda je prav  z vorka ")"

         call      TestRght                 ; test, zda je prav  z vorka
         jnc       XLoad8                   ; je prav  z vorka - OK

; ------ chyba syntaxe p©¡kazu

XLoad7:  mov       dx,offset Err01b         ; text - chyba syntaxe
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ n vrat z obsluhy

XLoad8:
         ret


; -----------------------------------------------------------------------------
;        PIC - zobrazen¡ objektu
; -----------------------------------------------------------------------------

PUBLIC   XObj
XObj:

; ------ test, zda je prvn¡ znak z vorka "("

         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XObj7                    ; chyba - nejsou parametry

; ------ definice objektu

         call      DefObj                   ; definice ‡¡sla objektu

; ------ oddˆlovac¡ ‡ rka parametr–

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XObj7                    ; chyba - neplatn˜ znak

; ------ sou©adnice X

         call      Vyraz                    ; sou©adnice X

; ------ oddˆlovac¡ ‡ rka parametr–

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XObj7                    ; chyba - neplatn˜ znak

; ------ sou©adnice Y

         call      Vyraz                    ; sou©adnice Y

; ------ test, zda je prav  z vorka ")"

         call      TestRght                 ; test, zda je prav  z vorka
         jnc       XObj8                   ; je prav  z vorka - OK

; ------ chyba syntaxe p©¡kazu

XObj7:   mov       dx,offset Err01b         ; text - chyba syntaxe
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ n vrat z obsluhy

XObj8:   ret

; -----------------------------------------------------------------------------
;        UNLOAD - zru¨en¡ objektu v pamˆti
; -----------------------------------------------------------------------------

PUBLIC   XUnld
XUnld:

; ------ test, zda je prvn¡ znak z vorka "("

         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XUnld7                   ; chyba - nejsou parametry

; ------ definice objektu

         call      DefObj                   ; definice ‡¡sla objektu

; ------ test, zda je prav  z vorka ")"

         call      TestRght                 ; test, zda je prav  z vorka
         jnc       XUnld8                   ; je prav  z vorka - OK

; ------ chyba syntaxe p©¡kazu

XUnld7:  mov       dx,offset Err01b         ; text - chyba syntaxe
         call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ n vrat z obsluhy

XUnld8:  ret

; -----------------------------------------------------------------------------
;        TEXT - zobrazen¡ textu
; -----------------------------------------------------------------------------

PUBLIC   XText
XText:

; ------ test, zda je prvn¡ znak z vorka "("

         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XText7                   ; chyba - nejsou parametry

; ------ sou©adnice X

         call      Vyraz                    ; definice sou©adnice X
         jc        XText8

; ------ oddˆlovac¡ ‡ rka

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XText7                   ; nen¡ - chyba syntaxe

; ------ sou©adnice Y

         call      Vyraz                    ; definice sou©adnice Y
         jc        XText8

; ------ oddˆlovac¡ ‡ rka

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XText7                   ; nen¡ - chyba syntaxe

; ------ barva textu

         call      Vyraz                    ; definice barvy
         jc        XText8

; ------ oddˆlovac¡ ‡ rka

         call      TestCar                  ; test, zda je oddˆlovac¡ ‡ rka
         jc        XText7                   ; nen¡ - chyba syntaxe

; ------ definice textu k zobrazen¡

         call      DefTxt                   ; definice textu
         jc        XText7                   ; chyba

; ------ test, zda je prav  z vorka ")"

         call      TestRght                 ; test, zda je prav  z vorka
         jnc       XText9                   ; je prav  z vorka - OK

; ------ chyba syntaxe p©¡kazu

XText7:  mov       dx,offset Err01b         ; text - chyba syntaxe
XText8:  call      DispErr                  ; zobrazen¡ textu chyby
         ret

; ------ n vrat z obsluhy

XText9:  ret

; -----------------------------------------------------------------------------
;        POINT - zobrazen¡ bodu
; -----------------------------------------------------------------------------

PUBLIC   XPoint
XPoint:
         mov       cx,3                     ; 3 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        XLINE - zobrazen¡ ‡ ry
; -----------------------------------------------------------------------------

PUBLIC   XLine
XLine:
         mov       cx,5                     ; 5 argument–
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        XRLINE - zobrazen¡ ‡ ry relativnˆ
; -----------------------------------------------------------------------------

PUBLIC   XRline
XRline:
         mov       cx,3                     ; 3 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        BOX - zobrazen¡ obd‚ln¡ku
; -----------------------------------------------------------------------------

PUBLIC   XBox
XBox:
         mov       cx,5                     ; 5 argument–
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        FBOX - zobrazen¡ pln‚ho obd‚ln¡ku
; -----------------------------------------------------------------------------

PUBLIC   XFBox
XFBox:
         mov       cx,5                     ; 5 argument–
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        CIRC - zobrazen¡ kru‘nice
; -----------------------------------------------------------------------------

PUBLIC   XCirc
XCirc:
         mov       cx,4                     ; 4 argumenty (barva, sou©., polom.)
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        FCIRC - zobrazen¡ pln‚ kru‘nice
; -----------------------------------------------------------------------------

PUBLIC   XFCirc
XFCirc:
         mov       cx,4                     ; 4 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        PRESS - test ur‡en‚ kl vesy, zda je stisknuta
; -----------------------------------------------------------------------------

PUBLIC   XPress
XPress:
         mov       cx,1                     ; 1 argument
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        TESTKEY - test p©ipraven‚ kl vesy
; -----------------------------------------------------------------------------

PUBLIC   XTstKey
XTstKey:
         ret

; -----------------------------------------------------------------------------
;        GETKEY - vstup znaku z kl vesnice
; -----------------------------------------------------------------------------

PUBLIC   XGtKey
XGtKey:
         ret

; -----------------------------------------------------------------------------
;        STATKEY - stavov‚ slovo kl vesnice
; -----------------------------------------------------------------------------

PUBLIC   XStatKey
XStatKey:
         ret

; -----------------------------------------------------------------------------
;        INPUT - vstup textu
; -----------------------------------------------------------------------------

PUBLIC   XInp
XInp:
         ret

; -----------------------------------------------------------------------------
;        SOUND - ovl d n¡ zvukov‚ho gener toru
; -----------------------------------------------------------------------------

PUBLIC   XSound
XSound:
         mov       cx,1                     ; 1 argument
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        TON - zahr n¡ t¢nu dan‚ frekvence a d‚lky
; -----------------------------------------------------------------------------

PUBLIC   XTon
XTon:
         mov       cx,2                     ; 2 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        MUSIC - zahr n¡ melodie
; -----------------------------------------------------------------------------

; ------ ulo‘en¡ slova d‚lky melodie

XMusK:
         push      es                       ; £schova ES
         mov       es,ds:[ProgSeg]          ; segment s programem
         mov       ax,ds:[ProgNum]          ; ukazatel programu
         sub       ax,bx                    ; d‚lka melodie*2 + 2
         sub       ax,2                     ; d‚lka melodie*2
         shr       ax,1                     ; d‚lka melodie
         mov       es:[bx],ax               ; nastaven¡ d‚lky melodie
         pop       es                       ; n vrat ES
         ret

; ------ chyba syntaxe p©¡kazu

XMusX:   mov       dx,offset Err01b         ; text - chyba syntaxe
         call      DispErr                  ; zobrazen¡ textu chyby
         ret




PUBLIC   XMusic
XMusic:

; ------ test, zda je prvn¡ znak z vorka "("

         call      TestLeft                 ; test, zda je lev  z vorka
         jc        XMusX                    ; chyba - nejsou parametry

; ------ £schova ukazatele za‡ tku melodie

         mov       bx,ds:[ProgNum]          ; £schova ukazatele programu
         call      OutWrd                   ; rezerva pro slovo d‚lky melodie

; ------ inicializace ukazatel– melodie

         mov       word ptr ds:[Oktava],4*12+1 ; inicializa‡n¡ okt va 4
         mov       byte ptr ds:[DelTon],4   ; inicializa‡n¡ d‚lka t¢nu 4
         mov       word ptr ds:[Krizky],0   ; zru¨en¡ k©¡‘k–

; ------ nalezen¡ platn‚ho znaku

XMus1:   call      InpSpc
         jc        XMusX                    ; neo‡ek van˜ konec
         cmp       al,")"                   ; je konec parametru ?
         je        XMusK                    ; konec parametru
         cmp       al,","                   ; je oddˆlovac¡ ‡ rka ?
         je        XMus1                    ; oddˆlovac¡ ‡ rka - ignoruje se

; ------ nastaven¡ okt vy - parametr "On"

         cmp       al,"O"                   ; je nastaven¡ okt vy "O" ?
         jne       XMus2                    ; nen¡ nastaven¡ okt vy "O"
         call      Numb                     ; vstup ‡¡sla - nastaven¡ okt vy
         jc        XMusX                    ; chyba
         cmp       ax,9
XMusXA:  ja        XMusX                    ; chybn‚ ‡¡slo okt vy
         mov       ah,12                    ; d‚lka okt vy v p–lt¢nech
         mul       ah                       ; p©epo‡et okt vy na p–lt¢ny
         inc       ax                       ; po‡ te‡n¡ offset = 1
         mov       ds:[Oktava],ax           ; £schova ‡¡sla okt vy v p–lt¢nech
         jmp       short XMus1              ; vstup dal¨¡ho parametru

; ------ zv˜¨en¡ t¢nu o okt vu - znak "+"

XMus2:   cmp       al,"+"                   ; je zv˜¨en¡ okt vy ?
         jne       XMus3                    ; nen¡ zv˜¨en¡ okt vy "+"
         add       word ptr ds:[Krizky],12  ; zv˜¨en¡ t¢nu o okt vu
         jmp       short XMus1              ; vstup dal¨¡ho parametru

; ------ sn¡‘en¡ okt vy - znak "-"

XMus3:   cmp       al,"-"                   ; je sn¡‘en¡ okt vy ?
         jne       XMus4                    ; nen¡ sn¡‘en¡ okt vy "-"
         sub       word ptr ds:[Krizky],12  ; sn¡‘en¡ t¢nu o okt vu
         jmp       short XMus1              ; vstup dal¨¡ho parametru

; ------ transpozice t¢niny - parametr "Tn"

XMus4:   cmp       al,"T"                   ; je transpozice t¢niny ?
         jne       XMus5                    ; nen¡ transpozice t¢niny
         call      Numb                     ; vstup ‡¡sla - transpozice
XMusXC:  jc        XMusX                    ; chyba syntaxe
         add       ds:[Oktava],ax           ; transpozice t¢niny
         jmp       short XMus1              ; vstup dal¨¡ho parametru

; ------ posun t¢nu o p–lt¢n - znak "#"

XMus5:   cmp       al,"#"                   ; je posun o p–lt¢n ?
         jne       XMus6                    ; nen¡ posun o p–lt¢n
         inc       word ptr ds:[Krizky]     ; zv˜¨en¡ ‡¡ta‡e k©¡‘k–
         jmp       short XMus1              ; vstup dal¨¡ho parametru

; ------ nastaven¡ d‚lky t¢nu - parametr "Ln"

XMus6:   cmp       al,"L"                   ; je nastaven¡ d‚lky t¢nu ?
         jne       XMus7                    ; nen¡ nastaven¡ d‚lky t¢nu
         call      Numb                     ; vstup ‡¡sla - d‚lka t¢nu
         jc        XMusXC                   ; chyba syntaxe
         cmp       ax,255                   ; max. d‚lka
XMusXA2: ja        XMusXA                   ; chyba d‚lky t¢nu
         mov       byte ptr ds:[DelTon],al  ; £schova d‚lky t¢nu
XMus11:  jmp       short XMus1              ; vstup dal¨¡ho parametru

; ------ prodleva - parametr R

XMus7:   cmp       al,"R"                   ; je prodleva ?
         mov       dl,0                     ; ‡¡slo t¢nu - prodleva
         je        XMus9

; ------ je t¢n - parametr C, D, E, F, G, A, H

         mov       dl,1                     ; je t¢n C
         cmp       al,"C"
         je        XMus8                    ; je C

         mov       dl,3
         cmp       al,"D"
         je        XMus8                    ; je D

         mov       dl,5
         cmp       al,"E"
         je        XMus8                    ; je E

         mov       dl,6
         cmp       al,"F"
         je        XMus8                    ; je F

         mov       dl,8
         cmp       al,"G"
         je        XMus8                    ; je G

         mov       dl,10
         cmp       al,"A"
         je        XMus8                    ; je A

         mov       dl,12
         cmp       al,"H"
         stc
         jne       XMusXC                   ; nen¡ "H" - chyba

; ------ zv˜¨en¡ t¢nu o okt vu a p–lt¢ny

XMus8:   mov       dh,0
         add       dx,ds:[Oktava]           ; zv˜¨en¡ t¢nu o okt vy
         add       dx,ds:[Krizky]           ; zv˜¨en¡ t¢nu o k©¡‘ky
         cmp       dx,121                   ; maxim ln¡ t¢n 121
XMusXA3: ja        XMusXA2                  ; p©ete‡en¡

; ------ ulo‘en¡ k¢du t¢nu

XMus9:   mov       al,dl                    ; k¢d t¢nu
         call      OutCh                    ; z pis bajt k¢du t¢nu
         mov       word ptr ds:[Krizky],0   ; zru¨en¡ p©¡znaku k©¡‘k–

; ------ prodlou‘en¡ t¢nu o p–lt¢n

         mov       dx,0                     ; ‡¡ta‡ znak– "." a "^"
XMusA:   call      InpSpc                   ; vstup dal¨¡ho znaku
         jc        XMusXC                   ; to je chyba
         cmp       al,"."                   ; je prodlou‘en¡ o p–lt¢n ?
         jne       XMusB                    ; nen¡ prodlou‘en¡ o p–lt¢n
         inc       dx                       ; zv˜¨en¡ ‡¡ta‡e p–lt¢n–
         jmp       short XMusA              ; vstup dal¨¡ho znaku

; ------ zkr cen¡ t¢nu na polovinu

XMusB:   cmp       al,"<"                   ; je zkr cen¡ t¢nu na polovinu ?
         jne       XMusC                    ; nen¡ zkr cen¡ t¢nu na polovinu
         sub       dx,2                     ; zv˜¨en¡ ‡¡ta‡e zkr cen¡
         jmp       short XMusA              ; vstup dal¨¡ho znaku

; ------ prodlou‘en¡ t¢nu na dvojn sobek

XMusC:   cmp       al,">"                   ; je dvojn sobn‚ prodlou‘en¡ t¢nu ?
         jne       XMusH                    ; nen¡ dvojn sobn‚ prodlou‘en¡ t¢nu
         add       dx,2
         jmp       short XMusA              ; vstup dal¨¡ho znaku

; ------ dek¢dov n¡ d‚lky t¢nu

XMusH:   call      RetCh                    ; navr cen¡ znaku
         call      NumB                     ; vstup ‡¡sla d‚lky t¢nu
         jnc       XMusD                    ; d‚lka t¢nu OK
         mov       al,ds:[DelTon]           ; implicitn¡ d‚lka t¢nu
         mov       ah,0
XMusD:   cmp       ax,255                   ; je d‚lka t¢nu povolen  ?
         ja        XMusXA3                  ; d‚lka t¢nu nen¡ povolen 

; ------ £prava d‚lky t¢nu podle p©ep¡na‡–

         or        dx,dx                    ; je prodlou‘en¡ nebo zkr cen¡ ?
         je        XMusF                    ; nen¡ ‘ dn  oprava
         js        XMusE                    ; je zkr cen¡ doby

; ------ je prodlou‘en¡ doby

         mov       cx,dx                    ; po‡et prodlou‘en¡ o p–lt¢n
         shr       cx,1                     ; po‡et prodlou‘en¡ o cel˜ t¢n
         shl       ax,cl                    ; prodlou‘en¡ doby
         jmp       short XMusF

; ------ je zkr cen¡ doby

XMusE:   neg       dx
         mov       cx,dx                    ; po‡et zkr cen¡ o p–lt¢n
         shr       cx,1                     ; po‡et zkr cen¡ o cel˜ t¢n
         shr       ax,cl                    ; zkr cen¡ doby

; ------ p©¡padn‚ prodlou‘en¡ doby o p–lt¢n

XMusF:   shr       dx,1                     ; je prodlou‘en¡ o p–lt¢n ?
         jnc       XMusG                    ; nen¡ prodlou‘en¡ o p–lt¢n
         mov       dx,ax                    ;
         shr       dx,1
         add       ax,dx                    ; prodlou‘en¡ o p–lt¢n

; ------ ulo‘en¡ d‚lky t¢nu

XMusG:   call      OutCh                    ; z pis bajtu d‚lky t¢nu
         jmp       XMus11                   ; dek¢dov n¡ dal¨¡ho parametru


; -----------------------------------------------------------------------------
;        MUSICSTOP - zastaven¡ hry melodie
; -----------------------------------------------------------------------------

PUBLIC   XMStop
XMStop:
         ret

; -----------------------------------------------------------------------------
;        MUSICGET - poskytnut¡ ukazatele melodie
; -----------------------------------------------------------------------------

PUBLIC   XMusGet
XMusGet:
         ret

; -----------------------------------------------------------------------------
;        WAIT - ‡ek n¡ po danou dobu
; -----------------------------------------------------------------------------

PUBLIC   XWait
XWait:
         mov       cx,1                     ; 1 argument
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        TIME - poskytnut¡ syst‚mov‚ho ‡asu
; -----------------------------------------------------------------------------

PUBLIC   XTime
XTime:
         ret

; -----------------------------------------------------------------------------
;        DATE - poskytnut¡ syst‚mov‚ho data
; -----------------------------------------------------------------------------

PUBLIC   XDate
XDate:
         ret

; -----------------------------------------------------------------------------
;        XMOUSE - poskytnut¡ pozice my¨i
; -----------------------------------------------------------------------------

PUBLIC   XXMous
XXMous:
         ret

; -----------------------------------------------------------------------------
;        YMOUSE - poskytnut¡ © dku my¨i
; -----------------------------------------------------------------------------

PUBLIC   XYMous
XYMous:
         ret

; -----------------------------------------------------------------------------
;        GETMOUSE - poskytnut¡ tla‡¡tek my¨i
; -----------------------------------------------------------------------------

PUBLIC   XKMous
XKMous:
         ret

; -----------------------------------------------------------------------------
;        MOUSEON - zapnut¡ kurzoru my¨i
; -----------------------------------------------------------------------------

PUBLIC   XMon
XMon:
         ret

; -----------------------------------------------------------------------------
;        MOUSEOFF - vypnut¡ kurzoru my¨i
; -----------------------------------------------------------------------------

PUBLIC   XMoff
XMoff:
         ret

; -----------------------------------------------------------------------------
;        CURMOUSE - definice kurzoru my¨i
; -----------------------------------------------------------------------------

PUBLIC   XDefm
XDefm:
         ret

; -----------------------------------------------------------------------------
;        WINMOUSE - definice okna my¨i
; -----------------------------------------------------------------------------

PUBLIC   XWinm
XWinm:
         mov       cx,4                     ; 4 argumenty
         call      Argum                    ; vstup argumentu
         ret

; -----------------------------------------------------------------------------
;        RND - gener tor n hodn‚ho ‡¡sla
; -----------------------------------------------------------------------------

PUBLIC   XRnd
XRnd:
         mov       cx,1
         call      Argum
         ret

; -----------------------------------------------------------------------------
;        REGISTER - nastaven¡ registru CRT
; -----------------------------------------------------------------------------

PUBLIC   XReg
XReg:
         mov       cx,2                     ; 2 parametry
         call      Argum
         ret

; -----------------------------------------------------------------------------
;        HSYN - horizont ln¡ synchronizace
; -----------------------------------------------------------------------------

PUBLIC   XHSyn
XHSyn:
         mov       cx,1                     ; 1 parametr
         call      Argum
         ret

; -----------------------------------------------------------------------------
;        VSYN - vertik ln¡ synchronizace
; -----------------------------------------------------------------------------

PUBLIC   XVSyn
XVSyn:
         mov       cx,1                     ; 1 parametr
         call      Argum
         ret

; -----------------------------------------------------------------------------
;        PATTERN - vzorek v˜plnˆ
; -----------------------------------------------------------------------------

PUBLIC   XPatt
XPatt:
         mov       cx,8                     ; 8 parametr–
         call      Argum
         ret

; -----------------------------------------------------------------------------
;        STICK - joystickov˜ vstup
; -----------------------------------------------------------------------------

PUBLIC   XStick
XStick:
         ret

; -----------------------------------------------------------------------------
;        TRIG - aktiva‡n¡ tla‡¡tko Joysticku
; -----------------------------------------------------------------------------

PUBLIC   XTrig
XTrig:
         ret

; -----------------------------------------------------------------------------
;        SIN - funkce sinus
; -----------------------------------------------------------------------------

PUBLIC   XSin
XSin:    mov       cx,1
         call      Argum                    ; 1 argument
         ret

; -----------------------------------------------------------------------------
;        COS - funkce cosinus
; -----------------------------------------------------------------------------

PUBLIC   XCos
XCos:    mov       cx,1
         call      Argum                    ; 1 argument
         ret

; -----------------------------------------------------------------------------
;        TAN - funkce tangent
; -----------------------------------------------------------------------------

PUBLIC   XTan
XTan:    mov       cx,1
         call      Argum                    ; 1 argument
         ret

; -----------------------------------------------------------------------------
;        ABS - absolutn¡ hodnota
; -----------------------------------------------------------------------------

PUBLIC   XAbs
XAbs:    mov       cx,1
         call      Argum                    ; 1 argument
         ret

; -----------------------------------------------------------------------------
;        ATN - funkce arcutangent
; -----------------------------------------------------------------------------

PUBLIC   XAtn
XAtn:    mov       cx,1
         call      Argum                    ; 1 argument
         ret

; -----------------------------------------------------------------------------
;        SQR - funkce odmocnina
; -----------------------------------------------------------------------------

PUBLIC   XSqr
XSqr:    mov       cx,1
         call      Argum                    ; 1 argument
         ret



; *****************************************************************************
;
;                        Obsluha u‘ivatelsk‚ho n vˆ¨t¡
;
; *****************************************************************************

; -----------------------------------------------------------------------------
;                        Ulo‘en¡ jm‚na do bufferu
; -----------------------------------------------------------------------------
; VSTUP:  AL=typ jm‚na
; V˜stup: AL=typ nalezen‚ho jm‚na (indik tor)
;         ES:DI=adresa jm‚na v tabulce symbol–
;         CY=je ji‘ definov no
; -----------------------------------------------------------------------------
; Popis definice jm‚na v tabulce u‘ivatelsk˜ch jmen:
;      00h=Indika‡n¡ bajt: bit 0:    0=nen¡ definov no, 1=jm‚no definov no
;                          bit 1:    0=data, 1=procedura
;                          bit 2,3:  0 = BYTE
;                                    1 = WORD
;                                    (2 = STRING)
;                                    3 = OBJECT
;                          bit 4:    1 = indexovan  promˆnn 
;      01h=adresa symbolu (slovo)
;      03h=d‚lka jm‚na (max. 64 bajt–)
;      04h=text jm‚na
; -----------------------------------------------------------------------------
;þ
PUBLIC   StorFlg
StorFlg:

; ------ £schova registr–

         push      bx
         push      cx
         push      si

; ------ inicializace registr–

         cld
         mov       es,ds:[FlagBuf]          ; segment s bufferem symbol–
         xor       di,di                    ; po‡ te‡n¡ adresa v bufferu
         mov       si,offset DelIdent       ; d‚lka jm‚na a text jm‚na
         mov       ch,0                     ; CH <- 0

; ------ test, zda je je¨tˆ dal¨¡ jm‚no v bufferu

StorFlg1:cmp       di,ds:[FlagNum]          ; je ji‘ konec tabulky ?
         jae       StorFlg3                 ; je konec tabulky

; ------ porovn n¡, zda je hledan‚ jm‚no

         mov       cl,es:[di+3]             ; d‚lka jm‚na
         inc       cl                       ; porovn v  se i d‚lkov˜ bajt
         push      si
         push      di
         push      cx
         add       di,3                     ; adresa za‡ tku jm‚na s d‚lkou
         repe      cmpsb                    ; porovn n¡ n vˆ¨t¡
         pop       cx
         pop       di
         pop       si
         stc                                ; p©¡znak, ‘e jm‚no bylo nalezeno
         je        StorFlg5                 ; jm‚no nalezeno OK

; ------ nastaven¡ na dal¨¡ jm‚no v tabulce

         add       di,3                     ; p©esko‡en¡ £vodn¡ch bajt–
         add       di,cx                    ; p©esko‡en¡ textu jm‚na
         jmp       short StorFlg1           ; test dal¨¡ho jm‚na

; ------ ulo‘en¡ nov‚ho n vˆ¨t¡ do bufferu

StorFlg3:cmp       di,-70                   ; dosa‘eno konce bufferu ?
         jae       StorFlg7                 ; chyba p©ete‡en¡ pamˆti
         push      di                       ; £schova adresy za‡ tku jm‚na
         stosb                              ; ulo‘en¡ indika‡n¡ho bajtu
         mov       bx,ds:[ProgNum]          ; adresa ukazatele programu
         mov       es:[di],bx               ; nastaven¡ adresy symbolu
         add       di,2                     ; zv˜¨en¡ adresy
         mov       cl,ds:[si]               ; d‚lka jm‚na symbolu
         inc       cx                       ; ulo‘¡ se i bajt d‚lky
         rep       movsb                    ; ulo‘en¡ textu jm‚na
         mov       ds:[FlagNum],di          ; nov  adresa konce bufferu
         pop       di                       ; adresa za‡ tku jm‚na
         clc                                ; p©¡znak, ‘e je nov‚ jm‚no

; ------ zji¨tˆn¡ parametr– jm‚na ES:DI

StorFlg5:mov       al,es:[di]               ; indika‡n¡ bajt symbolu

; ------ n vrat registr–

StorFlg6:pop       si
         pop       cx
         pop       bx
         ret

; ------ chyba p©ete‡en¡ pamˆti

StorFlg7:mov       dx,offset Mem1Txt        ; text - p©ete‡en¡ tabulky symbol–
         jmp       WritPrg1                 ; chyba - p©ete‡en¡ pamˆti

; *****************************************************************************
;
;                   Obsluha standardn¡ho identifik toru
;
; *****************************************************************************


; -----------------------------------------------------------------------------
;        Na‡ten¡ identifik toru (symbolu) (CY=nen¡ platn˜ identifik tor)
; -----------------------------------------------------------------------------

PUBLIC   ReadIdnt

; ------ p©¡prava registr–

ReadIdnt:push      cx
         push      di
         push      es
         mov       byte ptr ds:[DelIdent],0 ; d‚lka n vˆ¨t¡ = 0
         mov       cx,64                    ; maxim ln¡ po‡et znak– identifik.
         mov       di,offset BufIdent       ; buffer k ulo‘en¡
         push      ds
         pop       es                       ; ES <- datov˜ segment
         cld                                ; smˆr nahoru

; ------ na‡ten¡ prvn¡ho znaku identifik toru

         call      InpSpc                   ; vstup znaku s vypustˆn¡m mezer
         jc        ReadIdn5                 ; nen¡ dal¨¡ znak
         call      IdentCh                  ; test, zda je to platn˜ znak
         jc        ReadIdn4                 ; nen¡ to platn˜ znak - n vrat

; ------ test, zda to nen¡ ‡¡slice (= zak zan˜ prvn¡ znak)

         cmp       al,"0"                   ; je to ‡¡slice ?
         jb        ReadIdn2                 ; nen¡ to ‡¡slice - OK
         cmp       al,"9"+1                 ; je to ‡¡slice ?
         jb        ReadIdn4                 ; je to ‡¡slice - zak zan˜ znak

; ------ ulo‘en¡ znaku identifik toru

ReadIdn2:stosb                              ; ulo‘en¡ znaku do bufferu
         inc       byte ptr ds:[DelIdent]   ; zv˜¨en¡ ‡¡ta‡e d‚lky n vˆ¨t¡
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e max. po‡tu znak–
         jz        ReadIdn3                 ; p©ekro‡en max. po‡et znak–

; ------ vstup dal¨¡ho znaku identifik toru

         call      InpCh                    ; vstup dal¨¡ho znaku
         cmc
         jnc       ReadIdn5                 ; nen¡ dal¨¡ znak
         call      IdentCh                  ; test, zda to je platn˜ znak
         jnc       ReadIdn2                 ; je platn˜ znak - dal¨¡ znak

; ------ n vrat posledn¡ho znaku

ReadIdn3:clc                                ; p©¡znak - n vˆ¨t¡ je OK
ReadIdn4:call      RetCh                    ; n vrat znaku
ReadIdn5:pop       es
         pop       di
         pop       cx
         ret

; -----------------------------------------------------------------------------
;        Test, zda je znak symbolu (CY=nen¡ platn˜ znak identifik toru)
; -----------------------------------------------------------------------------

PUBLIC   IdentCh

IdentCh: call      UpCase                   ; p©evod na velk‚ p¡smeno
         cmp       al,"_"                   ; je podtr‘¡tko ?
         je        IdentCh2                 ; je platn˜ znak identifik toru
         cmp       al,"0"                   ; je ‡¡slice ?
         jb        IdentCh2                 ; nen¡ platn˜ znak identifik toru
         cmp       al,"9"+1                 ; je ‡¡slice ?
         cmc
         jnc       IdentCh2                 ; je ‡¡slice - je platn˜ znak
         cmp       al,"A"                   ; je p¡smeno ?
         jb        IdentCh2                 ; nen¡ platn˜ znak identifik toru
         cmp       al,"Z"+1                 ; je p¡smeno ?
         cmc
         jnc       IdentCh2                 ; je p¡smeno - je platn˜ znak
         cmp       al,128                   ; je znak > 128 ?

IdentCh2:ret

; -----------------------------------------------------------------------------
;        Nalezen¡ identifik toru v tabulce intern¡ch povel–
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: DS:SI=adresa slova v tabulce
;         AL=‡¡slo slova v tabulce (0...)
;         CY=slovo nenalezeno
; -----------------------------------------------------------------------------

PUBLIC   SrcIdnt

SrcIdnt:

; ------ £schova registr–

         push      cx
         push      di
         push      es
         push      ds
         pop       es                       ; ES <- DS

; ------ p©¡prava registr–

         cld                                ; smˆr posunu ukazatel– nahoru
         mov       al,0                     ; ukazatel ‡¡sla identifik toru
         mov       si,offset TabKey         ; tabulka intern¡ch slov
         mov       di,offset DelIdent       ; d‚lka identifik toru + identifik.
         mov       ch,0                     ; CH <- 0 vy¨¨¡ bajt d‚lky

; ------ porovn n¡ jednoho slova

SrcIdn1: mov       cl,ds:[si]               ; d‚lka slova
         stc                                ; p©¡znak chyby - slovo nenalezeno
         jcxz      SrcIdn3                  ; je konec tabulky
         inc       cx                       ; p©i‡ten¡ bajtu d‚lky
         push      cx
         push      di
         push      si
         repe      cmpsb                    ; porovn n¡ ©etˆzc–
         pop       si
         pop       di
         pop       cx
         je        SrcIdn3                  ; slovo nalezeno

; ------ nastaven¡ na dal¨¡ slovo

         add       si,cx                    ; p©esko‡en¡ d‚lky a slova
         add       si,2                     ; p©esko‡en¡ adresy obsluhy
         inc       al                       ; zv˜¨en¡ ‡¡ta‡e slov
         jmp       short SrcIdn1            ; porovn n¡ dal¨¡ho slova

; ------ n vrat registr–

SrcIdn3: pop       es
         pop       di
         pop       cx
         ret


; -----------------------------------------------------------------------------
;        N vrat n vˆ¨t¡ do bufferu
; -----------------------------------------------------------------------------

PUBLIC   RetIdnt

RetIdnt: push      ax
         push      cx
         push      si
         mov       si,offset BufIdent-1     ; buffer s identifik torem - 1
         mov       ch,0
         mov       cl,ds:[DelIdent]         ; d‚lka identifik toru
         jcxz      RetIdnt2                 ; nen¡ ‘ dn˜ znak
         add       si,cx                    ; posledn¡ znak v bufferu
RetIdnt1:std                                ; smˆr dol–
         lodsb                              ; na‡ten¡ znaku k n vratu
         call      RetCh                    ; n vrat znaku do bufferu
         loop      RetIdnt1                 ; n vrat dal¨¡ho znaku
RetIdnt2:cld                                ; smˆr nahoru
         pop       si
         pop       cx
         pop       ax
         ret

; *****************************************************************************
;
;                    Vstup ze vstupn¡ho souboru
;
; *****************************************************************************

;; -----------------------------------------------------------------------------
;;        Nalezen¡ oddˆlova‡e
;; -----------------------------------------------------------------------------
;
;PUBLIC   SrcSpc
;SrcSpc:  call      InpCh                    ; vstup dal¨¡ho znaku
;         jc        SrcSpc2                  ; nen¡ dal¨¡ znak
;         cmp       al," "                   ; je oddˆlova‡ ?
;         jbe       SrcSpc1                  ; je to oddˆlova‡
;         cmp       al,","                   ; je ‡ rka ?
;         je        SrcSpc1                  ; je ‡ rka - je to oddˆlova‡
;         cmp       al,";"                   ; je st©edn¡k ?
;         je        SrcSpc1                  ; je st©edn¡k - je to oddˆlova‡
;         cmp       al,"{"                   ; je pozn mka ?
;         jne       SrcSpc                   ; nen¡ pozn mka - dal¨¡ znak
;SrcSpc1: call      RetCh                    ; n vrat posledn¡ho znaku
;         clc
;SrcSpc2: ret

; -----------------------------------------------------------------------------
;        Vstup znaku s p©evodem na velk‚ p¡smeno
; -----------------------------------------------------------------------------

PUBLIC   InpChU

InpChU:  call      InpCh                    ; vstup znaku ze vstupn¡ho souboru
         jc        InpChU2                  ; nen¡ dal¨¡ znak
         call      UpCase                   ; p©evod znaku na velk‚ p¡smeno
InpChU2: ret

; -----------------------------------------------------------------------------
;        P©evod znaku na velk‚ p¡smeno (ponech v  registr p©¡znak–)
; -----------------------------------------------------------------------------

PUBLIC   UpCase

UpCase:  pushf
         cmp       al,"a"
         jb        UpCase2
         cmp       al,"z"
         ja        UpCase2
         sub       al,20h
UpCase2: popf
         ret

; -----------------------------------------------------------------------------
;        Vypu¨tˆn¡ oddˆlova‡– z textu
; -----------------------------------------------------------------------------

PUBLIC   InpSpc

; ------ vypustˆn¡ oddˆlovac¡ch znak– (mezera, tabel tor, CR, LF)

InpSpc:  call      InpCh                    ; vstup znaku ze souboru
         jc        InpSpc3                  ; nen¡ dal¨¡ znak (konec souboru)
         cmp       al," "                   ; je oddˆlova‡ ?
         jbe       InpSpc                   ; je oddˆlovac¡ znak

; ------ test, zda je pozn mka (z vorka {)

         cmp       al,"{"                   ; je za‡ tek pozn mky ?
         clc                                ; p©¡znak operace OK
         jne       InpSpc3                  ; nen¡ pozn mka - konec

; ------ vypustˆn¡ textu po konce pozn mky (z vorka })

InpSpc1: call      InpCh                    ; vstup dal¨¡ho znaku ze souboru
         jc        InpSpc3                  ; nen¡ dal¨¡ znak
         cmp       al,"{"                   ; je za‡ tek dal¨¡ pozn mky ?
         jne       InpSpc2                  ; nen¡ za‡ tek dal¨¡ pozn mky
         call      InpSpc1                  ; vypustˆn¡ vnit©n¡ pozn mky
         jc        InpSpc3                  ; nen¡ dal¨¡ znak
InpSpc2: cmp       al,"}"                   ; je konec pozn mky ?
         jne       InpSpc1                  ; nalezen¡ konce pozn mky
         jmp       short InpSpc             ; vypustˆn¡ oddˆlova‡–

InpSpc3: call      UpCase                   ; p©evod znaku na velk‚ p¡smeno
         ret

; -----------------------------------------------------------------------------
;        Vstup znaku ze vstupn¡ho souboru (CY=nen¡ dal¨¡ znak)
; -----------------------------------------------------------------------------

PUBLIC   InpCh

; ------ vyjmut¡ znaku z p©echodn‚ho bufferu

InpCh:   cmp       word ptr ds:[BuffChU],0  ; je v p©echodn‚m bufferu znak ?
         je        InpCh7                   ; v p©echodn‚m bufferu nen¡ znak
         push      si                       ; £schova SI
         mov       si,ds:[BuffChU]          ; po‡et bajt– v p©echodn‚m bufferu
         dec       si                       ; sn¡‘en¡ po‡tu bajt– v bufferu
         mov       ds:[BuffChU],si          ; nov˜ po‡et bajt– v bufferu
         mov       al,ds:[BuffCh+si]        ; ‡ten¡ znaku z bufferu
         pop       si                       ; n vrat SI
         jmp       short InpCh22

; ------ kontrola, zda je v bufferu nˆjak˜ znak

InpCh7:  cmp       word ptr ds:[SrcNum],0   ; je v buffer je¨tˆ nˆjak˜ znak ?
         jne       InpCh2                   ; v bufferu je je¨tˆ nˆjak˜ znak

; ------ na‡ten¡ dal¨¡ho bloku ze souboru

         push      ax
         push      bx
         push      cx
         push      dx

         cmp       byte ptr ds:[SrcEnd],0   ; byl ji‘ konec souboru ?
         jne       InpCh4                   ; byl ji‘ konec souboru

                                          ;* na‡ten¡ bloku dat ze souboru
         mov       ah,3fh                   ; funkce ‡ten¡ ze souboru
         mov       bx,ds:[ZdrojId]          ; identifik tor zdrojov‚ho souboru
         mov       cx,2000h                 ; velikost vstupn¡ho bufferu
         xor       dx,dx                    ; buffer k na‡ten¡ souboru
         mov       ds:[SrcUkaz],dx          ; nastaven¡ ukazatele vstup. bufferu

         push      ds
         mov       ds,ds:[SrcBuf]           ; buffer vstupn¡ho souboru
         int       21h                      ; na‡ten¡ bloku ze vstup. souboru
         pop       ds

                                          ;* kontrola spr vnosti operace
         jc        InpCh1                   ; chyba ‡ten¡
         mov       ds:[SrcNum],ax           ; po‡et na‡ten˜ch bajt–
         or        ax,ax                    ; na‡ten nˆjak˜ bajt ?
         jnz       InpCh1                   ; bylo nˆco na‡teno
         inc       byte ptr ds:[SrcEnd]     ; p©¡znak konce souboru
InpCh4:  stc                                ; p©¡znak konce souboru

InpCh1:  pop       dx
         pop       cx
         pop       bx
         pop       ax
         jc        InpCh3                   ; chyba - nejsou dal¨¡ data

; ------ na‡ten¡ znaku z bufferu vstupn¡ho souboru

InpCh2:  push      si
         push      ds
         cld                                ; smˆr nahoru
         mov       si,ds:[SrcUkaz]          ; ukazatel vstupn¡ho bufferu
         mov       ds,ds:[SrcBuf]           ; buffer vstupn¡ho souboru
         lodsb                              ; na‡ten¡ znak z bufferu
         pop       ds
         pop       si
         inc       word ptr ds:[SrcUkaz]    ; zv˜¨en¡ ukazatele vstup. bufferu
         dec       word ptr ds:[SrcNum]     ; sn¡‘en¡ ‡¡ta‡e znak– v bufferu

; ------ obsluha ukazatele za‡ tk– © dk– v souboru

         add       word ptr ds:[UkazCh],1   ; zv˜¨en¡ ukazatele znak– v souboru
         adc       word ptr ds:[UkazCh+2],0 ; p©enos do vy¨¨¡ho slova
         cmp       al,13                    ; je CR ?
         je        InpCh21                  ; je CR
         cmp       al,10                    ; je LF ?
         jne       InpCh22                  ; nen¡ LF
         inc       word ptr ds:[CitRad]     ; zv˜¨en¡ ‡¡ta‡e © dk– souboru
InpCh21: push      ax
         mov       ax,word ptr ds:[UkazCh]  ; ukazatel v souboru - ni‘¨¡ slovo
         mov       word ptr ds:[UkazRad],ax ; ukazatel © dku - ni‘¨¡ slovo
         mov       ax,word ptr ds:[UkazCh+2] ; ukazatel v souboru - vy¨¨¡ slovo
         mov       word ptr ds:[UkazRad+2],ax ; ukazatel © dku - vy¨¨¡ slovo
         pop       ax

InpCh22: clc                                ; p©¡znak operace OK

InpCh3:  ret

; -----------------------------------------------------------------------------
;        N vrat znaku do p©echodn‚ho bufferu
; -----------------------------------------------------------------------------

PUBLIC   RetCh

RetCh:   pushf
         push      si
         mov       si,ds:[BuffChU]          ; po‡et bajt– v p©echodn‚m bufferu
         cmp       si,64                    ; p©ekro‡en konec bufferu ?
         jae       RetCh2                   ; p©ete‡en¡ bufferu
         mov       ds:[BuffCh+si],al        ; ulo‘en¡ znaku do bufferu
         inc       si                       ; zv˜¨en¡ ukazatele v bufferu
         mov       ds:[BuffChU],si          ; nov˜ po‡et bajt– v bufferu
RetCh2:  pop       si
         popf
         ret


; *****************************************************************************
;
;                      Z pis do v˜stupn¡ho bufferu
;
; *****************************************************************************

; -----------------------------------------------------------------------------
;        Zv˜¨en¡ ukazatele v buferu
; -----------------------------------------------------------------------------

PUBLIC   OutInc
OutInc:  pushf
         push      ds
         cmp       word ptr ds:[ProgNum],-1 ; po‡et bajt– ve v˜stupn¡m bufferu
         je        OutInc2                  ; je p©ete‡en¡ bufferu
         inc       word ptr ds:[ProgNum]    ; zv˜¨en¡ ukazatele dat
         mov       ds,ds:[ProgSeg]          ; segment v˜stupn¡ho bufferu
         inc       word ptr ds:[0]          ; zv˜¨en¡ ukazatele d‚lky
OutInc2: pop       ds
         popf
         ret

; -----------------------------------------------------------------------------
;        Zru¨en¡ bajtu ulo‘en‚ho do buferu
; -----------------------------------------------------------------------------

PUBLIC   OutRet
OutRet:  pushf
         push      ds
         cmp       word ptr ds:[ProgNum],0  ; po‡et bajt– ve v˜stupn¡m bufferu
         je        OutRet2                  ; je podte‡en¡ bufferu
         dec       word ptr ds:[ProgNum]    ; sn¡‘en¡ ukazatele dat
         mov       ds,ds:[ProgSeg]          ; segment v˜stupn¡ho bufferu
         dec       word ptr ds:[0]          ; sn¡‘en¡ ukazatele d‚lky
OutRet2: pop       ds
         popf
         ret

; -----------------------------------------------------------------------------
;        Z pis slova AX do v˜stupn¡ho bufferu
; -----------------------------------------------------------------------------

PUBLIC   OutWrd
OutWrd:  push      ax
         call      OutCh
         mov       al,ah
         call      OutCh
         pop       ax
         ret

; -----------------------------------------------------------------------------
;        Z pis bajtu do v˜stupn¡ho bufferu
; -----------------------------------------------------------------------------

PUBLIC   OutCh

OutCh:   push      di
         push      es
         cld                                ; smˆr nahoru
         mov       es,ds:[ProgSeg]          ; segment v˜stupn¡ho bufferu
         mov       di,ds:[ProgNum]          ; po‡et bajt– ve v˜stupn¡m bufferu
         stosb                              ; ulo‘en¡ bajtu do v˜stup. bufferu
         or        di,di                    ; je p©ete‡en¡ bufferu ?
         stc                                ; p©ednastaven¡ p©¡znaku chyby
         jz        OutCh2                   ; je p©ete‡en¡ bufferu
         mov       ds:[ProgNum],di          ; jinak nov˜ po‡et bajt– v bufferu
         inc       word ptr es:[0]          ; zv˜¨en¡ ukazatele d‚lky
         clc                                ; p©¡znak operace OK
OutCh2:  pop       es
         pop       di
         ret

; -----------------------------------------------------------------------------
;        Z pis v˜stupn¡ho bufferu do souboru (CX=po‡et bajt–)
; -----------------------------------------------------------------------------

PUBLIC   WritProg
WritProg:push      ds
         mov       bx,ds:[CilId]            ; identifik tor v˜stupn¡ho souboru
         mov       ds,ds:[ProgSeg]          ; segment s interpreterem
         xor       dx,dx                    ; po‡ te‡n¡ offset
         add       cx,15                    ; zaokrouhlen¡ na odstavec nahoru
         and       cx,not 15                ; zarovn n¡ na odstavec
         mov       ax,cx                    ; po‡et bajt– k z pisu
         jcxz      WritPrg3                 ; nen¡ nic k z pisu
         mov       ah,40h                   ; funkce z pisu do souboru
         int       21h                      ; z pis interpreteru do souboru
WritPrg3:pop       ds
         mov       dx,offset WritTxt        ; text - chyba z pisu
         jc        WritPrg1                 ; chyba z pisu do v˜stupn¡ho souboru
         cmp       ax,cx                    ; zaps no v¨e ?
         je        WritPrg2                 ; nen¡ chyba - OK

; ------ chyba z pisu do v˜stupn¡ho souboru nebo jin  chyba

PUBLIC   WritPrg1
WritPrg1:
         jmp       Navrat0                  ; n vrat s chybou

WritPrg2:ret

; *****************************************************************************
;
;                     Obsluha chybov˜ch hl ¨en¡
;
; *****************************************************************************


; -----------------------------------------------------------------------------
;        Zobrazen¡ chybov‚ho hl ¨en¡
; -----------------------------------------------------------------------------

PUBLIC   DispErr
DispErr:

; ------ £schova registr–

         pushf
         push      ax
         push      bx
         push      cx
         push      dx
         push      di
         push      es

         push      ds
         pop       es
         inc       word ptr ds:[CitChyb]    ; zv˜¨en¡ ‡¡ta‡e chyb

; ------ zobrazen¡ ‡¡sla © dku s chybou

         push      dx                       ; £schova adresy textu hl ¨en¡
         mov       al,"["                   ; lev  z vorka
         call      DispCh                   ; zobrazen¡ znaku lev‚ z vorky
         mov       ax,ds:[ErrNRad]          ; ‡¡slo © dku
         call      DispNum                  ; zobrazen¡ ‡¡sla aktu ln¡ho © dku
         mov       al,"]"                   ; prav  z vorka
         call      DispCh                   ; zobrazen¡ prav‚ z vorky
         mov       al," "                   ; oddˆlovac¡ mezera za ‡¡slem © dku
         call      DispCh                   ; zobrazen¡ oddˆlovac¡ mezery
         pop       di                       ; chybov‚ hl ¨en¡

; ------ zobrazen¡ textu chybov‚ho hl ¨en¡

DispErr1:mov       al,ds:[di]
         inc       di
         or        al,al                    ; konec texty ?
         jz        DispErr3                 ; konec textu
         cmp       al,"%"                   ; parametr ?
         jne       DispErr2                 ; nen¡ parametr

         mov       ch,0
         mov       dx,offset BufIdent       ; buffer identifik toru
         mov       cl,ds:[DelIdent]         ; d‚lka identifik toru
         call      DispTxt                  ; zobrazen¡ textu identifik toru
         jmp       short DispErr1           ; dal¨¡ znak

DispErr2:call      DispCh                   ; zobrazen¡ znaku textu
         jmp       short DispErr1
DispErr3:mov       al,":"                   ; oddˆlova‡ hl ¨en¡
         call      DispCh                   ; zobrazen¡ znaku ":"
         mov       al," "                   ; oddˆlovac¡ mezera textu
         call      DispCh                   ; zobrazen¡ oddˆlovac¡ mezery

; ------ £schova aktu ln¡ pozice v souboru

         mov       ax,4201h                 ; funkce p©esunu od sou‡asn‚ pozice
         mov       bx,ds:[ZdrojId]          ; identifik tor zdrojov‚ho souboru
         xor       cx,cx
         xor       dx,dx
         int       21h                      ; poskytnut¡ aktu ln¡ho ukazatele
         push      ax                       ; ukazatel - ni‘¨¡ slovo
         push      dx                       ; ukazatel - vy¨¨¡ slovo

; ------ nastaven¡ pozice © dku s chybou

         mov       ax,4200h                 ; funkce nastaven¡ od za‡ tku soub.
         mov       dx,word ptr ds:[ErrARad] ; ukazatel © dku - ni‘¨¡ slovo
         mov       cx,word ptr ds:[ErrARad+2] ; ukazatel © dku - vy¨¨¡ slovo
         int       21h                      ; nastaven¡ ukazatele na © dek

; ------ na‡ten¡ © dku do bufferu

         mov       ah,3fh                   ; funkce ‡ten¡ ze souboru
         mov       dx,offset ErrRad         ; buffer pro chybov˜ © dek
         mov       cx,255                   ; maxim ln¡ po‡et znak–
         int       21h                      ; na‡ten¡ © dku ze souboru
         xor       ah,ah                    ; AH <- 0 poji¨tˆn¡
         mov       di,ax                    ; £schova po‡tu na‡ten˜ch znak–

; ------ n vrat p–vodn¡ho ukazatele v souboru

         mov       ax,4200h                 ; funkce nastaven¡ ukazatele
         pop       cx                       ; ukazatel - vy¨¨¡ slovo
         pop       dx                       ; ukazatel - ni‘¨¡ slovo
         int       21h                      ; nastaven¡ p–vodn¡ho ukazatele

; ------ nalezen¡ konce © dku v bufferu

         mov       cx,di                    ; po‡et znak– v bufferu
         push      cx
         mov       al,13                    ; hledan˜ znak - CR
         mov       di,offset ErrRad         ; buffer s chybov˜m © dkem
         mov       dx,di                    ; buffer s chybov˜m © dkem
         repne     scasb                    ; nalezen¡ znaku CR
         mov       byte ptr ds:[di-1],0     ; n hrada bajtem 0 (konec textu)
         pop       cx                       ; po‡et znak– v bufferu

; ------ nalezen¡ za‡ tku textu

         jcxz      DispErr7                 ; nen¡ dal¨¡ znak
DispErr5:mov       di,dx                    ; ukazatel adresy v bufferu
         cmp       byte ptr ds:[di]," "     ; je oddˆlova‘ ?
         ja        DispErr7                 ; nen¡ oddˆlova‡ - zobrazen¡ textu
         inc       dx                       ; zv˜¨en¡ adresy
         loop      DispErr5                 ; dal¨¡ znak

; ------ zobrazen¡ chybov‚ho © dku

DispErr7:mov       si,dx                    ; text k zobrazen¡
         cld
DispErr6:lodsb
         or        al,al                    ; je konec textu ?
         jz        DispErr4                 ; je konec textu
         call      DispCh                   ; zobrazen¡ textu © dku
         jmp       short DispErr6           ; dal¨¡ znak k zobrazen¡

; ------ od© dkov n¡ textu

DispErr4:mov       al,13
         call      DispCh                   ; zobrazen¡ CR
         mov       al,10
         call      DispCh                   ; zobrazen¡ LF

; ------ n vrat registr–

         pop       es
         pop       di
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         popf
         ret

; -----------------------------------------------------------------------------
;        Zobrazen¡ ‡¡sla AX
; -----------------------------------------------------------------------------

PUBLIC   DispNum

; ------ p©¡prava registr–

DispNum: push      ax
         push      bx
         push      cx
         push      dx
         mov       bx,10                    ; ‡¡seln  soustava
         xor       cx,cx                    ; ‡¡ta‡ ‡¡slic v z sobn¡ku

; ------ v˜po‡et jedn‚ ‡¡slice

DispNm1: xor       dx,dx                    ; DX <- 0 vy¨¨¡ slovo ‡¡sla
         div       bx                       ; v˜po‡et jedn‚ ‡¡slice
         add       dl,"0"                   ; korekce na znak ASCII
         push      dx                       ; ulo‘en¡ znaku do z sobn¡ku
         inc       cx                       ; zv˜¨en¡ ‡¡ta‡e znak–
         or        ax,ax                    ; zbylo nˆjak‚ ‡¡slo ?
         jnz       DispNm1                  ; je dal¨¡ ‡¡slo

; ------ zobrazen¡ ‡¡sla

DispNm2: pop       ax                       ; znak k zobrazen¡
         call      DispCh                   ; zobrazen¡ ‡¡slice
         loop      DispNm2                  ; zobrazen¡ dal¨¡ ‡¡slice

; ------ n vrat registr–

         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

; -----------------------------------------------------------------------------
;        Zobrazen¡ textu DS:DX o d‚lce CX znak–
; -----------------------------------------------------------------------------

PUBLIC   DispTxt
DispTxt: push      ax
         push      cx
         push      si
         mov       si,dx                    ; adresa textu
         jcxz      DispTxt2                 ; nen¡ ‘ dn˜ znak
         cld
DispTxt1:lodsb
         call      DispCh                   ; zobrazen¡ znaku
         loop      DispTxt1                 ; dal¨¡ znak
DispTxt2:pop       si
         pop       cx
         pop       ax
         ret

; -----------------------------------------------------------------------------
;        Zobrazen¡ znaku DOS
; -----------------------------------------------------------------------------

PUBLIC   DispCh
DispCh:  push      ax
         push      dx
         mov       dl,al                    ; znak k zobrazen¡
         mov       ah,2                     ; funkce zobrazen¡ znaku
         int       21h                      ; zobrazen¡ znaku
         pop       dx
         pop       ax
         ret




code     ends

; -----------------------------------------------------------------------------
;        Data
; -----------------------------------------------------------------------------

Data     SEGMENT

TabOper  label     byte                   ;* tabulka oper tor–

         db        1,'('                    ; 1
         db        1,')'                    ; 2
         db        1,'^'                    ; 3
         db        1,'*'                    ; 4
         db        1,'/'                    ; 5
         db        3,'MOD'                  ; 6
         db        2,'<<'                   ; 7
         db        2,'>>'                   ; 8
         db        1,'+'                    ; 9
         db        1,'-'                    ; 10
         db        1,'='                    ; 11
         db        2,'<>'                   ; 12
         db        1,'<'                    ; 13
         db        1,'>'                    ; 14
         db        2,'<='                   ; 15
         db        2,'>='                   ; 16
         db        3,'NOT'                  ; 17
         db        3,'AND'                  ; 18
         db        2,'OR'                   ; 19
         db        3,'XOR'                  ; 20
         db        0


; Za ka‘d˜m p©¡kazem mus¡ b˜t uveden znak st©edn¡ku ";" (= konec p©¡kazu).
; Vnit©n¡ oddˆlova‡e ‡ st¡ konstrukc¡: THEN, ELSE, ENDIF, DO uvnit© FOR, ENDDO,
;                                      IN, OUT, ENDCASE, ENDPROC;
; - za p©¡kazem p©ed vnit©n¡m oddˆlova‡em se nep¡¨e st©edn¡k.
;
; znak ? = speci ln¡ hodnota 8000h=-32768, u nˆkter˜ch p©¡kaz– zp–sob¡, ‘e
;          se tato hodnota nenastav¡ (nap©. definice jen nˆkter˜ch palet)

; -----------------------------------------------------------------------------
; Podm¡nˆn‚ vˆtven¡:
;     IF c THEN [s1; s2; ... sn] [ELSE [s1; s2; ... sn]] ENDIF;
;
; V¡cen sobn‚ vˆtven¡:
;     CASE e
;     IN [a1..a2 | a]: [s1; s2; ... sn]
;     .....
;     [OUT [s1; s2; ... sn]
;     ENDCASE;
;
; Cyklus:
;    [FOR v [:= e1] [TO e2] [STEP e3]] DO
;           [s1; s2; ... sn;]
;    [WHILE c;]
;           [s1; s2; ... sn;]
;    [WHILE c;]
;           .....
;           [s1; s2; ... sn]
;    ENDDO;
;
; Definice procedury:
;    PROC p;
;           [s1; s2; ... sn;]
;           [RETURN[(e)];]
;           ....
;           [s1; s2; ... sn]
;    ENDPROC;
;
; Pou‘it‚ symboly:
;    a1, a2, a - ‡¡seln‚ konstanty
;    c - podm¡nka
;    e - v˜raz
;    s - p©¡kaz
;    v - promˆnn 
;    p - jm‚no procedury
; -----------------------------------------------------------------------------

TabKey   label     byte                   ;* tabulka kl¡‡ov˜ch slov
                                            ; FF: u‘ivatelsk  procedura

                                            ; FB: naplnˆn¡ WORD s indexem
                                            ; FA: naplnˆn¡ BYTE s indexem
                                            ; F9: naplnˆn¡ WORD
                                            ; F8: naplnˆn¡ BYTE


                                          ;* povoleno jen na konci programu

         db        4,'LINK'                 ;  0: p©ilinkov n¡ objektu
         dw        offset XLink

                                          ;* povoleno kdykoliv

         db        7,'include'              ;  (1: vno©en¡ vstupn¡ho souboru)
         dw        offset XInclud

                                          ;* povoleno jen na za‡ tku programu

         db        4,'BYTE'                 ;  2: definice promˆnn‚ bajt–
         dw        offset XByte
         db        4,'WORD'                 ;  3: definice promˆnn‚ slov
         dw        offset XWord
         db        6,'string'               ;  (4: definice ©etˆzcov‚ promˆnn‚)
         dw        offset XString

                                          ;* povoleno na za‡ tku i uvnit©

         db        4,'PROC'                 ;  5: definice procedury
         dw        offset XProc

                                          ;* povoleno uvnit© procedur

         db        7,'ENDPROC'              ;  6: konec definice procedury
         dw        offset XEndp
         db        6,'RETURN'               ;  7: n vrat z procedury
         dw        offset XRet
         db        4,'exec'                 ;  8: proveden¡ p©¡kazu DOS
         dw        offset XExec

         db        2,'IF'                   ;  9: identifik tor podm¡nky
         dw        offset XIf
         db        4,'THEN'                 ; 10: za‡ tek p©¡kaz– - podm¡nka splnˆna
         dw        offset XThen
         db        4,'ELSE'                 ; 11: za‡ tek p©¡kaz– - podm. nesplnˆna
         dw        offset XElse
         db        5,'ENDIF'                ; 12: konec podm¡nky IF
         dw        offset XEndif

         db        3,'for'                  ; 13: cyklus s parametrem
         dw        offset XFor
         db        2,'to'                   ; 14: podm¡nka konce cyklu
         dw        offset XTo
         db        4,'step'                 ; 15: krok cyklu s parametrem
         dw        offset XStep

         db        2,'DO'                   ; 16: cyklus s podm¡nkou
         dw        offset XDo
         db        2,'ON'                   ; 17: podm¡nka cyklu
         dw        offset XOn
         db        5,'ENDDO'                ; 18: konec cyklu
         dw        offset XEnddo

         db        4,'EXIT'                 ; 19: p©ed‡asn‚ ukon‡en¡ cyklu
         dw        offset XExit

         db        4,'CASE'                 ; 20: v¡cen sobn‚ vˆtven¡
         dw        offset XCase
         db        2,'IN'                   ; 21: podm¡nka intervalu nebo hodnoty
         dw        offset XIn
         db        3,'OUT'                  ; 22: podm¡nka nesplnˆn¡ ‘ dn‚ hodnoty
         dw        offset XOut
         db        7,'ENDCASE'              ; 23: konec vˆtven¡ CASE
         dw        offset XEndCase

                                          ;* povoleno jako funkce
         db        3,'val'                  ; 24: p©evod ©etˆzce na ‡¡slo
         dw        offset XVal
         db        3,'str'                  ; 25: p©evod ‡¡sla na ©etˆzec
         dw        offset XStr
         db        3,'len'                  ; 26: zji¨tˆn¡ d‚lky ©etˆzce
         dw        offset XLen
         db        4,'CARD'                 ; 27: test grafick‚ karty
         dw        offset XCard
         db        5,'VIDEO'                ; 28: nastaven¡ videom¢du
         dw        offset XVideo
         db        8,'getvideo'             ; 29: zji¨tˆn¡ videom¢du
         dw        offset XGVideo
         db        4,'MODE'                 ; 30: nastaven¡ m¢du displeje
         dw        offset XMode
         db        4,'PAGE'                 ; 31: nastaven¡ str nek displeje
         dw        offset XPage
         db        5,'XPAGE'                ; 32: p©epnut¡ str nek displeje
         dw        offset XXPage
         db        6,'WINDOW'               ; 33: definice v˜stupn¡ho okna
         dw        offset XWind
         db        7,'PALETTE'              ; 34: definice palet displeje
         dw        offset XPal
         db        6,'XCOLOR'               ; 35: z mˆna barvy v oknˆ
         dw        offset XXCol
         db        7,'SETCURS'              ; 36: nastaven¡ pozice kurzoru
         dw        offset XSetCur
         db        7,'CURSOFF'              ; 37: vypnut¡ kurzoru
         dw        offset XCurOff
         db        4,'LOAD'                 ; 38: na‡ten¡ objektu ze souboru
         dw        offset XLoad
         db        3,'PIC'                  ; 39: zobrazen¡ objektu
         dw        offset XObj
         db        6,'UNLOAD'               ; 40: zru¨en¡ objektu z pamˆti
         dw        offset XUnld
         db        4,'TEXT'                 ; 41: zobrazen¡ textu
         dw        offset XText
         db        5,'POINT'                ; 42: zobrazen¡ bodu
         dw        offset XPoint
         db        4,'LINE'                 ; 43: zobrazen¡ ‡ ry
         dw        offset XLine
         db        5,'RLINE'                ; 44: zobrazen¡ ‡ ry relativnˆ
         dw        offset XRline
         db        3,'BOX'                  ; 45: zobrazen¡ opbd‚ln¡ku
         dw        offset XBox
         db        4,'FBOX'                 ; 46: zobrazen¡ pln‚ho obd‚ln¡ku
         dw        offset XFBox
         db        4,'CIRC'                 ; 47: zobrazen¡ kru‘nice
         dw        offset XCirc
         db        5,'FCIRC'                ; 48: zobrazen¡ pln‚ kru‘nice
         dw        offset XFCirc
         db        5,'PRESS'                ; 49: test ur‡it‚ kl vesy na stisk
         dw        offset XPress
         db        7,'TESTKEY'              ; 50: test p©ipraven‚ kl vesy
         dw        offset XTstKey
         db        6,'GETKEY'               ; 51: vstup znaku z kl vesnice
         dw        offset XGtKey
         db        7,'STATKEY'              ; 52: stavov‚ slovo kl vesnice
         dw        offset XStatKey
         db        5,'INPUT'                ; 53: vstup textu
         dw        offset XInp
         db        5,'SOUND'                ; 54: ovl d n¡ zvukov‚ho gener toru
         dw        offset XSound
         db        3,'TON'                  ; 55: zahr n¡ t¢nu dan‚ frekvence
         dw        offset XTon
         db        5,'MUSIC'                ; 56: zahr n¡ melodie
         dw        offset XMusic
         db        9,'MUSICSTOP'            ; 57: zastaven¡ hry melodie
         dw        offset XMStop
         db        8,'MUSICGET'             ; 58: poskytnut¡ ukazatele melodie
         dw        offset XMusGet
         db        4,'WAIT'                 ; 59: ‡ek n¡ po danou dobu
         dw        offset XWait
         db        4,'TIME'                 ; 60: poskytnut¡ syst‚mov‚ho ‡asu
         dw        offset XTime
         db        4,'DATE'                 ; 61: poskytnut¡ syst‚mov‚ho data
         dw        offset XDate
         db        6,'XMOUSE'               ; 62: poskytnut¡ pozice my¨i
         dw        offset XXMous
         db        6,'YMOUSE'               ; 63: poskytnut¡ linky my¨i
         dw        offset XYMous
         db        8,'GETMOUSE'             ; 64: poskytnut¡ tla‡¡tek my¨i
         dw        offset XKMous
         db        7,'MOUSEON'              ; 65: zapnut¡ kurzoru my¨i
         dw        offset XMon
         db        8,'MOUSEOFF'             ; 66: vypnut¡ kurzoru my¨i
         dw        offset XMoff
         db        8,'CURMOUSE'             ; 67: definice kurzoru my¨i
         dw        offset XDefm
         db        8,'WINMOUSE'             ; 68: definice okna my¨i
         dw        offset XWinm
         db        3,'RND'                  ; 69: gener tor n hodn‚ho ‡¡sla
         dw        offset XRnd
         db        8,'REGISTER'             ; 70: nastaven¡ registru CRT
         dw        offset XReg
         db        4,'HSYN'                 ; 71: horizont ln¡ synchronizace
         dw        offset XHSyn
         db        4,'VSYN'                 ; 72: vertik ln¡ synchronizace
         dw        offset XVSyn
         db        7,'PATTERN'              ; 73: vzorek v˜plnˆ
         dw        offset XPatt
         db        5,'STICK'                ; 74: joystickov˜ vstup
         dw        offset XStick
         db        4,'TRIG'                 ; 75: aktiva‡n¡ tla‡¡tko joysticku
         dw        offset XTrig
         db        3,'SIN'                  ; 76: funkce SINUS
         dw        offset XSin
         db        3,'COS'                  ; 77: funkce COSINUS
         dw        offset XCos
         db        3,'TAN'                  ; 78: funkce Tangens
         dw        offset XTan
         db        3,'ABS'                  ; 79: absolutn¡ hodnota
         dw        offset XAbs
         db        3,'ATN'                  ; 80: ArcTangent
         dw        offset XAtn
         db        3,'SQR'                  ; 81: odmocnina
         dw        offset XSqr

         db        0                        ; identifikace konce tabulky

; ------ £vodn¡ a z kladn¡ chybov  hl ¨en¡

UvTxt    db        'ANIM V 1.00 - graficka animace;  (c) Miroslav Nemecek',13,10,'$'

MemTxt   db        'Chyba - nedostatek pameti !',13,10,'$'
Mem1Txt  db        'Chyba - preteceni tabulky symbolu !',13,10,'$'
Mem2Txt  db        'Chyba - preteceni datoveho modulu !',13,10,'$'
Mem3Txt  db        'Chyba - preteceni programoveho modulu !',13,10,'$'
ZdrojTxt db        'Zadejte specifikaci zdrojoveho souboru !',13,10,'$'
FndTxt   db        'Chybne zadani zdrojoveho souboru !',13,10,'$'
CilTxt   db        'Vystupni soubor .EXE nelze vytvorit'
Err0Txt  db        ' !'
UvTxt1   db        13,10,'$'
WritTxt  db        'Chyba zapisu do vystupniho souboru !',13,10,'$'
ErrMain  db        'Nebyla definovana procedura MAIN',13,10,'$'
ErrClos  db        'Procedura neni uzavrena !',13,10,'$'

FreeTxt  db        13,10,'Volna pamet: program $'
FreeTxt1 db        ', data $'
FreeTxt2 db        ', symboly $'
FreeTxt3 db        13,10,'$'

ProgLev  db        0                        ; £rove¤ zpracov n¡ programu
                                            ;  0=deklara‡n¡ ‡ st promˆnn˜ch
                                            ;  1=programov  ‡ st - uzav©eno PROC
                                            ;  2=programov  ‡ st - otev©eno PROC
                                            ;  3=konec programu - LINK
ParMain  db        0                        ; p©¡znak, ‘e byla hlavn¡ porcedura
LastIdn  db        0                        ; posledn¡ identifik tor

SegPSP   dw        0                        ; segment PSP

; ------ obsluha chyb p©ekladu

Err000   db        'Pocet chyb : $'

Err001   db        'Neplatne symbolicke jmeno',0
Err002   db        'Jmeno % nedefinovano',0
Err003   db        '% smi byt jen v deklaracni casti',0
Err004   db        'Chybny zapis pro naplneni promenne',0
Err005   db        'Chybny zapis vyrazu',0
Err007   db        'Za prikazem LINK nesmi nasledovat program',0
Err008   db        '% nesmi byt uvnitr procedury',0
Err009   db        'Vicenasobne pouziti jmena %',0

Err010   db        'Procedura neni uzavrena',0
Err011   db        '% musi byt uvedeno v procedure',0
Err012   db        'Neplatne jmeno objektu',0
Err013   db        'Jmeno % je rezervovano',0
Err014   db        'Chybne zadani dimenze promenne %',0
Err015   db        'Chyba syntaxe prikazu LINK',0
Err016   db        'Chybne jmeno souboru',0
Err017   db        'Chybne zadani jmena programu ke startu',0
Err018   db        'Neplatne jmeno procedury',0
Err019   db        '% nesmi byt v deklaracni casti',0
Err01a   db        'Za prikazem chybi strednik',0
Err01b   db        'Chybny argument prikazu',0
Err01c   db        'Prilis mnoho udaju',0

Err020   db        'Podminka IF neuzavrena',0
Err021   db        'Za IF musi nasledovat THEN',0
Err022   db        '% bez podminky IF',0
Err023   db        'THEN musi nasledovat za podminkou IF',0
Err025   db        '% nelze uvest vicenasobne',0

Err030   db        'Cyklus DO neuzavren',0
Err031   db        '% bez zacatku cyklu DO',0
Err032   db        'Za ON musi nasledovat EXIT',0
Err033   db        'EXIT smi byt pouze za ON',0

Err040   db        'Vicenasobne vetveni CASE neuzavreno',0
Err041   db        '% bez CASE',0
Err043   db        '% nelze uvest po OUT',0
Err044   db        'Vetev % jiz byla pouzita',0
Err045   db        '% bez CASE',0
Err046   db        'Za CASE musi nasledovat IN',0
Err047   db        'Chybne meze pro IN',0

ErrARad  dd        0                        ; £schova ukazatele chybov‚ho © dku
ErrNRad  dw        0                        ; £schova ‡¡sla chybov‚ho © dku
ErrRad   db        256 dup(0)               ; text chybov‚ho © dku
RetClose dw        0                        ; £schova n vrat. adresy uzav©en¡
RetDisp  dw        0                        ; £schova n vrat. adresy zobrazen¡
RetComp  dw        0                        ; n vratov  adresa do kompil toru
RetPush  dw        0                        ; n vratov  adresa z £schovy reg.
RetProc  dw        0                        ; n vratov  adresa z £schovy PROC
CitChyb  dw        0                        ; ‡¡ta‡ chyb p©ip©ekladu

; ------ ukazatele pro spojov n¡ modul– LINK

LinkId   dw        0                        ; identifik tor zdrojov‚ho modulu

; ------ parametry pro gener tor melodie

Oktava   dw        0                        ; okt va
Krizky   dw        0                        ; ‡¡ta‡ k©¡‘k–
DelTon   db        0                        ; d‚lka t¢nu

; ------ buffer n vˆ¨t¡ a identifik tor–

BufOper  db        4 dup(0)                 ; buffer oper toru

DelIdent db        0                        ; d‚lka n vˆ¨t¡ (dodr‘et po©ad¡ !)
BufIdent db        64 dup(0)                ; buffer n vˆ¨t¡

FlagBuf  dw        0                        ; segment s tabulkou n vˆ¨t¡
FlagNum  dw        0                        ; po‡et bajt– v tabulce n vˆ¨t¡

; ------ v˜stupn¡ buffer (velikost 64 KB)

ProgSeg  dw        SEG Interp               ; segment s programem
ProgNum  dw        2                        ; po‡et bajt– programu



SizProg  dw        0                        ; po‡et bajt– programu
SizDat   dw        0                        ; po‡et bajt– v dat. segmentu

; ------ vstupn¡ buffer (velikost 2000h bajt–)

SrcBuf   dw        0                        ; segment vstupn¡ho bufferu
SrcUkaz  dw        0                        ; ukazatel ve vstupn¡m bufferu
SrcNum   dw        0                        ; po‡et zbyl˜ch znak– vstup. bufferu
UkazCh   dd        0                        ; ukazatel znak– v souboru
UkazRad  dd        0                        ; ukazatel za‡ tku © dku v souboru
CitRad   dw        1                        ; ‡¡ta‡ © dk– v souboru
SrcEnd   db        0                        ; 1=p©¡znak konce souboru

BuffChU  dw        0                        ; po‡et bajt– v p©echodn‚m bufferu
BuffCh   db        64 dup(0)                ; p©echodn˜ buffer

; ------ obsluha soubor–

SoubLinn db        0                        ; po‡et bajt– jm‚na souboru
SoubLink db        128 dup(0)               ; pracovn¡ soubor

PripAni  db        '.ANI',0                 ; p©¡pona anima‡n¡ho zdroj. souboru
PripExe  db        '.EXE',0                 ; p©¡pona v˜stupn¡ho souboru
Soubor   db        128 dup(0)               ; buffer k ulo‘en¡ jm‚na souboru

CilSize  dd        0                        ; velikost v˜stupn¡ho souboru
ZdrojId  dw        0                        ; identifik tor zdrojov‚ho souboru
CilId    dw        0                        ; identifik tor c¡lov‚ho souboru


Konec    label     byte                     ; ukazatel konce programu

Data     ENDS


; *****************************************************************************
;
;                  P©echodn˜ z sobn¡k pro kompil tor
;
; *****************************************************************************

Stack    SEGMENT   stack para

         dw        20h dup(0)               ; mus¡ b˜t nˆco definovan‚ !

Stack    ENDS


; *****************************************************************************
;
;        Segment s interpreterem programu (p©¡poj¡ se p©i kompilaci)
;
; *****************************************************************************

Interp   SEGMENT   para

Interp   ENDS

         END       Animc
