
                               ÿ8ÿ0ÿ8ÿ7
                          (c) Miroslav Nˆme‡ek


    Matematick˜  koprocesor  8087 je v˜konn˜ numerick˜ procesor, kter˜
dopl¤uje  standardn¡  instruk‡n¡  soubor  hlavn¡ho procesoru ©ady 86 o
aritmetick‚,  trigoniometrick‚,  exponenci ln¡  a logaritmick‚ funkce.
Operace je mo‘no prov dˆt s celo‡¡seln˜mi operandy r–zn˜ch form t–, ve
zobrazen¡  v  pohybliv‚ © dov‚ ‡ rce ‡i v BCD form tu. Obvod 8087 m–ze
spolupracovat  jako  matematick˜  procesor  s  hlavn¡mi procesory typu
8086,  8088,  80186  a  80188.  Jeho  v˜konnost  je  p©i matematick˜ch
operac¡ch a‘ ston sobnˆ vy¨¨¡ ne‘ v˜kon hlavn¡ho procesoru.

    Sou‡innost  koprocesoru  8087  s  hlavn¡m  procesorem,  kter˜ mus¡
pracovat   pracovat  v  maxim ln¡m  m¢du,  je  zalo‘ena  na  p©ed v n¡
instruk‡n¡ho  k¢du  ESC  spolu  s  p©ed n¡m  adres  operand–. Vz jemn 
synchronizace  ‡innost¡  je  zaji¨tˆna schopnost¡ koprocesoru sledovat
tok  instrukc¡,  kter‚  CPU vyzved v  z pamˆti. €innost koprocesoru je
odstartov na p©evzet¡m instrukce ESC. O p©–bˆhu operace informuje 8087
hlavn¡  procesor  sign lem BUSY na vstupu /TEST. CPU ‡ek  na proveden¡
operace  koprocesoru  v  instrukci WAIT. Koprocesor m–‘e vyslat sign l
p©eru¨en¡ p©i detekci chyby v˜po‡tu nebo vyj¡me‡n‚ho stavu.

    Typy dat 8087:
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÂÄÄÂÄÄÂÄÄÂÄÄÂÄÄÂÄÄÂÄÄÂÄÄÂÄÄ¿
 ³ form t dat    ³ rozsah  ³ p©esnost ³10³ 9³ 8³ 7³ 6³ 5³ 4³ 3³ 2³ 1³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÁÄÄÁÄÄÁÄÄÁÄÄÁÄÄÁÄÄÁÄÄÁÄÄÁÄÄ´
 ³Byte Integer   ³  102    ³  8 bit–  ³70³                          ³
 ³Word Integer   ³  104    ³ 16 bit–  ³15--0³                       ³
 ³Short Integer  ³  109    ³ 32 bit–  ³31--------0³                 ³
 ³Long Integer   ³  1018   ³ 64 bit–  ³63--------------------0³     ³
 ³Packed BCD     ³  1018   ³18 ‡¡slic ³S D17----------------------D0³
 ³Short Real     ³  10ñ38  ³ 24 bit–  ³S E7-0 F1-23³                ³
 ³Long Real      ³ 10ñ308  ³ 53 bit–  ³S E10-0 F1----------F52³     ³
 ³p©echodn˜ Real ³ 10ñ4932 ³ 64 bit–  ³S E14-0 F0----------------F63³
 ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
  Exponent pro REAL je posunut˜ o polovinu sv‚ hodnoty.

    V¨echna  ‡¡sla  uvnit©  8087  jsou  v  p©echodnˆ  re ln‚m form tu.
Instrukce  naplnˆn¡ a ulo‘en¡ dat automaticky p©ev d¡ operandy ulo‘en‚
v  pamˆti  v  ur‡it‚m  form tu  na p©echodn˜ re ln˜ form t a zpˆt. Pro
v˜po‡ty pou‘¡v  8087 z sobn¡k o velikosti 8 10-bajtov˜ch registr–.

    Po  inicializaci  sign lem  RESET  ur‡¡  koprocesor automaticky ze
stavu  sign lu  BHE/S7,  zda  je  hlavn¡  procesor  typu 8086/186 nebo
8088/188  a  podle toho p©izp–sob¡ d‚lku instruk‡n¡ fronty. Sledov n¡m
stavu  fronty instrukc¡ z¡sk v  a dek¢duje instrukce synchronnˆ s CPU.
CPU  rozli¨¡ instrukci ESC s odkazem na pamˆŸ, vypo‡te adresu operandu
a  prov d¡  form lnˆ ‡ten¡ operandu z ur‡en‚ fyzick‚ adresy (data v¨ak
ignoruje).  Koprocesor zachyt¡ tuto adresu a p©¡padnˆ p©evezme i ‡ten 
data.  €ten¡  dal¨¡ch  bajt–  dat  nebo  z pis  do pamˆti prov d¡ 8087
vlastn¡m p©¡stupem na sbˆrnici.

    ›¡©ka  vnit©n¡ sbˆrnice 8087 je 84 bit– - 68 bit– mantisa, 15 bit–
exponent a 1 bit znam‚nko.

    Po  dobu  prov dˆn¡  operace  je  aktivn¡  indika‡n¡  v˜stup  BUSY
pou‘¡van˜ pro synchronizaci sou‡innosti s hlavn¡m procesorem.



                       Univerz ln¡ registry 8087

    Pole  univerz ln¡ch  registr– 8087 obsahuje 8 80-bitov˜ch registr–
se z sobn¡kovou organizac¡. Operandy jsou v nich uspo© d ny ve form tu
pohybliv‚  © dov‚ ‡ rky (bit 79=znam‚nko, bity 64 a‘ 78=exponent, bity
0  a‘  63=mantisa).  P©i  implicitn¡m  adresov n¡  pou‘¡v   8087  toho
registru, kter˜ je pr vˆ ozna‡en za vrchol z sobn¡ku. Ukazatel vrcholu
z sobn¡ku  je  obsa‘en v 3-bitov‚m poli (TOP) stavov‚ho registru 8087.
Z sobn¡k  je  plnˆn  od  registr–  s vy¨¨¡ adresou k registr–m s ni‘¨¡
adresou.

                         P©¡znakov‚ slovo 8087

    Ka‘d‚mu  univerz ln¡mu registru v z sobn¡ku je p©i©azen dvoubitov˜
p©¡znakov˜  registr,  kter˜m  je  indikov n posledn¡ stav jeho obsahu.
P©¡znaky  stavu  z sobn¡kov˜ch  registr–  jsou  uspo© d ny  do jednoho
16-bitov‚ho  slova (bity 0 a 1 = stav registru 0, ..... bity 14 a 15 =
stav registru 7). P©¡znak registru m–‘e nab˜vat hodnot: 0=data platn ,
1=nula, 2=speci ln¡, 3=pr zdn˜.


                          Stavov‚ slovo 8087

    Celkov˜  stav 8087 se odr ‘¡ v 16-bitov‚m stavov‚m slovu:
                                        ÚÄÄÄÄÄÄ vyj¡m. stav ÄÄÄÄ¿
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
ÚÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄ¿
³ B ³ C3³ T   O   P ³ C2³ C1³ C0³ IR³ . ³ PE³ UE³ OE³ ZE³ DE³ IE³
ÀÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÙ
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   neplatn 
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ‡innost
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   (Ilegal)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   denormaliz.
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   operand
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   dˆlen¡ 0 (Zero)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   p©ete‡en¡ (Overfl.)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   podte‡en¡ (Un.)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   p©esnost
  ³   ³   ³   ³   ³   ³   ³   ³   ³   rezervov no
  ³   ³   ³   ³   ³   ³   ³   ³   ‘ dost o p©eru¨en¡ (nastaven, je-li
  ³   ³   ³   ³   ³   ³   ³   ³   nastaven libovoln˜ nemaskovan˜ bit
  ³   ³   ³   ³   ³   ³   ³   ³   v˜jime‡n‚ho stavu) (Inter. Request)
  ³   ÀÄÄÄÅÄÄÄÅÄÄÄÅÄÄÄÁÄÄÄÁÄÄÄÁpodm¡nkov˜ k¢d (Condition)
  ³       ÀÄÄÄÁÄÄÄÁvrchol ukazatele z sobn¡ku (Top)
  opera‡n¡ jednotka v ‡innosti (Busy)


                           ¡dic¡ slovo 8087

    ¡dic¡ slovo umo‘¤uje nastavit re‘im ‡innosti 8087.

                                        ÚÄÄÄ masky vyj. stavu ÄÄ¿
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
ÚÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄÂÄÄÄ¿
³ .   .   . ³ IC³ R   C ³ P   C ³ M ³ . ³ PM³ UM³ OM³ ZM³ DM³ IM³
ÀÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÁÄÂÄÙ
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   neplatn 
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ‡innost
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   (Ileg.)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   denormaliz.
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   operand
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   dˆlen¡ 0 (Zero)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   p©ete‡en¡ (Overfl.)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   podte‡en¡ (Un.)
  ³   ³   ³   ³   ³   ³   ³   ³   ³   ³   p©esnost
  ³   ³   ³   ³   ³   ³   ³   ³   ³   rezervov no
  ³   ³   ³   ³   ³   ³   ³   ³   maska p©eru¨en¡ (1=p©er. maskov no)
  ³   ³   ³   ³   ³   ³   ÀÄÄÄÁ©¡zen¡ p©esnosti (Pr. Ctr.)
  ³   ³   ³   ³   ³   ³        (00=24 b., 01=rez., 10=53 b., 11=64 b.)
  ³   ³   ³   ³   ÀÄÄÄÁ©¡zen¡ zaokrouhlen¡ (Ro. Ctr.)
  ³   ³   ³   ³        00=na nejbli‘¨¡/sud˜, 01=dol–, 10=nahoru
  ³   ³   ³   ³        11=osek no smˆrem k nule
  ³   ³   ³   À©¡zen¡ nekone‡na (0=pr–mˆtov‚, 1=sty‡n‚)
  ÀÄÄÄÁÄÄÄÁrezervov no


                       Ukazatel‚ instrukc¡ a dat

    Po  vniku  chybov‚ho  stavu  je  mo‘n‚ p©esunout informace o stavu
8087 do pamˆti:

 Offset:
  + 0 (2 bajty)         ©¡dic¡ slovo
  + 2 (2 bajty)         stavov‚ slovo
  + 4 (2 bajty)         p©¡znakov‚ slovo
  + 6 (2 bajty)         ukazatel instrukc¡ (0-15)
  + 8 (2 bajty)         ukazatel instrukc¡ (bity 12-15 = 16-19)
                        0 (bit 11)
                        oper. k¢d instrukce (bity 0-10 = 0-10)
 + 10 (2 bajty)         ukazatel dat (0-15)
 + 12 (2 bajty)         ukazatel dat (bity 12-15 = 16-19)
