
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;                                D I S K F
;                 obsluha diskov˜ch za©¡zen¡ - soubory
;
; =============================================================================
;
; Ve©ejn‚ procedury:
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°

INCLUDE  ASM\DEF.ASM

CodeDisk SEGMENT   BYTE PUBLIC
         ASSUME    cs:CodeDisk,ds:Data

; *****************************************************************************
;                                 NulDErr
;                        Nulov n¡ registru diskov‚ chyby
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; *****************************************************************************

NulDErr  PROC      FAR

         mov       word ptr ds:[LastErr],0
         ret

NulDErr  ENDP

; *****************************************************************************
;                               InitDPar
;                  inicializace tabulky diskov˜ch parametr–
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; -----------------------------------------------------------------------------
; lok ln¡ promˆnn‚: [BP-1] (1) uschovan˜ p–vodn¡ aktivn¡ disk
;                   [BP-2] (1) ukazatel ‡¡sla disku
;                   [BP-4] (2) ukl dac¡ adresa do tabulky disk–
;                   [BP-44h] (40h) buffer bloku parametr– disku
; *****************************************************************************

InitDPar PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      bp
         push      es

; ------ £schova registr–

         mov       bp,sp
         sub       sp,44h                   ; buffer v z sobn¡ku

; ------ £schova aktivn¡ho disku

         call      far ptr GetDisk         ; poskytnut¡ aktivn¡ho disku
         cmp       al,DiskMax
         jb        InitDPr0
         mov       al,2                     ; implicitnˆ disk C:
InitDPr0:mov       ss:[bp-1],al             ; £schova aktivn¡ho disku

; ------ p©¡prava registr–

         mov       byte ptr ss:[bp-2],0     ; ukazatel ‡¡sla disku
         mov       word ptr ss:[bp-4],offset DiskITab ; ukl dac¡ adresa do tab.
         mov       word ptr ds:[DiskNum],0  ; po‡et disk–

; ------ test, zda je disk platn˜ (zda lze nastavit)

InitDPr1:mov       al,ss:[bp-2]             ; ‡¡slo disku
         mov       di,ss:[bp-4]             ; ukl dac¡ adresa do tabulky
         mov       byte ptr ds:[di],0       ; neplatn˜ disk
         call      far ptr SetDisk         ; pokus o nastaven¡ disku
         jnc       InitDPr2                 ; disk je platn˜
         jmp       InitDPr7                 ; dal¨¡ disk
InitDPr2:inc       byte ptr ds:[DiskNum]    ; zv˜¨en¡ ‡¡ta‡e disk–

; ------ stanoven¡ atributu v˜mˆnosti disku AL

InitDP21:cmp       byte ptr ds:[VerzeOS+1],3 ; je verze DOS 3.00 nebo vy¨¨¡ ?
         jb        InitDP22                 ; je n¡zk  verze syst‚mu
         xchg      ax,bx                    ; BL <- po‘adovan˜ disk
         inc       bx                       ; korekce ‡¡sla disku
         mov       ax,4408h
         int       21h                      ; je disk v˜mˆnn˜ ?
         shl       al,1                     ; 2=pevn˜ disk, 0=v˜mˆnn˜ disk
InitDP22:mov       byte ptr ds:[di],1       ; typ - disketa
         cmp       al,2                     ; disk A nebo B / v˜mˆnn˜ disk ?
         jb        InitDP25                 ; je disk A nebo B nebo v˜mˆnn˜ disk
         mov       byte ptr ds:[di],2+bit6  ; jinak z©ejmˆ pevn˜ disk

; ------ stanoven¡ atributu d lkov‚ho za©¡zen¡ a SUBST (disk BL)

InitDP25:cmp       word ptr ds:[VerzeOS],3*HI+10 ; je verze DOS 3.10 nebo vy¨¨¡ ?
         jb        InitDPr3                 ; je n¡zk  verze syst‚mu
         xor       dx,dx                    ; DX <- 0 p©ednastaven¡ atribut–
         mov       ax,4409h
         int       21h                      ; je disk lok ln¡ ?
         jc        InitDPr3                 ; chyba - asi neplatn  funkce

         mov       al,dh                    ; atributy disku
         test      al,bit12/HI              ; je disk lok ln¡ ?
         jz        InitDP26                 ; disk je lok ln¡
         or        byte ptr ds:[DiskITbP],bit0 ; nalezen s¡Ÿov˜ disk
         and       byte ptr ds:[di],bit6    ; atribut pevn‚ho disku
         or        byte ptr ds:[di],4+bit4+bit5 ; typ - s¡Ÿov˜ disk
         jmp       short InitDPr4           ; je d lkov˜ disk

InitDP26:and       al,(bit12+bit13+bit15)/HI ; jen pot©ebn‚ atributy
         or        ds:[di],al               ; nov‚ atributy
         test      al,bit15/HI              ; je disk SUBST ?
         jz        InitDPr3                 ; nen¡ SUBST
         and       byte ptr ds:[di],not bit0+bit1+bit2
         or        byte ptr ds:[di],5+bit5  ; SUBST disk (nen¡ diskov  editace)

; ------ detekce RAM disku

InitDPr3:cmp       word ptr ds:[VerzeOS],3*HI+20 ; minim ln¡ verze 3.20
         jb        InitDPr4                 ; je n¡zk  verze syst‚mu
         test      byte ptr ds:[di],bit7    ; je SUBST disk ?
         jnz       InitDPr4                 ; je SUBST disk
         test      byte ptr ds:[di],bit6    ; je pevn˜ disk ?
         jz        InitDPr4                 ; nen¡ pevn˜ disk

         mov       dx,sp                    ; buffer v z sobn¡ku
         push      ds
         push      di
         push      ss
         pop       ds                       ; DS <- SS buffer v z sobn¡ku
         mov       si,ds                    ; SI <- DS pro OS/2
         mov       di,dx                    ; DI <- DX pro OS/2
         mov       bh,0
         mov       bl,ss:[bp-2]             ; ‡¡slo disku
         inc       bx                       ; korekce ‡¡sla disku
         mov       byte ptr ds:[di],bit2    ; dopl¤uj¡c¡ funkce
         mov       cx,860h                  ; podfunkce - poskytnut¡ parametr–
         mov       ax,440dh
         clc                                ; p©ednastaven¡
         int       21h
         pop       di
         pop       ds
         jnc       InitDPr4                 ; podporuje IOCTL
         mov       byte ptr ds:[di],3+bit6  ; je z©ejmˆ RAM disk

; ------ p©¡prava pro dal¨¡ disk

InitDPr4:
InitDPr7:inc       word ptr ss:[bp-4]       ; posun adresy na dal¨¡ disk
         inc       byte ptr ss:[bp-2]       ; zv˜¨en¡ ‡¡sla disku
         cmp       byte ptr ss:[bp-2],DiskMax ; jsou ji‘ v¨echny disky ?
         jae       InitDPr8                 ; jsou ji‘ v¨echny disky
         jmp       InitDPr1                 ; test dal¨¡ho disku

; ------ n vrat p–vodn¡ho aktivn¡ho disku

InitDPr8:mov       al,ss:[bp-1]             ; p–vodn¡ aktivn¡ disk
         call      far ptr SetDisk         ; nastaven¡ p–vodn¡ho aktiv. disku

; ------ pokud nebyl ani jeden disk, bude implicitnˆ 1 disk C:

         cmp       byte ptr ds:[DiskNum],0  ; byl alespo¤ 1 disk ?
         jne       IniDPr92                 ; je alespo¤ 1 disk
         inc       byte ptr ds:[DiskNum]    ; implicitn¡ 1 disk
         mov       byte ptr ds:[DiskITab+2],1 ; 1 disk C: (je to ale pt kovina)

; ------ 2 disketov‚ mechaniky, je-li pouze 1 mechanika

IniDPr92:call      DetLDMap                 ; korekce mapov n¡ logick˜ch disk–

; ------ detekce CD-ROM disku

IniDPr94:test      byte ptr ds:[DiskITbP],bit0 ; nalezen s¡Ÿov˜ disk ?
         jz        InitDPr9                 ; nenalezen
         call      IniCDRom                 ; inicializace CD-ROM

; ------ blokov n¡ voleb disku A: a B:

InitDPr9:and       word ptr ds:[FrmDMBlk],not bit1+bit1*HI ; disk A:,B: povolen
         and       word ptr ds:[RusDMBlk],not bit1+bit1*HI ; disk A:,B: povolen
         and       word ptr ds:[KopDMBlk],not bit1+bit1*HI ; disk A:,B: povolen
         and       word ptr ds:[KopD2Blk],not bit1+bit1*HI ; disk A:,B: povolen
         and       word ptr ds:[CmpDMBlk],not bit1+bit1*HI ; disk A:,B: povolen
         and       word ptr ds:[CmpD2Blk],not bit1+bit1*HI ; disk A:,B: povolen

         cmp       byte ptr ds:[DiskITab],0 ; je disk A: platn˜ ?
         jne       IniDPr96                 ; disk A: platn˜
         or        byte ptr ds:[FrmDMBlk],bit1 ; z kaz disku A:
         or        byte ptr ds:[RusDMBlk],bit1 ; z kaz disku A:
         or        byte ptr ds:[KopDMBlk],bit1 ; z kaz disku A:
         or        byte ptr ds:[KopD2Blk],bit1 ; z kaz disku A:
         or        byte ptr ds:[CmpDMBlk],bit1 ; z kaz disku A:
         or        byte ptr ds:[CmpD2Blk],bit1 ; z kaz disku A:

IniDPr96:cmp       byte ptr ds:[DiskITab+1],0 ; je disk B: platn˜ ?
         jne       IniDPr98                 ; disk B: platn˜
         or        byte ptr ds:[FrmDMBlk+1],bit1 ; z kaz disku B:
         or        byte ptr ds:[RusDMBlk+1],bit1 ; z kaz disku B:
         or        byte ptr ds:[KopDMBlk+1],bit1 ; z kaz disku B:
         or        byte ptr ds:[KopD2Blk+1],bit1 ; z kaz disku B:
         or        byte ptr ds:[CmpDMBlk+1],bit1 ; z kaz disku B:
         or        byte ptr ds:[CmpD2Blk+1],bit1 ; z kaz disku B:

; ------ n vrat registr–

IniDPr98:mov       sp,bp
         pop       es
         pop       bp
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

InitDPar ENDP

; -----------------------------------------------------------------------------
;        korekce mapov n¡ logick˜ch disk–
; -----------------------------------------------------------------------------

DetLDMap PROC      NEAR

         mov       al,byte ptr ds:[Vybaveni] ; vybaven¡
         and       al,bit0+bit6+bit7        ; p©¡znak disket
         cmp       al,bit0                  ; je 1 mechanika ?
         jne       DetLDMp9                 ; nen¡ jen 1 mechanika
         cmp       word ptr ds:[DiskITab],1+1*HI ; 2 mechaniky ?
         jne       DetLDMp9                 ; nejsou 2 mechaniky
         dec       byte ptr ds:[DiskNum]    ; sn¡‘en¡ po‡tu disk–

         mov       al,ss:[bp-1]             ; aktivn¡ disk
         mov       byte ptr ds:[DiskITab],0 ; 1. mechanika neplatn 
         cmp       al,1                     ; je aktivn¡ mechanika B: ?
         je        DetLDMp5                 ; aktivn¡ mechanika B:
         mov       word ptr ds:[DiskITab],1 ; 2. mechanika neplatn 
         jb        DetLDMp5                 ; aktivn¡ mechanika A:

         cmp       word ptr ds:[VerzeOS],3*HI+20 ; minim ln¡ verze 3.20
         jb        DetLDMp9                ; je n¡zk  verze syst‚mu
         mov       ax,440eh
         mov       bl,1                     ; disk A:
         int       21h                      ; poskytnut¡ mapov n¡ disku A:
         jc        DetLDMp9                 ; chyba
         cmp       al,1
         jbe       DetLDMp9                 ; mechanika A: nebo neplatn 
         mov       word ptr ds:[DiskITab],1*HI ; 1. mechanika neplatn 
         jmp       short DetLDMp9

DetLDMp5:cmp       word ptr ds:[VerzeOS],3*HI+20 ; minim ln¡ verze 3.20
         jb        DetLDMp9                 ; je n¡zk  verze syst‚mu
         xchg      ax,bx                    ; BL <- po‘adovan  mechanika
         inc       bx
         mov       ax,440fh
         int       21h                      ; nastaven¡ v˜mˆny disku

DetLDMp9:ret

DetLDMap ENDP

; -----------------------------------------------------------------------------
;        inicializace CD-ROM (vy‘aduje ovlada‡ verze minim lnˆ 2.00 !!!!)
; -----------------------------------------------------------------------------

IniCDRom PROC      NEAR

; ------ lok ln¡ buffer

         sub       sp,256                   ; buffer pro na‡ten¡ disk–

; ------ inicializace bufferu na nesmysly

         push      ss
         pop       es                       ; ES <- segment bufferu
         mov       di,sp                    ; DI <- offset bufferu
         mov       cx,256/2                 ; velikost bufferu / 2
         xor       ax,ax
         dec       ax                       ; AX <- -1
         cld
         rep       stosw                    ; vymaz n¡ bufferu

; ------ na‡ten¡ seznamu CD disk–

         mov       bx,sp                    ; BX <- offset bufferu
         mov       al,0dh                   ; funkce na‡ten¡ seznamu disk–
         call      far ptr IntCD            ; obsluha CD-ROM

; ------ korekce ozna‡en¡ disk–

         mov       si,sp                    ; SI <- buffer v z sobn¡ku
         mov       bh,0
IniCDRm2:mov       bl,ss:[si]               ; BL <- ‡¡slo disku
         inc       si                       ; zv˜¨en¡ ukazatele v bufferu
         cmp       bl,DiskMax               ; je to platn˜ disk ?
         jae       IniCDRm9                 ; nen¡ platn˜ disk (konec tabulky)

         mov       al,ds:[bx+DiskITab]      ; parametry disku
         and       al,bit0+bit1+bit2        ; typ disku
         cmp       al,4                     ; je to s¡Ÿov˜ disk ?
         jne       IniCDRm2                 ; nen¡ to s¡Ÿov˜ disk
         xor       byte ptr ds:[bx+DiskITab],4 xor 6 ; zmˆna na CD-ROM disk
         or        byte ptr ds:[DiskITbP],bit1 ; je ovlada‡ CD-ROM
         jmp       short IniCDRm2           ; dal¨¡ disk

; ------ n vrat z sobn¡ku

IniCDRm9:add       sp,256
         ret

IniCDRom ENDP

; *****************************************************************************
;                               IniDSKom
;               inicializace segmentu koment ©– k disk–m
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: CY=nedostatek pamˆti
; -----------------------------------------------------------------------------
; zni‡en‚ registry: AX, BX, CX, DI, ES
; *****************************************************************************
;þ
IniDSKom PROC      FAR

; ------ vytvo©en¡ datov‚ho bloku

;         and       byte ptr ds:[DiskInfP],not bit0+bit1+bit2+bit3 ; parametry
         call      far ptr CreatSeg         ; vytvo©en¡ datov‚ho bloku
         jc        IniDSKm9                 ; chyba pamˆti
         mov       ds:[DiskInfS],ax         ; segment datov‚ho bloku

; ------ nastaven¡ velikosti bloku

         mov       bx,2+DiskMax+1+1         ; inicializa‡n¡ velikost bloku
         call      far ptr ModiSegS         ; nastaven¡ velikosti bloku
         jc        IniDSKm9                 ; chyba pamˆti

; ------ adresa bufferu

         call      far ptr GetDat           ; poskytnut¡ adresy bufferu

; ------ inicializace ukazatel–

         xchg      ax,bx                    ; velikost dat v bufferu
         xor       di,di
         cld
         stosw                              ; slovo velikosti bloku
         mov       cx,(DiskMax+1+1)/2       ; po‡et disk–
         xor       ax,ax
         rep       stosw                    ; inicializace koment ©– k disk–m
;         clc                                ; NC = operace OK

IniDSKm9:ret

IniDSKom ENDP

; *****************************************************************************
;                                 InitIDsk
;                   inicializace z konfigura‡n¡ho souboru
;    (buffer koment ©– k disk–m mus¡ b˜t inicializov n na pr zdnˆ ©etˆzce !)
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; *****************************************************************************
;þ
InitIDsk PROC      FAR

; ------ nalezen¡ dal¨¡ho parametru

InitIDs1:call      far ptr NextLIni        ; dal¨¡ © dek
         jnc       InitIDs2                 ; je dal¨¡ © dek OK
IniIDs12:ret

InitIDs2:cmp       byte ptr es:[di],"["
         je        IniIDs12
         mov       si,di                    ; SI <- £schova adresy textu
         call      far ptr JumpPTxt

         db        6,'FLABEL'
         dw        IniIDs21

         db        7,'FVERIFY'
         dw        IniIDs24

         db        5,'FBEEP'
         dw        IniIDs25

         db        6,'FWRITE'
         dw        IniIDs26

         db        7,'EXTFORM'
         dw        IniIDs34

         db        7,'DISKEDI'
         dw        IniIDs41

         db        8,'DISKFORM'
         dw        IniIDs42

         db        7,'DISKLAB'
         dw        IniIDs43

         db        8,'DISKCOPY'
         dw        IniIDs44

         db        7,'DISKNUL'
         dw        IniIDs45

         db        7,'DISKDEL'
         dw        IniIDs46

         db        0
         dw        InitIDs7

; ------ zad n¡ jm‚na disku

IniIDs21:mov       ah,not bit0
         jmp       short IniIDs28

; ------ verifikace

IniIDs24:mov       ah,not bit1
         jmp       short IniIDs28

; ------ indikace konce

IniIDs25:mov       ah,not bit2
         jmp       short IniIDs28

; ------ testovac¡ z pis

IniIDs26:mov       ah,not bit3

IniIDs28:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniIDs29
         and       ds:[FormParm],ah         ; parametr vypnut
         jcxz      IniIDs29
         not       ah
         or        ds:[FormParm],ah         ; parametr zapnut
IniIDs29:jmp       InitIDs1

; ------ instalace roz¨¡©en˜ch form t–

IniIDs34:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniIDs29
         or        byte ptr ds:[Rez13Par],bit7 ; z kaz instalace
         jcxz      IniIDs29                 ; je z kaz instalace
         and       byte ptr ds:[Rez13Par],not bit7 ; instalace povolena
         jmp       short IniIDs29

; ------ povolen¡ editace disku

IniIDs41:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniIDs29
         or        byte ptr ds:[DMnuVBlk+1],bit0 ; z kaz editace disku
         jcxz      IniIDs29                 ; je z kaz editace disku
         and       byte ptr ds:[DMnuVBlk+1],not bit0 ; povolena editace disku
         jmp       short IniIDs29

; ------ povolen¡ form tov n¡ disket

IniIDs42:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniIDs29
         or        byte ptr ds:[DMnuVBlk+2],bit0 ; z kaz form tov n¡ disket
         jcxz      IniIDs29
         and       byte ptr ds:[DMnuVBlk+2],not bit0 ; povoleno form tov n¡ disket
         jmp       short IniIDs29

; ------ povolen¡ zmˆny jm‚na disku

IniIDs43:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniIDs29
         or        byte ptr ds:[DMnuVBlk+4],bit0 ; z kaz p©ejmenov n¡ disku
         jcxz      IniIDs29
         and       byte ptr ds:[DMnuVBlk+4],not bit0 ; povoleno p©ejmenov n¡ disku
IniID439:jmp       short IniIDs29

; ------ povolen¡ kop¡rov n¡ disket

IniIDs44:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniID439
         or        byte ptr ds:[DMnuVBlk+5],bit0 ; z kaz kop¡rov n¡ disket
         jcxz      IniID439
         and       byte ptr ds:[DMnuVBlk+5],not bit0 ; povoleno kop¡rov n¡ disket
         jmp       short IniID439

; ------ povolen¡ nulov n¡ disku

IniIDs45:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniID439
         or        byte ptr ds:[DMnuVBlk+7],bit0 ; z kaz nulov n¡ disku
         jcxz      IniID439
         and       byte ptr ds:[DMnuVBlk+7],not bit0 ; povoleno nulov n¡ disku
         jmp       short IniID439

; ------ povolen¡ ru¨en¡ disket

IniIDs46:call      far ptr InitIPYN         ; parametr Y/N
         jc        IniID439
         or        byte ptr ds:[DMnuVBlk+9],bit0 ; z kaz ru¨en¡ disket
         jcxz      IniID439
         and       byte ptr ds:[DMnuVBlk+9],not bit0 ; povoleno ru¨en¡ disket
         jmp       short IniID439

; ------ ‡ ste‡n  shoda parametru

InitIDs7:mov       di,si                    ; DI <- adresa za‡ tku © dku
         call      far ptr JumpPShd

         db        4,'FORM'
         dw        IniIDs72

         db        4,'DISK'
         dw        IniIDs82

         db        0
         dw        InitIDs1

; ------ form t disket "FORMx"

IniIDs72:mov       al,es:[di]               ; n sleduj¡c¡ znak
         sub       al,"0"                   ; konverze na ‡¡slo mechaniky
         jbe       IniID732                 ; neplatn‚ ‡¡slo
         cmp       al,5
         ja        IniID732                 ; neplatn‚ ‡¡slo mechaniky
         inc       di                       ; zv˜¨en¡ ukazatele textu

; ------ adresa k ulo‘en¡ definice

         mov       ah,MAXFORM*3 + 1         ; velikost jednoho popisova‡e
         mul       ah                       ; offset v tabulce
         add       ax,offset FormTab - MAXFORM*3
         xchg      ax,si                    ; SI <- ukazatel definice form t–
         mov       al,ds:[si-1]             ; po‡et form t–
         cmp       al,MAXFORM               ; maxim ln¡ po‡et form t–
         jae       IniID732                 ; je ji‘ maxim ln¡ po‡et form t–
         mov       ah,3
         mul       ah                       ; offset nov‚ polo‘ky
         add       ax,si
         xchg      ax,bx                    ; BX <- ukl dac¡ adresa

; ------ vypu¨tˆn¡ mezer

         call      far ptr InitISpc         ; vypu¨tˆn¡ mezer
         cmp       byte ptr es:[di],"="     ; je oddˆlova‡ ?
         jne       IniIDs73
         inc       di
         call      far ptr InitISpc

; ------ po‡et hlav

IniIDs73:call      far ptr InitIBNm         ; po‡et stran
         jnc       IniID734
IniID732:jmp       InitIDs1

IniID734:cmp       al,2                     ; 2 hlavy ?
         mov       al,0                     ; 2 strany
         jae       IniIDs74                 ; jsou 2 strany
         mov       al,bit7                  ; 1 strana
IniIDs74:mov       ds:[bx+1],al             ; po‡et stran

; ------ po‡et stop

         call      far ptr InitICar         ; vypu¨tˆn¡ ‡ rky
         call      far ptr InitIBNm         ; po‡et stop
         jc        IniID732                 ; chyba
         cmp       al,1                     ; minim lnˆ stop
         jb        IniID732                 ; chyba
         cmp       al,99                    ; maxim lnˆ stop
         ja        IniID732                 ; chyba
         or        al,bit7                  ; nestandardn¡ form t
         mov       ds:[bx],al               ; po‡et stop

; ------ po‡et sektor– na stopu

         call      far ptr InitICar         ; vypu¨tˆn¡ ‡ rky
         call      far ptr InitIBNm         ; po‡et sektor– na stopu
         jc        IniID732                 ; chyba
         cmp       al,1                     ; minim lnˆ sektor–
         jb        IniID732                 ; chyba
         cmp       al,50                    ; maxim lnˆ sektor–
         ja        IniID732                 ; chyba
         or        ds:[bx+1],al             ; po‡et sektor– na stopu

; ------ po‡et polo‘ek ROOT

         call      far ptr InitICar         ; vypu¨tˆn¡ ‡ rky
         call      far ptr InitIWNm         ; po‡et polo‘ek ROOT
         jc        IniID732                 ; chyba
         add       ax,15                    ; zaokrouhlen¡ nahoru
         shr       ax,1
         shr       ax,1
         shr       ax,1
         shr       ax,1                     ; p©epo‡et na sektory
         jz        IniIDs78                 ; chyba
         cmp       al,512/16                ; maxim ln¡ po‡et sektor–
         ja        IniIDs78                 ; chyba
         dec       ax                       ; korekce
         mov       ds:[bx+2],al             ; po‡et polo‘ek ROOT

; ------ po‡et sektor– na blok

         call      far ptr InitICar         ; vypu¨tˆn¡ ‡ rky
         call      far ptr InitIBNm         ; po‡et sektor– ROOT
         jc        IniIDs78
         cmp       ax,64
         ja        IniIDs78                 ; chyba
IniIDs75:shr       ax,1
         jz        IniIDs76
         add       byte ptr ds:[bx+2],bit5
         jmp       short IniIDs75

IniIDs76:inc       byte ptr ds:[si-1]       ; form t je platn˜ OK

IniIDs78:jmp       InitIDs1

; ------ bude koment © k disku

IniIDs82:mov       al,es:[di]               ; ozna‡en¡ disku
         call      far ptr UpCase           ; konverze na velk‚ p¡smeno
         sub       al,"A"
         jb        IniIDs78
         cmp       al,DiskMax
         jae       IniIDs78                 ; neplatn˜ disk
         inc       di
         mov       ah,0
         xchg      ax,bx                    ; BX <- ‡¡slo disku

; ------ nalezen¡ za‡ tku textu -> ES:DI

         call      far ptr InitISpc
         cmp       byte ptr es:[di],"="
         jne       IniIDs83
         inc       di
         call      far ptr InitISpc

; ------ zji¨tˆn¡ d‚lky textu -> CX

IniIDs83:xor       cx,cx
         push      di
IniIDs84:cmp       byte ptr es:[di]," "
         jb        IniIDs85
         inc       cx
         inc       di
         jmp       short IniIDs84
IniIDs85:pop       di

; ------ omezen¡ d‚lky koment ©e -> CX

         cmp       cx,255
         jbe       IniIDs86                 ; d‚lka je OK
         mov       cx,255                   ; omezen¡ d‚lky koment ©e

; ------ nalezen¡ adresy koment ©e -> SI

IniIDs86:mov       ax,ds:[DiskInfS]
         call      far ptr GetDat
         mov       si,2
         or        bx,bx
         jz        IniIDs88
         mov       ah,0
IniIDs87:mov       al,es:[si]
         inc       si
         add       si,ax
         dec       bx
         jnz       IniIDs87

; ------ vytvo©en¡ m¡sta v bufferu

IniIDs88:inc       si
         push      di
         mov       di,si                    ; adresa v bufferu
         mov       ax,ds:[DiskInfS]         ; segment diskov˜ch informac¡
         push      cx
         xor       cx,cx
         xchg      cl,es:[di-1]             ; star  d‚lka koment ©e
         jcxz      IniID882
         call      far ptr DelDat
IniID882:pop       cx
         call      far ptr InsDat           ; vytvo©en¡ m¡sta v bufferu
         pop       di
         jc        IniIDs78                 ; chyba - nedostatek pamˆti
         jcxz      IniIDs78

; ------ p©enesen¡ textu do bufferu

         push      ds

         mov       dx,SEG CodeDek           ; segment tabulky
         mov       bx,offset TbLatKam       ; konverze Latin 2 -> Kamenick˜ch
         cmp       byte ptr ds:[Cod0PagK],2 ; je k¢d Latin 2 ?
         je        IniID884                 ; je k¢d Latin 2
         xor       bx,bx                    ; nen¡ konverze

IniID884:push      es
         call      far ptr GetDIni
         pop       ds
         mov       ds:[si-1],cl

IniIDs89:mov       al,es:[di]

         cmp       al,128                   ; je pot©eba p©ek¢dovat ?
         jb        IniID892                 ; nen¡ pot©eba p©ek¢dovat
         or        bx,bx                    ; je konverze ?
         jz        IniID892                 ; nen¡ konverze

         push      ds
         mov       ds,dx                    ; segment tabulky
         sub       al,128
         xlat                               ; konverze znaku
         pop       ds

IniID892:mov       ds:[si],al
         inc       si
         inc       di
         loop      IniIDs89
         pop       ds
         jmp       InitIDs1

InitIDsk ENDP

; *****************************************************************************
;                                 ResDisk
;                       resetov n¡ diskov‚ho syst‚mu
; *****************************************************************************

ResDisk  PROC      FAR

         push      ax
         mov       ah,0dh
         int       21h                      ; reset diskov‚ho syst‚mu
         pop       ax
         ret

ResDisk  ENDP

;; *****************************************************************************
;;                               InitDKom
;;                     inicializace koment ©– k disk–m
;; -----------------------------------------------------------------------------
;; VSTUP: DS=datov˜ segment
;; *****************************************************************************
;;þ
;InitDKom PROC      FAR
;
;; ------ £schova registr–
;
;         push      ax
;         push      bx
;         push      cx
;         push      dx
;         push      si
;         push      di
;         push      es
;         sub       sp,FileMax               ; buffer pro cestu
;
;; ------ vytvo©en¡ datov‚ho bloku
;
;         and       byte ptr ds:[DiskInfP],not bit0+bit1+bit2+bit3 ; parametry
;         mov       bx,100                   ; minim ln¡ velikost bloku
;         call      far ptr CreatDat         ; vytvo©en¡ datov‚ho bloku
;         mov       ds:[DiskInfS],ax         ; segment datov‚ho bloku
;         jnc       InitDKm2                 ; segment vytvo©en OK
;         or        byte ptr ds:[DiskInfP],bit2 ; p©i chybˆ z kaz z pisu
;InitDKm1:jmp       InitDKm9
;
;; ------ sestaven¡ cesty k souboru DISKINFO
;
;InitDKm2:push      ss
;         pop       es
;         mov       di,sp                    ; buffer v z sobn¡ku
;         mov       si,offset FileDInf       ; jm‚no souboru DISKINFO
;         call      far ptr TempFile         ; sestaven¡ jm‚na souboru
;
;; ------ zji¨tˆn¡ atribut– souboru
;
;         mov       si,sp                    ; text jm‚na souboru
;         call      far ptr GetAFile        ; poskytnut¡ atribut– souboru
;         jc        InitDKm1                 ; soubor nenalezen
;
;; ------ otev©en¡ souboru pro ‡ten¡
;
;         call      far ptr OpenR           ; otev©en¡ souboru pro ‡ten¡
;         jc        InitDKm1                 ; soubor nenalezen
;
;; ------ adresa bufferu
;
;         push      ax
;         mov       ax,ds:[DiskInfS]         ; adresa bufferu
;         call      far ptr GetDat           ; poskytnut¡ adresy bufferu
;         pop       ax
;         jc        InitDKm1                 ; nˆjak  chyba
;
;; ------ na‡ten¡ souboru do bufferu
;
;         xchg      cx,bx                    ; CX <- velikost dat, BX <- atributy
;         dec       cx
;         dec       cx                       ; bez £vodn¡ho slova d‚lky
;         dec       cx                       ; bez koncov‚ho znaku CR
;         mov       di,2                     ; za‡ tek k na‡ten¡ dat
;         mov       dx,cx                    ; £schova velikosti dat
;         call      far ptr ReadFile        ; na‡ten¡ dat
;         cmp       dx,cx                    ; je soubor na‡ten cel˜ ?
;         jne       InitDKm3                 ; soubor je nejsp¡¨ na‡ten cel˜
;         or        byte ptr ds:[DiskInfP],bit2 ; p©¡znak z kazu z pisu do soub.
;InitDKm3:inc       cx
;         inc       cx                       ; v‡etnˆ £vodn¡ho slova
;         mov       si,cx                    ; konec dat v bufferu
;         inc       cx                       ; v‡etnˆ koncov‚ho znaku CR
;         mov       es:[0],cx                ; velikost dat v bufferu
;         mov       byte ptr es:[si],CR      ; ozna‡en¡ konce posledn¡ho © dku
;
;; ------ uzav©en¡ souboru
;
;         call      far ptr ClosFile        ; uzav©en¡ souboru
;
;; ------ nastaven¡ p©¡znak– souboru
;
;         or        byte ptr ds:[DiskInfP],bit0 ; p©¡znak na‡ten¡ souboru
;         test      bl,RO                    ; je z kaz z pisu do souboru ?
;         jz        InitDKm4                 ; nen¡ z kaz z pisu do souboru
;         or        byte ptr ds:[DiskInfP],bit2 ; p©¡znak z kazu z pisu
;
;; ------ zmen¨en¡ datov‚ho bloku
;
;InitDKm4:mov       ax,ds:[DiskInfS]         ; adresa bufferu
;         mov       bx,cx                    ; velikost dat v bufferu
;         call      far ptr ModiSegS         ; zmen¨en¡ datov‚ho bloku
;
;; ------ vynulov n¡ indexov‚ tabulky koment ©–
;
;         mov       di,offset DiskInfT       ; indexov  tabulka
;         mov       cx,DiskMax               ; po‡et disk– v tabulce
;         push      ds
;         push      es
;         push      ds
;         pop       es                       ; ES <- datov˜ segment
;         pop       ds                       ; DS <- segment dat
;         cld
;         xor       ax,ax
;         rep       stosw                    ; vynulov n¡ tabulky
;
;; ------ p©¡prava k vyhled v n¡ disk–
;
;         mov       si,2                     ; za‡ tek dat
;         mov       cx,ds:[0]                ; velikost dat v bufferu
;         sub       cx,3                     ; po‡et zbyl˜ch dat
;         jbe       InitDKm8                 ; nejsou ‘ dn  data
;
;; ------ nalezen¡ za‡ tku © dku
;
;InitDKm5:mov       dx,si                    ; £schova adresy za‡ tku © dku
;         jcxz      InitDKm8                 ; nen¡ dal¨¡ znak
;         lodsb                              ; na‡ten¡ znaku
;         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e znak–
;         cmp       al,CR
;         je        InitDKm5                 ; pr zdn˜ © dek se p©esko‡¡
;         cmp       al,LF
;         je        InitDKm5                 ; pr zdn˜ © dek se p©esko‡¡
;
;; ------ konverze jm‚na disku na velk‚ p¡smeno
;
;         cmp       al,"a"
;         jb        InitDKm6
;         cmp       al,"z"
;         ja        InitDKm6
;         sub       al,32                    ; konverze na velk‚ p¡smeno
;
;; ------ test, zda je to platn‚ ozna‡en¡ disku
;
;InitDKm6:sub       al,"A"                   ; konverze na ‡¡slo disku
;         jc        InitDKm7                 ; nen¡ to platn‚ ozna‡en¡ disku
;         cmp       al,DiskMax               ; je to platn‚ ozna‡en¡ disku ?
;         jae       InitDKm7                 ; nen¡ to platn‚ ozna‡en¡ disku
;
;; ------ test, zda n sleduje znak ":"
;
;         jcxz      InitDKm8                 ; nen¡ dal¨¡ znak
;         cmp       byte ptr ds:[si],":"     ; n sleduje znak ":" ?
;         jne       InitDKm7                 ; nen¡ to platn‚ ozna‡en¡ disku
;         and       byte ptr ds:[si-1],not 20h ; konverze na velk‚ p¡smeno
;
;; ------ je platn‚ ozna‡en¡ disku - ulo‘en¡ adresy © dku
;
;         mov       ah,0
;         shl       ax,1                     ; ‡¡slo disku * 2
;         add       ax,offset DiskInfT       ; adresa v tabulce disk–
;         xchg      ax,bx                    ; BX <- adresa v tabulce disk–
;         cmp       word ptr es:[bx],0       ; byl ji‘ disk nalezen ?
;         jne       InitDKm7                 ; disk ji‘ byl nalezen
;         mov       es:[bx],dx               ; ulo‘en¡ adresy © dku
;
;; ------ nalezen¡ konce © dku
;
;InitDKm7:jcxz      InitDKm8                 ; nen¡ dal¨¡ © dek
;         lodsb
;         dec       cx
;         cmp       al,CR
;         je        InitDKm5                 ; konec © dku - dal¨¡ © dek
;         cmp       al,LF
;         jne       InitDKm7                 ; nen¡ konec © dku
;         jmp       short InitDKm5           ; dal¨¡ © dek
;
;InitDKm8:pop       ds                       ; n vrat datov‚ho segmentu
;
;; ------ n vrat registr–
;
;InitDKm9:add       sp,FileMax               ; n vrat SP
;         pop       es
;         pop       di
;         pop       si
;         pop       dx
;         pop       cx
;         pop       bx
;         pop       ax
;         ret
;
;InitDKom ENDP

; *****************************************************************************
;                              KonvDN
;               konverze disku na po©adov‚ ‡¡slo v tabulce
; -----------------------------------------------------------------------------
; VSTUP: AL=disk (A:=0,..., DiskMax=historie)
;        DS=datov˜ segment
; VSTUP:AL=disk relativnˆ v tabulce (0=prvn¡ disk, ...)
; *****************************************************************************

KonvDN   PROC      FAR

         push      si
         push      cx

         xor       cx,cx
         mov       cl,al                    ; po‘adovan˜ disk

         cmp       al,DiskMax               ; je to historie ?
         mov       al,byte ptr ds:[DiskNum] ; disk historie
         jae       KonvDN9                  ; je historie

         xor       al,al
         mov       si,offset DiskITab       ; tabulka diskov˜ch parametr–

; ------ nalezen¡ po‘adovan‚ho disku

         jcxz      KonvDN9                  ; je to disk A
KonvDN1: cmp       byte ptr ds:[si],0       ; je to platn˜ disk ?
         je        KonvDN2                  ; nen¡ platn˜ disk
         inc       ax                       ; zv˜¨en¡ ‡¡sla disku
KonvDN2: inc       si                       ; zv˜¨en¡ adresy v tabulce
         loop      KonvDN1                  ; dal¨¡ disk

KonvDN9: pop       cx
         pop       si
         ret

KonvDN   ENDP

; *****************************************************************************
;                            KonvND
;             konverze po©adov‚ho ‡¡sla na ‡¡slo disku
; -----------------------------------------------------------------------------
; VSTUP: AL=disk relativnˆ v tabulce (0=prvn¡ disk, ...)
;        DS=datov˜ segment
; VSTUP:AL=disk (A=0,...)
; *****************************************************************************

KonvND   PROC      FAR

         push      si
         push      cx

         xor       cx,cx
         mov       cl,al                    ; po‘adovan˜ disk
         cmp       al,byte ptr ds:[DiskNum] ; je to platn˜ disk ?
         mov       al,DiskMax               ; ‡¡slo disku historie
         jae       KonvND9                  ; je historie
         inc       cx                       ; p©ednastaven¡
         mov       al,-1
         mov       si,offset DiskITab-1     ; tabulka parametr– disk–

; ------ nalezen¡ disku

KonvND1: inc       ax
         inc       si                       ; zv˜¨en¡ adresy v tabulce
         cmp       byte ptr ds:[si],0       ; je to platn˜ disk ?
         je        KonvND1                  ; neplatn˜ disk - dal¨¡
         loop      KonvND1                  ; dal¨¡ disk

KonvND9: pop       cx
         pop       si
         ret

KonvND   ENDP

; *****************************************************************************
;                                TestDisk
;                  test platnosti disku (podle tabulky disk–)
; -----------------------------------------------------------------------------
; VSTUP: AL=‡¡slo disku 0...
;        DS=datov˜ segment
; VSTUP:CY=neplatn˜ disk
; *****************************************************************************

TestDisk PROC      FAR

         push      ax
         push      bx

         cmp       al,DiskMax               ; kontrola maxim ln¡ho ‡¡sla disku
         jae       TestDsk2                 ; chybn‚ ‡¡slo disku
         mov       ah,0
         xchg      ax,bx                    ; BX <- offset v tabulce disk–
         cmp       byte ptr ds:[DiskITab+bx],0 ; je disk platn˜ ?
         jne       TestDsk3                 ; disk je platn˜ OK
TestDsk2:stc                                ; p©¡znak chyby - disk je neplatn˜

TestDsk3:pop       bx
         pop       ax
         ret

TestDisk ENDP

; *****************************************************************************
;                               AktADir
;            aktualizace aktivn¡ho adres ©e podle aktivn¡ho okna
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; *****************************************************************************

AktADir  PROC      FAR

; ------ £schova registr–

         push      ax
         push      cx
         push      dx
         push      si
         push      di
         push      es
         push      ds

; ------ p©enesen¡ textu cesty

         mov       ax,ds:[SegmAkt]          ; aktivn¡ okno
         call      far ptr GetSgAdr         ; poskytnut¡ adresy aktivn¡ho okna
         push      ds
         pop       es                       ; ES <- DS
         mov       ds,dx                    ; segment aktivn¡ho okna
         mov       cx,ds:[AWinDNum]         ; d‚lka textu adres ©e
         mov       es:[AktPathN],cx         ; d‚lka textu adres ©e
         mov       si,AWinDir               ; adres © okna
         mov       di,offset AktPath        ; aktivn¡ adres ©
         cld
         inc       cx                       ; v‡etnˆ koncov‚ 0
         rep       movsb                    ; p©enesen¡ textu cesty

; ------ n vrat registr–

         pop       ds
         pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       ax
         ret

AktADir  ENDP

; *****************************************************************************
;                                 TestDev
;               test, zda se jedn  o znakov‚ za©¡zen¡ nebo soubor
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru nebo za©¡zen¡
; VSTUP: CY=chyba nebo to je soubor
;         NC=znakov‚ za©¡zen¡
; *****************************************************************************

TestDev  PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx

; ------ poskytnut¡ informac¡ o za©¡zen¡

         xchg      ax,bx                    ; BX <- identifik tor za©¡zen¡
         mov       ax,4400h
         int       21h                      ; poskytnut¡ informac¡ o za©¡zen¡
         jc        TestDev6                 ; chyba

; ------ rozli¨en¡, zda se jedn  o znakov‚ za©¡zen¡

         cmp       dl,80h                   ; je to znakov‚ za©¡zen¡ ?
         jb        TestDev6                 ; je to diskov‚ za©¡zen¡

; ------ nastaven¡ bin rn¡ho m¢du pro znakov‚ za©¡zen¡

         mov       dh,0                     ; DH <- 0
         or        dl,bit5                  ; nastaven¡ bin rn¡ho m¢du
         mov       ax,4401h
         int       21h                      ; nastaven¡ bin rn¡ho m¢du
         clc                                ; p©¡znak znakov‚ho za©¡zen¡

; ------ n vrat registr–

TestDev6:pop       dx
         pop       bx
         pop       ax
         ret

TestDev  ENDP

; *****************************************************************************
;                                ExisFile
;                      Test, zda soubor ji‘ existuje
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru
;        DS=datov˜ segment
; VSTUP: CY=chyba nebo soubor neexistuje
;         CX=atributy nalezen‚ho souboru nebo adres ©e
; *****************************************************************************

ExisFile PROC      FAR

; ------ nalezen¡ zadan‚ho souboru

         call      far ptr Set0DTA          ; nastaven¡ pracovn¡ adresy DTA
         mov       cx,HID+SYS+RO+ARC+DIR    ; atributy - v¨echno
         call      far ptr SrcFirst         ; nalezen¡ souboru
         mov       cl,ds:[BuffDTA+DTAAtrib] ; atributy nalezen‚ho souboru
         jc        ExisFil2                 ; chyba
         je        ExisFil2                 ; soubor nalezen OK
         stc                                ; chyba - soubor nenalezen
ExisFil2:call      far ptr SrcClose         ; uzav©en¡ hled n¡
         ret

ExisFile ENDP

; *****************************************************************************
;                                 SrcFirst
;                   Nalezen¡ prvn¡ho vyhovuj¡c¡ho souboru
; -----------------------------------------------------------------------------
; VSTUP: CX=atributy souboru
;        ES:SI=specifikace souboru
;        DS=datov˜ segment
; VSTUP:CY=chyba (nap©. neplatn˜ adres ©)
;        ZY=soubor nalezen
;        NZ=soubor nenalezen
; *****************************************************************************

SrcFirst PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

; ------ uzav©en¡ p©¡padn‚ho star‚ho hled n¡

         xor       ax,ax                    ; AX <- 0
         mov       word ptr ds:[DTALCrea+6],ax ; ‡as vytvo©en¡ neplatn˜
         mov       word ptr ds:[DTALOpen+6],ax ; ‡as otev©en¡ neplatn˜
         mov       byte ptr ds:[DTALSNam],al ; zru¨en¡ kr tk‚ho jm‚na
         mov       byte ptr ds:[DTALName],al ; zru¨en¡ dlouh‚ho jm‚na
         mov       word ptr ds:[DTALNamN],ax ; zru¨en¡ dlouh‚ho jm‚na

; ------ p©¡znak, ‘e nen¡ hled n¡

         push      si
         push      es
         les       si,ds:[DTAAdr]           ; adresa aktivn¡ho DTA
         mov       word ptr es:[si+DTALIdnt],-1 ; p©¡znak neotev©en‚ho hled n¡
         pop       es
         pop       si

; ------ test, zda je p©eru¨en¡ operace

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SrcFrst9                 ; je p©eru¨en¡ operace

; ------ obsluha hled n¡ dlouh˜m jm‚nem

         test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
         jnz       SrcFrst4                 ; nejsou dlouh  jm‚na
         mov       al,4eh                   ; ‡¡slo slu‘by
         call      SrcFSrc                  ; hled n¡ souboru
         jnc       SrcFrs72                 ; soubor nalezen OK
         cmp       al,0                     ; je funkce podporovan  ?
         jne       SrcFrs62                 ; nen¡ nepodporovan 

; ------ nalezen¡ souboru nebo adres ©e

SrcFrst4:mov       ah,4eh                   ; funkce nalezen¡ souboru
SrcFrst5:push      ds
         push      es
         pop       ds                       ; segment adresy se jm‚nem souboru
         mov       dx,si                    ; offset adresy se jm‚nem souboru
         int       21h                      ; nalezen¡ prvn¡ho souboru
         pop       ds

         push      si
         push      es
         les       si,ds:[DTAAdr]           ; adresa aktivn¡ho DTA
         mov       word ptr es:[si+DTALIdnt],-1 ; nepou‘¡v  se dlouh‚ hled n¡
         pop       es
         pop       si

SrcFrst6:jnc       SrcFrst8                 ; operace OK - soubor nalezen

; ------ rozli¨en¡ chyby - zda soubor nebyl nalezen nebo jin  chyba

         cmp       al,0                     ; slu‘ba nepodporov na (DOS 7) ?
         je        SrcFrst7                 ; slu‘ba nepodporov na
SrcFrs62:cmp       al,2                     ; soubor nenalezen ?
         je        SrcFrst7                 ; soubor nenalezen
         cmp       al,12h                   ; nejsou dal¨¡ soubory ?
         je        SrcFrst7                 ; nen¡ dal¨¡ soubor

; ------ byla nˆjak  chyba (nap©. neplatn˜ adres ©)

         mov       ds:[LastErr],ax          ; £schova posledn¡ho k¢du chyby
         stc                                ; p©¡znak chyby operace
         jmp       short SrcFrst9

; ------ soubor nenalezen (k¢dy chyb 2 nebo 12h)

SrcFrst7:or        ax,ax                    ; nastaven¡ p©¡znak– NC, NZ
         jmp       short SrcFrst9

; ------ soubor nalezen OK

SrcFrs72:push      bx
         push      es
         les       bx,ds:[DTAAdr]           ; adresa aktivn¡ho DTA
         mov       word ptr es:[bx+DTALIdnt],ax ; identifik tor hled n¡
         pop       es
         pop       bx

SrcFrst8:xor       ax,ax                    ; nastaven¡ p©¡znak– NC, ZY

SrcFrst9:pop       dx
         pop       ax
         ret

SrcFirst ENDP

; *****************************************************************************
;                                  SrcNext
;                    Nalezen¡ dal¨¡ho vyhovuj¡c¡ho souboru
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP:CY=chyba
;        ZY=soubor nalezen
;        NZ=soubor nenalezen
; *****************************************************************************

SrcNext  PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         xor       ax,ax                    ; AX <- 0
         mov       word ptr ds:[DTALCrea+6],ax ; ‡as vytvo©en¡ neplatn˜
         mov       word ptr ds:[DTALOpen+6],ax ; ‡as otev©en¡ neplatn˜
         mov       byte ptr ds:[DTALSNam],al ; zru¨en¡ kr tk‚ho jm‚na
         mov       byte ptr ds:[DTALName],al ; zru¨en¡ dlouh‚ho jm‚na
         mov       word ptr ds:[DTALNamN],ax ; zru¨en¡ dlouh‚ho jm‚na

; ------ test, zda je p©eru¨en¡ operace

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SrcFrst9                 ; je p©eru¨en¡ operace

; ------ test, zda je hled n¡ dlouh˜m jm‚nem

         mov       ah,4fh                   ; funkce nalezen¡ dal¨¡ho souboru

         push      bx
         push      es
         les       bx,ds:[DTAAdr]           ; adresa aktivn¡ho DTA
         cmp       word ptr es:[bx+DTALIdnt],-1 ; je hled n¡ dlouh˜m jm‚nem ?
         pop       es
         pop       bx
         je        SrcFrst5                 ; nen¡ hled n¡ dlouh˜m jm‚nem

; ------ hled n¡ pomoc¡ dlouh‚ho jm‚na

         mov       al,4fh                   ; ‡¡slo slu‘by
         push      bx

         push      es
         les       bx,ds:[DTAAdr]           ; adresa aktivn¡ho DTA
         mov       bx,word ptr es:[bx+DTALIdnt] ; identifik tor hled n¡
         pop       es

         call      SrcFSrc                  ; hled n¡ dal¨¡ho souboru
         pop       bx
         jmp       short SrcFrst6           ; chyba nebo OK

SrcNext  ENDP

; ------ hled n¡ dlouh‚ho jm‚na, slu‘ba AL -> CY=chyba, AX=k¢d chyby

SrcFSrc  PROC      NEAR

         push      si
         push      di
         push      ds
         push      es

         mov       dx,si                    ; offset adresy se jm‚nem souboru
         mov       si,1                     ; po‘adov n form t ‡asu MS-DOS
         stc                                ; p©ednastaven¡ p©¡znaku chyby
         mov       ah,71h
         push      ds
         push      es
         pop       ds                       ; DS <- segment jm‚na
         pop       es                       ; ES <- datov˜ segment
         mov       di,offset DTALong        ; buffer pro obsluhu dlouh‚ho jm‚na
         int       21h                      ; vyhled n¡ souboru

         mov       byte ptr es:[DTALName-1],0 ; zru¨en¡ dlouh‚ho jm‚na

         pop       es
         pop       ds
         pop       di
         pop       si
         jc        SrcFSrc1                 ; chyba

; ------ test, zda bylo alespo¤ kr tk‚ nebo dlouh‚ jm‚no

         cmp       byte ptr ds:[DTALName],0 ; je dlouh‚ jm‚no ?
         jne       SrcFSrc2                 ; je dlouh‚ jm‚no
         mov       al,0                     ; chyba - neobsluhov no
         stc                                ; p©¡znak chyby
SrcFSrc1:jmp       SrcFSrc9

; ------ konverze nov‚ho form tu na star˜

SrcFSrc2:push      ax
         push      cx
         push      dx
         push      si
         push      di
         push      es

         les       di,ds:[DTAAdr]           ; adresa aktivn¡ DTA
         mov       al,ds:[DTALAtr]          ; nov‚ atributy
         mov       es:[di+DTAAtrib],al      ; star‚ atributy

         mov       ax,ds:[DTALSizL]         ; velikost souboru LOW
         mov       word ptr es:[di+DTASize],ax ; velikost souboru
         mov       ax,ds:[DTALSizL+2]
         mov       word ptr es:[di+DTASize+2],ax

         mov       ax,word ptr ds:[DTALModi] ; ‡as modifikace
         mov       es:[di+DTATime],ax       ; ‡as modifikace
         mov       ax,word ptr ds:[DTALModi+2] ; datum modifikace
         mov       es:[di+DTADate],ax       ; datum modifikace
;         mov       si,offset DTALModi       ; ‡as posledn¡ modifikace souboru
;         call      far ptr SrcFKonv         ; konverze ‡asu p©i hled n¡
;         mov       es:[di+DTATime],cx       ; ‡as
;         mov       es:[di+DTADate],dx       ; datum

; ------ p©enos kr tk‚ho jm‚na

         add       di,DTAName               ; buffer jm‚na souboru
         mov       si,offset DTALSNam       ; kr tk‚ jm‚no souboru
         cmp       byte ptr ds:[si],0       ; je kr tk‚ jm‚no ?
         jne       SrcFSrc3                 ; je kr tk‚ jm‚no OK
         mov       si,offset DTALName       ; n hrada dlouh˜m jm‚nem

SrcFSrc3:mov       cx,12                    ; d‚lka jm‚na
         cld
SrcFSr32:lodsb
         call      far ptr UpCase
         stosb
         cmp       al,0
         loopne    SrcFSr32
         mov       al,0
         stosb                              ; ozna‡en¡ konce textu

; ------ nen¡ to dlouh‚ jm‚no, pokud nebylo kr tk‚

         cmp       byte ptr ds:[DTALSNam],0 ; bylo kr tk‚ jm‚no ?
         jne       SrcFSr36                 ; bylo kr tk‚ jm‚no
         mov       byte ptr ds:[DTALName],0 ; zru¨en¡ dlouh‚ho jm‚na

; ------ d‚lka dlouh‚ho jm‚na

SrcFSr36:mov       si,offset DTALName-1     ; dlouh‚ jm‚no
         dec       byte ptr ds:[DTALNamN]
SrcFSrc4:inc       byte ptr ds:[DTALNamN]
         inc       si
         cmp       byte ptr ds:[si],0
         jne       SrcFSrc4

         mov       al,byte ptr ds:[DTALNamN] ; d‚lka jm‚na
         mov       ds:[DTALName-1],al       ; d‚lka jm‚na pro zobrazen¡

         clc                                ; p©¡znak operace OK
         pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       ax
SrcFSrc9:ret

SrcFSrc  ENDP

;; *****************************************************************************
;;        konverze polo‘ky ‡asu DS:SI na jednotliv‚ slo‘ky -> DX=datum, CX=‡as
;; *****************************************************************************
;
;SrcFKonv PROC      FAR
;
;; ------ £schova registr–
;
;         push      ax
;         push      bx
;
;; ------ ode‡ten¡ v˜choz¡ konstanty pro 1.1.1980 (rozsah: 8 Bajt–)
;; Po‡ tek je 1.1.1601, offset by mˆl proto b˜t 119600064000000000,
;; podle DOS ale vych z¡ 119599992000000000 :
;
;         sub       word ptr ds:[si],0b000h  ; 0000
;         sbb       word ptr ds:[si+2],1e4ch ; E1CB
;         sbb       word ptr ds:[si+4],0e78fh ; E7A0
;         sbb       word ptr ds:[si+6],1a8h  ; 01A8
;         jnc       SrcFKnv2                 ; nen¡ podte‡en¡
;
;; ------ omezen¡ p©i podte‡en¡
;
;         xor       ax,ax                    ; AX <- 0
;         mov       ds:[si],ax
;         mov       ds:[si+2],ax
;         mov       ds:[si+4],ax
;         mov       ds:[si+6],ax
;
;; ------ omezen¡ ‡¡sla (na asi 130 let) -> rozsah 7 bajt–
;
;SrcFKnv2:cmp       word ptr ds:[si+6],150
;         jb        SrcFKnv3
;         mov       word ptr ds:[si+6],150
;
;; ------ vydˆlen¡ ‡¡sla / 10000 (tj. na 1 ms) -> rozsah m¡rnˆ p©es 5 bajt–)
;
;SrcFKnv3:mov       bx,10000
;
;         mov       dx,ds:[si+6]
;         mov       ax,ds:[si+4]
;         div       bx
;         mov       ds:[si+4],ax
;
;         mov       ax,ds:[si+2]
;         div       bx
;         mov       ds:[si+2],ax
;
;         mov       ax,ds:[si]
;         div       bx
;         mov       ds:[si],ax
;
;; ------ vydˆlen¡ ‡¡sla / 1000 (tj. na s) -> rozsah 4 bajty)
;
;         mov       bx,1000
;
;         mov       dx,ds:[si+4]
;         mov       ax,ds:[si+2]
;         div       bx
;         mov       ds:[si+2],ax
;
;         mov       ax,ds:[si]
;         div       bx
;         mov       ds:[si],ax
;
;; ------ vydˆlen¡ ‡¡sla / 60 (tj. na minuty) -> rozsah 4 bajty)
;
;         mov       bx,60
;
;         xor       dx,dx                    ; DX <- 0
;         mov       ax,ds:[si+2]
;         div       bx
;         mov       ds:[si+2],ax
;
;         mov       ax,ds:[si]
;         div       bx
;         mov       ds:[si],ax
;
;         push      dx                       ; £schova sekund
;
;; ------ vydˆlen¡ ‡¡sla / 60 (tj. na hodiny) -> rozsah 3 bajty)
;
;         xor       dx,dx                    ; DX <- 0
;         mov       ax,ds:[si+2]
;         div       bx
;         mov       ds:[si+2],ax
;
;         mov       ax,ds:[si]
;         div       bx
;
;         push      dx                       ; £schova minut
;
;; ------ vydˆlen¡ ‡¡sla / 24 (tj. na dny) -> rozsah 2 bajty
;
;         mov       bl,24
;
;         mov       dx,ds:[si+2]
;         div       bx
;
;         push      dx                       ; £schova hodin
;
;; ------ v˜po‡et roku
;
;         xor       dx,dx
;         mov       bx,3*365+366
;         div       bx                       ; p©epo‡et na ‡ty©let¡
;         shl       ax,1
;         shl       ax,1                     ; korekce na ‡¡slo roku
;         cmp       dx,366
;         jb        SrcFKnv4
;         sub       dx,366
;         inc       ax
;
;SrcFKnv4:cmp       dx,365
;         jb        SrcFKnv5
;         sub       dx,365
;         inc       ax
;
;SrcFKnv5:cmp       dx,365
;         jb        SrcFKnv6
;         sub       dx,365
;         inc       ax
;
;SrcFKnv6:add       ax,1980
;         mov       ds:[si+6],ax             ; rok
;
;; ------ v˜po‡et mˆs¡ce a dne
;
;         mov       byte ptr ds:[si+5],0     ; ‡¡ta‡ ‡¡sla mˆs¡ce
;         mov       ah,0
;         mov       bx,offset PoctyDnu       ; tabulka po‡tu dn– mˆs¡c–
;SrcFKnv7:mov       al,ds:[bx]               ; po‡et dn– v mˆs¡ci
;         inc       bx                       ; zv˜¨en¡ ukazatele v tabulce
;         cmp       bx,offset PoctyDnu+2     ; je to £nor ?
;         jne       SrcFKnv8                 ; nen¡ to £nor
;         test      byte ptr ds:[si+6],bit0+bit1 ; je p©estupn˜ rok ?
;         jnz       SrcFKnv8                 ; nen¡ p©estupn˜ rok
;         inc       ax                       ; p©estupn˜ rok
;SrcFKnv8:inc       byte ptr ds:[si+5]       ; zv˜¨en¡ ‡¡sla mˆs¡ce
;         sub       dx,ax                    ; sn¡‘en¡ po‡tu zbyl˜ch dn–
;         jae       SrcFKnv7                 ; bude dal¨¡ mˆs¡c
;         add       dx,ax                    ; n vrat po‡tu dn–
;         inc       dx                       ; korekce ‡¡sla dne
;         mov       ds:[si+4],dl             ; ‡¡slo dne
;
;; ------ ulo‘en¡ ‡asu
;
;         pop       ax                       ; hodina
;         mov       ds:[si+3],al             ; hodina
;         pop       ax                       ; minuta
;         mov       ds:[si+2],al             ; minuta
;         pop       ax                       ; sekunda
;         mov       ds:[si+1],al             ; sekunda
;         mov       byte ptr ds:[si],0       ; setiny sekundy
;
;; ------ p©¡prava data
;
;         mov       ax,ds:[si+6]             ; rok
;         sub       ax,1980                  ; offset od roku 1980
;         mov       cl,9-5
;         shl       ax,cl                    ; posun roku
;         or        al,ds:[si+5]             ; mˆs¡c
;         mov       cl,5
;         shl       ax,cl                    ; posun mˆs¡ce
;         or        al,ds:[si+4]             ; den
;         xchg      ax,dx                    ; DX <- datum
;
;; ------ p©¡prava ‡asu
;
;         mov       ah,0
;         mov       al,ds:[si+3]             ; hodina
;         mov       cl,11-5
;         shl       ax,cl                    ; posun hodiny
;         or        al,ds:[si+2]             ; minuta
;         mov       cl,5
;         shl       ax,cl                    ; posun minuty
;         mov       cl,ds:[si+1]             ; sekunda
;         shr       cl,1
;         or        al,cl                    ; sekunda
;         xchg      ax,cx                    ; CX <- ‡as
;
;; ------ n vrat registr–
;
;         pop       bx
;         pop       ax
;         ret
;
;SrcFKonv ENDP

; *****************************************************************************
;                                SrcClose
;                 Uzav©en¡ hled n¡ (uchov v  registr p©¡znak– !)
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; *****************************************************************************

SrcClose PROC      FAR

         pushf
         push      ax
         push      bx
         push      si
         push      es

         les       si,ds:[DTAAdr]           ; adresa aktivn¡ho DTA
         mov       bx,-1                    ; BX <- -1 p©¡znak uzav©en¡
         xchg      bx,es:[si+DTALIdnt]      ; BX <- identifik tor hled n¡
         inc       bx                       ; je hled n¡ otev©eno ?
         jz        SrcClos9                 ; hled n¡ nen¡ otev©eno
         dec       bx                       ; n vrat ‡¡sla identifik toru

         xor       si,si                    ; SI <- 0
         mov       ax,71a1h
         int       21h                      ; uzav©en¡ hled n¡

SrcClos9:pop       es
         pop       si
         pop       bx
         pop       ax
         popf
         ret

SrcClose ENDP

; *****************************************************************************
;                              CopCErr
;               chybov‚ hl ¨en¡ - adres © nelze kop¡rovat s m do sebe
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace adres ©e ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace
; *****************************************************************************

CopCErr  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset CopCErrM       ; chybov‚ hl ¨en¡ - nelze cyklicky
         jmp       short OpenREr1

CopCErr  ENDP

; *****************************************************************************
;                              RenDErr
;               chybov‚ hl ¨en¡ - adres © nelze p©ejmenovat
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace adres ©e ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace
; *****************************************************************************

RenDErr  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset RenDErrM       ; chybov‚ hl ¨en¡ - nelze p©ejmenovat
         jmp       short OpenREr1

RenDErr  ENDP

; *****************************************************************************
;                              CopDErPr
;           chybov‚ hl ¨en¡ - p©episovan˜ soubor nelze zru¨it
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************
;þ
CopDErPr PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset CopyLDPr       ; chybov‚ hl ¨en¡ - nelze zru¨it
         jmp       short OpenREr1

CopDErPr ENDP

; *****************************************************************************
;                              CopErEq
;           chybov‚ hl ¨en¡ - kop¡ruje se soubor s m do sebe
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

CopErEq  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset CopErD1        ; chybov‚ hl ¨en¡ - soubor s m do sebe
         jmp       short OpenREr1

CopErEq  ENDP

; *****************************************************************************
;                              CopDErr
;           chybov‚ hl ¨en¡ - existuje adres © stejn‚ho jm‚na
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

CopDErr  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset CopyLD1        ; chybov‚ hl ¨en¡ - existuje adres ©
         jmp       short OpenREr1

CopDErr  ENDP

; *****************************************************************************
;                              CompWar
;           varovn‚ hl ¨en¡ - porovn v n soubor s m se sebou
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

CompWar  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset ChbCmWr        ; varovn‚ hl ¨en¡ - s m se sebou
         jmp       short OpenREr1

CompWar  ENDP

; *****************************************************************************
;                              CompErr
;               chybov‚ hl ¨en¡ - porovn van˜ soubor nenalezen
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

CompErr  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset ChbCmEr        ; chybov‚ho hl ¨en¡ - soubor nenalezen
         jmp       short OpenREr1

CompErr  ENDP

; *****************************************************************************
;                              WritErr
;               chybov‚ hl ¨en¡ - chyba z pisu do souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

WritErr  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset ChbWrEr        ; chybov‚ho hl ¨en¡ - chyba z pisu
         jmp       short OpenREr1

WritErr  ENDP

; *****************************************************************************
;                              ReadErr
;               chybov‚ hl ¨en¡ - chyba ‡ten¡ ze souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

ReadErr  PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset ChbReEr        ; chybov‚ho hl ¨en¡ - chyba ‡ten¡
         jmp       short OpenREr1

ReadErr  ENDP

; *****************************************************************************
;                              CreatErr
;           chybov‚ hl ¨en¡ - soubor nelze vytvo©it
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

CreatErr PROC      FAR

; ------ £schova registr–

         push      bx

;         mov       bl,es:[si]               ; disk
;         mov       ds:[CreaED5P],bl         ; disk

         push      si
         xor       bx,bx                    ; BX <- ‡¡ta‡ oddˆlova‡– "\"
CreatEr2:cmp       byte ptr es:[si],"\"
         jne       CreatEr3
         inc       bx                       ; ‡¡ta‡ oddˆlova‡– "\"
CreatEr3:inc       si
         cmp       byte ptr es:[si],0
         jne       CreatEr2
         pop       si

         mov       word ptr ds:[CreaED2P],offset CreaED3P ; nedostatek polo‘ek ROOT
         dec       bx                       ; byl pr vˆ 1 oddˆlova‡ ?
         jz        CreatEr4                 ; byl pr vˆ 1 oddˆlova‡
         mov       word ptr ds:[CreaED2P],offset CreaED4P ; nedostatek m¡sta na disku

CreatEr4:mov       bx,offset CreaED1        ; chybov‚ hl ¨en¡ - nelze vytvo©it
         jmp       short OpenREr1

CreatErr ENDP

; *****************************************************************************
;                              OpenRErr
;               chybov‚ hl ¨en¡ - soubor nelze otev©¡t
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace (jinak pokra‡ov n¡ dal¨¡m souborem)
; *****************************************************************************

OpenRErr PROC      FAR

; ------ £schova registr–

         push      bx
         mov       bx,offset ChbOpEr        ; chybov‚ho hl ¨en¡ - nelze otev©¡t

OpenREr1:push      ax
         push      si
         push      di
         push      dx

; ------ p©¡prava jm‚na souboru

OpenREr2:mov       di,offset ChbOpErF+1     ; buffer jm‚na souboru
OpenREr3:mov       al,es:[si]               ; p©ipraven˜ znak
         inc       si                       ; zv˜¨en¡ ukazatele
         cmp       al,0                     ; je konec ©etˆzce ?
         je        OpenREr4                 ; je konec ©etˆzce
         cmp       al,"\"                   ; je oddˆlova‡ cesty ?
         je        OpenREr2                 ; je oddˆlova‡ cesty - od za‡ tku
         cmp       al,":"                   ; je oddˆlova‡ disku ?
         je        OpenREr2                 ; je oddˆlova‡ disku - od za‡ tku
         cmp       di,offset ChbOpErF+1+12  ; maxim ln¡ konec
         jae       OpenREr3                 ; znak se neulo‘¡
         mov       ds:[di],al               ; ulo‘en¡ znaku
         inc       di
         jmp       short OpenREr3

OpenREr4:sub       di,offset ChbOpErF+1     ; d‚lka jm‚na souboru
         xchg      ax,di
         mov       ds:[ChbOpErF],al         ; d‚lka jm‚na souboru

; ------ chybov‚ hl ¨en¡

         mov       si,bx                    ; menu chybov‚ho hl ¨en¡
         call      far ptr TestBEsc         ; je p©eru¨en¡ operace ?
         jc        OpenREr8                 ; je p©eru¨en¡ operace

         call      far ptr Lin0MenF         ; chybov‚ hl ¨en¡
         jnc       OpenREr8                 ; nen¡ p©eru¨en¡ operace
         call      far ptr SetEsc           ; p©¡znak p©eru¨en¡ operace

; ------ n vrat registr–

OpenREr8:pop       dx
         pop       di
         pop       si
         pop       ax
         pop       bx
         ret

OpenRErr ENDP

; *****************************************************************************
;                              OpenR
;                   otev©en¡ souboru pro ‡ten¡
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba (soubor nelze otev©¡t)
;        AX=identifik tor souboru
; *****************************************************************************

OpenR    PROC      FAR

         mov       ax,3d00h                 ; otev©en¡ pro ‡ten¡
         jmp       short OpenRW1            ; otev©en¡ souboru

OpenR    ENDP

; *****************************************************************************
;                              OpenW
;                   otev©en¡ souboru pro z pis
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba (soubor nelze otev©¡t)
;        AX=identifik tor souboru
; *****************************************************************************

OpenW    PROC      FAR

         mov       ax,3d01h                 ; otev©en¡ pro z pis
         jmp       short OpenRW1            ; otev©en¡ souboru

OpenW    ENDP

; *****************************************************************************
;                            OpenRW
;               otev©en¡ souboru pro ‡ten¡ a z pis
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba (soubor nelze otev©¡t)
;        AX=identifik tor souboru
; *****************************************************************************

OpenRW   PROC      FAR

         mov       ax,3d02h                 ; otev©en¡ pro ‡ten¡ i z pis

; ------ otev©en¡ souboru

OpenRW1: cmp       byte ptr ds:[VerzeOS+1],3 ; je verze DOS 3.xx a vy¨¨¡ ?
         jb        OpenRW2                  ; je n¡zk  verze syst‚mu
         or        al,bit6                  ; m¢d sd¡len¡ soubor– bez omezen¡

OpenRW2: call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        OpenRW3                  ; je p©eru¨en¡ operace

         push      dx
         push      ds
         push      si
         pop       dx                       ; DX <- offset jm‚na souboru
         push      es
         pop       ds                       ; DS <- segment jm‚na souboru
         int       21h                      ; otev©en¡ souboru
         pop       ds
         pop       dx

; ------ chyba operace

         jnc       OpenRW3                  ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

OpenRW3: ret

OpenRW   ENDP

; *****************************************************************************
;                                ShrtXFil
;                  p©evod dlouh‚ho jm‚na souboru na kr tk‚
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=buffer s ASCIIZ dlouh˜m jm‚nem souboru
;        DS=datov˜ segment
; VSTUP: ES:SI=buffer naplnˆn ASCIIZ kr tk˜m jm‚nem souboru
;         CX=d‚lka jm‚na souboru v bufferu (plat¡ i p©i chybˆ)
;         CY=chyba (soubor nenalezen)
; *****************************************************************************

ShrtXFil PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx
         push      di

; ------ test, zda je p©eru¨en¡ operace

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        ShrtXFl6                 ; je p©eru¨en¡ operace

; ------ p©evod jm‚na souboru

         push      ds
         push      es
         pop       ds                       ; DS <- segment bufferu
         mov       ax,7160h                 ; funkce
         mov       cx,8001h                 ; pro SUBST bude logick‚ jm‚no
         mov       di,si                    ; DI <- buffer jm‚na souboru
         int       21h
         pop       ds

; ------ zji¨tˆn¡ d‚lka jm‚na souboru -> CX

ShrtXFl6:pushf
         mov       di,si                    ; DI <- buffer jm‚na souboru
         xor       cx,cx
         dec       cx
         mov       al,0
         cld
ShrtXFl8:inc       cx
         scasb
         jne       ShrtXFl8
         popf

; ------ n vrat registr–

         pop       di
         pop       dx
         pop       bx
         pop       ax
         ret

ShrtXFil ENDP

; *****************************************************************************
;                                CreOXFil
;             vytvo©en¡/otev©en¡ souboru s dlouh˜m jm‚nem WINDOWS 95
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru
;        DS=datov˜ segment
; VSTUP:AX=identifik tor nov‚ho souboru
;        CY=chyba (soubor nelze vytvo©it ani otev©¡t)
; *****************************************************************************

CreOXFil PROC      FAR

         push      dx
         mov       dl,11h                   ; vytvo©it/otev©¡t
         jmp       short OpenXRW1

CreOXFil ENDP

; *****************************************************************************
;                                CreaXFil
;             vytvo©en¡/zkr cen¡ souboru s dlouh˜m jm‚nem WINDOWS 95
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru
;        DS=datov˜ segment
; VSTUP:AX=identifik tor nov‚ho souboru
;        CY=chyba (soubor nelze vytvo©it)
; *****************************************************************************

CreaXFil PROC      FAR

         push      dx
         mov       dl,12h                   ; vytvo©it/zkr tit
         jmp       short OpenXRW1

CreaXFil ENDP

; *****************************************************************************
;                            OpenXRW
;       otev©en¡ souboru pro ‡ten¡ a z pis s dlouh˜m jm‚nem WINDOWS 95
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba (soubor nelze otev©¡t)
;        AX=identifik tor souboru
; *****************************************************************************

OpenXRW  PROC      FAR

         push      dx
         mov       dl,01h                   ; otev©¡t jen kdy‘ existuje

OpenXRW1:push      bx
         push      cx

         mov       dh,0
         mov       bx,2+bit6                ; m¢d otev©en¡
         xor       cx,cx                    ; atributy

; ------ otev©en¡ souboru

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        OpenXRW3                 ; je p©eru¨en¡ operace

         push      ds
         push      es
         pop       ds                       ; DS <- segment jm‚na souboru
         mov       ax,716ch
         int       21h                      ; otev©en¡ souboru
         pop       ds

; ------ chyba operace

         jnc       OpenXRW3                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

OpenXRW3:pop       cx
         pop       bx
         pop       dx
         ret

OpenXRW  ENDP

; *****************************************************************************
;                                CreatFil
;                          vytvo©en¡ souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru
;        DS=datov˜ segment
; VSTUP:AX=identifik tor nov‚ho souboru
;        CY=chyba (soubor nelze vytvo©it)
; *****************************************************************************

CreatFil PROC      FAR

; ------ £schova registr–

         push      cx
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        CreatFl9                 ; je p©eru¨en¡ operace

; ------ vytvo©en¡ souboru

         push      ds                       ; £schova DS
         push      es
         pop       ds                       ; DS <- jm‚no souboru - segment
         xor       cx,cx                    ; atributy souboru
         mov       dx,si                    ; DX <- jm‚no souboru - offset
         mov       ah,3ch                   ; funkce vytvo©en¡ souboru
         int       21h                      ; vytvo©en¡ souboru
         pop       ds                       ; n vrat DS

; ------ chyba operace

         jnc       CreatFl9                 ; soubor vytvo©en OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

CreatFl9:pop       dx
         pop       cx
         ret

CreatFil ENDP

; *****************************************************************************
;                              CreatTmp
;               vytvo©en¡ pracovn¡ho p©echodn‚ho souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=buffer k ulo‘en¡ specifikace souboru
;        DS=datov˜ segment
; VSTUP: AX=identifik tor nov‚ho souboru
;         ES:SI=jm‚no p©echodn‚ho souboru (sestaven‚ v bufferu)
;         CY=chyba (soubor nelze vytvo©it)
; *****************************************************************************

CreatTmp PROC      FAR

; ------ £schova registr–

         push      cx
         push      di
         push      es
         push      si                       ; SI mus¡ b˜t jako posledn¡ !!!

; ------ nalezen¡ parametru TEMP

         mov       di,si                    ; DI <- buffer k ulo‘en¡ textu
         mov       cx,es                    ; CX <- segment bufferu
         mov       si,offset TempTxt        ; jm‚no parametru "TEMP"
         call      far ptr Get0Env          ; nalezen¡ parametru TEMP
         jc        CreatTm4                 ; parametr nenalezen

; ------ kopie parametru do bufferu

         push      ds

         push      es
         pop       ds                       ; DS <- segment ©etˆzce
         mov       es,cx                    ; ES <- segment bufferu
         mov       cx,FileMax-15            ; maxim ln¡ d‚lka adres ©e
         cld
CreatTm2:lodsb
         stosb                              ; p©enesen¡ znaku
         or        al,al                    ; je konec ©etˆzce ?
         loopnz    CreatTm2                 ; p©enesen¡ textu adres ©e

         pop       ds

; ------ zaji¨tˆn¡ koncov‚ho "\" a 0

         dec       di                       ; n vrat na koncovou 0
         dec       di                       ; n vrat na posledn¡ znak
         mov       ax,"\"                   ; AL <- "\", AH <- 0
         scasb                              ; je posledn¡ znak "\" ?
         jne       CreatTm3                 ; nen¡ koncov˜ znak "\"
         dec       di                       ; n vrat na koncov˜ znak "\"
CreatTm3:stosw                              ; ulo‘en¡ koncov‚ho "\" a 0

; ------ vytvo©en¡ p©echodn‚ho souboru

         pop       si                       ; adresa bufferu
         push      si
         call      far ptr CreatPF          ; vytvo©en¡ p©echodn‚ho souboru

; ------ n vrat registr–

CreatTm4:pop       si
         pop       es
         pop       di
         pop       cx
         jnc       CreatTm8                 ; soubor vytvo©en OK

; ------ p©¡prava cesty k domovsk‚mu adres ©i

         push      si
         push      di
         mov       di,si                    ; DI <- adresa bufferu
         mov       si,offset TempTxt        ; SI <- text "TEMP"
         call      far ptr TempFile         ; sestaven¡ cesty k souboru
         pop       di
         pop       si

 ; ----- vytvo©en¡ p©echodn‚ho souboru

         call      far ptr CreatPF          ; vytvo©en¡ p©echodn‚ho souboru
CreatTm8:ret

CreatTmp ENDP

; *****************************************************************************
;                                CreatPF
;                    vytvo©en¡ p©echodn‚ho souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no adres ©e kon‡¡c¡ "\" (p©¡padn˜ soubor na konci se ignoruje)
;        DS=datov˜ segment
; VSTUP:AX=identifik tor nov‚ho souboru
;        ES:SI=jm‚no nov‚ho souboru (p©ipojeno ke jm‚nu adres ©e)
;        CY=chyba (soubor nelze vytvo©it)
; *****************************************************************************

CreatPF  PROC      FAR

; ------ £schova registr–

         push      bx
         push      cx
         push      dx
         push      di

; ------ nalezen¡ konce jm‚na adres ©e -> ES:BX

         mov       di,si                    ; DI <- ukazatel textu cesty
CreatPF1:mov       bx,di                    ; ukazatel konce adres ©e
CreatPF2:cmp       byte ptr es:[di],0       ; je konec jm‚na ?
         je        CreatPF4                 ; je konec jm‚na
         cmp       byte ptr es:[di],"\"     ; oddˆlova‡ cesty ?
         jne       CreatPF3                 ; nen¡ oddˆlova‡ cesty
         mov       bx,di                    ; adresa konce textu
CreatPF3:inc       di                       ; zv˜¨en¡ ukazatele textu
         cmp       byte ptr es:[di-1],":"   ; je oddˆlova‡ disku ?
         jne       CreatPF2                 ; nen¡ oddˆlova‡ disku
         jmp       short CreatPF1

CreatPF4:mov       word ptr es:[bx],"\"     ; oddˆlova‡ cesty + konec (0)

; ------ rozli¨en¡ podle verze opera‡n¡ho syst‚mu

         cmp       word ptr ds:[VerzeOS],300h ; je verze 3.00 nebo vy¨¨¡ ?
         jae       CreatPF8                 ; verze je OK

; ------ p©¡prava vlastn¡ho jm‚na souboru

         mov       di,bx                    ; DI <- adresa konce cesty
         inc       di                       ; ukazatel za znak "\"
         mov       ax,"00"
         cld
         stosw
         stosw
         stosw
         stosw                              ; nyn¡ je ukazatel na koncovou "."
         mov       word ptr es:[di],"$."
         mov       word ptr es:[di+2],"$"

; ------ zv˜¨en¡ jm‚na souboru

CreatPF5:push      di
CreatPF6:dec       di
         inc       byte ptr es:[di]         ; zv˜¨en¡ znaku
         cmp       byte ptr es:[di],"9"
         jbe       CreatPF7
         mov       byte ptr es:[di],"0"     ; p©ete‡en¡ na znak "0"
         jmp       short CreatPF6           ; dal¨¡ znak
CreatPF7:pop       di

; ------ test, zda soubor existuje (poskytnut¡m atribut– souboru)

         call      far ptr GetAFile         ; poskytnut¡ atribut– souboru
         jnc       CreatPF5                 ; soubor existuje - dal¨¡ pokus
         mov       word ptr ds:[LastErr],0  ; zru¨en¡ p©¡znaku chyby

; ------ vytvo©en¡ nov‚ho souboru

         call      far ptr CreatFil         ; vytvo©en¡ souboru
         jmp       short CreatPF9

; ------ test p©eru¨en¡ operace

CreatPF8:call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        CreatPF9                 ; je p©eru¨en¡ operace

; ------ vytvo©en¡ p©echodn‚ho souboru

         push      ds                       ; £schova DS
         push      es
         pop       ds                       ; DS <- jm‚no souboru - segment
         xor       cx,cx                    ; atributy souboru
         mov       dx,si                    ; DX <- jm‚no souboru - offset
         mov       ah,5ah                   ; funkce vytvo©en¡ p©echod. souboru
         int       21h                      ; vytvo©en¡ p©echodn‚ho souboru
         pop       ds                       ; n vrat DS

; ------ chyba operace

         jnc       CreatPF9                 ; soubor vytvo©en OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

CreatPF9:pop       di
         pop       dx
         pop       cx
         pop       bx
         ret

CreatPF  ENDP

; *****************************************************************************
;                            SetUFile
;              nastaven¡ ukazatele souboru na zadanou pozici
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        DX:CX=ukazatel v souboru
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

SetUFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SetUFil2                 ; je p©eru¨en¡ operace

; ------ nastaven¡ ukazatele na zadanou pozici

         xchg      cx,dx
         mov       bx,ax                    ; identifik tor souboru
         mov       ax,4200h                 ; funkce p©esunut¡ na za‡ tek
         int       21h                      ; p©esunut¡ ukazatele na za‡ tek

; ------ p©¡padn  chyba operace

         jnc       SetUFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

SetUFil2:pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

SetUFile ENDP

; *****************************************************************************
;                               GetUFile
;                    poskytnut¡ ukazatele souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
;        DX:CX=ukazatel v souboru
; *****************************************************************************

GetUFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        GetUFil2                 ; je p©eru¨en¡ operace

; ------ poskytnut¡ ukazatele

         xor       cx,cx
         xor       dx,dx
         mov       bx,ax                    ; identifik tor souboru
         mov       ax,4201h                 ; funkce p©esunut¡ na za‡ tek
         int       21h                      ; p©esunut¡ ukazatele na za‡ tek
         mov       cx,ax

; ------ p©¡padn  chyba operace

         jnc       GetUFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

GetUFil2:pop       bx
         pop       ax
         ret

GetUFile ENDP


; *****************************************************************************
;                            ResFile
;                resetov n¡ ukazatele souboru na za‡ tek
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

ResFile  PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        ResFile2                 ; je p©eru¨en¡ operace

; ------ nastaven¡ ukazatele na za‡ tek souboru

         mov       bx,ax                    ; identifik tor souboru
         mov       ax,4200h                 ; funkce p©esunut¡ na za‡ tek
         xor       cx,cx                    ; offset od za‡ tku HIGH = 0
         xor       dx,dx                    ; offset od za‡ tku LOW = 0
         int       21h                      ; p©esunut¡ ukazatele na za‡ tek

; ------ p©¡padn  chyba operace

         jnc       ResFile2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

ResFile2:pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

ResFile  ENDP

; *****************************************************************************
;                            SizeFile
;                   poskytnut¡ velikosti souboru
;         Ukazatel souboru nech  nastaven na konec souboru !!!
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        DS=datov˜ segment
; VSTUP:BX:CX=velikost souboru
;        CY=chyba operace
; *****************************************************************************

SizeFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SizeFil2                 ; je p©eru¨en¡ operace

; ------ poskytnut¡ velikosti souboru

         mov       bx,ax                    ; identifik tor souboru
         mov       ax,4202h                 ; funkce p©esunut¡ na konec souboru
         xor       cx,cx                    ; offset od konce HIGH = 0
         xor       dx,dx                    ; offset od konce LOW = 0
         int       21h                      ; p©esunut¡ ukazatele na konec soub.
         mov       bx,dx                    ; velikost HIGH
         mov       cx,ax                    ; velikost LOW

; ------ p©¡padn  chyba operace

         jnc       SizeFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

SizeFil2:pop       dx
         pop       ax
         ret

SizeFile ENDP

; *****************************************************************************
;                               Read0Fil
;                       nucen‚ ‡ten¡ dat ze souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        CX=po‡et bajt– ke ‡ten¡
;        ES:DI=adresa k na‡ten¡ dat
;        DS=datov˜ segment
; VSTUP: CY=chyba operace nebo po‡et na‡ten˜ch bajt– neodpov¡d 
; *****************************************************************************

Read0Fil PROC      FAR

         push      bx
         mov       bx,cx                    ; BX <- po‡et po‘adovan˜ch bajt–
         call      far ptr ReadFile         ; na‡ten¡ dat ze souboru
         jc        Read0Fl8                 ; byla chyba operace
         cmp       bx,cx                    ; souhlas¡ po‡et na‡ten˜ch bajt– ?
         je        Read0Fl8                 ; po‡et bajt– souhlas¡ OK
         stc                                ; p©¡znak chyby
Read0Fl8:pop       bx
         ret

Read0Fil ENDP

; *****************************************************************************
;                              ReadFile
;                      ‡ten¡ dat ze souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        CX=po‡et bajt– ke ‡ten¡
;        ES:DI=adresa k na‡ten¡ dat
;        DS=datov˜ segment
; VSTUP:CX=po‡et skute‡nˆ na‡ten˜ch bajt– dat (p©i CY je CX=0)
;        CY=chyba operace
; *****************************************************************************

ReadFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        ReadFil1                 ; je p©eru¨en¡ operace

; ------ na‡ten¡ bloku dat

         push      ds
         push      es
         pop       ds                       ; DS <- segment adresy bufferu
         mov       bx,ax                    ; identifik tor souboru
         mov       ah,3fh                   ; funkce ‡ten¡ ze souboru
         mov       dx,di                    ; DX <- offset adresy bufferu
         int       21h                      ; na‡ten¡ bloku dat
         pop       ds

; ------ stanoven¡ po‡tu na‡ten˜ch dat

         mov       cx,ax                    ; po‡et skute‡nˆ na‡ten˜ch dat
         jnc       ReadFil2                 ; operace probˆhla OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby
ReadFil1:mov       cx,0                     ; po‡et na‡ten˜ch bajt– = 0

; ------ n vrat registr–

ReadFil2:pop       dx
         pop       bx
         pop       ax
         ret

ReadFile ENDP


; *****************************************************************************
;                               WritFile
;                        z pis dat do souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        CX=po‡et bajt– k z pisu
;        ES:SI=adresa dat k z pisu
;        DS=datov˜ segment
; VSTUP:CY=chyba operace (nap©. disk pln˜)
;        CX=po‡et skute‡nˆ zapsan˜ch bajt–
; *****************************************************************************

WritFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        WritFil2                 ; je p©eru¨en¡ operace

; ------ z pis bloku dat

         push      cx
         push      ds
         push      es
         pop       ds                       ; segment adresy bufferu
         xchg      ax,bx                    ; BX <- identifik tor souboru
         mov       ah,40h                   ; funkce ‡ten¡ ze souboru
         mov       dx,si                    ; offset adresy bufferu
         int       21h                      ; z pis bloku dat
         pop       ds
         pop       cx

; ------ kontrola, zda operace probˆhla v po© dku

         jc        WritFil1                 ; byla chyba operace
         cmp       ax,cx                    ; byla zaps na v¨echna data ?
         jae       WritFil4                 ; zaps no v¨e OK (CX=po‡et bajt–)
         xchg      ax,cx                    ; CX <- skute‡nˆ zapsan  data
         mov       word ptr ds:[LastErr],Err_PLny_Disk ; chyba - disk je pln˜
         jmp       short WritFil3

WritFil1:mov       ds:[LastErr],ax          ; £schova k¢du chyby
WritFil2:xor       cx,cx                    ; nic se nezapsalo
WritFil3:stc                                ; p©¡znak chyby operace

; ------ n vrat registr–

WritFil4:pop       dx
         pop       bx
         pop       ax
         ret

WritFile ENDP

; *****************************************************************************
;                                 SetDTDir
;                     nastaven¡ data a ‡asu adres ©e
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=specifikace ASCII jm‚na adres ©e
;        CX=‡as adres ©e   bit 0 a‘ bit 4 = (sekunda/2)
;                          bit 5 a‘ bit 10 = minuta
;                          bit 11 a‘ bit 15 = hodina
;        DX=datum adres ©e bit 0 a‘ bit 4 = den
;                          bit 5 a‘ bit 8 = mˆs¡c
;                          bit 9 a‘ bit 15 = (rok-1980)
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

SetDTDir PROC      FAR

; ------ test, zda je povoleno dlouh‚ jm‚no

         test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
         stc                                ; p©¡znak chyby operace
         jnz       SetDTDr9                 ; nen¡ dlouh‚ jm‚no

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      di

; ------ £schova atribut– adres ©e (p©i pr ci v s¡ti se atributy zni‡¡)

         xchg      ax,cx                    ; AX <- po‘adovan˜ ‡as adres ©e
         call      far ptr GetAFile         ; na‡ten¡ atribut– souboru
         xchg      ax,cx                    ; AX <- atributy, CX <- ‡as adres ©e

; ------ test, zda je p©eru¨en¡ operace

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SetDTDr8                 ; je p©eru¨en¡ operace

; ------ nastaven¡ data a ‡asu adres ©e

         push      ax                       ; £schova p–vodn¡ch atribut–
         push      si
         push      ds

         push      es
         pop       ds                       ; DS <- segment jm‚na souboru
         mov       di,dx                    ; DI <- po‘adovan‚ datum adres ©e
         mov       dx,si                    ; DX <- offset jm‚na souboru
         mov       ax,7143h                 ; funkce nastaven¡ data a ‡asu
         mov       bl,3                     ; podfunkce - nastaven¡ pro adres ©
         xor       si,si                    ; SI <- 0
         int       21h                      ; nastaven¡ data a ‡asu adres ©e

         pop       ds
         pop       si
         pop       cx                       ; CX <- p–vodn¡ atributy adres ©e

; ------ chyba operace

         jnc       SetDTDr6                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat p–vodn¡ch atribut– adres ©e CX

SetDTDr6:pushf
         call      far ptr SetAFile         ; n vrat p–vodn¡ch atribut–
         popf

; ------ n vrat registr–

SetDTDr8:pop       di
         pop       dx
         pop       cx
         pop       bx
         pop       ax
SetDTDr9:ret

SetDTDir ENDP

; *****************************************************************************
;                             GetDFile
;                    poskytnut¡ data a ‡asu souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
;        CX=‡as souboru    bit 0 a‘ bit 4 = (sekunda/2)
;                          bit 5 a‘ bit 10 = minuta
;                          bit 11 a‘ bit 15 = hodina
;        DX=datum souboru  bit 0 a‘ bit 4 = den
;                          bit 5 a‘ bit 8 = mˆs¡c
;                          bit 9 a‘ bit 15 = (rok-1980)
; *****************************************************************************

GetDFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        GetDFil2                 ; je p©eru¨en¡ operace

; ------ poskytnut¡ data a ‡asu souboru

         mov       bx,ax                    ; identifik tor souboru
         mov       ax,5700h                 ; funkce poskytnut¡ data a ‡asu
         int       21h                      ; poskytnut¡ data a ‡asu souboru

; ------ chyba operace

         jnc       GetDFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

GetDFil2:pop       bx
         pop       ax
         ret

GetDFile ENDP

; *****************************************************************************
;                             SetDFile
;                     nastaven¡ data a ‡asu souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru
;        CX=‡as souboru    bit 0 a‘ bit 4 = (sekunda/2)
;                          bit 5 a‘ bit 10 = minuta
;                          bit 11 a‘ bit 15 = hodina
;        DX=datum souboru  bit 0 a‘ bit 4 = den
;                          bit 5 a‘ bit 8 = mˆs¡c
;                          bit 9 a‘ bit 15 = (rok-1980)
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

SetDFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SetDFil2                 ; je p©eru¨en¡ operace

; ------ nastaven¡ data a ‡asu souboru

         mov       bx,ax                    ; identifik tor souboru
         mov       ax,5701h                 ; funkce nastaven¡ data a ‡asu
         int       21h                      ; nastaven¡ data a ‡asu souboru

; ------ chyba operace

         jnc       SetDFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

SetDFil2:pop       bx
         pop       ax
         ret

SetDFile ENDP

; *****************************************************************************
;                             GetAFile
;                 poskytnut¡ atribut– souboru/adres ©e
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru/adres ©e ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
;        CX=atributy souboru
;              bit 0: R/O
;              bit 1: HID
;              bit 2: SYS
;              bit 3: VOL
;              bit 4: DIR
;              bit 5: ARC
; *****************************************************************************

GetAFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        GetAFil2                 ; je p©eru¨en¡ operace

; ------ poskytnut¡ atribut– souboru/adres ©e

         push      ds
         push      es
         pop       ds                       ; segment jm‚na souboru
         mov       dx,si                    ; offset jm‚na souboru
         mov       ax,4300h                 ; funkce poskytnut¡ atribut–
         int       21h                      ; poskytnut¡ atribut–
         pop       ds

; ------ chyba operace

         jnc       GetAFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

GetAFil2:pop       dx
         pop       ax
         ret

GetAFile ENDP

; *****************************************************************************
;                             SetAFile
;                 nastaven¡ atribut– souboru/adres ©e
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru/adres ©e ASCIIZ
;        DS=datov˜ segment
;        CL=atributy souboru
;              bit 0: R/O
;              bit 1: HID
;              bit 2: SYS
;              bit 3: VOL
;              bit 4: DIR (zde se neprojev¡)
;              bit 5: ARC
; VSTUP:CY=chyba operace
; *****************************************************************************

SetAFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      cx
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SetAFil2                 ; je p©eru¨en¡ operace

; ------ nastaven¡ atribut– souboru/adres ©e

         push      ds
         push      es
         pop       ds                       ; segment jm‚na souboru
         mov       dx,si                    ; offset jm‚na souboru
         and       cl,not bit4              ; zru¨en¡ bitu adres ©e
         mov       ch,0                     ; CH <- 0
         mov       ax,4301h                 ; funkce nastaven¡ atribut–
         int       21h                      ; nastaven¡ atribut–
         pop       ds

; ------ chyba operace

         jnc       SetAFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

SetAFil2:pop       dx
         pop       cx
         pop       ax
         ret

SetAFile ENDP

; *****************************************************************************
;                             SetXAFil
;            nastaven¡ atribut– souboru/adres ©e s dlouh˜m jm‚nem
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru/adres ©e ASCIIZ
;        DS=datov˜ segment
;        CL=atributy souboru
;              bit 0: R/O
;              bit 1: HID
;              bit 2: SYS
;              bit 3: VOL
;              bit 4: DIR (zde se neprojev¡)
;              bit 5: ARC
; VSTUP:CY=chyba operace
; *****************************************************************************

SetXAFil PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SetXAFl2                 ; je p©eru¨en¡ operace

; ------ nastaven¡ atribut– souboru/adres ©e

         push      ds
         push      es
         pop       ds                       ; segment jm‚na souboru
         mov       dx,si                    ; offset jm‚na souboru
         and       cl,not bit4              ; zru¨en¡ bitu adres ©e
         mov       ch,0
         mov       ax,7143h                 ; funkce nastaven¡ atribut–
         mov       bl,1                     ; nastaven¡ atribut–
         xor       si,si                    ; SI <- 0
         int       21h                      ; nastaven¡ atribut–
         pop       ds

; ------ chyba operace

         jnc       SetXAFl2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

SetXAFl2:pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

SetXAFil ENDP

; *****************************************************************************
;                                RenFile
;                          p©ejmenov n¡ souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=p–vodn¡ jm‚no souboru k p©ejmenov n¡ (ASCIIZ)
;        DX:DI=nov‚ jm‚no souboru (lze i jin˜ adres ©, ale stejn˜ disk)
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

RenFile  PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx
         push      es

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        RenFile2                 ; je p©eru¨en¡ operace

; ------ p©ejmenov n¡ souboru

         push      ds
         push      es
         pop       ds                       ; segment p–vodn¡ho jm‚na souboru
         mov       es,dx                    ; segment nov‚ho jm‚na souboru
         mov       dx,si                    ; offset p–vodn¡ho jm‚na souboru
         mov       ah,56h
         int       21h                      ; p©ejmenov n¡ souboru
         pop       ds

; ------ chyba operace

         jnc       RenFile2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

RenFile2:pop       es
         pop       dx
         pop       ax
         ret

RenFile  ENDP

; *****************************************************************************
;                                RenXFile
;             p©ejmenov n¡ souboru s dlouh˜m jm‚nem WINDOWS 95
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=p–vodn¡ jm‚no souboru k p©ejmenov n¡ (ASCIIZ)
;        DX:DI=nov‚ jm‚no souboru (lze i jin˜ adres ©, ale stejn˜ disk)
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

RenXFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx
         push      si
         push      es

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        RenXFil2                 ; je p©eru¨en¡ operace

; ------ p©ejmenov n¡ souboru

         push      ds
         push      es
         pop       ds                       ; segment p–vodn¡ho jm‚na souboru
         mov       es,dx                    ; segment nov‚ho jm‚na souboru
         mov       dx,si                    ; offset p–vodn¡ho jm‚na souboru
         mov       ax,7156h
         xor       si,si
         stc
         int       21h                      ; p©ejmenov n¡ souboru
         pop       ds

; ------ chyba operace

         jnc       RenXFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

RenXFil2:pop       es
         pop       si
         pop       dx
         pop       ax
         ret

RenXFile ENDP

; *****************************************************************************
;                               DelDir
;                   zru¨en¡ adres ©e (mus¡ b˜t pr zdn˜)
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no adres ©e ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

DelDir   PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        DelDir2                  ; je p©eru¨en¡ operace

; ------ zru¨en¡ adres ©e

         push      ds
         push      es
         pop       ds                       ; segment jm‚na adres ©e
         mov       dx,si                    ; offset jm‚na adres ©e
         mov       ah,3ah
         int       21h                      ; zru¨en¡ adres ©e
         pop       ds

; ------ chyba operace

         jnc       DelDir2                  ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

DelDir2: pop       dx
         pop       ax
         ret

DelDir   ENDP

; *****************************************************************************
;                               DelFile
;                           zru¨en¡ souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru ASCIIZ
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

DelFile  PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        DelFile2                 ; je p©eru¨en¡ operace

; ------ zru¨en¡ souboru

         push      ds
         push      es
         pop       ds                       ; segment jm‚na souboru
         mov       dx,si                    ; offset jm‚na souboru
         mov       ah,41h
         int       21h                      ; zru¨en¡ souboru
         pop       ds

; ------ chyba operace

         jnc       DelFile2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

DelFile2:pop       dx
         pop       ax
         ret

DelFile  ENDP

; *****************************************************************************
;                              FlshFile
;                p©echodn‚ uzav©en¡ souboru (vypr zdnˆn¡)
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru (0 se neuzav¡r )
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
; *****************************************************************************

FlshFile PROC      FAR

         push      ax
         push      bx

         or        ax,ax                    ; je platn˜ soubor ?
         jz        FlshFil8                 ; soubor 0 se neuzav©e

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        FlshFil8                 ; je p©eru¨en¡ operace

         xchg      ax,bx                    ; BX <- identifik tor souboru

         cmp       word ptr ds:[VerzeOS],3*HI + 30 ; je verze 3.30 a vy¨¨¡ ?
         mov       ah,68h                   ; funkce vypr zdˆn¡ buffer– souboru
         jae       FlshFil6                 ; je dostate‡n  verze syst‚mu

         mov       ah,45h
         int       21h                      ; zdvojen¡ identifik toru souboru
         jc        FlshFil7                 ; nˆjak  chyba

         xchg      ax,bx                    ; zduplik. identifik tor souboru
         mov       ah,3eh
FlshFil6:int       21h                      ; uzav©en¡ souboru
         jnc       FlshFil8                 ; operace OK

FlshFil7:mov       ds:[LastErr],ax          ; £schova k¢du chyby

FlshFil8:pop       bx
         pop       ax
         ret

FlshFile ENDP

; *****************************************************************************
;                              ClosFile
;                         uzav©en¡ souboru
; -----------------------------------------------------------------------------
; VSTUP: AX=identifik tor souboru (0 se neuzav¡r )
;        DS=datov˜ segment
; VSTUP:CY=chyba operace
;        AX=0
; *****************************************************************************

ClosFile PROC      FAR

         push      bx

         or        ax,ax                    ; je platn˜ soubor ?
         jz        ClosFil2                 ; soubor 0 se neuzav©e

         mov       bx,ax                    ; identifik tor souboru
         mov       ah,3eh                   ; identifik tor souboru
         int       21h                      ; uzav©en¡ souboru
         jnc       ClosFil2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

ClosFil2:pop       bx
         mov       ax,0
         ret

ClosFile ENDP

; *****************************************************************************
;                             CreaLDir
;  vytvo©en¡ dlouh‚ho adres ©e (o v¡ce stupn¡ch) (m–‘e posouvat segmenty !!!)
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=po‘adovan˜ nov˜ adres © ASCIIZ (pokud ji‘ existuje, je v¨e OK)
;              (nesm¡ b˜t v posouvateln‚m segmentu !)
;        CL=po‘adovan‚ atributy vytv ©en˜ch adres ©– (0=nenastavuj¡ se)
;        DS=datov˜ segment
; VSTUP:CY=chyba
; *****************************************************************************

CreaLDir PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      di
         mov       bl,cl                    ; po‘adovan‚ atributy

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        CreaLDr9                 ; je p©eru¨en¡ operace

; ------ test, zda po‘adovan˜ adres © ji‘ existuje

         call      far ptr ExisFile         ; test, zda adres © existuje
         jc        CreaLDr2                 ; nˆjak  chyba - zat¡m nevad¡
         test      cl,DIR                   ; je to adres © ?
         jnz       CreaLDr9                 ; je to adres © - to je OK
         mov       word ptr ds:[LastErr],Err_Exst_File ; chyba - je ji‘ soubor
         stc                                ; p©¡znak chyby
         jmp       short CreaLDr9           ; je to soubor - chyba

; ------ p©esko‡en¡ ozna‡en¡ disku a adres ©e ROOT

CreaLDr2:mov       di,si                    ; za‡ tek textu
         cmp       byte ptr es:[di],0       ; je nˆco zad no ?
         je        CreaLDr9                 ; nen¡ nic zad no - nic se nedˆje
         cmp       byte ptr es:[di+1],":"   ; je ozna‡en¡ disku ?
         jne       CreaLDr3                 ; nen¡ ozna‡en¡ disku
         inc       di
         inc       di                       ; p©esko‡en¡ ozna‡en¡ disku
CreaLDr3:cmp       byte ptr es:[di],"\"     ; za‡¡n  adres ©em ROOT ?
         jne       CreaLDr4                 ; neza‡¡n  adres ©em ROOT
         inc       di                       ; p©esko‡en¡ ozna‡en¡ ROOT

; ------ nalezen¡ dal¨¡ho oddˆlova‡e adres ©e

CreaLDr4:inc       di                       ; zv˜¨en¡ ukazatele textu
         mov       al,es:[di]               ; dal¨¡ znak
         cmp       al,0                     ; konec textu ?
         je        CreaLDr5                 ; konec textu
         cmp       al,"\"                   ; oddˆlova‡ adres ©e ?
         jne       CreaLDr4                 ; nen¡ oddˆlova‡ adres ©e - dal¨¡
CreaLDr5:mov       byte ptr es:[di],0       ; p©echodn‚ ozna‡en¡ konce adres ©e

; ------ test, zda ‡ ste‡n˜ adres © ji‘ existuje (ES:DI=uschovan˜ znak AL)

         call      far ptr ExisFile         ; test, zda adres © existuje
         jc        CreaLDr7                 ; nˆjak  chyba - zat¡m nevad¡
         test      cl,DIR                   ; je to adres © ?
         jnz       CreaLDr8                 ; je to adres © - to je OK
         mov       word ptr ds:[LastErr],Err_Exst_File ; chyba - je ji‘ soubor
         stc                                ; p©¡znak chyby
         jmp       short CreaLDr8           ; je to soubor - chyba

; ------ pokus o vytvo©en¡ ‡ ste‡n‚ho adres ©e (je aktualizace oken)

CreaLDr7:call      far ptr CreatDir         ; vytvo©en¡ adres ©e
         jc        CreaLDr8                 ; chyba

; ------ nastaven¡ atribut– vytvo©en‚ho adres ©e

         mov       cl,bl                    ; po‘adovan‚ atributy
         mov       ch,0
         jcxz      CreaLDr8                 ; atributy se nenastav¡ (zde je NC)
         call      far ptr SetAFile         ; nastaven¡ atribut– adres ©e

; ------ pokra‡ov n¡ dal¨¡m podadres ©em

CreaLDr8:mov       byte ptr es:[di],al      ; n vrat znaku
         jc        CreaLDr9                 ; byla nˆjak  chyba
         cmp       al,0                     ; byl to ji‘ konec adres ©e ?
         jne       CreaLDr4                 ; vytvo©en¡ dal¨¡ho podadres ©e

; ------ n vrat registr–

CreaLDr9:pop       di
         pop       cx
         pop       bx
         pop       ax
         ret

CreaLDir ENDP

; *****************************************************************************
;                            CreatDir
;           vytvo©en¡ nov‚ho adres ©e (m–‘e posouvat segmenty !!!)
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=po‘adovan˜ nov˜ adres © (nesm¡ b˜t v posouvateln‚m segmentu !)
;        DS=datov˜ segment
; VSTUP:CY=chyba
; *****************************************************************************

CreatDir PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; je p©eru¨en¡ operace ?
         jc        CreatDr4                 ; p©eru¨en¡ operace BREAK

; ------ vytvo©en¡ po‘adovan‚ho adres ©e

         push      si
         pop       dx                       ; DX <- offset jm‚na adres ©e
         push      ds                       ; £schova DS
         push      es
         pop       ds                       ; DS <- segment jm‚na adres ©e
         mov       ah,39h
         int       21h                      ; vytvo©en¡ po‘adovan‚ho adres ©e
         pop       ds                       ; n vrat DS

; ------ chyba operace

         jnc       CreatDr2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby
         jmp       short CreatDr4

; ------ aktualizace obsah– oken

CreatDr2:call      far ptr ModAWDir         ; modifikace adres ©e/souboru ES:SI

; ------ n vrat registr–

CreatDr4:pop       dx
         pop       ax
         ret

CreatDir ENDP

; *****************************************************************************
;                            CreaXDir
;     vytvo©en¡ nov‚ho adres ©e s dlouh˜m jm‚nem (m–‘e posouvat segmenty !!!)
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=po‘adovan˜ nov˜ adres © (nesm¡ b˜t v posouvateln‚m segmentu !)
;        DS=datov˜ segment
; VSTUP:CY=chyba
; *****************************************************************************

CreaXDir PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; je p©eru¨en¡ operace ?
         jc        CreaXDr4                 ; p©eru¨en¡ operace BREAK

; ------ vytvo©en¡ po‘adovan‚ho adres ©e

         mov       dx,si                    ; DX <- offset jm‚na adres ©e
         push      si
         push      ds                       ; £schova DS
         push      es
         pop       ds                       ; DS <- segment jm‚na adres ©e
         mov       ax,7139h
         xor       si,si
         stc
         int       21h                      ; vytvo©en¡ po‘adovan‚ho adres ©e
         pop       ds                       ; n vrat DS
         pop       si

; ------ chyba operace

         jnc       CreaXDr2                 ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby
         jmp       short CreaXDr4

; ------ aktualizace obsah– oken

CreaXDr2:call      far ptr ModAWDir         ; modifikace adres ©e/souboru ES:SI

; ------ n vrat registr–

CreaXDr4:pop       dx
         pop       ax
         ret

CreaXDir ENDP

; *****************************************************************************
;                             GetDisk
;                      Poskytnut¡ aktivn¡ho disku
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP:AL=aktivn¡ disk
; *****************************************************************************

GetDisk  PROC      FAR

         push      dx
         push      ax
         mov       ah,19h                   ; funkce poskytnut¡ aktivn¡ho disku
         int       21h                      ; poskytnut¡ aktivn¡ho disku
         mov       dl,al                    ; ‡¡slo aktivn¡ho disku
         pop       ax
         mov       al,dl                    ; ‡¡slo aktivn¡ho disku
         pop       dx
         ret

GetDisk  ENDP

; *****************************************************************************
;                             SetDisk
;                    Nastaven¡ aktivn¡ho disku
; -----------------------------------------------------------------------------
; VSTUP: AL=‡¡slo po‘adovan‚ho disku
;        DS=datov˜ segment
; VSTUP:CY=neplatn‚ ‡¡slo disku
; *****************************************************************************

SetDisk  PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx
         mov       dl,al                    ; po‘adovan˜ nov˜ disk

; ------ £schova p–vodn¡ho aktivn¡ho disku

         call      far ptr GetDisk         ; poskytnut¡ aktivn¡ho disku
         mov       dh,al                    ; ‡¡slo p–vodn¡ho aktivn¡ho disku

; ------ nastaven¡ po‘adovan‚ho disku

         mov       ah,0eh                   ; funkce nastaven¡ nov‚ho disku
         int       21h                      ; nastaven¡ nov‚ho disku

; ------ kontrola, zda byl disk nastaven

         call      far ptr GetDisk         ; poskytnut¡ aktivn¡ho disku
         cmp       al,dl                    ; byl disk spr vnˆ nastaven ?
         jne       SetDisk4                 ; chyba - disk nebyl nastaven

; ------ kontrola, zda je platn˜ disk slu‘bou IOCTL

         cmp       word ptr ds:[VerzeOS],300h ; je verze syst‚mu alespo¤ 3.00 ?
         cmc
         jnc       SetDisk5                 ; n¡zk  verze syst‚mu - z©ejmˆ OK
         mov       bl,dl                    ; ‡¡slo disku
         inc       bx                       ; korekce ‡¡sla disku
         mov       ax,4408h                 ; funkce poskytnut¡ typu disku
         int       21h                      ; poskytnut¡ typu disku
         cmp       al,0fh                   ; chyba - neplatn˜ disk ?
         clc
         jne       SetDisk5                 ; disk je OK

; ------ neplatn˜ disk - navr cen¡ p–vodn¡ho disku

SetDisk4:mov       dl,dh                    ; p–vodn¡ aktivn¡ disk
         mov       ah,0eh                   ; funkce nastaven¡ aktivn¡ho disku
         int       21h                      ; nastaven¡ p–vodn¡ho aktiv. disku
         stc                                ; p©¡znak chyby - neplatn˜ disk

; ------ n vrat registr–

SetDisk5:pop       dx
         pop       bx
         pop       ax
         ret

SetDisk  ENDP

; *****************************************************************************
;                            GetADir
;             poskytnut¡ aktivn¡ho adres ©e aktivn¡ho disku
; -----------------------------------------------------------------------------
; VSTUP: ES:DI=buffer 67 B k na‡ten¡ adres ©e (s diskem)
;        DS=datov˜ segment
; VSTUP:CY=chyba
;        CX=po‡et bajt–
; *****************************************************************************

GetADir  PROC      FAR

         push      ax
         call      far ptr GetDisk         ; poskytnut¡ aktivn¡ho disku
         call      far ptr GetDir          ; poskytnut¡ aktivn¡ho adres ©e
         pop       ax
         ret

GetADir  ENDP

; *****************************************************************************
;                            GetDir
;            poskytnut¡ aktivn¡ho adres ©e disku (i s diskem)
; -----------------------------------------------------------------------------
; VSTUP: AL=po‘adovan˜ disk, jeho‘ adres © se m  poskytnout
;        ES:DI=adresa bufferu 67 B k na‡ten¡ adres ©e (tvar ASCIIZ s diskem)
;        DS=datov˜ segment
; VSTUP:CY=chyba (neplatn˜ disk nebo disk nen¡ p©ipraven)
;        CX=po‡et bajt– textu cesty (p©i chybˆ CX=0)
; *****************************************************************************

GetDir   PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx
         push      si

; ------ na‡ten¡ adres ©e

         xor       cx,cx                    ; p©ednastaven¡ - d‚lka textu 0
         call      far ptr TestBreak        ; je p©eru¨en¡ operace ?
         jc        GetDir3                  ; p©eru¨en¡ operace BREAK

         push      ds                       ; £schova DS
         xchg      ax,dx                    ; DL <- po‘adovan˜ disk
         inc       dx                       ; korekce na spr vnou hodnotu
         push      es                       ; segment bufferu
         pop       ds                       ; segment bufferu
         mov       si,di                    ; offset bufferu
         mov       ah,47h                   ; funkce poskytnut¡ adres ©e
         add       si,3                     ; p©esko‡en¡ ozna‡en¡ disku
         int       21h                      ; poskytnut¡ adres ©e zadan‚ho disku
         pop       ds                       ; n vrat DS
         jc        GetDir2                  ; chyba - adres © neplatn˜
         mov       byte ptr es:[si+63],0    ; pojistn‚ ukon‡en¡ ©etˆzce

; ------ nastaven¡ textu disku

         add       dl,"A"-1                 ; korekce na znak ASCII
         mov       es:[di],dl               ; ozna‡en¡ disku
         mov       word ptr es:[di+1],"\:"  ; oddˆlova‡ disku

; ------ stanoven¡ d‚lky textu

         mov       cx,3                     ; inicializa‡n¡ d‚lka textu
GetDir1: cmp       byte ptr es:[si],0       ; konec textu ?
         je        GetDir3                  ; konec textu
         inc       cx
         inc       si
         jmp       short GetDir1

; ------ chyba operace

GetDir2: mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

GetDir3: pop       si
         pop       dx
         pop       ax
         ret

GetDir   ENDP

; *****************************************************************************
;                             SetDDir
;             nastaven¡ adres ©e a disku podle cesty
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=po‘adovan˜ adres © (bez koncov‚ho "\")
;        DS=datov˜ segment
; VSTUP:CY=chyba
; *****************************************************************************

SetDDir  PROC      FAR

; ------ nastaven¡ disku podle cesty

         push      ax
         cmp       byte ptr es:[si],0       ; je v–bec nˆco zad no ?
         je        SetDDir2                 ; nen¡ nic zad no
         cmp       byte ptr es:[si+1],":"   ; je zad n disk ?
         clc                                ; p©¡znak operace OK
         jne       SetDDir2                 ; nen¡ zad n disk
         mov       al,es:[si]               ; po‘adovan˜ disk
         call      far ptr UpCase           ; konverze na velk‚ p¡smeno
         sub       al,"A"                   ; korekce na ‡¡slo disku
         call      far ptr SetDisk         ; nastaven¡ po‘adovan‚ho disku
SetDDir2:pop       ax
         jc        SetDDir4                 ; chyba zad n¡ disku

; ------ nastaven¡ cesty

         call      far ptr SetDir          ; nastaven¡ adres ©e disku
SetDDir4:ret

SetDDir  ENDP

; *****************************************************************************
;                             SetDir
;                     nastaven¡ adres ©e disku
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=po‘adovan˜ adres © (bez koncov‚ho "\")
;        DS=datov˜ segment
; VSTUP:CY=chyba
; *****************************************************************************

SetDir   PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx

         call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        SetDir2                  ; je p©eru¨en¡ operace

; ------ zmˆna adres ©e

         push      ds
         push      es                       ; segment adres ©e
         pop       ds                       ; segment adres ©e
         cmp       byte ptr ds:[si],0       ; je nˆco zad no ?
         je        SetDir1                  ; nen¡ nic zad no
         mov       dx,si                    ; offset adres ©e
         mov       ah,3bh                   ; funkce nastaven¡ adres ©e
         int       21h                      ; nastaven¡ po‘adovan‚ho adres ©e
SetDir1: pop       ds

; ------ chyba operace

         jnc       SetDir2                  ; operace OK
         mov       ds:[LastErr],ax          ; £schova k¢du chyby

; ------ n vrat registr–

SetDir2: pop       dx
         pop       ax
         ret

SetDir   ENDP

; *****************************************************************************
;                            InitAPth
;                   inicializace aktivn¡ho adres ©e
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: CY=chyba operace (ale to nevad¡)
; -----------------------------------------------------------------------------
; zni‡en‚ registry: AX, CX, DI, ES
; *****************************************************************************

InitAPth PROC      FAR

         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       di,offset AktPath        ; cesta k aktivn¡mu adres ©i
         call      far ptr GetDisk         ; poskytnut¡ aktivn¡ho disku
         add       al,"A"
         mov       ah,":"
         mov       ds:[di],ax               ; inicializa‡n¡ ozna‡en¡ disku
         mov       word ptr ds:[di+2],"\"
         mov       word ptr ds:[AktPathN],3 ; d‚lka p©i chybˆ
         call      far ptr GetADir         ; poskytnut¡ aktivn¡ho adres ©e
         jc        InitAPt2                 ; chyba operace
         mov       ds:[AktPathN],cx         ; d‚lka textu adres ©e
InitAPt2:ret

InitAPth ENDP

; *****************************************************************************
;                                    InitHPth
;  inicializace domovsk‚ho adres ©e (vy‘aduje zn t aktivn¡ adres © a verzi OS)
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; -----------------------------------------------------------------------------
; zni‡en‚ registry: v¨echny kromˆ DS
; *****************************************************************************

InitHPth PROC      FAR

; ------ kopie aktivn¡ho adres ©e do domovsk‚ho

         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       cx,ds:[AktPathN]
         mov       ds:[HomeDirN],cx         ; d‚lka textu
         mov       si,offset AktPath        ; aktivn¡ adres ©
         mov       di,offset HomeDir        ; domovsk˜ adres ©
         cld
         push      si                       ; aktivn¡ adres ©
         push      cx                       ; d‚lka adres ©e
         inc       cx                       ; v‡etnˆ koncov‚ 0
         rep       movsb                    ; kopie domovsk‚ho adres ©e
         pop       cx
         pop       si

; ------ sestaven¡ n vratov‚ specifikace programu DOSMAN.EXE

         mov       di,offset DosmPath       ; n vrat do programu DOSMAN.EXE
         rep       movsb                    ; p©enos aktivn¡ho adres ©e
         mov       al,"\"
         cmp       ds:[di-1],al             ; je text ukon‡en "\" ?
         je        InitHP12                 ; je ukon‡en "\"
         stosb                              ; ulo‘en¡ koncov‚ho "\"
InitHP12:mov       si,offset DosmName       ; jm‚no DOSMAN.EXE
         mov       cl,offset(DosmNam0-DosmName) ; d‚lka jm‚na programu
         rep       movsb                    ; p©id n¡ jm‚na programu DOSMAN.EXE

; ------ adresa prost©ed¡

         mov       es,ds:[SegPSP]           ; segment PSP
         mov       ax,es:[PSP_ENV]          ; segment prost©ed¡
         mov       es,ax                    ; segment prost©ed¡
         cmp       ax,60h                   ; je segment prost©ed¡ ?
         jae       InitHPt1                 ; je prost©ed¡
IntHPt99:jmp       InitHPt9                 ; nen¡ prost©ed¡

; ------ nalezen¡ ©etˆzce odkazu na program

InitHPt1:xor       di,di                    ; za‡ tek prost©ed¡
         mov       cx,8000h                 ; maxim ln¡ d‚lka prost©ed¡
         xor       ax,ax                    ; hledan˜ konec prost©ed¡
InitHPt2:inc       di                       ; zv˜¨en¡ adresy v prost©ed¡
         cmp       es:[di-1],ax             ; je konec prost©ed¡ ?
         loopne    InitHPt2                 ; nalezen¡ konce prost©ed¡
         inc       di                       ; adresa po‡tu ©etˆzc–
         cmp       word ptr es:[di],0       ; je nˆjak˜ ©etˆzec ?
         je        IntHPt99                 ; nen¡ ‘ dn˜ ©etˆzec
         inc       di
         inc       di                       ; za‡ tek ©etˆzce

; ------ pro n¡zkou verzi syst‚mu dopl¤kov  kontrola

         cmp       word ptr ds:[VerzeOS],300h ; je verze syst‚mu alespo¤ 3.00 ?
         jae       InitHP22                 ; verze syst‚mu je OK
         cmp       word ptr es:[di-2],1     ; mus¡ b˜t 1 ©etˆzec
         jne       IntHPt99                 ; neplatn‚ informace
InitHP22:cmp       word ptr es:[di-2],1
         jb        IntHPt99                 ; neplatn‚ informace
         cmp       byte ptr es:[di]," "
         jbe       IntHPt99                 ; neplatn‚ informace

; ------ p©enesen¡ textu cesty

         mov       bp,di                    ; za‡ tek jm‚na programu
         mov       si,offset HomeDir        ; cesta k domovsk‚mu adres ©i
         mov       cx,FileDMax-1            ; maxim ln¡ d‚lka textu
         xor       bx,bx                    ; d‚lka textu
         mov       dx,si                    ; £schova konce cesty
InitHPt3:mov       al,es:[di]               ; znak cesty
         call      far ptr UpCase           ; konverze na velk‚ p¡smeno
         mov       ds:[si],al               ; ulo‘en¡ znaku
         cmp       al,":"
         je        InitHPt4                 ; je oddˆlova‡ disku
         cmp       al,"\"                   ; je oddˆlova‡ cesty ?
         jne       InitHPt5                 ; nen¡ oddˆlova‡ cesty
InitHPt4:mov       dx,si                    ; £schova konce cesty
         mov       bx,FileDMax-1            ; maxim ln¡ d‚lka textu
         sub       bx,cx                    ; £schova d‚lky textu
         mov       bp,di                    ; nov˜ za‡ tek jm‚na programu-1
         inc       bp                       ; nov˜ za‡ tek jm‚na programu
InitHPt5:inc       si
         inc       di
         cmp       al,0                     ; je to konec textu ?
         loopne    InitHPt3                 ; nen¡ konec - dal¨¡ znak

; ------ korekce textu cesty

         cmp       bx,3                     ; je dostate‡n  d‚lka textu ?
         jae       InitHPt7                 ; je dostate‡n  d‚lka textu
         cmp       word ptr ds:[HomeDir+1],"\:" ; je to ROOT adres © ?
         je        InitHPt6                 ; nen¡ to ROOT adres ©
         cmp       byte ptr ds:[HomeDir],"\" ; je zad n ROOT ?
         jne       InitHPt7                 ; nen¡ ROOT
         or        bx,bx                    ; je pouze oddˆlova‡ ROOT ?
         jnz       InitHPt7                 ; nen¡ jen oddˆlova‡ ROOT
InitHPt6:inc       bx                       ; plat¡ posledn¡ znak "\"
         inc       dx                       ; n sleduj¡c¡ znak za "\"
InitHPt7:mov       si,dx                    ; adresa konce cesty
         mov       byte ptr ds:[si],0       ; konec textu cesty
         mov       ds:[HomeDirN],bx         ; d‚lka textu cesty

; ------ nen¡-li zad na pln  cesta, jej¡ na‡ten¡

         push      ds
         pop       es                       ; ES <- datov˜ segment
         or        bx,bx                    ; je nˆco zad no ?
         jz        InitHPt8                 ; nen¡ nic zad no
         cmp       word ptr ds:[HomeDir+1],"\:" ; je zad n disk a ROOT ?
         je        InitHP82                 ; je pln  cesta - v¨e je OK
         mov       si,offset HomeDir        ; sestaven  cesta
         call      far ptr SetDDir         ; nastaven¡ zadan‚ cesty
InitHPt8:mov       di,offset HomeDir        ; domovsk˜ adres ©
         call      far ptr GetADir         ; poskytnut¡ domovsk‚ cesty
         jc        InitHP81
         mov       ds:[HomeDirN],cx         ; d‚lka textu cesty
InitHP81:mov       si,offset AktPath        ; aktivn¡ cesta
         call      far ptr SetDDir         ; n vrat aktivn¡ cesty

; ------ p©¡prava n vratov‚ cesty k DOSMAN.EXE

InitHP82:mov       si,offset HomeDir        ; domovsk˜ adres ©
         mov       di,offset DosmPath       ; n vratov  cesta k DOSMAN.EXE
         mov       cx,ds:[HomeDirN]
         cld
         rep       movsb                    ; p©enesen¡ textu cesty

         mov       al,"\"
         cmp       byte ptr ds:[di-1],al
         je        InitHP84
         stosb

InitHP84:push      ds
         mov       ds,ds:[SegPSP]           ; segment PSP
         mov       ds,ds:[PSP_ENV]          ; segment prost©ed¡
         mov       si,bp
InitHP85:lodsb
         cmp       al,0
         je        InitHP86
         cmp       di,offset DosmPth0-1
         jae       InitHP86
         call      far ptr UpCase
         stosb
         jmp       short InitHP85
InitHP86:mov       al,0
         stosb
         pop       ds

InitHPt9:ret

InitHPth ENDP

; *****************************************************************************
;                               InitTPth
;      inicializace odkl dac¡ho adres ©e (vy‘aduje zn t domovsk˜ adres ©)
;            pro domovsk˜ adres © mus¡ b˜t zn m p©echodn˜ adres ©
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
;        SI=text parametru (/Z nebo /X)
;        BP=buffer adres ©e (TempDir nebo HomeDir); DS:[BP-2] (2) d‚lka adres ©e
; -----------------------------------------------------------------------------
; zni‡en‚ registry: v¨echny kromˆ DS
; *****************************************************************************

InitTPth PROC      FAR

; ------ test, zda je zad n parametr

         call      far ptr GetCPar          ; nalezen¡ parametru v p©¡kaz. © dku
         jnc       InitTPt1
         jmp       InitTPt8                 ; domovsk˜ adres © nezad n

; ------ nalezen¡ za‡ tku zadan‚ho p©echodn‚ho adres ©e

InitTPt1:mov       al,es:[di]
         inc       di
         cmp       al,TAB
         je        InitTPt1                 ; tabul tor se p©esko‡¡
         cmp       al," "
         je        InitTPt1                 ; mezera se p©esko‡¡
         jb        InitTPt8                 ; konec parametr– - nen¡ nic zad no
         cmp       al,"/"
         je        InitTPt8                 ; nen¡ nic zad no

; ------ zad no "*" - bude jako datov˜ adres ©

         cmp       al,"*"
         je        InitTP78

; ------ p©enos textu adres ©e

         mov       si,bp                    ; buffer p©echodn‚ho adres ©e
         xor       dx,dx                    ; DX <- 0 ‡¡ta‡ d‚lky textu
InitTPt2:cmp       dl,FileDMax-1            ; maxim ln¡ d‚lka adres ©e
         jae       InitTPt3                 ; maxim ln¡ d‚lka adres ©e
         mov       ds:[si],al               ; ulo‘en¡ znaku do bufferu
         inc       si                       ; zv˜¨en¡ ukl dac¡ adresy
         inc       dx                       ; zv˜¨en¡ ‡¡ta‡e d‚lky textu
         mov       al,es:[di]               ; dal¨¡ znak
         inc       di
         cmp       al,"/"
         je        InitTPt3                 ; konec parametr–
         cmp       al," "
         jae       InitTPt2                 ; platn˜ znak

; ------ vypu¨tˆn¡ mezer na konci textu

InitTPt3:or        dx,dx                    ; je dal¨¡ znak ?
         jz        InitTPt4                 ; nen¡ dal¨¡ znak
         dec       si
         dec       dx
         cmp       byte ptr ds:[si]," "
         je        InitTPt3
         inc       si
         inc       dx

; ------ vypu¨tˆn¡ koncov‚ho znaku "\"

InitTPt4:cmp       dl,2                     ; minim ln¡ d‚lka 2 znaky
         jb        InitTPt5                 ; je m lo znak– - nem–‘e b˜t "x:\"
         cmp       byte ptr ds:[si-1],"\"
         jne       InitTPt5                 ; nen¡ "\" na konci adres ©e
         cmp       byte ptr ds:[si-2],":"
         je        InitTPt5                 ; je to ROOT
         dec       si                       ; vypu¨tˆn¡ koncov‚ho "\"

; ------ ozna‡en¡ konce adres ©e

InitTPt5:mov       byte ptr ds:[si],0       ; ozna‡en¡ konce adres ©e

; ------ nastaven¡ zadan‚ho adres ©e

         push      ds
         pop       es
         mov       si,bp                    ; sestaven  cesta
         call      far ptr SetDDir         ; nastaven¡ zadan‚ cesty

; ------ na‡ten¡ v˜sledn‚ho adres ©e

         mov       di,bp                    ; p©echodn˜ adres ©
         call      far ptr GetADir         ; poskytnut¡ domovsk‚ cesty
         jc        InitTPt7
         mov       ds:[bp-2],cx             ; d‚lka textu cesty

; ------ n vrat p–vodn¡ho aktivn¡ho adres ©e

InitTPt7:pushf
         mov       si,offset AktPath        ; aktivn¡ cesta
         call      far ptr SetDDir         ; n vrat aktivn¡ cesty
         popf
         jnc       InitTPt9

; ------ pro domovsk˜ adres © bude p©i chybˆ jako p©echodn˜ adres ©

InitTP78:mov       si,offset TempDir        ; vezme se to z p©echodn‚ho adres ©e
         mov       cx,ds:[TempDirN]
         cmp       bp,offset HomeDir        ; je to domovsk˜ adres © ?
         je        InitTP82                 ; je to domovsk˜ adres ©

; ------ odkl dac¡ adres © je v domovsk‚m adres ©i (pro HomeDir se nic nedˆje)

InitTPt8:mov       si,offset HomeDir        ; domovsk˜ adres ©
         mov       cx,ds:[HomeDirN]         ; d‚lka domovsk‚ho adres ©e
InitTP82:push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       di,bp                    ; p©echodn˜ adres ©
         mov       ds:[bp-2],cx             ; d‚lka p©echodn‚ho adres ©e
         inc       cx                       ; v‡etnˆ koncov‚ 0
         cld
         rep       movsb                    ; kopie adres ©e

InitTPt9:ret

InitTPth ENDP

; *****************************************************************************
;                                HomeFile
;               sestaven¡ cesty k souboru v dom c¡m adres ©i
; -----------------------------------------------------------------------------
; VSTUP: DS:SI=jm‚no souboru k sestaven¡ (prvn¡ bajt = d‚lka jm‚na souboru)
;        ES:DI=buffer k ulo‘en¡ specifikace souboru
;        DS=datov˜ segment
; VSTUP:DI=konec textu jm‚na souboru v bufferu (koncov  0)
; *****************************************************************************

HomeFile PROC      FAR

; ------ £schova registr–

         push      cx

; ------ p©enesen¡ textu dom c¡ho adres ©e do bufferu

         push      si
         mov       cx,ds:[HomeDirN]         ; d‚lka dom c¡ho adres ©e
         mov       si,offset HomeDir        ; dom c¡ adres ©e
         jmp       short TempFil0           ; inicializace adres ©e

HomeFile ENDP

; *****************************************************************************
;                                TempFile
;            sestaven¡ cesty k souboru v p©echodn‚mu adres ©i
; -----------------------------------------------------------------------------
; VSTUP: DS:SI=jm‚no souboru k sestaven¡ (prvn¡ bajt = d‚lka jm‚na souboru)
;        ES:DI=buffer k ulo‘en¡ specifikace souboru
;        DS=datov˜ segment
; VSTUP:DI=konec textu jm‚na souboru v bufferu (koncov  0)
; *****************************************************************************

TempFile PROC      FAR

; ------ £schova registr–

         push      cx

; ------ p©enesen¡ textu p©echodn‚ho adres ©e do bufferu

         push      si
         mov       cx,ds:[TempDirN]         ; d‚lka p©echodn‚ho adres ©e
         mov       si,offset TempDir        ; p©echodn˜ adres ©e
TempFil0:cld
         rep       movsb                    ; p©enos textu do bufferu
         pop       si

; ------ zaji¨tˆn¡ znaku "\" na konci textu p©echodn‚ho adres ©e

         push      ax

         mov       al,"\"                   ; oddˆlova‡ adres ©–
         dec       di
         scasb                              ; kon‡¡ adres © znakem "\" ?
         je        TempFil1                 ; kon‡¡ znakem "\"
         stosb                              ; oddˆlovac¡ znak "\"

; ------ p©id n¡ jm‚na souboru k textu cestu

TempFil1:push      si
         lodsb
         mov       cl,al                    ; CL <- d‚lka jm‚na souboru
         rep       movsb                    ; p©enos jm‚na souboru
         mov       es:[di],cl               ; ozna‡en¡ konce textu
         pop       si

; ------ n vrat registr–

         pop       ax

         pop       cx
         ret

TempFile ENDP

; *****************************************************************************
;                               Set0DTA
;              Nastaven¡ standardn¡ho bufferu DTA (BuffDTA)
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; *****************************************************************************

Set0DTA  PROC      FAR

         push      si
         push      es

         mov       si,offset BuffDTA
         push      ds
         pop       es
         call      far ptr SetDTA

         pop       es
         pop       si
         ret

Set0DTA  ENDP

; *****************************************************************************
;                                SetDTA
;                          Nastaven¡ adresy DTA
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=adresa DTA
; *****************************************************************************

SetDTA   PROC      FAR

; ------ £schova registr–

         push      ax
         push      dx
         push      ds

; ------ nastaven¡ adresy DTA

         mov       word ptr ds:[DTAAdr],si  ; adresa aktivn¡ DTA - offset
         mov       word ptr ds:[DTAAdr+2],es ; adresa aktivn¡ DTA - segment
         push      es
         pop       ds                       ; DS <- segment adresy DTA
         mov       dx,si                    ; DX <- offset adresy DTA
         mov       ah,1ah                   ; funkce nastaven¡ adresy DTA
         int       21h                      ; nastaven¡ adresy DTA

; ------ n vrat registr–

         pop       ds
         pop       dx
         pop       ax
         ret

SetDTA   ENDP

; *****************************************************************************
;                           GetErr
;                   Poskytnut¡ k¢du posledn¡ chyby
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP:AX=k¢d posledn¡ chyby
; *****************************************************************************

GetErr   PROC      FAR

; ------ zji¨tˆn¡ posledn¡ chyby pro ni‘¨¡ verze syst‚mu

         mov       ax,ds:[LastErr]          ; k¢d posledn¡ chyby
         cmp       word ptr ds:[VerzeOS],300h ; je verze syst‚mu alespo¤ 3.00 ?
         jb        GetErr2                  ; je n¡zk  verze syst‚mu

; ------ zji¨tˆn¡ k¢du chyby pro vy¨¨¡ verze syst‚mu

         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      bp
         push      ds
         push      es

         mov       ah,59h                   ; funkce poskytnut¡ k¢du chyby
         xor       bx,bx                    ; BX <- 0 identifik tor funkce
         int       21h                      ; poskytnut¡ k¢du chyby

         pop       es
         pop       ds
         pop       bp
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx

; ------ pokud nen¡ hl ¨ena chyba, pou‘ije se vlastn¡ uschovan˜ k¢d chyby

         or        ax,ax                    ; byla nˆjak  chyba ?
         jnz       GetErr2                  ; byla nˆjak  chyba
         mov       ax,ds:[LastErr]          ; k¢d posledn¡ chyby
GetErr2: ret

GetErr   ENDP

; *****************************************************************************
;                              NormFilL
;              normalizace jm‚na souboru v © dkov‚m bufferu
; - odstranˆn¡ po‡ te‡n¡ch a koncov˜ch mezer, o©ez n¡ d‚lky jmen, doplnˆn¡
;               koncov‚ nuly, p©evod na velk  p¡smena
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: ES:SI=adresa bufferu LinBuff (ES=DS, SI=offset LinBuff)
;         CX=d‚lka textu
;         ZY=nen¡ ‘ dn˜ znak
; *****************************************************************************

NormFilL PROC      FAR

         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset LinBuff        ; SI <- © dkov˜ buffer
         mov       ch,0
         mov       cl,ds:[LinNum]           ; CX <- d‚lka textu
         call      far ptr NormFile        ; normalizace bufferu
         mov       ds:[LinNum],cl           ; nov  d‚lka textu
         or        cx,cx                    ; je nˆjak˜ znak ?
         ret

NormFilL ENDP

; *****************************************************************************
;                              NormFile
;                      normalizace jm‚na souboru
; - odstranˆn¡ po‡ te‡n¡ch a koncov˜ch mezer, o©ez n¡ d‚lky jmen, doplnˆn¡
;               koncov‚ nuly, p©evod na velk  p¡smena
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=jm‚no souboru k normalizaci
;        CX=d‚lka jm‚na
; VSTUP:CX=nov  d‚lka jm‚na
; *****************************************************************************

NormFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx
         push      si
         push      di
         push      ds

; ------ p©¡prava registr–

         cld
         push      es
         pop       ds                       ; DS <- buffer se jm‚nem souboru
         mov       bx,cx                    ; BX <- celkov  d‚lka textu
         mov       di,si                    ; za‡ tek bufferu - ukl dac¡ adresa
         jcxz      NormFil9                 ; nen¡ ‘ dn˜ text

; ------ vypu¨tˆn¡ po‡ te‡n¡ch mezer

NormFil1:cmp       byte ptr ds:[si]," "     ; je mezera ?
         jne       NormFil2                 ; nen¡ mezera
         inc       si                       ; zv˜¨en¡ ukazatele textu
         dec       bx                       ; sn¡‘en¡ d‚lky textu
         loop      NormFil1                 ; sn¡‘en¡ ‡¡ta‡e zbyl˜ch znak–
         jmp       short NormFil9           ; nen¡ ‘ dn˜ text

; ------ odstranˆn¡ koncov˜ch mezer

NormFil2:cmp       byte ptr ds:[si+bx-1]," " ; je na konci mezera ?
         jne       NormFil3                 ; nen¡ mezera
         dec       bx                       ; sn¡‘en¡ d‚lky textu
         loop      NormFil2                 ; sn¡‘en¡ ‡¡ta‡e zbyl˜ch znak–

; ------ p©enesen¡ jm‚na disku (zb˜vaj¡-li alespo¤ 2 znaky)

NormFil3:cmp       cx,2                     ; zbyly alespo¤ 2 znaky ?
         jb        NormFil4                 ; kr tk˜ text - nen¡ disk
         cmp       byte ptr ds:[si+1],":"   ; za‡¡n  text ozna‡en¡m disku ?
         jne       NormFil4                 ; nen¡ ozna‡en¡ disku
         call      NormFil0                 ; na‡ten¡ ozna‡en¡ disku
         stosb                              ; ozna‡en¡ disku
         call      NormFil0                 ; na‡ten¡ oddˆlova‡e ":"

; ------ ulo‘en¡ oddˆlova‡e a vypu¨tˆn¡ mezer na konci jm‚na

NormFl34:cmp       byte ptr ds:[di-1]," "   ; p©edch z¡ mezera ?
         jne       NormFl35                 ; nep©edch z¡ mezera
         dec       di                       ; vypu¨tˆn¡ mezery
         dec       bx                       ; sn¡‘en¡ d‚lky textu
         jmp       short NormFl34           ; dal¨¡ znak
NormFl35:stosb                              ; ulo‘en¡ oddˆlovac¡ho znaku

; ------ vypu¨tˆn¡ mezer na za‡ tku jm‚na

NormFil4:jcxz      NormFl42                 ; nen¡ dal¨¡ znak
         cmp       byte ptr ds:[si]," "     ; n sleduje mezera ?
         jne       NormFl42                 ; nen sleduje mezera
         dec       bx                       ; sn¡‘en¡ ‡¡ta‡e d‚lky textu
         call      NormFil0                 ; zru¨en¡ znaku mezery
         jmp       short NormFil4           ; dal¨¡ znak

; ------ p©enesen¡ jm‚na

NormFl42:mov       dl,8                     ; maxim ln¡ d‚lka jm‚na
NormFil5:call      NormFil0                 ; na‡ten¡ dal¨¡ho znaku
         jc        NormFil9                 ; konec textu
         cmp       al,":"                   ; je oddˆlova‡ za©¡zen¡ ?
         je        NormFil5                 ; oddˆlova‡ za©¡zen¡ se ignoruje
         cmp       al,"\"                   ; oddˆlova‡ adres ©e - dal¨¡ jm‚no ?
         je        NormFl34                 ; dal¨¡ jm‚no adres ©e
         cmp       al,"."                   ; je p©¡pona ?
         je        NormFl63                 ; n sleduje p©¡pona
         or        dl,dl                    ; je ji‘ 8 znak– jm‚na ?
         jz        NormFil6                 ; je ji‘ 8 znak– jm‚na - p©esko‡en¡
         stosb                              ; ulo‘en¡ znaku
         dec       dx                       ; sn¡‘en¡ ‡¡ta‡e d‚lky jm‚na
         inc       bx                       ; p©ednastaven¡ pro platn˜ znak
NormFil6:dec       bx                       ; p©¡padn‚ sn¡‘en¡ d‚lky textu
         jmp       short NormFil5           ; dal¨¡ znak jm‚na

; ------ p©enesen¡ p©¡pony

NormFl63:stosb                              ; ulo‘en¡ znaku oddˆlova‡e "."
         mov       dl,3                     ; maxim ln¡ d‚lka p©¡pony
NormFl64:call      NormFil0                 ; na‡ten¡ dal¨¡ho znaku
         jc        NormFil9                 ; konec textu
         cmp       al,":"                   ; je oddˆlova‡ za©¡zen¡ ?
         je        NormFl64                 ; oddˆlova‡ za©¡zen¡ se ignoruje
         cmp       al,"\"                   ; oddˆlova‡ adres ©e - dal¨¡ jm‚no ?
         je        NormFl34                 ; dal¨¡ jm‚no adres ©e
         or        dl,dl                    ; jsou ji‘ 3 znaky p©¡pony ?
         jz        NormFl68                 ; jsou ji‘ 3 znaky - p©esko‡en¡
         stosb                              ; ulo‘en¡ znaku
         dec       dx                       ; sn¡‘en¡ ‡¡ta‡e d‚lky
         inc       bx                       ; p©ednastaven¡ pro platn˜ znak
NormFl68:dec       bx                       ; p©¡padn‚ sn¡‘en¡ d‚lky textu
         jmp       short NormFl64           ; dal¨¡ znak p©¡pony

; ------ ozna‡en¡ konce textu

NormFil9:mov       cx,bx                    ; nov  d‚lka textu
         mov       al,0                     ; koncov˜ znak 0
         stosb                              ; ulo‘en¡ koncov‚ 0 textu

; ------ n vrat registr–

         pop       ds
         pop       di
         pop       si
         pop       dx
         pop       bx
         pop       ax
         ret

NormFile ENDP

; -----------------------------------------------------------------------------
;        ‡ten¡ jednoho znaku p©i normalizaci jm‚na souboru
; -----------------------------------------------------------------------------

NormFil0 PROC      NEAR

; ------ na‡ten¡ znaku z bufferu

         stc                                ; p©¡znak, ‘e nen¡ dal¨¡ znak
         jcxz      NormFl03                 ; nen¡ dal¨¡ znak
         lodsb                              ; na‡ten¡ znaku z bufferu
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e znak–
         call      far ptr UpCase           ; konverze na velk‚ p¡smeno
         clc                                ; p©¡znak, ‘e je platn˜ znak
NormFl03:ret

NormFil0 ENDP

; *****************************************************************************
;                                FullFile
;                     sestaven¡ pln‚ho jm‚na souboru
; -----------------------------------------------------------------------------
; VSTUP: ES:SI=buffer se jm‚nem souboru k sestaven¡ (mus¡ b˜t normalizov no)
;        CX=d‚lka jm‚na
;        DS=datov˜ segment
; VSTUP:CX=nov  d‚lka jm‚na (omezeno na FileMax)
; *****************************************************************************

FullFile PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx
         push      si
         push      di
         push      bp
         push      ds
         mov       bp,sp
         mov       bx,cx                    ; d‚lka zadan‚ho textu

; ------ vytvo©en¡ bufferu v z sobn¡ku

         inc       cx                       ; zaokrouhlen¡ d‚lky nahoru
         and       cl,not 1                 ; zarovn n¡ na sudou d‚lku
         sub       sp,cx                    ; rezerva m¡sta v z sobn¡ku

; ------ £schova textu do bufferu v z sobn¡ku

         mov       di,sp                    ; buffer v z sobn¡ku
         push      es                       ; segment bufferu
         push      ds                       ; datov˜ segment
         push      si                       ; adresa bufferu s textem

         push      es
         pop       ds                       ; DS <- segment bufferu s textem
         push      ss
         pop       es                       ; ES <- buffer v z sobn¡ku
         cld
         shr       cx,1                     ; d‚lka textu ve slovech
         rep       movsw                    ; £schova textu do z sobn¡ku

         pop       di                       ; DI <- adresa bufferu s textem
         pop       ds                       ; DS <- datov˜ segment
         pop       es                       ; ES <- segment bufferu

; ------ inicializa‡n¡ ulo‘en¡ aktivn¡ho adres ©e

         push      di                       ; adresa bufferu textu
         mov       si,offset AktPath        ; aktivn¡ cesta
         mov       cx,ds:[AktPathN]         ; d‚lka cesty
         push      cx                       ; d‚lka aktivn¡ho adres ©e
         rep       movsb                    ; ulo‘en¡ aktivn¡ho adres ©e
         pop       cx                       ; d‚lka aktivn¡ho adres ©e
         pop       di                       ; adresa bufferu textu

; ------ kontrola, zda je zad n disk

         mov       si,sp                    ; buffer v z sobn¡ku
         cmp       bx,2                     ; jsou aspo¤ 2 znaky ?
         jb        FullFil2                 ; mal˜ po‡et znak– - nen¡ disk
         cmp       byte ptr ss:[si+1],":"   ; je zad n disk ?
         jne       FullFil2                 ; nen¡ zad n disk

; ------ pro aktivn¡ disk je adres © ji‘ nastaven

         mov       al,ss:[si]               ; zadan˜ disk
         cmp       al,es:[di]               ; je to aktivn¡ disk ?
         je        FullFil2                 ; je to aktivn¡ disk

; ------ adres © z neaktivn¡ho okna

         push      ax
         push      di
         push      si
         push      ds

         mov       ax,ds:[SegmNAkt]         ; neaktivn¡ okno
         call      far ptr GetSgAdr         ; adresa neaktivn¡ho okna
         jc        FullFil1                 ; nˆjak  chyba
         mov       ds,dx                    ; DS <- adresa okna

         mov       al,ss:[si]               ; zadan˜ disk
         mov       si,AWinDir
         cmp       al,ds:[si]               ; souhlas¡ disk ?
         stc
         jne       FullFil1                 ; disk nesouhlas¡

         cld
         mov       cx,ds:[AWinDNum]         ; d‚lka textu adres ©e
         push      cx
         rep       movsb                    ; p©enos textu adres ©e
         pop       cx
         clc                                ; p©¡znak operace OK

FullFil1:pop       ds
         pop       si
         pop       di
         pop       ax
         jnc       FullFil2                 ; adres © je OK

; ------ pro jin˜ disk na‡ten¡ aktivn¡ho adres ©e

         sub       al,"A"                   ; korekce na ‡¡slo disku
         call      far ptr GetDir           ; na‡ten¡ aktivn¡ho adres ©e
         jnc       FullFil2                 ; adres © na‡ten OK

; ------ chyba - vytvo©en¡ pomocn‚ho adres ©e

         add       al,"A"                   ; ozna‡en¡ disku
         mov       ah,":"                   ; oddˆlova‡ ozna‡en¡ disku
         mov       es:[di],ax               ; ozna‡en¡ disku a ":"
         mov       byte ptr es:[di+2],"\"   ; ozna‡en¡ ROOT
         mov       cx,3                     ; d‚lka adres ©e

; ------ p©¡prava k dek¢dov n¡ SS:SI/BX -> ES:DI/CX

FullFil2:push      ss
         pop       ds                       ; DS<-segment s textem k normalizaci
         cld

; ------ p©esko‡en¡ zad n¡ disku (byl rozli¨en ji‘ d©¡ve)

         cmp       bx,1                     ; je dostate‡n  d‚lka textu ?
         jb        FullFL22                 ; nen¡ nic zad no
         je        FullFl21                 ; je pouze 1 znak - m–‘e b˜t ROOT
         cmp       byte ptr ds:[si+1],":"   ; je zad n disk ?
         jne       FullFl21                 ; nebyl zad n disk
         inc       si
         inc       si                       ; p©esko‡en¡ zad n¡ disku
         dec       bx
         dec       bx                       ; zbyl˜ po‡et znak–
         jz        FullFl22                 ; nezbyly ‘ dn‚ znaky

; ------ rozli¨en¡, zda byl zad n ROOT

FullFl21:cmp       byte ptr ds:[si],"\"     ; byl zad n ROOT ?
         jne       FullFl22                 ; nebyl zad n ROOT
         mov       cx,3                     ; omezen¡ d‚lky cesty na ROOT
         inc       si                       ; p©esko‡en¡ znaku "\"
         dec       bx                       ; sn¡‘en¡ po‡tu znak–

; ------ za‡ tek k dek¢dov n¡

FullFl22:add       di,cx                    ; konec cesty
         mov       al,"\"                   ; oddˆlova‡
         cmp       es:[di-1],al
         je        FullFil3                 ; je ji‘ znak "\"
         stosb                              ; ulo‘en¡ oddˆlova‡e "\"
         inc       cx                       ; ‡¡ta‡ d‚lky

; ------ za‡ tek dek¢dov n¡ jednoho podadres ©e

FullFil3:cmp       bx,1                     ; zbyly je¨tˆ nˆjak‚ znaky ?
         jb        FullFil8                 ; konec textu
         je        FullFil4                 ; posledn¡ znak

; ------ posun k ni‘¨¡ £rovni (BX > 1)

         cmp       word ptr ds:[si],".."    ; je posun dol– ?
         jne       FullFil4                 ; nen¡ nadadres ©
         inc       si
         inc       si                       ; p©esko‡en¡ textu ".."
         dec       bx
         dec       bx                       ; sn¡‘eni ‡¡ta‡e zbyl˜ch znak–
         cmp       cl,3                     ; je ji‘ ROOT ?
         jbe       FullFil6                 ; je ji‘ ROOT - nic se nemˆn¡
FullFl32:dec       di                       ; posun o 1 znak dol–
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e d‚lky textu
         cmp       byte ptr es:[di-1],"\"   ; dosa‘eno p©ede¨l‚ho podadres ©e ?
         jne       FullFl32                 ; nalezen¡ p©ede¨l‚ho podadres ©e
         jmp       short FullFil6           ; dal¨¡ adres ©

; ------ stejn  £rove¤

FullFil4:cmp       byte ptr ds:[si],"."     ; je adres © stejn‚ £rovnˆ ?
         jne       FullFil5                 ; nen¡ adres © "."
         inc       si                       ; p©esko‡en¡ znaku "."
         dec       bx                       ; sn¡‘en¡ ‡¡ta‡e zbyl˜ch znak–
         jmp       short FullFil6           ; dal¨¡ adres ©

; ------ p©enesen¡ textu jednoho podadres ©e

FullFil5:cmp       byte ptr ds:[si],"\"     ; dosa‘eno koncov‚ho znaku "\" ?
         je        FullFil6                 ; je konec adres ©e
         or        bx,bx                    ; je konec textu ?
         jz        FullFil8                 ; konec textu
         lodsb                              ; na‡ten¡ znaku textu
         dec       bx                       ; sn¡‘en¡ ‡¡ta‡e zbyl˜ch znak–
         cmp       cl,FileMax               ; je ji‘ maxim ln¡ d‚lka cesty ?
         jae       FullFil5                 ; maxim ln¡ d‚lka - znak se ignoruje
         stosb                              ; ulo‘en¡ znaku adres ©e
         inc       cx                       ; zv˜¨en¡ ‡¡ta‡e d‚lky textu
         jmp       short FullFil5           ; dal¨¡ znak

; ------ vypu¨tˆn¡ zbyl˜ch znak– jednoho podadres ©e

FullFil6:or        bx,bx                    ; je ji‘ konec textu ?
         jz        FullFil8                 ; je ji‘ konec textu
         lodsb                              ; na‡ten¡ znaku z textu
         dec       bx                       ; sn¡‘en¡ ‡¡ta‡e zbyl˜ch znak–
         cmp       al,"\"                   ; nalezen dal¨¡ oddˆlova‡ adres ©e ?
         jne       FullFil6                 ; nalezen¡ dal¨¡ho oddˆlova‡e
         cmp       es:[di-1],al             ; byl text ukon‡en znakem "\" ?
         je        FullFil7                 ; byl ukon‡en znakem "\" - OK
         stosb                              ; ulo‘en¡ koncov‚ho znaku "\"
         inc       cx                       ; zv˜¨en¡ ‡¡ta‡e d‚lky textu
FullFil7:jmp       short FullFil3           ; dal¨¡ podadres ©

; ------ konec dek¢dov n¡ - oprava konce (aby nebyl "\" na konci)

FullFil8:cmp       byte ptr es:[di-2],":"   ; je to ROOT ?
         je        FullFil9                 ; je ROOT - "\" z–stane
         cmp       byte ptr es:[di-1],"\"   ; kon‡¡ text znakem "\" ?
         jne       FullFil9                 ; nekon‡¡ znakem "\" - je to OK
         dec       cx                       ; sn¡‘en¡ d‚lky textu
         dec       di                       ; n vrat na koncov˜ znak "\"
FullFil9:mov       byte ptr es:[di],0       ; ozna‡en¡ konce textu

; ------ n vrat registr–

         mov       sp,bp
         pop       ds
         pop       bp
         pop       di
         pop       si
         pop       dx
         pop       bx
         pop       ax
         ret

FullFile ENDP

CodeDisk ENDS

; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;
;                                 Data
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;þ
Data     SEGMENT

; ------ parametry pro inicializaci

;DiskIITx db        4,'Disk'                 ; skupina parametr–
;FormIITx db        6,'FormA1'               ; parametr form tu 1 disku A:
;ComDskTx db        5,'DiskA'                ; koment © k disku

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - adres © nelze kop¡rovat cyklicky
; -----------------------------------------------------------------------------
;þ
CopCErrM label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        CopCErrP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopCErrT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        54                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

CopCErrT db        19,'cyklick‚ kop¡rov n¡'

CopCErrP db        bit6,6,0,'CHYBA'
         db        bit6,43,'Adres © ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' nelze kop¡rovat s m do sebe !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - adres © nelze p©ejmenovat
; -----------------------------------------------------------------------------

RenDErrM label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        RenDErrP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PrejmenovaniAPresun  ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        RenDErrT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        49                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

RenDErrT db        25,'adres © nelze p©ejmenovat'

RenDErrP db        bit6,6,0,'CHYBA'
         db        bit6,33,'Adres © ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' nelze p©ejmenovat !'
         db        bit6,41,'(existuje ji‘ stejn˜ adres © nebo soubor)'
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - porovn van˜ soubor nenalezen
; -----------------------------------------------------------------------------

ChbCmEr  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        ChbCmErP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PorovnavaniSouboru   ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        ChbCmErT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        49                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

ChbCmErT db        16,'soubor nenalezen'

ChbCmErP db        bit6,6,0,'CHYBA'
         db        bit6,36,'Porovn van˜ soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' nenalezen !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;        varovn‚ hl ¨en¡ - porovn v n¡ souboru sama se sebou
; -----------------------------------------------------------------------------

ChbCmWr  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        ChbCmWrP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PorovnavaniSouboru   ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        ChbCmWrT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        52                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

ChbCmWrT db        13,'stejn˜ soubor'

ChbCmWrP db        bit6,9,0,'VAROVN‹'
         db        bit6,39,'Porovn v te soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' s m se sebou !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;        varovn‚ hl ¨en¡ - kop¡ruje se soubor s m do sebe
; -----------------------------------------------------------------------------

CopErD1  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        CopErD1P                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopErD1T                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        48                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

CopErD1T db        13,'kopie do sebe'

CopErD1P db        bit6,9,0,'VAROVN‹'
         db        bit6,37,'Kop¡rujete soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' s m do sebe !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;     chybov‚ hl ¨en¡ - existuje adres © stejn‚ho jm‚na jako kop¡rovan˜ soubor
; -----------------------------------------------------------------------------

CopyLD1  label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        CopyLD1P                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopyLD1T                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        6                        ; po‡ te‡n¡ © dek okna
         db        41                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

; ------ polo‘ky voleb

CopyLD1P db        bit6,6,0,'CHYBA'
         db        bit6,35,'Existuje ji‘ adres © stejn‚ho jm‚na'
         db        bit6,19,'jako soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' !'
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

CopyLD1T db        16,'existuje adres ©'


; -----------------------------------------------------------------------------
;     chybov‚ hl ¨en¡ - p©episovan˜ soubor nelze zru¨it
; -----------------------------------------------------------------------------

CopyLDPr label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        CopyLDPP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopyLDPT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        6                        ; po‡ te‡n¡ © dek okna
         db        50                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

; ------ polo‘ky voleb

CopyLDPP db        bit6,6,0,'CHYBA'
         db        bit6,39,'P©episovan˜ soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' nelze zru¨it !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

CopyLDPT db        19,'soubor nelze zru¨it'

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - chyba z pisu do souboru
; -----------------------------------------------------------------------------

ChbWrEr  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        ChbWrErP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PodmenuSoubory       ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        ChbWrErT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        43                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

ChbWrErT db        12,'chyba z pisu'

ChbWrErP db        bit6,6,0,'CHYBA'
         db        bit6,31,'Chyba z pisu do souboru ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - chyba ‡ten¡ ze souboru
; -----------------------------------------------------------------------------

ChbReEr  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        ChbReErP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PodmenuSoubory       ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        ChbReErT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        43                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

ChbReErT db        11,'chyba ‡ten¡'

ChbReErP db        bit6,6,0,'CHYBA'
         db        bit6,30,'Chyba ‡ten¡ ze souboru ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - chyba vytvo©en¡ souboru
; -----------------------------------------------------------------------------

CreaED1  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        CreaED1P                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PodmenuSoubory       ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CreaED1T                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        46                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

CreaED1T db        15,'chyba vytvo©en¡'

CreaED1P db        bit6,6,0,'CHYBA'
         db        bit6,29,'Soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' nelze vytvo©it !'
         db        bit6,3,1
CreaED2P dw        CreaED3P
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

CreaED3P db        33,'(p©¡li¨ mnoho soubor– v adres ©i)'
CreaED4P db        39,'(disk pln˜ nebo adres © nelze vytvo©it)'

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - chyba otev©en¡ souboru
; -----------------------------------------------------------------------------

ChbOpEr  label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        ChbOpErP                 ; za‡ tek definice polo‘ek menu
         dw        ChbOpErH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PodmenuSoubory       ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbOpErB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        ChbOpErT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        43                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

ChbOpErT db        14,'chyba otev©en¡'

ChbOpErP db        bit6,6,0,'CHYBA'
         db        bit6,28,'Soubor ',0,1
         dw        ChbOpErF                 ; jm‚no souboru
         db        0,' nelze otev©¡t !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

ChbOpErF db        12,'            '

HelpS    SEGMENT   BYTE PUBLIC
ChbOpErH db        37,'Pokra‡ov n¡ v operaci dal¨¡m souborem'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

ChbOpErB db        0,0

; -----------------------------------------------------------------------------
;        tabulka diskov˜ch informac¡
; -----------------------------------------------------------------------------
;þ
DiskNum  dw        0                        ; po‡et platn˜ch disk– v syst‚mu
DiskITbP db        0                        ; parametry disk–
                                            ;  bit 0: 1=nalezen s¡Ÿov˜/CD-ROM disk
                                            ;  bit 1: 1=nalezen CD-ROM disk

DiskITab label     byte                     ; (posledn¡=historie adres ©–)
         db        DiskMax+1 dup(0)         ; tabulka diskov˜ch informac¡ (0=nen¡)
                                            ;  bit 0 a‘ bit 2: typ disku
                                            ;           0=....neplatn˜ disk
                                            ;           1=disketov  mechanika
                                            ;           2=pevn˜ disk WINCHESTER
                                            ;           3=RAM disk
                                            ;           4=s¡Ÿov˜ disk
                                            ;           5=SUBST disk
                                            ;           6=CD ROM
                                            ;           7=
                                            ;  bit 3:
                                            ;  bit 4: 1=disk je d lkov˜
                                            ;  bit 5: 1=neumo‘¤uje sekt. p©¡stup
                                            ;  bit 6: 1=disk je pevn˜
                                            ;  bit 7: 1=disk je SUBST

; ------ obsluha diskov˜ch informac¡

DiskInfP db        0                        ; parametry disk–
                                            ;   bit 0:
                                                    ;   bit 1: 1=je editace © dku
                                            ;   bit 2:
                                            ;   bit 3: 1=buffer modifikov n
DiskInfS dw        0                        ; segment diskov˜ch informac¡
DiskInfA dw        0                        ; adresa za‡ tku aktivn¡ho © dku
DiskInfK dw        0                        ; adresa kurzoru p©i editaci

; ------ pracovn¡ buffer DTA

DTAAdr   dd        BuffDTA                  ; adresa aktivn¡ho DTA

BuffDTA  label     byte
         db        DTAMax dup(0)            ; pracovn¡ buffer DTA

; ------ buffer pro obsluhu dlouh‚ho jm‚na souboru
; €asy jsou ud ny jako po‡et 100ns od 1.1.1601 (zd  se, ‘e to je od 02:00:00)

; €asy lze zkonvertovat na tvar:  0: (1) 1/100 sekundy (rezervov no, zat¡m <- 0)
;                                 1: (1) sekunda
;                                 2: (1) minuta
;                                 3: (1) hodina
;                                 4: (1) den
;                                 5: (1) mˆs¡c
;                                 6: (2) rok
; €as modifikace je zkonvertov n ihned p©i hled n¡.

DTALong  label     byte
DTALAtr  label     byte
         db        0,0,0,0                  ; atributy (bit 8: 1=p©echodn˜)
DTALCrea label     byte
         dw        4 dup(0)                 ; ‡as vytvo©en¡ souboru
                                            ;  [DTALCrea+6] (2) =0 ... neplatn‚
DTALOpen label     byte
         dw        4 dup(0)                 ; ‡as posledn¡ho otev©en¡ souboru
                                            ;  [DTALOpen+6] (2) =0 ... neplatn‚
DTALModi dw        4 dup(0)                 ; ‡as posledn¡ modifikace souboru
DTALSizH dw        2 dup(0)                 ; velikost souboru HIGH
DTALSizL dw        2 dup(0)                 ; velikost souboru LOW
         dw        4 dup(0)                 ; .... rezervov no
                                          ;* posledn¡ bajt rezervovan‚ho pole
                                          ;* je nastaven na d‚lku dlouh‚ho jm‚na
                                          ;* kv–li jeho zobrazen¡
DTALName label     byte
         db        260 dup(0)               ; pln‚ ASCIIZ jm‚no souboru
DTALSNam label     byte
         db        14 dup(0)                ; kr tk‚ ASCIIZ jm‚no souboru

DTALNamN dw        0                        ; d‚lka dlouh‚ho jm‚na souboru

;DTALIdnt dw        -1                       ; identifik tor hled n¡ (-1=nen¡)

;DTALINul db        0,0b0h,4ch,1eh,8fh,0e7h,0a8h,1 ; ‡as pro 1.1.1980 v 00:00:00

; ------ aktu ln¡ adres © (dodr‘et po©ad¡ polo‘ek !)

AktPathN dw        3                        ; po‡et znak– textu adres ©e
AktPath  db        'C:\',FileDMax-3 dup(0)  ; cesta k aktivn¡mu adres ©i (+disk)

RootDir  db        'A:\',0

TempTxt  db        4,'TEMP'

DosmName db        'DOSMAN.EXE',0
DosmNam0 label     byte

Data     ENDS

         END
