
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;                              F I L E  -  4
;
;                 Obsluha soubor– - Informace, Modifikace, Program
;
; =============================================================================
;
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°

INCLUDE  ASM\DEF.ASM

CodeFil  SEGMENT   BYTE PUBLIC
         ASSUME    cs:CodeFil,ds:Data

; *****************************************************************************
;
;                   Informace o souboru (volba "Informace")
;
; *****************************************************************************
;þ
AWMMnuSI LABEL     FAR

; ------ p©¡prava k obsluze

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         call      far ptr ClosMnuA         ; uzav©en¡ v¨ech oken menu

InfoFile LABEL     FAR

         mov       byte ptr ds:[SIMnuLin+MnuAkt],1 ; aktivn¡ polo‘ka
         call      far ptr QSrcEnd          ; ukon‡en¡ rychlovyhled v n¡
         call      far ptr HistADir         ; ulo‘en¡ adres ©e do historie

; ------ test, zda je platn  polo‘ka pod kurzorem

         call      InfoTest                 ; test platnosti polo‘ky pod kurzorem
         jnc       InfoFl11                 ; je to platn  polo‘ka OK
InfoFil0:jmp       far ptr Main0

; ------ p©¡prava polo‘ky

InfoFl11:call      InfoPath                 ; p©¡prava cesty k polo‘ce
         call      InfoPMnu                 ; z kaz voleb menu
         call      InfoRead                 ; na‡ten¡ informa‡n¡ho souboru
         call      InfoParm                 ; p©¡prava parametr– polo‘ky (na‡ten¡)
InfoFl12:call      InfPDek                  ; dek¢dov n¡ parametr– polo‘ky

; ------ obsluha menu

         call      far ptr DispAAWn         ; zobrazen¡ aktivn¡ho okna
         mov       si,offset SIMnuLin
         call      far ptr Lin1Menu

         call      far ptr JumpBX           ; obsluha kl vesy

         dw        1,InfoFil2               ; zad n¡ koment ©e k polo‘ce
         dw        2,InfoFil4               ; editace popisu

         dw        5,InfoFil5               ; redukce polo‘ek
         dw        6,InfoFil3               ; zad n¡ nadpisu adres ©e
         dw        0,InfoFil0               ; p©eru¨en¡

; -----------------------------------------------------------------------------
;        redukce koment ©–
; -----------------------------------------------------------------------------

; ------ potvrzen¡ operace

InfoFil5:mov       si,offset InfoRMnu       ; menu - redukce polo‘ek
         call      far ptr Lin0MenF         ; potvrzen¡ operace
         jnc       InfoFl51
InfoFl50:jmp       InfoFil0

; ------ segment koment ©– (test, zda je platn˜) -> AX/ES

InfoFl51:call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         mov       ax,es:[AWinKomS]         ; segment koment ©–
         call      far ptr GetDat           ; adresa segmentu koment ©–
         jc        InfoFl50                 ; neplatn˜ segment

; ------ proveden¡ redukce

         call      InfoRed                  ; redukce koment ©–
         jmp       InfoFil0

; -----------------------------------------------------------------------------
;        redukce koment ©– (neuchov v  registry !)
; -----------------------------------------------------------------------------
; VSTUP: AX=segment koment ©– (aktivn¡ho okna)
;        ES=adresa segmentu koment ©–
; lok ln¡ promˆnn‚: SS:[BP-2] (2) ‡¡slo segmentu koment ©–
;                   SS:[BP-4] (2) adresa segmentu koment ©–
; -----------------------------------------------------------------------------

InfoRed  PROC      NEAR

; ------ p©¡prava registr–

         mov       bp,sp
         sub       sp,4
         mov       ss:[bp-2],ax             ; ‡¡slo segmentu koment ©–
         mov       ss:[bp-4],es             ; adresa segmentu koment ©–
         mov       si,2                     ; ukazatel dat koment ©–

; ------ test, zda jsou nˆjak‚ dal¨¡ © dky

InfoRed1:mov       es,ss:[bp-4]             ; ES <- adresa segmentu koment ©–
         cmp       si,es:[0]                ; bude dal¨¡ © dek ?
         jb        InfoRd12
         jmp       InfoRed9                 ; nen¡ dal¨¡ © dek
InfoRd12:mov       di,si                    ; DI <- £schova za‡ tku koment ©–

; ------ posun ukazatele na dal¨¡ © dek -> SI

InfoRed2:mov       al,es:[si]               ; d‚lka © dku
         mov       ah,0
         inc       si                       ; ukazatel na za‡ tek textu
         add       si,ax                    ; adresa dal¨¡ho © dku

; ------ test, zda je dal¨¡ © dek

         cmp       si,es:[0]                ; bude dal¨¡ © dek ?
         jae       InfoRed3                 ; nebude dal¨¡ © dek

; ------ test, zda je ji‘ platn˜ © dek dal¨¡ho koment ©e

         mov       al,es:[si+1]             ; prvn¡ znak © dku
         cmp       al,0
         je        InfoRed2                 ; pr zdn˜ © dek nen¡ platn˜
         cmp       al," "
         je        InfoRed2
         cmp       al,TAB
         je        InfoRed2

; ------ ochrana p©ed zru¨en¡m nadpisu

InfoRed3:cmp       di,2                     ; je to prvn¡ © dek ?
         jne       InfoRd32                 ; nen¡ to prvn¡ © dek
         cmp       byte ptr es:[di+1]," "   ; je nadpis ?
         jbe       InfoRed1                 ; je to nadpis

; ------ p©¡prava k vyhled n¡ indexu polo‘ky

InfoRd32:call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         mov       cx,es:[AWinSouN]         ; po‡et zobrazen˜ch polo‘ek
         mov       bx,word ptr es:[AWinKomI] ; tabulka index– - OFFSET
         mov       ax,es                    ; AX <- segment okna
         add       ax,word ptr es:[AWinKomI+2] ; segment tabulky index–
         mov       es,ax                    ; ES <- segment tabulky index–

; ------ vyhled n¡ indexu koment ©e v tabulce

         jcxz      InfoRed6                 ; nen¡ nic zobrazeno
InfoRed4:cmp       di,es:[bx]               ; minim ln¡ adresa
         jae       InfoRed5                 ; index nesouhlas¡
         cmp       si,es:[bx]               ; maxim ln¡ adresa
         jae       InfoRed1                 ; index nalezen OK - dal¨¡
InfoRed5:inc       bx
         inc       bx                       ; zv˜¨en¡ ukazatele v tabulce
         loop      InfoRed4                 ; test dal¨¡ho indexu

; ------ index nenalezen - vypu¨tˆn¡ koment ©e (po‡ tek DI, konec SI)

InfoRed6:mov       cx,si                    ; CX <- adresa konce koment ©e
         sub       cx,di                    ; d‚lka ru¨en‚ho koment ©e
         mov       ax,ss:[bp-2]             ; ‡¡slo segmentu koment ©–
         call      far ptr DelDat           ; zru¨en¡ dat z bufferu

; ------ korekce ukazatel– koment ©–

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         sub       es:[AWinKomN],cx         ; sn¡‘en¡ po‡tu bajt– v bufferu

; ------ p©¡prava ke korekci tabulky index–

         mov       dx,cx                    ; DX <- korekce tabulky index–
         mov       cx,es:[AWinSouN]         ; po‡et zobrazen˜ch polo‘ek
         mov       bx,word ptr es:[AWinKomI] ; tabulka index– - OFFSET
         mov       ax,es                    ; AX <- segment okna
         add       ax,word ptr es:[AWinKomI+2] ; segment tabulky index–
         mov       es,ax                    ; ES <- segment tabulky index–

; ------ korekce tabulky index–

         xchg      si,di                    ; SI <- za‡ tek, DI <- konec
         jcxz      InfoRd82                 ; nen¡ nic zobrazeno
InfoRed7:cmp       di,es:[bx]               ; maxim ln¡ adresa
         ja        InfoRed8                 ; nen¡ za ru¨en˜m koment ©em
         sub       es:[bx],dx               ; korekce indexu
InfoRed8:inc       bx
         inc       bx                       ; zv˜¨en¡ ukazatele v tabulce
         loop      InfoRed7                 ; korekce dal¨¡ho indexu
InfoRd82:jmp       InfoRed1                 ; dal¨¡ koment ©

; ------ ulo‘en¡ souboru FILEINFO

InfoRed9:mov       ax,ds:[SegmAkt]          ; aktivn¡ okno
         call      far ptr InitFKom         ; inicializace adres koment ©–
         call      far ptr WritFKom         ; ulo‘en¡ souboru FILEINFO

; ------ n vrat registr–

         mov       sp,bp
         ret

InfoRed  ENDP

; -----------------------------------------------------------------------------
;        zad n¡ koment ©e k polo‘ce
; -----------------------------------------------------------------------------

; ------ adresa indexu koment ©e -> ES:DI

InfoFil2:call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         mov       dx,es:[AWinKomS]         ; segment koment ©–
         mov       di,es:[AWinKurz]         ; kurzor
         shl       di,1                     ; offset v tabulce index–
         add       di,word ptr es:[AWinKomI] ; offset indexu koment ©e
         mov       ax,es                    ; segment okna
         add       ax,word ptr es:[AWinKomI+2] ; segment indexu koment ©e
         mov       es,ax                    ; ES <- segment indexu koment ©e

; ------ adresa koment ©e k polo‘ce -> ES:DI

         mov       byte ptr ds:[SIKMnPN1],0 ; p©ednastaven¡ - nen¡ koment ©
         mov       di,es:[di]               ; adresa koment ©e
         or        di,di                    ; je koment © definov n ?
         jz        InfoFl26                 ; koment © nen¡ definov 
         xchg      ax,dx                    ; AX <- segment koment ©–
         call      far ptr GetDat           ; adresa koment ©–
         jc        InfoFl26                 ; koment ©e nejsou
         mov       word ptr ds:[SIKMnPA1],di ; offset koment ©e
         mov       word ptr ds:[SIKMnPA1+2],es ; segment koment ©–

; ------ d‚lka koment ©e ES:DI -> CX

         xor       cx,cx                    ; CX <- 0  ‡¡ta‡ d‚lky
         dec       cx
         dec       di
InfoFl24:inc       di                       ; zv˜¨en¡ ukazatele textu
         inc       cx                       ; zv˜¨en¡ ‡¡ta‡e d‚lky
         cmp       es:[di],ch               ; konec ?
         jne       InfoFl24                 ; nalezen¡ konce textu
         mov       byte ptr ds:[SIKMnPD1],cl ; d‚lka koment ©e
         inc       byte ptr ds:[SIKMnPN1]   ; je 1 p©edvolba

; ------ zad n¡ nov‚ho koment ©e polo‘ky

InfoFl26:mov       si,offset SIKMnLin       ; menu
         call      far ptr Lin0Menu         ; zad n¡ nov‚ho koment ©e
         jc        InfoFl29                 ; p©eru¨en¡ operace

; ------ ulo‘en¡ zadan‚ho koment ©e

         mov       ax,ds:[SegmAkt]          ; segment okna
         call      far ptr StorFKom         ; ulo‘en¡ zadan‚ho koment ©e

InfoFl29:jmp       InfoFil0                 ; n vrat z menu

; -----------------------------------------------------------------------------
;        zad n¡ nadpisu adres ©e
; -----------------------------------------------------------------------------

; ------ p©¡prava koment ©e nadpisu

InfoFil3:call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         mov       di,es:[AWinKomA]         ; adresa nadpisu
         mov       cx,es:[AWinKomD]         ; d‚lka nadpisu
         mov       byte ptr ds:[SINMnPN1],0 ; p©ednastaven¡ - nen¡ p©edvolba
         or        di,di                    ; je koment © definov n ?
         jz        InfoFl32                 ; koment © nen¡ definov n
         jcxz      InfoFl32                 ; koment © m  d‚lku 0
         mov       ax,es:[AWinKomS]         ; segment koment ©–
         call      far ptr GetDat           ; adresa koment ©–
         jc        InfoFl32                 ; neplatn˜ segment
         mov       ds:[SINMnPD1],cx         ; d‚lka koment ©e
         mov       word ptr ds:[SINMnPA1],di; offset koment ©e
         mov       word ptr ds:[SINMnPA1+2],es ; segment koment ©–
         inc       byte ptr ds:[SINMnPN1]   ; 1 p©edvolba

; ------ zad n¡ nov‚ho koment ©e polo‘ky

InfoFl32:mov       si,offset SINMnLin
         call      far ptr Lin0Menu         ; zad n¡ nov‚ho koment ©e
         jc        InfoFl34                 ; p©eru¨en¡ operace

; ------ ulo‘en¡ zadan‚ho nadpisu

         mov       ax,ds:[SegmAkt]          ; segment okna
         call      far ptr StorNKom         ; ulo‘en¡ zadan‚ho koment ©e

InfoFl34:jmp       short InfoFl29           ; n vrat

; -----------------------------------------------------------------------------
;        dal¨¡ polo‘ka v oknˆ
; -----------------------------------------------------------------------------

InfoMDal PROC      FAR

         push      bx
         mov       bx,5000h                 ; k¢d kl vesy dol–

InfoMDl1:push      cx

         mov       ch,1                     ; maxim ln¡ po‡et pokus–
InfoMDl2:push      bx
         call      far ptr EditAWin         ; editace aktivn¡ho okna
         pop       bx
         call      InfoTest                 ; test platnosti polo‘ky
         jnc       InfoMDl3                 ; polo‘ka je platn  OK
         loop      InfoMDl2                 ; dal¨¡ pokus
         xor       bx,5000h XOR 4800h       ; zmˆna smˆru
         mov       ch,2
         jmp       short InfoMDl2

InfoMDl3:call      InfoPath                 ; p©¡prava cesty k polo‘ce
         call      InfoPMnu                 ; z kaz voleb menu
         call      InfoParm                 ; p©¡prava parametr– polo‘ky (na‡ten¡)
         call      InfPDek                  ; dek¢dov n¡ parametr– polo‘ky

         call      far ptr DispAll          ; nov‚ zobrazen¡ v¨eho

InfoMDl9:pop       cx
         pop       bx
         ret

InfoMDal ENDP

; -----------------------------------------------------------------------------
;        p©edchoz¡ polo‘ka v oknˆ
; -----------------------------------------------------------------------------

InfoMPre PROC      FAR

         push      bx

         mov       bx,4800h                 ; k¢d kl vesy nahoru
         jmp       short InfoMDl1           ; posun nahoru

InfoMPre ENDP

; -----------------------------------------------------------------------------
;        test platnosti polo‘ky pod kurzorem (CY=neplatn )
; -----------------------------------------------------------------------------

InfoTest PROC      NEAR

; ------ £schova registr–

         push      si
         push      es

; ------ test platnosti polo‘ky

         call      far ptr TestAAWn         ; test aktivn¡ho okna
         jc        InfoTst2                 ; nen¡ zapnuto
         call      far ptr GetAKurz         ; poskytnut¡ adresy kurzoru
         jc        InfoTst2                 ; nen¡ polo‘ka pod kurzorem
         test      byte ptr es:[si+FileAtr],ATRT ; je to platn  polo‘ka ?
         jnz       InfoTst2                 ; je to platn  polo‘ka OK
         stc                                ; p©¡znak, ‘e nen¡ platn  polo‘ka

; ------ n vrat registr–

InfoTst2:pop       es
         pop       si
         ret

InfoTest ENDP

; -----------------------------------------------------------------------------
;        p©¡prava cesty k polo‘ce pod kurzorem
; -----------------------------------------------------------------------------

InfoPath PROC      NEAR

; ------ £schova registr–

         push      cx
         push      si
         push      di
         push      es

; ------ ulo‘en¡ cesty aktivn¡ho adres ©e

         mov       si,offset AktPath        ; aktivn¡ cesta
         mov       di,offset FilePath       ; buffer jm‚na souboru
         mov       cx,ds:[AktPathN]         ; d‚lka aktivn¡ho adres ©e
         push      ds
         pop       es                       ; ES <- datov˜ segment
         cld
         inc       cx                       ; v‡etnˆ koncov‚ 0
         rep       movsb                    ; £schova aktivn¡ho adres ©e
         dec       di                       ; n vrat ukazatele na koncovou 0

; ------ test, zda se p©id v  jm‚no polo‘ky pod kurzorem

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         test      byte ptr es:[AWinPrm1],bit4 ; je to strom ?
         jnz       InfoPth6                 ; je to strom - polo‘ka je v cestˆ
         call      far ptr GetAKurz         ; poskytnut¡ adresy kurzoru
         cmp       byte ptr es:[si+FileName],"." ; je to ".." ?
         je        InfoPth6                 ; je to ".." - je ji‘ polo‘ka

; ------ zaji¨tˆn¡ oddˆlova‡e "\"

         cmp       byte ptr ds:[di-1],"\"   ; je cesta ukon‡ena "\" ?
         je        InfoPth2                 ; polo‘ka je ukon‡ena "\" OK
         mov       byte ptr ds:[di],"\"     ; oddˆlova‡ cesty
         inc       di

; ------ dek¢dov n¡ jm‚na polo‘ky ES:SI

InfoPth2:push      ds
         push      ds
         push      es
         pop       ds                       ; DS <- segment polo‘ky
         pop       es                       ; ES <- datov˜ segment (buffer)
         inc       si                       ; za‡ tek jm‚na souboru
         call      far ptr FileAsc          ; dek¢dov n¡ jm‚na polo‘ky na ASCII
         pop       ds

; ------ d‚lka textu cesty (se jm‚nem polo‘ky)

InfoPth6:sub       di,offset FilePath
         mov       ds:[FileFilN],di         ; d‚lka textu cesty s polo‘kou
         mov       ds:[FilePthN],di

; ------ n vrat registr–

         pop       es
         pop       di
         pop       si
         pop       cx
         ret

InfoPath ENDP

; -----------------------------------------------------------------------------
;        p©¡prava voleb
; -----------------------------------------------------------------------------

InfoPMnu PROC      NEAR

; ------ £schova registr–

         push      bx
         push      si
         push      es

; ------ p©ednastaven¡ - povolen¡ v¨ech voleb

         and       word ptr ds:[SIMnLBlk],not bit1+HI*bit1 ; "Koment ©" a "Editace"
         and       word ptr ds:[SIMnLBlk+2],not bit1+HI*bit1 ; "Dal¨¡" a "P©edchoz¡"
         and       word ptr ds:[SIMnLBlk+4],not bit1+HI*bit1 ; "Redukce" a "Adres ©"

; ------ z kaz volby "Dal¨¡", je-li posledn¡ polo‘ka v oknˆ

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         mov       bx,es:[AWinKurz]         ; kurzor
         inc       bx                       ; n sleduj¡c¡ polo‘ka
         cmp       bx,es:[AWinSouN]         ; je dal¨¡ polo‘ka ?
         jb        InfoPMn2                 ; bude dal¨¡ polo‘ka
         or        byte ptr ds:[SIMnLBlk+2],bit1 ; z kaz volby "Dal¨¡"

; ------ z kaz volby "P©edchoz¡", je-li prvn¡ polo‘ka nebo nebude-li platn  polo‘ka

InfoPMn2:dec       bx                       ; n vrat ‡¡sla kurzoru
         jz        InfoPMn4                 ; je to ji‘ prvn¡ polo‘ka - z kaz
         dec       bx                       ; p©ipraven  p©¡¨t¡ polo‘ka
         jnz       InfoPMn6                 ; nebude je¨tˆ prvn¡ polo‘ka - asi OK
         call      far ptr GetESPol         ; adresa p©¡¨t¡ polo‘ky
         test      byte ptr es:[si+FileAtr],ATRT ; bude to platn  polo‘ka ?
         jnz       InfoPMn6                 ; bude to platn  polo‘ka OK
InfoPMn4:or        byte ptr ds:[SIMnLBlk+3],bit1 ; z kaz volby "Zpˆt"

; ------ z kaz voleb "Koment ©", "Popis", "Redukce" a "Adres ©" pro strom a seznam

InfoPMn6:call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         test      byte ptr es:[AWinPrm1],bit3 ; je to adres ©ov‚ okno ?
         jnz       InfoPMn8                 ; je to adres ©ov‚ okno OK
         or        word ptr ds:[SIMnLBlk],bit1 + HI*bit1 ; z kaz "Koment ©" a "Editace"
         or        word ptr ds:[SIMnLBlk+4],bit1 + HI*bit1 ; z kaz "Redukce" a "Adres ©"

; ------ n vrat registr–

InfoPMn8:pop       es
         pop       si
         pop       bx
         ret

InfoPMnu ENDP

; -----------------------------------------------------------------------------
;        zaji¨tˆn¡ na‡ten¡ informa‡n¡ho souboru
; -----------------------------------------------------------------------------

InfoRead PROC      NEAR

; ------ £schova registr–

         push      ax
         push      es

; ------ test, zda to je adres ©ov‚ okno

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         test      byte ptr es:[AWinPrm1],bit3 ; je to adres ©ov‚ okno ?
         jz        InfoRea9                 ; nen¡ to adres ©ov‚ okno

; ------ test, zda ji‘ byl koment © na‡¡t n

         test      byte ptr es:[AWinPrm1],bit6 ; byl ji‘ koment © hled n ?
         jnz       InfoRea9                 ; koment © ji‘ byl hled n

; ------ hl ¨en¡ o na‡¡t n¡ informac¡

         mov       di,offset InfoCtuT       ; text - "Na‡¡t m informace"
         call      far ptr InfFile          ; zobrazen¡ hl ¨en¡

; ------ zaji¨tˆn¡ na‡ten¡ informa‡n¡ho souboru

         mov       al,es:[AWinPrm2]         ; sou‡asn˜ typ zobrazen¡ okna
         push      ax
         and       al,not bit5+bit6
         or        al,2*bit5                ; komentovan‚ okno
         mov       es:[AWinPrm2],al         ; komentovan‚ okno
         mov       ax,ds:[SegmAkt]          ; segment tohoto okna
         call      far ptr LoadFInf         ; na‡ten¡ informac¡
         call      far ptr InitFKom         ; inicializace koment ©–
         call      far ptr GetDat           ; obnoven¡ adresy okna
         pop       ax
         mov       es:[AWinPrm2],al         ; n vrat typu okna

         call      far ptr InfoClos         ; uzav©en¡ informa‡n¡ho © dku

; ------ n vrat registr–

InfoRea9:pop       es
         pop       ax
         ret

InfoRead ENDP

; -----------------------------------------------------------------------------
;        p©¡prava parametr– polo‘ky (na‡ten¡ informac¡ z okna a z disku)
; -----------------------------------------------------------------------------

InfoParm PROC      NEAR

; ------ £schova registr–

         push      ax
         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ p©¡prava velikosti aloka‡n¡ho bloku disku

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         mov       ax,es:[AWinAlok]         ; velikost aloka‡n¡ho bloku
         test      byte ptr es:[AWinPrm0],bit6 ; je CD-ROM ?
         jz        InfoPrm1                 ; nen¡ CD-ROM
         mov       ax,2048                  ; velikost pro CD-ROM

InfoPrm1:mov       ds:[SInfBlk],ax          ; velikost aloka‡n¡ho bloku

; ------ na‡ten¡ parametr– polo‘ky s okna

         call      far ptr GetAKurz         ; poskytnut¡ adresy kurzoru -> ES:SI
         push      ds
         push      ds
         push      es
         pop       ds                       ; DS <- segment polo‘ky
         pop       es                       ; ES <- datov˜ segment
         mov       di,offset FileFPol       ; fiktivn¡ polo‘ka
         mov       cx,20/2                  ; velikost polo‘ky
         cld
         rep       movsw                    ; £schova parametr– polo‘ky
         pop       ds

; ------ test, zda je polo‘ka adres ©

         test      byte ptr ds:[FileFAtr],DIR ; je to adres © ?
         jz        InfoPrm4                 ; nen¡ to adres ©

; ------ aktualizace parametr– podadres ©e

         call      InfFilD                  ; informace o aktivn¡m adres ©i
         mov       ax,word ptr ds:[SInfSize]
         mov       word ptr ds:[FileFSiz],ax
         mov       ax,word ptr ds:[SInfSize+2]
         mov       word ptr ds:[FileFSiz+2],ax
         jmp       short InfoPrm7

; ------ p©¡prava obsazen‚ kapacity pro soubor

InfoPrm4:mov       cx,ds:[SInfBlk]          ; velikost aloka‡n¡ho bloku
         mov       ax,word ptr ds:[FileFSiz] ; velikost souboru LOW
         mov       dx,word ptr ds:[FileFSiz+2] ; velikost souboru HIGH
         dec       cx                       ; velikost bloku - 1
         add       ax,cx                    ; zaokrouhlen¡ nahoru
         adc       dx,0
         inc       cx                       ; n vrat velikosti bloku
         cmp       dx,cx                    ; p©ekro‡en max. po‡et blok– ?
         jae       InfoPrm6                 ; p©ekro‡ena max. velikost
         div       cx                       ; po‡et aloka‡n¡ch blok–
         mul       cx                       ; kapacita
InfoPrm6:mov       word ptr ds:[SInfKap],ax ; zabran  kapacita LOW
         mov       word ptr ds:[SInfKap+2],dx ; zabran  kapacita HIGH
         mov       word ptr ds:[SInfSoub],1 ; je to 1 soubor

; ------ na‡ten¡ dlouh‚ho jm‚na souboru

InfoPrm7:mov       byte ptr ds:[DTALName-1],0 ; nen¡ dlouh‚ jm‚no
         mov       word ptr ds:[SIMnLPl3],offset SRMnuVL0 ; nejsou informace
         test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
         jnz       InfoPrm9                 ; nejsou dlouh  jm‚na
         call      InfoPath                 ; p©¡prava cesty k polo‘ce
         mov       si,offset FilePath       ; buffer jm‚na souboru
         push      ds
         pop       es                       ; ES <- datov˜ segment
         call      far ptr ExisFile         ; na‡ten¡ dlouh‚ho jm‚na

; ------ konverze font– dlouh‚ho jm‚na

;         mov       si,offset DTALName
;         mov       cx,ds:[DTALNamN]         ; d‚lka textu
;         mov       dx,bit3+bit2*HI          ; z Latin 2 do Kamenick˜ch
;         call      far ptr KonvFnt          ; konverze font–

; ------ test, zda bude ‡as otev©en¡ ‡i vytvo©en¡

         mov       ax,word ptr ds:[DTALCrea+2] ; datum vytvo©en¡ souboru
         or        ax,word ptr ds:[DTALOpen+2] ; datum otev©en¡ souboru
         jz        InfoPrm9                 ; nejsou platn‚
         mov       word ptr ds:[SIMnLPl3],offset SRMnuVLn ; jsou informace

; ------ p©¡prava data a ‡asu vytvo©en¡ a otev©en¡

         mov       ax,word ptr ds:[DTALCrea+2]
         mov       ds:[SIMnBuf],ax          ; datum vytvo©en¡
         mov       si,offset SIMnBuf-FileDate
         mov       di,offset SRMnuVtD       ; datum vytvo©en¡
         mov       dx,ds                    ; DX <- datov˜ segment
         mov       ah,0                     ; barva se neukl d 
         call      far ptr DekA4Dat         ; dek¢dov n¡ data

         mov       cx,word ptr ds:[DTALCrea]
         mov       ds:[SIMnBuf],cx          ; ‡as vytvo©en¡
         mov       si,offset SIMnBuf-FileTime
         mov       di,offset SRMnuVtT       ; ‡as vytvo©en¡
         call      far ptr DekATmS          ; dek¢dov n¡ ‡asu vytvo©en¡

         mov       dx,word ptr ds:[DTALOpen+2]
         mov       ds:[SIMnBuf],dx          ; datum otev©en¡
         mov       si,offset SIMnBuf-FileDate
         mov       di,offset SRMnuOpn       ; datum otev©en¡
         mov       dx,ds                    ; DX <- datov˜ segment
         call      far ptr DekA4Dat         ; dek¢dov n¡ data

; ------ n vrat registr–

InfoPrm9:pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       ax
         ret

InfoParm ENDP

; -----------------------------------------------------------------------------
;                                 InfFilD
;           stanoven¡ parametr– adres ©e pod kurzorem v aktivn¡m oknˆ
; -----------------------------------------------------------------------------
; VSTUP:  DS=datov˜ segment
;         FilePath=pln‚ jm‚no adres ©e (d‚lka FileFilN)
;         [SInfBlk] = je ji‘ p©ipravena velikost aloka‡n¡ho bloku
;         hl ¨en¡ je zobrazeno
; VSTUP: CY=chyba nebo p©eru¨en¡ operace
; -----------------------------------------------------------------------------
; lok ln¡ promˆnn‚: [BP-2] (2) ‡¡ta‡ £rovn¡
; -----------------------------------------------------------------------------

InfFilD  PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      bp
         mov       bp,sp
         sub       sp,2                     ; lok ln¡ promˆnn 

; ------ hl ¨en¡ o na‡¡t n¡ informac¡

         mov       di,offset InfoCtuT       ; text - "Na‡¡t m informace"
         call      far ptr InfFile          ; zobrazen¡ hl ¨en¡

; ------ inicializace ukazatel–

         xor       ax,ax                    ; AX <- 0
         mov       word ptr ds:[SInfSize],ax ; velikost adres ©e LOW
         mov       word ptr ds:[SInfSize+2],ax ; velikost adres ©e HIGH
         mov       word ptr ds:[SInfKap],ax  ; zabran  kapacita LOW
         mov       word ptr ds:[SInfKap+2],ax ; zabran  kapacita HIGH
         mov       word ptr ds:[SInfSoub],ax ; po‡et soubor– v adres ©i
         mov       word ptr ss:[bp-2],0     ; ‡¡ta‡ hloubky vno©en¡

; ------ bude vno©en¡ do podadres ©e

InfFilD2:inc       word ptr ss:[bp-2]       ; zv˜¨en¡ ‡¡ta‡e hloubky vno©en¡
         sub       sp,DTAMax                ; m¡sto pro polo‘ku DTA

; ------ nastaven¡ pracovn¡ adresy DTA

         push      ss
         pop       es                       ; ES <- segment SS
         mov       si,sp                    ; adresa polo‘ky DTA v z sobn¡ku
         mov       bx,si                    ; £schova adresy polo‘ky DTA
         call      far ptr SetDTA           ; nastaven¡ pracovn¡ adresy DTA

; ------ p©id n¡ textu "*.*" k cestˆ

         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset All            ; text "*.*"
         call      far ptr AddGFil          ; p©id n¡ textu "*.*"

; ------ nalezen¡ prvn¡ho souboru

         mov       cx,DIR+HID+SYS+RO+ARC    ; atributy souboru
         mov       si,offset FilePath       ; specifikace
         call      far ptr SrcFirst         ; nalezen¡ prvn¡ polo‘ky

; ------ zru¨en¡ textu "*.*" ze specifikace

         pushf
         call      far ptr SubGFil          ; odstranˆn¡ textu "*.*"
         popf

; ------ test, zda bylo nˆco nalezeno

InfFilD3:jc        InfFilD7                 ; nˆjak  chyba nebo p©eru¨en¡
         jne       InfFilD7                 ; nen¡ dal¨¡ polo‘ka v adres ©i
         cmp       byte ptr ss:[bx+DTAName],"." ; je to adres © "." nebo ".." ?
         je        InfFilD8                 ; zak zan˜ adres ©

; ------ rozli¨en¡, zda byl nalezen adres © nebo soubor

         test      byte ptr ss:[bx+DTAAtrib],DIR ; je to adres © ?
         jnz       InfFilD6                 ; byl nalezen adres ©

; ------ p©i‡ten¡ parametr– souboru

         inc       word ptr ds:[SInfSoub]   ; zv˜¨en¡ ‡¡ta‡e soubor–
         mov       ax,ss:[bx+DTASize]       ; velikost souboru LOW
         mov       dx,ss:[bx+DTASize+2]     ; velikost souboru HIGH
         mov       cx,ds:[SInfBlk]          ; velikost aloka‡n¡ho bloku
         add       word ptr ds:[SInfSize],ax ; velikost souboru LOW
         adc       word ptr ds:[SInfSize+2],dx ; velikost souboru HIGH
         dec       cx                       ; velikost alok. bloku - 1
         add       ax,cx                    ; zaokrouhlen¡ na aloka‡n¡ blok
         adc       dx,0
         inc       cx
         cmp       dx,cx                    ; bylo by p©ete‡en¡ ?
         jae       InfFilD5                 ; bylo by p©ete‡en¡
         div       cx                       ; v˜po‡et po‡tu zabran˜ch blok–
         mul       cx                       ; zabran  kapacita
InfFilD5:add       word ptr ds:[SInfKap],ax ; zabran  kapacita LOW
         adc       word ptr ds:[SInfKap+2],dx ; zabran  kapacita HIGH
         jmp       short InfFilD8           ; dal¨¡ polo‘ka

; ------ nalezen adres © - vno©en¡ do podadres ©e

InfFilD6:push      ss
         pop       es                       ; ES <- buffer v z sobn¡ku
         mov       si,sp                    ; SI <- adresa polo‘ky DTA
         add       si,DTAName               ; jm‚no nalezen‚ho souboru
         call      far ptr AddGFil          ; p©id n¡ nalezen‚ho adres ©e
         jmp       short InfFilD2           ; vno©en¡ do podadres ©e

; ------ nen¡ dal¨¡ polo‘ka - sn¡‘en¡ £rovnˆ

InfFilD7:call      far ptr SrcClose         ; uzav©en¡ star‚ho hled n¡

         dec       word ptr ss:[bp-2]       ; ‡¡ta‡ polo‘ek DTA
         clc                                ; p©¡znak operace OK
         jz        InfFilD9                 ; nen¡ dal¨¡ polo‘ka - konec
         add       sp,DTAMax                ; zru¨en¡ polo‘ky DTA
         call      far ptr SubGFil          ; zru¨en¡ posledn¡ polo‘ky z cesty

; ------ nastaven¡ p©ede¨l‚ adresy DTA

         push      ss
         pop       es                       ; ES <- buffer v z sobn¡ku
         mov       si,sp                    ; adresa polo‘ky DTA v z sobn¡ku
         mov       bx,si                    ; £schova adresy polo‘ky DTA
         call      far ptr SetDTA           ; nastaven¡ pracovn¡ adresy DTA

; ------ vyhled n¡ dal¨¡ polo‘ky v adres ©i

InfFilD8:call      far ptr TestBreak        ; test p©eru¨en¡ operace
         jc        InfFilD9                 ; je p©eru¨en¡ operace
         call      far ptr SrcNext          ; nalezen¡ dal¨¡ polo‘ky v adres ©i
         jmp       short InfFilD3           ; test dal¨¡ polo‘ky

; ------ n vrat registr–

InfFilD9:mov       sp,bp
         pop       bp
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx

; ------ ulo‘en¡ velikosti polo‘ky

         pushf
         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         test      byte ptr es:[AWinPrm1],bit4 ; je to strom ?
         jnz       InfFilDA                 ; pro strom se neukl d 
         call      far ptr GetAKurz          ; adresa polo‘ky
         mov       ax,word ptr ds:[SInfSize] ; velikost polo‘ky LOW
         mov       word ptr es:[si+FileSize],ax ; velikost polo‘ky LOW
         mov       ax,word ptr ds:[SInfSize+2] ; velikost polo‘ky HIGH
         mov       word ptr es:[si+FileSize+2],ax ; velikost polo‘ky HIGH

; ------ ukon‡en¡ re‘imu vyhled v n¡

         mov       ax,ds:[SegmAkt]          ; segment aktivn¡ho okna
         call      far ptr AktSelct         ; aktualizace v˜bˆru polo‘ek
InfFilDA:call      far ptr InfoClos         ; uzav©en¡ informa‡n¡ho © dku
         popf
         pop       ax
         ret

InfFilD  ENDP

; -----------------------------------------------------------------------------
;        dek¢dov n¡ parametr– polo‘ky do menu
; -----------------------------------------------------------------------------

InfPDek  PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ dek¢dov n¡ z kladn¡ch parametr– polo‘ky

         call      far ptr DekFParm         ; dek¢dov n¡ parametr– polo‘ky

; ------ konverze font– jm‚na souboru

;         test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
;         jnz       InfPDek0                 ; nejsou dlouh  jm‚na
;
;         push      ds
;         pop       es
;         mov       si,offset SRMnuFil
;         mov       ch,0
;         mov       cl,ds:[si]               ; d‚lka textu
;         mov       dx,bit3+bit2*HI          ; z Latin 2 do Kamenick˜ch
;         call      far ptr KonvFnt          ; konverze font–

; ------ oprava jm‚na polo‘ky pro ".."

InfPDek0:call      far ptr GetAKurz         ; adresa kurzoru
         mov       ax,".."
         cmp       word ptr es:[si+FileName],ax ; je to ".." ?
         jne       InfPDek1
         mov       word ptr ds:[SRMnuFil+1],ax
         mov       byte ptr ds:[SRMnuFil],2

; ------ vymaz n¡ bufferu obsazen‚ kapacity

InfPDek1:push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       di,offset SIMKapac       ; buffer obsazen‚ kapacity
         cld
         push      di
         mov       cx,13                    ; d‚lka bufferu
         mov       al," "
         rep       stosb                    ; vymaz n¡ bufferu obsazen‚ kapacity
         pop       di

; ------ dek¢dov n¡ obsazen‚ kapacity

         mov       ax,word ptr ds:[SInfKap] ; zabran  kapacita
         mov       dx,word ptr ds:[SInfKap+2]
         mov       bh,0                     ; atribut barvy se neukl d 
         mov       bl,ds:[OddelRad]         ; znak oddˆlova‡e © d–
         call      far ptr DekNum           ; dek¢dov n¡ £daje velikosti

; ------ vymaz n¡ bufferu po‡tu soubor– (CH=0)

         mov       di,offset SIMSoub        ; buffer po‡tu soubor–
         cld
         push      di
         mov       cl,6
         mov       al," "
         rep       stosb                    ; vymaz n¡ bufferu po‡tu soubor–
         pop       di

; ------ dek¢dov n¡ po‡tu soubor– (BH=0, BL=oddˆlova‡ © d–)

         mov       byte ptr ds:[di],"-"     ; p©¡znak, ‘e nen¡ adres ©
         test      byte ptr ds:[FileFAtr],DIR ; je to adres © ?
         jz        InfPDek2                 ; nen¡ to adres ©
         mov       ax,ds:[SInfSoub]         ; po‡et soubor– v adres ©i
         call      far ptr DekNumW          ; dek¢dov n¡ po‡tu soubor–

; ------ p©ednastaven¡ - nejsou koment ©e

InfPDek2:mov       di,offset SIMKomK        ; koment ©e
         mov       cx,10                    ; po‡et © dk– koment ©–
InfPDek3:mov       byte ptr ds:[di],0       ; nen¡ koment ©
         mov       word ptr ds:[di+1],0     ; nen¡ ani platn  adresa
         add       di,11
         loop      InfPDek3                 ; dal¨¡ © dek

; ------ test, zda je adres ©ov‚ okno

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         test      byte ptr es:[AWinPrm1],bit3 ; je to adres ©ov‚ okno ?
         jz        InfPDek9                 ; nen¡ to adres ©ov‚ okno

; ------ adresa segmentu koment ©– -> DX

         mov       ax,es:[AWinKomS]         ; CX <- ‡¡slo segmentu koment ©–
         call      far ptr GetSgAdr         ; DX <- adresa segmentu koment ©–
         jc        InfPDek9                 ; nen¡ segment koment ©–

; ------ adresa koment ©e k polo‘ce -> ES:SI

         mov       ax,es                    ; AX <- adresa segmentu okna
         mov       si,es:[AWinKurz]         ; SI <- aktivn¡ polo‘ka
         shl       si,1                     ; offset v tabulce index–
         add       si,word ptr es:[AWinKomI] ; offset v tabulce index–
         add       ax,word ptr es:[AWinKomI+2] ; segment v tabulce index–
         mov       es,ax                    ; ES <- segment v tabulce index–
         mov       si,es:[si]               ; SI <- offset koment ©e
         or        si,si                    ; je koment © ?
         jz        InfPDek9                 ; nen¡ koment © k polo‘ce
         mov       es,dx                    ; DS <- segment koment ©–

; ------ ulo‘en¡ adresy koment ©e k polo‘ce

         mov       di,offset SIMKomK
         mov       word ptr ds:[di+1],si    ; offset koment ©e
         mov       word ptr ds:[di+3],es    ; segment koment ©e

; ------ zji¨tˆn¡ d‚lky koment ©e

         cld
         xor       cx,cx                    ; ‡¡ta‡ d‚lky koment ©e
         dec       cx
         dec       si
InfPDek4:inc       cx
         inc       si
         cmp       byte ptr es:[si],0
         jne       InfPDek4
         mov       ds:[di],cl               ; d‚lka koment ©e

; ------ test, zda je dal¨¡ © dek

         mov       bx,9                     ; po‡et © dk–
InfPDek5:inc       si                       ; p©esko‡en¡ bajtu 0
         add       di,11                    ; adresa ukazatele dal¨¡ho © dku
         cmp       si,es:[0]                ; je ji‘ konec dat ?
         jae       InfPDek9                 ; je ji‘ konec dat

; ------ p©¡prava dal¨¡ho © dku

         mov       ch,0
         mov       cl,es:[si]               ; d‚lka © dku
         inc       si                       ; za‡ tek textu © dku

; ------ test, zda to je © dek popisu polo‘ky

         dec       cx                       ; je pr zdn˜ © dek ?
         jz        InfPDek7                 ; pr zdn˜ © dek je platn˜
         cmp       byte ptr es:[si]," "     ; za‡¡n  © dek mezerou ?
         je        InfPDek6                 ; za‡¡n  mezerou - je platn˜
         cmp       byte ptr es:[si],TAB     ; za‡¡n  tabul torem ?
         jne       InfPDek9                 ; nen¡ to platn˜ © dek popisu

; ------ nalezen¡ za‡ tku textu © dku

InfPDek6:inc       si                       ; zv˜¨en¡ ukazatele textu
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e d‚lky © dku
         cmp       byte ptr es:[si]," "     ; mezera ?
         je        InfPDek6                 ; mezera se vypust¡
         cmp       byte ptr es:[si],TAB     ; tabul tor ?
         je        InfPDek6                 ; tabul tor se vypust¡

; ------ ulo‘en¡ parametr– © dku

InfPDek7:mov       ds:[di],cl               ; d‚lka © dku
         mov       ds:[di+1],si             ; offset adresy © dku
         mov       ds:[di+3],es             ; segment adresy © dku

; ------ p©¡prava pro dal¨¡ © dek

         add       si,cx                    ; adresa konce © dku
         dec       bx                       ; ‡¡ta‡ © dk–
         jnz       InfPDek5                 ; dal¨¡ © dek popisu

; ------ n vrat registr–

InfPDek9:pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

InfPDek  ENDP

; -----------------------------------------------------------------------------
;        editace popisu
; -----------------------------------------------------------------------------

; ------ otev©en¡ okna editoru -> ES:DI=buffer, CX=d‚lka

InfoFil4:call      far ptr InfoClos         ; uzav©en¡ informa‡n¡ho © dku
         mov       si,offset PopisMnu       ; menu editoru popisu polo‘ky
         call      far ptr OpenText         ; otev©en¡ bufferu textu
         jc        InfoFl40                 ; chyba pamˆti
         mov       ds:[si+EdMnuSeg],ax      ; segment okna
         call      InfoF4Pr                 ; inicializace editoru

; ------ na‡ten¡ textu k editaci

         call      InfoF4Re                 ; na‡ten¡ textu k editaci
         jnc       InfoFl43                 ; operace OK

; ------ chyba pamˆti

InfoFl40:call      far ptr MemErr           ; chyba pamˆti
         jmp       InfoFl49

; ------ otev©en¡ okna menu

InfoFl43:call      far ptr OpenMnu          ; otev©en¡ okna menu editoru

; ------ editace okna

InfoFl44:mov       si,offset PopisMnu       ; menu editoru
         call      far ptr KorEMnu          ; korekce okna
         test      byte ptr ds:[TextEPar],bit3 ; je t©eba zobrazit v¨e ?
         jz        InfoFl45                 ; nen¡ zobrazen¡ v¨eho
         call      far ptr DispAll
         jmp       short InfoFl46
InfoFl45:call      far ptr DispMnu          ; zobrazen¡ okna

; ------ vstup znaku z kl vesnice -> BX

InfoFl46:call      far ptr InpChar          ; vstup znaku z kl vesnice

; ------ menu kl ves mal‚ n povˆdy

         push      di
         mov       di,offset TxtMnHM1       ; menu kl ves mal‚ n povˆdy
         call      far ptr MenKlHlp         ; obsluha menu kl ves
         pop       di

; ------ p©¡prava k obsluze kl vesy

InfoF464:mov       ax,ds:[si+EdMnuSeg]
         call      far ptr GetDat           ; adresa segmentu okna -> ES
         and       byte ptr ds:[TextEPar],not bit0+bit1+bit2+bit3

; ------ skok na obsluhu kl vesy

         cmp       bl,27                    ; je p©eru¨en¡ ESC ?
         je        InfoFl48                 ; je p©eru¨en¡ editace ESC
         call      far ptr JumpBX           ; skok na obsluhu kl vesy

         dw        4400h,InfoF472           ; F10 - obsluha menu
         dw        MousXKod+MousXMP,InfoF472 ; stisk st©edn¡ho tla‡¡tka my¨i
         dw        3c00h,InfoF474           ; F2 - ulo‘en¡ souboru
         dw        0,InfoFl47               ; jin‚ kl vesy

; ------ obsluha editace kl ves

InfoFl47:call      far ptr EditEMnu         ; editace okna menu
         jmp       short InfoFl44           ; pokra‡ov n¡ v editaci

; ------ F10 - menu

InfoF472:call      far ptr ZapisMnX         ; obsluha menu
         jnc       InfoF464                 ; v BX je k¢d kl vesy
         jmp       short InfoFl44           ; nen¡ kl vesa (p©eru¨en¡)

; ------ F2 - ulo‘en¡ zmˆn

InfoF474:call      InfoPUlo                 ; ulo‘en¡ editovan‚ho popisu polo‘ky
         jmp       short InfoFl44           ; dal¨¡ kl vesa

; ------ test, zda se m  text ulo‘it

InfoFl48:test      byte ptr es:[TextParm],bit1 ; text modifikov n ?
         jz        InfoF486                 ; nebyl modifikov n

         mov       si,offset ZUSMnLin       ; menu - text modifikov n
         call      far ptr Lin0Menu         ; volba operace
         jc        InfoFl44                 ; p©eru¨en¡ operace

         dec       bx                       ; ulo‘en¡ souboru ?
         jnz       InfoF486                 ; p©eru¨en¡ operace
         call      InfoPUlo                 ; ulo‘en¡ editovan‚ho popisu
         jc        InfoFl44                 ; p©eru¨en¡ operace

; ------ uzav©en¡ okna editoru

InfoF486:mov       si,offset PopisMnu
         call      far ptr ClosMnu
         mov       ax,word ptr ds:[PopisMnu+EdMnuSeg] ; segment bufferu
         call      far ptr DelSeg           ; zru¨en¡ segmentu
         mov       word ptr ds:[PopisMnu+EdMnuSeg],ax

InfoFl49:jmp       InfoFl12

; -----------------------------------------------------------------------------
;        p©¡prava parametr– k editaci popisu (ES=segment editoru)
; -----------------------------------------------------------------------------

InfoF4Pr PROC      NEAR

; ------ £schova registr–

         push      cx
         push      si
         push      di

; ------ jm‚no souboru (mˆlo by ji‘ b˜t p©ipraveno v SRMnuFil)

         mov       si,offset SRMnuFil+1     ; jm‚no souboru
         mov       ch,0
         mov       cl,ds:[si-1]             ; d‚lka jm‚na souboru
         cld
         mov       es:[TextNamN],cl         ; d‚lka jm‚na souboru
         mov       di,TextName              ; buffer jm‚na souboru
         rep       movsb                    ; ulo‘en¡ jm‚na souboru

; ------ koment © k polo‘ce

         push      ds
         mov       cl,ds:[SIMKomK]          ; d‚lka koment ©e
         lds       si,dword ptr ds:[SIMKomK+1] ; adresa koment ©e
         mov       di,TextKom               ; buffer koment ©e
         cmp       cl,50                    ; je d‚lka koment ©e OK ?
         jbe       InfoF4P2                 ; d‚lka koment ©e je OK
         mov       cl,50                    ; omezen¡ d‚lky koment ©e
InfoF4P2:mov       es:[TextNKom],cl         ; d‚lka koment ©e
         rep       movsb                    ; p©enos textu koment ©e
         pop       ds

; ------ n vrat registr–

         pop       di
         pop       si
         pop       cx
         ret

InfoF4Pr ENDP

; -----------------------------------------------------------------------------
;        na‡ten¡ © dk– k editaci (ES:DI=adresa bufferu, CX=velikost) -> CY chyba
; -----------------------------------------------------------------------------

InfoF4Re PROC      NEAR

; ------ £schova registr–

         push      cx
         push      si
         push      di
         push      ds

; ------ p©¡prava registr– k na‡ten¡ © dk–

         cld
         lds       si,dword ptr ds:[SIMKomK+1+11] ; adresa prvn¡ho © dku popisu
         or        si,si                    ; je platn˜ © dek ?
         jz        InfoF4R9                 ; nen¡ platn˜ © dek
         jmp       short InfoF4R7           ; prvn¡ © dek se nekontroluje

; ------ test, zda je dal¨¡ © dek

InfoF4R2:cmp       si,ds:[0]                ; je dal¨¡ © dek ?
         jae       InfoF4R9                 ; nen¡ dal¨¡ © dek

; ------ test, zda je platn˜ © dek koment ©e

         lodsb                              ; na‡ten¡ p©ipraven‚ho znaku
         cmp       al,0                     ; je pr zdn˜ © dek ?
         je        InfoF4R8                 ; je pr zdn˜ © dek
         cmp       al," "                   ; mezera ?
         je        InfoF4R6                 ; mezera - je platn˜ © dek
         cmp       al,TAB                   ; tabul tor ?
         clc                                ; p©¡znak operace OK
         jne       InfoF4R9                 ; nen¡ tabul tor - nen¡ platn˜ © dek

; ------ vypu¨tˆn¡ mezer ze za‡ tku © dku

InfoF4R6:lodsb                              ; na‡ten¡ dal¨¡ho znaku
         cmp       al," "                   ; mezera ?
         je        InfoF4R6                 ; mezera se vypou¨t¡
         cmp       al,TAB                   ; tabul tor ?
         je        InfoF4R6                 ; tabul tor se vypou¨t¡
         dec       si                       ; n vrat platn‚ho znaku

; ------ p©enesen¡ textu © dku

InfoF4R7:lodsb                              ; na‡ten¡ dal¨¡ho znaku
         cmp       al,0                     ; je konec © dku ?
         je        InfoF4R8                 ; je konec © dku
         call      InfoF4RU                 ; ulo‘en¡ znaku AL
         jnc       InfoF4R7                 ; dal¨¡ znak

; ------ ulo‘en¡ konce © dku CR/LF

InfoF4R8:inc       si                       ; p©esko‡en¡ bajtu d‚lky dal¨¡ho © dku
         mov       al,CR
         call      InfoF4RU
         jc        InfoF4R9
         mov       al,LF
         call      InfoF4RU
         jnc       InfoF4R2

; ------ nastaven¡ velikosti segmentu

InfoF4R9:pop       ds

         pushf
         mov       es:[TextByts],di         ; velikost dat v bufferu
         mov       ax,ds:[PopsSegm]         ; segment
         mov       bx,di                    ; BX <- konec dat
         call      far ptr ModiSegS         ; nastaven¡ velikosti segmentu
         popf

; ------ n vrat registr–

         pop       di
         pop       si
         pop       cx
         ret

InfoF4Re ENDP

; ------ ulo‘en¡ znaku AL do bufferu

InfoF4RU:stc                                ; p©¡znak chyb
         jcxz      InfF4RU2                 ; nen¡ voln‚ m¡sto v bufferu
         stosb                              ; ulo‘en¡ bajtu AL do bufferu
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e voln‚ho m¡sta
         inc       word ptr es:[TextBNum]   ; zv˜¨en¡ ‡¡ta‡e dat v bufferu
         clc                                ; p©¡znak operace OK
InfF4RU2:ret

; -----------------------------------------------------------------------------
;        ulo‘en¡ editovan‚ho popisu polo‘ky (CY=p©eru¨en¡ operace)
; -----------------------------------------------------------------------------
; lok ln¡ promˆnn‚: SS:[BP-2] (2) segment koment ©–
;                   SS:[BP-4] (2) offset indexu
;                   SS:[BP-6] (2) offset © dku koment ©e polo‘ky
;                   SS:[BP-8] (2) adresa segmentu koment ©–
;                   SS:[BP-10] (2) adresa za‡ tku popisu polo‘ky
;                   SS:[BP-12] (2) ukazatel adresy © dku v editoru
; -----------------------------------------------------------------------------

InfoPUlo PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      bp
         push      es
         mov       bp,sp
         sub       sp,12

; ------ segment koment ©–

         mov       ax,ds:[SegmAkt]          ; aktivn¡ okno
         call      far ptr KomSIni          ; inicializace segmentu
         jnc       InfoPUl1                 ; operace OK
InfoPUl0:jmp       InfoPUl8

; ------ adresa v indexov‚ tabulce -> ES:SI

InfoPUl1:mov       ss:[bp-2],ax             ; segment koment ©–
         mov       ss:[bp-8],es             ; adresa segmentu koment ©–
         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> AX
         mov       si,es:[AWinKurz]         ; aktivn¡ polo‘ka
         shl       si,1                     ; offset v indexov‚ tabulce
         add       si,word ptr es:[AWinKomI] ; offset indexu
         mov       ss:[bp-4],si             ; offset indexu
         mov       ax,es                    ; segment okna
         add       ax,word ptr es:[AWinKomI+2] ; segment v indexov‚ tabulce
         mov       es,ax                    ; ES <- segment v indexov‚ tabulce

; ------ test, zda je koment © polo‘ky vytvo©en˜

         mov       di,es:[si]               ; offset koment ©e polo‘ky
         or        di,di                    ; je polo‘ka vytvo©ena ?
         jnz       InfoPUl2                 ; polo‘ka je vytvo©ena OK

; ------ vytvo©en¡ polo‘ky, nen¡-li vytvo©ena

         mov       es,ss:[bp-8]             ; adresa segmentu koment ©– -> ES
         mov       di,es:[0]                ; velikost dat v segmentu
         mov       si,offset SRMnuFil       ; buffer jm‚na souboru
         mov       ch,0
         mov       cl,ds:[si]               ; d‚lka jm‚na souboru
         inc       cx                       ; + bajt d‚lky
         inc       cx                       ; + koncov  0
         mov       ax,ss:[bp-2]             ; segment koment ©–
         call      far ptr InsDat           ; vytvo©en¡ m¡sta pro jm‚no souboru
         jc        InfoPUl0                 ; chyba pamˆti

; ------ ulo‘en¡ polo‘ky

         cld
         push      cx
         lodsb                              ; AL <- d‚lka jm‚na polo‘ky
         mov       cl,al                    ; CL <- d‚lka jm‚na polo‘ky
         inc       ax                       ; v‡etnˆ koncov‚ 0
         stosb                              ; d‚lka polo‘ky
         rep       movsb                    ; p©enos jm‚na polo‘ky
         mov       al,0
         stosb                              ; koncov  0
         pop       cx
         dec       di                       ; n vrat na koncovou 0

; ------ oprava ukazatel– v oknˆ

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         add       es:[AWinKomN],cx         ; zv˜¨en¡ po‡tu bajt– koment ©–

; ------ aktualizace koment ©e k polo‘ce

         mov       si,ss:[bp-4]             ; offset indexu
         mov       ax,es                    ; segment okna
         add       ax,word ptr es:[AWinKomI+2] ; segment v indexov‚ tabulce
         mov       es,ax                    ; ES <- segment v indexov‚ tabulce
         mov       es:[si],di               ; adresa koment ©e k polo‘ce
InfoPUl2:mov       ss:[bp-6],di             ; offset koment ©e polo‘ky

; ------ nalezen¡ za‡ tku dal¨¡ho © dku = adresa za‡ tku popisu polo‘ky -> DI

         mov       es,ss:[bp-8]             ; adresa segmentu koment ©–
InfoPUl3:inc       di                       ; zv˜¨en¡ ukazatele textu
         cmp       byte ptr es:[di-1],0     ; je za‡ tek dal¨¡ho © dku ?
         jne       InfoPUl3                 ; nalezen¡ za‡ tku dal¨¡ho © dku
         mov       ss:[bp-10],di            ; adresa za‡ tku popisu polo‘ky

; ------ nalezen¡ konce popisu polo‘ek -> ES:SI

         mov       si,di                    ; SI <- ukazatel © dk–
InfoPUl4:cmp       si,es:[0]                ; je dal¨¡ © dek ?
         jae       InfoPUl5                 ; nen¡ dal¨¡ © dek
         mov       al,es:[si+1]             ; prvn¡ znak © dku
         cmp       al,0
         je        InfoPU42                 ; pr zdn˜ © dek je platn˜
         cmp       al," "
         je        InfoPU42                 ; je to platn˜ © dek popisu
         cmp       al,TAB
         jne       InfoPUl5                 ; nen¡ to © dek popisu
InfoPU42:mov       al,es:[si]               ; d‚lka © dku
         inc       si                       ; za‡ tek textu © dku
         mov       ah,0
         add       si,ax                    ; adresa dal¨¡ho © dku
         jmp       short InfoPUl4           ; dal¨¡ © dek

; ------ zru¨en¡ star‚ho popisu polo‘ky

InfoPUl5:mov       cx,si                    ; CX <- adresa konce popisu
         sub       cx,di                    ; d‚lka popisu polo‘ek
         mov       ax,ss:[bp-2]             ; segment koment ©–
         call      far ptr DelDat           ; zru¨en¡ star‚ho popisu

; ------ oprava ukazatel– v oknˆ

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         sub       es:[AWinKomN],cx         ; sn¡‘en¡ po‡tu bajt– koment ©–

; ------ p©¡prava ukazatel– pro jeden © dek

         mov       word ptr ss:[bp-12],TextBBeg ; ukazatel textu v editoru
InfoPUl6:mov       ax,ds:[PopsSegm]         ; segment editoru
         call      far ptr GetDat           ; adresa segmentu editoru
         mov       si,ss:[bp-12]            ; ukazatel textu v editoru
         mov       dx,es:[0]                ; adresa konce textu v editoru
         xor       cx,cx                    ; ‡¡ta‡ d‚lky © dku

; ------ nalezen¡ za‡ tku textu © dku

         dec       si
InfoPU61:inc       si                       ; zv˜¨en¡ ukazatele textu © dku
         cmp       si,dx                    ; je dal¨¡ © dek ?
         jae       InfoPUl8                 ; nen¡ dal¨¡ © dek - konec (je NC !)
         mov       al,es:[si]               ; p©ipraven˜ znak
         cmp       al," "
         je        InfoPU61
         cmp       al,TAB
         je        InfoPU61
         mov       ss:[bp-12],si            ; £schova adresy za‡ tku © dku

; ------ zji¨tˆn¡ d‚lky jednoho © dku v editoru -> CX

InfoPU62:cmp       si,dx                    ; je dal¨¡ znak ?
         jae       InfoPU64                 ; nen¡ dal¨¡ znak
         cmp       word ptr es:[si],CR + LF*HI ; je CR/LF ?
         je        InfoPU63                 ; je konec © dku
         inc       si                       ; zv˜¨en¡ ukazatele textu
         inc       cx                       ; zv˜¨en¡ ‡¡ta‡e d‚lky © dku
         jmp       short InfoPU62           ; dal¨¡ znak

; ------ £schova adresy dal¨¡ho © dku

InfoPU63:inc       si                       ; p©esko‡en¡ znaku CR
         inc       si                       ; p©esko‡en¡ znaku LF
InfoPU64:xchg      si,ss:[bp-12]            ; SI <- n vrat za‡ tku © dku

; ------ omezen¡ d‚lky textu © dku

         cmp       cx,255-1-2               ; max. d‚lka (bez nuly a 2*TAB)
         jbe       InfoPU65                 ; d‚lka je OK
         mov       cx,255-1-2               ; omezen¡ d‚lky textu

; ------ vytvo©en¡ m¡sta pro vlo‘en¡ © dku (je DI ukl dac¡ adresa)

InfoPU65:mov       ax,ss:[bp-2]             ; segment koment ©–
         add       cx,1+1+2                 ; + d‚lka + nula + 2*TAB
         call      far ptr InsDat           ; vytvo©en¡ m¡sta pro © dek
         jc        InfoPUl8                 ; chyba pamˆti

; ------ p©enesen¡ textu © dku

         push      cx
         push      ds

         mov       ax,ds:[PopsSegm]         ; segment editoru
         call      far ptr GetSgAdr         ; adresa segmentu editoru -> DX
         mov       es,ss:[bp-8]             ; adresa segmentu koment ©–
         mov       ds,dx                    ; DS <- segment editoru
         dec       cx                       ; bez bajtu d‚lky
         mov       al,cl                    ; AL <- d‚lka © dku
         cld
         stosb                              ; ulo‘en¡ bajtu d‚lky © dku
         mov       al,TAB                   ; tabul tor
         stosb                              ; ulo‘en¡ 2 tabul tor–
         stosb
         sub       cl,1+2                   ; bez 2 tabul tor– a bez koncov‚ 0
         rep       movsb                    ; p©enos textu © dku
         mov       al,0
         stosb                              ; koncov  0

         pop       ds
         pop       cx

; ------ oprava ukazatel– v oknˆ

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         sub       es:[AWinKomN],cx         ; sn¡‘en¡ po‡tu bajt– koment ©–
         jmp       short InfoPUl6

; ------ nulov n¡ p©¡znaku modifikace textu

InfoPUl8:pushf
         mov       ax,ds:[PopsSegm]         ; segment editoru
         call      far ptr GetDat           ; adresa segmentu editoru -> ES
         and       byte ptr es:[TextParm],not bit1 ; nulov n¡ p©¡znaku modifikace

; ------ ulo‘en¡ souboru FILEINFO

         mov       ax,ds:[SegmAkt]          ; aktivn¡ okno
         call      far ptr InitFKom         ; inicializace adres koment ©–
         call      far ptr WritFKom         ; ulo‘en¡ souboru FILEINFO
         popf

; ------ chyba pamˆti

         jnc       InfoPUl9                 ; operace OK
         call      far ptr MemErr           ; chyba pamˆti

; ------ n vrat registr–

InfoPUl9:mov       sp,bp
         pop       es
         pop       bp
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

InfoPUlo ENDP

; *****************************************************************************
;
;                      Modifikace parametr– soubor–
;
; *****************************************************************************
;þ
AWMMnuSM LABEL     FAR

; ------ z kaz polo‘ek p©i vypnut‚m aktivn¡m oknˆ

         and       word ptr ds:[SMMnVBlk],not (bit1+HI*bit1) ; polo‘ky povoleny
         and       word ptr ds:[SMMnVBlk+2],not (bit1+HI*bit1) ; polo‘ky povoleny
         call      far ptr TestAAWn         ; je aktivn¡ okno zapnuto ?
         jnc       AWMMnSM1                 ; okno je zapnuto
         or        word ptr ds:[SMMnVBlk],bit1+HI*bit1 ; z kaz polo‘ek
         or        word ptr ds:[SMMnVBlk+2],bit1+HI*bit1 ; z kaz polo‘ek

AWMMnSM1:mov       ax,word ptr ds:[SMnuVert+MnuPoz] ; pozice p©edchoz¡ho okna
         add       ax,0607h                 ; posun okna
         mov       word ptr ds:[si+MnuPoz],ax ; pozice okna

         jmp       far ptr VertMenu

ModSouTb db        bit0 + bit6              ; kurzor
         db        bit1 + bit6              ; ozna‡en‚
         db        bit2                     ; soubory
         db        bit2 + bit4 + bit6 + bit7 ; v¨echny
         db        bit3 + bit4 + bit6       ; zadan‚

ModiFil  LABEL     FAR

; ------ zah jen¡ operace

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         mov       bx,ds:[si+MnuAkt]        ; aktivn¡ zvolen  polo‘ka
         mov       al,cs:[bx+ModSouTb-1]    ; parametry pro v˜bˆr polo‘ek

; ------ vstupn¡ bod z funk‡n¡ kl vesy (AL=typ operace)

ModiFilF LABEL     FAR

         call      far ptr ClosMnuA         ; uzav©en¡ v¨ech oken menu
         call      far ptr InitFFil         ; inicializace vyhled v n¡
         jc        ModiSou0                 ; nen¡ ‘ dn˜ soubor

; ------ zad n¡ soubor– textem

         test      byte ptr ds:[FileTyp],bit3 ; je specifikace textem ?
         jz        ModiSou2                 ; nen¡ specifikace textem

ModiSou1:mov       si,offset SMZMLin        ; menu zad n¡ soubor–
         call      far ptr Lin0Menu         ; obsluha volby
         jnc       ModiSo12                 ; volba OK

; ------ p©eru¨en¡ operace a n vrat do hlavn¡ obsluhy

ModiSou0:jmp       far ptr Main0

; ------ rozbor zad n¡ parametr– operace

ModiSo12:call      far ptr RozborZ          ; rozbor zad n¡ parametr– operace
         jc        ModiSou0                 ; p©eru¨en¡ operace
         jnz       ModiSou1                 ; opakov n¡ zad n¡

; ------ doplnˆn¡ cesty na pln‚ jm‚no

         call      far ptr RozbFPth         ; doplnˆn¡ na pln‚ jm‚no

; ------ p©¡prava p©edvoleb

ModiSou2:call      ModSPred                 ; p©¡prava p©edvoleb

; ------ volba parametr– operace

ModiSou3:mov       si,offset SMMMLin
         call      far ptr Lin0Menu         ; obsluha volby
         jc        ModiSou0

; ------ rozbor zad n¡ parametr–

         mov       si,offset LinBuff        ; edita‡n¡ buffer
         mov       ch,0
         mov       cl,ds:[LinNum]           ; po‡et bajt– v edita‡n¡m bufferu
         push      cs
         call      near ptr ModiRozZ        ; rozbor zad n¡ s hl ¨en¡m chyby
         jc        ModiSou0                 ; p©eru¨en¡ operace
         jnz       ModiSou3                 ; opakov n¡ zad n¡

; ------ zapnut¡ nebo vypnut¡ atribut– v oknˆ

ModiSou4:test      byte ptr ds:[ModiWPar],bit0 ; bylo nˆco zad no ?
         jz        ModiSou5                 ; nebylo nic zad no
         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         jc        ModiSou5                 ; chyba ?
         call      far ptr TestAAWn         ; zapnuto aktivn¡ okno ?
         jc        ModiSou5                 ; aktivn¡ okno nezapnuto
         test      byte ptr es:[AWinPrm1],bit3+bit5 ; adres © nebo seznam ?
         jz        ModiSou5                 ; ne - tak to nen¡ pot©eba
         or        byte ptr es:[AWinPrm2],bit7 ; zapnut¡ atribut–
         test      byte ptr ds:[ModiWPar],bit1 ; je zapnut¡ atribut– ?
         jnz       ModiSo42                 ; je zapnut¡ atribut–
         and       byte ptr es:[AWinPrm2],not bit7 ; vypnut¡ atribut–

ModiSo42:push      ax
         push      si

         mov       al,es:[AWinPrm2]
         mov       si,offset ParamLC        ; parametry lev‚ho okna
         test      byte ptr ds:[WindPar],bit0 ; je aktivn¡ lev‚ okno ?
         jnz       ModiSo44                 ; je aktivn¡ lev‚ okno
         mov       si,offset ParamRC        ; parametry prav‚ho okna
ModiSo44:mov       ds:[si],al               ; £schova parametr–

         pop       si
         pop       ax

; ------ test, zda bylo nˆco zad no

ModiSou5:test      byte ptr ds:[ModiWPar],bit2+bit4+bit5+bit6+bit7 ; zad no ?
         jz        ModiSou0                 ; nebylo nic zad no - konec

; ------ zobrazen¡ £vodn¡ho textu a inicializace

         call      far ptr HistADir         ; ulo‘en¡ adres ©e do historie
         mov       si,offset ModiTxt        ; text "Modifikuji"
         call      far ptr InfDisp0         ; zobrazen¡ textu
         call      far ptr InitFSet         ; inicializace ozna‡en¡ polo‘ek

; ------ poskytnut¡ souboru k operaci

ModiSou6:call      far ptr DispTime         ; obsluha ‡asu
         call      far ptr DarkNul          ; nulov n¡ stm¡va‡e obrazovky
         call      far ptr GetFFil          ; poskytnut¡ souboru
         jnc       ModiSo61                 ; je dal¨¡ soubor OK
         jmp       ModiSou9                 ; nen¡ dal¨¡ soubor

ModiSo61:call      far ptr DispAAWn         ; zobrazen¡ okna
         test      byte ptr ds:[FileParm],bit3 ; je adres © p©i n vratu ?
         jz        ModSo612                 ; nen¡ to adres © p©i n vratu
         jmp       ModiSou7                 ; je to adres © p©i n vratu

; ------ zobrazen¡ informa‡n¡ho textu

ModSo612:mov       di,offset ModiTxt        ; text "Modifikuji"
         call      far ptr InfFile          ; zobrazen¡ jm‚na polo‘ky

; ------ p©¡prava po‘adovan‚ho data a ‡asu souboru -> DX, CX

         mov       cx,ds:[FileFTim]         ; ‡as souboru
         and       cx,ds:[ModiTimM]         ; maskov n¡ ‡asu
         or        cx,ds:[ModiTim]          ; nastaven¡ po‘adovan‚ho ‡asu
         mov       dx,ds:[FileFDat]         ; datum souboru
         and       dx,ds:[ModiDatM]         ; maskov n¡ data
         or        dx,ds:[ModiDat]          ; nastaven¡ po‘adovan‚ho data

; ------ test, zda se nastavuje datum a ‡as

         test      byte ptr ds:[ModiWPar],bit4+bit5+bit6+bit7 ; zad n datum/‡as ?
         jz        ModiSo64                 ; nezad n datum ani ‡as
         test      byte ptr ds:[FileFAtr],DIR ; je to adres © ?
         jnz       ModiSo63                 ; je adres ©

; ------ nastaven¡ po‘adovan‚ho data a ‡asu souboru (nastavuje atribut ARC !)

         call      far ptr OpenR            ; otev©en¡ souboru pro ‡ten¡
         jc        ModiSo62                 ; nˆjak  chyba
         call      far ptr SetDFile         ; nastaven¡ data a ‡asu souboru
         pushf
         call      far ptr ClosFile         ; uzav©en¡ souboru
         popf
         jnc       ModiSo64                 ; operace probˆhla OK

; ------ chyba - nelze nastavit parametry polo‘ky

ModiSo62:call      far ptr TestBEsc         ; test p©eru¨en¡ operace
         jc        ModiSou9                 ; p©eru¨en¡ operace
         call      far ptr DekFParm         ; p©¡prava parametr– souboru
         mov       si,offset ChbErMod       ; text - chyba modifikace
         call      far ptr Lin0MenF         ; chybov‚ hl ¨en¡
         jnc       ModiSou8
         call      far ptr SetEsc           ; p©¡znak p©eru¨en¡ operace ESC
         jmp       short ModiSou8

; ------ nastaven¡ data a ‡asu pro adres ©

ModiSo63:test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
         jnz       ModiSo64                 ; nen¡ dlouh‚ jm‚no
         call      far ptr SetDTDir         ; nastaven¡ data a ‡asu adres ©e
         jc        ModiSo62                 ; byla chyba operace

; ------ nastaven¡ atribut– polo‘ky (i kdyby nebyly zadan‚ - mˆn¡ se ARC !)

ModiSo64:mov       cl,ds:[FileFAtr]         ; atributy polo‘ky
         and       cl,ds:[ModiAtrM]         ; maskov n¡ atribut–
         or        cl,ds:[ModiAtr]          ; nastaven¡ po‘adovan˜ch atribut–
         and       cl,RO + HID + SYS + DIR + ARC ; pouze povolen‚ atributy
         call      far ptr SetAFile         ; nastaven¡ atribut– polo‘ky
         jc        ModiSo62                 ; chyba operace

; ------ operace provedena OK (zde je ES=DS !) - odzna‡en¡ polo‘ky

ModiSou7:call      far ptr ResFFil          ; nulov n¡ ozna‡en¡ polo‘ky
ModiSou8:mov       si,offset FilePath       ; jm‚no souboru
         mov       cx,ds:[FilePthN]         ; d‚lka textu cesty
         call      far ptr AktWFile         ; aktualizace polo‘ky

; ------ p©¡prava pro dal¨¡ polo‘ku

         call      far ptr TestBEsc         ; je p©eru¨en¡ operace ?
         jc        ModiSou9                 ; p©eru¨en¡ operace
         jmp       ModiSou6                 ; nen¡ p©eru¨en¡ - dal¨¡ polo‘ka

; ------ uzav©en¡ re‘imu modifikace

ModiSou9:jmp       ModiSou0

; -----------------------------------------------------------------------------
;        p©¡prava p©edvoleb
; -----------------------------------------------------------------------------

ModSPred PROC      NEAR

; ------ test, zda bude p©edvolba 2 (zapnut¡/vypnut¡ zobrazen¡ atribut–)

;         mov       byte ptr ds:[SMMMLPrN],1 ;  bude 1 p©edvolba
;         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
;         jc        ModSPre2                 ; chyba ?
;         call      far ptr TestAAWn         ; zapnuto aktivn¡ okno ?
;         jc        ModSPre2                 ; aktivn¡ okno nezapnuto
;         test      byte ptr es:[AWinPrm1],bit3+bit5 ; adres © nebo seznam ?
;         jz        ModSPre2                 ; ne - tak to nen¡ pot©eba
;         test      byte ptr es:[AWinPrm2],bit5+bit6 ; je to 1-sloupcov‚ okno ?
;         jnz       ModSPre2                 ; nen¡ to 1-sloupcov‚ okno
;         inc       byte ptr ds:[SMMMLPrN]   ;  bude 1 p©edvolba
;
;; ------ p©edvolba 2 - zapnut¡/vypnut¡ zobrazen¡ atribut–
;
;         mov       al,"+"                   ; zapnut¡ atribut–
;         test      byte ptr es:[AWinPrm2],bit7 ; zobrazeny atributy ?
;         jz        ModSPre1                 ; atributy nejsou zobrazeny
;         mov       al,"-"                   ; vypnut¡ atribut–
;ModSPre1:mov       ds:[SMMMLPr2],al         ; p©¡prava p©edvolby

; ------ p©¡prava fale¨n‚ polo‘ky, nen¡-li polo‘ka pod kurzorem

ModSPre2:mov       byte ptr ds:[FileFAtr],0 ; atributy - v¨echno na 0
         call      far ptr GetSDate         ; poskytnut¡ syst‚mov‚ho data
         mov       ds:[FileFDat],dx         ; aktu ln¡ datum
         call      far ptr GetSTime         ; poskytnut¡ syst‚mov‚ho ‡asu
         mov       ds:[FileFTim],dx         ; aktu ln¡ ‡as

; ------ polo‘ka pod kurzorem -> ES:SI

         call      far ptr TestAAWn         ; je aktivn¡ okno zapnuto ?
         jc        ModSPre3                 ; aktivn¡ okno nen¡ zapnuto
         call      far ptr GetAKurz         ; poskytnut¡ polo‘ky pod kurzorem
         jnc       ModSPre4                 ; polo‘ka je OK
ModSPre3:push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset FileFPol       ; adresa fale¨n‚ polo‘ky souboru

; ------ dek¢dov n¡ atribut–

ModSPre4:mov       di,offset SMMMLPr1       ; buffer p©edvolby
         mov       al,es:[si+FileAtr]       ; atributy souboru
         shl       al,1                     ; p©esko‡en¡ bitu ATRT
         shl       al,1                     ; p©esko‡en¡ bitu ATRO
         mov       ah,"A"
         call      ModSPrA                  ; atribut ARC
         shl       al,1                     ; p©esko‡en¡ bitu DIR
         shl       al,1                     ; p©esko‡en¡ bitu ATRU
         mov       ah,"S"
         call      ModSPrA                  ; atribut SYS
         mov       ah,"H"
         call      ModSPrA                  ; atribut HID
         mov       ah,"R"
         call      ModSPrA                  ; atribut R/O

; ------ dek¢dov n¡ data a ‡asu

         inc       di                       ; p©esko‡en¡ mezery
         inc       di                       ; p©esko‡en¡ znaku "D"
         push      ds
         mov       dx,ds                    ; DX <- datov˜ segment

         push      ds
         push      es
         pop       ds                       ; DS <- segment polo‘ky
         pop       es                       ; ES <- datov˜ segment
         mov       ah,0                     ; barva se neukl d 
         call      far ptr DekA4Dat         ; dek¢dov n¡ data

         inc       di                       ; p©esko‡en¡ mezery
         inc       di                       ; p©esko‡en¡ znaku "T"
         call      far ptr DekATmS          ; dek¢dov n¡ ‡asu polo‘ky

         pop       ds
         ret

ModSPred ENDP

; ------ dek¢dov n¡ jednoho atributu

ModSPrA: shl       al,1                     ; je atribut nastaven ?
         jc        ModSPrA2                 ; atribut je nastaven
         add       ah,"a"-"A"               ; korekce na mal‚ p¡smeno
ModSPrA2:mov       ds:[di],ah               ; ulo‘en¡ znaku
         inc       di                       ; zv˜¨en¡ ukl dac¡ adresy
         ret

; *****************************************************************************
;                                   RozbCil
;           zad n¡ a rozbor zad n¡ c¡le operace (tj. soubor + parametry)
; -----------------------------------------------------------------------------
; VSTUP: DS:SI=menu volby
;        DS=datov˜ segment
; VSTUP: CY=p©eru¨en¡ operace
; -----------------------------------------------------------------------------
; ni‡¡ v¨echny registry (kromˆ DS a BP)
; *****************************************************************************

RozbCil  PROC      FAR

         push      bp

; ------ zad n¡ operace

         mov       bp,si                    ; BP <- £schova adresy menu
RozbCil1:call      far ptr Lin0Menu         ; zad n¡ operace
         jc        RozbCil9                 ; p©eru¨en¡ operace

; ------ nalezen¡ za‡ tku parametr–

         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       di,offset LinBuff        ; za‡ tek bufferu
         mov       ch,0
         mov       cl,ds:[LinNum]           ; d‚lka zadan‚ho textu
         jcxz      RozbCil3                 ; nen¡ nic zad no (CX=0, SI n hodn‚)
         cld
         mov       al,"/"                   ; ozna‡en¡ parametr–
         repne     scasb                    ; nalezen¡ znaku "/"
         jne       RozbCil3                 ; nejsou parametry (CX=0, SI n hodn‚)

; ------ zkr cen¡ textu v © dku o parametry

         mov       si,di                    ; SI <- za‡ tek parametr–
         mov       ax,di
         sub       ax,offset LinBuff+1      ; d‚lka textu jm‚na souboru (bez /)
         mov       ds:[LinNum],al           ; nov  d‚lka jm‚na souboru/adres ©e

; ------ rozbor zad n¡ parametr–

RozbCil3:call      far ptr ModiRozZ         ; rozbor zad n¡ parametr–
         jc        RozbCil9                 ; p©eru¨en¡ operace
         mov       si,bp                    ; SI <- adresa menu
         jnz       RozbCil1                 ; opakov n¡ zad n¡ operace

RozbCil9:pop       bp
         ret

RozbCil  ENDP

; *****************************************************************************
;                                 ModiRozZ
;                    rozbor zad n¡ parametr– s kontrolou
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
;        DS:SI=adresa za‡ tku textu
;        CX=po‡et znak–
; VSTUP: CY=p©eru¨en¡ operace
;         NZ=chyba zad n¡ parametr–, opakov n¡ zad n¡
;         ZY=v¨e OK
; *****************************************************************************

ModiRozZ PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si

; ------ rozbor zad n¡ parametr– operace

         push      cs
         call      near ptr ModiRozb        ; rozbor zad n¡ parametr– operace
         jnc       ModRozZ8                 ; parametry zad ny OK

; ------ chyba zad n¡ parametr– operace

         mov       si,offset ChbLnPar       ; menu - chyba zad n¡
         call      far ptr Lin0MenF         ; chybov‚ hl ¨en¡
         jc        ModRozZ9                 ; p©eru¨en¡ operace

; ------ opakov n¡ zad n¡ parametr– operace

         or        si,si                    ; p©¡znaky NC, NZ = opakov n¡ zad n¡
         jmp       short ModRozZ9

; ------ n vrat registr–

ModRozZ8:xor       cx,cx                    ; p©¡znaky NC, ZY = v¨e OK
ModRozZ9:pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

ModiRozZ  ENDP

; *****************************************************************************
;                              ModiRozb
;            rozbor zad n¡ parametr– k modifikaci soubor–
; -----------------------------------------------------------------------------
; VSTUP: DS:SI=adresa za‡ tku textu
;        CX=po‡et znak–
; VSTUP: CY=chyba zad n¡ parametr–
;         DS:SI=adresa chyby
;         CX=po‡et zbyl˜ch znak–
; *****************************************************************************
;þ
ModiRozb PROC      FAR

; ------ £schova registr–

         push      ax
         push      bx
         push      dx
         push      di
         push      bp
         push      es

         mov       bp,si                    ; BP <- £schova za‡ tku textu
         push      ds
         pop       es                       ; ES <- datov˜ segment

; ------ inicializace ukazatel–

         xor       ax,ax                    ; AX <- 0
         mov       ds:[ModiWPar],al         ; p©¡znaky zad n¡ parametr–
         mov       ds:[ModiAtr],al          ; atributy k modifikaci polo‘ky
         mov       ds:[ModiTim],ax          ; ‡as k modifikaci polo‘ky
         mov       ds:[ModiDat],ax          ; datum k modifikaci polo‘ky
         dec       ax                       ; AX <- -1
         mov       ds:[ModiAtrM],al         ; maska atribut– k modifikaci
         mov       ds:[ModiTimM],ax         ; maska ‡asu k modifikaci polo‘ky
         mov       ds:[ModiDatM],ax         ; maska data k modifikaci polo‘ky

; ------ na‡ten¡ prvn¡ho znaku

ModiRoz1:call      RozbPCh                  ; na‡ten¡ jednoho znaku
         jnc       ModiRoz2                 ; je nˆjak˜ platn˜ znak
         clc                                ; p©¡znak operace OK
         jmp       ModiRoz9                 ; konec parametr–
ModiRoz2:call      far ptr UpCase           ; konverze znaku na velk‚ p¡smeno

; ------ datum "D"

         cmp       al,"D"                   ; je zad n¡ data ?
         jne       ModiRoz3                 ; nen¡ zad n¡ data
         call      ModiRDat                 ; rozbor zad n¡ data
         jmp       short ModiRoz1           ; dal¨¡ parametr

; ------ ‡as "T"

ModiRoz3:cmp       al,"T"                   ; je zad n¡ ‡asu ?
         jne       ModiRoz4                 ; nen¡ zad n¡ ‡asu
         call      ModiRTim                 ; rozbor zad n¡ ‡asu
         jmp       short ModiRoz1           ; dal¨¡ parametr

; ------ zapnut¡ atribut– "+"

ModiRoz4:cmp       al,"+"                   ; je zapnut¡ atribut– ?
         jne       ModiRoz5                 ; nen¡ zapnut¡ atribut–
         or        byte ptr ds:[ModiWPar],bit0 + bit1 ; p©¡znak zapnut¡ atribut–
         jmp       short ModiRoz1           ; dal¨¡ parametr

; ------ vypnut¡ atribut– "-"

ModiRoz5:cmp       al,"-"                   ; je vypnut¡ atribut– ?
         jne       ModiRoz6                 ; nen¡ vypnut¡ atribut–
         or        byte ptr ds:[ModiWPar],bit0 ; p©¡znak zad n¡ parametru
         and       byte ptr ds:[ModiWPar],not bit1 ; p©¡znak vypnut¡ atribut–
         jmp       short ModiRoz1           ; dal¨¡ parametr

; ------ atributy

ModiRoz6:mov       di,offset ModiAtr        ; atributy
         cmp       al,"C"                   ; atribut "C" nen¡ povolen
         je        ModiRoz8                 ; chyba
         not       byte ptr ds:[di+1]       ; maska m  opa‡n˜ v˜znam
         call      RozbPAtr                 ; rozbor zad n¡ atribut–
         pushf
         not       byte ptr ds:[di+1]       ; n vrat v˜znamu masky
         popf
         jc        ModiRoz8                 ; chyba
         or        byte ptr ds:[ModiWPar],bit2 ; p©¡znak zad n¡ atribut–
         jmp       short ModiRoz1           ; dal¨¡ parametr

; ------ chybn˜ znak - p©enesen¡ textu chyby do bufferu

ModiRoz8:call      RozbPErr                 ; £schova textu chyby

; ------ n vrat registr–

ModiRoz9:pop       es
         pop       bp
         pop       di
         pop       dx
         pop       bx
         pop       ax
         ret

ModiRozb ENDP

; -----------------------------------------------------------------------------
;        rozbor zad n¡ data (parametr "D datum")
; -----------------------------------------------------------------------------
; ni‡¡ registry: AX, BX, DX, DI
; -----------------------------------------------------------------------------

ModiRDat PROC      NEAR

; ------ nulov n¡ ukazatel–

         or        byte ptr ds:[ModiWPar],bit4 ; p©¡znak zad n¡ data
         and       byte ptr ds:[ModiWPar],not bit5 ; zru¨en¡ p©¡znaku implicit.

         mov       di,offset ModiDat        ; datum
         call      RozbPDt0                 ; rozbor zad n¡ data
         not       word ptr ds:[di+2]       ; oprava v˜znamu masky

; ------ nastaven¡ aktu ln¡ho syst‚mov‚ho data

         cmp       word ptr ds:[di+2],-1    ; bylo nˆco zad no ?
         jne       ModiRDt5                 ; bylo nˆco zad no
         xor       byte ptr ds:[ModiWPar],bit4+bit5 ; p©¡znak implicitn¡ho data
         call      far ptr GetSDate         ; poskytnut¡ syst‚mov‚ho data
         mov       ds:[di],dx               ; aktu ln¡ datum
         not       word ptr ds:[di+2]       ; 0=maska pro nulov n¡ star‚ho data
ModiRDt5:ret

ModiRDat ENDP

; -----------------------------------------------------------------------------
;        rozbor zad n¡ ‡asu (parametr "T ‡as")
; -----------------------------------------------------------------------------
; ni‡¡ registry: AX, BX, DX, DI
; -----------------------------------------------------------------------------

ModiRTim PROC      NEAR

; ------ rozbor ‡asu

         or        byte ptr ds:[ModiWPar],bit6 ; p©¡znak zad n¡ ‡asu
         and       byte ptr ds:[ModiWPar],not bit7 ; zru¨en¡ p©¡znaku implicit.
         mov       di,offset ModiTim        ; ‡as
         call      RozbPHod                 ; rozbor hodin
         call      RozbPMin                 ; rozbor minut
         call      RozbPSek                 ; rozbor sekund
         not       word ptr ds:[di+2]       ; oprava v˜znamu masky

; ------ nastaven¡ aktu ln¡ho syst‚mov‚ho ‡asu

         cmp       word ptr ds:[di+2],-1    ; je ‡as zad n ?
         jne       ModiRTm9                 ; ‡as je zad n
         xor       byte ptr ds:[ModiWPar],bit6+bit7 ; ‡as implicitn¡
         call      far ptr GetSTime         ; poskytnut¡ syst‚mov‚ho ‡asu
         mov       ds:[di],dx               ; aktu ln¡ ‡as
         not       word ptr ds:[di+2]       ; 0=maska pro nulov n¡ star‚ho ‡asu
ModiRTm9:ret

ModiRTim ENDP

; *****************************************************************************
;
;                           Start programu
;
; *****************************************************************************
;þ
Program  PROC      FAR

         mov       ax,word ptr ds:[SMnuVert+MnuPoz] ; pozice p©edchoz¡ho okna
         add       ax,0607h                 ; posun okna
         mov       word ptr ds:[si+MnuPoz],ax        ; pozice okna

         push      dx
         mov       dl,ds:[ProgSwc]
         call      far ptr SetSwch          ; nastaven¡ p©ep¡na‡–
         pop       dx

         jmp       far ptr VertMenu

Program  ENDP

; ------ p©ep¡na‡ BAT m¢d

Progr101 PROC      FAR

         mov       al,bit0
Progr102:and       dl,not bit0+bit1+bit2
         or        dl,al
         and       byte ptr ds:[ProgSwc],not bit0+bit1+bit2
         or        ds:[ProgSwc],al
         call      far ptr SetSwch
         call      far ptr DispMnu
         ret

Progr101 ENDP

; ------ p©ep¡na‡ LOADER m¢d

Progr104:mov       al,bit1
         jmp       short Progr102

; ------ p©ep¡na‡ PERMANENT m¢d

Progr105:mov       al,bit2
         jmp       short Progr102

;Progr106:xor       dl,bit3
;         jmp       short Progr103
;
;Progr107:xor       dl,bit4
;         jmp       short Progr103
;
;Progr108:xor       dl,bit5
;         jmp       short Progr103

; -----------------------------------------------------------------------------
;        Program pod kurzorem
; -----------------------------------------------------------------------------

Progr2   PROC      FAR

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         call      far ptr ClosMnuA         ; uzav©en¡ oken menu
         jmp       far ptr AWEnter0         ; proveden¡ p©¡kazu

Progr2   ENDP

; -----------------------------------------------------------------------------
;        u‘ivatelsk‚ menu
; -----------------------------------------------------------------------------

Progr3   PROC      FAR

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         call      far ptr ClosMnuA         ; uzav©en¡ oken menu
         jmp       far ptr UserMenu         ; u‘ivatelsk‚ menu

Progr3   ENDP

; -----------------------------------------------------------------------------
;        ozna‡en‚ soubory
; -----------------------------------------------------------------------------

Progr4   PROC      FAR

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         call      far ptr ClosMnuA         ; uzav©en¡ oken menu
         jmp       far ptr SelcExec         ; start ozna‡en˜ch soubor–

Progr4   ENDP

; -----------------------------------------------------------------------------
;        Zadan˜ p©¡kaz
; -----------------------------------------------------------------------------

Progr29: jmp       far ptr Main0

Progr5   PROC      FAR

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         call      far ptr ClosMnuA         ; uzav©en¡ okna menu

; ------ zad n¡ p©¡kazu Shift-F2

Progr500 LABEL     FAR

         mov       word ptr ds:[SPZMLPlL],0 ; nen¡ p©edvolba
         mov       al,ds:[LineCNum]         ; po‡et zadan˜ch znak–
         cmp       al,0                     ; je nˆco zad no ?
         je        Progr501                 ; nen¡ nic zad no
         inc       byte ptr ds:[SPZMLPlL]   ; je 1 p©edvolba
         mov       byte ptr ds:[SPZMLPlN],al ; d‚lka p©edvolby

Progr501:mov       si,offset SPZMLin        ; zadan˜ p©¡kaz
         call      far ptr Lin0Menu
         jc        Progr29                  ; p©eru¨en¡

         mov       si,offset LinBuff        ; buffer
         mov       di,offset LineCBuf       ; buffer p©¡kazu
         mov       ch,0
         mov       cl,ds:[LinNum]
         jcxz      Progr29                  ; nen¡ nic zad no

         mov       ds:[LineCNum],cl         ; po‡et zadan˜ch znak–
         mov       ds:[LineCKur],cl         ; sou‡asnˆ pozice kurzoru
         push      ds
         pop       es
         cld
         rep       movsb                    ; p©enos zadan‚ho p©¡kazu

         test      byte ptr ds:[LinParm],bit0 ; je ukon‡en¡ Ctrl-ENTER ?
         jz        Progr504                 ; nen¡ Ctrl-ENTER
         mov       ds:[LineCTop],cl         ; zobrazen˜ po‡ tek
         call      far ptr DispLCom         ; zobrazen¡ p©¡kazov‚ho © dku
         jmp       short Progr29

Progr504:call      far ptr QSrcEnd          ; ukon‡en¡ re‘imu rychlovyhled v n¡
         jmp       short ProgrEx2

; ------ proveden¡ p©¡kazu z p©¡kazov‚ho © dku
; Pozor - je-li vol no z inicializa‡n¡ sekvence, nemus¡ b˜t je¨tˆ okna na‡tena !

;þ
ProgrExe LABEL     FAR

         call      far ptr QSrcEnd          ; ukon‡en¡ re‘imu rychlovyhled v n¡

; ------ pro extern¡ stm¡va‡ se neukl d  historie, aby nerachotil disk

         test      byte ptr ds:[StartPar],bit1 ; je aktualizace INI souboru ?
         jnz       ProgrEx1                 ; je aktualizace INI souboru
         test      byte ptr ds:[ProgSwc3],bit1 ; je obsluha stm¡va‡e ?
         jnz       ProgrEx1                 ; je obsluha ext. stm¡va‡e

         call      far ptr HistADir         ; ulo‘en¡ adres ©e do historie

ProgrEx1:push      ds
         pop       es
         mov       si,offset AktPath        ; aktu ln¡ adres ©
         call      far ptr SetDDir          ; nastaven¡ aktu ln¡ho adres ©e

         mov       al,HistComm              ; historie p©¡kaz–
         mov       si,offset LineCBuf       ; buffer p©¡kazu
         mov       ch,0
         mov       cl,ds:[LineCNum]         ; po‡et bajt– v bufferu

         test      byte ptr ds:[ProgSwc3],bit1 ; je obsluha stm¡va‡e ?
         jnz       ProgEx28                 ; je obsluha ext. stm¡va‡e

         test      byte ptr ds:[ProgSwc],bit7 ; je $DOSMAN$.BAT ?
         jnz       ProgrEx2                 ; je $DOSMAN$.BAT
         test      byte ptr ds:[ProgSwc2],bit0 ; je p©¡kaz z EXTENSION/MENU ?
         jnz       ProgrEx2                 ; je EXTENSION/MENU
         test      byte ptr ds:[StartPar],bit1 ; je aktualizace INI souboru ?
         jnz       ProgrEx2                 ; je aktualizace INI souboru

         call      far ptr InsHist          ; ulo‘en¡ textu do historie

ProgrEx2:

         mov       si,offset ProgTxt1
         call      far ptr InfDisp0         ; zobrazen¡ informa‡n¡ho textu

;; ------ n hrada znak– "||" v p©¡kazu p©elomy © dk–
;
;         mov       si,offset LineCBuf
;         mov       cl,ds:[LineCNum]
;         mov       ch,0
;         jcxz      ProgEx28
;         dec       cx
;         jz        ProgEx28
;         cld
;ProgEx22:lodsb
;         cmp       al,'"'
;         jne       ProgEx24
;ProgEx23:
;
;
;ProgEx24:
;
;
;
;ProgEx27:
;
;
;

ProgEx28:mov       es,ds:[SegPSP]
         mov       di,81h
         cld

         cmp       word ptr ds:[EnvSize],0  ; je prost©ed¡ definov no ?
         je        Progr520                 ; nen¡ prost©ed¡ definov no

         mov       ax,"E/"
         stosw
         mov       al,":"
         stosb
         mov       ax,ds:[EnvSize]          ; velikost prost©ed¡
         xor       bx,bx
         call      far ptr DekNumW          ; dek¢dov n¡ ‡¡sla
         cld
         mov       al," "
         stosb

Progr520:mov       ax,"C/"
         stosw
         mov       al," "
         stosb
         mov       ax,0ffh - 2 - 1          ; asi tak konec © dku
         sub       ax,di                    ; zbyl‚ m¡sto

         mov       cs:[ProgAdrB],di         ; £schova adresy p©¡kazu

         mov       ch,0
         mov       cl,ds:[LineCNum]
         cmp       cl,al
         jbe       Progr521                 ; d‚lka je OK
         mov       cl,al                    ; omezen¡ d‚lky textu
Progr521:mov       cs:[ProgAdrN],cx         ; d‚lka textu
         mov       si,offset LineCBuf
         rep       movsb
         mov       ax,CR+LF*HI
         stosw                              ; ukon‡ovac¡ CR

         mov       ax,di                    ; konec textu
         sub       ax,81h+2                 ; velikost textu
         mov       es:[80h],al

; ------ paket parametr–

         mov       word ptr ds:[ExecPck0],80h ; adresa p©¡kazov‚ho © dku
         mov       ds:[ExecPck1],es
         mov       ds:[ExecPck2],es
         mov       ds:[ExecPck3],es
;         mov       ax,ds:[EnvParnt]         ; otcovsk‚ prost©ed¡
;         or        ax,ax
;         jnz       Prog5202
         mov       ax,es:[2ch]
Prog5202:mov       ds:[ExecPckE],ax

; ------ na‡ten¡ jm‚na programu COMMAND.COM

         mov       si,offset ComSpc         ; parametr "COMSPEC"
         call      far ptr Get0Env          ; nalezen¡ parametru COMSPEC
         jnc       Prg52022                 ; parametr nalezen OK

         mov       si,offset Command        ; parametr "COMMAND"
         push      ds
         pop       es                       ; ES <- datov˜ segment

Prg52022:mov       di,offset ExecPath       ; buffer k ulo‘en¡ jm‚na

         push      ds

         push      ds
         push      es
         pop       ds                       ; DS <- segment parametru
         pop       es                       ; ES <- datov˜ segment
         cld
Prg52023:cmp       di,offset ExecPath+FileMax-1
         jbe       Prg52024
         dec       di
Prg52024:lodsb
         stosb
         cmp       al,0
         jne       Prg52023

         pop       ds

; ------ ulo‘en¡ historie na disk

         call      far ptr StoSHist         ; ulo‘en¡ historie

; ------ n vrat obrazovky

         call      far ptr ClosMnuA         ; uzav©en¡ v¨ech menu

         test      byte ptr ds:[ProgSwc3],bit1 ; je obsluha stm¡va‡e ?
         jnz       Pro51031                 ; je obsluha ext. stm¡va‡e

         cmp       byte ptr ds:[STopLine],-1
         jne       Prog5101
         mov       word ptr ds:[STopAdr],0
         mov       byte ptr ds:[STopLine],0

Prog5101:xor       dx,dx
         mov       cl,ds:[Pozic]
         mov       ch,ds:[Radku]
         call      far ptr PopScr
         mov       dx,ds:[SKurzor]          ; uschovan˜ syst‚mov˜ kurzor

         cmp       dh,ds:[MaxRow]           ; p©ekro‡en maxim ln¡ © dek ?
         jbe       Prog5102                 ; © dek je OK
         mov       dh,ds:[MaxRow]           ; omezen¡ © dku
Prog5102:cmp       dl,ds:[MaxPoz]           ; p©ekro‡ena maxim ln¡ pozice ?
         jbe       Prog5103                 ; pozice je OK
         mov       dl,ds:[MaxPoz]           ; omezen¡ pozice
Prog5103:
         call      far ptr SetKurz          ; nastaven¡ kurzoru

; ------ vypnut¡ my¨i

Pro51031:call      far ptr MouseOff         ; vypnut¡ kurzoru my¨i
         call      far ptr PopFont          ; n vrat definice font–
         test      byte ptr ds:[ParDisp],bit6 ; maj¡ se navracet fonty ?
         jnz       Pro51032                 ; fonty se maj¡ vracet
         call      far ptr InitFont
Pro51032:

; ------ odinstalov n¡ obsluh p©eru¨en¡

         call      far ptr DeInsInt         ; odinstalov n¡ obsluh p©eru¨en¡

; ------ nastaven¡ p©echodn‚ho z sobn¡ku

         push      ss
         pop       es                       ; £schova segmentu z sobn¡ku
         mov       ax,SEG StackS            ; segment z sobn¡ku
         mov       ss,ax                    ; segment z sobn¡ku
         mov       sp,256                   ; adresa konce z sobn¡ku

; ------ uvolnˆn¡ aloka‡n¡ho bloku z sobn¡ku

         mov       ah,49h
         int       21h                      ; uvolnˆn¡ bloku z sobn¡ku

; ------ uvolnˆn¡ datov‚ho bloku pamˆti

         mov       es,ds:[TopSeg]           ; aloka‡n¡ datov˜ blok pamˆti
         mov       ah,49h
         int       21h                      ; uvolnˆn¡ bloku pamˆti

; ------ extern¡ stm¡va‡ se startuje v‘dy v rychl‚m m¢du

         test      byte ptr ds:[ProgSwc3],bit1 ; je obsluha stm¡va‡e ?
         jnz       Progr534                 ; start v rychl‚m m¢du
         test      byte ptr ds:[StartPar],bit1 ; je aktualizace INI souboru ?
         jnz       Progr534                 ; je aktualizace INI souboru

; ------ proveden¡ p©¡kazu pomoc¡ $DOSMAN$.BAT

         test      byte ptr ds:[UserSwcM],bit1 ; je menu s povelem "!" ?
         jz        Prog5104                 ; nen¡ menu s povelem "!"
         test      byte ptr ds:[UserSwcM],bit2 ; je m¢d spou¨tˆn¡ s BAT ?
         jnz       Prog5105                 ; nen¡ m¢d spou¨tˆn¡ s BAT
         jmp       short Progr53            ; jin˜ m¢d spou¨tˆn¡

Prog5104:test      byte ptr ds:[ProgSwc],bit0 ; je BAT m¢d ?
         jz        Progr53                  ; nen¡ BAT m¢d
Prog5105:call      far ptr StorBCnf         ; ulo‘en¡ konfigurace

; ------ z pis p©¡kazu do souboru

         test      byte ptr ds:[ProgSwc],bit7 ; je ji‘ $DOSMAN$.BAT ?
         jnz       Progr51                  ; je ji‘ $DOSMAN$.BAT
         call      far ptr OpenBPth         ; vytvo©en¡ souboru
         jc        Progr51

         mov       es,ds:[SegPSP]           ; segment PSP
         mov       si,cs:[ProgAdrB]         ; za‡ tek dat
         mov       cx,cs:[ProgAdrN]         ; d‚lka dat
         inc       cx
         inc       cx
         call      far ptr WritFile         ; z pis dat do souboru

         call      far ptr ClosFile

Progr51: mov       es,ds:[RezPSP]
         mov       byte ptr es:[80h],1      ; je m¢d BAT
         mov       ax,4c00h
         int       21h

ProgAdrB dw        81h                      ; uschovan  adresa za‡ tku p©¡kazu
ProgAdrN dw        0                        ; d‚lka textu

; ------ proveden¡ p©¡kazu bez zru¨en¡ DOSMANu

Progr53: test      byte ptr ds:[UserSwcM],bit1 ; je menu s povelem "!" ?
         jz        Progr532                 ; nen¡ menu s povelem "!"
         test      byte ptr ds:[UserSwcM],bit4 ; je rychl˜ m¢d ?
         jz        Progr54                  ; nen¡ rychl˜ m¢d
         jmp       short Progr534           ; jinak rychl˜ m¢d

Progr532:test      byte ptr ds:[ProgSwc],bit2 ; je rychl˜ m¢d ?
         jz        Progr54                  ; nen¡ rychl˜ m¢d

; ------ start programu (DS=datov˜ segment)

Progr534:call      far ptr StoPCnf          ; ulo‘en¡ konfigurace

         push      ds
         mov       ax,SEG CodeLod           ; segment zavadˆ‡e
         mov       ds,ax
         mov       dx,offset INT024
         mov       ax,2524h
         int       21h                      ; p©edefinov n¡ INT 24h
         mov       dx,offset INT023
         mov       ax,2523h
         int       21h                      ; p©edefinov n¡ INT 23h
         pop       ds

         push      ds
         pop       es
         mov       dx,offset ExecPath       ; cesta k programu
         mov       bx,offset ExecPack       ; paket parametr–
         mov       ax,4b00h
         test      byte ptr ds:[StartPar],bit1 ; je aktualizace INI souboru ?
         jnz       Progr536                 ; je aktualizace INI souboru
         int       21h                      ; start programu

; ------ obnoven¡ ukazatele z sobn¡ku

Progr536:mov       ax,SEG StackS            ; segment z sobn¡ku
         mov       ss,ax                    ; segment z sobn¡ku
         mov       sp,256                   ; adresa konce z sobn¡ku

; ------ obnoven¡ registr–

         mov       ax,SEG Data              ; datov˜ segment
         mov       ds,ax                    ; DS <- datov˜ segment
         mov       es,ds:[SegPSP]           ; segment PSP
         mov       byte ptr es:[80h],0      ; nen¡ nic v p©¡kazov‚m © dku

; ------ nov˜ start programu

         or        byte ptr ds:[StartPar],bit2 ; p©¡znak opakovan‚ho startu
         jmp       far ptr ReStart          ; opakovan˜ start

; ------ skok do obsluhy p©¡kazu

Progr54: call      far ptr StoPCnf          ; ulo‘en¡ konfigurace
         mov       si,offset ConfBeg
         mov       di,si
         push      ds
         pop       es
         call      far ptr TestDSum         ; kontroln¡ sou‡et
         mov       ds:[si+4],dx             ; nastaven¡ kontroln¡ho sou‡tu
         test      byte ptr ds:[StartPar],bit0 ; je rezidentn¡ modul ?
         jnz       Progr55                  ; je rezidentn¡ modul
         jmp       far ptr Execute          ; proveden¡ p©¡kazu

; ------ £schova dat do rezidentn¡ho modulu

Progr55: mov       es,ds:[RezData]          ; rezidentn¡ data
         mov       cx,offset ConfEnd
         sub       cx,si
         cld
         rep       movsb                    ; £schova dat

         mov       di,80h
         mov       ax,ds:[RezPSP]
         mov       es:[ExecPck1],ax         ; segment p©¡kazov‚ho © dku
         mov       es:[ExecPck0],di         ; offset p©¡kazov‚ho © dku

         push      ds
         mov       es,ax
         mov       ds,ds:[SegPSP]
         mov       si,di
         mov       cl,128
         cld
         rep       movsb
         pop       ds

         mov       ax,4c00h
         int       21h

Progr5   ENDP

; -----------------------------------------------------------------------------
;        otev©en¡ souboru $DOSMAN$.BAT -> AX identifik tor, CY=chyba
; -----------------------------------------------------------------------------

OpenBPth PROC      FAR

; ------ £schova regisr–

         push      si
         push      di
         push      bp
         push      es
         mov       bp,sp

; ------ sestaven¡ jm‚na souboru

         sub       sp,FileMax
         push      ss
         pop       es
         mov       di,sp
         mov       si,offset DosmBat
         call      far ptr TempFile         ; sestaven¡ jm‚na souboru

; ------ vytvo©en¡ souboru

         test      byte ptr ds:[TempDirP],bit0 ; je z kaz z pisu ?
         stc                                ; p©¡znak chyby
         jnz       OpenBPt9                 ; je z kaz z pisu
         mov       si,sp
         call      far ptr CreatFil         ; vytvo©en¡ souboru

; ------ n vrat registr–

OpenBPt9:mov       sp,bp
         pop       es
         pop       bp
         pop       di
         pop       si
         ret

OpenBPth ENDP

CodeFil  ENDS

; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;
;                                 Data
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;þ
Data     SEGMENT   BYTE PUBLIC

; -----------------------------------------------------------------------------
;        Definice menu - informace o souboru
; -----------------------------------------------------------------------------
;þ
SIMnuLin label     byte                   ;* informace o souboru

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        7                        ; po‡et platn˜ch polo‘ek menu
         dw        24                       ; celkov˜ po‡et polo‘ek menu

         dw        SIMnLPol                 ; za‡ tek definice polo‘ek menu
         dw        SIMnLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@InformaceOSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        SIMnLBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SIMnLTit                 ; adresa titulu okna
         dw        SIMnLExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        21                       ; po‡ te‡n¡ pozice okna
         db        5                        ; po‡ te‡n¡ © dek okna
         db        80                       ; ¨¡©ka okna
         db        22                       ; v˜¨ka okna

         dw        250                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; identifik tor historie
         db        0                        ; po‡et p©edvoleb

; ------ polo‘ky voleb

SIMnLPol db        bit6,5,4,0,1
         dw        SRMnuFil                 ; jm‚no souboru

         db        bit6,5,4,0,1             ; dlouh‚ jm‚no
         dw        DTALName-1

         db        bit6,42,'Datum: ',0,1
         dw        SRMnuDat
         db        0,'Velikost: ',0,1
         dw        SRMnuSiz
         db        0,'Atributy: ',0,1
         dw        SRMnuAtr
         db        ' '

         db        bit6,54,'  €as: ',0,1
         dw        SRMnuTim
         db        0,'  Zab¡r : ',0
SIMKapac db        13 dup(" ")
         db        0,' Soubor–: ',0
SIMSoub  db        6 dup(" ")

         db        bit6,3,1
SIMnLPl3 dw        SRMnuVLn

         db        bit6+bit7,0

         db        bit6,10,4,0,3            ; koment ©
SIMKomK  db        0
         dd        0
         db        2,0                      ; (jen aby byla stejn  d‚lka polo‘ky)

         REPT      9
         db        bit6,9,4,3               ; popis
         db        0
         dd        0
         db        2,250                    ; mezery zprava
         ENDM

         db        bit6+bit7,0

         db        1,8,'Koment ©'
         db        1,5,'Popis'
         db        1,5,'Dal¨¡'
         db        1,4,'Zpˆt'
         db        1,7,'Redukce'
         db        1,7,'Adres ©'
         db        1,6,'N vrat'

SIMnLBlk db        0,0,0,0,0,0,0            ; blokovac¡ tabulka

SIMnLExe label     dword
         dd        Lin0MenR                 ; Koment ©
         dd        Lin0MenR                 ; Editace
         dd        InfoMDal                 ; Dal¨¡
         dd        InfoMPre                 ; Zpˆt
         dd        Lin0MenR                 ; Redukce
         dd        Lin0MenR                 ; Adres ©
         dd        Lin0MenR                 ; N vrat

SRMnuVL0 db        0

SRMnuVLn db        72,'Vytvo©eno: ',0
SRMnuVtD db        '00.00.0000'          ; datum vytvo©en¡
         db        0,'   ...    v: ',0
SRMnuVtT db        '00:00:00'             ; ‡as vytvo©en¡
         db        0,'     Otev©eno: ',0
SRMnuOpn db        '00.00.0000'             ; datum otev©en¡

SIMnBuf  dw        0                        ; pracovn¡ mezibuffer (‡as, datum)

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SIMnLHlp db        59,'Koment © k polo‘ce (zobrazen˜ v komentovan‚m m¢du Ctrl-K)'
         db        36,'Editace v¡ce© dkov‚ho popisu polo‘ky'
         db        42,'Zobrazen¡ informac¡ k dal¨¡ polo‘ce v oknˆ'
         db        45,'Zobrazen¡ informac¡ k p©ede¨l‚ polo‘ce v oknˆ'
         db        64,'Redukce koment ©– - vypu¨tˆn¡ koment ©– k neexistuj¡c¡m polo‘k m'
         db        62,'Koment © k adres ©i (nadpis okna v komentovan‚m m¢du Ctrl-K)'
         db        26,'N vrat z informa‡n¡ho okna'
HelpS    ENDS

SIMnLTit db        9,'informace'

SInfSize dd        0                        ; velikost souboru nebo adres ©e
SInfKap  dd        0                        ; zabran  kapacita na disku
SInfSoub dw        0                        ; po‡et soubor– v adres ©i
SInfBlk  dw        0                        ; velikost aloka‡n¡ho bloku

InfoCtuT db        21,'Na‡¡t m informace o ',0

; ------ menu - koment © polo‘ky

SIKMnLin label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SIKMnPol                 ; za‡ tek definice polo‘ek menu
         dw        SIKMnHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KomentareSouboru     ; ‡¡slo str nky velk‚ n povˆdy
         dw        SIKMnBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SIKMnTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        20                       ; po‡ te‡n¡ pozice okna
         db        0                        ; po‡ te‡n¡ © dek okna
         db        27                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        250                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak– - v¨echny
         db        3,13,10,0,'   '          ; zak zan‚ znaky

         db        HistKom                  ; historie koment ©–
SIKMnPN1 db        0                        ; po‡et p©edvoleb
SIKMnPD1 dw        0                        ; d‚lka p©edvolby
SIKMnPA1 dd        0                        ; adresa p©edvolby

; ------ polo‘ky voleb

SIKMnPol db        bit6,4,0,1
         dw        SRMnuFil                 ; jm‚no souboru

         db        0,0
         db        bit6+bit7,0
         db        2,6,' Ulo‘ '
         db        1,6,'N vrat'

SIKMnBlk db        0,0,0                    ; blokovac¡ tabulka

SIKMnTit db        8,'koment ©'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SIKMnHlp db        58,'Zadejte nov˜ koment © polo‘ky (zobrazen  d‚lka 25 znak–)'
         db        26,'Ulo‘en¡ zadan‚ho koment ©e'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

; ------ menu - nadpis

SINMnLin label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SINMnPol                 ; za‡ tek definice polo‘ek menu
         dw        SINMnHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KomentareSouboru     ; ‡¡slo str nky velk‚ n povˆdy
         dw        SINMnBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SINMnTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        20                       ; po‡ te‡n¡ pozice okna
         db        0                        ; po‡ te‡n¡ © dek okna
         db        40                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        250                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak– - v¨echny
         db        3,13,10,0,'   '          ; zak zan‚ znaky

         db        HistKom                  ; historie koment ©–
SINMnPN1 db        0                        ; po‡et p©edvoleb
SINMnPD1 dw        0                        ; d‚lka p©edvolby
SINMnPA1 dd        0                        ; adresa p©edvolby

; ------ polo‘ky voleb

SINMnPol db        bit6,21,'Nov˜ nadpis adres ©e:'
         db        0,0
         db        bit6+bit7,0
         db        2,6,' Ulo‘ '
         db        1,6,'N vrat'

SINMnBlk db        0,0,0                    ; blokovac¡ tabulka

SINMnTit db        6,'nadpis'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SINMnHlp db        57,'Zadejte nov˜ nadpis adres ©e (zobrazen  d‚lka 38 znak–)'
         db        24,'Ulo‘en¡ zadan‚ho nadpisu'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

; -----------------------------------------------------------------------------
;        okno editoru pole popisu
; -----------------------------------------------------------------------------
;þ
PopisMnu label     byte
         db        16                       ; typ menu - editace textu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        1                        ; po‡et polo‘ek menu
         dw        1                        ; celkov˜ po‡et polo‘ek menu

         dw        0                        ; za‡ tek definice polo‘ek menu
         dw        TxtMnHl1                 ; adresa tabulky text– n povˆdy
         dw        Hlp@EditorZapisniku      ; ‡¡slo str nky velk‚ n povˆdy
         dw        0                        ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        PopMnTit                 ; adresa titulu okna
         dw        LinMenTM                 ; adresy obsluh
         dw        LinMenTM                 ; adresa podmenu
         dd        0                        ; n vratov  adresa

         db        0                        ; po‡ te‡n¡ pozice okna
         db        1                        ; po‡ te‡n¡ © dek okna
         db        80                       ; ¨¡©ka okna
         db        21                       ; v˜¨ka okna

PopsSegm dw        0                        ; aktivn¡ segment s textem

PopMnTit db        13,'popis polo‘ky'

; -----------------------------------------------------------------------------
;        varov n¡ p©ed redukc¡ polo‘ek
; -----------------------------------------------------------------------------

InfoRMnu label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        10                       ; celkov˜ po‡et polo‘ek menu

         dw        InfoRMnP                 ; adresa defini‡n¡ tabulky polo‘ek
         dw        InfoRMnH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KomentareSouboru     ; ‡¡slo str nky velk‚ n povˆdy
         dw        InfoRMnB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        InfoRMnT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        6                        ; po‡ te‡n¡ pozice
         db        7                        ; po‡ te‡n¡ © dek
         db        54                       ; ¨¡©ka
         db        13                       ; v˜¨ka

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; dopl¤uj¡c¡ zak zan‚ znaky

         db        0                        ; identifik tor historie
         db        0                        ; po‡et p©edvoleb

InfoRMnP db        bit6,9,0,'VAROVN‹'
         db        bit6,0
         db        bit6,31,'Redukc¡ koment ©– budou zru¨eny'
         db        bit6,29,'v¨echny koment ©e k polo‘k m,'
         db        bit6,27,'kter‚ v adres ©i neexistuj¡'
         db        bit6,30,'nebo nejsou zobrazeny v oknˆ !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,9,'Redukovat'
         db        1,6,'N vrat'

HelpS    SEGMENT   BYTE PUBLIC
InfoRMnH db        52,'Proveden¡ redukce koment ©– k neexistuj¡c¡m polo‘k m'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

InfoRMnB db        0,0
InfoRMnT db        17,'redukce koment ©–'

; -----------------------------------------------------------------------------
;        Modifikace parametr– soubor–
; -----------------------------------------------------------------------------
;þ
SMMnVert label     byte                   ;* menu modifikace soubor–

         db        2                        ; typ menu - vertik ln¡ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        5                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SMMnVPol                 ; defini‡n¡ tabulka polo‘ek
         dw        SMMnVHlp                 ; n povˆda
         dw        Hlp@MenuModifikaceSouboru ; ‡¡slo str nky velk‚ n povˆdy
         dw        SMMnVBlk                 ; blokovac¡ tabulka
         dw        0                        ; p©ep¡na‡e
         dw        SMMnVTit                 ; adresa titulu okna
         dw        SMMnVExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        36                       ; po‡ te‡n¡ pozice
         db        10                       ; po‡ te‡n¡ © dek
         db        20                       ; ¨¡©ka okna
         db        7                        ; v˜¨ka okna

SMMnVPol db        1,6,'Kurzor'
         db        1,8,'Ozna‡en‚'
         db        1,7,'Soubory'
         db        1,7,'V¨echny'
         db        1,6,'Zadan‚'

SMMnVBlk db        0,0,0,0,0

SMMnVTit db        10,'modifikace'

HelpS    SEGMENT   BYTE PUBLIC
SMMnVHlp db        55,'Modifikace parametr– souboru nebo adres ©e pod kurzorem'
         db        57,'Modifikace parametr– ozna‡en˜ch soubor– a adres ©– (F9)'
         db        50,'Modifikace parametr– v¨ech soubor– v aktivn¡m oknˆ'
         db        77,'Modifikace parametr– v¨ech soubor– a adres ©– v aktivn¡m oknˆ a podadres ©¡ch'
         db        64,'Modifikace parametr– soubor– a adres ©– podle bli‘¨¡ specifikace'
HelpS    ENDS

SMMnVExe label     dword                    ; obsluhy voleb
         dd        ModiFil                  ; kurzor
         dd        ModiFil                  ; ozna‡en‚
         dd        ModiFil                  ; soubory
         dd        ModiFil                  ; v¨echny
         dd        ModiFil                  ; zadan‚

; -----------------------------------------------------------------------------
;       Volba soubor– k modifikaci parametr–
; -----------------------------------------------------------------------------

SMZMLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SMZMLPol                 ; za‡ tek definice polo‘ek menu
         dw        SMZMLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@VyberSouboru         ; ‡¡slo str nky velk‚ n povˆdy
         dw        SMZMLBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SMZMLTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        45                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        HistSel                  ; identifik tor historie
         db        1                        ; po‡et p©edvoleb

         dw        3                        ; d‚lka p©edvolby
         dd        All                      ; p©edvolba

; ------ polo‘ky voleb

SMZMLPol db        bit6,31,'Soubory k modifikaci parametr–:'
         db        0,0
         db        bit6+bit7,0
         db        1,6,'Proveƒ'
         db        1,6,'N vrat'

SMZMLBlk db        0,0,0                    ; blokovac¡ tabulka

SMZMLTit db        6,'zadan‚'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SMZMLHlp db        3,1
         dw        MenuFndH
         db        48,'Modifikace parametr– zadan˜ch soubor– a adres ©–'
         db        3,1
         dw        MenuHlP1
HelpS    ENDS

; -----------------------------------------------------------------------------
;        Zad n¡ parametr– soubor–
; -----------------------------------------------------------------------------

SMMMLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SMMMLPol                 ; za‡ tek definice polo‘ek menu
         dw        SMMMLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@ModifikaceSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        SMMMLBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SMMMLTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        45                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit6                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        HistAtri                 ; identifik tor historie
         db        1                        ; po‡et p©edvoleb

         dw        26                       ; d‚lka p©edvolby 1
         dd        SMMMLPr1                 ; p©edvolba 1
;         dw        1                        ; d‚lka p©edvolby 2
;         dd        SMMMLPr2                 ; p©edvolba 2

SMMMLPr1 db        'ashr D01.01.1980 T00:00:00' ; p©edvolba 1
;SMMMLPr2 db        '+'                      ; p©edvolba 2

; ------ polo‘ky voleb

SMMMLPol db        bit6,31,'Zadejte parametry k modifikaci:'
         db        0,0
         db        bit6+bit7,0
         db        1,6,'Proveƒ'
         db        1,6,'N vrat'

SMMMLBlk db        0,0,0                    ; blokovac¡ tabulka

SMMMLTit db        10,'modifikace'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SMMMLHlp db        89,'Parametry: atributy +/- zobrazit, ASHR nastavit, ashr nulovat; D datum, T ‡as'
         db        33,'Modifikace parametr– podle zad n¡'
         db        3,1
         dw        MenuHlP1
HelpS    ENDS

; -----------------------------------------------------------------------------
;        chybov‚ hl ¨en¡ - chyba modifikace
; -----------------------------------------------------------------------------

ChbErMod label     byte
         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        2                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        ChbErMoP                 ; za‡ tek definice polo‘ek menu
         dw        ChbErMoH                 ; adresa tabulky text– n povˆdy
         dw        Hlp@ModifikaceSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        ChbErMoB                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        ChbErMoT                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        56                       ; ¨¡©ka okna
         db        9                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

ChbErMoT db        16,'chyba modifikace'

ChbErMoP db        bit6,6,0,'CHYBA'
         db        bit6,42,'Chyba modifikace parametr– souboru ',0,1
         dw        SRMnuFil
         db        0,' !'
         db        bit6,0
         db        bit6+bit7,0
         db        1,5,'Dal¨¡'
         db        1,8,'P©eru¨it'

ChbErMoB db        0,0                      ; blokovac¡ tabulka

HelpS    SEGMENT   BYTE PUBLIC
ChbErMoH db        48,'Pokra‡ov n¡ modifikac¡ parametr– dal¨¡ho souboru'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

; -----------------------------------------------------------------------------
;        data k modifikaci parametr– soubor– (nemˆnit po©ad¡ polo‘ek a masek !)
; -----------------------------------------------------------------------------

ModiWPar db        0                        ; parametry
                                            ;   bit 0: 1=zad n "+" nebo "-"
                                            ;   bit 1: 1=zap "+", 0=vyp "-"
                                            ;   bit 2: 1=zad ny atributy ASHR
                                            ;   bit 3:
                                            ;   bit 4: 1=zad no datum
                                            ;   bit 5: 1=aktu ln¡ datum
                                            ;   bit 6: 1=zad n ‡as
                                            ;   bit 7: 1=aktu ln¡ ‡as

ModiAtr  db        0                        ; atributy k modifikaci polo‘ky
ModiAtrM db        -1                       ; maska atribut– k modifikaci

ModiTim  dw        0                        ; ‡as k modifikaci polo‘ky
ModiTimM dw        -1                       ; maska k modifikaci ‡asu polo‘ky

ModiDat  dw        0                        ; datum k modifikaci polo‘ky
ModiDatM dw        -1                       ; maska k modifikaci data polo‘ky

ModiTxt  db        12,'Modifikuji ',0

;ChybBuff db        1,32 dup(" ")            ; buffer chybov‚ho textu

; -----------------------------------------------------------------------------
;        Start programu
; -----------------------------------------------------------------------------
;þ
SPMnVert label     byte                   ;* start programu

         db        2                        ; typ menu - vertik ln¡ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        7                        ; po‡et platn˜ch polo‘ek menu
         dw        8                        ; celkov˜ po‡et polo‘ek menu

         dw        SPMnVPol                 ; defini‡n¡ tabulka polo‘ek
         dw        SPMnVHlp                 ; n povˆda
         dw        Hlp@MenuSpusteniprogramu ; ‡¡slo str nky velk‚ n povˆdy
         dw        SPMnVBlk                 ; blokovac¡ tabulka
         dw        SPMnVSwc                 ; p©ep¡na‡e
         dw        SPMnVTit                 ; adresa titulu okna
         dw        SPMnVExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        36                       ; po‡ te‡n¡ pozice
         db        10                       ; po‡ te‡n¡ © dek
         db        20                       ; ¨¡©ka okna
         db        10                       ; v˜¨ka okna

SPMnVPol db        bit7+1,7,'BAT m¢d'
         db        bit7+1,6,'Loader'
         db        bit7+1,10,'Rychl˜ m¢d'
         db        bit6+bit7,0
;         db        bit7+1,11,'COMMAND.COM'
;         db        bit7+1,10,'Dˆlen˜ BAT'
;         db        bit7+1,14,'Uschovat v˜bˆr'
;         db        bit6+bit7,0
         db        1,6,'Kurzor'
         db        1,4,'Menu'
         db        1,8,'Ozna‡en‚'
         db        1,6,'P©¡kaz'
;         db        1,6,'Zadan‚'

SPMnVSwc db        0,0,0

SPMnVBlk db        0,0,0,0,0,0,0

SPMnVTit db        7,'program'

HelpS    SEGMENT   BYTE PUBLIC
SPMnVHlp db        81,'M¢d s povelov˜m souborem - v pamˆti nic nez–st v  (DOSMAN spu¨tˆn z DOSM.BAT)'
         db        78,'M¢d se zavadˆ‡em - v pamˆti z–st v  1.6 KB (+ rezidentn¡ ‡ st COMMAND.COM)'
         db        80,'Rychl˜ m¢d - v pamˆti z–st v  310 KB (cel˜ DOSMAN, nen¡ nutn‚ nov‚ zav dˆn¡)'
;         db        73,'Ke spu¨tˆn¡ program– je pou‘it COMMAND.COM (v pamˆti nav¡c zhruba 2.5 KB)'
;         db        62,'Povelov‚ soubory prov dˆny po © dc¡ch (nen¡ nutn˜ COMMAND.COM)'
;         db        32,'—schova ozna‡en¡ soubor– na disk'
         db        71,'Spu¨tˆn¡ programu pod kurzorem (ENTER; podle definice v DOSMAN.INI)'
         db        50,'Proveden¡ p©¡kazu pomoc¡ u‘ivatelsk‚ho menu (F2)'
         db        81,'Hromadn‚ proveden¡ p©¡kazu s ozna‡en˜mi soubory (pro x.BAT uveƒte CALL x.BAT)'
         db        63,'Proveden¡ p©¡kazu podle zad n¡ (v p©¡kazov‚m © dku; Shift-F2)'
;         db        50,'Operace provedena se soubory podle bli‘¨¡ho zad n¡'
HelpS    ENDS

SPMnVExe label     dword                    ; obsluhy voleb
         dd        Progr101                 ; BAT m¢d
         dd        Progr104                 ; Loader
         dd        Progr105                 ; Rychl˜ m¢d
;         dd        Progr106                 ; COMMAND.COM
;         dd        Progr107                 ; dˆlen˜ BAT
;         dd        Progr108                 ; uschovat v˜bˆr
         dd        Progr2                   ; kurzor
         dd        Progr3                   ; menu
         dd        Progr4                   ; ozna‡en‚
         dd        Progr5                   ; p©¡kaz
;         dd        0                        ; zadan‚

; -----------------------------------------------------------------------------
;        Zad n¡ p©¡kazu
; -----------------------------------------------------------------------------

SPZMLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SPZMLPol                 ; za‡ tek definice polo‘ek menu
         dw        SPZMLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@PrikazovyRadek       ; ‡¡slo str nky velk‚ n povˆdy
         dw        SPZMLBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SPZMLTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        50                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

SPZMLinM dw        115                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        HistComm                 ; identifik tor historie
SPZMLPlL db        1                        ; po‡et p©edvoleb

SPZMLPlN dw        0                        ; d‚lka p©edvolby
         dd        LineCBuf                 ; p©edvolba

; ------ polo‘ky voleb

SPZMLPol db        bit6,27,'Zadejte p©¡kaz k proveden¡:'
         db        0,0
         db        bit6+bit7,0
         db        1,6,'Proveƒ'
         db        1,6,'N vrat'

SPZMLBlk db        0,0,0                    ; blokovac¡ tabulka

SPZMLTit db        6,'p©¡kaz'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SPZMLHlp db        26,'Zadejte p©¡kaz k proveden¡'
         db        26,'Proveden¡ zadan‚ho p©¡kazu'
         db        3,1
         dw        MenuHlP1
HelpS    ENDS

; ------ parametry

;ProgSwc  db        bit1+bit3+bit5           ; p©ep¡na‡e voleb
;                                            ;   bit 0: 1=BAT m¢d
;                                            ;   bit 1: 1=Loader
;                                            ;   bit 2: 1=rychl˜ m¢d (perm.)
;                                            ;   bit 3: 1=COMMAND.COM
;                                            ;   bit 4: 1=dˆlen˜ BAT
;                                            ;   bit 5: 1=uschovat v˜bˆr

ProgSwc2 db        0                        ; parametry 2 pro program
                                            ;   bit 0: 1=je p©¡kaz z EXTENSION/MENU


ProgTxt1 db        18,'Prov d¡m p©¡kaz...'

Command  db        'C:\COMMAND.COM',0

ComSpc   db        7,'COMSPEC'

DosmBat  db        12,'$DOSMAN$.BAT'

Data     ENDS
         END
