
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;                              F I L E  -  5
;
;                    Obsluha soubor– - Kop¡rov n¡ a P©esun
;
; =============================================================================
;
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°

INCLUDE  ASM\DEF.ASM

CodeFil  SEGMENT   BYTE PUBLIC
         ASSUME    cs:CodeFil,ds:Data

; *****************************************************************************
;
;                      P©esun soubor– a adres ©–
;
; *****************************************************************************
;þ
; Pozor na p©esouv n¡ adres ©e, kter˜ je v jin‚m oknˆ jako aktivn¡ - DOS
; to nemus¡ povolit (je-li to aktivn¡ adres © disku)

AWMMnuSJ LABEL     FAR

         mov       ax,word ptr ds:[SMnuVert+MnuPoz] ; pozice p©edchoz¡ho okna
         add       ax,407h                  ; posun okna
         mov       word ptr ds:[si+MnuPoz],ax        ; pozice okna
         jmp       far ptr VertMenu

; ------ zah jen¡ operace z menu

MoveFil  LABEL     FAR

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         mov       bx,ds:[si+MnuAkt]        ; aktivn¡ zvolen  polo‘ka
         mov       al,cs:[bx+CopSouTb-1]    ; parametry pro v˜bˆr polo‘ek

; ------ vstupn¡ bod z funk‡n¡ kl vesy (AL=typ operace)

MoveFilF LABEL     FAR

         mov       byte ptr ds:[CopyParD],bit6 ; p©¡znak p©esunu
         jmp       short CopyFl04

; *****************************************************************************
;
;                      Kop¡rov n¡ soubor– a adres ©–
;
; -----------------------------------------------------------------------------
; lok ln¡ promˆnn‚: SS:[BP-2] (2) adresa masky dlouh‚ho jm‚na v z sobn¡ku
;                   SS:[BP-4] (2)         (d‚lka masky dlouh‚ho jm‚na v z sobn¡ku)
;                   SS:[BP-6] (2) adresa dlouh‚ho jm‚na souboru v z sobn¡ku
;                   SS:[BP-8] (2)         (d‚lka dlouh‚ho jm‚na souboru v z sobn¡ku)
;                   SS:[BP-10] (2) adresa c¡lov‚ho jm‚na souboru v z sobn¡ku
;                   SS:[BP-12] (2)       (d‚lka c¡lov‚ho jm‚na souboru v z sobn¡ku)
;                             (256) maska dlouh‚ho jm‚na
;                             (256) uschovan‚ dlouh‚ jm‚no souboru
;                           (2*256) c¡lov‚ dlouh‚ jm‚no
; -----------------------------------------------------------------------------
; Soubory mus¡ b˜t p©i operaci poskytov ny se zv˜¨en¡m hloubky vno©en¡ max.
; o 1 £rove¤, proto‘e jsou prov dˆny korekce dlouh˜ch jmen na kr tk . Pouze
; u seznamu hled n¡ nemus¡ b˜t podadres ©e, proto‘e se nevytv ©ej¡ s dlouh˜mi
; jm‚ny.
; *****************************************************************************
;þ
AWMMnuSK LABEL     FAR

         mov       ax,word ptr ds:[SMnuVert+MnuPoz] ; pozice p©edchoz¡ho okna
         add       ax,507h                  ; posun okna
         mov       word ptr ds:[si+MnuPoz],ax        ; pozice okna
         jmp       far ptr VertMenu

CopSouTb db        bit0 + bit4 + bit6 + bit7; kurzor
         db        bit1 + bit4 + bit6 + bit7; ozna‡en‚
         db        bit2                     ; soubory
         db        bit2 + bit4 + bit6 + bit7; v¨echny
         db        bit3 + bit4 + bit6       ; zadan‚

; ------ zah jen¡ operace z menu DS:SI

CopyFil  LABEL     FAR

         add       sp,4                     ; zru¨en¡ n vratov‚ adresy
         mov       bx,ds:[si+MnuAkt]        ; aktivn¡ zvolen  polo‘ka
         mov       al,cs:[bx+CopSouTb-1]    ; parametry pro v˜bˆr polo‘ek

; ------ vstupn¡ bod z funk‡n¡ kl vesy (AL=typ operace)

CopyFilF LABEL     FAR

; ------ inicializace parametr–

         mov       byte ptr ds:[CopyParD],bit5 ; p©¡znak operace kop¡rov n¡
CopyFl04:mov       byte ptr ds:[ExistPar],0 ; inicializace p©¡znak– p©episu
         mov       byte ptr ds:[CopyRusP],0 ; parametry pro ru¨en¡ R/O polo‘ek
         call      far ptr ClosMnuA         ; uzav©en¡ v¨ech oken menu

; ------ p©¡prava lok ln¡ho bufferu

         push      bp
         mov       bp,sp
         sub       sp,12+256
         mov       ss:[bp-2],sp             ; adresa masky dlouh‚ho jm‚na
         sub       sp,256
         mov       ss:[bp-6],sp             ; adresa dlouh‚ho jm‚na
         sub       sp,2*256
         mov       ss:[bp-10],sp            ; adresa c¡lov‚ho dlouh‚ho jm‚na

; ------ inicializace vyhled v n¡ soubor– (AL=typ operace)

         call      far ptr InitFFil         ; inicializace vyhled v n¡
         jc        CopyFil0                 ; nen¡ ‘ dn˜ soubor k operaci

; ------ vytvo©en¡ pracovn¡ho datov‚ho bufferu (BX=typ operace !)

         call      far ptr CreatBuf         ; vytvo©en¡ pracovn¡ho bufferu
         jc        CopyFil0                 ; chyba

; ------ zad n¡ soubor– textem (BX=typ operace !)

         test      byte ptr ds:[FileTyp],bit3 ; je specifikace textem ?
         jz        CopyFil3                 ; nen¡ specifikace textem
CopyFl00:mov       si,offset SKZMLin        ; menu zad n¡ soubor– kop¡rov n¡
         test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jnz       CopyFl06                 ; je kop¡rov n¡
         mov       si,offset SJZMLin        ; menu zad n¡ soubor– pro p©esun
CopyFl06:push      bx
         call      far ptr Lin0Menu         ; obsluha volby
         pop       bx
         jnc       CopyFil1                 ; volba OK

; ------ zru¨en¡ lok ln¡ho bufferu, p©eru¨en¡ operace

CopyFil0:mov       sp,bp
         pop       bp
         jmp       far ptr Main0

; ------ rozbor zad n¡ parametr– operace (BX=typ operace !)

CopyFil1:call      far ptr RozborZ          ; rozbor zad n¡ parametr– operace
         jc        CopyFil0                 ; p©eru¨en¡ operace
         jnz       CopyFl00                 ; opakov n¡ zad n¡

; ------ doplnˆn¡ na plnou cestu (BX=typ operace !)

         call      far ptr RozbFPth         ; doplnˆn¡ na pln‚ jm‚no

; ------ zad n¡ c¡le operace (BX=typ operace !)

CopyFil3:mov       si,offset SK1MLin        ; menu pro kop¡rov n¡
         test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jnz       CopyFl31                 ; je kop¡rov n¡
         mov       si,offset SJ1MLin        ; menu zad n¡ c¡le
CopyFl31:call      CopyFPrp                 ; p©¡prava p©ep¡na‡–
         call      CopPred                  ; p©edvolby a zad n¡ c¡le
         jc        CopyFil0                 ; p©eru¨en¡ operace

; ------ £schova masky dlouh‚ho jm‚na

         push      ss
         pop       es                       ; ES <- segment bufferu
         mov       si,offset LinBuff        ; buffer zadan‚ho textu
         mov       ch,0
         mov       cl,ds:[LinNum]           ; d‚lka zadan‚ho textu
         cld
CopFl312:mov       di,ss:[bp-2]             ; adresa masky dlouh‚ho jm‚na
CopFl314:jcxz      CopFl316                 ; nen¡ dal¨¡ znak
         lodsb                              ; na‡ten¡ znaku
         dec       cx                       ; sn¡‘en¡ ‡¡ta‡e znak–
         cmp       al,"\"                   ; je adres © ?
         je        CopFl312                 ; inicializace ukazatele
         cmp       al,":"
         je        CopFl312
         stosb                              ; ulo‘en¡ znaku masky
         jmp       short CopFl314           ; dal¨¡ znak

CopFl316:mov       byte ptr es:[di],0       ; koncov˜ znak 0

; ------ inicializa‡n¡ zobrazen¡ textu

         mov       si,offset CopyTxt1       ; text "Kop¡ruji"
         test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jnz       CopyFl32                 ; je kop¡rov n¡
         mov       si,offset MoveTxt1       ; text "P©esov m"
CopyFl32:call      far ptr InfDisp0         ; zobrazen¡ textu

; ------ p©¡prava pln‚ c¡lov‚ cesty

         call      far ptr InitFCil         ; rozbor zad n¡ c¡le kop¡rov n¡
         jc        CopyFil0                 ; chyba nebo p©eru¨en¡ operace
         test      byte ptr ds:[CopyPrD2],bit7 ; c¡lov‚ jm‚no zru¨it ?
         jz        CopyFl33                 ; c¡lov‚ jm‚no nezru¨eno

         mov       di,ss:[bp-2]             ; adresa masky dlouh‚ho jm‚na
         mov       byte ptr ss:[di],0       ; koncov˜ znak 0

; ------ up©esnˆn¡ c¡le p©esunu (je p©ednastaven p©¡znak p©esunu mezi disky)

CopyFl33:mov       al,ds:[CilPath]          ; c¡lov˜ disk
         cmp       al,ds:[FilePath]         ; je stejn˜ disk ?
         jne       CopFl332                 ; nen¡ stejn˜ disk
         test      byte ptr ds:[CopyParD],bit6 ; je p©esun mezi disky ?
         jz        CopyFl34                 ; nen¡ p©esun mezi disky
         xor       byte ptr ds:[CopyParD],bit6+bit7 ; p©¡znak p©esunu na disku
         jmp       short CopyFl34

; ------ aktualizace oken s c¡lov˜m diskem AL (jen pokud se li¨¡ od zdrojov‚ho)

CopFl332:sub       al,"A"                   ; korekce na ‡¡slo disku
         mov       ah,bit3+bit4+bit5        ; asi aktualizovat v¨e
         call      far ptr ModWDisk         ; aktualizace oken pro disk AL
         call      far ptr MainRead         ; obnoven¡ na‡ten¡ oken
         call      far ptr DispAll          ; zobrazen¡ v¨eho
         call      far ptr TestBEsc         ; je p©eru¨en¡ operace ?
         jc        CopyFl41                 ; p©eru¨en¡ operace

; ------ p©¡prava parametr– c¡lov‚ho disku

CopyFl34:call      far ptr HistADir         ; ulo‘en¡ adres ©e do historie
         call      far ptr InitFSet         ; inicializace ozna‡en¡ polo‘ek
         call      CopyGDsk                 ; na‡ten¡ informac¡ o c¡lov‚m disku

; ------ poskytnut¡ dal¨¡ho souboru k operaci

CopyFil4:call      far ptr DispTime         ; obsluha ‡asu
         call      far ptr DarkNul          ; nulov n¡ stm¡va‡e obrazovky
         call      far ptr TestBEsc         ; je p©eru¨en¡ operace ?
         jc        CopyFl41                 ; p©eru¨en¡ operace
         call      far ptr GetFFil          ; poskytnut¡ souboru
         jnc       CopyFl42
CopyFl41:jmp       CopyFil9                 ; nen¡ dal¨¡ soubor - konec
CopyFl42:call      far ptr DispAAWn         ; zobrazen¡ aktivn¡ho okna

; ------ £schova dlouh‚ho jm‚na souboru

         and       byte ptr ds:[CopyPrD2],not bit5 ; nen¡ dlouh‚ jm‚no
         test      byte ptr ds:[Win95Par],bit2 ; je z kaz dlouh˜ch jmen ?
         jnz       CopFl428                 ; je z kaz dlouh˜ch jmen
         test      byte ptr ds:[CopyPrD2],bit1 ; zkr cen¡ na kr tk‚ jm‚no ?
         jnz       CopFl428                 ; je zkr cen¡ na kr tk‚ jm‚no
         call      CopFUsch                 ; £schova dlouh‚ho jm‚na

; ------ inicializace parametr– pro jeden soubor

CopFl428:and       byte ptr ds:[CopyParD],not bit0+bit2+bit3 ; nen¡ v˜stupn¡ soubor
         mov       ax,word ptr ds:[FileFSiz] ; velikost souboru LOW
         mov       word ptr ds:[CopyDSiz],ax ; zb˜vaj¡c¡ velikost LOW
         mov       word ptr ds:[CilFSize],ax
         mov       ax,word ptr ds:[FileFSiz+2] ; velikost souboru HIGH
         mov       word ptr ds:[CopyDSiz+2],ax ; zb˜vaj¡c¡ velikost LOW
         mov       word ptr ds:[CilFSize+2],ax
         and       byte ptr ds:[ExistPar],not bit0+bit6+bit7 ; nen¡ pokra‡ov n¡ dal¨¡m diskem
         mov       word ptr ds:[CopyDRea],0 ; ukazatel na‡ten˜ch dat
         mov       word ptr ds:[CopyDRea+2],0
         mov       ax,ds:[FileFDat]
         mov       ds:[CilFDate],ax
         mov       ax,ds:[FileFTim]
         mov       ds:[CilFTime],ax
         mov       al,ds:[FileFAtr]
         mov       ds:[CilFAtr],al

; ------ sestaven¡ c¡lov‚ho jm‚na souboru

         call      far ptr GetFCil          ; sestaven¡ jm‚na c¡lov‚ho souboru
         test      byte ptr ds:[CopyPrD2],bit5 ; m  c¡l dlouh‚ jm‚no ?
         jz        CopFl429                 ; c¡l nem  dlouh‚ jm‚no
         call      GetFLCil                 ; c¡l s dlouh˜m jm‚nem

; ------ test a normalizace c¡lov‚ho souboru

CopFl429:call      CopyTCil                 ; test c¡lov‚ho souboru
         jc        CopFl42A                 ; soubor nenalezen
         or        byte ptr ds:[ExistPar],bit0 ; soubor ji‘ existuje

; ------ zobrazen¡ hl ¨en¡ o kop¡rov n¡

CopFl42A:call      CopyHlas                 ; hl ¨en¡ o kop¡rov n¡

; ------ test, zda to je adres ©

         push      ds
         pop       es                       ; ES <- datov˜ segment
         test      byte ptr ds:[FileFAtr],DIR ; je to adres © ?
         jnz       CopyFl43                 ; je to adres ©
         jmp       CopyFil5                 ; nen¡ to adres ©

; ------ test, zda je adres © p©i n vratu

CopyFl43:test      byte ptr ds:[FileParm],bit3 ; je adres © p©i n vratu ?
         jz        CopyFl44                 ; nen¡ to adres © p©i n vratu
         test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jnz       CopFl433                 ; je kop¡rov n¡ - nic se nedˆje

; ------ p©i p©esunu se adres © p©i n vratu zru¨¡

         mov       si,offset FilePath       ; zdrojov˜ adres ©
         call      far ptr DelDir           ; zru¨en¡ adres ©e
         jnc       CopFl432                 ; operace OK
         jmp       CopyFl45                 ; adres © nebyl zru¨en

CopFl432:mov       di,offset FileFPol       ; polo‘ka adres ©e
         mov       dx,ds                    ; DX <- datov˜ segment
         mov       cx,ds:[FilePthN]         ; d‚lka textu adres ©e
         call      far ptr DelWFile         ; zru¨en¡ star‚ho jm‚na adres ©e
         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken
CopFl433:jmp       CopyFl47                 ; dal¨¡ polo‘ka

; ------ test, zda je p©ejmenov n¡ adres ©e ve stejn‚m adres ©i

CopyFl44:test      byte ptr ds:[CopyParD],bit7 ; je p©esun na disku ?
         jz        CopyFl46                 ; nen¡ p©esun na disku
         mov       si,offset FilePath       ; zdrojov‚ jm‚no
         mov       di,offset CilPath        ; c¡lov‚ jm‚no
         mov       cx,ds:[FilePthN]         ; d‚lka textu adres ©e
         cmp       cx,ds:[CilCilPN]         ; souhlas¡ adres © ?
         jne       CopyFl46                 ; nesouhlas¡ adres ©
         cld
         repe      cmpsb                    ; porovn n¡ adres ©–
         jne       CopyFl46                 ; adres © nesouhlas¡

; ------ p©ejmenov n¡ adres ©e na disku v jednom adres ©i

         mov       si,offset FilePath       ; zdrojov‚ jm‚no souboru

         test      byte ptr ds:[CopyPrD2],bit5 ; m  c¡l dlouh‚ jm‚no ?
         jz        CopFl445                 ; c¡l nem  dlouh‚ jm‚no

         mov       di,ss:[bp-10]            ; c¡lov‚ jm‚no
         mov       dx,ss                    ; DX <- segment c¡lov‚ho jm‚na
         call      far ptr RenXFile         ; p©ejmenov n¡ adres ©e
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         mov       dx,ds                    ; DX <- datov˜ segment
         jnc       CopFl446                 ; operace OK

CopFl445:mov       di,offset CilPath        ; c¡lov‚ jm‚no souboru
         mov       dx,ds                    ; DX <- datov˜ segment
         call      far ptr RenFile          ; p©ejmenov n¡ souboru
         jnc       CopFl446                 ; adres © p©ejmenov n OK

         or        byte ptr ds:[FileParm],bit5 ; z kaz vno©en¡ do adres ©e
         call      far ptr RenDErr          ; chyba p©ejmenov n¡ adres ©e
         jmp       CopyFil7

CopFl446:or        byte ptr ds:[FileParm],bit5 ; z kaz vno©en¡ do adres ©e
         mov       cx,ds:[FilePthN]         ; d‚lka textu adres ©e
         mov       di,offset FileFPol       ; vzor polo‘ky (zde je DX=DS !)
         call      far ptr DelWFile         ; zru¨en¡ star‚ho jm‚na adres ©e

         mov       si,offset CilPath        ; SI <- nov‚ jm‚no adres ©e
         mov       cx,ds:[CilCilPN]         ; d‚lka textu adres ©e
         mov       di,offset CilFPol        ; vzor polo‘ky (zde je DX=DS !)
         call      far ptr InsWFile         ; vytvo©en¡ polo‘ky v oknˆ

         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken
CopyFl45:jmp       CopyFl72                 ; dal¨¡ polo‘ka

; ------ test, zda je cyklick‚ kop¡rov n¡ adres ©e do sebe

CopyFl46:mov       si,offset FilePath       ; zdrojov‚ jm‚no
         mov       di,offset CilPath        ; c¡lov‚ jm‚no
         mov       cx,ds:[FileFilN]         ; d‚lka pln‚ho textu adres ©e
         cld
         repe      cmpsb                    ; porovn n¡ adres ©–
         jne       CopFl468                 ; adres © nesouhlas¡
         cmp       byte ptr ds:[di],"\"     ; je oddˆlova‡ ?
         jne       CopFl468                 ; nen¡ cyklicky
         or        byte ptr ds:[FileParm],bit5 ; z kaz vno©en¡ do adres ©e
         mov       si,offset FilePath       ; zdrojov‚ jm‚no souboru
         call      far ptr CopCErr          ; chyba cyklick‚ho kop¡rov n¡
         jmp       CopyFil7

; ------ je to adres © p©i vno©en¡ - vytvo©en¡ c¡lov‚ho adres ©e

CopFl468:mov       cx,ds:[FileFTim]         ; ‡as adres ©e
         mov       dx,ds:[FileFDat]         ; datum adres ©e
         mov       bl,ds:[FileFAtr]         ; atributy polo‘ky
         call      CopCreaD                 ; vytvo©en¡ adres ©e ES:SI
CopyFl47:jmp       CopyFil7                 ; dal¨¡ polo‘ka

; ------ test, zda se kop¡ruje soubor s m do sebe

CopyFil5:test      byte ptr ds:[ExistPar],bit0 ; soubor nalezen ?
         jz        CopyFl54                 ; c¡lov˜ soubor nenalezen
         mov       si,offset FilePath       ; zdrojov˜ soubor
         mov       di,offset CilPath        ; c¡lov˜ soubor
         mov       cx,ds:[FileFilN]         ; d‚lka adres ©e se souborem
         inc       cx                       ; v‡etnˆ koncov‚ 0
         cld
         push      si
         repe      cmpsb                    ; porovn n¡ jmen
         pop       si                       ; SI = zdrojov˜ soubor
         jne       CopyFl54                 ; je to OK
;         test      byte ptr ds:[CopyParD],bit7 ; je p©esun na disku ?
;         jz        CopyFl53                 ; nen¡ p©ejmenov n¡ souboru
;         jmp       CopFl662                 ; je p©ejmenov n¡ souboru

; ------ p©i p©esunu se nic nehl s¡

CopyFl53:test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jz        CopyFl45                 ; je p©esun - nic se nedˆje
         call      far ptr CopErEq          ; chybov‚ hl ¨en¡
         jmp       short CopyFl57           ; dal¨¡ soubor

; ------ rozli¨en¡ operace, pokud soubor ji‘ existuje

CopyFl54:call      CopyExis                 ; test, zda polo‘ka ji‘ existuje
         jnc       CopyFl58                 ; soubor se zapisuje
CopyFl57:jmp       CopyFil8                 ; polo‘ka se nep©episuje

; ------ pro znakov‚ za©¡zen¡ p©¡mo skok na kop¡rov n¡

CopyFl58:test      byte ptr ds:[ExistPar],bit6 ; je to znakov‚ za©¡zen¡ ?
         jz        CopyFl59                 ; nen¡ to znakov‚ za©¡zen¡
         jmp       CopyFl68                 ; obsluha znakov‚ho za©¡zen¡

; ------ test, zda m  b˜t odstranˆn atribut polo‘ky R/O

CopyFl59:test      byte ptr ds:[ExistPar],bit1+bit5 ; je p©epis/p©ipojen¡ souboru ?
         jz        CopyFil6                 ; nen¡ p©epis/p©ipojen˜ souboru
         test      byte ptr ds:[ExistPar],bit7 ; je dal¨¡ disk ?
         jnz       CopyFil6                 ; je dal¨¡ disk - p©ep¡¨e se v‘dy
         test      byte ptr ds:[CilDTA+DTAAtrib],RO ; je soubor R/O ?
         jz        CopyFil6                 ; nen¡ soubor R/O
         call      CopyRO                   ; test p©episu polo‘ek R/O
         jc        CopyFl57                 ; polo‘ka se nep©episuje

; ------ pro s¡Ÿov˜ disk se voln‚ m¡sto netestuje

CopyFil6:mov       bl,ds:[CilPath]          ; c¡lov˜ disk
         mov       bh,0
         mov       al,ds:[bx+DiskITab-"A"]  ; parametry disku
         and       al,bit0+bit1+bit2        ; typ tisku
         cmp       al,4                     ; je to s¡Ÿov˜ disk ?
         je        CopyFl64                 ; pro s¡Ÿov˜ disk se netestuje

; ------ test voln‚ho m¡sta na disku

         test      byte ptr ds:[ExistPar],bit7 ; je dal¨¡ disk ?
         jnz       CopyFl64                 ; je dal¨¡ disk - pokra‡uje bez dotazu
         test      byte ptr ds:[ExistPar],bit5 ; p©epis souboru ?
         jnz       CopyFl62                 ; je p©epis souboru
         test      byte ptr ds:[CopyParD],bit7 ; je p©esun na disku ?
         jnz       CopyFl64                 ; je p©esun na disku
CopyFl62:call      CopyFre                  ; test voln‚ho m¡sta disku
         jc        CopyFl57                 ; soubor se nekop¡ruje

; ------ odstranˆn¡ atributu R/O c¡lov‚ polo‘ky

CopyFl64:test      byte ptr ds:[ExistPar],bit0 ; nalezena polo‘ka ?
         jz        CopyFl66                 ; nenalezena polo‘ka
         test      byte ptr ds:[CilDTA+DTAAtrib],RO ; je soubor R/O ?
         jz        CopyFl66                 ; nen¡ soubor R/O

         mov       cl,ds:[CilDTA+DTAAtrib]
         and       cl,not RO                ; nulov n¡ atributu R/O
         mov       si,offset CilPath        ; c¡lov˜ soubor
         call      far ptr SetAFile         ; zru¨en¡ atributu R/O

; ------ p©esun souboru na disku

CopyFl66:test      byte ptr ds:[CopyParD],bit7 ; je p©esun na disku ?
         jz        CopyFl67                 ; nen¡ p©esun na disku
         test      byte ptr ds:[ExistPar],bit5 ; je p©ipojen¡ souboru ?
         jnz       CopyFl67                 ; je p©ipojen¡ souboru

; ------ zru¨en¡ p©esouvan‚ho souboru p©i p©episu na disku

         test      byte ptr ds:[ExistPar],bit1 ; je p©epis souboru ?
         jz        CopFl662                 ; nen¡ p©epis souboru
         call      CopyFDel                 ; zru¨en¡ p©episovan‚ho souboru
         jc        CopFl682                 ; chyba

; ------ p©ejmenov n¡ souboru na disku

CopFl662:call      CopF6Ren                 ; p©ejmenov n¡ souboru/adres ©e
         jnc       CopFl664                 ; soubor p©ejmenov n OK

; ------ vytvo©en¡ c¡lov‚ho adres ©e

         call      CopFCDir                 ; vytvo©en¡ c¡lov‚ho adres ©e

; ------ druh˜ pokus o p©ejmenov n¡ souboru na disku

         call      CopF6Ren                 ; p©ejmenov n¡ souboru/adres ©e
         jnc       CopFl664                 ; soubor p©ejmenov n OK

         call      far ptr CreatErr         ; chyba vytvo©en¡ souboru
         jmp       short CopFl682


CopFl664:mov       cx,ds:[FilePthN]         ; d‚lka textu adres ©e
         mov       di,offset FileFPol       ; vzor polo‘ky (zde je DX=DS !)
         call      far ptr DelWFile         ; zru¨en¡ star‚ho jm‚na souboru

         mov       si,offset CilPath        ; SI <- nov‚ jm‚no souboru
         mov       cx,ds:[CilCilPN]         ; d‚lka textu adres ©e
         mov       di,offset CilFPol        ; vzor polo‘ky (zde je DX=DS !)
         call      far ptr InsWFile         ; vytvo©en¡ polo‘ky v oknˆ

         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken
         jmp       CopyFl72

; ------ vytvo©en¡ p©echodn‚ho v˜stupn¡ho souboru, je-li p©epis souboru

CopyFl67:test      byte ptr ds:[ExistPar],bit1 ; je p©epis souboru ?
         jz        CopyFl68                 ; nen¡ p©epis souboru
         call      CopyFTmp                 ; vytvo©en¡ p©echodn‚ho souboru
         jnc       CopyFl68                 ; soubor vytvo©en OK
         call      far ptr TestBreak        ; je p©eru¨en¡ operace ?
         jc        CopFl682                 ; p©eru¨en¡ operace
         call      CopyFDel                 ; jinak zru¨en¡ p©episovan‚ho souboru
         jc        CopFl682                 ; chyba

; ------ otev©en¡ zdrojov‚ho souboru

CopyFl68:mov       si,offset FilePath       ; zdrojov˜ soubor
         call      far ptr OpenR            ; otev©en¡ pro ‡ten¡
         jnc       CopFl684                 ; soubor otev©en OK

; ------ chyba otev©en¡ zdrojov‚ho souboru

         call      far ptr OpenRErr         ; chyba otev©en¡ soubor
CopFl682:jmp       CopyFil8                 ; chyba

CopFl684:mov       ds:[FileIdnt],ax         ; identifik tor zdroje

; ------ otev©en¡ existuj¡c¡ho souboru pro z pis (p©i v¡ce disc¡ch m–‘e b˜t vytvo©en¡)

         test      byte ptr ds:[CopyParD],bit3 ; je p©echodn˜ soubor ?
         jz        CopFl685
         jmp       CopyFl73                 ; je ji‘ p©echodn˜ soubor

; ------ otev©en¡ s dlouh˜m jm‚nem

CopFl685:test      byte ptr ds:[CopyPrD2],bit5 ; m  c¡l dlouh‚ jm‚no ?
         jz        CopFl688                 ; nen¡ dlouh‚ jm‚no

         push      ss
         pop       es                       ; ES <- segment bufferu
         mov       si,ss:[bp-10]            ; c¡lov‚ jm‚no

         test      byte ptr ds:[ExistPar],bit5 ; je p©ipojen¡ souboru ?
         jz        CopFl686                 ; nen¡ p©ipojen¡ souboru
         call      far ptr OpenXRW          ; otev©en¡ s dlouh˜m jm‚nem
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         jnc       CopFl689                 ; soubor otev©en OK
CopFl686:call      far ptr CreaXFil         ; vytvo©en¡ s dlouh˜m jm‚nem
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         mov       si,offset CilPath        ; jm‚no v˜stupn¡ho souboru
         push      ds
         pop       es
         jnc       CopyFl6B                 ; soubor vytvo©en OK

; ------ otev©en¡ s kr tk˜m jm‚nem

CopFl688:mov       si,offset CilPath        ; jm‚no v˜stupn¡ho souboru
         test      byte ptr ds:[ExistPar],bit5 ; je p©ipojen¡ souboru ?
         jz        CopyFL69                 ; nen¡ p©ipojen¡ souboru
         call      far ptr OpenW            ; otev©en¡ pro z pis
         jc        CopyFL69                 ; chyba ? - mo‘n  je dal¨¡ disk
CopFl689:push      ds
         pop       es
         call      far ptr SizeFile         ; ukazatel na konec souboru
         jmp       short CopyFL6A

CopyFL69:call      far ptr CreatFil         ; vytvo©en¡ souboru
         jnc       CopyFl6B                 ; soubor vytvo©en OK

; ------ vytvo©en¡ c¡lov‚ho adres ©e

         call      CopFCDir                 ; vytvo©en¡ c¡lov‚ho adres ©e

; ------ druh˜ pokus o vytvo©en¡ souboru

         test      byte ptr ds:[CopyPrD2],bit5 ; m  c¡l dlouh‚ jm‚no ?
         jz        CopFl698                 ; nen¡ dlouh‚ jm‚no

         push      ss
         pop       es                       ; ES <- segment bufferu
         mov       si,ss:[bp-10]            ; c¡lov‚ jm‚no
         call      far ptr CreaXFil         ; vytvo©en¡ s dlouh˜m jm‚nem
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         mov       si,offset CilPath        ; jm‚no v˜stupn¡ho souboru
         push      ds
         pop       es
         jnc       CopyFl6B                 ; soubor vytvo©en OK

CopFl698:call      far ptr CreatFil
         jnc       CopyFl6B                 ; soubor vytvo©en OK

; ------ chyba - v˜stupn¡ soubor nelze vytvo©it

         call      far ptr CreatErr         ; chyba vytvo©en¡ souboru
         jmp       CopFl682           ; p©eru¨en¡ operace

CopyFl6B:or        byte ptr ds:[CopyParD],bit0 ; v˜stupn¡ soubor vytvo©en
CopyFL6A:mov       ds:[CilIdent],ax         ; identifik tor souboru
         test      byte ptr ds:[ExistPar],bit6 ; je to znakov‚ za©¡zen¡ ?
         jz        CopyFl73                 ; nen¡ to znakov‚ za©¡zen¡
         call      far ptr TestDev          ; nastaven¡ bin rn¡ho m¢du za©¡zen¡

; ------ zkop¡rov n¡ bloku dat (do konce souboru nebo do konce diskety)
;þ
CopyFl73:call      CopyCop                  ; zkop¡rov n¡ dat souboru

; ------ uzav©en¡ soubor– (CY=je chyba operace)

CopyFl77:call      CopyClos                 ; uzav©en¡ soubor–
         jc        CopyFil8                 ; p©i chybˆ dal¨¡ soubor

; ------ operace provedena OK

CopyFil7:test      byte ptr ds:[ExistPar],bit7 ; pokra‡uje se d l ?
         jz        CopyFl72                 ; nepokra‡uje se

; ------ v˜mˆna disku

         call      CopyFre0                 ; v˜mˆna disku
         jc        CopyFil8                 ; p©eru¨en¡ operace
         jmp       CopyFil5                 ; pokra‡ov n¡ v operaci

; ------ p©i p©esunu zru¨en¡ zdrojov‚ho souboru

CopyFl72:test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jnz       CopFl728                 ; je kop¡rov n¡
         test      byte ptr ds:[ExistPar],bit6 ; je to za©¡zen¡ ?
         jnz       CopFl728                 ; je to za©¡zen¡ -> neru¨it
         test      byte ptr ds:[ExistPar],bit5 ; je p©ipojen¡ souboru ?
         jnz       CopFl722                 ; je p©ipojen¡ souboru
         test      byte ptr ds:[CopyParD],bit7 ; je p©esun na disku ?
         jnz       CopFl728                 ; je p©esun na disku

CopFl722:push      ds
         pop       es
         mov       si,offset FilePath
         test      byte ptr ds:[FileFAtr],RO ; je R/O ?
         jz        CopFl724                 ; nen¡ R/O
         mov       cl,0
         call      far ptr SetAFile         ; zru¨en¡ atributu R/O
CopFl724:call      far ptr DelFile          ; zru¨en¡ zdrojov‚ho souboru
         jc        CopFl728

         mov       dx,ds                    ; DX <- datov˜ segment
         mov       di,offset FileFPol       ; ru¨en  polo‘ka
         mov       cx,ds:[FilePthN]         ; d‚lka textu adres ©e
         call      far ptr DelWFile
         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken

CopFl728:call      far ptr ResFFil          ; nulov n¡ ozna‡en¡ polo‘ky

;; ------ aktualizace oken (vytvo©en¡ c¡lov‚ polo‘ky)
;
;         push      ds
;         pop       es
;         mov       si,offset CilPath
;         mov       cx,ds:[CilCilPN]         ; d‚lka textu adres ©e
;         mov       di,offset FileFPol       ; vzor polo‘ky
;         mov       dx,ds                    ; DX <- segment vzoru polo‘ky
;         call      far ptr InsWFile         ; vytvo©en¡ polo‘ky v oknˆ
;         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken
;
;; ------ oprava voln‚ho m¡sta na disku
;
;         mov       ax,word ptr ds:[CopyDUlo] ; ukazatel ulo‘en˜ch dat
;         mov       dx,word ptr ds:[CopyDUlo+2]
;         mov       cx,ds:[CopyDBlk]         ; velikost bloku
;         dec       cx
;         add       ax,cx                    ; zaokrouhlen¡ nahoru
;         adc       dx,0
;         inc       cx
;         cmp       dx,cx
;         jae       CopyFil8
;         div       cx                       ; DX <- zbytek v bloku
;         sub       cx,dx                    ; CX <- nevyu‘it  data v bloku
;         xor       ax,ax
;         sub       word ptr ds:[CopyDFre],cx ; oprava voln‚ho m¡sta
;         sbb       word ptr ds:[CopyDFre+2],ax
;         jnc       CopyFil8
;         mov       word ptr ds:[CopyDFre],ax
;         mov       word ptr ds:[CopyDFre+2],ax

; ------ zru¨en¡ p©echodn‚ho souboru (p©i p©eru¨en¡ operace)

CopyFil8:mov       ax,ds:[FileIdnt]         ; identifik tor vstupn¡ho souboru
         call      far ptr ClosFile         ; uzav©en¡ souboru
         mov       ds:[FileIdnt],ax         ; p©¡znak uzav©en¡ souboru

         test      byte ptr ds:[CopyParD],bit3 ; je dosud p©echodn˜ soubor ?
         jz        CopyFl84                 ; nen¡ ji‘ p©echodn˜ sobor
         call      far ptr ZapKrit          ; zapnut¡ kritick‚ho re‘imu
         mov       ax,ds:[CilIdent]         ; identifik tor p©echodn‚ho souboru
         call      far ptr ClosFile         ; uzav©en¡ souboru
         mov       ds:[CilIdent],ax         ; zru¨en¡ identifik toru
         push      ds
         pop       es
         mov       si,offset CilTempF       ; p©echodn˜ c¡lov˜ soubor
         call      far ptr DelFile          ; zru¨en¡ p©echodn‚ho souboru
         and       byte ptr ds:[CopyParD],not bit3 ; nen¡ ji‘ p©echodn˜ soubor
         call      far ptr VypKrit          ; vypnut¡ kritick‚ sekce

; ------ p©¡prava pro dal¨¡ polo‘ku

CopyFl84:call      far ptr TestBEsc         ; je p©eru¨en¡ operace ?
         jc        CopyFil9                 ; p©eru¨en¡
         jmp       CopyFil4                 ; pokra‡ov n¡ operace

; ------ uzav©en¡ re‘imu kop¡rov n¡ (se zru¨en¡m lok ln¡ho bufferu)

CopyFil9:jmp       CopyFil0

; ------ p©ejmenov n¡ jednoho souboru/adres ©e na disku

CopF6Ren PROC      NEAR

         mov       si,offset FilePath       ; zdrojov‚ jm‚no souboru

         test      byte ptr ds:[CopyPrD2],bit5 ; m  c¡l dlouh‚ jm‚no ?
         jz        CopF6Rn2                 ; c¡l nem  dlouh‚ jm‚no

         mov       dx,ss                    ; DX <- segment c¡lov‚ho jm‚na
         mov       di,ss:[bp-10]            ; c¡lov‚ jm‚no
         call      far ptr RenXFile         ; p©ejmenov n¡ adres ©e
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         mov       dx,ds                    ; DX <- datov˜ segment
         jnc       CopF6Rn4                 ; operace OK

CopF6Rn2:mov       di,offset CilPath        ; c¡lov‚ jm‚no souboru
         mov       dx,ds
         call      far ptr RenFile          ; p©ejmenov n¡ souboru
CopF6Rn4:ret

CopF6Ren ENDP

; ------ vytvo©en¡ c¡lov‚ho adres ©e pro soubor

CopFCDir PROC      NEAR

         mov       di,offset CilPath        ; jm‚no v˜stupn¡ho souboru
         mov       si,di
         add       di,ds:[CilCilPN]         ; adresa konce cesty
         mov       bl,ds:[di]               ; £schova znaku
         mov       byte ptr ds:[di],0       ; ozna‡en¡ konce cesty
         mov       cl,0                     ; atributy nov‚ho adres ©e
         call      far ptr CreaLDir         ; vytvo©en¡ dlouh‚ho adres ©e
         mov       ds:[di],bl               ; n vrat znaku
         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken
         ret

CopFCDir ENDP

; -----------------------------------------------------------------------------
;        p©ep¡na‡ Aktualizace
; -----------------------------------------------------------------------------

SKMnLExA PROC      FAR

         xor       byte ptr ds:[CopyPrD2],bit0 ; zmˆna p©ep¡na‡e
         jmp       short SKMnLEK2

SKMnLExA ENDP

; -----------------------------------------------------------------------------
;        p©ep¡na‡ Kr tk  jm‚na
; -----------------------------------------------------------------------------

SKMnLExK PROC      FAR

         xor       byte ptr ds:[CopyPrD2],bit1 ; zmˆna p©ep¡na‡e
SKMnLEK2:call      CopyFPrp                 ; p©¡prava p©ep¡na‡–
         call      far ptr DispMnu          ; nov‚ zobrazen¡ menu
         ret

SKMnLExK ENDP

; -----------------------------------------------------------------------------
;        p©ep¡na‡ Datum
; -----------------------------------------------------------------------------

SKMnLExD PROC      FAR

         xor       byte ptr ds:[CopyPrD2],bit2 ; zmˆna p©ep¡na‡e
         jmp       short SKMnLEK2

SKMnLExD ENDP

; -----------------------------------------------------------------------------
;        p©¡prava p©ep¡na‡– menu volby c¡le operace DS:SI
; -----------------------------------------------------------------------------

CopyFPrp PROC      NEAR

         push      ax
         push      dx

         mov       dl,ds:[CopyPrD2]         ; p©ep¡na‡ dlouh˜ch jmen
         and       byte ptr ds:[SK1MLBlk+3],not bit1 ; operace povolena
         and       byte ptr ds:[SJ1MLBlk+3],not bit1

         test      byte ptr ds:[Win95Par],bit2 ; povoleno ?
         jz        CopyFPr2                 ; povoleno
         or        byte ptr ds:[SK1MLBlk+3],bit1 ; z kaz
         or        byte ptr ds:[SJ1MLBlk+3],bit1 ; z kaz
         or        dl,bit1                  ; kr tk  jm‚na ano

CopyFPr2:call      far ptr SetSwch          ; nastaven¡ p©ep¡na‡–

         mov       al,ds:[ZnakSwch]         ; zapnut
         test      dl,bit0                  ; aktualizace ?
         jnz       CopyFPr3                 ; p©ep¡na‡ zapnut
         mov       al,ds:[ZnakSwch+1]       ; vypnuto
CopyFPr3:mov       ds:[SJ1MLPl0],al         ; znak p©ep¡na‡e
         mov       ds:[SK1MLPl0],al         ; znak p©ep¡na‡e

         mov       al,ds:[ZnakSwch]         ; zapnut
         test      dl,bit1                  ; kr tk  jm‚na ?
         jnz       CopyFPr4                 ; p©ep¡na‡ zapnut
         mov       al,ds:[ZnakSwch+1]       ; vypnuto
CopyFPr4:mov       ds:[SJ1MLPl1],al         ; znak p©ep¡na‡e
         mov       ds:[SK1MLPl1],al         ; znak p©ep¡na‡e

         mov       al,ds:[ZnakSwch]         ; zapnut
         test      dl,bit2                  ; datum ?
         jnz       CopyFPr6                 ; p©ep¡na‡ zapnut
         mov       al,ds:[ZnakSwch+1]       ; vypnuto
CopyFPr6:mov       ds:[SJ1MLPl2],al         ; znak p©ep¡na‡e
         mov       ds:[SK1MLPl2],al         ; znak p©ep¡na‡e

         pop       dx
         pop       ax
         ret

CopyFPrp ENDP

; -----------------------------------------------------------------------------
;        £schova dlouh‚ho jm‚na souboru do bufferu
; -----------------------------------------------------------------------------

CopFUsch PROC      NEAR

; ------ £schova registr–

         push      ax
         push      cx
         push      si
         push      di
         push      es

; ------ £schova typu okna -> AL

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         mov       al,es:[AWinPrm1]         ; typ okna

; ------ adresa polo‘ky pod kurzorem -> ES:SI

         call      far ptr GetAKurz         ; poskytnut¡ adresy kurzoru
         jc        CopFUsc9                 ; nen¡ kurzor (?)

; ------ test, zda je dlouh‚ jm‚no

         mov       di,ss:[bp-6]             ; adresa dlouh‚ho jm‚na
         test      al,bit3                  ; je to adres ©ov‚ okno ?
         jz        CopFUsc4                 ; nen¡ to adres ©ov‚ okno
         mov       al,es:[si+FileLong]      ; d‚lka dlouh‚ho jm‚na
         or        al,al                    ; je dlouh‚ jm‚no ?
         jz        CopFUsc4                 ; nen¡ dlouh‚ jm‚no

; ------ £schova dlouh‚ho jm‚na

         mov       ah,0                     ; AX = d‚lka dlouh‚ho jm‚na
         push      ds
         xchg      ax,cx                    ; CX <- d‚lka dlouh‚ho jm‚na
         add       si,FileLong+1            ; za‡ tek dlouh‚ho jm‚na
         cld
         push      es
         pop       ds                       ; DS <- segment jm‚na
         push      ss
         pop       es                       ; ES <- segment z sobn¡ku
         rep       movsb                    ; £schova jm‚na souboru
         mov       al,0
         stosb                              ; koncov  0
         pop       ds
         jmp       short CopFUsc8

; ------ test, zda se m  kr tk‚ jm‚no prodlou‘it

CopFUsc4:test      byte ptr ds:[CopyPrD2],bit1 ; je zmˆna na dlouh  jm‚na ?
         jnz       CopFUsc9                 ; nen¡ zmˆna na dlouh  jm‚na

; ------ dek¢dov n¡ kr tk‚ho jm‚na soubor do z sobn¡ku

         push      ds
         push      es
         pop       ds                       ; DS <- segment polo‘ky
         push      ss
         pop       es                       ; ES <- segment bufferu
         inc       si                       ; za‡ tek jm‚na polo‘ky
         call      far ptr FileAsc          ; dek¢dov n¡ jm‚na polo‘ky
         pop       ds

;; ------ korekce jm‚na souboru (prvn¡ p¡smeno velk‚, ostatn¡ mal )
;
;         cld
;         mov       si,ss:[bp-6]             ; adresa jm‚na souboru
;         lods      byte ptr ss:[si]         ; na‡ten¡ prvn¡ho znaku
;         call      far ptr UpCase           ; konverze na velk‚ p¡smeno
;         jmp       short CopFUsc7           ; ulo‘en¡ znaku
;
;CopFUsc5:lods      byte ptr ss:[si]         ; na‡ten¡ znaku
;;         call      far ptr DownCase         ; konverze na mal‚ p¡smeno
;
;         call      far ptr UpCase           ; konverze na velk‚ p¡smeno
;
;CopFUsc7:mov       ss:[si-1],al             ; ulo‘en¡ znaku
;         cmp       al,0                     ; je konec textu ?
;         jne       CopFUsc5                 ; dal¨¡ znak

; ------ p©¡znak, ‘e bude dlouh‚ jm‚no

CopFUsc8:or        byte ptr ds:[CopyPrD2],bit5 ; c¡l m  dlouh‚ jm‚no

; ------ n vrat registr–

CopFUsc9:pop       es
         pop       di
         pop       si
         pop       cx
         pop       ax
         ret

CopFUsch ENDP

; -----------------------------------------------------------------------------
;        p©¡prava dlouh‚ho jm‚na c¡le operace
; -----------------------------------------------------------------------------
;þ
GetFLCil PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ kopie c¡lov‚ cesty do bufferu

         mov       di,ss:[bp-10]            ; adresa c¡lov‚ho jm‚na
         push      ss
         pop       es                       ; ES <- segment bufferu
         mov       si,offset CilPath        ; c¡lov  cesta
         mov       cx,ds:[CilCilPN]         ; d‚lka bez souboru
         cld
         rep       movsb                    ; p©enos cesty

; ------ zaji¨tˆn¡ oddˆlova‡e adres ©e "\"

         dec       di
         mov       al,"\"
         scasb                              ; je oddˆlova‡ adres ©e ?
         je        GetFLCl2                 ; je oddˆlova‡ adres ©e
         stosb                              ; ulo‘en¡ oddˆlova‡e adres ©e

; ------ test, zda bude maska

GetFLCl2:mov       si,ss:[bp-6]             ; adresa dlouh‚ho jm‚na
         mov       bx,ss:[bp-2]             ; adresa masky dlouh‚ho jm‚na
         test      byte ptr ds:[CopyPrD2],bit6 ; maska se neuplatn¡ ?
         jnz       GetFLCl3                 ; dlouh  maska se neuplatn¡
         cmp       byte ptr ss:[bx],0       ; je maska ?
         jne       GetFLCl4                 ; je maska

; ------ p©enos dlouh‚ho jm‚na, nen¡-li maskov n¡

GetFLCl3:lods      byte ptr ss:[si]         ; na‡ten¡ znaku
         cmp       al,":"                   ; je oddˆlova‡ za©¡zen¡ ?
         je        GetFLCl3                 ; oddˆlova‡ za©¡zen¡ se ignoruje
         stosb
         cmp       al,0
         jne       GetFLCl3
         jmp       short GetFLCl9

; ------ p©enos dlouh‚ho jm‚na s maskov n¡m

GetFLCl4:xchg      si,bx                    ; SI <- maska, BX <- jm‚no
GetFLC42:lods      byte ptr ss:[si]         ; na‡ten¡ znaku masky
         mov       ah,ss:[bx]               ; na‡ten¡ znaku jm‚na
         inc       bx                       ; zv˜¨en¡ ukazatele jm‚na

         cmp       al,ah                    ; jsou znaky shodn‚ ?
         je        GetFLCl7                 ; znaky jsou shodn‚ - nic nemˆnit
         or        al,al                    ; konec masky ?
         jz        GetFLCl7                 ; konec masky plat¡

         or        ah,ah                    ; je konec jm‚na ?
         jz        GetFLC43                 ; ponech  se na konci
         cmp       ah,"."                   ; bude te‡ka jm‚na ?
         jne       GetFLC44                 ; nen¡ te‡ka jm‚na
GetFLC43:dec       bx                       ; te‡ka nebo konec se podr‘¡

GetFLC44:cmp       al,"*"                   ; n hradn¡ znak ?
         jne       GetFLC45                 ; nen¡ n hradn¡ znak
         cmp       ah,"."                   ; konec jm‚na ?
         je        GetFLC42                 ; konec jm‚na - dal¨¡ znak
         or        ah,ah                    ; konec jm‚na ?
         jz        GetFLC42                 ; konec jm‚na - dal¨¡ znak
         dec       si                       ; n hradn¡ znak se ponech 
         mov       al,"?"                   ; n hrada

GetFLC45:cmp       al,"."
         jne       GetFLCl5
         dec       bx
GetFLC46:inc       bx
         cmp       byte ptr ss:[bx],0
         je        GetFLCl7
         cmp       byte ptr ss:[bx],al
         jne       GetFLC46                 ; nalezen¡ te‡ky nebo konce jm‚na
         inc       bx                       ; p©esko‡en¡ znaku te‡ky

GetFLCl5:cmp       al,"?"                   ; n hradn¡ znak ?
         jne       GetFLCl7                 ; plat¡ znak masky

GetFLCl6:xchg      al,ah                    ; AL <- platn˜ znak jm‚na
GetFLCl7:stosb                              ; ulo‘en¡ znaku
         cmp       al,0                     ; konec ?
         jne       GetFLC42                 ; dal¨¡ znak

; ------ n vrat registr–

GetFLCl9:pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

GetFLCil ENDP

; -----------------------------------------------------------------------------
;        korekce dlouh‚ho c¡lov‚ho jm‚na (CY=byla chyba), uchov v  p©¡znaky
; -----------------------------------------------------------------------------

KorFCil  PROC      NEAR

         pushf
         jc        KorFCil9                 ; byla chyba operace
         test      byte ptr ds:[CopyPrD2],bit5 ; je dlouh‚ jm‚no ?
         jz        KorFCil9                 ; nen¡ dlouh‚ jm‚no
         call      CopyTCil                 ; test c¡lov‚ho souboru
KorFCil9:popf
         ret

KorFCil  ENDP

; -----------------------------------------------------------------------------
;        vytvo©en¡ p©echodn‚ho v˜stupn¡ho souboru (CY=nelze vytvo©it)
; -----------------------------------------------------------------------------

CopyFTmp PROC      NEAR

; ------ kopie c¡lov‚ho adres ©e do bufferu

         mov       si,offset CilPath        ; buffer c¡lov‚ho adres ©e
         mov       cx,FileMax-10            ; max. d‚lka c¡l. adres ©e+soubor
         mov       di,offset CilTempF       ; buffer adres ©e
         push      ds
         pop       es                       ; ES <- datov˜ segment
         cld
         push      di
         rep       movsb                    ; £schova c¡lov‚ho adres ©e
         pop       si                       ; SI = buffer adres ©e

; ------ vytvo©en¡ p©echodn‚ho souboru

         call      far ptr CreatPF          ; vytvo©en¡ p©echodn‚ho souboru
         jc        CopyFTm9                 ; soubor nelze vytvo©it
         mov       ds:[CilIdent],ax         ; identifik tor c¡lov‚ho souboru
         or        byte ptr ds:[CopyParD],bit3 ; p©¡znak p©echodn‚ho souboru
CopyFTm9:ret

CopyFTmp ENDP

; -----------------------------------------------------------------------------
;        uzav©en¡ soubor– p©i kop¡rov n¡ (VSTUP: CY=byla chyba operace)
; -----------------------------------------------------------------------------
;þ
CopyClos PROC      NEAR

         pushf

; ------ zru¨en¡ v˜stupn¡ho souboru a nahrazen¡ p©echodn˜m souborem

         jc        CopyCls1                 ; p©i chybˆ se neru¨¡
         test      byte ptr ds:[CopyParD],bit3 ; je p©echodn˜ soubor ?
         jz        CopyCls1                 ; nen¡ p©echodn˜ soubor
         call      CopyFDel                 ; zru¨en¡ v˜stupn¡ho souboru
         popf
         pushf                              ; CY = chyba

; ------ uzav©en¡ zdrojov‚ho souboru

CopyCls1:mov       ax,ds:[FileIdnt]
         call      far ptr ClosFile         ; uzav©en¡ souboru
         mov       ds:[FileIdnt],ax

; ------ nastaven¡ data a ‡asu v˜stupn¡ho souboru

         mov       ax,ds:[CilIdent]         ; identifik tor v˜stupn¡ho souboru
         or        ax,ax                    ; je v˜stupn¡ soubor otev©en ?
         jz        CopyCls2                 ; v˜stupn¡ soubor nen¡ otev©en

         mov       cx,ds:[FileFTim]         ; ‡as
         and       cx,ds:[ModiTimM]         ; nulov n¡ ‡asu
         or        cx,ds:[ModiTim]          ; nastaven¡ po‘adovan‚ho ‡asu
         mov       dx,ds:[FileFDat]         ; datum
         and       dx,ds:[ModiDatM]         ; nulov n¡ data
         or        dx,ds:[ModiDat]          ; nastaven¡ po‘adovan‚ho data
         call      far ptr SetDFile         ; nastaven¡ data a ‡asu

; ------ uzav©en¡ c¡lov‚ho souboru

         call      far ptr ClosFile         ; uzav©en¡ souboru
         mov       ds:[CilIdent],ax         ; soubor nen¡ otev©en

; ------ nastaven¡ atribut– c¡lov‚ho souboru

CopyCls2:push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset CilPath        ; jm‚no v˜stupn¡ho souboru
         mov       cl,ds:[FileFAtr]         ; atributy
         and       cl,ds:[ModiAtrM]         ; nulov n¡ nastavovan˜ch atribut–
         or        cl,ds:[ModiAtr]          ; nastaven¡ po‘adovan˜ch atribut–
         call      far ptr SetAFile         ; nastaven¡ atribut–

; ------ p©i chybˆ zru¨en¡ v˜stupn¡ho souboru (a tak‚ p©i z pisu 0 bajt–)

CopyCls3:popf
         jc        CopyCl32                 ; chyba
         mov       ax,word ptr ds:[CopyDUlo]
         or        ax,word ptr ds:[CopyDUlo+2] ; byla ulo‘ena nˆjak  data ?
         jnz       CopyCls5                 ; byla nˆjak  data

         mov       ax,word ptr ds:[CopyDSiz]
         or        ax,word ptr ds:[CopyDSiz+2] ; zb˜vaj¡ nˆjak  data ?
         jz        CopyCls5                 ; nezb˜vaj¡ ‘ dn  data

CopyCl32:pushf
         test      byte ptr ds:[CopyParD],bit0 ; byl soubor vytvo©en ?
         jz        CopyCls4                 ; nebyl vytvo©en
         call      far ptr ZapKrit          ; zapnut¡ kritick‚ho re‘imu
         mov       si,offset CilPath        ; jm‚no v˜stupn¡ho souboru
         call      far ptr DelFile          ; zru¨en¡ v˜stupn¡ho souboru
         call      far ptr VypKrit          ; vypnut¡ kritick‚ho re‘imu
CopyCls4:popf

; ------ aktualizace vytvo©en‚ho souboru

CopyCls5:jc        CopyCls6                 ; byla chyba

         push      ds
         pop       es
         mov       si,offset FileFPol
         mov       di,offset CilFPol
         mov       cx,offset(CilFPol0-CilFPol)
         cld
         rep       movsb
         mov       ax,word ptr ds:[CopyDUlo] ; ulo‘en  data
         mov       word ptr ds:[CilFSize],ax
         mov       ax,word ptr ds:[CopyDUlo+2]
         mov       word ptr ds:[CilFSize+2],ax

         mov       si,offset CilPath
         mov       cx,ds:[CilCilPN]         ; d‚lka textu adres ©e
         mov       di,offset CilFPol        ; vzor polo‘ky
         mov       dx,ds                    ; DX <- segment vzoru polo‘ky
         call      far ptr InsWFile         ; vytvo©en¡ polo‘ky v oknˆ
         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken

         clc
CopyCls6:ret

CopyClos ENDP

; -----------------------------------------------------------------------------
;        zkop¡rov n¡ ‡ sti dat (do konce souboru nebo do konce diskety) CY=chyba
; -----------------------------------------------------------------------------
;þ
CopyCop  PROC      NEAR

; ------ p©¡prava ukazatel–

         mov       bx,-1                    ; zat¡m bez omezen¡ velikosti bloku
         and       byte ptr ds:[ExistPar],not bit7 ; nen¡ dal¨¡ disk
         mov       word ptr ds:[CopyDUlo],0 ; ‡¡ta‡ ulo‘en˜ch dat
         mov       word ptr ds:[CopyDUlo+2],0

; ------ na‡ten¡ bloku dat ze souboru (omezen¡ BX bajt–) -> CX bajt–, adresa ES

CopyCop1:call      CopC0Rea                 ; na‡ten¡ bloku dat ze souboru
         jc        CopyCp59                 ; chyba - dal¨¡ soubor
         jcxz      CopyCp59                 ; konec souboru (je NC=operace OK)
         mov       dx,cx                    ; DX <- £schova po‡tu na‡ten˜ch bajt–

; ------ z pis DX bajt– dat (buffer ES) do v˜stupn¡ho souboru (omezen¡ BX)

CopyCop2:mov       cx,bx                    ; CX <- velikost bloku dat
CopyCp22:cmp       cx,dx                    ; bylo na‡teno dost dat ?
         jbe       CopyCop3                 ; bylo na‡teno dost dat
         mov       cx,dx                    ; omezen  velikost dat
CopyCop3:mov       ax,ds:[CilIdent]         ; identifik tor v˜stupn¡ho souboru
         xor       si,si                    ; offset po‡ tku dat
         call      far ptr TestBreak        ; je p©eru¨en¡ operace ?
         jc        CopyCp59                 ; je p©eru¨en¡ operace
         call      far ptr WritFile         ; z pis dat do souboru
                                          ;* (pozor, p©i pln‚m disku je tak‚ CY)
; ------ zmen¨en¡ omezen¡ velikosti bloku, je-li konec disku

         cmp       bh,-1                    ; je ji‘ omezen¡ bloku ?
         jne       CopyCop4                 ; je ji‘ omezen¡ bloku
         cmp       bl,-2                    ; byl ukl d n zbytek do bloku ?
         jne       CopyCop5                 ; nebyl zbytek do konce bloku
         mov       bx,8000h                 ; p©¡¨t¡ omezen¡
         jmp       short CopyCop5

CopyCop4:shr       bx,1                     ; zmen¨en¡ omezen¡ bloku
         cmp       bx,64                    ; minim ln¡ velikost bloku
         jae       CopyCop5                 ; velikost bloku je OK
         mov       bl,64                    ; minim ln¡ velikost bloku

; ------ kontrola, zda bylo nˆco ulo‘eno

CopyCop5:or        cx,cx                    ; bylo nˆco ulo‘eno ?
         jnz       CopyCop7                 ; bylo nˆco ulo‘eno

; ------ zru¨en¡ p©episovan‚ho souboru, je-li m lo m¡sta

         test      byte ptr ds:[CopyParD],bit3 ; je p©echodn˜ soubor ?
         jz        CopyCop6                 ; nen¡ p©echodn˜ soubor
         test      byte ptr ds:[ExistPar],bit0 ; existuje soubor ?
         jz        CopyCop6                 ; soubor neexistuje
         test      byte ptr ds:[CopyParD],bit2 ; byl soubor ji‘ zru¨en ?
         jnz       CopyCop6                 ; soubor ji‘ byl zru¨en
         call      CopyFDel                 ; zru¨en¡ p©episovan‚ho souboru
         jnc       CopyCop2                 ; opakov n¡ z pisu
CopyCp59:jmp       short CopyCop9           ; chyba

; ------ kontrola, zda byl ji‘ zkou¨en minim ln¡ blok

CopyCop6:cmp       bx,64                    ; byl ji‘ minim ln¡ blok ?
         jbe       CopyCop8                 ; ji‘ se nic neulo‘¡ - konec disku

; ------ kontrola, zda je ji‘ omezen¡ velikosti dat

         cmp       bx,-1                    ; je ji‘ omezen¡ velikosti dat ?
         jne       CopyCop2                 ; je ji‘ omezen¡ velikosti dat

; ------ v˜po‡et zbytku do aloka‡n¡ho bloku -> CX

         call      CopC0Zby                 ; po‡et bajt– do konce bloku -> CX
         dec       bx                       ; -2 = p©¡znak ulo‘en¡ zbytku
         jmp       short CopyCp22

; ------ posun ukazatel– o CX ulo‘en˜ch bajt–

CopyCop7:call      CopC0Inc                 ; posun ukazatel–
         jmp       short CopyCop1           ; dal¨¡ blok dat

; ------ na disk se ji‘ nic nevejde

CopyCop8:mov       word ptr ds:[CopyDFre],0 ; nen¡ m¡sto na disku
         mov       word ptr ds:[CopyDFre+2],0
         mov       word ptr ds:[CopyDFr0],0 ; voln‚ m¡sto bez p©epis. souboru
         mov       word ptr ds:[CopyDFr0+2],0
         or        byte ptr ds:[ExistPar],bit7 ; p©¡znak dal¨¡ho disku
                                          ;* zde je NC !
CopyCop9:ret

CopyCop  ENDP

; ------ zbytek po‡tu bajt– do konce alok.bloku (DX=bajt– v bufferu) -> CX <> 0

CopC0Zby:push      dx
         mov       ax,word ptr ds:[CopyDUlo] ; ‡¡ta‡ ulo‘en˜ch dat na disk
         mov       dx,word ptr ds:[CopyDUlo+2]
         mov       cx,ds:[CopyDBlk]         ; velikost bloku disku
         cmp       dx,cx                    ; bylo by p©ete‡en¡ ?
         jae       CopC0Zb2                 ; bylo by p©ete‡en¡
         div       cx                       ; v˜po‡et ‡ sti v bloku
         sub       cx,dx                    ; CX = zbytek do bloku (1...)
CopC0Zb2:pop       dx
         ret

; -----------------------------------------------------------------------------
;        na‡ten¡ bloku dat ze souboru (omezen¡ BX) -> CX=po‡et bajt–, CY=chyba
; -----------------------------------------------------------------------------

CopC0Rea PROC      NEAR

; ------ nastaven¡ ukazatele ve zdrojov‚m souboru

         mov       ax,ds:[FileIdnt]         ; zdrojov˜ soubor
         mov       cx,word ptr ds:[CopyDRea] ; ukazatel na‡ten˜ch dat
         mov       dx,word ptr ds:[CopyDRea+2]
         call      far ptr SetUFile         ; nastaven¡ ukazatele v souboru
         jnc       CopC0Re5                 ; operace OK

; ------ chyba ‡ten¡ ze souboru

CopC0Re2:mov       si,offset FilePath       ; jm‚no souboru
         push      ds
         pop       es                       ; ES <- segment jm‚na souboru
         call      far ptr ReadErr          ; chyba ‡ten¡ ze souboru
         stc                                ; p©¡znak dal¨¡ho souboru
         jmp       short CopC0Re9           ; dal¨¡ soubor

; ------ na‡ten¡ bloku dat ze zdrojov‚ho souboru AX (omezen¡ na BX bajt–)

CopC0Re5:call      far ptr GetBuff          ; adresa bufferu -> ES
         jc        CopC0Re9                 ; chyba pamˆti
         mov       cx,ds:[BuffSize]         ; velikost bufferu

         test      byte ptr ds:[ExistPar],bit6 ; je to znakov‚ za©¡zen¡ ?
         jz        CopC0Re6                 ; nen¡ to znakov‚ za©¡zen¡
         or        ch,ch                    ; asi tak omezen¡ velikosti bloku
         jz        CopC0Re6                 ; je to OK
         mov       ch,1                     ; asi tak omezen¡ velikosti dat
CopC0Re6:cmp       cx,bx                    ; je pot©eba omezit ?
         jbe       CopC0Re8                 ; nen¡ pot©eba omezit
         mov       cx,bx                    ; omezen¡ velikosti bloku
CopC0Re8:xor       di,di                    ; offset za‡ tku bufferu
         call      far ptr ReadFile         ; ‡ten¡ ze souboru
         jc        CopC0Re2                 ; chyba ‡ten¡

CopC0Re9:ret

CopC0Rea ENDP

; -----------------------------------------------------------------------------
;        posun ukazatel– o CX ulo‘en˜ch bajt–
; -----------------------------------------------------------------------------

CopC0Inc PROC      NEAR

         xor       ax,ax                    ; AX <- 0

; ------ ‡¡ta‡ ulo‘en˜ch dat na 1 disk

         add       word ptr ds:[CopyDUlo],cx ; ‡¡ta‡ ulo‘en˜ch dat
         adc       word ptr ds:[CopyDUlo+2],ax

; ------ ‡¡ta‡ na‡ten˜ch (a ulo‘en˜ch) dat ze souboru

         add       word ptr ds:[CopyDRea],cx ; ukazatel na‡ten˜ch dat
         adc       word ptr ds:[CopyDRea+2],ax

; ------ ‡¡ta‡ voln‚ho m¡sta na c¡lov‚m disku

         sub       word ptr ds:[CopyDFre],cx ; sn¡‘en¡ voln‚ho m¡sta disku
         sbb       word ptr ds:[CopyDFre+2],ax
         jnc       CopC0In2
         mov       word ptr ds:[CopyDFre],ax
         mov       word ptr ds:[CopyDFre+2],ax

; ------ ‡¡ta‡ voln‚ho m¡sta na c¡lov‚m disku bez p©episovan‚ho souboru

CopC0In2:sub       word ptr ds:[CopyDFr0],cx ; sn¡‘en¡ voln‚ho m¡sta bez souboru
         sbb       word ptr ds:[CopyDFr0+2],ax
         jnc       CopC0In4
         mov       word ptr ds:[CopyDFr0],ax
         mov       word ptr ds:[CopyDFr0+2],ax

; ------ ‡¡ta‡ zb˜vaj¡c¡ velikosti souboru ke zkop¡rov n¡

CopC0In4:sub       word ptr ds:[CopyDSiz],cx ; sn¡‘en¡ zb˜vaj¡c¡ velikosti souboru
         sbb       word ptr ds:[CopyDSiz+2],ax
         jnc       CopC0In6
         mov       word ptr ds:[CopyDSiz],ax
         mov       word ptr ds:[CopyDSiz+2],ax

; ------ posun indik toru operace

CopC0In6:call      far ptr InfoKurz         ; posun kurzoru operace
         ret

CopC0Inc ENDP

; -----------------------------------------------------------------------------
;        zru¨en¡ p©episovan‚ho souboru -> CY=chyba, bude dal¨¡ soubor
; -----------------------------------------------------------------------------

CopyFDel PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ test, zda je soubor ji‘ zru¨en

         test      byte ptr ds:[ExistPar],bit0 ; existuje soubor ?
         jz        CopyFDl2                 ; soubor neexistuje
         test      byte ptr ds:[CopyParD],bit2 ; byl soubor ji‘ zru¨en ?
         jnz       CopyFDl2                 ; soubor ji‘ byl zru¨en

; ------ zru¨en¡ v˜stupn¡ho souboru

         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset CilPath        ; c¡lov˜ soubor
         call      far ptr DelFile          ; zru¨en¡ souboru
         jnc       CopyFDl4                 ; soubor zru¨en OK

; ------ chyba - v˜stupn¡ soubor nelze zru¨it

         call      far ptr CopDErPr         ; chyba - soubor nelze zru¨it
         stc                                ; bude dal¨¡ soubor
CopyFDl2:jmp       short CopyFDl9

; ------ aktualizace po zru¨en¡ c¡lov‚ho souboru

CopyFDl4:or        byte ptr ds:[CopyParD],bit2 ; p©¡znak zru¨en¡ souboru
         mov       cx,ds:[CilCilPN]         ; d‚lka c¡lov‚ho adres ©e
         mov       dx,ds
         mov       di,offset CilFPol        ; fiktivn¡ polo‘ka
         call      far ptr DelWFile         ; zru¨en¡ souboru
         call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken

; ------ test, zda je otev©en p©echodn˜ soubor

         test      byte ptr ds:[CopyParD],bit3 ; je p©echodn˜ soubor ?
         jz        CopyFDl8                 ; nen¡ p©echodn˜ soubor

; ------ uzav©en¡ p©echodn‚ho souboru

         mov       ax,ds:[CilIdent]         ; identifik tor p©echodn‚ho souboru
         call      far ptr ClosFile         ; uzav©en¡ souboru
         mov       ds:[CilIdent],ax         ; zru¨en¡ identifik toru

; ------ p©ejmenov n¡ p©echodn‚ho souboru na c¡lov‚ jm‚no

         mov       si,offset CilTempF       ; jm‚no p©echodn‚ho souboru

         test      byte ptr ds:[CopyPrD2],bit5 ; m  c¡l dlouh‚ jm‚no ?
         jz        CopyFDl6                 ; c¡l nem  dlouh‚ jm‚no

         mov       di,ss:[bp-10]            ; c¡lov‚ jm‚no
         mov       dx,ss                    ; DX <- segment c¡lov‚ho jm‚na
         call      far ptr RenXFile         ; p©ejmenov n¡ adres ©e
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         jnc       CopyFDl7                 ; operace OK

CopyFDl6:mov       di,offset CilPath        ; c¡lov‚ jm‚no souboru
         mov       dx,ds                    ; DX <- datov˜ segment
         call      far ptr RenFile          ; p©ejmenov n¡ souboru
         jc        CopyFD71                 ; chyba p©ejmenov n¡ souboru

; ------ otev©en¡ v˜stupn¡ho souboru

CopyFDl7:and       byte ptr ds:[CopyParD],not bit3 ; nen¡ ji‘ p©echodn˜ soubor
         mov       si,offset CilPath        ; jm‚no c¡lov‚ho souboru
         call      far ptr OpenRW           ; otev©en¡ souboru pro z pis
         jnc       CopyFD72                 ; soubor otev©en OK

; ------ chyba otev©en¡ v˜stupn¡ho souboru

CopyFD71:call      far ptr CreatErr         ; chyba vytvo©en¡ souboru
         stc                                ; p©¡znak p©eru¨en¡
         jmp       short CopyFDl9

; ------ vystaven¡ ukazatele na konec souboru

CopyFD72:mov       ds:[CilIdent],ax         ; identifik tor souboru
         call      far ptr SizeFile         ; vystaven¡ ukazatele v souboru
CopyFDl8:clc                                ; p©¡znak operac¡ OK

; ------ n vrat registr–

CopyFDl9:pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

CopyFDel ENDP

; -----------------------------------------------------------------------------
;        vytvo©en¡ c¡lov‚ho adres ©e (datum DX, ‡as CX, atributy BL)
; -----------------------------------------------------------------------------

CopCreaD PROC      NEAR

; ------ £schova registr–

         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ instalace obsluhy ‡asu

         and       cx,ds:[ModiTimM]         ; nulov n¡ ‡asu
         or        cx,ds:[ModiTim]          ; nastaven¡ po‘adovan‚ho ‡asu
         mov       di,cx                    ; DI <- £schova ‡asu
         and       dx,ds:[ModiDatM]         ; nulov n¡ data
         or        dx,ds:[ModiDat]          ; nastaven¡ po‘adovan‚ho data
         test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
         jz        CopCreD1                 ; je dlouh‚ jm‚no
         test      byte ptr ds:[CopyPrD2],bit2 ; uchov vat datum a ‡as ?
         jz        CopCreD1                 ; neuchov vat
         call      far ptr InstA08          ; instalace obsluhy ‡asu

; ------ vytvo©en¡ adres ©e s dlouh˜m jm‚nem

CopCreD1:mov       cl,bl                    ; atributy
         and       cl,ds:[ModiAtrM]         ; nulov n¡ nastavovan˜ch atribut–
         or        cl,ds:[ModiAtr]          ; nastaven¡ po‘adovan˜ch atribut–

         test      byte ptr ds:[CopyPrD2],bit5 ; je dlouh‚ jm‚no ?
         jz        CopCreD2                 ; nen¡ dlouh‚ jm‚no

         push      ss
         pop       es                       ; ES <- segment bufferu
         mov       si,ss:[bp-10]            ; c¡lov‚ jm‚no
         call      far ptr CreaXDir         ; vytvo©en¡ adres ©e
         call      KorFCil                  ; korekce c¡lov‚ho jm‚na
         jc        CopCreD2                 ; chyba
         mov       ch,0
         call      far ptr SetXAFil         ; nastaven¡ atribut– adres ©e
         jmp       short CopCreD4

; ------ vytvo©en¡ dlouh‚ho adres ©e

CopCreD2:push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset CilPath        ; jm‚no c¡lov‚ho adres ©e
         call      far ptr CreaLDir         ; vytvo©en¡ dlouh‚ho adres ©e

; ------ nastaven¡ data a ‡asu adres ©e, je-li dlouh‚ jm‚no

CopCreD4:test      byte ptr ds:[Win95Par],bit2 ; jsou dlouh  jm‚na ?
         jnz       CopCreD6                 ; nen¡ dlouh‚ jm‚no
         test      byte ptr ds:[CopyPrD2],bit2 ; uchov vat datum a ‡as ?
         jz        CopCreD8                 ; neuchov vat datum a ‡as
         mov       cx,di                    ; CX <- ‡as
         call      far ptr SetDTDir         ; nastaven¡ data a ‡asu adres ©e
         jmp       short CopCreD8

; ------ odinstalov n¡ obsluhy ‡asu

CopCreD6:call      far ptr DInsA08          ; odinstalov n¡ modifikace ‡asu

; ------ obnoven¡ zobrazen¡ oken

CopCreD8:call      far ptr DispWAkt         ; podm¡nˆn‚ zobrazen¡ oken

; ------ n vrat registr–

         pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         ret

CopCreaD ENDP

; -----------------------------------------------------------------------------
;                                  CopPred
;        p©¡prava p©edvoleb pro kop¡rov n¡ a p©esun, zad n¡ c¡le operace
; -----------------------------------------------------------------------------
; VSTUP: BX=typ operace
;                  2 = kurzor - soubor (ve FileTxtP je jm‚no souboru)
;                  4 = kurzor - adres © (ve FileTxtP je jm‚no adres ©e)
;                  6 = 1 ozna‡en  polo‘ka (ve FileTxtP je po‡et polo‘ek)
;                  8 = 2 a‘ 4 ozna‡en‚ polo‘ky (ve FileTxtP je po‡et polo‘ek)
;                 10 = 5 a v¡ce ozna‡en˜ch polo‘ek (ve FileTxtP je po‡et polo‘.)
;                 12 = v¨echny soubory
;                 14 = v¨echny soubory a adres ©e
;                 16 = zadan‚ polo‘ky
;        SI=menu
; VSTUP: CY=p©eru¨en¡ operace
; -----------------------------------------------------------------------------
; lok ln¡ promˆnn‚: SS:[BP-2] (2) adresa definice menu
;                   SS:[BP-4] (2) typ operace
;                   SS:[BP-22] (18) p©edvolba 1 - jm‚no souboru pod kurzorem
;                              (FileMax) p©edvolba 2 - cesta k protˆj¨¡mu oknu
; Ni‡¡ v¨echny registry !
; -----------------------------------------------------------------------------

CopPred  PROC      NEAR

; ------ p©¡prava lok ln¡ch promˆnn˜ch

         push      bp

         mov       bp,sp
         sub       sp,22+FileMax + 10
         mov       ss:[bp-2],si             ; adresa definice menu
         mov       ss:[bp-4],bx             ; typ operace
         mov       byte ptr ss:[bp-22],0    ; p©¡znak - nen¡ kr tk‚ jm‚no souboru

; ------ p©¡prava parametr– menu

         test      byte ptr ds:[HelpPar],bit2 ; je n povˆda k menu ?
         jnz       CopPred2                 ; n povˆda k menu nen¡
         mov       es,ds:[HelpSeg]          ; segment n povˆdy
         mov       ax,ds:[bx+CopyTabH-2]    ; adresa n povˆdy
         mov       es:[SK1MLHlX],ax
         mov       es:[SJ1MLHlX],ax
CopPred2:mov       ax,ds:[bx+CopyTbPA-2]    ; adresa polo‘ky - A
         mov       ds:[SK1MLPlA],ax
         mov       ds:[SJ1MLPlA],ax
         mov       ax,ds:[bx+CopyTbPB-2]    ; adresa polo‘ky - B
         mov       ds:[SK1MLPlB],ax
         mov       ds:[SJ1MLPlB],ax

; ------ inicializace ukazatel–

         lea       bx,[si+LMnuPreN]         ; BX <- definice p©edvoleb
         mov       byte ptr ds:[bx],0       ; nen¡ ‘ dn  p©edvolba

; ------ test, zda bude polo‘ka pod kurzorem

         cmp       byte ptr ss:[bp-4],12    ; jsou v¨echny polo‘ky nebo zadan‚ ?
         jae       CopPred4                 ; nen¡ polo‘ka pod kurzorem

; ------ £schova typu okna

         call      far ptr GetAAWin         ; adresa aktivn¡ho okna
         mov       al,es:[AWinPrm1]         ; typ okna

; ------ adresa polo‘ky pod kurzorem -> ES:SI

         call      far ptr GetAKurz         ; poskytnut¡ adresy kurzoru
         jc        CopPred4                 ; nen¡ kurzor
         inc       byte ptr ds:[bx]         ; je 1 p©edvolba

; ------ test, zda bude dlouh‚ jm‚no

         test      al,bit3                  ; je to adres ©ov‚ okno ?
         jz        CopPrd26                 ; nen¡ to adres ©ov‚ okno
         mov       al,es:[si+FileLong]      ; d‚lka dlouh‚ho jm‚na
         or        al,al                    ; je dlouh‚ jm‚no ?
         jz        CopPrd26                 ; nen¡ dlouh‚ jm‚no

; ------ nastaven¡ adresy dlouh‚ho jm‚na

         mov       ah,0
         mov       ds:[bx+1],ax             ; d‚lka p©edvolby
         add       si,FileLong+1            ; za‡ tek dlouh‚ho jm‚na
         mov       ds:[bx+3],si             ; adresa jm‚na
         mov       ds:[bx+5],es             ; segment jm‚na
         jmp       short CopPrd32

; ------ nastaven¡ ukazatel– na polo‘ku

CopPrd26:lea       di,[bp-22]               ; p©edvolba 1 - polo‘ka
         mov       ds:[bx+3],di             ; p©edvolba 1 - polo‘ka
         mov       ds:[bx+5],ss

; ------ dek¢dov n¡ jm‚na polo‘ky pod kurzorem

         push      ds
         push      es
         push      ss
         pop       es                       ; ES <- segment bufferu
         pop       ds                       ; DS <- segment polo‘ky
         inc       si                       ; za‡ tek jm‚na polo‘ky
         call      far ptr FileAsc          ; dek¢dov n¡ jm‚na polo‘ky
         pop       ds
         sub       di,ds:[bx+3]             ; d‚lka textu p©edvolby 1
         mov       ds:[bx+1],di             ; d‚lka textu p©edvolby 1

; ------ oprava jm‚na polo‘ky na mal  p¡smena

         cmp       byte ptr ss:[bp-4],2     ; je to soubor ?
         jne       CopPrd32                 ; nen¡ to soubor

         mov       cx,di                    ; CX <- d‚lka p©edvolby 1
         lea       di,[bp-22]               ; p©edvolba 1 - polo‘ka
CopPred3:mov       al,ss:[di]               ; na‡ten¡ znaku
;         call      far ptr DownCase         ; p©evod na mal‚ p¡smeno

         call      far ptr UpCase           ; konverze na velk‚ p¡smeno

         cld
         stosb                              ; ulo‘en¡ znaku
         loop      CopPred3                 ; dal¨¡ znak

CopPrd32:add       bx,6                     ; adresa dal¨¡ p©edvolby

; ------ test, zda je protˆj¨¡ okno

CopPred4:call      far ptr TestNAWn         ; test, zda je neaktiv. okno zapnuto
         jc        CopPrd49                 ; neaktivn¡ okno nen¡ zapnuto

; ------ adresa protˆj¨¡ho okna

         call      far ptr GetNAWin         ; adresa neaktivn¡ho okna
CopPrd49:jc        CopPred9                 ; nˆjak  chyba

; ------ test, zda je to aktivn¡ adres ©

         mov       cx,es:[AWinDNum]         ; d‚lka textu adres ©e
         cmp       cx,ds:[AktPathN]         ; je shodn  d‚lka ?
         jne       CopPred5                 ; d‚lka nen¡ shodn 

         push      cx
         mov       di,AWinDir               ; aktivn¡ adres © neaktivn¡ho okna
         mov       si,offset AktPath        ; aktivn¡ cesta
         cld
         repe      cmpsb                    ; porovn n¡ text– adres ©–
         pop       cx
         je        CopPred9                 ; je to aktivn¡ adres © - nic

; ------ p©¡prava ukazatel– na cestu do protˆj¨¡ho okna

CopPred5:mov       si,ss:[bp-2]             ; definice menu
         add       si,LMnuPreN              ; definice po‡tu p©edvoleb
         inc       byte ptr ds:[si]         ; je p©edvolba 2
         mov       ds:[bx+1],cx             ; d‚lka textu adres ©e
         mov       di,sp                    ; p©edvolba 2 - cesta
         mov       ds:[bx+3],di             ; p©edvolba 2 - cesta
         mov       ds:[bx+5],ss

; ------ p©¡prava cesty k protˆj¨¡mu oknu

         push      si
         push      ds

         push      es
         push      ss
         pop       es                       ; ES <- segment bufferu v z sobn¡ku
         pop       ds                       ; DS <- segment okna
         mov       si,AWinDir               ; za‡ tek textu cesty
         cld
         rep       movsb                    ; p©enos textu p©edvolby

         pop       ds
         pop       si

; ------ test, zda se k cestˆ p©id  jm‚no polo‘ky

         cmp       byte ptr ss:[bp-4],2     ; je kurzor - soubor ?
         ja        CopPrd82                 ; nen¡ kurzor - soubor
         cmp       byte ptr ds:[si],2       ; jsou obˆ p©edvolby ?
         jne       CopPrd82                 ; nejsou obˆ p©edvolby
         lea       si,ss:[bp-22]            ; p©edvolba 1 - polo‘ka
         cmp       byte ptr ss:[si],0       ; je kr tk‚ jm‚no souboru ?
         je        CopPrd82                 ; nen¡ kr tk‚ jm‚no souboru

; ------ kopie textu jm‚na polo‘ky, je-li kurzor (je zde CLD)

         mov       cx,ds:[bx-6+1]           ; CX <- d‚lka p©edvolby 1
         add       ds:[bx+1],cx             ; zv˜¨en¡ d‚lky p©edvolby 2
         mov       al,"\"
         dec       di
         scasb                              ; je znak "\" ?
         je        CopPred8                 ; je ji‘ znak "\"
         stosb                              ; ulo‘en¡ znaku "\"
         inc       word ptr ds:[bx+1]       ; zv˜¨en¡ d‚lky textu cesty
CopPred8:rep       movs byte ptr es:[di],ss:[si] ; p©id n¡ jm‚na polo‘ky

; ------ p©id n¡ parametru "/r" pro CD disk

CopPrd82:push      es
         call      far ptr GetAAWin         ; adresa aktivn¡ho okna -> ES
         test      byte ptr es:[AWinPrm0],bit6 ; je to CD-ROM disk ?
         pop       es
         jz        CopPred9                 ; nen¡ to CD-ROM disk

         cld
         mov       ax,"/ "                  ; mezera a znak parametru "/"
         stosw                              ; oddˆlovac¡ mezera a znak "/"
         mov       ax,"r"                   ; parametr "r" a koncov  0
         stosw
         add       word ptr ds:[bx+1],3     ; zv˜¨en¡ d‚lky textu

; ------ zad n¡ a rozbor c¡le operace (CY=p©eru¨en¡)

CopPred9:mov       si,ss:[bp-2]             ; adresa definice menu
         call      far ptr RozbCil          ; zad n¡ a rozbor c¡le

; ------ n vrat registr–

         mov       sp,bp
         pop       bp
         ret

CopPred  ENDP

; -----------------------------------------------------------------------------
;                                 CopyExis
;                     test, zda c¡lov˜ soubor ji‘ existuje
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: CY=soubor se nekop¡ruje
; -----------------------------------------------------------------------------

CopyExis PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ inicializace operace pro v¡cediskov˜ re‘im

         and       byte ptr ds:[ExistPar],not bit3 ; nen¡ p©esko‡en¡
         test      byte ptr ds:[ExistPar],bit1+bit5 ; je p©epis nebo p©ipojen¡ ?
         jnz       CopyEx12                 ; je p©epis nebo p©ipojen¡ - OK
         or        byte ptr ds:[ExistPar],bit1 ; p©epis souboru (pro dal¨¡ disk)
CopyEx12:test      byte ptr ds:[ExistPar],bit7 ; je dal¨¡ disk ?
         jnz       CopyEx10                 ; je dal¨¡ disk
         and       byte ptr ds:[ExistPar],not bit1+bit5 ; nulov n¡

; ------ test, zda c¡lov˜ soubor ji‘ existuje

CopyEx10:test      byte ptr ds:[ExistPar],bit0 ; soubor existuje ?
         jnz       CopyEx3                  ; soubor ji‘ existuje
CopyEx1: and       byte ptr ds:[ExistPar],not bit1+bit5 ; nulov n¡ (pro dal¨¡ disk)
                                          ;* zde je NC=soubor se p©ep¡¨e
CopyEx2: jmp       CopyEx9

; ------ chyba - existuje ji‘ adres © stejn‚ho jm‚na jako ES:SI

CopyEx3: test      byte ptr ds:[CilDTA+DTAAtrib],DIR ; je to adres © ?
         jz        CopyEx4                  ; nen¡ to adres ©
         call      far ptr CopDErr          ; chyba - existuje adres ©
         stc                                ; v ‘ dn‚m p©¡padˆ se nekop¡ruje
         jmp       short CopyEx2            ; p©eru¨en¡

; ------ test, zda je p©ednastavena operace pro v¨echny soubory

CopyEx4: test      byte ptr ds:[ExistPar],bit7 ; je dal¨¡ disk ?
         jnz       CopyEx2                  ; dal¨¡ disk - soubor se p©episuje
         or        byte ptr ds:[ExistPar],bit3 ; p©¡znak p©esko‡en¡ souboru
         test      byte ptr ds:[ExistPar],bit4 ; je p©esko‡en¡ v¨ech soubor– ?
         stc                                ; p©¡znak p©esko‡en¡ souboru
         jnz       CopyEx2                  ; je p©esko‡en¡ souboru
         xor       byte ptr ds:[ExistPar],bit1+bit3 ; p©¡znak p©episu souboru
         test      byte ptr ds:[ExistPar],bit2 ; je p©epis v¨ech soubor– ?
         jnz       CopyEx2                  ; je p©epis souboru
         and       byte ptr ds:[ExistPar],not bit1+bit3+bit5 ; nulov n¡ p©¡znak–

; ------ za©¡zen¡ se automaticky p©episuje

         test      byte ptr ds:[ExistPar],bit6 ; je to za©¡zen¡ ?
         jnz       CopyEx41                 ; je to za©¡zen¡

; ------ automatick˜ p©epis soubor–

         mov       si,offset FileFPol       ; polo‘ka kop¡rovan‚ho souboru
         mov       di,offset CilDTA         ; polo‘ka c¡lov‚ho souboru

         test      byte ptr ds:[CopyPrD2],bit0 ; je automatick˜ p©epis ?
         jz        CopyEx42                 ; nen¡ automatick˜ p©epis

         mov       ax,ds:[si+FileDate]      ; datum
         cmp       ax,ds:[di+DTADate]       ; porovn n¡ data
         jne       CopyEx40                 ; datum nen¡ shodn‚
         mov       ax,ds:[si+FileTime]      ; ‡as
         cmp       ax,ds:[di+DTATime]       ; porovn n¡ ‡asu
CopyEx40:ja        CopyEx41                 ; nov˜ soubor je novˆj¨¡ - p©epis
         jmp       CopyEx84                 ; je p©esko‡en¡ souboru
CopyEx41:jmp       CopyEx82                 ; je p©epis souboru

; ------ p©¡prava textu porovn n¡ parametr– soubor–

CopyEx42:mov       bx,offset CopLD2P2       ; ‡ st textu 1 "Kop¡rovan˜ soubor.."
         mov       cx,offset CopLD2P3       ; ‡ st textu 2 "novˆj¨¡"
         mov       dx,offset CopLD2P7       ; ‡ st textu 3 "ne‘ p©episovan˜"

         mov       ax,ds:[si+FileDate]      ; datum
         cmp       ax,ds:[di+DTADate]       ; porovn n¡ data
         jne       CopyEx43                 ; datum nen¡ shodn‚
         mov       ax,ds:[si+FileTime]      ; ‡as
         cmp       ax,ds:[di+DTATime]       ; porovn n¡ ‡asu
CopyEx43:ja        CopyEx5                  ; nov˜ soubor je novˆj¨¡
         mov       cx,offset CopLD2P4       ; ‡ st textu 2 "star¨¡"
         jb        CopyEx5                  ; nov˜ soubor je star¨¡

         mov       cx,offset CopLD2P5       ; ‡ st textu 2 "vˆt¨¡"
         mov       ax,word ptr ds:[si+FileSize+2] ; velikost HIGH
         cmp       ax,ds:[di+DTASize+2]     ; porovn n¡ velikosti HIGH
         jne       CopyEx44                 ; velikost nen¡ shodn 
         mov       ax,word ptr ds:[si+FileSize] ; velikost LOW
         cmp       ax,ds:[di+DTASize]       ; porovn n¡ velikosti LOW
CopyEx44:ja        CopyEx5                  ; nov˜ soubor je vˆt¨¡
         mov       cx,offset CopLD2P6       ; ‡ st textu 2 "men¨¡"
         jb        CopyEx5                  ; nov˜ soubor je men¨¡

         mov       bx,offset CopLD2P1       ; ‡ st textu 1 "parametry shodn‚"
         mov       cx,offset CopLD2P0
         mov       dx,offset CopLD2P0

CopyEx5: mov       word ptr ds:[CopLD2PA+1],bx ; ‡ st textu 1
         mov       word ptr ds:[CopLD2PA+4],cx ; ‡ st textu 2
         mov       word ptr ds:[CopLD2PA+7],dx ; ‡ st textu 3

; ------ dek¢dov n¡ velikosti

         mov       di,offset CopLD2PV + 13  ; buffer k dek¢dov n¡ velikosti
         mov       cx,28
         mov       al," "
         rep       stosb                    ; vymaz n¡ bufferu textu

         mov       ax,word ptr ds:[CilDTA+DTASize] ; velikost c¡lov‚ho souboru
         mov       dx,word ptr ds:[CilDTA+DTASize+2]
         mov       bl,ds:[OddelRad]         ; oddˆlovac¡ znak © d–
         mov       bh,0                     ; barva textu - nen¡
         call      far ptr DekNumD          ; dek¢dov n¡ velikosti

         mov       di,offset CopLD2PV + 13 + 13 ; konec velikosti zdrojov‚ho souboru
         mov       ax,word ptr ds:[si+FileSize]      ; velikost souboru LOW
         mov       dx,word ptr ds:[si+FileSize+2]    ; velikost souboru HIGH
         call      far ptr DekNumD          ; dek¢dov n¡ velikosti

; ------ dek¢dov n¡ data (DS:SI=zdrojov˜ soubor)

         mov       di,offset CopLD2PD + 16
         mov       ah,0                     ; barva nen¡
         mov       dx,ds                    ; DX <- datov˜ segment
         call      far ptr DekA4Dat         ; dek¢dov n¡ data zdrojov‚ho souboru
         push      si
         mov       si,offset CilDTA + DTADate - FileDate ; fiktivn¡ c¡lov  polo‘ka
         mov       di,offset CopLD2PD + 31
         call      far ptr DekA4Dat         ; dek¢dov n¡ data c¡lov‚ho souboru
         pop       si

; ------ dek¢dov n¡ ‡asu (DS:SI=zdrojov˜ soubor)

         mov       di,offset CopLD2PT + 18
         call      far ptr DekATmS          ; dek¢dov n¡ ‡asu zdrojov‚ho souboru
         mov       si,offset CilDTA + DTATime - FileTime ; fiktivn¡ c¡lov  polo‘ka
         mov       di,offset CopLD2PT + 33
         call      far ptr DekATmS          ; dek¢dov n¡ ‡asu c¡lov‚ho souboru

; ------ chybov‚ hl ¨en¡ - soubor ji‘ existuje

         call      far ptr InfoClos         ; uzav©en¡ funkce
         mov       si,offset CopyLD2
         call      far ptr Lin0Menu         ; zobrazen¡ menu
         call      far ptr InfoDisp         ; nov‚ zobrazen¡ hl ¨en¡

; ------ obsluha zvolen‚ operace

         call      far ptr JumpBX           ; skok na obsluhu volby

         dw        1,CopyEx82               ; p©epsat
         dw        2,CopyEx81               ; v¨echny
         dw        3,CopyEx84               ; dal¨¡
         dw        4,CopyEx83               ; nep©episovat
         dw        5,CopyEx85               ; slou‡it

         dw        0,CopyEx6                ; konec nebo ESC

; ------ p©eru¨en¡ operace

CopyEx6: call      far ptr SetEsc           ; p©¡znak p©eru¨en¡
         jmp       short CopyEx9            ; p©eru¨en¡ operace

; ------ p©epsat v¨echny

CopyEx81:or        byte ptr ds:[ExistPar],bit2 ; p©epsat v¨echny

; ------ p©epis

CopyEx82:or        byte ptr ds:[ExistPar],bit1 ; p©epis souboru
         jmp       short CopyEx9            ; zde je NC !

; ------ nep©episovat ‘ dn˜

CopyEx83:or        byte ptr ds:[ExistPar],bit4 ; p©esko‡it v¨echny

; ------ dal¨¡

CopyEx84:or        byte ptr ds:[ExistPar],bit3 ; p©esko‡en¡ souboru
         stc                                ; p©¡znak p©esko‡en¡
         jmp       short CopyEx9

; ------ p©idat

CopyEx85:or        byte ptr ds:[ExistPar],bit5 ; p©ipojen¡ souboru
                                          ;* zde je nastaveno NC !
; ------ n vrat registr–

CopyEx9: pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

CopyExis ENDP

; -----------------------------------------------------------------------------
;                                 CopyRO
;                  test, zda se polo‘ka R/O p©episuje
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: CY=polo‘ka se nep©episuje
; -----------------------------------------------------------------------------

CopyRO   PROC      NEAR

; ------ £schova registr–

         push      bx
         push      dx
         push      si

; ------ test, zda se ru¨¡/p©eskakuj¡ v¨echny polo‘ky

         test      byte ptr ds:[CopyRusP],bit0 ; p©episuj¡ se v¨echny R/O ?
         jnz       CopyRO9                  ; p©episuj¡ se v¨echny R/O
         test      byte ptr ds:[CopyRusP],bit1 ; p©eskakuj¡ se v¨echny R/O ?
         jnz       CopyRO8                  ; p©eskakuj¡ se v¨echny polo‘ky

; ------ dotaz na zru¨en¡ polo‘ky

         call      far ptr InfoClos         ; uzav©en¡ informa‡n¡ho © dku
         mov       si,offset CopL4Lin
         call      far ptr Lin0Menu         ; zad n¡ volby
         call      far ptr InfoDisp         ; nov‚ zobrazen¡ hl ¨en¡

         call      far ptr JumpBX

         dw        1,CopyRO6                ; p©epsat
         dw        2,CopyRO5                ; v¨echny
         dw        3,CopyRO8                ; dal¨¡
         dw        4,CopyRO7                ; nep©episovat

         dw        0,CopyRO2                ; p©eru¨it, ESC

; ------ p©eru¨en¡ operace

CopyRO2: call      far ptr SetEsc           ; nastaven¡ p©¡znaku p©eru¨en¡ ESC
         jmp       short CopyRO9

; ------ p©epsat

CopyRO5: or        byte ptr ds:[CopyRusP],bit0 ; p©¡znak zru¨en¡ v¨ech polo‘ek
CopyRO6: clc                                ; p©¡znak p©episu polo‘ky
         jmp       short CopyRO9

; ------ p©esko‡it

CopyRO7: or        byte ptr ds:[CopyRusP],bit1 ; p©¡znak p©esko‡en¡ v¨ech
CopyRO8: stc                                ; p©¡znak p©esko‡en¡ polo‘ky

; ------ n vrat registr–

CopyRO9: pop       si
         pop       dx
         pop       bx
         ret

CopyRO   ENDP

; -----------------------------------------------------------------------------
;                                CopyFre
;           test voln‚ho m¡sta na disku (p©ed zah jen¡m kop¡rov n¡)
; -----------------------------------------------------------------------------
; VSTUP: DS=datov˜ segment
; VSTUP: CY=soubor se p©esko‡¡
; -----------------------------------------------------------------------------

CopyFre  PROC      NEAR

; ------ aktualizace voln‚ kapacity c¡lov‚ho disku

         call      CopyGDsk                 ; aktualizace voln‚ho m¡sta disku

; ------ £schova registr–

CopyFre0:push      ax
         push      bx
         push      cx
         push      dx
         push      si
         push      di
         push      es

; ------ p©¡prava voln‚ho m¡sta disku -> DX:AX

         call      CopyPFre                 ; p©¡prava voln‚ho m¡sta disku
         jc        CopyFre2                 ; nedostatek m¡sta
         jmp       CopyFre9                 ; je dost voln‚ho m¡sta pro soubor

; ------ test p©¡tomnosti p©episovan‚ho souboru

CopyFr12:call      CopyTCil                 ; test c¡lov‚ho souboru

; ------ aktualizace obsah– oken

         call      CopyWAkt                 ; aktualizace oken

; ------ p©¡prava text– hl ¨en¡

CopyFre2:mov       ds:[CopL3P11],offset CopL3P16 ; text "nen¡"
         mov       ds:[CopL3P12],offset CopL3P18 ; text "Vymˆ¤te disk..."

         call      CopyPFre                 ; p©¡prava voln‚ho m¡sta disku
         jc        CopyFre4                 ; nen¡ dost voln‚ho m¡sta pro soubor

         mov       ds:[CopL3P11],offset CopL3P17 ; text "je"
         mov       ds:[CopL3P12],offset CopL3P19 ; text "M–‘ete pokra‡ovat..."

; ------ dek¢dov n¡ po‘adovan‚ho voln‚ho m¡sta

CopyFre4:mov       di,offset CopL3Pl4 + 27  ; buffer k dek¢dov n¡
         mov       ax,word ptr ds:[CopyDSiz] ; po‘adovan‚ voln‚ m¡sto
         mov       dx,word ptr ds:[CopyDSiz+2]
         call      CopyF0Nm                 ; dek¢dov n¡ ‡¡sla

; ------ dek¢dov n¡ voln‚ kapacity disku

         mov       di,offset CopL3Pl3 + 27  ; buffer k dek¢dov n¡
         mov       ax,word ptr ds:[CopyDFr0]
         mov       dx,word ptr ds:[CopyDFr0+2]
         call      CopyF0Nm                 ; dek¢dov n¡ ‡¡sla

; ------ dek¢dov n¡ celkov‚ kapacity disku

         mov       di,offset CopL3Pl2 + 27  ; buffer k dek¢dov n¡
         mov       ax,word ptr ds:[CopyDMax]
         mov       dx,word ptr ds:[CopyDMax+2]
         call      CopyF0Nm                 ; dek¢dov n¡ ‡¡sla

; ------ dotaz na dal¨¡ postup

         mov       si,offset CopL3Lin
         call      far ptr Lin0MenF         ; zad n¡ volby (vypr zdnˆn¡ kl vesnice)
         call      far ptr InfoDisp         ; nov‚ zobrazen¡ hl ¨en¡

         call      far ptr JumpBX
         dw        1,CopyFre8               ; pokra‡ov n¡
         dw        2,CopyFre6               ; dal¨¡ soubor
         dw        3,CopyFr12               ; v˜mˆna disku

         dw        0,CopyFre5               ; p©eru¨en¡ operace

; ------ p©eru¨en¡ operace ESC

CopyFre5:call      far ptr SetEsc           ; nastaven¡ p©¡znaku p©eru¨en¡ ESC
CopyFre6:stc                                ; p©¡znak dal¨¡ho souboru
         jmp       short CopyFre9

; ------ n vrat registr–

CopyFre8:call      CopyWAkt                 ; aktualizace oken po v˜mˆnˆ diskety
         clc                                ; NC=p©¡znak pokra‡ov n¡
CopyFre9:pop       es
         pop       di
         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

CopyFre   ENDP

; ------ dek¢dov n¡ ‡¡sla DX:AX do bufferu DI

CopyF0Nm:push      ds
         pop       es                       ; ES <- datov˜ segment

         cld
         mov       cx,13
         push      di
         push      ax
         mov       al," "
         rep       stosb                    ; vymaz n¡ bufferu ‡¡sla
         pop       ax
         pop       di

         mov       bl,ds:[OddelRad]         ; oddˆlova‡ © d–
         mov       bh,0                     ; barva se neukl d 
         call      far ptr DekNum           ; dek¢dov n¡ ‡¡sla
         ret

; -----------------------------------------------------------------------------
;     test, zda je c¡lov˜ soubor (a aktualizace informac¡ o souboru) -> CY=nen¡
; -----------------------------------------------------------------------------

CopyTCil PROC      NEAR

; ------ £schova registr–

         push      ax
         push      cx
         push      si
         push      di
         push      es

; ------ nastaven¡ adresy bufferu DTA

         push      ds
         pop       es                       ; ES <- segment bufferu DTA
         mov       si,offset CilDTA         ; SI <- buffer DTA
         call      far ptr SetDTA           ; nastaven¡ adresy DTA

; ------ zobrazen¡ hl ¨en¡ o na‡¡t n¡ informac¡ o disku (nen¡-li nic zobrazeno)

         call      CopyIHls                 ; zobrazen¡ hl ¨en¡

; ------ test, zda c¡lov˜ soubor ji‘ existuje

         mov       si,offset CilPath        ; c¡lov‚ jm‚no souboru
         test      byte ptr ds:[CopyPrD2],bit5 ; je dlouh‚ jm‚no ?
         jz        CopyTCl2                 ; nen¡ dlouh‚ jm‚no
         push      ss
         pop       es                       ; ES <- segment z sobn¡ku
         mov       si,ss:[bp-10]            ; c¡lov‚ jm‚no
CopyTCl2:mov       cx,SYS+HID+DIR+RO
         call      far ptr SrcFirst         ; nalezen¡ souboru nebo adres ©e
         call      far ptr SrcClose         ; uzav©en¡ star‚ho hled n¡
         jc        CopyTCl9                 ; nˆjak  chyba (nap©. nen¡ adres ©)
         stc                                ; p©¡znak, ‘e soubor nen¡
         jne       CopyTCl9                 ; soubor neexistuje

; ------ test, zda je souborem znakov‚ za©¡zen¡ (a nastaven¡ do bin rn¡ho m¢du)

         call      far ptr OpenW            ; otev©en¡ pro z pis
         jc        CopyTCl3                 ; asi to je soubor R/O
         call      far ptr TestDev          ; test, zda to je za©¡zen¡
         jc        CopyTC22                 ; je to soubor
         or        byte ptr ds:[ExistPar],bit6 ; p©¡znak znakov‚ho za©¡zen¡
CopyTC22:call      far ptr ClosFile         ; uzav©en¡ souboru/za©¡zen¡

; ------ £schova atributu

CopyTCl3:mov       al,ds:[CilDTA+DTAAtrib]
         mov       ds:[CilFAtr],al          ; £schova atribut–

; ------ £schova velikosti

         mov       ax,word ptr ds:[CilDTA+DTASize]
         mov       word ptr ds:[CilFSize],ax
         mov       ax,word ptr ds:[CilDTA+DTASize+2]
         mov       word ptr ds:[CilFSize+2],ax

; ------ £schova data

         mov       ax,word ptr ds:[CilDTA+DTADate]
         mov       ds:[CilFDate],ax

; ------ £schova ‡asu

         mov       ax,word ptr ds:[CilDTA+DTATime]
         mov       ds:[CilFTime],ax

; ------ p©¡prava konce cesty v c¡lov‚m bufferu

         mov       di,offset CilPath        ; c¡lov˜ buffer
         add       di,ds:[CilCilPN]         ; konec cesty
         cmp       byte ptr ds:[di-1],"\"
         je        CopyTCl4
         inc       di

; ------ p©enesen¡ jm‚na souboru

CopyTCl4:cld
         push      ds
         pop       es                       ; ES <- datov˜ segment
         mov       si,offset CilDTA+DTAName ; jm‚no souboru
         xor       cx,cx                    ; CX <- ‡¡ta‡ d‚lky jm‚na
         push      si
         dec       cx                       ; p©ednastaven¡
CopyTCl6:inc       cx                       ; zv˜¨en¡ ‡¡ta‡e d‚lky jm‚na
         lodsb                              ; na‡ten¡ znaku
         stosb                              ; ulo‘en¡ znaku
         or        al,al                    ; je konec jm‚na ?
         jnz       CopyTCl6                 ; p©enesen¡ jm‚na
         pop       si

; ------ nov  d‚lka cesty

         sub       di,offset CilPath+1      ; d‚lka jm‚na souboru
         mov       ds:[CilPathN],di         ; nov  d‚lka jm‚na souboru

; ------ kopie jm‚na souboru i do FileTxtP

         mov       di,offset FileTxtP+1
         mov       ds:[di-1],cl             ; d‚lka jm‚na
         rep       movsb                    ; £schova jm‚na polo‘ky

; ------ n vrat registr–

         clc                                ; p©¡znak, ‘e soubor existuje OK
CopyTCl9:pop       es
         pop       di
         pop       si
         pop       cx
         pop       ax
         ret

CopyTCil ENDP

; -----------------------------------------------------------------------------
;        £schova parametr– c¡lov‚ho souboru
; -----------------------------------------------------------------------------

CilFAkt  PROC      NEAR

; ------ £schova registr–

         push      ax

; ------ n vrat registr–

         pop       ax
         ret

CilFAkt  ENDP

; -----------------------------------------------------------------------------
;        p©¡prava voln‚ho m¡sta c¡lov‚ho disku -> DX:AX, CY=nesta‡¡ m¡sto
; -----------------------------------------------------------------------------

CopyPFre PROC      NEAR

         push      cx

; ------ p©¡prava voln‚ho m¡sta disku

         mov       ax,word ptr ds:[CopyDFre] ; voln  kapacita disku
         mov       dx,word ptr ds:[CopyDFre+2]
         mov       word ptr ds:[CopyDFr0],ax ; voln  kapacita po p©episu
         mov       word ptr ds:[CopyDFr0+2],dx

; ------ test, zda se uvoln¡ p©episovan˜ soubor

         test      byte ptr ds:[ExistPar],bit0 ; existuje c¡lov˜ soubor ?
         jz        CopyPFr4                 ; c¡lov˜ soubor neexistuje
         test      byte ptr ds:[ExistPar],bit1 ; je p©epis souboru ?
         jz        CopyPFr4                 ; nen¡ p©epis souboru
         test      byte ptr ds:[CopyParD],bit2 ; byl soubor zru¨en ?
         jnz       CopyPFr4                 ; soubor ji‘ byl zru¨en

; ------ zaokrouhlen  velikost souboru

         mov       ax,word ptr ds:[CilDTA+DTASize] ; velikost c¡lov‚ho souboru
         mov       dx,word ptr ds:[CilDTA+DTASize+2]
         mov       cx,ds:[CopyDBlk]         ; velikost aloka‡n¡ho bloku
         dec       cx
         add       ax,cx                    ; zaokrouhlen¡ na aloka‡n¡ blok
         adc       dx,0
         inc       cx
         cmp       dx,cx                    ; bylo by p©ete‡en¡ ?
         jae       CopyPFr3                 ; bylo by p©ete‡en¡
         div       cx                       ; p©epo‡et na bloky
         mul       cx                       ; p©epo‡et zp tky na bajty

; ------ nov‚ voln‚ m¡sto disku -> DX:AX

CopyPFr3:add       ax,word ptr ds:[CopyDFr0] ; p©i‡ten¡ voln‚ho m¡sta disku
         adc       dx,word ptr ds:[CopyDFr0+2]
         mov       word ptr ds:[CopyDFr0],ax
         mov       word ptr ds:[CopyDFr0+2],dx

; ------ test, zda se soubor vejde na disk (CY=nevejde se)

CopyPFr4:test      byte ptr ds:[CopyParD],bit1 ; jsou diskov‚ informace platn‚ ?
         jnz       CopyPFr6                 ; diskov‚ informace jsou neplatn‚
         cmp       dx,word ptr ds:[CopyDSiz+2] ; vejde se soubor na disk ?
         jne       CopyPFr6
         cmp       ax,word ptr ds:[CopyDSiz]

CopyPFr6:pop       cx
         ret

CopyPFre ENDP

; -----------------------------------------------------------------------------
;        aktualizace oken po v˜mˆnˆ c¡lov‚ho disku
; -----------------------------------------------------------------------------

CopyWAkt PROC      NEAR

; ------ £schova registr–

         push      ax
         push      dx
         push      si
         push      es

; ------ na‡ten¡ nov˜ch informac¡ o c¡lov‚m disku

         call      CopyGDsk                 ; na‡ten¡ informac¡ o c¡lov‚m disku
         call      far ptr TestBreak        ; bylo p©eru¨en¡ operace ?
         jc        CopyAkt9                 ; je p©eru¨en¡ operace

; ------ adresa neaktivn¡ho okna

         call      far ptr GetNAWin         ; adresa neaktivn¡ho okna
         jc        CopyAkt9
         test      byte ptr es:[AWinPrm1],bit3 ; je to adres ©ov‚ okno ?
         jz        CopyAkt9                 ; nen¡ to adres ©ov‚ okno

; ------ test, zda to je c¡lov˜ disk

         mov       al,ds:[CilPath]          ; c¡lov˜ disk
         cmp       al,es:[AWinDir]          ; souhlas¡ disk ?
         jne       CopyAkt9                 ; nen¡ to c¡lov˜ disk

; ------ znovuna‡ten¡ neaktivn¡ho okna

         and       byte ptr es:[AWinPrm0],not bit0 ; uchovat kurzor i ozna‡en¡
         mov       ax,ds:[SegmNAkt]         ; neaktivn¡ okno
         call      far ptr ReReadD          ; znovuna‡ten¡ okna
         call      far ptr DispNAWn         ; zobrazen¡ neaktivn¡ho okna

; ------ obnoven¡ hl ¨en¡ o kop¡rov n¡

CopyAkt9:call      CopyHlas                 ; hl ¨en¡ o operaci

; ------ n vrat registr–

         pop       es
         pop       si
         pop       dx
         pop       ax
         ret

CopyWAkt ENDP

; -----------------------------------------------------------------------------
;        inicializace parametr– disku
; -----------------------------------------------------------------------------

CopyGDsk PROC      NEAR

; ------ £schova registr–

         push      ax
         push      bx
         push      cx
         push      dx
         push      si

; ------ zobrazen¡ hl ¨en¡ o na‡¡t n¡

         call      CopyIHls                 ; zobrazen¡ hl ¨en¡

; ------ p©¡prava jm‚na disku pro hl ¨en¡

         mov       al,ds:[CilPath]          ; c¡lov˜ disk
         mov       ds:[CopL3Pl1],al         ; ulo‘en¡ ozna‡en¡ disku
         sub       al,"A"                   ; korekce na ‡¡slo disku

; ------ zji¨tˆn¡ informac¡ o c¡lov‚m disku AL

         and       byte ptr ds:[CopyParD],not bit1 ; diskov‚ informace platn‚ OK
         call      far ptr GetDInfo         ; diskov‚ informace
         jnc       CopyGDs2                 ; informace jsou OK
         or        byte ptr ds:[CopyParD],bit1 ; neplatn‚ diskov‚ informace

; ------ v˜po‡et velikosti aloka‡n¡ho bloku

CopyGDs2:xchg      cx,dx                    ; CX<-blok– celkem, DX<-bajt–/sektor
         mul       dx                       ; v˜po‡et po‡tu bajt– na blok
         mov       ds:[CopyDBlk],ax         ; £schova po‡tu bajt– na blok
         or        dx,dx                    ; je v¡ce ne‘ 64 KB ?
         jz        CopyGDs3                 ; je to OK
         mov       word ptr ds:[CopyDBlk],-1 ; omezen¡ velikosti bloku

; ------ v˜po‡et celkov‚ kapacity disku

CopyGDs3:xchg      ax,cx                    ; AX<-blok– celkem, CX<-blok LOW
         mov       si,dx                    ; SI <- velikost bloku HIGH
         push      ax                       ; blok– celkem
         mul       si                       ; kapacita HIGH
         mov       word ptr ds:[CopyDMax+2],ax ; kapacita HIGH
         pop       ax                       ; blok– celkem
         mul       cx                       ; kapacita LOW
         mov       word ptr ds:[CopyDMax],ax ; celkov  kapacita - LOW
         add       word ptr ds:[CopyDMax+2],dx ; celkov  kapacita - HIGH

; ------ v˜po‡et voln‚ kapacity disku

         xchg      ax,si                    ; velikost bloku HIGH
         mul       bx                       ; voln‚ m¡sto HIGH
         mov       word ptr ds:[CopyDFre+2],ax ; voln  kapacita HIGH
         xchg      ax,bx                    ; po‡et voln˜ch alok. blok–
         mul       cx                       ; v˜po‡et voln‚ kapacity
         mov       word ptr ds:[CopyDFre],ax ; voln  kapacita - LOW
         add       word ptr ds:[CopyDFre+2],dx ; voln  kapacita - HIGH

; ------ n vrat registr–

         pop       si
         pop       dx
         pop       cx
         pop       bx
         pop       ax
         ret

CopyGDsk ENDP

; -----------------------------------------------------------------------------
;        hl ¨en¡ o kop¡rov n¡ a p©esunu
; -----------------------------------------------------------------------------

CopyHlas PROC      NEAR

; ------ £schova registr–

         push      cx
         push      si
         push      es

; ------ vymaz n¡ informa‡n¡ho © dku

         push      ds
         pop       es                       ; ES <- datov˜ segment
         call      far ptr InfoClr          ; vymaz n¡ informa‡n¡ho © dku

; ------ £vodn¡ ‡ st hl ¨en¡

         mov       si,offset CopyTxt1       ; text hl ¨en¡ - ‡ st 1
         test      byte ptr ds:[CopyParD],bit5 ; je kop¡rov n¡ ?
         jnz       CopyHls1                 ; je kop¡rov n¡
         mov       si,offset MoveTxt1       ; jinak p©ejmenov n¡
CopyHls1:call      far ptr InfoTxt          ; dek¢dov n¡ £vodn¡ ‡ sti textu

; ------ jm‚no souboru

         mov       si,offset FilePath       ; pln‚ jm‚no souboru
         add       si,ds:[FilePthN]         ; za‡ tek jm‚na souboru
         mov       cx,ds:[FileFilN]         ; d‚lka se jm‚nem souboru
         sub       cx,ds:[FilePthN]         ; d‚lka jm‚na souboru
         cmp       byte ptr ds:[si],"\"     ; je oddˆlova‡ adres ©e ?
         jne       CopyHls2                 ; nen¡ oddˆlova‡ adres ©e
         inc       si                       ; p©esko‡en¡ oddˆlova‡e adres ©e
         dec       cx                       ; sn¡‘en¡ d‚lky textu
CopyHls2:call      far ptr InfoDek          ; dek¢dov n¡ jm‚na souboru

; ------ druh  ‡ st textu

         mov       si,offset CopyTxt2       ; text hl ¨en¡ - ‡ st 2 "do"
         call      far ptr InfoTxt          ; dek¢dov n¡ druh‚ ‡ sti textu

; ------ c¡lov˜ soubor

         mov       si,offset CilPath        ; text c¡lov‚ho jm‚na
         mov       cx,ds:[CilPathN]         ; d‚lka jm‚na souboru
         call      far ptr InfoDek          ; dek¢dov n¡ jm‚na souboru

; ------ zobrazen¡ © dku

         test      byte ptr ds:[CopyParD],bit7 ; je p©esun na disku ?
         jz        CopyHls4                 ; nen¡ p©esun na disku
         call      far ptr InfoDisp         ; zobrazen¡ informa‡n¡ho © dku
         jmp       short CopyHls5

CopyHls4:xor       cx,cx                    ; CX <- 0 p©¡rustek nen¡
         call      far ptr InfoKurz         ; zobrazen¡ © dku s kurzorem

; ------ n vrat registr–

CopyHls5:pop       es
         pop       si
         pop       cx
         ret

CopyHlas ENDP

; -----------------------------------------------------------------------------
;        podm¡nˆn‚ hl ¨en¡ o na‡¡t n¡ informac¡ o disku
; -----------------------------------------------------------------------------

CopyIHls PROC      NEAR

         call      far ptr InfoAkt          ; test zobrazen¡ inf. © dku
         jnc       CopyIHl2                 ; informa‡n¡ © dek je ji‘ zobrazen
         push      ax
         push      si
         mov       al,ds:[CilPath]          ; c¡lov˜ disk
         mov       ds:[CopL3Ds2],al         ; ozna‡en¡ disku
         mov       si,offset CopL3Dsk       ; text "Na‡¡t m informace..."
         call      far ptr InfDisp0         ; hl ¨en¡ o na‡¡t n¡ informac¡
         pop       si
         pop       ax
CopyIHl2:ret

CopyIHls ENDP

CodeFil  ENDS

; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;
;
;                                 Data
;
;
; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°
;þ
Data     SEGMENT

; -----------------------------------------------------------------------------
;        kop¡rov n¡ soubor–
; -----------------------------------------------------------------------------

SKMnVert label     byte                   ;* menu verifikace soubor–

         db        2                        ; typ menu - vertik ln¡ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        5                        ; po‡et platn˜ch polo‘ek menu
         dw        6                        ; celkov˜ po‡et polo‘ek menu

         dw        SKMnVPol                 ; defini‡n¡ tabulka polo‘ek
         dw        SKMnVHlp                 ; n povˆda
         dw        Hlp@MenuKopirovaniSouboru ; ‡¡slo str nky velk‚ n povˆdy
         dw        SKMnVBlk                 ; blokovac¡ tabulka
         dw        0                        ; p©ep¡na‡e
         dw        SKMnVTit                 ; adresa titulu okna
         dw        SKMnVExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        36                       ; po‡ te‡n¡ pozice
         db        10                       ; po‡ te‡n¡ © dek
         db        20                       ; ¨¡©ka okna
         db        7                        ; v˜¨ka okna

SKMnVPol db        1,6,'Kurzor'
         db        1,8,'Ozna‡en‚'
         db        1,7,'Soubory'
         db        1,7,'V¨echny'
         db        1,6,'Zadan‚'

SKMnVBlk db        0,0,0,0,0

SKMnVTit db        10,'kop¡rov n¡'

HelpS    SEGMENT   BYTE PUBLIC
SKMnVHlp db        48,1
         dw        SKMnVHl1
         db        'souboru nebo adres ©e pod kurzorem (Alt-F5)'

         db        39,1
         dw        SKMnVHl1
         db        'ozna‡en˜ch soubor– a adres ©– (F5)'

         db        32,1
         dw        SKMnVHl1
         db        'v¨ech soubor– v aktivn¡m oknˆ'

         db        43,1
         dw        SKMnVHl1
         db        'v¨ech soubor– a adres ©– v aktivn¡m oknˆ'

         db        59,1
         dw        SKMnVHl1
         db        'soubor– a adres ©– podle bli‘¨¡ specifikace (Shift-F5)'
HelpS    ENDS

SKMnVHl1 db        11,'Kop¡rov n¡ '

SKMnVExe label     dword                    ; obsluhy voleb
         dd        CopyFil                  ; kurzor
         dd        CopyFil                  ; ozna‡en‚
         dd        CopyFil                  ; soubory
         dd        CopyFil                  ; v¨echny
         dd        CopyFil                  ; zadan‚

; -----------------------------------------------------------------------------
;       Volba soubor– ke kop¡rov n¡
; -----------------------------------------------------------------------------

SKZMLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SKZMLPol                 ; za‡ tek definice polo‘ek menu
         dw        SKZMLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@VyberSouboru         ; ‡¡slo str nky velk‚ n povˆdy
         dw        SKZMLBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SKZMLTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        46                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        HistFile                 ; identifik tor historie
         db        1                        ; po‡et p©edvoleb

         dw        3                        ; d‚lka p©edvolby
         dd        All                      ; p©edvolba

; ------ polo‘ky voleb

SKZMLPol db        bit6,30,'Zadejte soubory ke kop¡rov n¡:'
         db        0,0
         db        bit6+bit7,0
         db        1,8,'Pokra‡uj'
         db        1,6,'N vrat'

SKZMLBlk db        0,0,0                    ; blokovac¡ tabulka

SKZMLTit db        6,'zadan‚'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SKZMLHlp db        3,1
         dw        MenuFndH

         db        30,1
         dw        SKMnVHl1
         db        'zadan˜ch soubor– a adres ©–'

         db        3,1
         dw        MenuHlP1
HelpS    ENDS

; -----------------------------------------------------------------------------
;       Volba c¡le kop¡rov n¡
; -----------------------------------------------------------------------------

SK1MLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        6                        ; po‡et platn˜ch polo‘ek menu
         dw        8                        ; celkov˜ po‡et polo‘ek menu

         dw        SK1MLPol                 ; za‡ tek definice polo‘ek menu
         dw        SK1MLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        SK1MLBlk                 ; adresa blokovac¡ tabulky
         dw        SK1MLSwc                 ; adresa tabulky p©ep¡na‡–
         dw        SK1MLTit                 ; adresa titulu okna
         dw        SK1MLExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        70                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; v¨echny znaky (kv–li dlouh˜m jm‚n–m)
         db        0,'      '               ; zak zan‚ znaky

         db        HistFile                 ; identifik tor historie

SK1MLnPN db        0                        ; po‡et p©edvoleb

         dw        0                        ; d‚lka p©edvolby
         dd        0                        ; p©edvolba 1
         dw        0
         dd        0                        ; p©edvolba 2
;þ
; ------ polo‘ky voleb

SK1MLPol db        bit6,27,'Zkop¡ruji '
         db        1
SK1MLPlA dw        SK1MLPA1
         db        4,0,1
         dw        FileTxtP                 ; parametr
         db        0,4,1
SK1MLPlB dw        SK1MLPB1
         db        ' do:'

         db        0,0
         db        bit6+bit7,0
         db        1,6,'Proveƒ'
         db        bit7+1,14,'Aktualizovat '
SK1MLPl0 db        '-'
         db        bit7+1,8,'Kr tk  '
SK1MLPl1 db        '-'
         db        bit7+1,7,'Datum '
SK1MLPl2 db        '-'
         db        1,6,'N vrat'

SK1MLPA1 db        7,'soubor '              ; 1 soubor
SK1MLPA2 db        8,'adres © '
SK1MLPB1 db        0
SK1MLPB2 db        24,' ozna‡en˜ soubor/adres ©'
SK1MLPB3 db        26,' ozna‡en‚ soubory/adres ©e'
SK1MLPB4 db        28,' ozna‡en˜ch soubor–/adres ©–'
SK1MLPB5 db        22,'v¨echny soubory v oknˆ'
SK1MLPB6 db        33,'v¨echny soubory a adres ©e v oknˆ'
SK1MLPB7 db        25,'zadan‚ soubory a adres ©e'

SK1MLBlk db        0,0,0,0,0,0              ; blokovac¡ tabulka
SK1MLSwc db        0,0,0

SK1MLTit db        14,'c¡l kop¡rov n¡'

HelpS    SEGMENT   BYTE PUBLIC
SK1MLHlp db        3,1
         dw        SK1MLHl0
         db        31,'Kop¡rov n¡ ',1
SK1MLHlX dw        SK1MLHl1
         db        ' do zadan‚ho c¡le'

         db        3,1
         dw        SK1MLHlC

         db        26,'V¨echna dlouh ',1
         dw        SK1MLHlA
         db        'kr tk ',1
         dw        SK1MLHlB

         db        42,'Uchov vat/modifikovat datum a ‡as adres ©–'

         db        3,1
         dw        MenuHlP1
HelpS    ENDS

SK1MLHlA db        32,' jm‚na soubor– budou zmˆnˆna na '
SK1MLHlB db        15,' (WINDOWS 95)'
SK1MLHlC db        42,'Automatick˜ p©epis star¨¡ch soubor– nov˜mi'

SK1MLExe dd        Lin0MenR                 ; © dky
         dd        Lin0MenR                 ; start
         dd        SKMnLExA                 ; aktualizace
         dd        SKMnLExK                 ; kr tk  jm‚na
         dd        SKMnLExD                 ; datum
         dd        Lin0MenR                 ; n vrat

SK1MLHl0 db        59,'Syntaxe: adres ©\maska  / ASHR ashr  Ddatum  T‡as'
SK1MLHl1 db        7,'souboru'
SK1MLHl2 db        8,'adres ©e'
SK1MLHl5 db        16,'soubor–/adres ©–'

CopyTabH label     word                     ; tabulka n povˆd menu
         dw        SK1MLHL1                 ; kurzor - soubor
         dw        SK1MLHL2                 ; kurzor - adres ©
         dw        SK1MLHL5                 ; 1 ozna‡en˜ soubor/adres ©
         dw        SK1MLHL5                 ; 2 a‘ 4 ozna‡en‚ polo‘ky
         dw        SK1MLHL5                 ; 5 a v¡ce ozna‡en˜ch polo‘ek
         dw        SK1MLHL5                 ; v¨echny soubory
         dw        SK1MLHL5                 ; v¨echny soubory a adres ©e
         dw        SK1MLHL5                 ; zadan‚

CopyTbPA label     word                     ; tabulka polo‘ek menu - A
         dw        SK1MLPA1                 ; kurzor - soubor
         dw        SK1MLPA2                 ; kurzor - adres ©
         dw        SK1MLPB1                 ; 1 ozna‡en˜ soubor/adres ©
         dw        SK1MLPB1                 ; 2 a‘ 4 ozna‡en‚ polo‘ky
         dw        SK1MLPB1                 ; 5 a v¡ce ozna‡en˜ch polo‘ek
         dw        SK1MLPB1                 ; v¨echny soubory
         dw        SK1MLPB1                 ; v¨echny soubory a adres ©e
         dw        SK1MLPB1                 ; zadan‚

CopyTbPB label     word                     ; tabulka polo‘ek menu - B
         dw        SK1MLPB1                 ; kurzor - soubor
         dw        SK1MLPB1                 ; kurzor - adres ©
         dw        SK1MLPB2                 ; 1 ozna‡en˜ soubor/adres ©
         dw        SK1MLPB3                 ; 2 a‘ 4 ozna‡en‚ polo‘ky
         dw        SK1MLPB4                 ; 5 a v¡ce ozna‡en˜ch polo‘ek
         dw        SK1MLPB5                 ; v¨echny soubory
         dw        SK1MLPB6                 ; v¨echny soubory a adres ©e
         dw        SK1MLPB7                 ; zadan‚

; -----------------------------------------------------------------------------
;     hl ¨en¡ - existuje soubor stejn‚ho jm‚na jako kop¡rovan˜ soubor
; -----------------------------------------------------------------------------

CopyLD2  label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        6                        ; po‡et platn˜ch polo‘ek menu
         dw        14                       ; celkov˜ po‡et polo‘ek menu

         dw        CopyLD2P                 ; za‡ tek definice polo‘ek menu
         dw        CopyLD2H                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        CopyLD2B                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopyLD2T                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        6                        ; po‡ te‡n¡ © dek okna
         db        69                       ; ¨¡©ka okna
         db        13                       ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka textu © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit3                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        0                        ; historie specifikac¡ soubor–
         db        0                        ; po‡et p©edvoleb

; ------ polo‘ky voleb

CopyLD2P db        bit6,42,'Existuje ji‘ soubor stejn‚ho jm‚na '
         db        0,1
         dw        FileTxtP
         db        0,' !'

         db        bit6,9
CopLD2PA db        1
         dw        CopLD2P1
         db        1
         dw        CopLD2P0
         db        1
         dw        CopLD2P0

         db        bit6+bit7,0

         db        bit6,38,'              zdrojov˜:   p©episovan˜:'
CopLD2PV db        bit6,39,'Velikost: ',0,'                            '
CopLD2PD db        bit6,39,'   Datum: ',0,'                            '
CopLD2PT db        bit6,39,'     €as: ',0,'                            '

         db        bit6+bit7,0
         db        1,7,'P©epsat'
         db        1,7,'V¨echny'
         db        1,5,'Dal¨¡'
         db        1,12,'Nep©episovat'
         db        1,7,'Slou‡it'
         db        1,5,'Konec'

CopLD2P0 db        0
CopLD2P1 db        30,'Parametry soubor– jsou shodn‚.'
CopLD2P2 db        20,'Zdrojov˜ soubor je ',0
CopLD2P3 db        7,'novˆj¨¡'
CopLD2P4 db        6,'star¨¡'
CopLD2P5 db        5,'vˆt¨¡'
CopLD2P6 db        5,'men¨¡'
CopLD2P7 db        18,0,' ne‘ p©episovan˜.'

HelpS    SEGMENT   BYTE PUBLIC
CopyLD2H db        54,'P©epsat c¡lov˜ soubor kop¡rovan˜m/p©esouvan˜m souborem'
         db        45,'P©epsat v¨echny existuj¡c¡ soubory bez dotazu'
         db        39,'Nep©episovat soubor a pokra‡ovat dal¨¡m'
         db        42,'Nep©episovat ‘ dn˜ dal¨¡ existuj¡c¡ soubor'
         db        65,'P©idat kop¡rovan˜/p©esouvan˜ soubor na konec existuj¡c¡ho souboru'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

CopyLD2T db        15,'soubor existuje'

CopyLD2B db        0,0,0,0,0,0

; -----------------------------------------------------------------------------
;        na disku bude nedostatek m¡sta ke zkop¡rov n¡ cel‚ho souboru
; -----------------------------------------------------------------------------
;þ
CopL3Lin label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        4                        ; po‡et platn˜ch polo‘ek menu
         dw        11                       ; celkov˜ po‡et polo‘ek menu

         dw        CopL3Pol                 ; adresa defini‡n¡ tabulky polo‘ek
         dw        CopL3Hlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        CopL3Blk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopL3Tit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        6                        ; po‡ te‡n¡ pozice
         db        7                        ; po‡ te‡n¡ © dek
         db        68                       ; ¨¡©ka
         db        12                       ; v˜¨ka

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; dopl¤uj¡c¡ zak zan‚ znaky

         db        0                        ; identifik tor historie
         db        0                        ; po‡et p©edvoleb

CopL3Pol db        bit6,58,'Na disku ',0
CopL3Pl1 db        'A:',0,' ',1
CopL3P11 dw        CopL3P16
         db        ' dost m¡sta ke zkop¡rov n¡ souboru ',0,1
         dw        FileTxtP
         db        0,'.'

         db        bit6,3,1
CopL3P12 dw        CopL3P17

         db        bit6+bit7,0
CopL3Pl2 db        bit6,38,'celkov  kapacita disku: ',0,'             '
CopL3Pl3 db        bit6,38,'  voln‚ m¡sto na disku: ',0,'             '
CopL3Pl4 db        bit6,38,'po‘adovan‚ voln‚ m¡sto: ',0,'             '

         db        bit6+bit7,0
         db        1,10,'Pokra‡ovat'
         db        1,5,'Dal¨¡'
         db        1,9,'Nov˜ disk'
         db        1,5,'Konec'

HelpS    SEGMENT   BYTE PUBLIC
CopL3Hlp db        77,'Pokra‡ov n¡ ulo‘en¡m souboru nebo jeho ‡ sti do velikosti voln‚ho m¡sta disku'
         db        56,'Soubor se nebude kop¡rovat - pokra‡ov n¡ dal¨¡m souborem'
         db        48,'Zobrazen¡ informac¡ o nov‚m disku po jeho v˜mˆnˆ'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

CopL3P16 db        4,'nen¡'
CopL3P17 db        2,'je'
CopL3P18 db        48,'Vymˆ¤te disk nebo rozdˆlte soubor na v¡ce ‡ st¡.'
CopL3P19 db        28,'M–‘ete pokra‡ovat v operaci.'

CopL3Blk db        0,0,0,0

CopL3Tit db        9,'disk pln˜'

; -----------------------------------------------------------------------------
;        nalezen¡ souboru s atributem R/O
; -----------------------------------------------------------------------------

CopL4Lin label     byte

         db        3                        ; typ menu - © dkov‚ menu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        5                        ; po‡et platn˜ch polo‘ek menu
         dw        8                        ; celkov˜ po‡et polo‘ek menu

         dw        CopL4Pol                 ; adresa defini‡n¡ tabulky polo‘ek
         dw        CopL4Hlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@KopirovaniSouboru    ; ‡¡slo str nky velk‚ n povˆdy
         dw        CopL4Blk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        CopL4Tit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        6                        ; po‡ te‡n¡ pozice
         db        7                        ; po‡ te‡n¡ © dek
         db        64                       ; ¨¡©ka
         db        8                        ; v˜¨ka

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        0                        ; celkov˜ po‡et © dk–
         dw        0                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; dopl¤uj¡c¡ zak zan‚ znaky

         db        0                        ; identifik tor historie
         db        0                        ; po‡et p©edvoleb

CopL4Pol db        bit6,52,'Soubor ',0,1
         dw        FileTxtP                 ; buffer jm‚na souboru
         db        0,' je chr nˆn proti p©episu atributem R/O.'

         db        bit6,33,'P©ejete si jej i p©esto p©epsat ?'

         db        bit6+bit7,0
         db        1,7,'P©epsat'
         db        1,7,'V¨echny'
         db        1,5,'Dal¨¡'
         db        1,12,'Nep©episovat'
         db        1,5,'Konec'

CopL4Blk db        0,0,0,0,0

CopL4Tit db        11,'atribut R/O'

HelpS    SEGMENT   BYTE PUBLIC
CopL4Hlp db        50,'P©epis tohoto souboru (s nulov n¡m atributu R/O)'
         db        63,'P©epis v¨ech n sleduj¡c¡ch soubor– s atributem R/O bez dotazu'
         db        43,'Pokra‡ov n¡ d le bez p©episu tohoto souboru'
         db        56,'Nep©episovat ‘ dn˜ dal¨¡ soubor ozna‡en˜ atributem R/O'
         db        3,1
         dw        MenuHlP2
HelpS    ENDS

; -----------------------------------------------------------------------------
;        p©esun soubor–
; -----------------------------------------------------------------------------
;þ
SJMnVert label     byte

         db        2                        ; typ menu - vertik ln¡ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka volby
         dw        5                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SKMnVPol                 ; defini‡n¡ tabulka polo‘ek
         dw        SJMnVHlp                 ; n povˆda
         dw        Hlp@MenuPrejmenovaniAPresun ; ‡¡slo str nky velk‚ n povˆdy
         dw        SJMnVBlk                 ; blokovac¡ tabulka
         dw        0                        ; p©ep¡na‡e
         dw        SJMnVTit                 ; adresa titulu okna
         dw        SJMnVExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        36                       ; po‡ te‡n¡ pozice
         db        10                       ; po‡ te‡n¡ © dek
         db        20                       ; ¨¡©ka okna
         db        7                        ; v˜¨ka okna

SJMnVBlk db        0,0,0,0,0

SJMnVTit db        12,'jm‚no/p©esun'

HelpS    SEGMENT   BYTE PUBLIC
SJMnVHlp db        65,'P©ejmenov n¡/p©esun souboru nebo adres ©e pod kurzorem (Alt-F6)'
         db        56,'P©ejmenov n¡/p©esun ozna‡en˜ch soubor– a adres ©– (F6)'
         db        49,'P©ejmenov n¡/p©esun v¨ech soubor– v aktivn¡m oknˆ'
         db        60,'P©ejmenov n¡/p©esun v¨ech soubor– a adres ©– v aktivn¡m oknˆ'
         db        76,'P©ejmenov n¡/p©esun soubor– a adres ©– podle bli‘¨¡ specifikace (Shift-F6)'
HelpS    ENDS

SJMnVExe label     dword                    ; obsluhy voleb
         dd        MoveFil                  ; kurzor
         dd        MoveFil                  ; ozna‡en‚
         dd        MoveFil                  ; adres ©
         dd        MoveFil                  ; podadres ©e
         dd        MoveFil                  ; zadan‚

; -----------------------------------------------------------------------------
;       Volba soubor– k p©esunu
; -----------------------------------------------------------------------------

SJZMLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        3                        ; po‡et platn˜ch polo‘ek menu
         dw        5                        ; celkov˜ po‡et polo‘ek menu

         dw        SJZMLPol                 ; za‡ tek definice polo‘ek menu
         dw        SJZMLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@VyberSouboru         ; ‡¡slo str nky velk‚ n povˆdy
         dw        SJZMLBlk                 ; adresa blokovac¡ tabulky
         dw        0                        ; adresa tabulky p©ep¡na‡–
         dw        SJZMLTit                 ; adresa titulu okna
         dw        LinMenTE                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        45                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; maska zad van˜ch znak–
         db        0,'      '               ; zak zan‚ znaky

         db        HistFile                 ; identifik tor historie
         db        1                        ; po‡et p©edvoleb

         dw        3                        ; d‚lka p©edvolby
         dd        All                      ; p©edvolba

; ------ polo‘ky voleb

SJZMLPol db        bit6,39,'Zadejte soubory k p©ejmenov n¡/p©esunu:'
         db        0,0
         db        bit6+bit7,0
         db        1,6,'Proveƒ'
         db        1,6,'N vrat'

SJZMLBlk db        0,0,0                    ; blokovac¡ tabulka

SJZMLTit db        6,'zadan‚'

; ------ n povˆda

HelpS    SEGMENT   BYTE PUBLIC
SJZMLHlp db        3,1
         dw        MenuFndH
         db        47,'P©ejmenov n¡/p©esun zadan˜ch soubor– a adres ©–'
         db        3,1
         dw        MenuHlP1
HelpS    ENDS

; -----------------------------------------------------------------------------
;       Volba c¡le p©esunu
; -----------------------------------------------------------------------------

SJ1MLin  label     byte

         db        3                        ; typ menu - © dkov‚ podmenu

         db        0                        ; hladina k zobrazen¡ menu
         dw        1                        ; aktivn¡ polo‘ka menu
         dw        6                        ; po‡et platn˜ch polo‘ek menu
         dw        8                        ; celkov˜ po‡et polo‘ek menu

         dw        SJ1MLPol                 ; za‡ tek definice polo‘ek menu
         dw        SJ1MLHlp                 ; adresa tabulky text– n povˆdy
         dw        Hlp@Prejmenovaniapresun  ; ‡¡slo str nky velk‚ n povˆdy
         dw        SJ1MLBlk                 ; adresa blokovac¡ tabulky
         dw        SJ1MLSwc                 ; adresa tabulky p©ep¡na‡–
         dw        SJ1MLTit                 ; adresa titulu okna
         dw        SK1MLExe                 ; tabulka obsluh voleb menu
         dw        LinMenTM                 ; tabulka adres podmenu
         dd        0                        ; n vratov  adresa p©i p©eru¨en¡

         db        23                       ; po‡ te‡n¡ pozice okna
         db        7                        ; po‡ te‡n¡ © dek okna
         db        70                       ; ¨¡©ka okna
         db        8                        ; v˜¨ka okna

         dw        255                      ; maxim ln¡ d‚lka © dku
         dw        0                        ; prvn¡ zobrazen˜ © dek
         dw        0                        ; aktivn¡ zobrazen˜ © dek
         dw        1                        ; celkov˜ po‡et © dk–
         dw        1                        ; po‡et zobrazen˜ch © dk–

         db        bit2                     ; v¨echny znaky (kv–li dlouh˜m jm‚n–m)
         db        0,'      '               ; zak zan‚ znaky

         db        HistFile                 ; identifik tor historie

SJ1MLnPN db        0                        ; po‡et p©edvoleb

         dw        0                        ; d‚lka p©edvolby
         dd        0                        ; p©edvolba 1
         dw        0
         dd        0                        ; p©edvolba 2

; ------ polo‘ky voleb

SJ1MLPol db        bit6,36,'P©ejmenuji/p©esunu '
         db        1
SJ1MLPlA dw        SK1MLPA1
         db        4,0,1
         dw        FileTxtP                 ; parametr
         db        0,4,1
SJ1MLPlB dw        SK1MLPB1
         db        ' do:'

         db        0,0
         db        bit6+bit7,0
         db        1,6,'Proveƒ'
         db        bit7+1,14,'Aktualizovat '
SJ1MLPl0 db        '-'
         db        bit7+1,8,'Kr tk  '
SJ1MLPl1 db        '-'
         db        bit7+1,7,'Datum '
SJ1MLPl2 db        '-'
         db        1,6,'N vrat'

SJ1MLBlk db        0,0,0,0,0,0              ; blokovac¡ tabulka
SJ1MLSwc db        0,0,0

SJ1MLTit db        24,'c¡l p©ejmenov n¡/p©esunu'

HelpS    SEGMENT   BYTE PUBLIC
SJ1MLHlp db        3,1
         dw        SK1MLHl0
         db        40,'P©ejmenov n¡/p©esun ',1
SJ1MLHlX dw        SK1MLHl1
         db        ' do zadan‚ho c¡le'

         db        3,1
         dw        SK1MLHlC

         db        26,'V¨echna dlouh ',1
         dw        SK1MLHLA
         db        'kr tk ',1
         dw        SK1MLHlB

         db        42,'Uchov vat/modifikovat datum a ‡as adres ©–'

         db        3,1
         dw        MenuHlP1
HelpS    ENDS

; -----------------------------------------------------------------------------
;        data pro kop¡rov n¡ soubor–
; -----------------------------------------------------------------------------

CopyParD db        0                        ; parametry pro kop¡rov n¡
                                            ;  bit 0: 1=c¡lov˜ soubor byl vytvo©en
                                            ;         (aby jej bylo mo‘n‚ zru¨it
                                            ;          p©i ne£spˆ¨n‚ operaci)
                                            ;  bit 1: 1=neplatn‚ disk. informace
                                            ;  bit 2: 1=p©episovan˜ soubor zru¨en
                                            ;         (nelze jej ji‘ pou‘¡t ke
                                            ;          zv˜¨en¡ voln‚ho m¡sta)
                                            ;  bit 3: 1=vytvo©en p©echodn˜ soubor
                                            ;  bit 4:
                                            ;  bit 5: 1=kop¡rov n¡
                                            ;  bit 6: 1=p©esun mezi disky
                                            ;  bit 7: 1=p©esun na disku

;CopyPrD2 db        bit2                     ; parametry pro kop¡rov n¡ a p©esun
;                                            ;  bit 0: 1=aktualizace soubor–
;                                            ;  bit 1: 1=zmˆna na kr tk  jm‚na
;                                            ;  bit 2: 1=uchov vat datum a ‡as adres ©–
;
;                                            ;  bit 5: 1=c¡l m  dlouh‚ jm‚no
;                                            ;  bit 6: 1=dlouh  maska se neuplatn¡
;                                            ;         (nastaveno v InitFCil)
;                                            ;  bit 7: 1=c¡lov‚ jm‚no zru¨eno
;                                            ;         (nastaveno v InitFCil)

ExistPar db        0                        ; parametry pro existuj¡c¡ soubor
                                            ;  bit 0: 1=byl nalezen c¡lov˜ soubor
                                            ;          (nenuluje se p©i zru¨en¡
                                            ;           souboru a nenastavuje se
                                            ;           p©i vytvo©en¡ souboru)
                                            ;  bit 1: 1=p©epis souboru
                                            ;  bit 2: 1=p©epis v¨ech soubor–
                                            ;  bit 3: 1=p©esko‡en¡ souboru
                                            ;  bit 4: 1=p©esko‡en¡ v¨ech soubor–
                                            ;  bit 5: 1=p©ipojen¡ souboru
                                            ;  bit 6: 1=c¡lem znakov‚ za©¡zen¡
                                            ;  bit 7: 1=pokra‡ov n¡ dal¨¡m diskem
                                            ;         (byl dokon‡en z pis na jeden
                                            ;          disk, bude nutn˜ dal¨¡ disk)

CopyRusP db        0                        ; parametry pro ru¨en¡ p©i kop¡r.
                                            ;  bit 0: 1=p©episovat v¨echny R/O
                                            ;  bit 1: 1=p©esko‡it v¨echny R/O

CopyDFre dd        0                        ; voln‚ m¡sto disku
CopyDFr0 dd        0                        ; voln‚ m¡sto po p©episu souboru
CopyDMax dd        0                        ; celkov  kapacita disku
CopyDBlk dw        0                        ; velikost jednoho bloku disku
CopyDSiz dd        0                        ; zb˜vaj¡c¡ velikost souboru
CopyDRea dd        0                        ; ukazatel na‡ten˜ch dat ze souboru
CopyDUlo dd        0                        ; ‡¡ta‡ ulo‘en˜ch dat na 1 disku

CilTempF db        FileMax+1 dup(0)         ; p©echodn˜ c¡lov˜ soubor

;FileIdnt dw        0                        ; identifik tor zdrojov‚ho souboru
;CilIdent dw        0                        ; identifik tor c¡lov‚ho souboru

CilDTA   label     byte
         db        DTAMax dup(0)            ; buffer DTA p©episovan‚ho souboru

; ------ polo‘ka simuluj¡c¡ polo‘ku seznamu soubor–

CilFPol  label     byte
CilFAtr  db        0                        ; atributy nalezen‚ho souboru
CilFCB   db        11 dup(0)                ; jm‚no souboru ve tvaru FCB
CilFSize dd        0                        ; velikost nalezen‚ho souboru
CilFDate dw        0                        ; datum nalezen‚ho souboru
CilFTime dw        0                        ; ‡as nalezen‚ho souboru
CilFPol0 label     byte

CopyTxt1 db        10,'Kop¡ruji ',0
CopyTxt2 db        6,0,' do ',0
MoveTxt1 db        11,'P©esouv m ',0
CopL3Dsk db        28,'Na‡¡t m informace o disku '
CopL3Ds2 db        'A:'

Data     ENDS
         END
