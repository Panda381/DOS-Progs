CONTEXT   0 241   0   3  89
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
     Modul IO.SYS                         - # -

; MODUL IO.SYS



0000  e91732         jmp    321a                 ; start modulu IO.SYS

                                                 ; obsluha diskov‚ho za©¡zen¡
0003                 db     18h                  ; max.‡¡slo povelu diskov‚ho za©¡zen¡
0004                 dw     1f25h                ; 00h (inicializace za©¡zen¡)
0006                 dw     0a97h                ; 01h (kontrola m‚dia)
0008                 dw     0b47h                ; 02h (vystavˆn¡ BPB)
000a                 dw     06e0h                ; 03h (vstup IOCTL)
000c                 dw     0e3eh                ; 04h (vstup ze za©¡zen¡)
000e                 dw     06dch                ; 05h (nedestruktivn¡ vstup)
0010                 dw     06f7h                ; 06h (status vstupu)
0012                 dw     06f7h                ; 07h (vy‡i¨tˆn¡ vstupu)
0014                 dw     0e2ch                ; 08h (v˜stup na za©¡zen¡)
0016                 dw     0e23h                ; 09h (v˜stup s verifikac¡)
0018                 dw     06f7h                ; 0ah (status v˜stupu)
001a                 dw     06f7h                ; 0bh (vypr zdnˆn¡ v˜stupu)
001c                 dw     06e0h                ; 0ch (v˜stup IOCTL)
001e                 dw     2134h                ; 0dh (otev©en¡ za©¡zen¡)
0020                 dw     213dh                ; 0eh (uzav©en¡ za©¡zen¡)
0022                 dw     0de9h                ; 0fh (p©enositelnost m‚dia)
0024                 dw     06f7h                ; 10h
0026                 dw     06f7h                ; 11h
0028                 dw     06f7h                ; 12h
002a                 dw     161fh                ; 13h (generov n¡ po‘adavku IOCTL)
002c                 dw     06f7h                ; 14h
002e                 dw     06f7h                ; 15h
0030                 dw     06f7h                ; 16h
0032                 dw     1aa8h                ; 17h (poskytnut¡ logick‚ho za©¡zen¡)
0034                 dw     1acch                ; 18h (nastaven¡ logick‚ho za©¡zen¡)
0036                 db     0

                                                 ; obsluha za©¡zen¡ CON
0037                 db     0ah                  ; max. ‡¡slo povelu CON
0038                 dw     06f7h                ; 00h (inicializace za©¡zen¡)
003a                 dw     06f7h                ; 01h (kontrola m‚dia)
003c                 dw     06f7h                ; 02h (vystavˆn¡ BPB)
003e                 dw     06e0h                ; 03h (vstup znaku IOCTL)
0040                 dw     0724h                ; 04h (vstup ©etˆzce ze za©¡zen¡)
0042                 dw     076ch                ; 05h (nedestruktivn¡ vstup)
0044                 dw     06f7h                ; 06h (status vstupu)
0046                 dw     07d0h                ; 07h (vy‡i¨tˆn¡ vstupu z CON)
0048                 dw     07e8h                ; 08h (v˜stup ©etˆzce na CON)
004a                 dw     07e8h                ; 09h (v˜stup s verifikac¡)
004c                 dw     06f7h                ; 0ah (status v˜stupu)
004e                 db     0

                                                 ; obsluha za©¡zen¡ AUX a COM
004f                 db     0ah                  ; max. ‡¡slo povelu AUX, COM
0050                 dw     06f7h                ; 00h (inicializace za©¡zen¡)
0052                 dw     06f7h                ; 01h (kontrola m‚dia)
0054                 dw     06f7h                ; 02h (vystavˆn¡ BPB)
0056                 dw     06e0h                ; 03h (vstup IOCTL)
0058                 dw     07fch                ; 04h (vstup ze za©¡zen¡)
005a                 dw     0827h                ; 05h (nedestruktivn¡ vstup)
005c                 dw     06f7h                ; 06h (status vstupu)
005e                 dw     0865h                ; 07h (vy‡i¨tˆn¡ vstupu)
0060                 dw     086eh                ; 08h (v˜stup ©etˆzce na COM)
0062                 dw     086eh                ; 09h (v˜stup ©etˆzce na COM)
0064                 dw     084ah                ; 0ah (status v˜stupu COM)
0066                 db     0

                                                 ; obsluha za©¡zen¡ CLOCK$
0067                 db     9                    ; max. ‡¡slo povelu CLOCK$
0068                 dw     06f7h                ; 00h (inicializace za©¡zen¡)
006a                 dw     06f7h                ; 01h (kontrola m‚dia)
006c                 dw     06f7h                ; 02h (vystavˆn¡ BPB)
006e                 dw     06e0h                ; 03h (vstup IOCTL)
0070                 dw     0a0eh                ; 04h (vstup ze za©¡zen¡)
0072                 dw     06dch                ; 05h (nedestruktivn¡ vstup)
0074                 dw     06f7h                ; 06h (status vstupu)
0076                 dw     06f7h                ; 07h (vy‡i¨tˆn¡ vstupu)
0078                 dw     096fh                ; 08h (v˜stup na za©¡zen¡)
007a                 dw     096fh                ; 09h (v˜stup s verifikac¡)
007c                 db     0

                                                 ; obsluha za©¡zen¡ PRN, LPT
007d                 db     18h                  ; max. ‡¡slo povelu PRN, LPT
007e                 dw     06f7h                ; 00h (inicializace za©¡zen¡)
0080                 dw     06f7h                ; 01h (kontrola m‚dia)
0082                 dw     06f7h                ; 02h (vystavˆn¡ BPB)
0084                 dw     06e0h                ; 03h (vstup IOCTL)
0086                 dw     06eeh                ; 04h (vstup ze za©¡zen¡)
0088                 dw     06dch                ; 05h (nedestruktivn¡ vstup)
008a                 dw     06f7h                ; 06h (status vstupu)
008c                 dw     06f7h                ; 07h (vy‡i¨tˆn¡ vstupu)
008e                 dw     0892h                ; 08h (v˜stup ©etˆzce na LPT)
0090                 dw     0892h                ; 09h (v˜stup ©etˆzce na LPT)
0092                 dw     08b4h                ; 0ah (status v˜stupu)
0094                 dw     06f7h                ; 0bh (vypr zdnˆn¡ v˜stupu)
0096                 dw     06f7h                ; 0ch (v˜stup IOCTL)
0098                 dw     06f7h                ; 0dh (otev©en¡ za©¡zen¡)
009a                 dw     06f7h                ; 0eh (uzav©en¡ za©¡zen¡)
009c                 dw     06f7h                ; 0fh (p©enositelnost m‚dia)
009e                 dw     08ddh                ; 10h (v˜stup ©etˆzce na tisk rnu)
00a0                 dw     08ddh                ; 11h (v˜stup ©etˆzce na tisk rnu)
00a2                 dw     06f7h                ; 12h
00a4                 dw     0923h                ; 13h (generov n¡ po‘adavku IOCTL)
00a6                 dw     06f7h                ; 14h 
00a8                 dw     06f7h                ; 15h 
00aa                 dw     06f7h                ; 16h 
00ac                 dw     06e0h                ; 17h (poskytnut¡ logick‚ho za©¡zen¡)
00ae                 dw     06e0h                ; 18h (nastaven¡ logick‚ho za©¡zen¡)


00b0                 dd     "6895"               ; p–vodn¡ adresa INT 13H

00b4                 dw     3132h ("21")         ; p–vodn¡ adresa INT 13H - LOW pro obsluhu 2
00b6                 dw     0                    ; p–vodn¡ adresa INT 13H - HIGH pro obsluhu 2

00b8                 dw     0                    ; adresa z hlav¡ po‘adavku - LOW
00ba                 dw     0                    ; adresa z hlav¡ po‘adavku - HIGH

00bc                 db     4 dup (0)            ; buffery pro £schovu znak– z COM

00c0                 dw     0                    ; £schova registru AX p©i p©eru¨en¡ INT 13h
00c2                 dw     0


00c0                 dw     84 dup (0)


016c                 dw     0                    ; ‡¡slo portu COM, PRN

                                                 ; z hlav¡ driver–

                                                 ; z hlav¡ za©¡zen¡ CON
016e                 dw     0180h                ; n sleduj¡c¡ driver (AUX)
0170                 dw     0070h                ; segment n sleduj¡c¡ho driveru
0172                 dw     8013h                ; atributy za©¡zen¡
0174                 dw     062ah                ; adresa rutiny STRATEGIE
0176                 dw     0635h                ; adresa rutiny PžERU›EN‹
0178                 db     'CON     '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ AUX
0180                 dw     0192h                ; n sleduj¡c¡ driver (PRN)
0182                 dw     0070h                ; segment n sleduj¡c¡ho driveru
0184                 dw     8000h                ; atributy za©¡zen¡
0186                 dw     062ah                ; adresa rutiny STRATEGIE
0188                 dw     063bh                ; adresa rutiny PžERU›EN‹
018a                 db     'AUX     '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ PRN
0192                 dw     01a4h                ; n sleduj¡c¡ driver (CLOCK$)
0194                 dw     0070h                ; segment n sleduj¡c¡ho driveru
0196                 dw     a040h                ; atributy za©¡zen¡
0198                 dw     062ah                ; adresa rutiny STRATEGIE
019a                 dw     0658h                ; adresa rutiny PžERU›EN‹
019c                 db     'PRN     '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ CLOCK$
01a4                 dw     01b6h                ; n sleduj¡c¡ driver
01a6                 dw     0070h                ; segment n sleduj¡c¡ho driveru
01a8                 dw     8008h                ; atributy za©¡zen¡
01aa                 dw     062ah                ; adresa rutiny STRATEGIE
01ac                 dw     067eh                ; adresa rutiny PžERU›EN‹
01ae                 db     'CLOCK$  '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ diskov˜ch za©¡zen¡
01b6                 dw     01cah                ; n sleduj¡c¡ driver (COM1)
01b8                 dw     0070h                ; segment n sleduj¡c¡ho driveru
01ba                 dw     0842h                ; atributy za©¡zen¡
01bc                 dw     062ah                ; adresa rutiny STRATEGIE
01be                 dw     0684h                ; adresa rutiny PžERU›EN‹
01c0                 db     4                    ; celkov˜ po‡et disk–
01c1                 db     0feh                 ; ‡¡slo disku
01c2                 db     0                    ; p©¡znak logick‚ho disku (=0)
01c3                 db     0                    ; 1=p©¡znak mo‘n‚ indik. v˜mˆny
01c4                 db     0                    ; 1=p©¡znak, ‘e je logick˜ disk
01c5                 db     0                    ; 1=p©¡znak inicializace hodin
01c6                 dw     0

01c8                 db     6bh,6ah

                                                 ; z hlav¡ za©¡zen¡ COM1
01ca                 dw     01dch                ; n sleduj¡c¡ driver (LPT1)
01cc                 dw     0070h                ; segment n sleduj¡c¡ho driveru
01ce                 dw     8000h                ; atributy za©¡zen¡
01d0                 dw     062ah                ; adresa rutiny STRATEGIE
01d2                 dw     063bh                ; adresa rutiny PžERU›EN‹
01d4                 db     'COM1    '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ LPT1
01dc                 dw     01eeh                ; n sleduj¡c¡ driver (LPT2)
01de                 dw     0070h                ; segment n sleduj¡c¡ho driveru
01e0                 dw     a040h                ; atributy za©¡zen¡
01e2                 dw     062ah                ; adresa rutiny STRATEGIE
01e4                 dw     065eh                ; adresa rutiny PžERU›EN‹
01e6                 db     'LPT1    '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ LPT2
01ee                 dw     0200h                ; n sleduj¡c¡ driver (LPT3)
01f0                 dw     0070h                ; segment n sleduj¡c¡ho driveru
01f2                 dw     a040h                ; atributy za©¡zen¡
01f4                 dw     062ah                ; adresa rutiny STRATEGIE
01f6                 dw     0666h                ; adresa rutiny PžERU›EN‹
01f8                 db     'LPT2    '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ LPT3
0200                 dw     0212h                ; n sleduj¡c¡ driver (COM2)
0202                 dw     0070h                ; segment n sleduj¡c¡ho driveru
0204                 dw     a040h                ; atributy za©¡zen¡
0206                 dw     062ah                ; adresa rutiny STRATEGIE
0208                 dw     066eh                ; adresa rutiny PžERU›EN‹
020a                 db     'LPT3    '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ COM2
0212                 dw     0224h                ; n sleduj¡c¡ driver (COM3)
0214                 dw     0070h                ; segment n sleduj¡c¡ho driveru
0216                 dw     8000h                ; atributy za©¡zen¡
0218                 dw     062ah                ; adresa rutiny STRATEGIE
021a                 dw     0641h                ; adresa rutiny PžERU›EN‹
021c                 db     'COM2    '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ COM3
0224                 dw     0236h                ; n sleduj¡c¡ driver (COM4)
0226                 dw     0070h                ; segment n sleduj¡c¡ho driveru
0228                 dw     8000h                ; atributy za©¡zen¡
022a                 dw     062ah                ; adresa rutiny STRATEGIE
022c                 dw     0647h                ; adresa rutiny PžERU›EN‹
022e                 db     'COM3    '           ; jm‚no za©¡zen¡

                                                 ; z hlav¡ za©¡zen¡ COM4
0236                 dw     ffffh                ; n sleduj¡c¡ driver-je posledn¡
0238                 dw     0070h                ; segment n sleduj¡c¡ho driveru
023a                 dw     8000h                ; atributy za©¡zen¡
023c                 dw     062ah                ; adresa rutiny STRATEGIE
023e                 dw     064dh                ; adresa rutiny PžERU›EN‹
0240                 db     'COM4    '           ; jm‚no za©¡zen¡

0248                 dw     1f31h
024a                 dw     0070h


                                                 ; aktu ln¡ logick˜ disk
024c                 dw     0484h                ; adresa tabulky pro mechaniku 1
024e                 dw     0070h                ; (segment)
0250                 db     0                    ; aktu ln¡ fyzick˜ disk
0251                 db     0ffh                 ; aktu ln¡ logick˜ disk
0252                 dw     0
0254                 db     0                    ; popisova‡ m‚dia
0255                 db     90h
0256                 db     2                    ; po‘adovan  operace s diskem
0257                 db     0                    ; 1=po‘adov na verifikace po z pisu
0258                 dw     0                    ; po‡et sektor– pro disk. operaci
025a                 db     63h                  ; po‡et disketov˜ch mechanik
025b                 db     0                    ; doba pro start motoru disket. mechaniky
025c                 db     0                    ; doba pro ust len¡ hlavy mechaniky
025d                 db     0                    ; po‡et sektor– pro disk. operaci
025e                 db     0
025f                 db     0
0260                 db     9                    ; max. po‡et sektor– na stopu pro disky
0261                 db     90h
0262                 dd     0                    ; ukazatel diskov˜ch parametr– INT 1EH
0266                 db     0                    ; ‡¡slo sektoru pro disk. operaci
0267                 db     0                    ; hlava pro disk. operaci
0268                 dw     0                    ; ‡¡slo stopy pro disk. operaci
026a                 dw     0                    ; £schova ukazatele z sobn¡ku
026c                 db     8


0263   00 00 00 00 00 00 00 00 00 08 00 00 00 50 CC 80   .............P..
0273   40 10 08 06 04 03 00 0A 02 06 04 04 0F 08 00 0C   @...............

0284                 db     512 dup(0)           ; buffer pro na‡ten¡ sektoru

0283   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0293   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
02A3   00 00 00 00 00 00 00 00 00 00 00 00 20 20 20 20   ............
02B3   20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 00                  .
02C3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
02D3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
02E3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
02F3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0303   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0313   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0323   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0333   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0343   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0353   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0363   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0373   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0383   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0393   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
03A3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
03B3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
03C3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
03D3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
03E3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
03F3   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0403   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0413   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0423   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0433   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0443   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0453   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0463   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0473   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................


0483   00 E8 04 70 00 00 00 00 02 FF 01 00 02 40 00 68   ...p.........@.h

þ                                                 ; disketov  mechanika 1
0484                 dw     04e8h                ; [DI+00h] n sleduj¡c¡ diskov  jednotka
0486                 dw     0070h                ; [DI+02h] (segment)
0488                 db     0                    ; [DI+04h] fyzick˜ disk
0489                 db     0                    ; [DI+05h] logick˜ disk
                                                 ; blok diskov˜ch parametr– BPB - disketa 1
048a                 dw     0200h                ; [DI+06h] po‡et bajt– na sektor
048c                 db     0ffh                 ; [DI+08h] po‡et sektor– na aloka‡n¡ blok
048d                 dw     0001h                ; [DI+09h] po‡et zav dˆc¡ch a rezervovan˜ch sektor–
048f                 db     2                    ; [DI+0Bh] po‡et aloka‡n¡ch tabulek FAT
0490                 dw     0040h                ; [DI+0Ch] max.po‡et polo‘ek z kl.adres ©e
0492                 dw     0168h                ; [DI+0Eh] po‡et sektor– na m‚diu
0494                 db     0                    ; [DI+10h] popisova‡ m‚dia
0495                 dw     0002h                ; [DI+11h] po‡et sektor– v jedn‚ tabulce FAT
0497                 dw     9                    ; [DI+13h] po‡et sektor– na stopu
0499                 dw     1                    ; [DI+15h] po‡et stran m‚dia
049b                 dw     0                    ; [DI+17h] ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
049d                 dw     0                    ; [DI+19h] ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
049f                 dw     0                    ; [DI+1bh] celkov˜ po‡et sektor– odd¡lu - LOW
04a1                 dw     0                    ; [DI+1dh] celkov˜ po‡et sektor– odd¡lu - HIGH
04a3                 db     0                    ; [DI+1fh] typ FAT (40h=FAT16)
04a4                 dw     0                    ; [DI+20h] ‡¡ta‡ otev©en¡ disku
04a6                 db     3                    ; [DI+22h] typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
04a7                 dw     0020h                ; [DI+23h] 0020h=nen¡ logick˜ disk
                                                 ;          0040h=m‚dium bylo vymˆnˆno
04a9                 dw     0028h                ; [DI+25h] po‡et stop na disku


04A3   00 00 00 03 20 00 28 00 00 02 01 01 00 02 E0 00   .... .(.........
04B3   68 01 F0 02 00 09 00 02 00 00 00 00 00 00 00 00   h...............



04b8                 dw     0009h                ; [DI+34] po‡et sektor– na stopu
04ba                 dw     0002h                ; [DI+36] po‡et hlav disku


04C3   00 00 00 00 00 00 00 FF FF FF FF FF 4E 4F 20 4E   ............NO N


04cb                 dd     0ffffffffh           ; [DI+47h] ‡as posledn¡ diskov‚ operace
; 04cd               dw     0ffffh               ; [DI+49h] v lec za‡ tku odd¡lu pevn‚ho disku
04cf                 db     'NO NAME    ',0      ; [DI+4bh] identifikace disku
05db                 dw     0                    ; [DI+57h] s‚riov‚ ‡¡slo - datum
05dd                 dw     0                    ; [DI+59] s‚riov‚ ‡¡slo - ‡as
04df                 db     'FAT12   ',0         ; [DI+5bh] identifikace FAT


                                                 ; disketov  mechanika 2
04e8                 dw     054ch                ; [DI+00h] adresa tabulky pro mechaniku 4
04ea                 dw     0070h                ; [DI+02h]
04ec                 db     0                    ; [DI+04h] fyzick˜ disk 2
04ed                 db     0                    ; [DI+05h] logick˜ disk 2
                                                 ; blok diskov˜ch parametr– BPB - disketa 2
04ee                 dw     0200h                ; [DI+06h] po‡et bajt– na sektor
04f0                 db     0ffh                 ; [DI+08h] po‡et sektor– na aloka‡n¡ blok
04f1                 dw     0001h                ; [DI+09h] po‡et zav dˆc¡ch a rezervovan˜ch sektor–
04f3                 db     2                    ; [DI+0Bh] po‡et aloka‡n¡ch tabulek FAT
04f4                 dw     0040h                ; [DI+0Ch] max.po‡et polo‘ek z kl.adres ©e
04f6                 dw     0168h                ; [DI+0Eh] po‡et sektor– na m‚diu
04f8                 db     0                    ; [DI+10h] popisova‡ m‚dia
04f9                 dw     0002h                ; [DI+11h] po‡et sektor– v jedn‚ tabulce FAT
04fb                 dw     9                    ; [DI+13h] po‡et sektor– na stopu
04fd                 dw     1                    ; [DI+15h] po‡et stran m‚dia
04ff                 dw     0                    ; [DI+17h] ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
0501                 dw     0                    ; [DI+19h] ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
0503                 dw     0                    ; [DI+1bh] celkov˜ po‡et sektor– odd¡lu - LOW
0505                 dw     0                    ; [DI+1dh] celkov˜ po‡et sektor– odd¡lu - HIGH
0507                 db     0                    ; [DI+1fh] typ FAT (40h=FAT16)
0508                 dw     0                    ; [DI+20h] ‡¡ta‡ otev©en¡ disku
050a                 db     3                    ; [DI+22h] typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
050b                 dw     0020h                ; [DI+23h] 0020h=nen¡ logick˜ disk
                                                 ;          0040h=m‚dium bylo vymˆnˆno
050d                 dw     0028h                ; [DI+25h] po‡et stop na disku


051c                 dw     0009h                ; [DI+34] po‡et sektor– na stopu
051e                 dw     0002h                ; [DI+36] po‡et hlav disku


04F3   02 40 00 68 01 00 02 00 09 00 01 00 00 00 00 00   .@.h............
0503   00 00 00 00 00 00 00 03 20 00 28 00 00 02 01 01   ........ .(.....
0513   00 02 E0 00 68 01 F0 02 00 09 00 02 00 00 00 00   ....h...........
0523   00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF FF   ................


051f                 dd     0ffffffffh           ; [DI+47h] ‡as posledn¡ diskov‚ operace
0533                 db     'NO NAME    ',0      ; [DI+4bh] identifikace disku
053f                 dw     0                    ; [DI+57h] s‚riov‚ ‡¡slo - datum
0541                 dw     0                    ; [DI+59] s‚riov‚ ‡¡slo - ‡as
0543                 db     'FAT12   ',0         ; [DI+5bh] identifikace FAT


                                                 ; disketov  mechanika 3
054c                 dw     05b0h                ; [DI+00h] adresa tabulky pro mechaniku 5
054e                 dw     0070h                ; [DI+02h]
0550                 db     0                    ; [DI+04h] fyzick˜ disk 3
0551                 db     0                    ; [DI+05h] logick˜ disk 3
                                                 ; blok diskov˜ch parametr– BPB - disketa 3
0552                 dw     0200h                ; [DI+06h] po‡et bajt– na sektor
0554                 db     0ffh                 ; [DI+08h] po‡et sektor– na aloka‡n¡ blok
0555                 dw     0001h                ; [DI+09h] po‡et zav dˆc¡ch a rezervovan˜ch sektor–
0557                 db     2                    ; [DI+0Bh] po‡et aloka‡n¡ch tabulek FAT
0558                 dw     0040h                ; [DI+0Ch] max.po‡et polo‘ek z kl.adres ©e
055a                 dw     0168h                ; [DI+0Eh] po‡et sektor– na m‚diu
055c                 db     0                    ; [DI+10h] popisova‡ m‚dia
055d                 dw     0002h                ; [DI+11h] po‡et sektor– v jedn‚ tabulce FAT
055f                 dw     9                    ; [DI+13h] po‡et sektor– na stopu
0561                 dw     1                    ; [DI+15h] po‡et stran m‚dia
0563                 dw     0                    ; [DI+17h] ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
0565                 dw     0                    ; [DI+19h] ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
0567                 dw     0                    ; [DI+1bh] celkov˜ po‡et sektor– odd¡lu - LOW
0569                 dw     0                    ; [DI+1dh] celkov˜ po‡et sektor– odd¡lu - HIGH
056b                 db     0                    ; [DI+1fh] typ FAT (40h=FAT16)
056c                 dw     0                    ; [DI+20h] ‡¡ta‡ otev©en¡ disku
056e                 db     3                    ; [0I+22h] typ disku (1=1.2M, 2=720K, 7=nezn m˜)
056f                 dw     0020h                ; [DI+23h] 0020h=nen¡ logick˜ disk
                                                 ;          0040h=m‚dium bylo vymˆnˆno
0571                 dw     0028h                ; [DI+25h] po‡et stop na disku


0580                 dw     0009h                ; [DI+34] po‡et sektor– na stopu
0582                 dw     0002h                ; [DI+36] po‡et hlav disku


0553   02 FF 01 00 02 40 00 68 01 00 02 00 09 00 01 00   .....@.h........
0563   00 00 00 00 00 00 00 00 00 00 00 03 20 00 28 00   ............ .(.
0573   00 02 01 01 00 02 E0 00 68 01 F0 02 00 09 00 02   ........h.......
0583   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF   ................


0593                 dd     0ffffffffh           ; [DI+47h] ‡as posledn¡ diskov‚ operace
0597                 db     'NO NAME    ',0      ; [DI+4bh] identifikace disku
05a3                 dw     0                    ; [DI+57h] s‚riov‚ ‡¡slo - datum
05a5                 dw     0                    ; [DI+59] s‚riov‚ ‡¡slo - ‡as
05a7                 db     'FAT12   ',0         ; [DI+5bh] identifikace FAT


                                                 ; disketov  mechanika 4
05b0                 dw     0ffffh               ; [DI+00h] je ji‘ posledn¡ mechanika
05b2                 dw     0070h                ; [DI+02h]
05b4                 db     0                    ; [DI+04h] fyzick˜ disk 4
05b5                 db     0                    ; [DI+05h] logick˜ disk 4
                                                 ; blok diskov˜ch parametr– BPB - disketa 4
05b6                 dw     0200h                ; [DI+06h] po‡et bajt– na sektor
05b8                 db     0ffh                 ; [DI+08h] po‡et sektor– na aloka‡n¡ blok
05b9                 dw     0001h                ; [DI+09h] po‡et zav dˆc¡ch a rezervovan˜ch sektor–
05bb                 db     2                    ; [DI+0Bh] po‡et aloka‡n¡ch tabulek FAT
05bc                 dw     0040h                ; [DI+0Ch] max.po‡et polo‘ek z kl.adres ©e
05be                 dw     0168h                ; [DI+0Eh] po‡et sektor– na m‚diu
05c0                 db     0                    ; [DI+10h] popisova‡ m‚dia
05c1                 dw     0002h                ; [DI+11h] po‡et sektor– v jedn‚ tabulce FAT
05c3                 dw     9                    ; [DI+13h] po‡et sektor– na stopu
05c5                 dw     1                    ; [DI+15h] po‡et stran m‚dia
05c7                 dw     0                    ; [DI+17h] ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
05c9                 dw     0                    ; [DI+19h] ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
05cb                 dw     0                    ; [DI+1bh] celkov˜ po‡et sektor– odd¡lu - LOW
05cd                 dw     0                    ; [DI+1dh] celkov˜ po‡et sektor– odd¡lu - HIGH
05cf                 db     0                    ; [DI+1fh] typ FAT (40h=FAT16)
05d0                 dw     0                    ; [DI+20h] ‡¡ta‡ otev©en¡ disku
05d2                 db     3                    ; [DI+22h] typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
05d3                 dw     0020h                ; [DI+23h] 0020h=nen¡ logick˜ disk
                                                 ;          0040h=m‚dium bylo vymˆnˆno
05d5                 dw     0028h                ; [DI+25h] po‡et stop na disku


05e4                 dw     0009h                ; [DI+34] po‡et sektor– na stopu
05e6                 dw     0002h                ; [DI+36] po‡et hlav disku


05C3   09 00 01 00 00 00 00 00 00 00 00 00 00 00 00 03   ................
05D3   20 00 28 00 00 02 01 01 00 02 E0 00 68 01 F0 02    .(.........h...
05E3   00 09 00 02 00 00 00 00 00 00 00 00 00 00 00 00   ................
05F3   00 00 00 FF FF FF FF FF 4E 4F 20 4E 41 4D 45 20   ........NO NAME


05f7                 dd     0ffffffffh           ; [DI+47h] ‡as posledn¡ diskov‚ operace
05fb                 db     'NO NAME    ',0      ; [DI+4bh] identifikace disku
0607                 dw     0                    ; [DI+57h] s‚riov‚ ‡¡slo - datum
0609                 dw     0                    ; [DI+59] s‚riov‚ ‡¡slo - ‡as
060b                 db     'FAT12   ',0         ; [DI+5bh] identifikace FAT


                                                 ; tabulka param. diskety 1.2MB
0614                 db     3                    ; po‡et sektor– tabulky FAT
0615                 db     9                    ; po‡et sektor– na stopu
0616                 db     70h                  ; po‡et polo‘ek adres ©e
0617                 dw     05a0h                ; po‡et sektor– na m‚diu
0619                 db     2                    ; po‡et sektor– na blok
061a                 db     2                    ; po‡et stop


061b                 db     0                    ; uschovan˜ orienta‡n¡ k¢d kl vesy
                                                 ; p©i stisku kl vesy <Ctrl>-<Break>
                                                 ; se zde nastav¡ k¢d 03h (=^C)

061c                 db     0                    ; k¢d pro ‡ten¡ znaku z kl vesnice
061d                 db     1                    ; k¢d pro ‡ten¡ statusu kl vesnice
061e                 db     0                    ; parametr pro proveden¡ funkce
                                                 ; (‡¡slo portu LPT)

061f                 db     90h

                                                 ; doby pro TIME-OUT tisk ren
0620                 dw     0050h                ; LPT1
0622                 dw     0050h                ; LPT2
0624                 dw     0050h                ; LPT3
0626                 dw     0050h                ; LPT4

0628                 dw     0000h                ; po‡et dn– od 1.1.1980
                                                 ;  1=hodiny nepracuj¡
                                                 ;  2=chyba tvaru dat BCD
                                                 ;  3=chyba £daje data,hodin

; ----------------------------------------------------------------------------
;                           obsluha rutiny STRATEGIE
; ----------------------------------------------------------------------------

                                                 ; STRATEGIE p©eru¨en¡
062a  2e891eb800     mov    cs:[00b8],bx         ; ulo‘en¡ adresy z hlav¡ po‘adavku
062f  2e8c06ba00     mov    cs:[00ba],es
0634  cb             ret    far                  ; n vrat z obsluhy STRATEGIE


; ----------------------------------------------------------------------------
;                           obsluha rutiny PžERU›EN‹
; ----------------------------------------------------------------------------

                                                 ; obsluha rutiny PžERU›EN‹ pro CON
0635  56             push   si
0636  be3700         mov    si,0037
0639  eb4d           jmp    0688

                                                 ; obsluha rutiny PžERU›EN‹ pro AUX, COM1
063b  56             push   si
063c  50             push   ax
063d  32c0           xor    al,al                ; ‡¡slo portu COM1 (=00)
063f  eb12           jmp    0653

                                                 ; obsluha rutiny PžERU›EN‹ pro COM2
0641  56             push   si
0642  50             push   ax
0643  b001           mov    al,01                ; ‡¡slo portu COM2 (=01)
0645  eb0c           jmp    0653

                                                 ; obsluha rutiny PžERU›EN‹ pro COM3
0647  56             push   si
0648  50             push   ax
0649  b002           mov    al,02                ; ‡¡slo portu COM3 (=02)
064b  eb06           jmp    0653

                                                 ; obsluha rutiny PžERU›EN‹ pro COM4
064d  56             push   si
064e  50             push   ax
064f  b003           mov    al,03                ; ‡¡slo portu COM4 (=04)
0651  eb00           jmp    0653

0653  be4f00       * mov    si,004f
0656  eb31           jmp    0689

                                                 ; obsluha rutiny PžERU›EN‹ pro PRN
0658  56             push   si
0659  50             push   ax
065a  33c0           xor    ax,ax                ; ‡¡slo portu LPT1 (=00)
065c  eb16           jmp    0674

                                                 ; obsluha rutiny PžERU›EN‹ pro LPT1
065e  56             push   si
065f  50             push   ax
0660  32c0           xor    al,al                ; ‡¡slo portu LPT1 (=00)
0662  b401           mov    ah,01
0664  eb0e           jmp    0674

                                                 ; obsluha rutiny PžERU›EN‹ pro LPT2
0666  56             push   si
0667  50             push   ax
0668  b001           mov    al,01                ; ‡¡slo portu LPT2 (=01)
066a  b402           mov    ah,02

066c  eb06           jmp    0674                 ; nedestruktivn¡ vstup z konzoly

                                                 ; obsluha rutiny PžERU›EN‹ pro LPT3
066e  56             push   si
066f  50             push   ax
0670  b002           mov    al,02                ; ‡¡slo portu LPT3 (=02)
0672  b403           mov    ah,03
0674  be7d00       * mov    si,007d
0677  2e88261e06     mov    cs:[061e],ah
067c  eb0b           jmp    0689

                                                 ; obsluha rutiny PžERU›EN‹ pro CLOCK$
067e  56             push   si
067f  be6700         mov    si,0067
0682  eb04           jmp    0688

                                                 ; obsluha rutiny PžERU›EN‹ pro disky
0684  56             push   si
0685  be0300         mov    si,0003

                                                 ; obsluha rutiny PžERU›EN‹ (SI-tabulka)
0688  50           * push   ax
0689  51           * push   cx
068a  52             push   dx
068b  57             push   di
068c  55             push   bp
068d  1e             push   ds
068e  06             push   es
068f  53             push   bx
0690  2ea26c01       mov    cs:[016c],al         ; ‡¡slo portu COM, PRN
0694  2ec51eb800     lds    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
0699  8a4701         mov    al,[bx+01]           ; ‡¡slo jednotky (blok. za©¡zen¡)
069c  8a670d         mov    ah,[bx+0d]           ; po‡et definovan˜ch jednotek
069f  8b4f12         mov    cx,[bx+12]           ; ASCIIZ ©etˆzec z CONFIG.SYS
06a2  8b5714         mov    dx,[bx+14]           ; segment ASCIIZ ©etˆzce
06a5  81fe0300       cmp    si,0003              ; je diskov‚ za©¡zen¡ ?
06a9  7519           jnz    06c4                 ; nen¡ diskov‚ za©¡zen¡
06ab  83faff         cmp    dx,ffff              ; je zad n ©etˆzec p©¡kazu ?
06ae  750d           jnz    06bd                 ; je zad n ©etˆzec ASCIIZ
06b0  8b571c         mov    dx,[bx+1c]
06b3  2e89168b0a     mov    cs:[0a8b],dx
06b8  8b571a         mov    dx,[bx+1a]
06bb  eb07           jmp    06c4
06bd  2ec7068b0a0000*mov    cs:[0a8b],0000
06c4  97           * xchg   ax,di
06c5  8a4702         mov    al,[bx+02]           ; ‡¡slo povelu
06c8  2e3a04         cmp    al,cs:[si]           ; kontrola ‡¡sla povelu
06cb  7713           ja     06e0                 ; ‡¡slo povelu vˆt¨¡ - chyba
06cd  98             cbw                         ; AX <- AL
06ce  d1e0           shl    ax,1                 ; AX * 2
06d0  03f0           add    si,ax                ; SI+AX
06d2  97             xchg   ax,di
06d3  c47f0e         les    di,[bx+0e]           ; koncov  adresa rezidentn¡ho k¢du
06d6  0e             push   cs
06d7  1f             pop    ds                   ; DS <- CS
06d8  fc             cld                         ; smˆr p©enosu nahoru
06d9  ff6401         jmp    [si+01]              ; skok na adresu z tabulky

                                                 ; za©¡zen¡ p©ipraveno
06dc  b403           mov    ah,03                ; p©¡znak - za©¡zen¡ nen¡ p©ipraveno
06de  eb19           jmp    06f9

06e0  b003         * mov    al,03                ; k¢d chyby - nezn m˜ povel
06e2  2ec51eb800     lds    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
06e7  294f12         sub    [bx+12],cx           ; adresa BPB = 0
06ea  b481           mov    ah,81                ; p©¡znak chyby (nenalezena funkce)
06ec  eb0b           jmp    06f9                 ; n vrat z obsluhy

                                                 ; vstup z LPT
06ee  c51eb800       lds    bx,[00b8]            ; adresa z hlav¡ po‘adavku
06f2  33c0           xor    ax,ax
06f4  894712         mov    [bx+12],ax           ; adresa BPB (nen¡ nastavena)
                                                 ; sem je n vrat z obsluh funkc¡
06f7  b401         * mov    ah,01                ; p©¡znak ukon‡en¡ operace
06f9  2ec51eb800   * lds    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
06fe  894703         mov    [bx+03],ax           ; nastaven¡ stavov‚ho slova za©¡zen¡
0701  5b             pop    bx
0702  07             pop    es
0703  1f             pop    ds
0704  5d             pop    bp
0705  5f             pop    di
0706  5a             pop    dx
0707  59             pop    cx
0708  58             pop    ax
0709  5e             pop    si
070a  cb             ret    far

; -----------------------------------------------------------------------------
                                                 ; obsluha p©eru¨en¡ INT 29H
                                                 ; - v˜stup znaku AL na displej
                                                 ; VSTUP: AL=znak k zobrazen¡
070b  50             push   ax
070c  56             push   si
070d  57             push   di
070e  55             push   bp
070f  53             push   bx
0710  b40e           mov    ah,0e                ; funkce z pisu znaku v m¢du TTY
0712  bb0700         mov    bx,0007              ; barva b¡l  na ‡ern‚m podkladˆ
0715  cd10           int    10                   ; v˜stup znaku na displej
0717  5b             pop    bx
0718  5d             pop    bp
0719  5f             pop    di
071a  5e             pop    si
071b  58             pop    ax
071c  cf             iret

; -----------------------------------------------------------------------------
                                                 ; p©e‡ten¡ ‡¡sla portu (DX)
071d  2e8b166c01     mov    dx,cs:[016c]         ; ‡¡slo portu COM,PRN
0722  c3             ret

0723  00             db     0

                                                 ; vstup ©etˆzce znak– z konzoly
                                                 ; ES:DI = buffer pro vstup
0724  e3             jcxz   072ch                ; po‡et znak– = 0
0726  e80600       * call   072f                 ; vstup znaku z kl vesnice
0729  aa             stosb                       ; ulo‘en¡ znaku do bufferu
072a  e2fa           loop   0726                 ; vstup dal¨¡ kl vesy
072c  e9c8ff       * jmp    06f7                 ; konec obsluhy

                                                 ; vstup znaku z kl vesnice
072f  8a261c06     * mov    ah,[061c]            ; funkce pro vstup z kl vesnice
0733  32c0           xor    al,al                ; AL <- 0
0735  86061b06       xchg   al,[061b]            ; vyjmut¡ orienta‡n¡ho k¢du kl vesy
0739  0ac0           or     al,al                ; je p©ipraven orienta‡n¡ k¢d kl vesy ?
073b  752b           jnz    0768                 ; je orienta‡n¡ k¢d kl vesy
073d  cd16           int    16                   ; vstup znaku z kl vesnice
073f  0bc0           or     ax,ax                ; zad n znak ?
0741  74ec           jz     072f                 ; nep©i¨el znak - znovu
0743  3d0072         cmp    ax,7200              ; je kl vesa <Print Screen> ?
0746  7505           jnz    074d                 ; nen¡ <Print Screen>
0748  b010           mov    al,10                ; nastaven¡ na k¢d 7210h (= ^P)
074a  eb1c           jmp    0768
074c  90             nop
074d  803e1c0600   * cmp    [061c],00            ; funkce pro vstup z kl vesnice
0752  740c           jz     0760                 ; je ‡ten¡ znaku z kl vesnice
0754  3ce0           cmp    al,e0                ; je zvl ¨tn¡ kl vesa ?
0756  7508           jnz    0760                 ; nen¡ zvl ¨tn¡ kl vesa
0758  0ae4           or     ah,ah
075a  740c           jz     0768                 ; je k¢d 00e0h (pomoc¡ ALT-)
075c  32c0           xor    al,al                ; je k¢d kl vesy 2 bajty
075e  eb04           jmp    0764                 ; je zvl ¨tn¡ kl vesa
0760  0ac0         * or     al,al                ; ASCII k¢d kl vesy
0762  7504           jnz    0768                 ; nen¡ k¢d kl vesy 0
0764  88261b06       mov    [061b],ah            ; ulo‘en¡ orienta‡n¡ho k¢du kl vesy
0768  c3           * ret

0769  eb62           jmp    07cd
076b  90             nop

                                                 ; nedestruktivn¡ vstup z CON
076c  a01b06         mov    al,[061b]            ; orienta‡n¡ k¢d kl vesy
076f  0ac0           or     al,al
0771  7403           jz     0776                 ; nen¡ p©ipraven k¢d kl vesy
0773  eb4e           jmp    07c3
0775  90             nop

0776  8a261d06     * mov    ah,[061d]            ; k¢d funkce pro vstup znaku
077a  cd16           int    16                   ; vstup znaku z kl vesnice
077c  7403           jz     0781                 ; nep©i¨el znak z kl vesnice
077e  eb1b           jmp    079b
0780  90             nop

0781  803ec50100   * cmp    [01c5],00            ; 1=p©¡znak, ‘e se prov d¡ inicializace hodin
0786  74e1           jz     0769
0788  c51eb800       lds    bx,[00b8]            ; adresa z hlav¡ po‘adavku
078c  f747030004     test   [bx+03],0400         ; STATUS
0791  74d6           jz     0769
0793  b80041         mov    ax,4100              ; funkce ‡ek n¡ na ud lost
0796  cd15           int    15                   ; ‡ek n¡ na ud lost
0798  eb33           jmp    07cd
079a  90             nop

079b  0bc0           or     ax,ax
079d  7508           jnz    07a7
079f  8a261c06       mov    ah,[061c]            ; funkce pro vstup znaku z kl vesnice
07a3  cd16           int    16                   ; vstup znaku z kl vesnice
07a5  ebc5           jmp    076c
07a7  3d0072       * cmp    ax,7200              ; je kl vesa <Print Screen> ?
07aa  7505           jnz    07b1                 ; nen¡ <Print Screen>
07ac  b010           mov    al,10                ; zmˆna na k¢d 7210h (= ^P)
07ae  eb13           jmp    07c3
07b0  90             nop
07b1  803e1c0600     cmp    [061c],00
07b6  740b           jz     07c3
07b8  3ce0           cmp    al,e0
07ba  7507           jnz    07c3
07bc  80fc00         cmp    ah,00
07bf  7402           jz     07c3
07c1  b000           mov    al,00
07c3  c51eb800     * lds    bx,[00b8]            ; adresa z hlav¡ po‘adavku
07c7  88470d         mov    [bx+0d],al
07ca  e92aff       * jmp    06f7                 ; konec
07cd  e90cff       * jmp    06dc                 ; p©¡znak - za©¡zen¡ nen¡ p©ipraveno

07d0  e80300         call   07d6                 ; vy‡i¨tˆn¡ vstupn¡ho bufferu CON
07d3  e921ff         jmp    06f7                 ; konec obsluhy funkce

                                                 ; vy‡i¨ten¡ vstupn¡ho bufferu CON
07d6  c6061b0600     mov    [061b],00
07db  b401           mov    ah,01                ; funkce stavu kl vesnice
07dd  cd16           int    16                   ; zji¨tˆn¡ stavu kl vesnice
07df  7406           jz     07e7                 ; nen¡ p©ipraven znak
07e1  32e4           xor    ah,ah                ; funkce ‡ten¡ znaku z kl vesnice
07e3  cd16           int    16                   ; ‡ten¡ znaku z kl vesnice
07e5  ebf4           jmp    07db                 ; zni‡en¡ dal¨¡ho znaku
07e7  c3           * ret

                                                 ; v˜stup ©etˆzce na konzolu
07e8  e3e0           jcxz   07ca                 ; nen¡ ‘ dn˜ znak - konec vstupu
07ea  268a05       * mov    al,es:[di]           ; znak k v˜stupu na konzolu
07ed  47             inc    di                   ; zv˜¨en¡ pozice ukazatele
07ee  cd29           int    29                   ; ulo‘en¡ znaku na obrazovku
07f0  e2f8           loop   07ea                 ; dal¨¡ znak
07f2  e902ff         jmp    06f7                 ; konec v˜stupu

                                                 ; obsluha INT 1BH (p©eru¨en¡ <Ctrl>-<Break>)
07f5  2ec6061b0603 * mov    cs:[061b],03         ; nastaven¡ k¢du p©eru¨en¡ ^C
07fb  cf           * iret                        ; (zde t‚‘ obsluha INT 01H,03H,04H,0FH)

                                                 ; vstup IOCTL z AUX, COM
07fc  e311           jcxz   080f                 ; nen¡ ‘ dn˜ znak
07fe  e88700         call   0888                 ; nastaven¡ adresy COM v bufferu
0801  33c0           xor    ax,ax                ; AL <- 00
0803  8607           xchg   al,[bx]              ; vyjmut¡ znaku z bufferu
0805  0ac0           or     al,al                ; je v bufferu znak ?
0807  7503           jnz    080c                 ; je ulo‘en znak
0809  e80600       * call   0812                 ; vstup znaku z COM
080c  aa           * stosb                       ; ulo‘en¡ znaku do bufferu
080d  e2fa           loop   0809                 ; p©¡jem dal¨¡ho znaku
080f  e9e5fe       * jmp    06f7                 ; konec vstupu

                                                 ; vstup znaku z COM
0812  b402           mov    ah,02                ; funkce - p©¡jem 1 znaku
0814  e84800         call   085f                 ; p©¡jem znaku z COM
0817  f6c40e         test   ah,0e                ; stav veden¡ - nastala chyba ?
081a  740a           jz     0826                 ; nen¡ ‘ dn  chyba - n vrat
081c  83c402         add    sp,0002              ; zru¨en¡ n vratov‚ adresy
081f  32c0           xor    al,al
0821  0cb0           or     al,b0                ; chybov˜ k¢d
0823  e9bcfe         jmp    06e2                 ; chybov˜ n vrat
0826  c3           * ret

                                                 ; nedestruktivn¡ vstup z COM
0827  e85e00         call   0888                 ; nastaven¡ adresy COM v bufferu
082a  8a07           mov    al,[bx]              ; je ulo‘en nˆjak˜ znak ?
082c  0ac0           or     al,al
082e  7514           jnz    0844                 ; je p©ipraven znak
0830  e82600         call   0859                 ; dotaz na stav COM
0833  f6c401         test   ah,01                ; jsou p©ipravena data ?
0836  740f           jz     0847                 ; data nejsou p©ipravena
0838  a820           test   al,20                ;
083a  740b           jz     0847                 ; data nejsou p©ipravena
083c  e8d3ff         call   0812                 ; vstup znaku z COM
083f  e84600         call   0888                 ; nastaven¡ adresy COM v bufferu
0842  8807           mov    [bx],al              ; ulo‘en¡ znaku do bufferu
0844  e97cff       * jmp    07c3                 ; n vrat (znak p©ipraven)
0847  e992fe       * jmp    06dc                 ; p©¡znak - za©¡zen¡ nep©ipraveno

                                                 ; test stavu COM
084a  e80c00         call   0859                 ; dotaz na stav COM
084d  a820           test   al,20                ; vys¡lac¡ registr pr zdn˜ ?
084f  74f6           jz     0847                 ; nen¡ je¨tˆ pr zdn˜
0851  f6c420         test   ah,20                ; je protistanice p©ipravena ?
0854  74f1           jz     0847                 ; nen¡ je¨tˆ p©ipravena
0856  e99efe         jmp    06f7                 ; n vrat z obsluhy

                                                 ; dotaz na stav COM
0859  b403           mov    ah,03                ; funkce dotazu na stav COM
085b  e80100         call   085f                 ; proveden¡ obsluhy COM
085e  c3             ret

                                                 ; proveden¡ obsluhy COM
085f  e8bbfe         call   071d                 ; nastaven¡ ‡¡sla portu COM
0862  cd14           int    14                   ; servis port– COM
0864  c3             ret

                                                 ; vy‡i¨tˆn¡ vstupu z COM
0865  e82000         call   0888                 ; nastaven¡ adresy COM v bufferu
0868  c60700         mov    [bx],00              ; zru¨en¡ ulo‘en‚ho p©ij. znaku
086b  e989fe         jmp    06f7                 ; n vrat z obsluhy

                                                 ; v˜stup ©etˆzce na COM
086e  e39f           jcxz   080f                 ; nen¡ ‘ dn˜ znak k vysl n¡
0870  268a05       * mov    al,es:[di]           ; znak k vysl n¡
0873  47             inc    di                   ; zv˜¨en¡ ukazatele dat
0874  b401           mov    ah,01                ; funkce v˜stupu znaku na COM
0876  e8e6ff         call   085f                 ; proveden¡ obsluhy COM
0879  f6c480         test   ah,80                ; status - je TIME-OUT ?
087c  7405           jz     0883                 ; nen¡ chyba TIME-OUT
087e  b00a           mov    al,0a                ; k¢d chyby CHYBA ZPISU
0880  e95ffe         jmp    06e2                 ; chyba obsluhy
0883  e2eb           loop   0870                 ; vysl n¡ dal¨¡ho znaku
0885  e96ffe         jmp    06f7                 ; n vrat z obsluhy

                                                 ; nastaven¡ adresy COM v bufferu
0888  e892fe         call   071d                 ; nastaven¡ ‡¡sla portu COM
088b  8bda           mov    bx,dx                ; ‡¡slo portu COM
088d  81c3bc00       add    bx,00bc              ; adresa ulo‘en‚ho znaku COM
0891  c3             ret

                                                 ; v˜stup ©etˆzce na LPT (ES:DI=buffer)
0892  e31a           jcxz   08ae                 ; nen¡ ‘ dn˜ znak k v˜stupu
0894  bb0200         mov    bx,0002              ; po‡et pokus– p©i TIME-OUT
0897  268a05       * mov    al,es:[di]           ; znak k vysl n¡
089a  32e4           xor    ah,ah                ; funkce vysl n¡ znaku na tisk rnu
089c  e82400         call   08c3                 ; vysl n¡ znaku na tisk rnu
089f  740a           jz     08ab                 ; v˜stup probˆhl OK
08a1  f6c401         test   ah,01                ; byla chyba TIME-OUT ?
08a4  7405           jz     08ab                 ; nen¡ chyba TIME-OUT
08a6  4b             dec    bx                   ; sn¡‘en¡ ‡¡ta‡e pokus–
08a7  75ee           jnz    0897                 ; dal¨¡ pokus o vysl n¡ znaku
08a9  eb06           jmp    08b1                 ; je chyba TIME-OUT
08ab  47           * inc    di                   ; zv˜¨en¡ ukazatele v bufferu
08ac  e2e6           loop   0894                 ; dal¨¡ znak k v˜stupu
08ae  e946fe       * jmp    06f7                 ; n vrat z obsluhy
08b1  e92efe         jmp    06e2                 ; chyba TIME-OUT

                                                 ; statut v˜stupu na LPT
08b4  e80a00         call   08c1                 ; zji¨tˆn¡ statusu tisk rny
08b7  75f8           jnz    08b1                 ; je chyba
08b9  f6c480         test   ah,80                ; je v˜stup p©ipraven ?
08bc  75f0           jnz    08ae                 ; tisk rna je zanepr zdnˆna
08be  e91bfe         jmp    06dc                 ; tisk rna p©ipravena k p©¡jmu

                                                 ; test statusu tisk rny
08c1  b402           mov    ah,02                ; ‡¡slo funkce - status tisk rny
                                                 ; proveden¡ funkce tisk rny
08c3  e857fe       * call   071d                 ; nastaven¡ ‡¡sla portu PRN
08c6  cd17           int    17                   ; dotaz na status tisk rny
08c8  f6c408         test   ah,08                ; je chyba I/O ?
08cb  740a           jz     08d7                 ; nenastala chyba I/O
08cd  b009           mov    al,09                ; k¢d chyby - v tisk rnˆ nen¡ pap¡r
08cf  f6c420         test   ah,20                ; je v tisk rnˆ pap¡r ?
08d2  7502           jnz    08d6                 ; nem  pap¡r
08d4  fec0           inc    al                   ; k¢d chyby 10 - chyba z pisu
08d6  c3           * ret
08d7  b002         * mov    al,02                ; k¢d chyby - tisk rna nep©ipravena
08d9  f6c401         test   ah,01                ; je chyba TIME-OUT ?
08dc  c3             ret

                                                 ; v˜stup ©etˆzce na tisk rnu
08dd  1e             push   ds
08de  06             push   es
08df  1f             pop    ds                   ; DS <- ES (©etˆzec k v˜stupu)
08e0  8bf7           mov    si,di                ; ©etˆzec k v˜stupu na tisk rnu
08e2  51           * push   cx
08e3  53             push   bx
08e4  33db           xor    bx,bx
08e6  2e8a1e1e06     mov    bl,cs:[061e]         ; hodnota pro TIME-OUT
08eb  d1e3           shl    bx,1                 ; BX*2
08ed  2e8b8f2006     mov    cx,cs:[bx+0620]      ; doba pro TIME-OUT
08f2  5b             pop    bx
08f3  e8cbff       * call   08c1                 ; test statusu tisk rny
08f6  751e           jnz    0916                 ; je chyba tisk rny
08f8  f6c480         test   ah,80                ; je tisk rna p©ipravena ?
08fb  e1f6           loopz  08f3                 ; ‡ek n¡ na p©ipravenost tisk rny
08fd  59             pop    cx
08fe  7417           jz     0917                 ; chyba TIME-OUT
0900  ac             lodsb                       ; na‡ten¡ znaku k v˜stupu
0901  32e4           xor    ah,ah                ; funkce v˜stupu znaku
0903  e8bdff         call   08c3                 ; v˜stup znaku na tisk rnu
0906  750f           jnz    0917                 ; chyba tisk rny
0908  e2d8           loop   08e2                 ; dal¨¡ znak k v˜stupu
090a  1f             pop    ds
090b  2ec51eb800     lds    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
0910  294f12         sub    [bx+12],cx           ; zru¨en¡ adresy BPB
0913  e9e1fd         jmp    06f7                 ; n vrat z obsluhy
                                                 ; chyba v˜stupu na tisk rnu
0916  59           * pop    cx
0917  1f           * pop    ds
0918  2ec51eb800     lds    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
091d  294f12         sub    [bx+12],cx
0920  e9c7fd         jmp    06ea

                                                 ; generov n¡ po‘adavku IOCTL pro PRN
                                                 ; (podfunkce: 45h-nastaven¡ doby TIME-OUT)
0923  c43eb800       les    di,[00b8]            ; adresa z hlav¡ po‘adavku
0927  26807d0d05     cmp    es:[di+0d],05        ; ‡¡slo funkce=z pis na blokov‚ za©¡zen¡
092c  7403           jz     0931                 ; je z pis na blokov‚ za©¡zen¡
092e  e9affd       * jmp    06e0                 ; chyba funkce
0931  268a450e     * mov    al,es:[di+0e]        ; ‡¡slo podfunkce
0935  26c47d13       les    di,es:[di+13]        ; adresa dat pro z pis
0939  33db           xor    bx,bx
093b  8a1e1e06       mov    bl,[061e]            ; ‡¡slo portu LPT
093f  d1e3           shl    bx,1
0941  8b8f2006       mov    cx,[bx+0620]         ; doba pro TIME-OUT
0945  3c65           cmp    al,65                ; ‡¡slo podfunkce
0947  7407           jz     0950                 ; podfunkce 65h
0949  3c45           cmp    al,45                ; podfunkce nastaven¡ doby TIME-OUT
094b  75e1           jnz    092e                 ; chyba - nezn m  funkce
094d  268b0d         mov    cx,es:[di]           ; p©e‡ten¡ nov‚ doby TIME-OUT
0950  898f2006     * mov    [bx+0620],cx         ; nastaven¡ nov‚ doby TIME-OUT
0954  26890d         mov    es:[di],cx           ; z znam doby TIME-OUT
0957  e99dfd         jmp    06f7                 ; ukon‡en¡ obsluhy

095a                 db     0                    ; 1=p©¡znak, ‘e syst. hodiny bˆ‘¡
095b                 db     13h
095c                 db     50h

                                                 ; tabulka po‡tu dn– v mˆs¡ci
095d                 db     31                   ; LEDEN
095e                 db     28                   ; —NOR
095f                 db     31                   ; BžEZEN
0960                 db     30                   ; DUBEN
0961                 db     31                   ; KV‰TEN
0962                 db     30                   ; €ERVEN
0963                 db     31                   ; €ERVENEC
0964                 db     31                   ; SRPEN
0965                 db     30                   ; Zž‹
0966                 db     31                   ; ž‹JEN
0967                 db     30                   ; LISTOPAD
0968                 db     31                   ; PROSINEC

0969                 dw     0                    ; adresa obsluhy hodin
096b                 dw     0
096d                 dw     09c9h                ; p©epo‡et na £daj syst‚mov‚ho ‡¡ta‡e

                                                 ; nastaven¡ za©¡zen¡ CLOCK$
096f  268b05         mov    ax,es:[di]
0972  50             push   ax
0973  803e5a0900     cmp    [095a],00            ; 1=p©¡znak, ‘e syst. hodiny bˆ‘¡
0978  7426           jz     09a0
097a  268a4503       mov    al,es:[di+03]
097e  ff166909       call   [0969]               ; adresa obsluhy hodin
0982  8ae8           mov    ch,al                ; hodiny (BCD)
0984  268a4502       mov    al,es:[di+02]
0988  ff166909       call   [0969]               ; adresa obsluhy hodin
098c  8ac8           mov    cl,al                ; minuty (BCD)
098e  268a4505       mov    al,es:[di+05]        ; logick˜ disk
0992  ff166909       call   [0969]               ; adresa obsluhy hodin
0996  8af0           mov    dh,al                ; sekundy (BCD)
0998  b200           mov    dl,00                ; nen¡ denn¡ ukl d n¡
099a  fa             cli
099b  b403           mov    ah,03                ; funkce nastaven¡ hodin
099d  cd1a           int    1a                   ; nastaven¡ hodin re ln‚ho ‡asu
099f  fb             sti
09a0  268b4d02     * mov    cx,es:[di+02]
09a4  268b5504       mov    dx,es:[di+04]        ; fyzick˜ disk
09a8  e81e00         call   09c9                 ; p©epo‡et na £daj syst‚mov‚ho ‡¡ta‡e
09ab  fa             cli
09ac  b401           mov    ah,01                ; funkce nastaven¡ syst‚mov‚ho ‡¡ta‡e
09ae  cd1a           int    1a                   ; nastaven¡ syst‚mov‚ho ‡¡ta‡e ‡asu
09b0  8f062806       pop    [0628]               ; po‡et dn– od 1.1.1980
09b4  fb             sti
09b5  803e5a0900     cmp    [095a],00            ; 1=p©¡znak, ‘e syst. hodiny bˆ‘¡
09ba  740a           jz     09c6
09bc  ff166b09       call   [096b]
09c0  fa             cli
09c1  b405           mov    ah,05                ; funkce nastaven¡ data hodin
09c3  cd1a           int    1a                   ; nastaven¡ data hodin re ln‚ho ‡asu
09c5  fb             sti
09c6  e92efd       * jmp    06f7                 ; n vrat z obsluhy funkce

                                                 ; p©epo‡et na £daj syst‚mov‚ho ‡¡ta‡e
                                                 ; VSTUP: CH=hodina
                                                 ;        CL=minuta
                                                 ;        DH=sekunda
                                                 ;        DL=setina sekundy
                                                 ; VSTUP: CX=vy¨¨¡ slovo ‡¡ta‡e
                                                 ;         DX=ni‘¨¡ slovo ‡¡ta‡e
09c9  b03c           mov    al,3c                ; 60
09cb  f6e5           mul    ch                   ; hodina*60
09cd  b500           mov    ch,00
09cf  03c1           add    ax,cx                ; hodiny*60+minuty
09d1  b97017         mov    cx,1770              ; 6000
09d4  8bda           mov    bx,dx                ; sekundy a setiny sekund
09d6  f7e1           mul    cx                   ; p©epo‡et na setiny sekund
09d8  8bc8           mov    cx,ax                ;
09da  b064           mov    al,64                ; 100
09dc  f6e7           mul    bh                   ; sekundy * 100
09de  03c8           add    cx,ax                ; p©i‡ten¡ sekund k hodin m a minut m
09e0  83d200         adc    dx,0000              ; p©i‡ten¡ p©enosu
09e3  b700           mov    bh,00
09e5  03cb           add    cx,bx                ; p©i‡ten¡ setin sekundy
09e7  83d200         adc    dx,0000              ; p©i‡ten¡ p©enosu
09ea  92             xchg   ax,dx                ; AX<-vy¨¨¡ slovo £daje ‡asu
09eb  91             xchg   ax,cx                ; AX<-ni‘¨¡ slovo ‡asu, CX<-vy¨¨¡ slovo
09ec  bb0be9         mov    bx,e90b              ; 59659
09ef  f7e3           mul    bx                   ; ni‘¨¡ slovo * 59659
09f1  87d1           xchg   dx,cx                ; DX<-vy¨¨¡ slovo
09f3  92             xchg   ax,dx                ; AX<-vy¨¨¡ slovo
09f4  f7e3           mul    bx                   ; vy¨¨¡ slovo * 59659
09f6  03c1           add    ax,cx
09f8  83d200         adc    dx,0000              ; p©enos
09fb  92             xchg   ax,dx
09fc  bb0500         mov    bx,0005
09ff  f6f3           div    bl                   ; /5
0a01  8ac8           mov    cl,al                ; vy¨¨¡ ‡ st ‡¡ta‡e ‡asu
0a03  b500           mov    ch,00
0a05  8ac4           mov    al,ah
0a07  98             cbw
0a08  92             xchg   ax,dx                ; /5
0a09  f7f3           div    bx
0a0b  8bd0           mov    dx,ax                ; ni‘¨¡ ‡ st ‡¡ta‡e ‡su
0a0d  c3             ret

                                                 ; vstup ze za©¡zen¡ CLOCK$
0a0e  32e4           xor    ah,ah                ; funkce ‡ten¡ syst‚mov‚ho ‡asu
0a10  cd1a           int    1a                   ; ‡ten¡ syst‚mov‚ho ‡asu
0a12  0ac0           or     al,al                ; byl p©elom 24 hodin ?
0a14  7404           jz     0a1a                 ; nebyl p©elom 24 hodin
0a16  ff062806       inc    w/[0628]             ; po‡et dn– od 1.1.1980
0a1a  8b362806     * mov    si,[0628]            ; po‡et dn– od 1.1.1980
0a1e  8bc1           mov    ax,cx                ; vy¨¨¡ ‡ st ‡¡ta‡e ‡asu
0a20  8bda           mov    bx,dx                ; ni‘¨¡ ‡ st ‡¡ta‡e ‡asu
0a22  d1e2           shl    dx,1
0a24  d1d1           rcl    cx,1                 ; =‡¡ta‡ ‡asu*2
0a26  d1e2           shl    dx,1
0a28  d1d1           rcl    cx,1                 ; =‡¡ta‡ ‡asu*4
0a2a  03d3           add    dx,bx
0a2c  13c1           adc    ax,cx                ; =‡¡ta‡ ‡asu*5
0a2e  92             xchg   ax,dx
0a2f  b90be9         mov    cx,e90b              ; 59659
0a32  f7f1           div    cx                   ; ‡¡ta‡ ‡asu*5/59659
0a34  8bd8           mov    bx,ax                ; £schova pod¡lu
0a36  33c0           xor    ax,ax
0a38  f7f1           div    cx
0a3a  8bd3           mov    dx,bx
0a3c  b9c800         mov    cx,00c8              ; 200
0a3f  f7f1           div    cx                   ; /200
0a41  80fa64         cmp    dl,64                ; >100 ?
0a44  7203           jc     0a49
0a46  80ea64         sub    dl,64
0a49  f5           * cmc                         ; -CF
0a4a  8ada           mov    bl,dl
0a4c  d1d0           rcl    ax,1
0a4e  b200           mov    dl,00
0a50  d1d2           rcl    dx,1
0a52  b93c00         mov    cx,003c              ; 60
0a55  f7f1           div    cx                   ; /60
0a57  8afa           mov    bh,dl
0a59  f6f1           div    cl                   ; /60
0a5b  86c4           xchg   al,ah                ; AL=setiny, AH=sekundy
0a5d  50             push   ax
0a5e  8bc6           mov    ax,si                ; po‡et dn– syst‚mov‚ho ‡¡ta‡e
0a60  ab             stosw                       ; ulo‘en¡ po‡tu dn–
0a61  58             pop    ax
0a62  ab             stosw                       ; ulo‘en¡ setin sekund a sekund
0a63  8bc3           mov    ax,bx
0a65  ab             stosw                       ; ulo‘en¡ minut a hodin
0a66  e98efc         jmp    06f7                 ; n vrat z obsluhy

0a69                 dw     0
0A6b                 db     'FAT12   ',0
0a74                 db     'FAT16   ',0
0a7d                 db     'NO NAME    ',0

0a89                 dw     0                    ; pro prozatimn¡ £schovu

0a8d                 dw     0                    ; £schova po‡ te‡n¡ho relativn¡ho sektoru - LOW

0a8f                 dw     0

0A89   00 00 00 00 00 00 00 00 00 00 00 00 00 00 E8 5F   ..............._

0a92                 dw     0                    ; po‡et pokus– o diskovou operaci
0a94                 dw     0                    ; po‡et pokus– o verifikaci po z pisu

                                                 ; FUNKCE 01 - kontrola m‚dia diskov‚ho za©¡zen¡
0a97  e85f03         call   0df9                 ; nalezen¡ disku v tabulce
0a9a  2e813ec8016b6a cmp    cs:[01c8],6a6bh
0aa1  7546           jnz    0ae9
0aa3  be0100         mov    si,0001              ; p©¡znak - m‚dium nezmˆnˆno
0aa6  f745230001     test   [di+23],0100
0aab  7417           jz     0ac4
0aad  816523fffe     and    [di+23],feff
0ab2  2ec6065102ff   mov    cs:[0251],ff         ; aktu ln¡ logick˜ disk
0ab8  f745230100     test   [di+23],0001
0abd  740c           jz     0acb
0abf  beffff         mov    si,ffff              ; p©¡znak - m‚dium bylo vymˆnˆno
0ac2  eb25           jmp    0ae9
0ac4  f745230100     test   [di+23],0001
0ac9  751e           jnz    0ae9
0acb  33f6           xor    si,si                ; p©¡znak - nelze ur‡it, zda bylo m‚dium vymˆnˆno
0acd  e88116         call   2151
0ad0  7233           jc     0b05
0ad2  e82518         call   22fa
0ad5  7512           jnz    0ae9
0ad7  be0100         mov    si,0001              ; p©¡znak - m‚dium je zmˆnˆno
0ada  2ea05102       mov    al,cs:[0251]         ; aktu ln¡ logick˜ disk
0ade  3a4504         cmp    al,[di+04]           ; fyzick˜ disk
0ae1  7505           jnz    0ae8
0ae3  e82500         call   0b0b                 ; test v˜mˆny m‚dia podle ‡asu
0ae6  eb01           jmp    0ae9
0ae8  4e           * dec    si
0ae9  2ec41eb800   * les    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
0aee  2689770e       mov    es:[bx+0e],si        ; p©¡znak v˜mˆny m‚dia
0af2  0bf6           or     si,si
0af4  7803           js     0af9                 ; m‚dium bylo vymˆnˆno
0af6  e9fefb         jmp    06f7                 ; n vrat z obsluhy OK
0af9  e84f17       * call   224b
0afc  2ec6065102ff   mov    cs:[0251],ff         ; aktu ln¡ logick˜ disk
0b02  e9f2fb         jmp    06f7                 ; n vrat z obsluhy OK
0b05  e8c106         call   11c9
0b08  e9dffb         jmp    06ea                 ; chyba


                                                 ; test v˜mˆny m‚dia podle ‡asu
                                                 ; od posledn¡ operace s diskem
0b0b  be0100         mov    si,0001              ; p©¡znak - m‚dium nezmˆnˆno
0b0e  32e4           xor    ah,ah
0b10  cd1a           int    1a                   ; ‡ten¡ syst‚mov‚ho ‡asova‡e
0b12  d0e8           shr    al,1                 ; byl p©elom 24 hodin ?
0b14  2e8316280600   adc    cs:[0628],0000       ; zv˜¨en¡ po‡tu dn– od 1.1.1980
0b1a  8b4547         mov    ax,[di+47]           ; ‡as posledn¡ operace s diskem - LOW
0b1d  2bd0           sub    dx,ax                ; rozd¡l ‡asu od posledn¡ operace - LOW
0b1f  8b4549         mov    ax,[di+49]           ; ‡as posledn¡ operace s diskem - HIGH
0b22  1bc8           sbb    cx,ax                ; rozd¡l ‡asu od posledn¡ operace - HIGH
0b24  751d           jnz    0b43                 ; velk  ‡asov  zmˆna - nelze ur‡it v˜mˆnu
0b26  0bd2           or     dx,dx                ; ‡asov  diference od posledni operace
0b28  7514           jnz    0b3e
0b2a  2efe065002     inc    b/cs:[0250]          ; aktu ln¡ fyzick˜ disk
0b2f  2e803e500205   cmp    cs:[0250],05         ; aktu ln¡ fyzick˜ disk
0b35  720d           jc     0b44                 ; nen¡ je¨tˆ p©ekro‡en po‡et mechanik
0b37  2efe0e5002     dec    b/cs:[0250]          ; n vrat ‡¡sla fyz. disku
0b3c  eb05           jmp    0b43
0b3e  83fa24         cmp    dx,0024              ; rozd¡l ‡asu mus¡ b˜t men¨¡ ne‘ 2 sekundy
0b41  7601           jna    0b44
0b43  4e             dec    si                   ; nelze ur‡it, zda bylo m‚dium vymˆnˆno
0b44  c3           * ret


0b45  ebbe           jmp    0b05

                                                 ; FUNKCE 02 - vystavˆn¡ BPB disk. za©¡zen¡
0b47  268a25         mov    ah,es:[di]           ; popisova‡ mˆdia
0b4a  e8ac02         call   0df9                 ; nalezen¡ disku v tabulce
0b4d  f745230100     test   [di+23],0001
0b52  751f           jnz    0b73
0b54  e83300         call   0b8a                 ; nastaven¡ ozna‡en¡ disku v tabulce disku
0b57  2ec6066a0a01   mov    cs:[0a6a],01
0b5d  e86900         call   0bc9                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
0b60  72e3           jc     0b45
0b62  2e803e6a0a02   cmp    cs:[0a6a],02
0b68  2ec6066a0a00   mov    cs:[0a6a],00
0b6e  7403           jz     0b73
0b70  e8a517         call   2318
0b73  83c706         add    di,0006
0b76  2ec41eb800     les    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku
0b7b  2688670d       mov    es:[bx+0d],ah        ; bajt popisova‡e m‚dia
0b7f  26897f12       mov    es:[bx+12],di        ; adresa bloku parametr– BIOS (BPB)
0b83  268c5f14       mov    es:[bx+14],ds        ; segment adresy BPB
0b87  e96dfb         jmp    06f7                 ; OK


                                                 ; nastaven¡ ozna‡en¡ disku v tabulce disku
                                                 ; VSTUP: DS:DI=tabulka parametr– disku
0b8a  1e             push   ds
0b8b  57             push   di
0b8c  06             push   es
0b8d  56             push   si
0b8e  51             push   cx
0b8f  1e             push   ds
0b90  07             pop    es
0b91  0e             push   cs
0b92  1f             pop    ds
0b93  b90000         mov    cx,0000              ; vymaz n¡ s‚riov‚ho ‡¡sla diskety
0b96  26894d57       mov    es:[di+57],cx        ; s‚riov‚ ‡¡slo diskety - datum
0b9a  26894d59       mov    es:[di+59],cx        ; s‚riov‚ ‡¡slo diskety - ‡as
0b9e  b90b00         mov    cx,000b
0ba1  be7d0a         mov    si,0a7d              ; ozna‡en¡ NO NAME
0ba4  57             push   di
0ba5  83c74b         add    di,004b              ; ozna‡en¡ disku NO NAME
0ba8  f3a4           rep    movsb                ; p©enos ozna‡en¡ disku
0baa  5f             pop    di
0bab  26f6451f40     test   es:[di+1f],40        ; typ FAT
0bb0  7506           jnz    0bb8                 ; je FAT16
0bb2  be6b0a         mov    si,0a6b              ; ozna‡en¡ FAT12
0bb5  eb04           jmp    0bbb
0bb7  90             nop
0bb8  be740a         mov    si,0a74              ; ozna‡en¡ FAT16
0bbb  b90800       * mov    cx,0008              ; d‚lka ozna‡en¡ FAT
0bbe  83c75b         add    di,005b              ; adresa ozna‡en¡ FAT disku
0bc1  f3a4           rep    movsb                ; p©enos ozna‡en¡ FAT do tabulky disku
0bc3  59             pop    cx
0bc4  5e             pop    si
0bc5  07             pop    es
0bc6  5f             pop    di
0bc7  1f             pop    ds
0bc8  c3             ret

                                                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
0bc9  f745230500     test   [di+23],0005
0bce  7403           jz     0bd3
0bd0  e99b00         jmp    0c6e                 ; n vrat (instrukce RET)
0bd3  51           * push   cx
0bd4  52             push   dx
0bd5  06             push   es
0bd6  53             push   bx
0bd7  e8ab00         call   0c85                 ; na‡ten¡ zav dˆc¡ho sektoru
0bda  720b           jc     0be7                 ; chyba na‡ten¡ sektoru
0bdc  83fb00         cmp    bx,0000              ; byla chyba ?
0bdf  7509           jnz    0bea
0be1  e8fc00         call   0ce0                 ; na‡ten¡ parametr– z diskety
0be4  eb60           jmp    0c46
0be6  90             nop


0be7  e98500       * jmp    0c6f

                                                 ; nastaven¡ parametr– diskety podle popisova‡e
0bea  e87301         call   0d60                 ; na‡ten¡ sektoru FAT do pamˆti
0bed  72f8           jc     0be7                 ; chyba na‡ten¡ sektoru
0bef  e86816         call   225a
0bf2  807d2202       cmp    [di+22],02           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
0bf6  7520           jnz    0c18
0bf8  80fcf9         cmp    ah,f9                ; je disketa HD 1.2MB ?
0bfb  757d           jnz    0c7a                 ; nen¡
0bfd  bb1406         mov    bx,0614              ; tabulka parametr– diskety HD 1.2MB
0c00  0e             push   cs
0c01  07             pop    es
0c02  268a870000     mov    al,es:[bx+0000]      ; po‡et sektor– v jedn‚ FAT
0c07  268b8f0300     mov    cx,es:[bx+0003]      ; celkov˜ po‡et sektor– na m‚diu
0c0c  268b970500     mov    dx,es:[bx+0005]      ; DH-po‡et sektor– na alok.blok, DL-po‡et stran
0c11  268b9f0100     mov    bx,es:[bx+0001]      ; BH-po‡et polo‘ek z kl. adres ©e, BL-po‡et sektor– na stopu
0c16  eb2e           jmp    0c46
0c18  8acc           mov    cl,ah
0c1a  80e1f8         and    cl,f8
0c1d  80f9f8         cmp    cl,f8
0c20  7558           jnz    0c7a
0c22  b001           mov    al,01                ; po‡et sektor– v jedn‚ FAT
0c24  bb0840         mov    bx,4008              ; BH-po‡et polo‘ek z kl.adres., BL-po‡et sektor– na stopu
0c27  b94001         mov    cx,0140              ; po‡et sektor– na m‚diu (disketa 160 KB)
0c2a  ba0101         mov    dx,0101              ; DH-po‡et sektor– na alok. blok
0c2d  f6c402         test   ah,02                ; je 8 sektor– ?
0c30  7507           jnz    0c39                 ; je 8 sektor– na stopu
0c32  fec0           inc    al                   ; zv˜¨en¡ na 2 sektory na FAT
0c34  fec3           inc    bl                   ; zv˜¨en¡ n 9 sektor– na stopu
0c36  83c128         add    cx,0028              ; zv˜¨en¡ na kapacitu 180 KB
0c39  f6c401         test   ah,01                ; je oboustrann  disketa ?
0c3c  7408           jz     0c46                 ; nen¡ oboustrann 
0c3e  03c9           add    cx,cx                ; zdvojn soben¡ po‡tu sektor–
0c40  b770           mov    bh,70                ; po‡et polo‘ek z kl. adres ©e
0c42  fec6           inc    dh                   ; po‡et sektor– na blok
0c44  fec2           inc    dl                   ; po‡et stran
0c46  887508         mov    [di+08],dh           ; po‡et sektor– na aloka‡n¡ blok
0c49  887d0c         mov    [di+0c],bh           ; max. po‡et polo‘ek z kl. adres ©e
0c4c  894d0e         mov    [di+0e],cx           ; celkov˜ po‡et sektor– na m‚diu
0c4f  886510         mov    [di+10],ah           ; popisova‡ m‚dia
0c52  884511         mov    [di+11],al           ; po‡et sektor– v jedn‚ FAT
0c55  885d13         mov    [di+13],bl           ; po‡et sektor– na stopu
0c58  885515         mov    [di+15],dl           ; po‡et stran m‚dia
0c5b  c745190000     mov    [di+19],0000         ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
0c60  c745170000     mov    [di+17],0000         ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
0c65  c7451d0000     mov    [di+1d],0000         ; celkov˜ po‡et sektor– odd¡lu - HIGH
0c6a  5b             pop    bx
0c6b  07             pop    es
0c6c  5a             pop    dx
0c6d  59             pop    cx
0c6e  c3           * ret

0c6f  2ec6066a0a00   mov    cs:[0a6a],00
0c75  e85105         call   11c9
0c78  ebf0           jmp    0c6a
0c7a  2ec6066a0a00   mov    cs:[0a6a],00
0c80  b007           mov    al,07
0c82  f9             stc
0c83  ebe5           jmp    0c6a

                                                 ; na‡ten¡ zav dˆc¡ho sektoru
                                                 ; od adresy 0284h
0c85  b600           mov    dh,00                ; hlava 0
0c87  b90100         mov    cx,0001              ; stopa 0, sektor 1 (zav dˆc¡)
0c8a  e8e500         call   0d72                 ; na‡ten¡ sektoru do pamˆti
0c8d  7250           jc     0cdf                 ; chyba zaveden¡ sektoru
0c8f  33db           xor    bx,bx
0c91  2e803e840269   cmp    cs:[0284],69         ; 1. bajt sektoru = 69h ?
0c97  7418           jz     0cb1
0c99  2e803e8402e9   cmp    cs:[0284],e9         ; je instrukce JMP NEAR ... ?
0c9f  7410           jz     0cb1                 ; je OK
0ca1  2e803e8402eb   cmp    cs:[0284],eb         ; je instrukce JMP SHORT ... ?
0ca7  7533           jnz    0cdc                 ; nen¡ - nen¡ zav dˆc¡ sektor
0ca9  2e803e860290   cmp    cs:[0286],90         ; n sleduje instrukce NOP ?
0caf  752b           jnz    0cdc                 ; nen¡ - chyba zav dˆc¡ho sektoru
0cb1  2ea09902     * mov    al,cs:[0299]         ; (7c15h) popisova‡ m‚dia
0cb5  24f0           and    al,f0
0cb7  3cf0           cmp    al,f0                ; je popisova‡ m‚dia ?
0cb9  7521           jnz    0cdc                 ; nen¡ - chyba zav dˆc¡ho sektoru
0cbb  2ea09902       mov    al,cs:[0299]         ; (7c15h) popisova‡ m‚dia
0cbf  a801           test   al,01                ; je oboustrann  disketa ?
0cc1  751a           jnz    0cdd                 ; je oboustrann  disketa
0cc3  2e813e8c02332e cmp    cs:[028c],2e33       ; (7c09h) ‡¡slo verze OS ?
0cca  7508           jnz    0cd4                 ; nen¡ verze DOS 3.x
0ccc  2e803e8e0232   cmp    cs:[028e],32         ; (7c0bh) ‡¡slo podverze OS
0cd2  7309           jnc    0cdd                 ; je verze alespo¤ 3.2
0cd4  2ec606910201   mov    cs:[0291],01         ; (7c0dh) velikost bloku = 1 sektor
0cda  eb01           jmp    0cdd                 ; zav dˆc¡ sektor OK
0cdc  43             inc    bx                   ; indikace chyby zav dˆc¡ho sektoru
0cdd  f8           * clc
0cde  c3             ret
0cdf  c3           * ret

                                                 ; na‡ten¡ parametr– disku ze zav dˆc¡ho sektoru
0ce0  1e             push   ds
0ce1  57             push   di
0ce2  0e             push   cs
0ce3  1f             pop    ds
0ce4  bf8f02         mov    di,028f              ; blok dat z diskety [0284h+0bh]
0ce7  8a7502         mov    dh,[di+02]           ; velikost aloka‡n¡ho bloku
0cea  8a7d06         mov    bh,[di+06]           ; max. po‡et polo‘ek z kl. adres ©e
0ced  8b4d08         mov    cx,[di+08]           ; po‡et sektor– na aloka‡n¡ blok
0cf0  8a650a         mov    ah,[di+0a]           ; typ disku
0cf3  8a450b         mov    al,[di+0b]           ; po‡et sektor– v jednom FAT
0cf6  8a5d0d         mov    bl,[di+0d]           ; po‡et sektor– na stopu
0cf9  8a550f         mov    dl,[di+0f]           ; po‡et hlav disku
0cfc  5f             pop    di
0cfd  1f             pop    ds
0cfe  2e803e6a0a01   cmp    cs:[0a6a],01
0d04  7516           jnz    0d1c
0d06  e81500         call   0d1e                 ; na‡ten¡ identifikace disku
0d09  7206           jc     0d11
0d0b  2ec6066a0a02   mov    cs:[0a6a],02
0d11  2e803ec30101   cmp    cs:[01c3],01         ; 1=p©¡znak, ‘e je mo‘n  indikace v˜mˆny
0d17  7503           jnz    0d1c
0d19  e8d915         call   22f5
0d1c  f8           * clc                         ; OK
0d1d  c3             ret

                                                 ; na‡ten¡ identifikace z disku
                                                 ; VSTUP: DS:DI=tabulka parametr– disku
                                                          CS:[0284h]=zav dˆc¡ sektor disku
0d1e  2e803eaa0229   cmp    cs:[02aa],29         ; [0284h+26h] identifikace s‚riov‚ho ‡¡sla
0d24  7538           jnz    0d5e                 ; chyba - nen¡ identifikace IBM
0d26  51             push   cx                   ; £schova CX
0d27  2e8b0eab02     mov    cx,cs:[02ab]         ; [0284h+27h] s‚riov‚ ‡¡slo disku - datum
0d2c  894d57         mov    [di+57],cx           ; s‚riov‚ ‡¡slo disku - datum
0d2f  2e8b0ead02     mov    cx,cs:[02ad]         ; [0284h+29h] s‚riov‚ ‡¡slo disku - ‡as
0d34  894d59         mov    [di+59],cx           ; s‚riov‚ ‡¡slo disku - ‡as
0d37  1e             push   ds                   ; £schova DS
0d38  57             push   di                   ; £schova DI (ukazatel diskov˜ch parametr–)
0d39  06             push   es                   ; £schova ES
0d3a  56             push   si                   ; £schova SI
0d3b  1e             push   ds
0d3c  07             pop    es                   ; ES <- DS
0d3d  0e             push   cs
0d3e  1f             pop    ds                   ; DS <- CS
0d3f  b90b00         mov    cx,000b              ; d‚lka ozna‡en¡ disku (11 znak– NO NAME)
0d42  beaf02         mov    si,02af              ; [0284h+2bh] ozna‡en¡ disku (NO NAME)
0d45  57             push   di                   ; £schova DI
0d46  83c74b         add    di,004b              ; ozna‡en¡ disku (NO NAME)
0d49  f3a4           rep    movsb                ; p©enos ozna‡en¡ disku
0d4b  5f             pop    di                   ; n vrat DI
0d4c  b90800         mov    cx,0008              ; d‚lka ozna‡en¡ FAT (8 znak–)
0d4f  beba02         mov    si,02ba              ; [0284h+36h] ozna‡en¡ FAT
0d52  83c75b         add    di,005b              ; ozna‡en¡ FAT
0d55  f3a4           rep    movsb                ; p©enos ozna‡en¡ FAT
0d57  5e             pop    si                   ; n vrat SI
0d58  07             pop    es                   ; n vrat ES
0d59  5f             pop    di                   ; n vrat DI
0d5a  1f             pop    ds                   ; n vrat DS
0d5b  59             pop    cx                   ; n vrat CX
0d5c  f8             clc                         ; nastaven¡ OK
0d5d  c3             ret
0d5e  f9           * stc                         ; chyba - nen¡ disketa IBM
0d5f  c3             ret


                                                 ; na‡ten¡ sektoru FAT do pamˆti
0d60  50             push   ax
0d61  b600           mov    dh,00                ; hlava 0
0d63  b90200         mov    cx,0002              ; v lec 0, sektor 2 (FAT)
0d66  e80900         call   0d72                 ; na‡ten¡ sektoru do pamˆti
0d69  7205           jc     0d70                 ; chyba ‡ten¡ sektoru
0d6b  58             pop    ax
0d6c  2e8a27         mov    ah,cs:[bx]           ; identifika‡n¡ bajt (z tabulky FAT)
0d6f  c3             ret
0d70  59           * pop    cx
0d71  c3             ret

                                                 ; na‡ten¡ sektoru do pamˆti
                                                 ; od adresy 0284h
                                                 ; VSTUP: CH=‡¡slo v lce
                                                 ;        CL=‡¡slo sektoru
                                                 ;        DH=‡¡slo hlavy
                                                 ;        [DI+4]=‡¡slo disku
                                                 ; VSTUP: CS:0284 buffer sektoru
                                                 ;        [DI+46]=‡¡slo v lce
0d72  55             push   bp                   ; £schova BP
0d73  bd0300         mov    bp,0003              ; po‡et pokus– o ‡ten¡
0d76  06             push   es                   ; £schova ES
0d77  8a5504         mov    dl,[di+04]           ; fyzick˜ disk
0d7a  bb8402         mov    bx,0284              ; adresa bufferu pro na‡ten¡ sektoru
0d7d  0e             push   cs
0d7e  07             pop    es                   ; ES<-CS (adresa bufferu)
0d7f  b80102       * mov    ax,0201              ; funkce na‡ten¡ sektoru z disku
0d82  cd13           int    13                   ; na‡ten¡ 1 sektoru
0d84  734e           jnc    0dd4                 ; ‡ten¡ OK
0d86  e8af0c       * call   1a38                 ; resetov n¡ disku
0d89  7446           jz     0dd1                 ; chyba-byl ji‘ posledn¡ pokus
0d8b  f745230100     test   [di+23],0001
0d90  75ed           jnz    0d7f                 ; dal¨¡ pokus o ‡ten¡ sektoru
0d92  2e803e191600   cmp    cs:[1619],00
0d98  7514           jnz    0dae                 ;
0d9a  1e             push   ds
0d9b  50             push   ax
0d9c  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
0da1  8a4409         mov    al,[si+09]
0da4  2ea25f02       mov    cs:[025f],al
0da8  c644090f       mov    [si+09],0f
0dac  58             pop    ax
0dad  1f             pop    ds
0dae  b80102         mov    ax,0201              ; funkce na‡ten¡ 1 sektoru
0db1  cd13           int    13                   ; na‡ten¡ 1 sektoru z disku
0db3  9c             pushf
0db4  2e803e191600   cmp    cs:[1619],00
0dba  7510           jnz    0dcc
0dbc  1e             push   ds
0dbd  50             push   ax
0dbe  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
0dc3  2ea05f02       mov    al,cs:[025f]
0dc7  884409         mov    [si+09],al
0dca  58             pop    ax
0dcb  1f             pop    ds
0dcc  9d           * popf
0dcd  7305           jnc    0dd4
0dcf  ebb5           jmp    0d86
0dd1  b2ff         * mov    dl,ff
0dd3  f9             stc
0dd4  2e8816c101   * mov    cs:[01c1],dl         ; ‡¡slo disku
0dd9  2e88165102     mov    cs:[0251],dl         ; aktu ln¡ logick˜ disk
0dde  886d46         mov    [di+46],ch           ; ‡¡slo v lce
0de1  9c             pushf
0de2  e8fd03         call   11e2                 ; na‡ten¡ £daje syst. ‡asova‡e
0de5  9d             popf
0de6  07             pop    es
0de7  5d             pop    bp
0de8  c3             ret


                                                 ; FUNKCE 0FH - test vymˆnitelnosti m‚dia
0de9  e80d00         call   0df9                 ; nalezen¡ disku v tabulce
0dec  f745230100     test   [di+23],0001         ; je vymˆnˆno m‚dium ?
0df1  7503           jnz    0df6                 ; je - nen¡ p©ipraven disk
0df3  e901f9         jmp    06f7                 ; OK
0df6  e9e3f8         jmp    06dc                 ; za©¡zen¡ nen¡ p©ipraveno


                                                 ; nalezen¡ disku v tabulce
                                                 ; VSTUP: AL=po‘adovan˜ fyzick˜ disk
                                                 ; VSTUP: DS:DI=nalezen  tabulka disku
                                                 ;         CY=disk nenalezen

0df9  53           * push   bx                   ; £schova BX
0dfa  0e             push   cs
0dfb  1f             pop    ds                   ; DS <- CS
0dfc  8b3e4c02       mov    di,[024c]            ; adresa 1. diskov‚ jednotky
0e00  2e803ec20101 * cmp    cs:[01c2],01         ; je logick˜ disk (=0) ?
0e06  7207           jc     0e0f                 ; je logick˜ disk
0e08  384504         cmp    [di+04],al           ; je hledan˜ fyzick˜ disk ?
0e0b  7414           jz     0e21                 ; disk byl nalezen
0e0d  eb05           jmp    0e14                 ; disk nesouhlas¡ - dal¨¡ disk
0e0f  384505       * cmp    [di+05],al           ; je logick˜ disk ?
0e12  740d           jz     0e21                 ; disk byl nalezen
0e14  8b5d02       * mov    bx,[di+02]           ; segment adresy n sleduj¡c¡ho disku
0e17  8b3d           mov    di,[di]              ; offset adresy n sleduj¡c¡ho disku
0e19  8edb           mov    ds,bx                ; segment adresy n sleduj¡c¡ho disku
0e1b  83ffff         cmp    di,ffff              ; je konec tabulky ?
0e1e  75e0           jnz    0e00                 ; nen¡ konec - dal¨¡ disk v tabulce
0e20  f9             stc                         ; chyba - disk nenalezen
0e21  5b           * pop    bx
0e22  c3             ret


                                                 ; FUNKCE 09h - v˜stup na diskov‚ za©¡zen¡ s verifikac¡
0e23  2ec70656020301 mov    cs:[0256],0103       ; po‘adovan  operace z pis s verifikac¡
0e2a  eb07           jmp    0e33

                                                 ; FUNKCE 08h - v˜stup na diskov‚ za©¡zen¡
0e2c  2ec70656020300 mov    cs:[0256],0003       ; po‘adovan  operace z pis
0e33  e89400       * call   0eca
0e36  7203           jc     0e3b
0e38  e9bcf8         jmp    06f7                 ; OK
0e3b  e9a4f8         jmp    06e2                 ; chyba
0e3e  e88300         call   0ec4                 ; ‡ten¡ z disku
0e41  ebf3           jmp    0e36

                                                 ; FUNKCE 04h - vstup z diskov‚ho za©¡zen¡
                                                 ; inicializace logick‚ho disku
0e43  50             push   ax
0e44  53             push   bx
0e45  8b5d23         mov    bx,[di+23]
0e48  f6c321         test   bl,21
0e4b  7562           jnz    0eaf                 ; nen¡ logick˜ disk
0e4d  f6c310         test   bl,10
0e50  745d           jz     0eaf                 ; nen¡ logick˜ disk
0e52  8a4504         mov    al,[di+04]           ; fyzick˜ disk
0e55  1e             push   ds
0e56  57             push   di
0e57  0e             push   cs
0e58  1f             pop    ds
0e59  bf4c02         mov    di,024c              ; adresa tabulky
0e5c  8b5d02       * mov    bx,[di+02]           ; segment tabulky
0e5f  8b3d           mov    di,[di]              ; offset tabulky
0e61  8edb           mov    ds,bx                ; segment tabulky
0e63  83ffff         cmp    di,ffff              ; je ji‘ posledn¡ tabulka ?
0e66  744a           jz     0eb2                 ; je posledn¡
0e68  384504         cmp    [di+04],al           ; je hledan˜ fyzick˜ disk ?
0e6b  75ef           jnz    0e5c                 ; nen¡ - dal¨¡ tabulka
0e6d  8b5d23         mov    bx,[di+23]           ; disk nalezen
0e70  f6c320         test   bl,20
0e73  74e7           jz     0e5c
0e75  80f320         xor    bl,20
0e78  895d23         mov    [di+23],bx
0e7b  5f             pop    di
0e7c  1f             pop    ds
0e7d  33db           xor    bx,bx
0e7f  80cb20         or     bl,20
0e82  095d23         or     [di+23],bx
0e85  2e803ec70101   cmp    cs:[01c7],01
0e8b  7422           jz     0eaf
0e8d  2e803ec40102   cmp    cs:[01c4],02
0e93  7517           jnz    0eac                 ; nutn‚ vymˆnit logick˜ disk
0e95  1e             push   ds
0e96  57             push   di
0e97  50             push   ax
0e98  8a4505         mov    al,[di+05]           ; ‡¡slo logick‚ho disku
0e9b  8ae0           mov    ah,al
0e9d  33ff           xor    di,di
0e9f  8edf           mov    ds,di
0ea1  86060405       xchg   al,[0504]
0ea5  3ae0           cmp    ah,al
0ea7  58             pop    ax
0ea8  5f             pop    di
0ea9  1f             pop    ds
0eaa  7403           jz     0eaf                 ; logick˜ disk je ji‘ nastaven˜
0eac  e82f11       * call   1fde                 ; hl ¨en¡ o v˜mˆnˆ disku
0eaf  5b           * pop    bx
0eb0  58             pop    ax
0eb1  c3             ret

0eb2  f9             stc
0eb3  5f             pop    di
0eb4  1f             pop    ds
0eb5  ebf8           jmp    0eaf

0eb7  b008         * mov    al,08
0eb9  eb02           jmp    0ebd

0ebb  b007         * mov    al,07
0ebd  f9             stc
0ebe  c3           * ret

0ebf  b00f           mov    al,0f
0ec1  e91501         jmp    0fd9

                                                 ; ‡ten¡ dat z disku
                                                 ; VSTUP: DI=ukl dac¡ adresa pro diskovou operaci
                                                 ;        AL=po‘adovan˜ fyzick˜ disk
                                                 ;        CX=po‡et sektor– k na‡ten¡

0ec4  2ec606560202   mov    cs:[0256],02         ; po‘adovan  operace - ‡ten¡
0eca  8bdf           mov    bx,di                ; adresa bufferu pro diskovou operaci
0ecc  e82aff         call   0df9                 ; nalezen¡ disku v tabulce
0ecf  8a4510         mov    al,[di+10]           ; popisova‡ m‚dia
0ed2  2ea25402       mov    cs:[0254],al         ; popisova‡ m‚dia
0ed6  e3e6           jcxz   0ebe                 ; nen¡ ‘ dn˜ sektor k na‡ten¡ - n vrat
0ed8  f745230002     test   [di+23],0200
0edd  75dc           jnz    0ebb                 ; chybov˜ n vrat
0edf  2e890e5802     mov    cs:[0258],cx         ; po‡et sektor– pro disk. operaci
0ee4  2e89266a02     mov    cs:[026a],sp         ; £schova ukazatele z sobn¡ku
0ee9  8bc2           mov    ax,dx
0eeb  33f6           xor    si,si
0eed  03d1           add    dx,cx
0eef  83d600         adc    si,0000
0ef2  837d0e00       cmp    [di+0e],0000         ; po‡et sektor– na m‚diu pro 1-slovn¡ zad n¡
0ef6  740c           jz     0f04                 ; nen¡ - je 2-slovn¡ £daj
0ef8  83fe00         cmp    si,0000
0efb  75ba           jnz    0eb7
0efd  3b550e         cmp    dx,[di+0e]           ; po‡et sektor– na m‚diu pro 1-slovn¡ zad n¡
0f00  77b5           ja     0eb7
0f02  eb11           jmp    0f15
0f04  2e03368b0a   * add    si,cs:[0a8b]
0f09  3b751d         cmp    si,[di+1d]           ; celkov˜ po‡et sektor– odd¡lu - HIGH
0f0c  7207           jc     0f15
0f0e  77a7           ja     0eb7
0f10  3b551b         cmp    dx,[di+1b]           ; celkov˜ po‡et sektor– odd¡lu - LOW
0f13  77a2           ja     0eb7
0f15  2e8b168b0a   * mov    dx,cs:[0a8b]
0f1a  034517         add    ax,[di+17]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
0f1d  135519         adc    dx,[di+19]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
0f20  2ea38d0a       mov    cs:[0a8d],ax         ; £schova po‡ te‡n¡ho relativn¡ho sektoru - LOW
0f24  1e             push   ds                   ; £schova DS
0f25  33c0           xor    ax,ax                ; AX <- 0000
0f27  8ed8           mov    ds,ax                ; DS <- 0000
0f29  c5367800       lds    si,[0078]            ; DS:SI <- INT 1EH adresa disketov˜ch parametr–
0f2d  2e89366202     mov    cs:[0262],si         ; ukazatel diskov˜ch parametr– INT 1EH
0f32  2e8c1e6402     mov    cs:[0264],ds         ; ukazatel diskov˜ch parametr– - segment
0f37  1f             pop    ds                   ; n vrat DS
0f38  f745230100     test   [di+23],0001
0f3d  7509           jnz    0f48
þ0f3f  e801ff         call   0e43                 ; inicializace logick‚ho disku
0f42  e85312         call   2198
0f45  e85000         call   0f98                 ; nastaven¡ parametr– diskov‚ mechaniky
0f48  8bc2         * mov    ax,dx                ; po‡ te‡n¡ rel. sektor - HIGH
0f4a  33d2           xor    dx,dx                ; DX <- 0000
0f4c  f77513         div    w/[di+13]            ; /po‡et sektor– na stopu -> ‡¡slo stopy HIGH
0f4f  2ea3890a       mov    cs:[0a89],ax         ; ‡¡slo po‡ te‡n¡ stopy - HIGH
0f53  2ea18d0a       mov    ax,cs:[0a8d]         ; n vrat po‡ te‡n¡ho relativn¡ho sektoru - LOW
0f57  f77513         div    w/[di+13]            ; /po‡et sektor– na stopu -> ‡¡slo stopy LOW
0f5a  fec2           inc    dl                   ; ‡¡slo sektoru na stopˆ
0f5c  2e88166602     mov    cs:[0266],dl         ; ‡¡slo sektoru pro disk. operaci
0f61  8b4d15         mov    cx,[di+15]           ; po‡et stran m‚dia
0f64  50             push   ax                   ; ‡¡slo stopy - LOW
0f65  33d2           xor    dx,dx                ; DX <- 0000
0f67  2ea1890a       mov    ax,cs:[0a89]         ; ‡¡slo po‡ te‡n¡ stopy - HIGH
0f6b  f7f1           div    cx                   ; /po‡et stran -> ‡¡slo v lce - HIGH
0f6d  2ea3890a       mov    cs:[0a89],ax         ; ‡¡slo po‡ te‡n¡ho v lce - HIGH
0f71  58             pop    ax                   ; ‡¡slo stopy - HIGH
0f72  f7f1           div    cx                   ; /po‡et stran -> ‡¡slo v lce - LOW
0f74  2e833e890a00   cmp    cs:[0a89],0000       ; ‡¡slo po‡ te‡n¡ stopy - HIGH = 0 ?
0f7a  7719           ja     0f95                 ; nen¡ = 0 - chyba
0f7c  3d0004         cmp    ax,0400              ; ‡¡slo stopy - LOW je men¨¡ ne‘ 1024 ?
0f7f  7714           ja     0f95                 ; je vˆt¨¡ - chyba
0f81  2e88166702     mov    cs:[0267],dl         ; hlava pro disk. operaci
0f86  2ea36802       mov    cs:[0268],ax         ; ‡¡slo stopy pro disk. operaci
0f8a  2ea15802       mov    ax,cs:[0258]         ; po‡et sektor– pro disk. operaci
0f8e  e88600         call   1017                 ; na‡ten¡ po‘adovan‚ho po‡tu sektor–
0f91  e84c00         call   0fe0                 ; n vrat diskov˜ch parametr–
0f94  c3             ret
0f95  e91fff       * jmp    0eb7


                                                 ; nastaven¡ parametr– diskov‚ mechaniky
                                                 ; VSTUP: DS:DI=tabulka parametr– disku

0f98  8a4504         mov    al,[di+04]           ; fyzick˜ disk
0f9b  2ea25102       mov    cs:[0251],al         ; aktu ln¡ logick˜ disk
0f9f  2e803e191600   cmp    cs:[1619],00
0fa5  7538           jnz    0fdf
0fa7  8cd9           mov    cx,ds                ; CX <- DS
0fa9  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
0fae  2ea06002       mov    al,cs:[0260]         ; max. po‡et sektor– na stopu
0fb2  884404         mov    [si+04],al           ; nastaven¡ ‡¡sla posledn¡ho sektoru na stopˆ
0fb5  8a440a         mov    al,[si+0a]           ; ‡as startu motoru disketov‚ mechaniky
0fb8  2ea25b02       mov    cs:[025b],al         ; ‡as startu motoru disketov‚ mechaniky
0fbc  06             push   es                   ; £schova ES
0fbd  8ec1           mov    es,cx                ; ES <- DS
0fbf  26807d2202     cmp    es:[di+22],02        ; typ disku = 720K ?
0fc4  7505           jnz    0fcb                 ; nen¡ disk 720K
0fc6  b004           mov    al,04                ; del¨¡ doba startu motoru pro mechaniku 720K
0fc8  86440a         xchg   al,[si+0a]           ; nastaven¡ nov‚ doby startu motoru
0fcb  07           * pop    es                   ; n vrat ES
0fcc  32c0           xor    al,al                ; AL <- 0
0fce  fec0           inc    al                   ; AL <- 1 nov  doba pro ust len¡ hlavy
0fd0  864409         xchg   al,[si+09]           ; nastaven¡ doby ust len¡ hlavy
0fd3  2ea25c02       mov    cs:[025c],al         ; doba pro ust len¡ hlavy mechaniky
0fd7  b00f           mov    al,0f                ; po‡et sektor– pro diskovou operaci = 15
0fd9  8ed9           mov    ds,cx                ; n vrat hodnoty DS
0fdb  2ea25d02       mov    cs:[025d],al         ; po‡et sektor– pro disk. operaci
0fdf  c3           * ret


                                                 ; n vrat diskov˜ch parametr–

0fe0  f745230100     test   [di+23],0001
0fe5  752f           jnz    1016
0fe7  e8f801         call   11e2                 ; na‡ten¡ £daje syst. ‡asova‡e
0fea  9c             pushf
0feb  2e803e191600   cmp    cs:[1619],00
0ff1  7522           jnz    1015
0ff3  50             push   ax
0ff4  8cda           mov    dx,ds
0ff6  2ea05c02       mov    al,cs:[025c]         ; doba pro ust len¡ hlavy mechaniky
0ffa  2e8a265b02     mov    ah,cs:[025b]         ; doba pro start motoru disket. mechaniky
0fff  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
1004  c6440409       mov    [si+04],09           ; posledn¡ sektor na stopˆ
1008  884409         mov    [si+09],al           ; doba pro ust len¡ hlavy
100b  c6440302       mov    [si+03],02           ; velikost sektoru = 512 bajt–
100f  88640a         mov    [si+0a],ah           ; doba pro start motoru disket. mechaniky
1012  8eda           mov    ds,dx
1014  58             pop    ax
1015  9d             popf
1016  c3           * ret

                                                 ; diskov  operace
1017  0bc0         * or     ax,ax                ; po‡et sektor– pro disjk. operaci
1019  74fb           jz     1016                 ; nen¡ ‘ dn˜ sektor - n vrat
101b  f745230100     test   [di+23],0001
1020  740f           jz     1031
1022  2ef7068f0a8000 test   cs:[0a8f],0080
1029  7406           jz     1031
102b  e82900         call   1057                 ; sekven‡n¡ diskov  operace
102e  33c0           xor    ax,ax
1030  c3             ret
1031  8a4d13       * mov    cl,[di+13]           ; po‡et sektor– na stopu
1034  fec1           inc    cl                   ; posledn¡ sektor + 1
1036  2e2a0e6602     sub    cl,cs:[0266]         ; - ‡¡slo sektoru pro disk. operaci
103b  32ed           xor    ch,ch
103d  3bc1           cmp    ax,cx
103f  7302           jnc    1043
1041  8bc8           mov    cx,ax
1043  50           * push   ax
1044  51             push   cx
1045  8bc1           mov    ax,cx                ; po‡et sektor– ke ‡ten¡
1047  e80d00         call   1057                 ; sekven‡n¡ diskov  operace
104a  59             pop    cx
104b  58             pop    ax
104c  2bc1           sub    ax,cx
104e  d0e1           shl    cl,1
1050  02f9           add    bh,cl                ; zv˜¨en¡ ukl dac¡ adresy
1052  ebc3           jmp    1017                 ; dal¨¡ ‡ten¡

1054  e9ec00         jmp    1143

                                                 ; sekven‡n¡ diskov  operace
                                                 ; AL=po‡et sektor–
1057  bd0500         mov    bp,0005              ; po‡et pokus– o diskovou operaci
105a  2e892e920a     mov    cs:[0a92],bp         ; po‡et pokus– o diskovou operaci
105f  2e892e940a     mov    cs:[0a94],bp         ; po‡et pokus– o verifikaci po z pisu
1064  2e8a265602     mov    ah,cs:[0256]         ; po‘adovan  operace s diskem
1069  50             push   ax
106a  2e8b166802     mov    dx,cs:[0268]         ; ‡¡slo stopy pro disk. operaci
106f  f745230100     test   [di+23],0001
1074  7409           jz     107f
1076  837d4701       cmp    [di+47],0001         ; ‡as posledn¡ operace s diskem - LOW
107a  7503           jnz    107f
107c  035549         add    dx,[di+49]           ; p©i‡ten¡ skryt˜ch stop
107f  d0ce         * ror    dh,1                 ; nejvy¨¨¡ 2 bity ‡¡sla stopy
1081  d0ce           ror    dh,1
1083  2e0a366602     or     dh,cs:[0266]         ; ‡¡slo sektoru pro disk. operaci
1088  8bca           mov    cx,dx                ; ‡¡slo stopy a ‡¡slo sektoru
108a  86e9           xchg   ch,cl
108c  2e8a366702     mov    dh,cs:[0267]         ; hlava pro disk. operaci
1091  8a5504         mov    dl,[di+04]           ; fyzick˜ disk
1094  807d2205       cmp    [di+22],05           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
1098  7415           jz     10af                 ; proveden¡ diskov‚ operace
109a  2e803ec101ff   cmp    cs:[01c1],ff         ; typ disku
10a0  740a           jz     10ac
10a2  80fc02         cmp    ah,02                ; je funkce ‡ten¡ z disku ?
10a5  7408           jz     10af                 ; je ‡ten¡ sektor– z disku
10a7  80fc04         cmp    ah,04                ; je verifikace sektor– ?
10aa  7403           jz     10af                 ; je verifikace sektor–
10ac  eb5e         * jmp    110c                 ; jin  operace
10ae  90             nop
10af  e80901       * call   11bb                 ; proveden¡ diskov‚ operace
10b2  72a0           jc     1054                 ; chyba diskov‚ operace
10b4  2e8816c101     mov    cs:[01c1],dl         ; ‡¡slo fyzick‚ho disku
10b9  886d46         mov    [di+46],ch           ; ‡¡slo v lce
10bc  2e813e56020301 cmp    cs:[0256],0103       ; po‘adovan  operace z pis s verifikac¡ ?
10c3  7458           jz     111d                 ; proveden¡ verifikace po z pisu
10c5  58             pop    ax
10c6  f745230100     test   [di+23],0001
10cb  7409           jz     10d6
10cd  2ef7068f0a8000 test   cs:[0a8f],0080
10d4  7534           jnz    110a
10d6  80e13f         and    cl,3f                ; ‡¡slo sektoru
10d9  32e4           xor    ah,ah
10db  2e29065802     sub    cs:[0258],ax         ; sn¡‘en¡ ‡¡ta‡e sektor–
10e0  02c8           add    cl,al                ; zv˜¨en¡ ukazatele sektoru
10e2  2e880e6602     mov    cs:[0266],cl         ; ‡¡slo sektoru pro disk. operaci
10e7  3a4d13         cmp    cl,[di+13]           ; p©ekro‡eno ‡¡slo sektoru ?
10ea  761e           jna    110a                 ; nen¡ p©ekro‡eno
10ec  2ec606660201   mov    cs:[0266],01         ; ‡¡slo sektoru pro disk. operaci=1
10f2  2e8a366702     mov    dh,cs:[0267]         ; hlava pro disk. operaci
10f7  fec6           inc    dh                   ; zv˜¨en¡ ‡¡sla hlavy
10f9  3a7515         cmp    dh,[di+15]           ; p©ekro‡eno ‡¡slo hlavy ?
10fc  7207           jc     1105                 ; nen¡ p©ekro‡eno
10fe  32f6           xor    dh,dh                ; ‡¡slo hlavy=0
1100  2eff066802     inc    w/cs:[0268]          ; zv˜¨en¡ ‡¡sla stopy diskov‚ operace
1105  2e88366702   * mov    cs:[0267],dh         ; hlava pro disk. operaci
110a  f8           * clc
110b  c3             ret

110c  2e3a16c101     cmp    dl,cs:[01c1]
1111  7505           jnz    1118
1113  3a6d46         cmp    ch,[di+46]
1116  7497           jz     10af
1118  e87900       * call   1194
111b  eb95           jmp    10b2
                                                 ; verifikace po z pisu
111d  58             pop    ax
111e  50             push   ax                   ; AL=po‡et sektor–
111f  b404           mov    ah,04                ; funkce verifikace sektor–
1121  e89700         call   11bb                 ; proveden¡ diskov‚ operace
1124  739f           jnc    10c5                 ; verifikace OK - pokra‡ov n¡
1126  80fc11         cmp    ah,11                ; byla provedena korekce ECC ?
1129  750d           jnz    1138                 ; ne£spˆ¨n  operace - dal¨¡ pokus
112b  2eff0e940a     dec    w/cs:[0a94]          ; po‡et pokus– o verifikaci po z pisu
1130  7493           jz     10c5                 ; byl to ji‘ posledn¡ pokus
1132  e80809         call   1a3d
1135  eb3d           jmp    1174
1137  90             nop
                                                 ; ne£spˆ¨n  disk.operace - dal¨¡ pokus
1138  e80209       * call   1a3d
113b  2eff0e920a     dec    w/cs:[0a92]          ; po‡et pokus– o diskovou operaci
1140  eb18           jmp    115a
1142  90             nop

1143  e8c910         call   220f
1146  2e803e960a01   cmp    cs:[0a96],01
114c  7509           jnz    1157
114e  bd0100         mov    bp,0001
1151  2ec606960a00   mov    cs:[0a96],00
1157  e8de08         call   1a38
115a  7421         * jz     117d
115c  f745230100     test   [di+23],0001
1161  7505           jnz    1168
1163  80fc80         cmp    ah,80
1166  7415           jz     117d
1168  80fccc         cmp    ah,cc
116b  740b           jz     1178
116d  2ec706940a0500 mov    cs:[0a94],0005       ; po‡et pokus– o verifikaci po z pisu
1174  58             pop    ax
1175  e9f1fe         jmp    1069

1178  bd0100         mov    bp,0001
117b  ebf7           jmp    1174
117d  e84900         call   11c9
1180  2ec6065102ff   mov    cs:[0251],ff         ; aktu ln¡ logick˜ disk
1186  2e8b0e5802     mov    cx,cs:[0258]         ; po‡et sektor– pro disk. operaci
118b  2e8b266a02     mov    sp,cs:[026a]         ; n vrat ukazatele z sobn¡ku
1190  e857fe         call   0fea
1193  c3             ret

1194  2e803e191600   cmp    cs:[1619],00
119a  751f           jnz    11bb                 ; proveden¡ diskov‚ operace
119c  1e             push   ds
119d  50             push   ax
119e  2ea05d02       mov    al,cs:[025d]         ; po‡et sektor– pro disk. operaci
11a2  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
11a7  884409         mov    [si+09],al
11aa  58             pop    ax
11ab  1f             pop    ds
11ac  e80c00         call   11bb                 ; proveden¡ diskov‚ operace
11af  1e             push   ds
11b0  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
11b5  c6440901       mov    [si+09],01
11b9  1f             pop    ds
11ba  c3             ret
                                                 ; proveden¡ diskov‚ operace
                                                 ; VSTUP: CH=‡¡slo v lce
                                                 ;        CL=‡¡slo sektoru
                                                 ;        DH=‡¡slo hlavy
                                                 ;        DL=‡¡slo disku
                                                 ;        AH=po‘adovan  funkce
                                                 ;        AL=po‡et sektor–
11bb  f6451f80     * test   [di+1f],80
11bf  7503           jnz    11c4
11c1  cd13           int    13                   ; diskov  operace
11c3  c3           * ret
11c4  f9           * stc
11c5  b480           mov    ah,80
11c7  ebfa           jmp    11c3

11c9  51             push   cx
11ca  0e             push   cs
11cb  07             pop    es
11cc  8ac4           mov    al,ah
11ce  2ea27902       mov    cs:[0279],al
11d2  b90900         mov    cx,0009
11d5  bf7102         mov    di,0271
11d8  f2ae           repnz  scasb
11da  2e8a850800     mov    al,cs:[di+0008]
11df  59             pop    cx
11e0  f9             stc
11e1  c3             ret

                                                 ; na‡ten¡ £daje syst. ‡asova‡e
11e2  50             push   ax
11e3  32e4           xor    ah,ah                ; funkce ‡ten¡ syst‚mov‚ho ‡asova‡e
11e5  cd1a           int    1a                   ; ‡ten¡ syst‚mov‚ho ‡asova‡e
11e7  0ac0           or     al,al                ; byl p©elom 24 hodin ?
11e9  7405           jz     11f0                 ; nebyl
11eb  2eff062806     inc    w/cs:[0628]          ; zv˜¨en¡ ‡¡ta‡e dn– od 1.1.1980
11f0  3b5547         cmp    dx,[di+47]           ; ‡as posledn¡ operace s diskem - LOW
11f3  7505           jnz    11fa                 ; nen¡ shodn˜ ‡as
11f5  3b4d49         cmp    cx,[di+49]           ; vy¨¨¡ ‡ st ‡¡ta‡e ‡asu
11f8  740c           jz     1206                 ; je shodn˜ ‡as
11fa  2ec606500200 * mov    cs:[0250],00         ; aktu ln¡ fyzick˜ disk = 0
1200  895547         mov    [di+47],dx           ; ‡as posledn¡ operace s diskem - LOW
1203  894d49         mov    [di+49],cx           ; nastaven¡ £daje ‡asu (HIGH)
1206  f8           * clc
1207  58             pop    ax
1208  c3             ret

1209                 dw     0                    ; £schova registru AX p©i INT 13h
120b                 dw     0                    ; £schova registru BX p©i INT 13h
120d                 dw     0                    ; £schova registru CX p©i INT 13h
120f                 dw     0                    ; £schova registru DX p©i INT 13h
1211                 dw     0                    ; £schova registru DI p©i INT 13h
1213                 dw     0                    ; £schova registru SI p©i INT 13h
1215                 dw     0                    ; £schova registru BP p©i INT 13h
1217                 dw     0                    ; £schova registru DS p©i INT 13h
1219                 dw     0                    ; £schova registru ES p©i INT 13h

121b                 db     0                    ; ‡¡slo disku (registr DX)
                     db     0

121d                 dw     0                    ; £schova registru p©¡znak– p©i INT 13h

; -----------------------------------------------------------------------------
;                             Obsluha INT 13H
; -----------------------------------------------------------------------------

121f                                             ; vlastn¡ obsluha INT 13H
                                                 ; (diskov‚ operace)
121f  2ea3c000       mov    cs:[00c0],ax         ; £schova registru AX
1223  9c             pushf                       ; £schova p©¡znakov‚ho registru
1224  80fc05         cmp    ah,05                ; je po‘adov no form tov n¡ stopy ?
1227  750a           jnz    1233                 ; nen¡ form tov n¡
1229  2ec70652024001 mov    cs:[0252],0140       ; p©¡znak - disketa vymˆnˆna,
1230  e88d10         call   22c0                 ; nastaven¡ p©¡znaku v tabulk ch disk–
1233  f6c280       * test   dl,80                ; je pevn˜ disk ?
1236  752c           jnz    1264                 ; je pevn˜ disk
1238  2e803e910a00   cmp    cs:[0a91],00         ; je instalov n nˆjak˜ disk ?
123e  7424           jz     1264                 ; nen¡ instalov n ‘ dn˜ disk
1240  50             push   ax
1241  53             push   bx
1242  51             push   cx
1243  8aca           mov    cl,dl                ; disk
1245  b001           mov    al,01
1247  d2e0           shl    al,cl                ; bit
1249  2e8406910a     test   cs:[0a91],al         ; je instalov n tento disk ?
124e  7411           jz     1261                 ; nen¡ instalov n tento disk
1250  8ada           mov    bl,dl                ; disketov  jednotka
1252  32ff           xor    bh,bh
1254  06             push   es
1255  b84000         mov    ax,0040
1258  8ec0           mov    es,ax                ; ES <- 0040h segment dat
125a  26c687900093   mov    es:[bx+0090],93      ; stav jednotky: 250K/s, 360K
1260  07             pop    es
1261  59           * pop    cx
1262  5b             pop    bx
1263  58             pop    ax
1264  2e803e0c1dfa * cmp    cs:[1d0c],fa         ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
126a  750a           jnz    1276
126c  80fc08         cmp    ah,08                ; funkce poskytnut¡ diskov˜ch parametr–
126f  7412           jz     1283                 ; je poskytnut¡ disk. parametr–
1271  80fc15         cmp    ah,15                ; je ‡ten¡ typu DASD ?
1274  740d           jz     1283                 ; je ‡ten¡ typu DASD
1276  2eff1eb400   * call   far cs:[00b4]        ; vol n¡ p–vodn¡ obsluhy INT 13h
127b  7203           jc     1280                 ; chyba
127d  ca0200         ret    far  0002            ; n vrat se zru¨en¡m registru p©¡znak–
1280  e98000       * jmp    1303                 ; chyba diskov‚ operace - reset disku
                                                 ; poskytnut¡ informac¡ o disku
1283  2e89161b12     mov    cs:[121b],dx         ; DL=‡¡slo disku
1288  2eff1eb400     call   far cs:[00b4]        ; vol n¡ p–vodn¡ obsluhy INT 13h
128d  2ea30912       mov    cs:[1209],ax         ; £schova registru AX
1291  2e891e0b12     mov    cs:[120b],bx         ; £schova registru BX
1296  2e890e0d12     mov    cs:[120d],cx         ; £schova registru CX
129b  2e89160f12     mov    cs:[120f],dx         ; £schova registru DX
12a0  2e893e1112     mov    cs:[1211],di         ; £schova registru DI
12a5  2e89361312     mov    cs:[1213],si         ; £schova registru SI
12aa  2e892e1512     mov    cs:[1215],bp         ; £schova registru BP
12af  2e8c1e1712     mov    cs:[1217],ds         ; £schova registru DS
12b4  2e8c061912     mov    cs:[1219],es         ; £schova registru ES
12b9  9c             pushf
12ba  2e8f061d12     pop    cs:[121d]            ; £schova registru p©¡znak–
12bf  2e8b161b12     mov    dx,cs:[121b]         ; ‡¡slo disku
12c4  9c             pushf
12c5  b401           mov    ah,01                ; funkce poskytnut¡ syst. stavu disku
12c7  2eff1eb400     call   far cs:[00b4]        ; vol n¡ p–vodn¡ obsluhy INT 13h
12cc  2ea10912       mov    ax,cs:[1209]         ; n vrat registru AX
12d0  2e8b1e0b12     mov    bx,cs:[120b]         ; n vrat registru BX
12d5  2e8b0e0d12     mov    cx,cs:[120d]         ; n vrat registru CX
12da  2e8b160f12     mov    dx,cs:[120f]         ; n vrat registru DX
12df  2e8b3e1112     mov    di,cs:[1211]         ; n vrat registru DI
12e4  2e8b361312     mov    si,cs:[1213]         ; n vrat registru SI
12e9  2e8b2e1512     mov    bp,cs:[1215]         ; n vrat registru BP
12ee  2e8e1e1712     mov    ds,cs:[1217]         ; n vrat registru DS
12f3  2e8e061912     mov    es,cs:[1219]         ; n vrat registru ES
12f8  2eff361d12     push   cs:[121d]            ; registr p©¡znak–
12fd  9d             popf                        ; n vrat registru p©¡znak–
12fe  7203           jc     1303                 ; byla chyba diskov‚ operace
1300  ca0200         ret    far  0002            ; n vrat z obsluhy INT 13h

                                                 ; chyba diskov‚ operace
1303  9c             pushf                       ; £schova registru p©¡znak–
1304  80fc09         cmp    ah,09                ; byla inicializace tabulky pevn‚ho disku
1307  7408           jz     1311                 ; byla inicializace tabulky
1309  80fc11         cmp    ah,11                ; bylo p©ekalibrov n¡ pevn‚ho disku ?
130c  7403           jz     1311                 ; p©ekalibrov n¡ pevn‚ho disku
130e  eb4f           jmp    135f                 ; n vrat z obsluhy INT 13h
1310  90             nop
1311  1e           * push   ds
1312  57             push   di
1313  50             push   ax
1314  2ec606c20101   mov    cs:[01c2],01         ; p©¡znak - nen¡ logick˜ disk
131a  8ac2           mov    al,dl                ; ‡¡slo disku
131c  e8dafa         call   0df9                 ; nalezen¡ disku v tabulce
131f  2ec606c20100   mov    cs:[01c2],00         ; p©¡znak - je logick˜ disk
1325  58             pop    ax
1326  5f             pop    di
1327  1f             pop    ds
1328  7235           jc     135f
132a  80fc09         cmp    ah,09                ; je inicializace tabulky pevn‚ho disku ?
132d  7503           jnz    1332                 ; nen¡
132f  e98200         jmp    13b4                 ; je inicializace tabulky
1332  2e803e191601   cmp    cs:[1619],01
1338  7425           jz     135f
133a  2e803e0c1dfe   cmp    cs:[1d0c],fe         ; syst‚mov˜ model = PC XT ?
1340  7318           jnc    135a                 ; je PC XT nebo PC
1342  2e803e0c1dfb   cmp    cs:[1d0c],fb         ; syst‚mov˜ model = XT ?
1348  7410           jz     135a                 ; je XT
134a  2e803e0c1dfc   cmp    cs:[1d0c],fc         ; syst‚mov˜ model = AT ?
1350  750d           jnz    135f                 ; nen¡ ani AT
1352  2e803e0d1d02   cmp    cs:[1d0d],02         ; je XT-286 ?
1358  7705           ja     135f                 ; je XT-286
135a  80fc11       * cmp    ah,11                ; je p©ekalibrov n¡ disk. driveru ?
135d  7404           jz     1363                 ; p©ekalibrov n¡ pevn‚ho disku pro star¨¡ verze PC
135f  9d           * popf
1360  ca0200         ret    far  0002
1363  32e4         * xor    ah,ah                ; funkce resetov n¡ disku
1365  2eff1eb400     call   far cs:[00b4]        ; p–vodn¡ obsluha INT 13
136a  2ea1c000       mov    ax,cs:[00c0]         ; £schova registru AX p©i INT 13
136e  3c01           cmp    al,01                ;
1370  7505           jnz    1377
1372  32e4           xor    ah,ah                ; operace probˆhla OK
1374  ca0200         ret    far  0002            ; n vrat z obsluhy INT 13
1377  53           * push   bx
1378  51             push   cx
1379  52             push   dx
137a  2ea2c200       mov    cs:[00c2],al
137e  2ea1c000     * mov    ax,cs:[00c0]         ; £schova registru AX p©i INT 13
1382  b001           mov    al,01                ; p©¡rustek ‡¡sla sektoru
1384  e8a708         call   1c2e                 ; nastaven¡ stopy a sektoru disku
1387  9c             pushf
1388  2eff1eb400     call   far cs:[00b4]        ; vyvol n¡ p–vodn¡ funkce
138d  730f           jnc    139e                 ; OK
138f  80fc11         cmp    ah,11                ; je p©ekalibrov n¡ disk. driveru ?
1392  7519           jnz    13ad                 ; nen¡
1394  b400           mov    ah,00                ; funkce resetov n¡ disku
1396  9c             pushf
1397  2eff1eb400     call   far cs:[00b4]        ; vyvol n¡ p–vodn¡ funkce
139c  33c0           xor    ax,ax
139e  2efe0ec200   * dec    b/cs:[00c2]
13a3  7409           jz     13ae                 ; n vrat
13a5  fec1           inc    cl
13a7  fec7           inc    bh
13a9  fec7           inc    bh
13ab  ebd1           jmp    137e
13ad  f9             stc
13ae  5a           * pop    dx
13af  59             pop    cx
13b0  5b             pop    bx
13b1  ca0200         ret    far  0002            ; n vrat z INT 13

13b4  58             pop    ax
13b5  2ea1c000       mov    ax,cs:[00c0]         ; p–vodn¡ obsah registru AX
13b9  fb             sti
13ba  80fc02         cmp    ah,02                ; bylo ‡ten¡ sektoru ?
13bd  7266           jc     1425                 ; =00 nebo 01:skok na p–vodn¡ obsluhu
13bf  80fc04         cmp    ah,04                ; verifikace dat ?
13c2  7439           jz     13fd                 ; je verifikace dat
13c4  80fc05         cmp    ah,05                ; je form tov n¡ ?
13c7  7446           jz     140f                 ; je form tov n¡ stopy
13c9  775a           ja     1425                 ; skok na p–vodn¡ obsluhu
13cb  52             push   dx
13cc  51             push   cx
13cd  53             push   bx
13ce  50             push   ax
13cf  55             push   bp
13d0  8bec           mov    bp,sp                ; £schova SP
13d2  8cc2           mov    dx,es                ; segment
13d4  d1e2           shl    dx,1
13d6  d1e2           shl    dx,1
13d8  d1e2           shl    dx,1
13da  d1e2           shl    dx,1                 ; dx*16
13dc  03d3           add    dx,bx                ; +offset bufferu
13de  81c2ff01       add    dx,01ff              ; konec bufferu
13e2  7306           jnc    13ea                 ; nen¡ p©elom 64KB
                                                 ; zde nastal p©echod p©es hranici 64KB
13e4  8a7609         mov    dh,[bp+09]
13e7  e99a00         jmp    1484
13ea  d0ee         * shr    dh,1
13ec  b480           mov    ah,80
13ee  2ae6           sub    ah,dh
13f0  3ae0           cmp    ah,al
13f2  7236           jc     142a
13f4  8a7609         mov    dh,[bp+09]
13f7  e8f808         call   1cf2
13fa  e9f100         jmp    14ee
                                                 ; je verifikace dat
13fd  06           * push   es
13fe  53             push   bx
13ff  0e             push   cs
1400  07             pop    es
1401  bb8402       * mov    bx,0284              ; buffer pro na‡ten¡ dat
1404  9c             pushf
1405  2eff1eb400     call   far cs:[00b4]        ; vol n¡ p–vodn¡ obsluhy
140a  5b             pop    bx
140b  07             pop    es
140c  ca0200         ret    far  0002            ; n vrat z obsluhy INT 13

140f  06           * push   es
1410  53             push   bx
1411  56             push   si
1412  57             push   di
1413  1e             push   ds
1414  06             push   es
1415  0e             push   cs
1416  07             pop    es
1417  1f             pop    ds
1418  8bf3           mov    si,bx
141a  bf8402         mov    di,0284              ; c¡lov  adresa pro p©enos sektoru
141d  e8c608         call   1ce6                 ; p©enos sektoru
1420  1f             pop    ds
1421  5f             pop    di
1422  5e             pop    si
1423  ebdc           jmp    1401
1425  2eff2eb400   * jmp    far cs:[00b4]        ; skok do p–vodn¡ obsluhy INT 13

142a  8b5608       * mov    dx,[bp+08]
142d  57             push   di
142e  1e             push   ds
142f  50             push   ax
1430  2ec606c20101   mov    cs:[01c2],01         ; p©¡znak - nen¡ logick˜ disk
1436  8ac2           mov    al,dl
1438  e8bef9         call   0df9                 ; nalezen¡ disku v tabulce
143b  58             pop    ax
143c  2ec606c20100   mov    cs:[01c2],00         ; p©¡znak - je logick˜ disk
1442  f745230100     test   [di+23],0001
1447  7504           jnz    144d
1449  8ac4           mov    al,ah
144b  eb0f           jmp    145c
144d  51             push   cx
144e  33c9           xor    cx,cx
1450  8b4d13         mov    cx,[di+13]           ; po‡et sektor– na stopu
1453  b53f           mov    ch,3f
1455  2ae9           sub    ch,cl
1457  8ac5           mov    al,ch
1459  86e0           xchg   ah,al
145b  59             pop    cx
145c  1f             pop    ds
145d  5f             pop    di
145e  3ae0           cmp    ah,al
1460  7305           jnc    1467
1462  50             push   ax
1463  8ac4           mov    al,ah
1465  eb03           jmp    146a
1467  8ae0           mov    ah,al
1469  50             push   ax
146a  e88508         call   1cf2
146d  727f           jc     14ee
146f  58             pop    ax
1470  286602         sub    [bp+02],ah
1473  02cc           add    cl,ah
1475  02fc           add    bh,ah
1477  02fc           add    bh,ah
1479  3ae0           cmp    ah,al
147b  7407           jz     1484
147d  2ac4           sub    al,ah
147f  e8ac07         call   1c2e                 ; nastaven¡ stopy a sektoru disku
1482  ebda           jmp    145e

1484  53           * push   bx
1485  8a6603         mov    ah,[bp+03]
1488  80fc03         cmp    ah,03
148b  7525           jnz    14b2
148d  1e             push   ds
148e  06             push   es
148f  56             push   si
1490  57             push   di
1491  0e             push   cs
1492  06             push   es
1493  1f             pop    ds
1494  07             pop    es
1495  bf8402         mov    di,0284              ; c¡lov  adresa
1498  57             push   di
1499  8bf3           mov    si,bx                ; zdrojov  adresa sektoru
149b  e84808         call   1ce6                 ; p©enos sektoru
149e  5b             pop    bx
149f  5f             pop    di
14a0  5e             pop    si
14a1  b001           mov    al,01
14a3  8a5608         mov    dl,[bp+08]
14a6  e88507         call   1c2e                 ; nastaven¡ stopy a sektoru disku
14a9  e84608         call   1cf2
14ac  07             pop    es
14ad  1f             pop    ds
14ae  723e           jc     14ee
14b0  eb26           jmp    14d8
14b2  06             push   es
14b3  53             push   bx
14b4  0e             push   cs
14b5  07             pop    es
14b6  bb8402         mov    bx,0284
14b9  b001           mov    al,01
14bb  8a5608         mov    dl,[bp+08]
14be  e86d07         call   1c2e                 ; nastaven¡ stopy a sektoru disku
14c1  e82e08         call   1cf2
14c4  5b             pop    bx
14c5  07             pop    es
14c6  7226           jc     14ee
14c8  1e             push   ds
14c9  56             push   si
14ca  57             push   di
14cb  0e             push   cs
14cc  1f             pop    ds
14cd  8bfb           mov    di,bx                ; c¡lov  adresa sektoru
14cf  be8402         mov    si,0284              ; zdrojov  adresa sektoru
14d2  e81108         call   1ce6                 ; p©enos sektoru
14d5  5f             pop    di
14d6  5e             pop    si
14d7  1f             pop    ds
14d8  5b           * pop    bx
14d9  80c702         add    bh,02
14dc  41             inc    cx
14dd  8a4602         mov    al,[bp+02]
14e0  f8             clc
14e1  fec8           dec    al
14e3  7409           jz     14ee
14e5  8a5608         mov    dl,[bp+08]
14e8  e84307         call   1c2e                 ; nastaven¡ stopy a sektoru disku
14eb  e80408         call   1cf2
14ee  8be5         * mov    sp,bp
14f0  5d             pop    bp
14f1  5b             pop    bx
14f2  5b             pop    bx
14f3  59             pop    cx
14f4  5a             pop    dx
14f5  ca0200         ret    far  0002

                                                 ; FUNKCE IOCTL 2x
14f8                 db     7                    ; max. ‡¡slo funkce
14f9                 dw     165fh                ; FUNKCE IOCTL 20H
14fb                 dw     1905h                ; FUNKCE IOCTL 21H
14fd                 dw     18ach                ; FUNKCE IOCTL 22H
14ff                 dw     165bh                ; FUNKCE IOCTL 23H
1501                 dw     165bh                ; FUNKCE IOCTL 24H
1503                 dw     165bh                ; FUNKCE IOCTL 25H
1505                 dw     1b2eh                ; FUNKCE IOCTL 26H
1507                 dw     1c06h                ; FUNKCE IOCTL 27H

                                                 ; FUNKCE IOCTL 0x
1509                 db     7                    ; max. ‡¡slo funkce
150a                 dw     169bh                ; FUNKCE IOCTL 00H
150c                 dw     190eh                ; FUNKCE IOCTL 01H
150e                 dw     17f5h                ; FUNKCE IOCTL 02H
1510                 dw     165bh                ; FUNKCE IOCTL 03H
1512                 dw     165bh                ; FUNKCE IOCTL 04H
1514                 dw     165bh                ; FUNKCE IOCTL 05H
1516                 dw     1b69h                ; FUNKCE IOCTL 06H
1518                 dw     1c1ah                ; FUNKCE IOCTL 07H


1510   5B 16 5B 16 5B 16 69 1B 1A 1C 24 00 00 00 01 02   [.[.[.i...$.....
1520   00 00 02 02 00 00 03 02 00 00 04 02 00 00 05 02   ................
1530   00 00 06 02 00 00 07 02 00 00 08 02 00 00 09 02   ................
1540   00 00 0A 02 00 00 0B 02 00 00 0C 02 00 00 0D 02   ................
1550   00 00 0E 02 00 00 0F 02 00 00 10 02 00 00 11 02   ................
1560   00 00 12 02 00 00 13 02 00 00 14 02 00 00 15 02   ................
1570   00 00 16 02 00 00 17 02 00 00 18 02 00 00 19 02   ................
1580   00 00 1A 02 00 00 1B 02 00 00 1C 02 00 00 1D 02   ................
1590   00 00 1E 02 00 00 1F 02 00 00 20 02 00 00 21 02   .......... ...!.
15A0   00 00 22 02 00 00 23 02 00 00 24 02 00 00 00 00   .."...#...$.....
15B0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
15C0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
15D0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
15E0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
15F0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
1600   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
1610   00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 2E   ................
1620   C4 1E B8 00 E8 D2 F7 26 80 7F 0D 08 75 2A 26 8A   .......&...u*&.


1619                 db     0
                                                 ; FUNKCE 13H - generov n¡ po‘adavku IOCTL
                                                 ;  pro diskov‚ za©¡zen¡
161f  2ec41eb800     les    bx,cs:[00b8]         ; adresa z hlav¡ po‘adavku za©¡zen¡
1624  e8d2f7         call   0df9                 ; nalezen¡ disku v tabulce
1627  26807f0d08     cmp    es:[bx+0d],08        ; je ‡¡slo funkce = 8 ?
162c  752a           jnz    1658                 ; nen¡ = 8 - chyba (nezn m˜ povel)
162e  268a470e       mov    al,es:[bx+0e]        ; ‡¡slo podfunkce
1632  bef814         mov    si,14f8              ; tabulka adres podfunkc¡ IOCTL 2x
1635  a820           test   al,20                ; jsou podfunkce IOCTL 2x ?
1637  7503           jnz    163c                 ; jsou podfunkce IOCTL 2x
1639  be0915         mov    si,1509              ; tabulka adres podfunkc¡ IOCTL 0x
163c  249f         * and    al,9f                ; nulov n¡ bit– 5 a 6 ‡¡sla podfunkce
163e  2e3a04         cmp    al,cs:[si]           ; kontrola ‡¡sla podfunkce
1641  7715           ja     1658                 ; chyba - nezn m  funkce
1643  98             cbw                         ; AX <- AL
1644  d1e0           shl    ax,1                 ; AX * 2
1646  46             inc    si
1647  03f0           add    si,ax                ; adresa skoku do obsluhy funkce
1649  26c45f13       les    bx,es:[bx+13]        ; adresa bal¡ku dat IOCTL
164d  2eff14         call   cs:[si]              ; zavol n¡ obsluhy IOCTL
1650  7203           jc     1655                 ; chyba
1652  e9a2f0         jmp    06f7                 ; n vrat OK
1655  e992f0         jmp    06ea                 ; chyba
1658  e985f0         jmp    06e0                 ; chyba

                                                 ; neobsluhovan  funkce IOCTL
165b  5a             pop    dx
165c  5a             pop    dx
165d  ebf9           jmp    1658                 ; chybov˜ n vrat

                                                 ; FUNKCE IOCTL 20h - informace o za©¡zen¡
165f  8a4522         mov    al,[di+22]           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
1662  26884701       mov    es:[bx+01],al
1666  8b4523         mov    ax,[di+23]
1669  250300         and    ax,0003
166c  26894702       mov    es:[bx+02],ax
1670  8b4525         mov    ax,[di+25]           ; celkov˜ po‡et v lc– na disku
1673  26894704       mov    es:[bx+04],ax
1677  32c0           xor    al,al
1679  26884706       mov    es:[bx+06],al
167d  8d7527         lea    si,[di+27]
1680  26f60701       test   es:[bx],01
1684  740b           jz     1691
1686  e8baf7         call   0e43                 ; inicializace logick‚ho disku
1689  e83df5         call   0bc9                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
168c  720c           jc     169a                 ; chyba
168e  8d7506         lea    si,[di+06]
1691  8d7f07         lea    di,[bx+07]
1694  b91900         mov    cx,0019
1697  f3a4           rep    movsb
1699  f8             clc
169a  c3             ret

                                                 ; FUNKCE IOCTL 00h - informace o za©¡zen¡
169b  814d234001     or     [di+23],0140         ; p©¡znak - m‚dium bylo vymˆnˆno
16a0  26f60702       test   es:[bx],02
16a4  7403           jz     16a9
16a6  eb71           jmp    1719
16a8  90             nop

16a9  268a4701       mov    al,es:[bx+01]        ; ‡¡slo jednotky blokov‚ho za©¡zen¡
16ad  884522         mov    [di+22],al           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
16b0  268b4704       mov    ax,es:[bx+04]
16b4  894525         mov    [di+25],ax           ; celkov˜ po‡et v lc– na disku
16b7  268b4702       mov    ax,es:[bx+02]
16bb  2e803ec30100   cmp    cs:[01c3],00         ; 1=p©¡znak, ‘e je mo‘n  indikace v˜mˆny
16c1  7503           jnz    16c6
16c3  25fdff         and    ax,fffd
16c6  250300         and    ax,0003
16c9  8b4d23         mov    cx,[di+23]
16cc  81e1f4fd       and    cx,fdf4
16d0  0bc1           or     ax,cx
16d2  894523         mov    [di+23],ax
16d5  268a4706       mov    al,es:[bx+06]
16d9  2ea21816       mov    cs:[1618],al
16dd  814d238000     or     [di+23],0080         ; je za©¡zen¡
16e2  1e             push   ds
16e3  57             push   di
16e4  06             push   es
16e5  53             push   bx
16e6  26f60701       test   es:[bx],01
16ea  7513           jnz    16ff
16ec  f745230400     test   [di+23],0004
16f1  7404           jz     16f7

16f3  836523fb       and    word ptr [di+23],0fbh
16f7  b91f00         mov    cx,001f
16fa  8d7d27         lea    di,[di+27]
16fd  eb0a           jmp    1709

16ff  834d2304       or     word ptr [di+23],+04
1703  b91900         mov    cx,0019
1706  8d7d06         lea    di,[di+06]
1709  8d7707         lea    si,[bx+07]
170c  06             push   es
170d  1e             push   ds
170e  07             pop    es
170f  1f             pop    ds
1710  f3a4           rep    movsb
1712  e8ed03         call   1b02
1715  5b             pop    bx
1716  07             pop    es
1717  5f             pop    di
1718  1f             pop    ds
1719  268b4f26       mov    cx,es:[bx+26]
171d  2e890e1a15     mov    cs:[151a],cx

1722  836523f7       and    word ptr [di+23],0f7h
1726  26f60704       test   es:[bx],04
172a  7404           jz     1730
172c  834d2308       or     word ptr [di+23],+08
1730  83f93f         cmp    cx,003f
1733  771c           ja     1751
1735  e318           jcxz   174f
1737  bf1c15         mov    di,151c
173a  8d7728         lea    si,[bx+28]
173d  06             push   es
173e  1f             pop    ds
173f  0e             push   cs
1740  07             pop    es
1741  47             inc    di
1742  47             inc    di
1743  ad             lodsw
1744  50             push   ax
1745  ad             lodsw
1746  e87802         call   19c1
1749  5a             pop    dx
174a  8ac2           mov    al,dl
174c  ab             stosw
174d  e2f2           loop   1741
174f  f8             clc
1750  c3             ret
1751  b00c           mov    al,0c
1753  f9             stc
1754  c3             ret

1755  51             push   cx
1756  52             push   dx
1757  33c0           xor    ax,ax
1759  2e803e1a1601   cmp    cs:[161a],01
175f  7503           jnz    1764
1761  e8d902         call   1a3d
1764  2e803e191601   cmp    cs:[1619],01
176a  7503           jnz    176f
176c  e98300         jmp    17f2
176f  1e             push   ds
1770  56             push   si
1771  8ed8           mov    ds,ax
1773  c5367800       lds    si,[0078]
1777  2e89366202     mov    cs:[0262],si         ; ukazatel diskov˜ch parametr– INT 1EH
177c  2e8c1e6402     mov    cs:[0264],ds
1781  c644090f       mov    [si+09],0f
1785  5e             pop    si
1786  1f             pop    ds
1787  2ec606c60101   mov    cs:[01c6],01
178d  32c0           xor    al,al
178f  8b4d25         mov    cx,[di+25]           ; celkov˜ po‡et v lc– na disku
1792  49             dec    cx
1793  80e503         and    ch,03
1796  d0cd           ror    ch,1
1798  d0cd           ror    ch,1
179a  86e9           xchg   ch,cl
179c  0a4d13         or     cl,[di+13]           ; po‡et sektor– na stopu
179f  8a5504         mov    dl,[di+04]           ; ‡¡slo disku
17a2  b418           mov    ah,18                ; funkce nastaven¡ typu m‚dia
17a4  06             push   es
17a5  1e             push   ds
17a6  56             push   si
17a7  57             push   di
17a8  cd13           int    13                   ; nastaven¡ typu m‚dia pro form tov n¡
17aa  7228           jc     17d4
17ac  33c9           xor    cx,cx
17ae  8ed9           mov    ds,cx
17b0  c5367800       lds    si,[0078]
17b4  2e89361b16     mov    cs:[161b],si
17b9  2e8c1e1d16     mov    cs:[161d],ds
17be  893e7800       mov    [0078],di
17c2  8c067a00       mov    [007a],es
17c6  2ec606191601   mov    cs:[1619],01
17cc  32c0           xor    al,al
17ce  2ea21a16       mov    cs:[161a],al
17d2  eb1a           jmp    17ee
17d4  80fc0c         cmp    ah,0c
17d7  740f           jz     17e8
17d9  80fc80         cmp    ah,80
17dc  740e           jz     17ec
17de  b001           mov    al,01
17e0  2ec606c60100   mov    cs:[01c6],00
17e6  eb06           jmp    17ee
17e8  b002           mov    al,02
17ea  eb02           jmp    17ee
17ec  b003           mov    al,03
17ee  5f             pop    di
17ef  5e             pop    si
17f0  1f             pop    ds
17f1  07             pop    es
17f2  5a             pop    dx
17f3  59             pop    cx
17f4  c3             ret

                                                 ; FUNKCE IOCTL 02h - ‡ten¡ ze za©¡zen¡
17f5  26f60701       test   es:[bx],01
17f9  7408           jz     1803
17fb  e857ff         call   1755
17fe  268807         mov    es:[bx],al
1801  f8             clc
1802  c3             ret
1803  807d2205       cmp    [di+22],05           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
1807  7503           jnz    180c
1809  e99600         jmp    18a2
180c  1e             push   ds
180d  57             push   di
180e  06             push   es
180f  53             push   bx
1810  26f60702       test   es:[bx],02
1814  7405           jz     181b
1816  b401           mov    ah,01
1818  eb76           jmp    1890
181a  90             nop
181b  e837ff         call   1755
181e  3c01           cmp    al,01
1820  7407           jz     1829
1822  3c03           cmp    al,03
1824  7506           jnz    182c
1826  eb5b           jmp    1883
1828  90             nop
1829  e8a801         call   19d4
182c  e814f6         call   0e43                 ; inicializace logick‚ho disku
182f  268b4703       mov    ax,es:[bx+03]
1833  2ea36e02       mov    cs:[026e],ax
1837  268b4f01       mov    cx,es:[bx+01]
183b  2e880e6d02     mov    cs:[026d],cl
1840  8ae1           mov    ah,cl
1842  57             push   di
1843  bf1c15         mov    di,151c
1846  0e             push   cs
1847  07             pop    es
1848  2e8b0e1a15     mov    cx,cs:[151a]
184d  ab             stosw
184e  47             inc    di
184f  47             inc    di
1850  e2fb           loop   184d
1852  5f             pop    di
1853  b90500         mov    cx,0005
1856  51             push   cx
1857  bb1c15         mov    bx,151c
185a  0e             push   cs
185b  07             pop    es
185c  2ea11a15       mov    ax,cs:[151a]
1860  b405           mov    ah,05
1862  e8e501         call   1a4a
1865  59             pop    cx
1866  7330           jnc    1898
1868  e8d201         call   1a3d
186b  2ec6061a1601   mov    cs:[161a],01
1871  50             push   ax
1872  51             push   cx
1873  52             push   dx
1874  e8defe         call   1755
1877  3c01           cmp    al,01
1879  7503           jnz    187e
187b  e85601         call   19d4
187e  5a             pop    dx
187f  59             pop    cx
1880  58             pop    ax
1881  e2d3           loop   1856
1883  2ec6061a1601   mov    cs:[161a],01
1889  80fc06         cmp    ah,06
188c  7502           jnz    1890
188e  b480           mov    ah,80
1890  e836f9         call   11c9
1893  5b             pop    bx
1894  07             pop    es
1895  5f             pop    di
1896  1f             pop    ds
1897  c3             ret
1898  2ec6061a1600   mov    cs:[161a],00
189e  5b             pop    bx
189f  07             pop    es
18a0  5f             pop    di
18a1  1f             pop    ds
18a2  e80700         call   18ac
18a5  c3             ret
18a6  b401           mov    ah,01
18a8  e81ef9         call   11c9
18ab  c3             ret

                                                 ; FUNKCE IOCTL 22h - verifikace z diskov‚ho za©¡zen¡
18ac  2ec606560204   mov    cs:[0256],04         ; po‘adovan  operace = verifikace
18b2  268b4703       mov    ax,es:[bx+03]
18b6  2ea36802       mov    cs:[0268],ax         ; ‡¡slo stopy pro disk. operaci
18ba  268b4701       mov    ax,es:[bx+01]
18be  2ea26702       mov    cs:[0267],al         ; hlava pro disk. operaci
18c2  2e8b0e1a15     mov    cx,cs:[151a]
18c7  26f60702       test   es:[bx],02
18cb  7428           jz     18f5
18cd  268b4705       mov    ax,es:[bx+05]
18d1  3dff00         cmp    ax,00ff
18d4  77d0           ja     18a6
18d6  f6e1           mul    cl
18d8  3dff00         cmp    ax,00ff
18db  77c9           ja     18a6
18dd  8bc8           mov    cx,ax
18df  f745230100     test   [di+23],0001
18e4  740f           jz     18f5
18e6  2ef7068f0a8000 test   cs:[0a8f],0080
18ed  7406           jz     18f5
18ef  2ec606960a01   mov    cs:[0a96],01
18f5  33c0           xor    ax,ax
18f7  33db           xor    bx,bx
18f9  8ec3           mov    es,bx
18fb  e83900         call   1937
18fe  2ec606960a00   mov    cs:[0a96],00
1904  c3             ret

                                                 ; FUNKCE IOCTL 21h - ‡ten¡ z disku
1905  2ec606560202   mov    cs:[0256],02         ; po‘adovan  operace = ‡ten¡
190b  eb0a           jmp    1917
190d  90             nop

                                                 ; FUNKCE IOCTL 01h - nastaven¡ informac¡ o za©¡zen¡
190e  2ec606560203   mov    cs:[0256],03         ; po‘adovan  operace = z pis
1914  eb01           jmp    1917
1916  90             nop
1917  268b4703       mov    ax,es:[bx+03]
191b  2ea36802       mov    cs:[0268],ax         ; ‡¡slo stopy pro disk. operaci
191f  268b4701       mov    ax,es:[bx+01]
1923  2ea26702       mov    cs:[0267],al         ; hlava pro disk. operaci
1927  268b4705       mov    ax,es:[bx+05]
192b  268b4f07       mov    cx,es:[bx+07]
192f  26c45f09       les    bx,es:[bx+09]
1933  e80100         call   1937
1936  c3             ret
1937  2e89266a02     mov    cs:[026a],sp         ; £schova ukazatele z sobn¡ku
193c  e804f5         call   0e43                 ; inicializace logick‚ho disku
193f  2e803e191601   cmp    cs:[1619],01
1945  7407           jz     194e
1947  50             push   ax
1948  51             push   cx
1949  e84cf6         call   0f98                 ; nastaven¡ parametr– diskov‚ mechaniky
194c  59             pop    cx
194d  58             pop    ax
194e  be1c15         mov    si,151c
1951  d1e0           shl    ax,1
1953  d1e0           shl    ax,1
1955  03f0           add    si,ax
1957  ba0100         mov    dx,0001
195a  f745230800     test   [di+23],0008
195f  7402           jz     1963
1961  87d1           xchg   dx,cx
1963  51             push   cx
1964  52             push   dx
1965  46             inc    si
1966  46             inc    si
1967  2e             cs:
1968  ac             lodsb
1969  2ea26602       mov    cs:[0266],al         ; ‡¡slo sektoru pro disk. operaci
196d  f745230100     test   [di+23],0001
1972  7417           jz     198b
1974  2ef7068f0a8000 test   cs:[0a8f],0080
197b  740e           jz     198b
197d  2e89165802     mov    cs:[0258],dx         ; po‡et sektor– pro disk. operaci
1982  8bc2           mov    ax,dx
1984  e8d0f6         call   1057
1987  5a             pop    dx
1988  59             pop    cx
1989  f8             clc
198a  c3             ret
198b  2e             cs:
198c  ac             lodsb
198d  50             push   ax
198e  56             push   si
198f  1e             push   ds
1990  2ec5366202     lds    si,cs:[0262]         ; ukazatel diskov˜ch parametr– INT 1EH
1995  884403         mov    [si+03],al
1998  2ea06002       mov    al,cs:[0260]         ; max. po‡et sektor– na stopu
199c  884404         mov    [si+04],al
199f  1f             pop    ds
19a0  8ac2           mov    al,dl
19a2  2ea35802       mov    cs:[0258],ax         ; po‡et sektor– pro disk. operaci
19a6  e8aef6         call   1057
19a9  5e             pop    si
19aa  58             pop    ax
19ab  e81e00         call   19cc
19ae  03d8           add    bx,ax
19b0  5a             pop    dx
19b1  59             pop    cx
19b2  e2af           loop   1963
19b4  2e803e191601   cmp    cs:[1619],01
19ba  7403           jz     19bf
19bc  e821f6         call   0fe0
19bf  f8             clc
19c0  c3             ret
19c1  80fc02         cmp    ah,02
19c4  7703           ja     19c9
19c6  8ac4           mov    al,ah
19c8  c3             ret
19c9  b003           mov    al,03
19cb  c3             ret
19cc  8ac8           mov    cl,al
19ce  b88000         mov    ax,0080
19d1  d3e0           shl    ax,cl
19d3  c3             ret
19d4  2e803e1a1601   cmp    cs:[161a],01
19da  740c           jz     19e8
19dc  f745238000     test   [di+23],0080
19e1  744c           jz     1a2f
19e3  8165237fff     and    [di+23],ff7f
19e8  2ec6061a1600   mov    cs:[161a],00
19ee  2ec606700250   mov    cs:[0270],50
19f4  b004           mov    al,04                ; disketa 720K v mechanice 720K
19f6  807d2202       cmp    [di+22],02           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
19fa  741c           jz     1a18
19fc  807d2201       cmp    [di+22],01           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
1a00  7404           jz     1a06
1a02  b001           mov    al,01                ; disketa 360K v mechanice 360K
1a04  eb12           jmp    1a18
1a06  b002           mov    al,02                ; disketa 360K v mechanice 1.2M
1a08  2e803e181600   cmp    cs:[1618],00
1a0e  7508           jnz    1a18
1a10  b003           mov    al,03                ; disketa 1.2M v mechanice 1.2M
1a12  2ec606700254   mov    cs:[0270],54
1a18  1e             push   ds
1a19  56             push   si
1a1a  33f6           xor    si,si
1a1c  8ede           mov    ds,si
1a1e  c5367800       lds    si,[0078]
1a22  c644090f       mov    [si+09],0f
1a26  5e             pop    si
1a27  1f             pop    ds
1a28  b417           mov    ah,17                ; funkce nastaven¡ typu DASD
1a2a  8a5504         mov    dl,[di+04]           ; ‡¡slo disku
1a2d  cd13           int    13                   ; nastaven¡ typu DASD pro form tov n¡
1a2f  8a6513         mov    ah,[di+13]           ; po‡et sektor– na stopu
1a32  2e88266c02     mov    cs:[026c],ah
1a37  c3             ret

                                                 ; resetov n¡ disku
                                                 ; VSTUP: DL=‡¡slo disku
                                                 ;        BP=‡¡ta‡ pokus–
                                                 ; VSTUP: BP-1, ZF=konec pokus–
1a38  e80200         call   1a3d
1a3b  4d             dec    bp
1a3c  c3             ret

                                                 ; resetov n¡ disku
                                                 ; VSTUP: DL=‡¡slo disku
1a3d  50             push   ax
1a3e  32e4           xor    ah,ah                ; funkce resetov n¡ disku
1a40  cd13           int    13                   ; reset disku
1a42  2ec606c101ff   mov    cs:[01c1],ff
1a48  58             pop    ax
1a49  c3             ret

1a4a  1e             push   ds
1a4b  57             push   di
1a4c  06             push   es
1a4d  53             push   bx
1a4e  56             push   si
1a4f  2ef606c60101   test   cs:[01c6],01
1a55  753a           jnz    1a91
1a57  50             push   ax
1a58  8cda           mov    dx,ds
1a5a  33c0           xor    ax,ax
1a5c  8ed8           mov    ds,ax
1a5e  c5367800       lds    si,[0078]
1a62  2e89366202     mov    cs:[0262],si         ; ukazatel diskov˜ch parametr– INT 1EH
1a67  2e8c1e6402     mov    cs:[0264],ds
1a6c  2ea06c02       mov    al,cs:[026c]
1a70  884404         mov    [si+04],al
1a73  2ea07002       mov    al,cs:[0270]
1a77  884407         mov    [si+07],al
1a7a  c644090f       mov    [si+09],0f
1a7e  06             push   es
1a7f  8ec2           mov    es,dx
1a81  26807d2202     cmp    es:[di+22],02        ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
1a86  7505           jnz    1a8d
1a88  b004           mov    al,04
1a8a  86440a         xchg   al,[si+0a]
1a8d  07             pop    es
1a8e  8eda           mov    ds,dx
1a90  58             pop    ax
1a91  2e8b166e02   * mov    dx,cs:[026e]
1a96  8aea           mov    ch,dl
1a98  8a5504         mov    dl,[di+04]           ; fyzick˜ disk
1a9b  2e8a366d02     mov    dh,cs:[026d]
1aa0  cd13           int    13                   ; operace ‡ten¡/z pis
1aa2  5e             pop    si
1aa3  5b             pop    bx
1aa4  07             pop    es
1aa5  5f             pop    di
1aa6  1f             pop    ds
1aa7  c3             ret

                                                 ; povel 17h - poskytnut¡ logick‚ho diskov‚ho za©¡zen¡
1aa8  e84ef3         call   0df9                 ; nalezen¡ disku v tabulce
1aab  8a4504         mov    al,[di+04]           ; fyzick˜ disk
1aae  0e             push   cs
1aaf  1f             pop    ds
1ab0  2e8b3e4c02     mov    di,cs:[024c]         ; adresa prvn¡ho disku
1ab5  384504         cmp    [di+04],al           ; nalezen fyzick˜ disk ?
1ab8  7507           jnz    1ac1                 ; nenalezen - dal¨¡ disk
1aba  f745232000     test   [di+23],0020
1abf  7509           jnz    1aca
1ac1  8b5d02         mov    bx,[di+02]           ; segment tabulky pro dal¨¡ disk
1ac4  8b3d           mov    di,[di]              ; offset tabulky pro dal¨¡ disk
1ac6  8edb           mov    ds,bx                ; segment
1ac8  ebeb           jmp    1ab5                 ; dal¨¡ disk
1aca  eb1d           jmp    1ae9

                                                 ; povel 18h - nastaven¡ logick‚ho diskov‚ho za©¡zen¡
1acc  ae82af3        call   0df9                 ; nalezen¡ disku v tabulce
1acf  2ec606c70101   mov    cs:[01c7],01
1ad5  e86bf3         call   0e43                 ; inicializace logick‚ho disku
1ad8  2ec606c70100   mov    cs:[01c7],00
1ade  33db           xor    bx,bx
1ae0  8ec3           mov    es,bx
1ae2  b1ff           mov    cl,ff
1ae4  26880e0405     mov    es:[0504],cl
1ae9  32c9           xor    cl,cl
1aeb  f745231000     test   [di+23],0010
1af0  7405           jz     1af7
1af2  8a4d05         mov    cl,[di+05]           ; logick˜ disk
1af5  fec1           inc    cl
1af7  2ec51eb800     lds    bx,cs:[00b8]
1afc  884f01         mov    [bx+01],cl
1aff  e9f5eb         jmp    06f7                 ; n vrat z obsluhy funkce

1b02  50             push   ax
1b03  32c0           xor    al,al
1b05  2ea21a16       mov    cs:[161a],al
1b09  2e86061916     xchg   al,cs:[1619]
1b0e  0ac0           or     al,al
1b10  7419           jz     1b2b
1b12  56             push   si
1b13  1e             push   ds
1b14  06             push   es
1b15  2ec5361b16     lds    si,cs:[161b]
1b1a  33c0           xor    ax,ax
1b1c  8ec0           mov    es,ax
1b1e  2689367800     mov    es:[0078],si
1b23  268c1e7a00     mov    es:[007a],ds
1b28  07             pop    es
1b29  1f             pop    ds
1b2a  5e             pop    si
1b2b  58             pop    ax
1b2c  f8             clc
1b2d  c3             ret

                                                 ; FUNKCE IOCTL 26h - poskytnut¡ statusu vstupu
1b2e  e8b000         call   1be1
1b31  8a4505         mov    al,[di+05]           ; logick˜ disk
1b34  2ec606560202   mov    cs:[0256],02         ; po‘adovan  operace = ‡ten¡
1b3a  e88500         call   1bc2
1b3d  7229           jc     1b68
1b3f  2e8a0e9902     mov    cl,cs:[0299]
1b44  80e1f0         and    cl,f0
1b47  80f9f0         cmp    cl,f0
1b4a  7519           jnz    1b65
1b4c  2e803eaa0229   cmp    cs:[02aa],29
1b52  7511           jnz    1b65
1b54  0e             push   cs
1b55  1f             pop    ds
1b56  beab02         mov    si,02ab
1b59  8bfb           mov    di,bx
1b5b  83c702         add    di,0002
1b5e  b91700         mov    cx,0017
1b61  f3a4           rep    movsb
1b63  eb03           jmp    1b68
1b65  b007           mov    al,07
1b67  f9             stc
1b68  c3             ret


                                                 ; FUNKCE IOCTL 06h - poskytnut¡ statusu vstupu
1b69  e87500         call   1be1
1b6c  8a4505         mov    al,[di+05]           ; logick˜ disk
1b6f  8ad0           mov    dl,al                ; po‘adovan˜ disk
1b71  2ec606560202   mov    cs:[0256],02         ; po‘adovan  operace = ‡ten¡
1b77  52             push   dx
1b78  e84700         call   1bc2                 ; na‡ten¡ zav dˆc¡ho sektoru disku
1b7b  5a             pop    dx
1b7c  7243           jc     1bc1
1b7e  2e8a0e9902     mov    cl,cs:[0299]         ; [0284h+15h] popisova‡ m‚dia
1b83  80e1f0         and    cl,f0
1b86  80f9f0         cmp    cl,f0                ; je form t IBM ?
1b89  7533           jnz    1bbe                 ; nen¡ spr vn˜ disk
1b8b  2e803eaa0229   cmp    cs:[02aa],29         ; [0284h+26h] identifikace disku
1b91  752b           jnz    1bbe                 ; nen¡ spr vn˜ disk
1b93  1e             push   ds
1b94  57             push   di
1b95  06             push   es
1b96  1f             pop    ds
1b97  0e             push   cs
1b98  07             pop    es
1b99  bfab02         mov    di,02ab              ; [0284h+27h] s‚riov‚ ‡¡slo a popis disku
1b9c  8bf3           mov    si,bx
1b9e  83c602         add    si,0002
1ba1  b91700         mov    cx,0017              ; d‚lka dat [0284h+27h a‘ 3dh]
1ba4  f3a4           rep    movsb                ; p©enos popisky disku
1ba6  5f             pop    di
1ba7  1f             pop    ds
1ba8  e873f1         call   0d1e                 ; na‡ten¡ identifikace z disku
1bab  8ac2           mov    al,dl
1bad  2ec606560203   mov    cs:[0256],03         ; po‘adovan  operace = z pis
1bb3  e80c00         call   1bc2                 ; z pis sektoru zpˆt na disk
1bb6  2ec6065102ff   mov    cs:[0251],ff         ; aktu ln¡ logick˜ disk
1bbc  eb03           jmp    1bc1
1bbe  b007           mov    al,07
1bc0  f9             stc
1bc1  c3             ret

                                                 ; operace se sektorem
1bc2  1e             push   ds
1bc3  06             push   es
1bc4  57             push   di
1bc5  53             push   bx
1bc6  8ccf           mov    di,cs
1bc8  8edf           mov    ds,di
1bca  8ec7           mov    es,di
1bcc  bf8402         mov    di,0284              ; buffer pro zaveden¡ sektoru
1bcf  33d2           xor    dx,dx
1bd1  2e89168b0a     mov    cs:[0a8b],dx
1bd6  b90100         mov    cx,0001
1bd9  e8eef2         call   0eca                 ; diskov  operace
1bdc  5b             pop    bx
1bdd  5f             pop    di
1bde  07             pop    es
1bdf  1f             pop    ds
1be0  c3             ret

1be1  8a5504         mov    dl,[di+04]           ; fyzick˜ disk
1be4  0ad2           or     dl,dl                ; je pevn˜ disk ?
1be6  781d           js     1c05                 ; je pevn˜ disk
1be8  2e803ec30101   cmp    cs:[01c3],01         ; 1=p©¡znak, ‘e je mo‘n  indikace v˜mˆny
1bee  7515           jnz    1c05
1bf0  e80707         call   22fa                 ; test [DI+23],0002h
1bf3  7410           jz     1c05
1bf5  b416           mov    ah,16                ; funkce stavu indikace v˜mˆny diskety
1bf7  cd13           int    13                   ; stav indikace v˜mˆny diskety
1bf9  730a           jnc    1c05                 ; sign l v˜mˆny diskety je aktivn¡
1bfb  2ec70652024000 mov    cs:[0252],0040
1c02  e8bb06         call   22c0                 ; nastaven¡ p©¡znaku v tabulk ch disk–
1c05  c3             ret

                                                 ; FUNKCE IOCTL 27h
1c06  f745230002     test   [di+23],0200
1c0b  7407           jz     1c14
1c0d  26c6470100     mov    es:[bx+01],00
1c12  eb05           jmp    1c19
1c14  26c6470101     mov    es:[bx+01],01
1c19  c3             ret

                                                 ; FUNKCE IOCTL 07h - poskytnut¡ v˜stupn¡ho
                                                 ;  statusu diskov‚ho za©¡zen¡
1c1a  26807f0100     cmp    es:[bx+01],00
1c1f  7507           jnz    1c28
1c21  814d230002     or     [di+23],0200
1c26  eb05           jmp    1c2d
1c28  816523fffd     and    [di+23],fdff
1c2d  c3             ret

                                                 ; nastaven¡ stopy a sektoru disku
1c2e  50             push   ax
1c2f  53             push   bx
1c30  1e             push   ds
1c31  57             push   di
1c32  2ec606c20101   mov    cs:[01c2],01         ; p©¡znak - nen¡ logick˜ disk
1c38  8ac2           mov    al,dl                ; ‡¡slo disku
1c3a  e8bcf1         call   0df9                 ; nalezen¡ disku v tabulce
1c3d  2ec606c20100   mov    cs:[01c2],00         ; p©¡znak - je logick˜ disk
1c43  725e           jc     1ca3                 ; disk nenalezen - n vrat
1c45  f745230100     test   [di+23],0001
1c4a  7457           jz     1ca3                 ; n vrat
1c4c  8b5d13         mov    bx,[di+13]           ; po‡et sektor– na stopu
1c4f  8bc1           mov    ax,cx                ; po‡ te‡n¡ v lec a sektor
1c51  253f00         and    ax,003f              ; po‡ te‡n¡ sektor
1c54  3bc3           cmp    ax,bx                ; po‡et sektor– na stopu
1c56  764b           jna    1ca3                 ; nep©ekra‡uje stopu - n vrat
1c58  f6f3           div    bl                   ; v˜po‡et po‡tu stop a sektor–
1c5a  0ae4           or     ah,ah                ; po‡et sektor–
1c5c  7504           jnz    1c62                 ; jsou nˆjak‚ sektory
1c5e  8ae3           mov    ah,bl                ; po‡et sektor– na stopu
1c60  fec8           dec    al                   ; sn¡‘en¡ ‡¡sla stopy
1c62  80e1c0       * and    cl,c0                ; vy¨¨¡ 2 bity ‡¡sla stopy
1c65  0acc           or     cl,ah                ; nastaven¡ nov‚ho ‡¡sla sektoru
1c67  32e4           xor    ah,ah
1c69  40             inc    ax
1c6a  02c6           add    al,dh                ; ‡¡slo stopy
1c6c  80d400         adc    ah,00
1c6f  3b4515         cmp    ax,[di+15]           ; po‡et stop na m‚diu (sekci)
1c72  7635           jna    1ca9                 ; nen¡ vˆt¨¡ - OK
1c74  52             push   dx                   ; ‡¡slo stopy
1c75  33d2           xor    dx,dx
1c77  8b5d15         mov    bx,[di+15]           ; po‡et stop na m‚diu (sekci)
1c7a  f7f3           div    bx                   ;
1c7c  0bd2           or     dx,dx
1c7e  7507           jnz    1c87
1c80  8bd3           mov    dx,bx
1c82  0bc0           or     ax,ax
1c84  7401           jz     1c87
1c86  48             dec    ax
1c87  8afa         * mov    bh,dl
1c89  5a             pop    dx
1c8a  fecf           dec    bh
1c8c  8af7           mov    dh,bh
1c8e  8af9           mov    bh,cl                ; ‡¡slo sektoru
1c90  80e73f         and    bh,3f                ; ‡¡slo sektoru
1c93  b306           mov    bl,06                ; po‡et rotac¡
1c95  86cb           xchg   cl,bl
1c97  d2eb           shr    bl,cl
1c99  02e8           add    ch,al
1c9b  12dc           adc    bl,ah
1c9d  d2e3           shl    bl,cl
1c9f  86d9           xchg   bl,cl
1ca1  0acf           or     cl,bh
1ca3  f8           * clc
1ca4  5f             pop    di
1ca5  1f             pop    ds
1ca6  5b             pop    bx
1ca7  58             pop    ax
1ca8  c3             ret

1ca9  8af0         * mov    dh,al
1cab  fece           dec    dh
1cad  ebf4           jmp    1ca3

                                                 ; z mˆna adres INT 13h
1caf  80fc13         cmp    ah,13
1cb2  7405           jz     1cb9
1cb4  2eff264802     jmp    cs:[0248]
1cb9  2eff36b400     push   cs:[00b4]            ; £schova vlastn¡ adresy INT 13h
1cbe  2eff36b600     push   cs:[00b6]
1cc3  2eff36b000     push   cs:[00b0]            ; £schova p–vodn¡ adresy INT 13h
1cc8  2eff36b200     push   cs:[00b2]
1ccd  2e8916b400     mov    cs:[00b4],dx         ; vlastn¡ adresa INT 13h
1cd2  2e8c1eb600     mov    cs:[00b6],ds
1cd7  2e891eb000     mov    cs:[00b0],bx         ; p–vodn¡ adresa INT 13h
1cdc  2e8c06b200     mov    cs:[00b2],es
1ce1  07             pop    es                   ; p–vodn¡ adresa INT 13h
1ce2  5b             pop    bx
1ce3  1f             pop    ds                   ; vlastn¡ adresa INT 13h
1ce4  5a             pop    dx
1ce5  cf             iret

; -----------------------------------------------------------------------------
                                                 ; p©enos sektoru
                                                 ; VSTUP: DS:SI - zdroj. adresa
                                                 ;        ES:DI - c¡lov  adresa
1ce6  fc             cld                         ; smˆr p©enosu nahoru
1ce7  51             push   cx
1ce8  b90001         mov    cx,0100              ; d‚lka sektoru (slov)
1ceb  d1e9           shr    cx,1                 ; CX/2 (korekce na po‡et dvojslov)
1ced  66f3a5         rep    movsd                ; p©enos dvojslov pro procesor 386
; 1ced  66             db     66                   ; (nastaveno na NOP z adr. 32fd)
; 1cee  f3a5           rep    movsw                ; p©enos slov u procesoru 86 a 286
1cf0  59             pop    cx
1cf1  c3             ret

; -----------------------------------------------------------------------------

                                                 ; diskov  operace
1cf2  8a5608         mov    dl,[bp+08]           ; disk pro INT 13h
1cf5  32e4           xor    ah,ah
1cf7  0ac0           or     al,al
1cf9  740f           jz     1d0a
1cfb  8a6603         mov    ah,[bp+03]           ; funkce pro INT 13h
1cfe  ff760e         push   [bp+0e]              ; p–vodn¡ hodnota registru p©¡znak–
1d01  2eff1eb400     call   far cs:[00b4]        ; vol n¡ obsluhy INT 13h
1d06  9c             pushf                       ; nov  hodnota registru p©¡znak–
1d07  8f460e         pop    [bp+0e]              ; ulo‘en¡ registru p©¡znak–
1d0a  c3             ret


1d0b                 db     0
1d0c                 db     0ffh                 ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
                                                 ; (0ffh = p–vodn¡ PC)
1d0d                 db     0                    ; ‡¡slo submodelu po‡¡ta‡e
1d0e                 dd     0                    ; p–vodn¡ adresa INT 19h
1d12                 db     0
1d13                 db     38h dup (0ffh)
1d4b                 db     90h


                                                 ; tabulka adres BPB disk–
1d4c                 dw     048ah                ; disketa 1
1d4e                 dw     04eeh                ; disketa 2
1d50                 dw     0552h                ; disketa 3
1d52                 dw     05b6h                ; disketa 4
1d54                 dw     2072h                ; pevn˜ disk 1
1d56                 dw     20d6h                ; pevn˜ disk 2

1d58                 db     30h dup(0)

; -----------------------------------------------------------------------------
;                 Obsluha p©eru¨en¡ INT 19h - zaveden¡ syst‚mu
; -----------------------------------------------------------------------------

                                                 ; vlastn¡ obsluha INT 19H
                                                 ; (zavadˆ‡ opera‡n¡ho syst‚mu)
1d88  33c0           xor    ax,ax
1d8a  8ed8           mov    ds,ax
1d8c  2ec43eb000     les    di,cs:[00b0]
1d91  893e4c00       mov    [004c],di
1d95  8c064e00       mov    [004e],es
1d99  2e803e121d00   cmp    cs:[1d12],00
1d9f  7513           jnz    1db4
1da1  e97201         jmp    1f16
1da4  b800f0         mov    ax,f000
1da7  8ed8           mov    ds,ax
1da9  b0fd           mov    al,fd
1dab  3a06feff       cmp    al,[fffe]
1daf  7503           jnz    1db4
1db1  e96201         jmp    1f16
1db4  33c0           xor    ax,ax
1db6  8ed8           mov    ds,ax
1db8  2ec43e131d     les    di,cs:[1d13]
1dbd  8cc0           mov    ax,es
1dbf  3dffff         cmp    ax,ffff
1dc2  740d           jz     1dd1
1dc4  83ffff         cmp    di,ffff
1dc7  7408           jz     1dd1
1dc9  893e0800       mov    [0008],di
1dcd  8c060a00       mov    [000a],es
1dd1  2ec43e171d     les    di,cs:[1d17]
1dd6  8cc0           mov    ax,es
1dd8  3dffff         cmp    ax,ffff
1ddb  740d           jz     1dea
1ddd  83ffff         cmp    di,ffff
1de0  7408           jz     1dea
1de2  893e2000       mov    [0020],di
1de6  8c062200       mov    [0022],es
1dea  2ec43e1b1d     les    di,cs:[1d1b]
1def  8cc0           mov    ax,es
1df1  3dffff         cmp    ax,ffff
1df4  740d           jz     1e03
1df6  83ffff         cmp    di,ffff
1df9  7408           jz     1e03
1dfb  893e2400       mov    [0024],di
1dff  8c062600       mov    [0026],es
1e03  2ec43e1f1d     les    di,cs:[1d1f]
1e08  8cc0           mov    ax,es
1e0a  3dffff         cmp    ax,ffff
1e0d  740d           jz     1e1c
1e0f  83ffff         cmp    di,ffff
1e12  7408           jz     1e1c
1e14  893e2800       mov    [0028],di
1e18  8c062a00       mov    [002a],es
1e1c  2ec43e231d     les    di,cs:[1d23]
1e21  8cc0           mov    ax,es
1e23  3dffff         cmp    ax,ffff
1e26  740d           jz     1e35
1e28  83ffff         cmp    di,ffff
1e2b  7408           jz     1e35
1e2d  893e2c00       mov    [002c],di
1e31  8c062e00       mov    [002e],es
1e35  2ec43e271d     les    di,cs:[1d27]
1e3a  8cc0           mov    ax,es
1e3c  3dffff         cmp    ax,ffff
1e3f  740d           jz     1e4e
1e41  83ffff         cmp    di,ffff
1e44  7408           jz     1e4e
1e46  893e3000       mov    [0030],di
1e4a  8c063200       mov    [0032],es
1e4e  2ec43e2b1d     les    di,cs:[1d2b]
1e53  8cc0           mov    ax,es
1e55  3dffff         cmp    ax,ffff
1e58  740d           jz     1e67
1e5a  83ffff         cmp    di,ffff
1e5d  7408           jz     1e67
1e5f  893e3400       mov    [0034],di
1e63  8c063600       mov    [0036],es
1e67  2ec43e2f1d     les    di,cs:[1d2f]
1e6c  8cc0           mov    ax,es
1e6e  3dffff         cmp    ax,ffff
1e71  740d           jz     1e80
1e73  83ffff         cmp    di,ffff
1e76  7408           jz     1e80
1e78  893e3800       mov    [0038],di
1e7c  8c063a00       mov    [003a],es
1e80  2ec43e331d     les    di,cs:[1d33]
1e85  8cc0           mov    ax,es
1e87  3dffff         cmp    ax,ffff
1e8a  740d           jz     1e99
1e8c  83ffff         cmp    di,ffff
1e8f  7408           jz     1e99
1e91  893ec001       mov    [01c0],di            ; celkov˜ po‡et disk–
1e95  8c06c201       mov    [01c2],es
1e99  2ec43e371d     les    di,cs:[1d37]
1e9e  8cc0           mov    ax,es
1ea0  3dffff         cmp    ax,ffff
1ea3  740d           jz     1eb2
1ea5  83ffff         cmp    di,ffff
1ea8  7408           jz     1eb2
1eaa  893ec801       mov    [01c8],di
1eae  8c06ca01       mov    [01ca],es
1eb2  2ec43e3b1d     les    di,cs:[1d3b]
1eb7  8cc0           mov    ax,es
1eb9  3dffff         cmp    ax,ffff
1ebc  740d           jz     1ecb
1ebe  83ffff         cmp    di,ffff
1ec1  7408           jz     1ecb
1ec3  893ecc01       mov    [01cc],di
1ec7  8c06ce01       mov    [01ce],es
1ecb  2ec43e3f1d     les    di,cs:[1d3f]
1ed0  8cc0           mov    ax,es
1ed2  3dffff         cmp    ax,ffff
1ed5  740d           jz     1ee4
1ed7  83ffff         cmp    di,ffff
1eda  7408           jz     1ee4
1edc  893ed001       mov    [01d0],di
1ee0  8c06d201       mov    [01d2],es
1ee4  2ec43e431d     les    di,cs:[1d43]
1ee9  8cc0           mov    ax,es
1eeb  3dffff         cmp    ax,ffff
1eee  740d           jz     1efd
1ef0  83ffff         cmp    di,ffff
1ef3  7408           jz     1efd
1ef5  893ed801       mov    [01d8],di
1ef9  8c06da01       mov    [01da],es
1efd  2ec43e471d     les    di,cs:[1d47]
1f02  8cc0           mov    ax,es
1f04  3dffff         cmp    ax,ffff
1f07  740d           jz     1f16
1f09  83ffff         cmp    di,ffff
1f0c  7408           jz     1f16
1f0e  893edc01       mov    [01dc],di
1f12  8c06de01       mov    [01de],es
1f16  2ec43e0e1d     les    di,cs:[1d0e]
1f1b  893e6400       mov    [0064],di
1f1f  8c066600       mov    [0066],es
1f23  cd19           int    19                   ; nov‚ zaveden¡ opera‡n¡ho syst‚mu

                                                 ; FUNKCE 00h - inicializace diskov‚ho za©¡zen¡
1f25  0e             push   cs
1f26  1f             pop    ds
1f27  8a26c001       mov    ah,[01c0]            ; celkov˜ po‡et disk–
1f2b  bf4c1d         mov    di,1d4c              ; tabulka adres BPB disk–
1f2e  e945ec         jmp    0b76

1f31  80fc08         cmp    ah,08
1f34  7405           jz     1f3b
1f36  2eff2e801d     jmp    far cs:[1d80]
1f3b  3cf8           cmp    al,f8
1f3d  7201           jc     1f40
1f3f  cf             iret

1f40  0ac0           or     al,al
1f42  7503           jnz    1f47
1f44  b0ff           mov    al,ff
1f46  cf             iret
1f47  3c01           cmp    al,01
1f49  7504           jnz    1f4f
1f4b  e81900         call   1f67                 ; nastaven¡ posledn¡ho disku
1f4e  cf             iret

                                                 ; nastaven¡ posledn¡ho disku
1f4f  3c03           cmp    al,03
1f51  740d           jz     1f60
1f53  2e891eb800     mov    cs:[00b8],bx
1f58  2e8c06ba00     mov    cs:[00ba],es
1f5d  e924e7         jmp    0684
1f60  0e             push   cs
1f61  1f             pop    ds
1f62  8b3e4c02       mov    di,[024c]
1f66  cf             iret


1f67  2ec4364c02     les    si,cs:[024c]         ; adresa tabulky disku
1f6c  06             push   es
1f6d  56             push   si
1f6e  83feff         cmp    si,ffff              ; je ji‘ posledn¡ disk ?
1f71  7437           jz     1faa                 ; je posledn¡ disk
1f73  8a4504         mov    al,[di+04]           ; hledan˜ fyzick˜ disk
1f76  26384404       cmp    es:[si+04],al        ; je to stejn˜ disk ?
1f7a  751f           jnz    1f9b                 ; nen¡
1f7c  33db           xor    bx,bx
1f7e  b310           mov    bl,10
1f80  095d23         or     [di+23],bx
1f83  26095c23       or     es:[si+23],bx
1f87  b320           mov    bl,20
1f89  83f3ff         xor    bx,-01
1f8c  215d23         and    [di+23],bx
1f8f  268b5c23       mov    bx,es:[si+23]
1f93  80e302         and    bl,02
1f96  32ff           xor    bh,bh
1f98  095d23         or     [di+23],bx
1f9b  5b           * pop    bx
1f9c  5b             pop    bx
1f9d  06             push   es
1f9e  56             push   si
1f9f  268b5c02       mov    bx,es:[si+02]
1fa3  268b34         mov    si,es:[si]
1fa6  8ec3           mov    es,bx
1fa8  ebc4           jmp    1f6e
1faa  5e           * pop    si
1fab  07             pop    es
1fac  8cd8           mov    ax,ds
1fae  26894402       mov    es:[si+02],ax
1fb2  26893c         mov    es:[si],di
1fb5  c705ffff       mov    [di],ffff            ; ozna‡en¡ - je to posledn¡ disk
1fb9  c3             ret

1fba  50             push   ax
1fbb  1e             push   ds
1fbc  57             push   di
1fbd  33ff           xor    di,di
1fbf  8edf           mov    ds,di
1fc1  bfbc00         mov    di,00bc
1fc4  8b05           mov    ax,[di]
1fc6  2ea3801d       mov    cs:[1d80],ax
1fca  8b4502         mov    ax,[di+02]
1fcd  2ea3821d       mov    cs:[1d82],ax
1fd1  fa             cli
1fd2  c705af1c       mov    [di],1caf
1fd6  8c4d02         mov    [di+02],cs
1fd9  fb             sti
1fda  5f             pop    di
1fdb  1f             pop    ds
1fdc  58             pop    ax
1fdd  cb             ret    far

                                                 ; hl ¨en¡ o v˜mˆnˆ log. disku
                                                 ; VSTUP: [DI+5]=‡¡slo disku
1fde  8a4505         mov    al,[di+05]           ; logick˜ disk
1fe1  0441           add    al,41                ; p©evod na znak ASCII
1fe3  2ea22320       mov    cs:[2023],al         ; nastaven¡ ozna‡en¡ disku
1fe7  1e             push   ds
1fe8  0e             push   cs
1fe9  1f             pop    ds                   ; DS <- CS
1fea  be0720         mov    si,2007              ; text "Insert diskette ..."
1fed  53             push   bx
1fee  e80a00         call   1ffb                 ; tisk textu "Insert..."
1ff1  e8e2e7         call   07d6                 ; vy‡i¨tˆn¡ vstupn¡ho bufferu CON
1ff4  32e4           xor    ah,ah                ; funkce ‡ten¡ znaku z kl vesnice
1ff6  cd16           int    16                   ; ‡ek n¡ na stisk kl vesy
1ff8  5b             pop    bx
1ff9  1f             pop    ds
1ffa  c3           * ret

                                                 ; tisk textu na displej
                                                 ; VSTUP: DS:SI text k tisku
1ffb  ac             lodsb                       ; na‡ten¡ znaku k tisku do AL
1ffc  0ac0           or     al,al                ; je ji‘ koncov˜ bajt 0 ?
1ffe  74fa           jz     1ffa                 ; je konec textu
2000  9c             pushf                       ; (simulace vol n¡ INT)
2001  0e             push   cs
2002  e806e7         call   070b                 ; tisk znaku na displej (INT 29H)
2005  ebf4           jmp    1ffb                 ; dal¨¡ znak k tisku

2007                 db     13,10,'Insert diskette for drive '
2023                 db     'A: and press any key when ready'
                     db     13,10,10,0

2046                 db     0
2047                 db     0
2048                 db     0
2049                 db     0

                                                 ; datum nebo ‡as hodin re ln‚ho ‡asu
204a                 db     0                    ; stolet¡,hodina (BCD nebo bin rn¡)
204b                 db     0                    ; rok,minuta (BCD nebo bin rn¡)
204c                 db     0                    ; mˆs¡c,sekunda (BCD nebo bin rn¡)
204d                 db     0                    ; den,setina sekundy (BCD nebo bin rn¡)

                                                 ; tabulka mˆs¡c– (po‡ty dn–
                                                 ; od za‡ tku roku)
204e                 dw     0                    ; LEDEN      (0)
2050                 dw     31                   ; —NOR       (0+31)
2052                 dw     59                   ; BžEZEN     (31+28)
2054                 dw     90                   ; DUBEN      (59+31)
2056                 dw     120                  ; KV‰TEN     (90+30)
2058                 dw     151                  ; €ERVEN     (120+31)
205a                 dw     181                  ; €ERVENEC   (151+30)
205c                 dw     212                  ; SRPEN      (181+31)
205e                 dw     243                  ; Zž‹       (212+31)
2060                 dw     273                  ; ž‹JEN      (243+30)
2062                 dw     304                  ; LISTOPAD   (273+31)
2064                 dw     334                  ; PROSINEC   (304+30)

2066                 dw     0                    ; po‡et dn– od 1.1.1980
                                                 ; 1=hodiny nepracuj¡
                                                 ; 2=chyba tvaru dar BCD
                                                 ; 3=chyba £daje ‡asu/data

2068                 db     0
2069                 db     0                    ; po‡et pevn˜ch disk–
206a                 db     80h
206b                 db     90h

                                                 ; parametry pevn‚ho disku 1
206c                 dw     0ffffh               ; [DI+00h] n sleduj¡c¡ diskov  jednotka
206e                 dw     0070h                ; [DI+02h] (segment)
2070                 db     50h  ;"P"            ; [DI+04h] fyzick˜ disk
2071                 db     43h  ;"C"            ; [DI+05h] logick˜ disk
                                                 ; blok parametr– BPB - pevn˜ disk 1
2072                 dw     0200h                ; [DI+06h] po‡et bajt– na sektor
2074                 db     1                    ; [DI+08h] po‡et sektor– na aloka‡n¡ blok
2075                 dw     1                    ; [DI+09h] po‡et zav dˆc¡ch a rezervovan˜ch sektor–
2077                 db     2                    ; [DI+0Bh] po‡et aloka‡n¡ch tabulek FAT
2078                 dw     0010h                ; [DI+0Ch] max.po‡et polo‘ek z kl.adres ©e
207a                 dw     0                    ; [DI+0Eh] po‡et sektor– na m‚diu
207c                 db     0f8h                 ; [DI+10h] popisova‡ m‚dia
207d                 dw     0001h                ; [DI+11h] po‡et sektor– v jedn‚ tabulce FAT
207f                 dw     0                    ; [DI+13h] po‡et sektor– na stopu
2081                 dw     0                    ; [DI+15h] po‡et stran m‚dia
2083                 dw     0                    ; [DI+17h] ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
2085                 dw     0                    ; [DI+19h] ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
2087                 dw     0                    ; [DI+1bh] celkov˜ po‡et sektor– odd¡lu - LOW
2089                 dw     0                    ; [DI+1dh] celkov˜ po‡et sektor– odd¡lu - HIGH
208b                 db     0                    ; [DI+1fh] typ FAT (40h=FAT16)
208c                 dw     0                    ; [DI+20h] ‡¡ta‡ otev©en¡ za©¡zen¡
208e                 db     3                    ; [DI+22h] typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
208f                 dw     0020h                ; [DI+23h]
                                                 ;          0040h=m‚dium bylo vymˆnˆno
2091                 dw     0028h                ; [DI+25h] po‡et stop na disku

2090   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............

20a0                 dw     0                    ; [DI+34] po‡et sektor– na stopu
20a2                 dw     0                    ; [DI+36] po‡et hlav disku

20A0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................

20b0                 dw     0
20b2                 db     0ffh
20b3                 dd     0ffffffffh           ; [DI+47h] ‡as posledn¡ diskov‚ operace
20b7                 db     'NO NAME    ',0      ; [DI+4bh] identifikace disku
20c3                 dw     0                    ; [DI+57h] s‚riov‚ ‡¡slo - datum
20c5                 dw     0                    ; [DI+59] s‚riov‚ ‡¡slo - ‡as
20c7                 db     'FAT12   ',0         ; [DI+5bh] identifikace FAT


                                                 ; parametry pevn‚ho disku 2
20d0                 dw     0ffffh               ; [DI+00h] n sleduj¡c¡ diskov  jednotka
20d2                 dw     0070h                ; [DI+02h] (segment)
20d4                 db     51h  ;"Q"            ; [DI+04h] fyzick˜ disk
20d5                 db     44h  ;"D"            ; [DI+05h] logick˜ disk
                                                 ; blok parametr– BPB - pevn˜ disk 1
20d6                 dw     0200h                ; [DI+06h] po‡et bajt– na sektor
20d8                 db     1                    ; [DI+08h] po‡et sektor– na aloka‡n¡ blok
20d9                 dw     1                    ; [DI+09h] po‡et zav dˆc¡ch a rezervovan˜ch sektor–
20db                 db     2                    ; [DI+0Bh] po‡et aloka‡n¡ch tabulek FAT
20dc                 dw     0                    ; [DI+0Ch] max.po‡et polo‘ek z kl.adres ©e
20de                 dw     0                    ; [DI+0Eh] po‡et sektor– na m‚diu
20e0                 db     0f8h                 ; [DI+10h] popisova‡ m‚dia
20e1                 dw     0                    ; [DI+11h] po‡et sektor– v jedn‚ tabulce FAT
20e3                 dw     0                    ; [DI+13h] po‡et sektor– na stopu
20e5                 dw     0                    ; [DI+15h] po‡et stran m‚dia
20e7                 dw     0                    ; [DI+17h] ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
20e9                 dw     0                    ; [DI+19h] ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
20eb                 dw     0                    ; [DI+1bh] celkov˜ po‡et sektor– odd¡lu - LOW
20ed                 dw     0                    ; [DI+1dh] celkov˜ po‡et sektor– odd¡lu - HIGH
20ef                 db     0                    ; [DI+1fh] typ FAT (40h=FAT16)
20f0                 dw     0                    ; [DI+20h] ‡¡ta‡ otev©en¡ za©¡zen¡
20f2                 db     3                    ; [DI+22h] typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
20f3                 dw     0020h                ; [DI+23h]
                                                 ;          0040h=m‚dium bylo vymˆnˆno
20f5                 dw     0028h                ; [DI+25h] po‡et stop na disku

20F0   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........

2104                 dw     0                    ; [DI+34] po‡et sektor– na stopu
2106                 dw     0                    ; [DI+36] po‡et hlav disku

2100   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2110   00 00 00 00 00 00 FF FF FF FF FF 4E 4F 20 4E 41   ...........NO NA

2114                 dw     0
2116                 db     0ffh
2117                 dd     0ffffffffh           ; [DI+47h] ‡as posledn¡ diskov‚ operace
211b                 db     'NO NAME    ',0      ; [DI+4bh] identifikace disku
2127                 dw     0                    ; [DI+57h] s‚riov‚ ‡¡slo - datum
2129                 dw     0                    ; [DI+59] s‚riov‚ ‡¡slo - ‡as
212b                 db     'FAT12   ',0         ; [DI+5bh] identifikace FAT


                                                 ; FUNKCE 0DH - otev©en¡ diskov‚ho za©¡zen¡
2134  e8c2ec         call   0df9                 ; nalezen¡ disku v tabulce
2137  ff4520         inc    w/[di+20]            ; zv˜¨en¡ ‡¡ta‡e otev©en¡ za©¡zen¡
213a  e9bae5         jmp    06f7                 ; n vrat OK

                                                 ; FUNKCE 0EH - uzav©en¡ diskov‚ho za©¡zen¡
213d  e8b9ec         call   0df9                 ; nalezen¡ disku v tabulce
2140  837d2000       cmp    [di+20],0000         ; je za©¡zen¡ ji‘ uzav©eno ?
2144  7403           jz     2149                 ; je uzav©eno - n vrat OK
2146  ff4d20         dec    w/[di+20]            ; sn¡‘en¡ ‡¡ta‡e otev©en¡
2149  e9abe5         jmp    06f7                 ; n vrat OK

                                                 ; test uzav©en¡ diskov‚ho za©¡zen¡
214c  837d2000     * cmp    [di+20],0000         ; je teƒ ji‘ uzav©eno ?
2150  c3             ret

2151  e8efec         call   0e43                 ; inicializace logick‚ho disku
2154  33f6           xor    si,si
2156  e8a101         call   22fa
2159  742e           jz     2189
215b  e89101         call   22ef                 ; test, zda bylo m‚dium vymˆnˆno
215e  752a           jnz    218a
2160  50             push   ax
2161  52             push   dx
2162  8a5504         mov    dl,[di+04]           ; ‡¡slo fyzick‚ho disku
2165  b416           mov    ah,16                ; funkce indikace v˜mˆny diskety
2167  cd13           int    13                   ; stav indikace v˜mˆny diskety
2169  5a             pop    dx
216a  58             pop    ax
216b  721d           jc     218a                 ; chyba nebo disketa vymˆnˆna
216d  be0100         mov    si,0001
2170  2e8a1e5102     mov    bl,cs:[0251]         ; aktu ln¡ logick˜ disk
2175  385d04         cmp    [di+04],bl           ; fyzick˜ disk
2178  740f           jz     2189
217a  50             push   ax
217b  51             push   cx
217c  52             push   dx
217d  e88be9         call   0b0b
2180  5a             pop    dx
2181  59             pop    cx
2182  58             pop    ax
2183  0bf6           or     si,si
2185  7403           jz     218a
2187  33f6           xor    si,si
2189  c3             ret

218a  e83cea         call   0bc9                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
218d  72fa           jc     2189
218f  e82f00         call   21c1
2192  73f5           jnc    2189
2194  e832f0         call   11c9
2197  c3             ret

2198  e8b1ff         call   214c                 ; test uzav©en¡ diskov‚ho za©¡zen¡
219b  7501           jnz    219e                 ; diskov‚ za©¡zen¡ nen¡ uzav©eno - uzav©en¡
219d  c3           * ret                         ; uzav©eno
219e  e84e01       * call   22ef                 ; test, zda bylo m‚dium vymˆnˆno
21a1  74fa           jz     219d                 ; nebylo vymˆnˆno
21a3  e823ea         call   0bc9                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
21a6  720f           jc     21b7                 ; chyba
21a8  e81600         call   21c1
21ab  7207           jc     21b4
21ad  0bf6           or     si,si
21af  79ec           jns    219d
21b1  e87f00         call   2233
21b4  e812f0         call   11c9
21b7  f9           * stc
21b8  5e             pop    si
21b9  c3             ret

21ba  e83b02         call   23f8                 ; test, zda souhlas¡ popisova‡ m‚dia
21bd  0bf6           or     si,si
21bf  7828           js     21e9
21c1  2e803eaa0229   cmp    cs:[02aa],29         ; je s‚riov‚ ‡¡slo disku ?
21c7  7427           jz     21f0
21c9  e82e01         call   22fa
21cc  74cf           jz     219d                 ; konec (instrukce RET)
21ce  33f6           xor    si,si
21d0  2e803e940200   cmp    cs:[0294],00         ; po‡et aloka‡n¡ch tabulek FAT
21d6  7410           jz     21e8                 ; nen¡ zad na ‘ dn  aloka‡n¡ tabulka
21d8  e85a01         call   2335
21db  720b           jc     21e8
21dd  e80102         call   23e1
21e0  0bf6           or     si,si
21e2  7505           jnz    21e9
21e4  e80e01         call   22f5
21e7  f8             clc
21e8  c3           * ret

21e9  2ec6065102ff * mov    cs:[0251],ff         ; aktu ln¡ logick˜ disk
21ef  c3             ret

21f0  50           * push   ax
21f1  2ea1ab02       mov    ax,cs:[02ab]
21f5  3b4557         cmp    ax,[di+57]
21f8  750e           jnz    2208
21fa  2ea1ad02       mov    ax,cs:[02ad]
21fe  3b4559         cmp    ax,[di+59]
2201  7505           jnz    2208
2203  33f6           xor    si,si
2205  58             pop    ax
2206  ebdc           jmp    21e4
2208  58             pop    ax
2209  beffff         mov    si,ffff
220c  f8             clc
220d  ebda           jmp    21e9
220f  80fc06         cmp    ah,06
2212  75d4           jnz    21e8
2214  e835ff         call   214c                 ; test uzav©en¡ diskov‚ho za©¡zen¡
2217  74cf           jz     21e8
2219  e8ade9         call   0bc9                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
221c  7212           jc     2230
221e  e899ff         call   21ba
2221  7209           jc     222c
2223  0bf6           or     si,si
2225  7802           js     2229
2227  45             inc    bp
2228  c3             ret

2229  e80700         call   2233
222c  f9             stc
222d  e94def         jmp    117d
2230  e94def         jmp    1180
2233  1e             push   ds
2234  57             push   di
2235  51             push   cx
2236  e8cf01         call   2408
2239  2ec51eb800     lds    bx,cs:[00b8]
223e  897f16         mov    [bx+16],di
2241  8c4718         mov    [bx+18],es
2244  59             pop    cx
2245  5f             pop    di
2246  1f             pop    ds
2247  b406           mov    ah,06
2249  f9             stc
224a  c3             ret

224b  e8ba01         call   2408
224e  2ec51eb800     lds    bx,cs:[00b8]
2253  897f0f         mov    [bx+0f],di
2256  8c4711         mov    [bx+11],es
2259  c3             ret

225a  f745230200     test   [di+23],0002
225f  741c           jz     227d
2261  807d2202       cmp    [di+22],02           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
2265  7416           jz     227d
2267  80fcf9         cmp    ah,f9
226a  7511           jnz    227d
226c  b007           mov    al,07
226e  bb0fe0         mov    bx,e00f
2271  b96009         mov    cx,0960
2274  ba0201         mov    dx,0102
2277  83c402         add    sp,0002
227a  e9c9e9         jmp    0c46
227d  c3             ret

; -----------------------------------------------------------------------------
;                   Obsluha INT 13h - sledov n¡ v˜mˆny disket
; -----------------------------------------------------------------------------

227e                 dd     0                    ; £schova adresy INT 13h
2282                 dw     0                    ; offset n vratov‚ adresy
2284                 dw     0                    ; segment n vratov‚ adresy
2286                 dw     0                    ; registr p©¡znak– pro n vrat

                                                 ; obsluha INT 13h - sledov n¡ v˜mˆny diskety

2288  2e8f068222     pop    cs:[2282]            ; £schova offsetu n vratov‚ adresy
228d  2e8f068422     pop    cs:[2284]            ; £schova segmentu n vratov‚ adresy
2292  2e8f068622     pop    cs:[2286]            ; £schova registru p©¡znak–
2297  9c             pushf                       ; simulace vol n¡ INT ...
2298  2eff1e7e22     call   far cs:[227e]        ; vol n¡ p–vodn¡ obsluhy INT 13h
229d  7205           jc     22a4                 ; nastala chyba diskov‚ operace
229f  2eff2e8222     jmp    far cs:[2282]        ; n vrat z obsluhy INT 13h do programu
22a4  9c             pushf                       ; £schova registru p©¡znak–
22a5  80fc06         cmp    ah,06                ; byl k¢d chyby "disketa byla vymˆnˆna" ?
22a8  7406           jz     22b0                 ; disketa byla vymˆnˆna
22aa  9d             popf                        ; n vrat registru p©¡znak–
22ab  2eff2e8222     jmp    far cs:[2282]        ; n vrat z obsluhy INT 13h
22b0  0ad2         * or     dl,dl                ; jak˜ byl disk ?
22b2  78f6           js     22aa                 ; je pevn˜ disk - n vrat z obsluhy
22b4  2ec70652024000 mov    cs:[0252],0040       ; p©¡znak, ‘e byla disketa vymˆnˆna
22bb  e80200         call   22c0                 ; nastaven¡ p©¡znaku tabulky disk–
22be  ebea           jmp    22aa                 ; n vrat z obsluhy


                                                 ; nastaven¡ p©¡znaku v tabulk ch disk–
22c0  53           * push   bx
22c1  52             push   dx
22c2  8ada           mov    bl,dl                ; ‡¡slo disku
22c4  2e8b165202     mov    dx,cs:[0252]         ; p©¡znak, kter˜ se m  nastavit
22c9  32ff           xor    bh,bh                ; BH <- 00
22cb  50             push   ax                   ; £schova AX
22cc  1e             push   ds                   ; £schova DS
22cd  57             push   di                   ; £schova DI
22ce  2ec53e4c02     lds    di,cs:[024c]         ; za‡ tek tabulky disk. mechanik
22d3  83ffff       * cmp    di,ffff              ; je ji‘ posledn¡ polo‘ka ?
22d6  7411           jz     22e9                 ; je konec tabulky
22d8  385d04         cmp    [di+04],bl           ; je hledan  disketov  mechanika ?
22db  7503           jnz    22e0                 ; nen¡ - dal¨¡ polo‘ka tabulky
22dd  095523         or     [di+23],dx           ; po‘adovan‚ nastaven¡ p©¡znaku
22e0  8b4502       * mov    ax,[di+02]           ; segment n sleduj¡c¡ polo‘ky
22e3  8b3d           mov    di,[di]              ; offset n sleduj¡c¡ polo‘ky v tabulce
22e5  8ed8           mov    ds,ax                ; segment n sleduj¡c¡ polo‘ky
22e7  ebea           jmp    22d3                 ; test dal¨¡ tabulky disku
22e9  5f           * pop    di                   ; n vrat DI
22ea  1f             pop    ds                   ; n vrat DS
22eb  58             pop    ax                   ; n vrat AX
22ec  5a             pop    dx                   ; n vrat DX
22ed  5b             pop    bx                   ; n vrat BX
22ee  c3             ret

                                                 ; test, zda bylo m‚dium vymˆnˆno
                                                 ; VSTUP: ZY=nebylo vymˆnˆno
22ef  f745234000   * test   [di+23],0040
22f4  c3             ret

; -----------------------------------------------------------------------------


22f5                 db     83h,65h,23h,0bfh,0c3h

22fa  f745230200     test   [di+23],0002
22ff  c3             ret

2300                 db     'NO NAME    ',0
230c                 db     'NO NAME    ',0

2318  52             push   dx
2319  50             push   ax
231a  e8ddff         call   22fa
231d  740d           jz     232c
231f  57             push   di
2320  e81200         call   2335
2323  5f             pop    di
2324  720a           jc     2330
2326  e8a700         call   23d0
2329  e8c9ff         call   22f5
232c  f8             clc
232d  58             pop    ax
232e  5a             pop    dx
232f  c3             ret


2330  5a             pop    dx
2331  5a             pop    dx
2332  c3             ret

2333  0000           add    [bx+si],al

2335  06             push   es
2336  52             push   dx
2337  51             push   cx
2338  53             push   bx
2339  50             push   ax
233a  1e             push   ds
233b  57             push   di
233c  0e             push   cs
233d  07             pop    es
233e  0e             push   cs
233f  1f             pop    ds
2340  bf0c23         mov    di,230c
2343  be0023         mov    si,2300
2346  b90c00         mov    cx,000c
2349  f3a4           rep    movsb
234b  5f             pop    di
234c  1f             pop    ds
234d  8a450b         mov    al,[di+0b]
2350  8b4d11         mov    cx,[di+11]           ; po‡et sektor– v jedn‚ tabulce FAT
2353  f6e1           mul    cl
2355  034509         add    ax,[di+09]
2358  2ea33323       mov    cs:[2333],ax
235c  8b450c         mov    ax,[di+0c]           ; max. po‡et polo‘ek z kl. adres ©e
235f  b104           mov    cl,04
2361  d3e8           shr    ax,cl
2363  8bc8           mov    cx,ax
2365  51             push   cx
2366  2ea13323       mov    ax,cs:[2333]
236a  8b4d13         mov    cx,[di+13]           ; po‡et sektor– na stopu
236d  33d2           xor    dx,dx
236f  f7f1           div    cx
2371  42             inc    dx
2372  8aca           mov    cl,dl
2374  33d2           xor    dx,dx
2376  f77515         div    w/[di+15]            ; po‡et stran m‚dia
2379  8af2           mov    dh,dl
237b  8ae8           mov    ch,al
237d  e8f2e9         call   0d72                 ; na‡ten¡ sektoru do pamˆti
2380  724a           jc     23cc
2382  b91000         mov    cx,0010
2385  b008           mov    al,08
2387  26803f00       cmp    es:[bx],00
238b  743c           jz     23c9
238d  26803fe5       cmp    es:[bx],e5
2391  7406           jz     2399
2393  2684470b       test   es:[bx+0b],al
2397  7511           jnz    23aa
2399  83c320         add    bx,0020
239c  e2e9           loop   2387
239e  59             pop    cx
239f  2eff063323     inc    w/cs:[2333]
23a4  e2bf           loop   2365
23a6  33f6           xor    si,si
23a8  eb18           jmp    23c2
23aa  59             pop    cx
23ab  8bf3           mov    si,bx
23ad  1e             push   ds
23ae  57             push   di
23af  06             push   es
23b0  1f             pop    ds
23b1  0e             push   cs
23b2  07             pop    es
23b3  bf0c23         mov    di,230c
23b6  b90b00         mov    cx,000b
23b9  f3a4           rep    movsb
23bb  32c0           xor    al,al
23bd  aa             stosb
23be  33f6           xor    si,si
23c0  5f             pop    di
23c1  1f             pop    ds
23c2  58             pop    ax
23c3  f8             clc
23c4  5b             pop    bx
23c5  59             pop    cx
23c6  5a             pop    dx
23c7  07             pop    es
23c8  c3             ret

23c9  59             pop    cx
23ca  ebda           jmp    23a6
23cc  5e             pop    si
23cd  5e             pop    si
23ce  ebf4           jmp    23c4
23d0  1e             push   ds
23d1  57             push   di
23d2  06             push   es
23d3  56             push   si
23d4  51             push   cx
23d5  e83000         call   2408
23d8  fc             cld
23d9  f3a4           rep    movsb
23db  59             pop    cx
23dc  5e             pop    si
23dd  07             pop    es
23de  5f             pop    di
23df  1f             pop    ds
23e0  c3             ret

23e1  1e             push   ds
23e2  57             push   di
23e3  06             push   es
23e4  51             push   cx
23e5  e82000         call   2408
23e8  fc             cld
23e9  f3a6           rep    cmpsb
23eb  be0000         mov    si,0000
23ee  7403           jz     23f3
23f0  beffff         mov    si,ffff
23f3  59             pop    cx
23f4  07             pop    es
23f5  5f             pop    di
23f6  1f             pop    ds
23f7  c3             ret

                                                 ; test, zda souhlas¡ popisova‡ m‚dia
                                                 ; VSTUP: SI=0 souhlas¡, -1=nesouhlas¡

23f8  50             push   ax                   ; £schova AX
23f9  33f6           xor    si,si                ; SI=0 parametr operace OK
23fb  2ea05402       mov    al,cs:[0254]         ; popisova‡ m‚dia
23ff  3a4510         cmp    al,[di+10]           ; souhlas¡ popisova‡ m‚dia
2402  7401           jz     2405                 ; souhlas¡ popisova‡ m‚dia
2404  4e             dec    si                   ; SI <- FFFFh nesouhlas¡ popisova‡ m‚dia
2405  f8           * clc                         ; CF <- 0
2406  58             pop    ax                   ; n vrat AX
2407  c3             ret

2408  50             push   ax
2409  1e             push   ds
240a  07             pop    es
240b  0e             push   cs
240c  1f             pop    ds
240d  be0c23         mov    si,230c
2410  83c74b         add    di,004b
2413  b90c00         mov    cx,000c
2416  58             pop    ax
2417  c3             ret

                                                 ; tabulka pro 23 disk–
2418

2410   83 C7 4B B9 0C 00 58 C3 FF FF 00 00 50 03 00 02   ..K...X.....P...
2420   01 01 00 02 10 00 00 00 F8 01 00 00 00 00 00 00   ................
2430   00 00 00 00 00 00 00 00 00 00 03 20 00 28 00 00   ........... .(..
2440   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2450   00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 01   ................
2460   00 00 00 4E 4F 20 4E 41 4D 45 20 20 20 20 00 00   ...NO NAME    ..
2470   00 00 00 46 41 54 31 32 20 20 20 00 FF FF 00 00   ...FAT12   .....
2480   50 03 00 02 01 01 00 02 10 00 00 00 F8 01 00 00   P...............
2490   00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 20   ...............
24A0   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............
24B0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
24C0   00 00 FF 01 00 00 00 4E 4F 20 4E 41 4D 45 20 20   .......NO NAME
24D0   20 20 00 00 00 00 00 46 41 54 31 32 20 20 20 00     .....FAT12   .
24E0   FF FF 00 00 50 03 00 02 01 01 00 02 10 00 00 00   ....P...........
24F0   F8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2500   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........
2510   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2520   00 00 00 00 00 00 FF 01 00 00 00 4E 4F 20 4E 41   ...........NO NA
2530   4D 45 20 20 20 20 00 00 00 00 00 46 41 54 31 32   ME    .....FAT12
2540   20 20 20 00 FF FF 00 00 50 03 00 02 01 01 00 02      .....P.......
2550   10 00 00 00 F8 01 00 00 00 00 00 00 00 00 00 00   ................
2560   00 00 00 00 00 00 03 20 00 28 00 00 00 00 00 00   ....... .(......
2570   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2580   00 00 00 00 00 00 00 00 00 00 FF 01 00 00 00 4E   ...............N
2590   4F 20 4E 41 4D 45 20 20 20 20 00 00 00 00 00 46   O NAME    .....F
25A0   41 54 31 32 20 20 20 00 FF FF 00 00 50 03 00 02   AT12   .....P...
25B0   01 01 00 02 10 00 00 00 F8 01 00 00 00 00 00 00   ................
25C0   00 00 00 00 00 00 00 00 00 00 03 20 00 28 00 00   ........... .(..
25D0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
25E0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 01   ................
25F0   00 00 00 4E 4F 20 4E 41 4D 45 20 20 20 20 00 00   ...NO NAME    ..
2600   00 00 00 46 41 54 31 32 20 20 20 00 FF FF 00 00   ...FAT12   .....
2610   50 03 00 02 01 01 00 02 10 00 00 00 F8 01 00 00   P...............
2620   00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 20   ...............
2630   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............
2640   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2650   00 00 FF 01 00 00 00 4E 4F 20 4E 41 4D 45 20 20   .......NO NAME
2660   20 20 00 00 00 00 00 46 41 54 31 32 20 20 20 00     .....FAT12   .
2670   FF FF 00 00 50 03 00 02 01 01 00 02 10 00 00 00   ....P...........
2680   F8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2690   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........
26A0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
26B0   00 00 00 00 00 00 FF 01 00 00 00 4E 4F 20 4E 41   ...........NO NA
26C0   4D 45 20 20 20 20 00 00 00 00 00 46 41 54 31 32   ME    .....FAT12
26D0   20 20 20 00 FF FF 00 00 50 03 00 02 01 01 00 02      .....P.......
26E0   10 00 00 00 F8 01 00 00 00 00 00 00 00 00 00 00   ................
26F0   00 00 00 00 00 00 03 20 00 28 00 00 00 00 00 00   ....... .(......
2700   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2710   00 00 00 00 00 00 00 00 00 00 FF 01 00 00 00 4E   ...............N
2720   4F 20 4E 41 4D 45 20 20 20 20 00 00 00 00 00 46   O NAME    .....F
2730   41 54 31 32 20 20 20 00 FF FF 00 00 50 03 00 02   AT12   .....P...
2740   01 01 00 02 10 00 00 00 F8 01 00 00 00 00 00 00   ................
2750   00 00 00 00 00 00 00 00 00 00 03 20 00 28 00 00   ........... .(..
2760   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2770   00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 01   ................
2780   00 00 00 4E 4F 20 4E 41 4D 45 20 20 20 20 00 00   ...NO NAME    ..
2790   00 00 00 46 41 54 31 32 20 20 20 00 FF FF 00 00   ...FAT12   .....
27A0   50 03 00 02 01 01 00 02 10 00 00 00 F8 01 00 00   P...............
27B0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 20   ...............
27C0   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............
27D0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
27E0   00 00 FF 01 00 00 00 4E 4F 20 4E 41 4D 45 20 20   .......NO NAME
27F0   20 20 00 00 00 00 00 46 41 54 31 32 20 20 20 00     .....FAT12   .
2800   FF FF 00 00 50 03 00 02 01 01 00 02 10 00 00 00   ....P...........
2810   F8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2820   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........
2830   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2840   00 00 00 00 00 00 FF 01 00 00 00 4E 4F 20 4E 41   ...........NO NA
2850   4D 45 20 20 20 20 00 00 00 00 00 46 41 54 31 32   ME    .....FAT12
2860   20 20 20 00 FF FF 00 00 50 03 00 02 01 01 00 02      .....P.......
2870   10 00 00 00 F8 01 00 00 00 00 00 00 00 00 00 00   ................
2880   00 00 00 00 00 00 03 20 00 28 00 00 00 00 00 00   ....... .(......
2890   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
28A0   00 00 00 00 00 00 00 00 00 00 FF 01 00 00 00 4E   ...............N
28B0   4F 20 4E 41 4D 45 20 20 20 20 00 00 00 00 00 46   O NAME    .....F
28C0   41 54 31 32 20 20 20 00 FF FF 00 00 50 03 00 02   AT12   .....P...
28D0   01 01 00 02 10 00 00 00 F8 01 00 00 00 00 00 00   ................
28E0   00 00 00 00 00 00 00 00 00 00 03 20 00 28 00 00   ........... .(..
28F0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2900   00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 01   ................
2910   00 00 00 4E 4F 20 4E 41 4D 45 20 20 20 20 00 00   ...NO NAME    ..
2920   00 00 00 46 41 54 31 32 20 20 20 00 FF FF 00 00   ...FAT12   .....
2930   50 03 00 02 01 01 00 02 10 00 00 00 F8 01 00 00   P...............
2940   00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 20   ...............
2950   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............
2960   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2970   00 00 FF 01 00 00 00 4E 4F 20 4E 41 4D 45 20 20   .......NO NAME
2980   20 20 00 00 00 00 00 46 41 54 31 32 20 20 20 00     .....FAT12   .
2990   FF FF 00 00 50 03 00 02 01 01 00 02 10 00 00 00   ....P...........
29A0   F8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
29B0   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........
29C0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
29D0   00 00 00 00 00 00 FF 01 00 00 00 4E 4F 20 4E 41   ...........NO NA
29E0   4D 45 20 20 20 20 00 00 00 00 00 46 41 54 31 32   ME    .....FAT12
29F0   20 20 20 00 FF FF 00 00 50 03 00 02 01 01 00 02      .....P.......
2A00   10 00 00 00 F8 01 00 00 00 00 00 00 00 00 00 00   ................
2A10   00 00 00 00 00 00 03 20 00 28 00 00 00 00 00 00   ....... .(......
2A20   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2A30   00 00 00 00 00 00 00 00 00 00 FF 01 00 00 00 4E   ...............N
2A40   4F 20 4E 41 4D 45 20 20 20 20 00 00 00 00 00 46   O NAME    .....F
2A50   41 54 31 32 20 20 20 00 FF FF 00 00 50 03 00 02   AT12   .....P...
2A60   01 01 00 02 10 00 00 00 F8 01 00 00 00 00 00 00   ................
2A70   00 00 00 00 00 00 00 00 00 00 03 20 00 28 00 00   ........... .(..
2A80   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2A90   00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 01   ................
2AA0   00 00 00 4E 4F 20 4E 41 4D 45 20 20 20 20 00 00   ...NO NAME    ..
2AB0   00 00 00 46 41 54 31 32 20 20 20 00 FF FF 00 00   ...FAT12   .....
2AC0   50 03 00 02 01 01 00 02 10 00 00 00 F8 01 00 00   P...............
2AD0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 20   ...............
2AE0   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............
2AF0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2B00   00 00 FF 01 00 00 00 4E 4F 20 4E 41 4D 45 20 20   .......NO NAME
2B10   20 20 00 00 00 00 00 46 41 54 31 32 20 20 20 00     .....FAT12   .
2B20   FF FF 00 00 50 03 00 02 01 01 00 02 10 00 00 00   ....P...........
2B30   F8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2B40   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........
2B50   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2B60   00 00 00 00 00 00 FF 01 00 00 00 4E 4F 20 4E 41   ...........NO NA
2B70   4D 45 20 20 20 20 00 00 00 00 00 46 41 54 31 32   ME    .....FAT12
2B80   20 20 20 00 FF FF 00 00 50 03 00 02 01 01 00 02      .....P.......
2B90   10 00 00 00 F8 01 00 00 00 00 00 00 00 00 00 00   ................
2BA0   00 00 00 00 00 00 03 20 00 28 00 00 00 00 00 00   ....... .(......
2BB0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2BC0   00 00 00 00 00 00 00 00 00 00 FF 01 00 00 00 4E   ...............N
2BD0   4F 20 4E 41 4D 45 20 20 20 20 00 00 00 00 00 46   O NAME    .....F
2BE0   41 54 31 32 20 20 20 00 FF FF 00 00 50 03 00 02   AT12   .....P...
2BF0   01 01 00 02 10 00 00 00 F8 01 00 00 00 00 00 00   ................
2C00   00 00 00 00 00 00 00 00 00 00 03 20 00 28 00 00   ........... .(..
2C10   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2C20   00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF 01   ................
2C30   00 00 00 4E 4F 20 4E 41 4D 45 20 20 20 20 00 00   ...NO NAME    ..
2C40   00 00 00 46 41 54 31 32 20 20 20 00 FF FF 00 00   ...FAT12   .....
2C50   50 03 00 02 01 01 00 02 10 00 00 00 F8 01 00 00   P...............
2C60   00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 20   ...............
2C70   00 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00   .(..............
2C80   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2C90   00 00 FF 01 00 00 00 4E 4F 20 4E 41 4D 45 20 20   .......NO NAME
2CA0   20 20 00 00 00 00 00 46 41 54 31 32 20 20 20 00     .....FAT12   .
2CB0   FF FF 00 00 50 03 00 02 01 01 00 02 10 00 00 00   ....P...........
2CC0   F8 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2CD0   00 00 03 20 00 28 00 00 00 00 00 00 00 00 00 00   ... .(..........
2CE0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
2CF0   00 00 00 00 00 00 FF 01 00 00 00 4E 4F 20 4E 41   ...........NO NA
2D00   4D 45 20 20 20 20 00 00 00 00 00 46 41 54 31 32   ME    .....FAT12
2D10   20 20 20 00 00 00 00 00 00 00 00 00 00 00 00 00      .............
2D20   00 00 00 00 80 FA 80 72 0A 80 FC 02 74 0A 80 FC   .......r....t...
2D30   0A 74 05 2E FF 2E B0 00 53 51 52 57 1E 06 50 B8   .t......SQRW..P.
2D40   40 00 8E D8 C6 06 74 00 00 80 E2 7F 3A 16 75 00   @.....t....:.u.

; -----------------------------------------------------------------------------
;                              Obsluha INT 13h
; -----------------------------------------------------------------------------

                                                 ; obsluha INT 13h
                                                 ; - tato obsluha se p©enese na konec
                                                 ;   1. ‡ sti IO.SYS

2d24  80fa80         cmp    dl,80
2d27  720a           jc     2d33
2d29  80fc02         cmp    ah,02
2d2c  740a           jz     2d38
2d2e  80fc0a         cmp    ah,0a
2d31  7405           jz     2d38
2d33  2eff2eb000     jmp    far cs:[00b0]
2d38  53             push   bx
2d39  51             push   cx
2d3a  52             push   dx
2d3b  57             push   di
2d3c  1e             push   ds
2d3d  06             push   es
2d3e  50             push   ax
2d3f  b84000         mov    ax,0040
2d42  8ed8           mov    ds,ax
2d44  c606740000     mov    [0074],00
2d49  80e27f         and    dl,7f
2d4c  3a167500       cmp    dl,[0075]
2d50  7207           jc     2d59
2d52  c606740001     mov    [0074],01
2d57  eb20           jmp    2d79
2d59  53             push   bx
2d5a  8cc0           mov    ax,es
2d5c  c1eb04         shr    bx,04
2d5f  03c3           add    ax,bx
2d61  8ec0           mov    es,ax
2d63  5b             pop    bx
2d64  83e30f         and    bx,+0f
2d67  0e             push   cs
2d68  e8de00         call   2e49
2d6b  720c           jc     2d79
2d6d  58             pop    ax
2d6e  50             push   ax
2d6f  e81a00         call   2d8c
2d72  baf603         mov    dx,03f6
2d75  ee             out    dx,al
2d76  e86b00         call   2de4
2d79  58             pop    ax
2d7a  8a267400       mov    ah,[0074]
2d7e  0ae4           or     ah,ah
2d80  7401           jz     2d83
2d82  f9             stc
2d83  07             pop    es
2d84  1f             pop    ds
2d85  5f             pop    di
2d86  5a             pop    dx
2d87  59             pop    cx
2d88  5b             pop    bx
2d89  ca0200         ret    far  0002


2d8c  a24300         mov    [0043],al
2d8f  c606480020     mov    [0048],20
2d94  80fc02         cmp    ah,02
2d97  7405           jz     2d9e
2d99  c606480022     mov    [0048],22
2d9e  8ac1           mov    al,cl
2da0  243f           and    al,3f
2da2  a24400         mov    [0044],al
2da5  882e4500       mov    [0045],ch
2da9  8ac1           mov    al,cl
2dab  c0e806         shr    al,06
2dae  a24600         mov    [0046],al
2db1  8bc2           mov    ax,dx
2db3  c0e004         shl    al,04
2db6  80e40f         and    ah,0f
2db9  0ac4           or     al,ah
2dbb  0ca0           or     al,a0
2dbd  a24700         mov    [0047],al
2dc0  06             push   es
2dc1  53             push   bx
2dc2  0e             push   cs
2dc3  e85b00         call   2e21
2dc6  268b4705       mov    ax,es:[bx+05]
2dca  c1e802         shr    ax,02
2dcd  a24200         mov    [0042],al
2dd0  268a4708       mov    al,es:[bx+08]
2dd4  5b             pop    bx
2dd5  07             pop    es
2dd6  8a267600       mov    ah,[0076]
2dda  80e4c0         and    ah,c0
2ddd  0ae0           or     ah,al
2ddf  88267600       mov    [0076],ah
2de3  c3             ret
2de4  8bfb           mov    di,bx
2de6  0e             push   cs
2de7  e83f00         call   2e29
2dea  7534           jnz    2e20
2dec  0e             push   cs
2ded  e84100         call   2e31
2df0  752e           jnz    2e20
2df2  b90001         mov    cx,0100
2df5  baf001         mov    dx,01f0
2df8  fc             cld
2df9  fa             cli
2dfa  f36d           rep    insw
2dfc  fb             sti
2dfd  f606480002     test   [0048],02
2e02  7410           jz     2e14
2e04  0e             push   cs
2e05  e83100         call   2e39
2e08  7216           jc     2e20
2e0a  b90400         mov    cx,0004
2e0d  baf001         mov    dx,01f0
2e10  fa             cli
2e11  f36c           rep    insb
2e13  fb             sti
2e14  0e             push   cs
2e15  e82900         call   2e41
2e18  7506           jnz    2e20
2e1a  fe0e4300       dec    b/[0043]
2e1e  75cc           jnz    2dec
2e20  c3             ret

2e21  6865ff         push   ff65
2e24  ea8e2f00f0     jmp    f000:2f8e

2e29  6865ff         push   ff65
2e2c  ea1e2e00f0     jmp    f000:2e1e

2e31  6865ff         push   ff65
2e34  ea7f2e00f0     jmp    f000:2e7f

2e39  6865ff         push   ff65
2e3c  eae22e00f0     jmp    f000:2ee2

2e41  6865ff         push   ff65
2e44  eaf82e00f0     jmp    f000:2ef8

2e49  6865ff         push   ff65
2e4c  ea692f00f0     jmp    f000:2f69

2e51                 db     0

; -----------------------------------------------------------------------------
;                              Obsluha hodin
; -----------------------------------------------------------------------------

                                                 ; obsluha
                                                 ; - tato obsluha se p©enese na konec
                                                 ;   1. ‡ sti IO.SYS


2e52  2eff362806     push   cs:[0628]
2e57  2e813e2806891c cmp    cs:[0628],1c89h
2e5e  730f           jnc    2e6f
2e60  2ec6065b0913   mov    cs:[095b],13
2e66  2ec6065c0950   mov    cs:[095c],50
2e6c  eb14           jmp    2e82
2e6e  90             nop
2e6f  2ec6065b0914   mov    cs:[095b],14
2e75  2ec6065c0900   mov    cs:[095c],00
2e7b  2e812e2806891c sub    cs:[0628],1c89       ; po‡et dn– od 1.1.1980
2e82  33d2           xor    dx,dx
2e84  2ea12806       mov    ax,cs:[0628]         ; po‡et dn– od 1.1.1980
2e88  bbb505         mov    bx,05b5
2e8b  f7f3           div    bx
2e8d  2e89162806     mov    cs:[0628],dx         ; po‡et dn– od 1.1.1980
2e92  b304           mov    bl,04
2e94  f6e3           mul    bl
2e96  2e00065c09     add    cs:[095c],al
2e9b  2eff062806     inc    w/cs:[0628]          ; po‡et dn– od 1.1.1980
2ea0  2e813e28066e01 cmp    cs:[0628],016e       ; po‡et dn– od 1.1.1980
2ea7  7626           jna    2ecf
2ea9  2efe065c09     inc    b/cs:[095c]
2eae  2e812e28066e01 sub    cs:[0628],016e       ; po‡et dn– od 1.1.1980
2eb5  b90300         mov    cx,0003
2eb8  2e813e28066d01 cmp    cs:[0628],016d       ; po‡et dn– od 1.1.1980
2ebf  7614           jna    2ed5
2ec1  2efe065c09     inc    b/cs:[095c]
2ec6  2e812e28066d01 sub    cs:[0628],016d       ; po‡et dn– od 1.1.1980
2ecd  e2e9           loop   2eb8
2ecf  2ec6065e091d   mov    cs:[095e],1d
2ed5  33db           xor    bx,bx
2ed7  33d2           xor    dx,dx
2ed9  2ea12806       mov    ax,cs:[0628]         ; po‡et dn– od 1.1.1980
2edd  be5d09         mov    si,095d
2ee0  b90c00         mov    cx,000c
2ee3  fec3           inc    bl
2ee5  8a14           mov    dl,[si]
2ee7  3bc2           cmp    ax,dx
2ee9  7605           jna    2ef0
2eeb  46             inc    si
2eec  2bc2           sub    ax,dx
2eee  e2f3           loop   2ee3
2ef0  2ec6065e091c   mov    cs:[095e],1c
2ef6  8ad3           mov    dl,bl
2ef8  2e8a365c09     mov    dh,cs:[095c]
2efd  2e8a0e5b09     mov    cl,cs:[095b]
2f02  2eff166909     call   cs:[0969]            ; adresa obsluhy hodin
2f07  86d0           xchg   dl,al
2f09  2eff166909     call   cs:[0969]            ; adresa obsluhy hodin
2f0e  86f0           xchg   dh,al
2f10  2eff166909     call   cs:[0969]            ; adresa obsluhy hodin
2f15  86c8           xchg   cl,al
2f17  2eff166909     call   cs:[0969]            ; adresa obsluhy hodin
2f1c  8ae8           mov    ch,al
2f1e  2e8f062806     pop    cs:[0628]            ; po‡et dn– od 1.1.1980
2f23  c3             ret

; -----------------------------------------------------------------------------

                                                 ; p©evod dekadick‚ ‡¡slice na BCD
2f24  51             push   cx                   ; £schova CX
2f25  32e4           xor    ah,ah                ; AH <- 0
2f27  b10a           mov    cl,0a                ; CL <- 10
2f29  f6f1           div    cl                   ; AL / 10
2f2b  b104           mov    cl,04                ; po‡et rotac¡
2f2d  d2e0           shl    al,cl                ; AL * 16 (vy¨¨¡ © d ‡¡sla BCD)
2f2f  0ac4           or     al,ah                ; + AH = ni‘¨¡ © d ‡¡sla BCD
2f31  59             pop    cx                   ; n vrat CX
2f32  c3             ret
2f33  90             nop

; -----------------------------------------------------------------------------
;                              Inicializace hodin
; -----------------------------------------------------------------------------

                                                 ; n sleduj¡c¡ podprogramy se
                                                 ; uchovaj¡ na konci modulu IO.SYS
                                                 ; pouze pro konvertabiln¡ PC

                                                 ; inicializace syst‚mov‚ho data a ‡asu
                                                 ; - obsluha INT 6CH po opˆtovn‚m
                                                 ;   startu po‡¡ta‡e
2f34  0e             push   cs
2f35  1f             pop    ds                   ; DS <- CS
2f36  8f064620       pop    [2046]               ; n vratov  adresa IP
2f3a  8f064820       pop    [2048]               ; n vratov˜ segment CS
2f3e  9d             popf                        ; n vrat registru p©¡znak–
2f3f  e81300         call   2f55                 ; zji¨tˆn¡ po‡tu dn– od 1.1.1980
2f42  fa             cli
2f43  89362806       mov    [0628],si            ; po‡et dn– od 1.1.1980
2f47  fb             sti
2f48  e8cc00         call   3017                 ; zji¨tˆn¡ syst‚mov‚ho ‡asu pro ‡asova‡
2f4b  fa             cli
2f4c  b401           mov    ah,01                ; funkce nastaven¡ syst‚mov‚ho ‡asova‡e
2f4e  cd1a           int    1a                   ; nastaven¡ syst‚mov‚ho ‡asova‡e
2f50  fb             sti
2f51  ff2e4620       jmp    far [2046]           ; n vrat zpˆt do programu


                                                 ; zji¨tˆn¡ po‡tu dn– od 1.1.1980
2f55  50             push   ax                   ; £schova AX
2f56  51             push   cx                   ; £schova CX
2f57  52             push   dx                   ; £schova DX
2f58  32e4           xor    ah,ah                ; funkce ‡ten¡ syst‚mov‚ho ‡asova‡e
2f5a  cd1a           int    1a                   ; ‡ten¡ syst‚mov‚ho ‡asova‡e
                                                 ; pro zru¨en¡ indikace p©elomu 24 hodin
2f5c  5a             pop    dx                   ; n vrat DX
2f5d  59             pop    cx                   ; n vrat CX
2f5e  58             pop    ax                   ; n vrat AX
2f5f  50             push   ax                   ; £schova AX
2f60  53             push   bx                   ; £schova BX
2f61  51             push   cx                   ; £schova CX
2f62  52             push   dx                   ; £schova DX
2f63  2ec70666200100 mov    cs:[2066],0001       ; p©¡znak - datum nespr vn‚
2f6a  b404           mov    ah,04                ; funkce ‡ten¡ data
2f6c  cd1a           int    1a                   ; ‡ten¡ data hodin re ln‚ho ‡asu BCD
2f6e  7303           jnc    2f73                 ; hodiny pracuj¡ OK
2f70  e99300         jmp    3006                 ; chyba - hodiny nepracuj¡
2f73  882e4a20     * mov    [204a],ch            ; stolet¡ (BCD)
2f77  880e4b20       mov    [204b],cl            ; rok (BCD)
2f7b  88364c20       mov    [204c],dh            ; mˆs¡c (BCD)
2f7f  88164d20       mov    [204d],dl            ; den (BCD)
2f83  2ec70666200200 mov    cs:[2066],0002       ; p©¡znak - syst. datum nespr vn˜ tvar BCD
2f8a  e85601         call   30e3                 ; kontrola £daje hodin BCD
2f8d  7277           jc     3006                 ; chyba tvaru BCD data
2f8f  2ec70666200300 mov    cs:[2066],0003       ; p©¡znak - syst. datum nespr vn˜ £daj
2f96  e8f300         call   308c                 ; kontrola spr vnosti data
2f99  726b           jc     3006                 ; chyba £daje data
2f9b  2ec70666200000 mov    cs:[2066],0000       ; p©¡znak - syst. datum spr vn‚
2fa2  e8ac00         call   3051                 ; p©evod data z BCD tvaru na bin rn¡
2fa5  a04b20         mov    al,[204b]            ; rok (bin rn¡ £daj)
2fa8  98             cbw                         ; AX <- AL (rok)
2fa9  803e4a2014     cmp    [204a],14            ; stolet¡ = 20 (bin rn¡ £daj) ?
2fae  7503           jnz    2fb3                 ; je stolet¡ 19
2fb0  056400         add    ax,0064              ; je stolet¡ 20 (rok + 100)
2fb3  2d5000       * sub    ax,0050              ; offset od roku 1980
2fb6  b104           mov    cl,04                ; perioda p©estupn˜ch rok–
2fb8  f6f1           div    cl                   ; rok/4 (po‡et p©estup– rok–)
2fba  8adc           mov    bl,ah                ; zbytek po dˆlen¡ (rok po p©estupn‚m roku)
2fbc  98             cbw                         ; po‡et rok–/4
2fbd  b9b505         mov    cx,05b5              ; 1461 (=4*365+1) - po‡et dn– za ‡ty©let¡
2fc0  f7e1           mul    cx                   ; *1461 - po‡et dn– do p©estupn‚ho roku
2fc2  2ea36620       mov    cs:[2066],ax         ; po‡et dn– od 1.1.1980
2fc6  8ac3           mov    al,bl                ; po‡et rok– od p©estupn‚ho roku
2fc8  98             cbw                         ; AX <- AL
2fc9  0bc0           or     ax,ax                ; je p©estupn˜ rok ?
2fcb  740c           jz     2fd9                 ; je p©estupn˜ rok
2fcd  b96d01         mov    cx,016d              ; 365 po‡et dn– v nep©estupn‚m roce
2fd0  f7e1           mul    cx                   ; * 365 - po‡et dn– od p©estupn‚ho roku
2fd2  2e01066620     add    cs:[2066],ax         ; po‡et dn– od 1.1.1980
2fd7  eb07           jmp    2fe0                 ; nen¡ p©estupn˜ rok
2fd9  803e4c2002   * cmp    [204c],02            ; mˆs¡c - je £nor ?
2fde  7605           jna    2fe5                 ; je leden nebo £nor
2fe0  2eff066620   * inc    w/cs:[2066]          ; korekce pro p©estupn˜ rok
2fe5  8a0e4d20     * mov    cl,[204d]            ; den v mˆs¡ci
2fe9  32ed           xor    ch,ch                ; CH <- 0
2feb  49             dec    cx                   ; den v mˆs¡ci - 1
2fec  2e010e6620     add    cs:[2066],cx         ; p©i‡ten¡ dne v mˆs¡ci
2ff1  8a0e4c20       mov    cl,[204c]            ; mˆs¡c
2ff5  32ed           xor    ch,ch                ; CH <- 0
2ff7  49             dec    cx                   ; mˆs¡c - 1
2ff8  d1e1           shl    cx,1                 ; mˆs¡c * 2
2ffa  be4e20         mov    si,204e              ; tabulka mˆs¡c– (po‡ty dn– od za‡ tku)
2ffd  03f1           add    si,cx                ; adresa p©¡slu¨n‚ho mˆs¡ce
2fff  8b04           mov    ax,[si]              ; po‡et dn– od za‡ tku roku
3001  2e01066620     add    cs:[2066],ax         ; p©i‡ten¡ k po‡tu dn– od 1.1.1980
3006  2e8b366620   * mov    si,cs:[2066]         ; po‡et dn– od 1.1.1980
300b  5a             pop    dx
300c  59             pop    cx
300d  5b             pop    bx
300e  58             pop    ax
300f  c3             ret

                                                 ; chyba ‡ten¡ ‡asu
3010  33c9         * xor    cx,cx
3012  33d2           xor    dx,dx
3014  eb3a           jmp    3050
3016  90             nop

                                                 ; zji¨tˆn¡ syst‚mov‚ho ‡asu pro ‡¡ta‡
3017  b402           mov    ah,02                ; funkce ‡ten¡ ‡asu hodin
3019  cd1a           int    1a                   ; ‡ten¡ ‡asu hodin re ln‚ho ‡asu
301b  72f3           jc     3010                 ; hodiny nepracuj¡
301d  882e4a20       mov    [204a],ch            ; hodina (BCD)
3021  880e4b20       mov    [204b],cl            ; minuta (BCD)
3025  88364c20       mov    [204c],dh            ; sekunda (BCD)
3029  c6064d2000     mov    [204d],00            ; setiny sekundy (BCD)
302e  e8b200         call   30e3                 ; kontrola tvaru BCD ‡asu
3031  72dd           jc     3010                 ; chyba £daje BCD ‡asu
3033  e89400         call   30ca                 ; kontrola £daje ‡asu (BCD)
3036  72d8           jc     3010                 ; nespr vn˜ £daj ‡asu
3038  e81600         call   3051                 ; p©evod data z BCD tvaru na bin rn¡
303b  8a2e4a20       mov    ch,[204a]            ; hodina (bin rnˆ)
303f  8a0e4b20       mov    cl,[204b]            ; minuta (bin rnˆ)
3043  8a364c20       mov    dh,[204c]            ; sekunda (bin rnˆ)
3047  8a164d20       mov    dl,[204d]            ; setina sekundy (bin rnˆ)
304b  2eff166d09     call   cs:[096d]            ; p©epo‡et na £daj syst‚mov‚ho ‡¡ta‡e
3050  c3             ret

                                                 ; p©evod data z BCD tvaru na bin rn¡
3051  a04a20         mov    al,[204a]            ; stolet¡ (BCD)
3054  e81f00         call   3076                 ; p©evod ‡¡sla BCD na bin rn¡
3057  a24a20         mov    [204a],al            ; stolet¡ (bin rn¡)
305a  a04b20         mov    al,[204b]            ; rok (BCD)
305d  e81600         call   3076                 ; p©evod ‡¡sla BCD na bin rn¡
3060  a24b20         mov    [204b],al            ; rok (bin rn¡)
3063  a04c20         mov    al,[204c]            ; mˆs¡c (BCD)
3066  e80d00         call   3076                 ; p©evod ‡¡sla BCD na bin rn¡
3069  a24c20         mov    [204c],al            ; mˆs¡c (bin rn¡)
306c  a04d20         mov    al,[204d]            ; den (BCD)
306f  e80400         call   3076                 ; p©evod ‡¡sla BCD na bin rn¡
3072  a24d20         mov    [204d],al            ; den (bin rn¡)
3075  c3             ret

                                                 ; p©evod bajtu BCD na bin rn¡
                                                 ; VSTUP: AL=‡¡slo BCD k p©evodu
                                                 ; VSTUP: AL=p©eveden‚ ‡¡slo
3076  8ae0           mov    ah,al                ; ‡¡slo k p©evodu
3078  250ff0         and    ax,f00f              ; AH=des¡tky, AL=jednotky
307b  8ad8           mov    bl,al                ; jednotky
307d  86e0           xchg   ah,al                ; AL <- des¡tky
307f  32e4           xor    ah,ah
3081  b104           mov    cl,04
3083  d3e8           shr    ax,cl                ; AL/16
3085  b10a           mov    cl,0a                ; CL <- 10
3087  f6e1           mul    cl                   ; CL*10
3089  02c3           add    al,bl                ; + jednotky = v˜sledn‚ ‡¡slo
308b  c3             ret

                                                 ; kontrola spr vnosti data
308c  803e4a2020     cmp    [204a],20            ; stolet¡ = 20 (BCD £daj) ?
3091  7735           ja     30c8                 ; chyba-stolet¡ vˆt¨¡ ne‘ 20
3093  740e           jz     30a3                 ; je stolet¡ 20 (OK)
3095  803e4a2019     cmp    [204a],19            ; stolet¡ = 19 (BCD £daj) ?
309a  722c           jc     30c8                 ; chyba-stolet¡ men¨¡ ne‘ 19
309c  803e4b2080     cmp    [204b],80            ; rok < 80 ?
30a1  7225           jc     30c8                 ; chyba - rok men¨¡ ne‘ 1980
30a3  803e4b2099   * cmp    [204b],99            ; rok > 99 ?
30a8  771e           ja     30c8                 ; chyba - rok vˆt¨¡ ne‘ 99
30aa  803e4c2012     cmp    [204c],12            ; mˆs¡c > 12 ?
30af  7717           ja     30c8                 ; chyba - mˆs¡c vˆt¨¡ ne‘ 12
30b1  803e4c2000     cmp    [204c],00            ; mˆs¡c < 0 ?
30b6  7610           jna    30c8                 ; chyba - mˆs¡c <= 0
30b8  803e4d2031     cmp    [204d],31            ; den > 31 ?
30bd  7709           ja     30c8                 ; chyba - den vˆt¨¡ ne‘ 31
30bf  803e4d2000     cmp    [204d],00            ; den < 0 ?
30c4  7602           jna    30c8                 ; chyba - den <= 0
30c6  f8             clc                         ; tvar data OK
30c7  c3             ret
30c8  f9           * stc                         ; chyba £daje
30c9  c3             ret

                                                 ; kontrola £daje ‡asu (BCD)
30ca  803e4a2024     cmp    [204a],24            ; hodina > 24 (BCD £daj) ?
30cf  7710           ja     30e1                 ; chyba: hodina > 24
30d1  803e4b2059     cmp    [204b],59            ; minuta > 59 ?
30d6  7709           ja     30e1                 ; chyba: minuta > 59
30d8  803e4c2059     cmp    [204c],59            ; sekunda > 59 ?
30dd  7702           ja     30e1                 ; chyba: minuta > 59
30df  f8             clc                         ; £daj ‡asu OK
30e0  c3             ret
30e1  f9           * stc                         ; chyba £daje ‡asu
30e2  c3             ret

                                                 ; kontrola tvaru BCD hodin
30e3  b90400         mov    cx,0004              ; po‡et bajt– ke kontrole
30e6  bb4a20         mov    bx,204a              ; £daj hodin re ln‚ho ‡asu
30e9  8a07           mov    al,[bx]              ; bajt ke kontrole
30eb  8ae0           mov    ah,al                ; bajt ke kontrole tvaru BCD
30ed  250ff0         and    ax,f00f              ; AH=des¡tky, AL=jednotky
30f0  3c0a           cmp    al,0a                ; kontrola: jednotky > 10 ?
30f2  7716           ja     310a                 ; chyba, je > 10
30f4  d0ec           shr    ah,1                 ; AH/2
30f6  d0ec           shr    ah,1                 ; AH/4
30f8  d0ec           shr    ah,1                 ; AH/8
30fa  d0ec           shr    ah,1                 ; AH/16
30fc  80e40f         and    ah,0f                ; des¡tky
30ff  80fc0a         cmp    ah,0a                ; kontrola: des¡tky > 10 ?
3102  7706           ja     310a                 ; chyba - des¡tky > 10
3104  43             inc    bx                   ; zv˜¨en¡ ukazatele
3105  49             dec    cx                   ; ‡¡ta‡ bajt–
3106  75e1           jnz    30e9                 ; dal¨¡ bajt ke kontrole
3108  f8             clc                         ; kontrola OK
3109  c3             ret
310a  f9           * stc                         ; chyba £daje
310b  c3             ret


; ----------------------------------------------------------------------------
;                         Inicializace syst‚mu - data
; ----------------------------------------------------------------------------


310c                 db     0                    ; po‡et disketov˜ch mechanik
310d                 db     0                    ; popisova‡ m‚dia
310e                 dd     0                    ; sektor za IO.SYS
3112                 dw     0                    ; ‡¡ta‡ sektor– pro ‡ten¡ bloku
3114                 db     0                    ; 80h=chyba, 40h=mus¡ b˜t FAT16
3115                 dw     0                    ; segment pro na‡ten¡ tabulky FAT
                                                 ; (konec pamˆti - 400h)
3117                 dw     0                    ; segment pro na‡ten¡ zav dˆc¡ho sektoru
                                                 ; (konec pamˆti - 800h)
3119                 db     80h                  ; ‡¡slo pevn‚ho disku
311a                 dw     0200h                ; po‡et bajt– na sektor

311e                 dw     0ffffh
3120                 db     2                    ; po‡et hlav disku
3121                 db     9                    ; po‡et sektor– na stopu
3122                 db     28h                  ; po‡et stop disku
3123                 db     0                    ; 1=nen¡ ‘ dn  disket. mech.

3110   00 00 00 00 00 00 00 00 00 80 00 02 00 00 FF FF   ................
3120   02 09 28 00 00 02 00 01 40 00 00 00 00 08 01 02   ..(.....@.......
3130   70 00 00 00 00 20 02 04 00 01 00 00 A8 7F 03 08   p.... .........
3140   00 02 00 00 FF FF 04 10 00 04 00 00 00 00 A8 7F   ...............

                                                 ; tabulky pro nastaven¡ odd¡l– pevn‚ho disku

314c                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
314e                 dw     7fa8h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
3150                 db     3                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
3151                 db     8                    ; po‡et sektor– na aloka‡n¡ blok
3152                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
3154                 dw     0000h                ; typ FAT (40=FAT16, 00=FAT12)

3156                 dw     0004h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
3158                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
315a                 db     2                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
315b                 db     4                    ; po‡et sektor– na aloka‡n¡ blok
315c                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
315e                 dw     0040h                ; typ FAT (40=FAT16, 00=FAT12)

3160                 dw     0008h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
3162                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
3164                 db     3                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
3165                 db     8                    ; po‡et sektor– na aloka‡n¡ blok
3166                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
3168                 dw     0040h                ; typ FAT (40=FAT16, 00=FAT12)

316a                 dw     0010h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
316c                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
316e                 db     4                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
316f                 db     10h                  ; po‡et sektor– na aloka‡n¡ blok
3170                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
3172                 dw     0040h                ; typ FAT (40=FAT16, 00=FAT12)

3174                 dw     0020h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
3176                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
3178                 db     5                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
3179                 db     20h                  ; po‡et sektor– na aloka‡n¡ blok
317a                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
317c                 dw     0040h                ; typ FAT (40=FAT16, 00=FAT12)

317e                 dw     0040h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
3180                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
3182                 dw     6                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
3183                 dw     40h                  ; po‡et sektor– na aloka‡n¡ blok
3184                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
3186                 dw     0040h                ; typ FAT (40=FAT16, 00=FAT12)

3188                 dw     0080h                ; maxim ln¡ po‡et sektor– odd¡lu - HIGH
318a                 dw     0000h                ; maxim ln¡ po‡et sektor– odd¡lu - LOW
318c                 dw     7                    ; po‡et rotac¡ pro p©epo‡et sektor– na bloky
318d                 dw     80h                  ; po‡et sektor– na aloka‡n¡ blok
318e                 dw     0200h                ; po‡et polo‘ek z kladn¡ho adres ©e
3190                 dw     0040h                ; typ FAT (40=FAT16, 00=FAT12)

3192                 dw     0000h                ; adresa n sleduj¡c¡ nepou‘it‚ tabulky disku

3194                 db     0                    ; po‡et pevn˜ch disk– v syst‚mu
3195                 db     0                    ; celkov˜ po‡et disk–
3196                 db     0                    ; po‡et odd¡l– na pevn‚m disku
3197                 db     80h                  ; ‡¡slo pevn‚ho disku
3198                 dw     0                    ; po‡et hlav pevn‚ho disku
319a                 dw     0                    ; po‡et sektor– na stopu
319c                 dw     0                    ; adresa v tabulce BPB za posledn¡m diskem

319e                 db     '01/10/84'

31A0   2F 31 30 2F 38 34 00 90 00 02 02 01 00 02 70 00   /10/84........p.
31B0   D0 02 FD 02 00 09 00 02 00 00 00 00 00 00 00 00   ................
31C0   00 90 00 02 01 01 00 02 E0 00 60 09 F9 07 00 0F   ..........`.....
31D0   00 02 00 00 00 00 00 00 00 00 00 90 00 02 02 01   ................
31E0   00 02 70 00 A0 05 F9 03 00 09 00 02 00 00 00 00   ..p.............
31F0   00 00 00 00 00 90 A8 31 C2 31 DC 31 0A 00 CD 0A   .......1.1.1....


                                                 ; tabulka adres k vynulov n¡
                                                 ; funkc¡ indikace v˜mˆny m‚dia

31fc                 dw     0ah                  ; po‡et bajt– k vynulov n¡
31fe                 dw     0acdh                ; adresa k vynulov n¡ programu
3200                 dw     3
3202                 dw     0befh
3204                 dw     3
3206                 dw     0b70h
3208                 dw     3
320a                 dw     0f42h
320c                 dw     3
320e                 dw     1143h
3210                 dw     0ah
3212                 dw     1229h
3214                 dw     3
3216                 dw     0af9h
3218                 dw     0


; *****************************************************************************
;
;                           Inicializace IO.SYS
;
; *****************************************************************************

                                                 ; start modulu IO.SYS
                                                 ; VSTUP: CH=popisova‡ m‚dia
                                                 ;        DL=‡¡slo disku
                                                 ;        AX:BX=dal¨¡ sektor


321a  fa           * cli                         ; z kaz p©eru¨en¡
321b  50             push   ax                   ; £schova sektoru HIGH
321c  33c0           xor    ax,ax                ; AX <- 0
321e  8ed8           mov    ds,ax                ; DS <- 0
3220  58             pop    ax                   ; n vrat sektoru HIGH
3221  2ea31031       mov    cs:[3110],ax         ; dal¨¡ sektor HIGH
3225  2e891e0e31     mov    cs:[310e],bx         ; dal¨¡ sektor LOW

                                               ;* instalace obsluhy INT 13h
322a  a14c00         mov    ax,[004c]            ; INT 13H - LOW
322d  2ea3b000       mov    cs:[00b0],ax         ; p–vodn¡ adresa INT 13H - LOW
3231  2ea3b400       mov    cs:[00b4],ax         ; adresa INT 13H - LOW
3235  a14e00         mov    ax,[004e]            ; INT 13H - HIGH (segment)
3238  2ea3b200       mov    cs:[00b2],ax         ; adresa INT 13H - HIGH
323c  2ea3b600       mov    cs:[00b6],ax         ; vlastn¡ adresa INT 13H - HIGH
3240  c7064c001f12   mov    [004c],121f          ; vlastn¡ obsluha INT 13H
3246  8c0e4e00       mov    [004e],cs            ; vlastn¡ obsluha INT 13H

                                               ;* instalace obsluhy INT 19h
324a  a16400         mov    ax,[0064]            ; INT 19H - LOW
324d  2ea30e1d       mov    cs:[1d0e],ax         ; p–vodn¡ adresa INT 19H - LOW
3251  a16600         mov    ax,[0066]            ; INT 19H - HIGH
3254  2ea3101d       mov    cs:[1d10],ax         ; p–vodn¡ adresa INT 19H - HIGH
3258  c7066400881d   mov    [0064],1d88          ; vlastn¡ obsluha INT 19H
325e  8c0e6600       mov    [0066],cs            ; vlastn¡ obsluha INT 19H
3262  fb             sti                         ; povolen¡ p©eru¨en¡

                                               ;* test, zda je disket. mechanika
3263  cd11           int    11                   ; ‡ten¡ tabulky vybaven¡
3265  a90100         test   ax,0001              ; je nˆjak  disket. mechanika ?
3268  750b           jnz    3275                 ; je disketov  mechanika
326a  2ec606233101   mov    cs:[3123],01         ; p©¡znak, ‘e nen¡ disket.mech.
3270  b80100         mov    ax,0001              ; po‡et logick˜ch disket. mechanik
3273  eb0f           jmp    3284

                                               ;* zji¨tˆn¡ po‡tu mechanik
3275  d0c0         * rol    al,1
3277  d0c0           rol    al,1                 ; po‡et disketov˜ch mechanik
3279  250300         and    ax,0003              ; po‡et disketov˜ch mechanik
327c  7506           jnz    3284                 ; jsou alespo¤ 2 disket. mech.
327e  40             inc    ax                   ; je 1 mechanika - je log. disk
327f  2efe06c401     inc    b/cs:[01c4]          ; p©¡znak, ‘e je logick˜ disk


3284  40           * inc    ax                   ; po‡et disketov˜ch mechanik
3285  8ac8           mov    cl,al                ; po‡et disketov˜ch mechanik
3287  f6c280         test   dl,80                ; je start z pevn‚ho disku ?
328a  7502           jnz    328e                 ; je pevn˜ disk
328c  33c0           xor    ax,ax                ; je disketov  mechanika A
328e  33d2         * xor    dx,dx                ; DX <- 0
3290  fa             cli                         ; z kaz p©eru¨en¡
3291  8ed2           mov    ss,dx                ; SS <- 0
3293  bc0007         mov    sp,0700              ; SP <- 700h (z sobn¡k)
3296  fb             sti                         ; povolen¡ p©eru¨en¡

3297  51             push   cx                   ; CL-po‡et disket. mechanik, CH-popisova‡ m‚dia
3298  8ae5           mov    ah,ch                ; popisova‡ m‚dia
329a  50             push   ax                   ; AL-po‡et disket. mechanik
                                                 ; AH-popisova‡ m‚dia

                                                 ; zde se zjist¡ model po‡¡ta‡e

329b  b4c0           mov    ah,c0                ; AH<-C0H funkce poskytnut¡ syst‚m. konfigurace
329d  cd15           int    15                   ; poskytnut¡ syst‚mov‚ konfigurace
329f  7217           jc     32b8                 ; funkce nepodporov na
32a1  80fc00         cmp    ah,00                ; kontroln¡ hodnota
32a4  7512           jnz    32b8                 ; funkce nepodporov na (je PC)
32a6  268a4702       mov    al,es:[bx+02]        ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
32aa  2ea20c1d       mov    cs:[1d0c],al         ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
32ae  268a4703       mov    al,es:[bx+03]        ; ‡¡slo submodelu po‡¡ta‡e
32b2  2ea20d1d       mov    cs:[1d0d],al         ; ‡¡slo submodelu po‡¡ta‡e
32b6  eb0d           jmp    32c5                 ; p©esko‡en¡ nastaven¡ modelu z ROM
32b8  beffff       * mov    si,ffff              ; segment FFFFH
32bb  8ec6           mov    es,si                ; ES <- FFFFh
32bd  26a00e00       mov    al,es:[000e]         ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
32c1  2ea20c1d       mov    cs:[1d0c],al         ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e

32c5  b020         * mov    al,20                ; k¢d pro ukon‡en¡ p©eru¨en¡
32c7  e620           out    [20],al              ; ukon‡en¡ p©eru¨en¡

                                                 ; zde se rozpozn  pou‘it˜ procesor
                                                 ; - pokud jsou bity 12 a‘ 15 p©¡znakov‚ho
                                                 ; registru napevno 1, jedn  se o 8086,186
                                                 ; - pokud jdou bity 12 a‘ 15 p©¡znakov‚ho
                                                 ; registru napevno 0, jedn  se o 80286
                                                 ; - pokud z–stanou bity nastaveny, je 80386

32c9  9c             pushf                       ; £schova registru p©¡znak–
32ca  53             push   bx                   ; £schova BX
32cb  33db           xor    bx,bx                ; BX <- 0000
32cd  33c0           xor    ax,ax                ; AX <- 0000 testovac¡ vzorek 1
32cf  50             push   ax                   ; AX = 0
32d0  9d             popf                        ; F<-0000
32d1  9c             pushf                       ; F do z sobn¡ku
32d2  58             pop    ax                   ; AX <- hodnota z F
32d3  2500f0         and    ax,f000              ; test bit– 12 a‘ 15
32d6  3d00f0         cmp    ax,f000              ; je procesor 86,186 ?
32d9  740e           jz     32e9                 ; zmˆnily se na 1 - je procesor 86 nebo 186
32db  b800f0         mov    ax,f000              ; AX <- F000h testovac¡ vzorek 2
32de  50             push   ax                   ; AX = F000h
32df  9d             popf                        ; F <- F000h
32e0  9c             pushf                       ; F do z sobn¡ku
32e1  58             pop    ax                   ; AX <- hodnota z F
32e2  2500f0         and    ax,f000              ; test bit– 12 a‘ 15
32e5  7401           jz     32e8                 ; zmˆnily se na 0 - je procesor 286
32e7  43             inc    bx                   ; je procesor 386
32e8  43           * inc    bx                   ; je procesor 286
32e9  8bc3         * mov    ax,bx                ; k¢d procesoru
32eb  5b             pop    bx                   ; n vrat BX
32ec  9d             popf                        ; n vrat F

                                                 ; pokud je ni‘¨¡ typ procesoru ne‘ 286,
                                                 ; nahrad¡ se instrukce MOVSD v podprogramu
                                                 ; pro p©enos sektoru instrukc¡ MOVSW

32ed  3d0200         cmp    ax,0002              ; je procesor 386 ?
32f0  740e           jz     3300                 ; je procesor 386
32f2  06             push   es                   ; £schova ES
32f3  0e             push   cs                   ; CS do z sobn¡ku
32f4  07             pop    es                   ; ES <- CS
32f5  bfeb1c         mov    di,1ceb              ; podprogram pro p©enos sektoru
32f8  b90300         mov    cx,0003              ; po‡et bajt– instrukc¡ ke zmˆnˆ
32fb  b090           mov    al,90                ; instrukce NOP
32fd  f3aa           rep    stosb                ; zru¨en¡ instrukce REP MOVSD
32ff  07             pop    es                   ; n vrat ES

                                                 ; provede se inicializace COM a LPT

3300  be3602       * mov    si,0236              ; z hlav¡ za©¡zen¡ COM4
3303  e84d09         call   3c53                 ; inicializace portu COM4
3306  be2402         mov    si,0224              ; z hlav¡ za©¡zen¡ COM3
3309  e84709         call   3c53                 ; inicializace portu COM3
330c  be1202         mov    si,0212              ; z hlav¡ za©¡zen¡ COM2
330f  e84109         call   3c53                 ; inicializace portu COM2
3312  beca01         mov    si,01ca              ; z hlav¡ za©¡zen¡ COM1
3315  e83b09         call   3c53                 ; inicializace portu COM1
3318  be0002         mov    si,0200              ; z hlav¡ za©¡zen¡ LPT3
331b  e82d09         call   3c4b                 ; inicializace portu LPT3
331e  beee01         mov    si,01ee              ; z hlav¡ za©¡zen¡ LPT2
3321  e82709         call   3c4b                 ; inicializace portu LPT2
3324  bedc01         mov    si,01dc              ; z hlav¡ za©¡zen¡ LPT1
3327  e82109         call   3c4b                 ; inicializace portu LPT1

                                                 ; ?

332a  33d2           xor    dx,dx                ; DX <- 0000
332c  8eda           mov    ds,dx                ; DS <- 0000
332e  8ec2           mov    es,dx                ; ES <- 0000
3330  33c0           xor    ax,ax                ; AX <- 0000
3332  bf3405         mov    di,0534
3335  ab             stosw                       ; 0534 <- 0000
3336  ab             stosw                       ; 0536 <- 0000

                                                 ; nastaven¡ vlastn¡ch adres obsluh
                                                 ; INT 1BH, 29H, 01H, 03H, 04H

3337  8cc8           mov    ax,cs                ; AX <- CS
3339  c7066c00f507   mov    [006c],07f5          ; nastaven¡ obsluhy INT 1BH (= ^C)
333f  a36e00         mov    [006e],ax            ; segment CS
3342  c706a4000b07   mov    [00a4],070b          ; nastaven¡ obsluhy INT 29H (tisk znaku na displej)
3348  a3a600         mov    [00a6],ax            ; segment CS
334b  bf0400         mov    di,0004              ; adresa INT 01H
334e  bbfb07         mov    bx,07fb              ; adresa obsluhy (instrukce IRET)
3351  93             xchg   ax,bx                ; £schova AX
3352  ab             stosw                       ; nastaven¡ offsetu obsluhy INT 01H
3353  93             xchg   ax,bx                ; AX=segment programu
3354  ab             stosw                       ; nastaven¡ segmentu obsluhy INT 01H
3355  83c704         add    di,0004              ; adresa INT 03H
3358  93             xchg   ax,bx                ; n vrat AX
3359  ab             stosw                       ; nastaven¡ offsetu obsluhy INT 03H
335a  93             xchg   ax,bx                ; AX=segment programu
335b  ab             stosw                       ; nastaven¡ segmentu obsluhy INT 03H
335c  93             xchg   ax,bx                ; £schova AX
335d  ab             stosw                       ; nastaven¡ offsetu obsluhy INT 04H
335e  93             xchg   ax,bx                ; AX=segment programu
335f  ab             stosw                       ; nastaven¡ segmentu obsluhy INT 04H

                                                 ; nastaven¡ syst‚mov˜ch parametr– BIOS

3360  89160005       mov    [0500],dx            ; 0500h <- 0000 (status <Print-Screen>)
3364  89160405       mov    [0504],dx            ; 0504h <- 0000 (logick˜ disk)
3368  a02c05         mov    al,[052c]            ; doba pro start motoru mechaniky
336b  2ea25b02       mov    cs:[025b],al         ; doba pro start motoru mechaniky
336f  2e803e0c1dfd   cmp    cs:[1d0c],fd         ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
3375  720b           jc     3382                 ; je novˆj¨¡ XT nebo AT
3377  c7062b050f02   mov    [052b],020f          ; nastaven¡ doby ust len¡ hlavy a startu motoru
337d  c6062205df     mov    [0522],df            ; nastaven¡ rychlosti krokov n¡ motoru

                                                 ; nastaven¡ ukazatel– pamˆti

3382  cd12         * int    12                   ; hl ¨en¡ o velikosti pamˆti
3384  b106           mov    cl,06                ; po‡et rotac¡
3386  d3e0           shl    ax,cl                ; AX*64=po‡et odstavc– pamˆti v syst‚mu
3388  59             pop    cx                   ; CH=popisova‡ m‚dia, CL-po‡et disket. mechanik
3389  2e890e0c31     mov    cs:[310c],cx         ; po‡et mechanik, popisova‡ m‚dia
338e  50             push   ax                   ; po‡et odstavc– pamˆti
338f  2d4000         sub    ax,0040              ; ode‡ten¡ bufferu 400H bajt–
3392  2ea31531       mov    cs:[3115],ax         ; segment pro na‡ten¡ tabulky FAT
3396  2d4000         sub    ax,0040              ; ode‡ten¡ prostoru bufferu 400H
3399  2ea31731       mov    cs:[3117],ax         ; segment pro na‡ten¡ dat z disku
339d  58             pop    ax                   ; po‡et odstavc– pamˆti
339e  ba5804         mov    dx,0458              ; segment
33a1  8eda           mov    ds,dx                ; DS <- 0458h
33a3  c706fd076e01   mov    [07fd],016e          ; 0458:07fd adresa z hlav¡ driver–
                                                 ; (odpov¡d  adrese 0070:467dh)
33a9  8c0eff07       mov    [07ff],cs            ; segment z hlav¡ driver–
33ad  a30f08         mov    [080f],ax            ; po‡et odstavc– pamˆti celkem
33b0  fec1           inc    cl                   ; po‡et mechanik + 1
33b2  880e1108       mov    [0811],cl            ; po‡et disketov˜ch mechanik + 1
33b6  b8773e         mov    ax,3e77              ; offset 2. ‡ sti IO.SYS
33b9  2d0000         sub    ax,0000              ; offset 1. ‡ sti IO.SYS
33bc  050f00         add    ax,000f              ; zaokrouhlen¡ d‚lky 1. ‡ sti IO.SYS
33bf  d1d8           rcr    ax,1
33c1  d1e8           shr    ax,1
33c3  d1e8           shr    ax,1
33c5  d1e8           shr    ax,1                 ; AX/16 = po‡et odstavc– 1. ‡ sti IO.SYS
33c7  050005         add    ax,0500              ; d‚lka 2. ‡ sti
33ca  057000         add    ax,0070              ; po‡ te‡n¡ segment 1. ‡ sti IO.SYS
33cd  a3f707         mov    [07f7],ax            ; segment za 2. ‡ st¡ IO.SYS

                                                 ; nastaven¡ vlastn¡ obsluhy INT 0FH

33d0  50             push   ax                   ; segment za 2. ‡ st¡ IO.SYS
33d1  b85804         mov    ax,0458              ; nov˜ segment 2. ‡ sti IO.SYS
33d4  8ec0           mov    es,ax                ; ES <- 0458h
33d6  33c0           xor    ax,ax                ; AX <- 0000h
33d8  8ed8           mov    ds,ax                ; DS <- 0000h
33da  a13e00         mov    ax,[003e]            ; segment INT 0FH
33dd  263b060f08     cmp    ax,es:[080f]         ; odstavec konce pamˆti RAM
33e2  7605           jna    33e9                 ; INT 0FH je v RAM (OK)
33e4  3d00f0         cmp    ax,f000              ; je v ROM ?
33e7  750a           jnz    33f3                 ; nen¡ - chyba (nep©esmˆruje se)
33e9  c7063c00fb07 * mov    [003c],07fb          ; vlastn¡ obsluha INT 0FH (p©eru¨en¡ od LPT1)
33ef  8c0e3e00       mov    [003e],cs            ; segment obsluhy INT 0FH
33f3  58           * pop    ax                   ; segment za 2. ‡ st¡ IO.SYS

                                                 ; nastaven¡ ‡¡sla funkce kl vesnice

33f4  33c9           xor    cx,cx                ; CX <- 0000
33f6  8ed9           mov    ds,cx                ; DS <- 0000
33f8  8a0e9604       mov    cl,[0496]            ; status kl vesnice
33fc  f6c110         test   cl,10                ; je kl vesnice 101/102 ?
33ff  740c           jz     340d                 ; nen¡ kl vesnice 101/102
3401  2ec6061c0610   mov    cs:[061c],10         ; k¢d pro ‡ten¡ znaku z kl vesnice
3407  2ec6061d0611   mov    cs:[061d],11         ; k¢d pro ‡ten¡ stavu kl vesnice

                                                 ; inicializace syst‚mov˜ch hodin

340d  0e           * push   cs
340e  1f             pop    ds                   ; DS <- CS
340f  0e             push   cs
3410  07             pop    es                   ; ES <- CS
3411  e8b809         call   3dcc                 ; inicializace syst‚mov˜ch hodin a data

                                                 ; inicializace tabulky adres BPB disk–

3414  33f6           xor    si,si                ; SI <- 0000
3416  c7046a20       mov    [si],206a            ; cs:[0000] <- 206ah
341a  58             pop    ax                   ; AH-popisova‡ m‚dia, AL-po‡et disket. mechanik
341b  32e4           xor    ah,ah                ; AH<-0
341d  a25a02         mov    [025a],al            ; po‡et disketov˜ch mechanik
3420  a2c001         mov    [01c0],al            ; celkov˜ po‡et disk–
3423  d1e0           shl    ax,1                 ; po‡et mechanik * 2
3425  bf4c1d         mov    di,1d4c              ; tabulka adres BPB disk–
3428  03f8           add    di,ax                ; adresa za posledn¡ disket. mechanikou
342a  be541d         mov    si,1d54              ; adresy tabulek BPB pevn˜ch disk–
342d  a5             movsw                       ; p©enos adresy pevn‚ho disku 1
342e  a5             movsw                       ; p©enos adresy pevn‚ho disku 2

                                                 ; inicializace tabulek disket. mechanik

342f  b280           mov    dl,80                ; ‡¡slo disku - 1. pevn˜ disk
3431  b408           mov    ah,08                ; funkce poskytnut¡ disk. parametr–
3433  cd13           int    13                   ; poskytnut¡ diskov˜ch parametr–
3435  7204           jc     343b                 ; chyba - nen¡ ‘ dn˜ pevn˜ disk
3437  88166920       mov    [2069],dl            ; po‡et pevn˜ch disk–
343b  32d2         * xor    dl,dl                ; DL <- 0
343d  0e             push   cs                   ; CS do z sobn¡ku
343e  1f             pop    ds                   ; DS <- CS
343f  c606600209     mov    [0260],09            ; max. po‡et sektor– na stopu
3444  bf4c02         mov    di,024c              ; tabulky disket. mechanik
3447  2e803e233101   cmp    cs:[3123],01         ; je nˆjak  disketov  mechanika ?
344d  750b           jnz    345a                 ; je disket. mechanika
344f  8b3d           mov    di,[di]              ; adresa 1. disket. mechaniky
3451  8b3d           mov    di,[di]              ; adresa 2. disket. mechaniky
3453  c705ffff       mov    [di],ffff            ; ozna‡en¡ posledn¡ho disku = 2. disk
3457  e90f01         jmp    3569                 ; konec inicializace disket
345a  3a16c001    ** cmp    dl,[01c0]            ; dosa‘eno posledn¡ disket. mechaniky ?
345e  7203           jc     3463                 ; ne - dal¨¡ mechanika
3460  e90101         jmp    3564                 ; byla posledn¡ mechanika - konec
3463  33c9         * xor    cx,cx                ; CX <- 0000h parametry log. disk–
3465  8b3d           mov    di,[di]              ; adresa n sleduj¡c¡ disk. jednotky
3467  b600           mov    dh,00                ; typ disku = 0 (standardn¡ DD)
3469  c606223128     mov    [3122],28            ; po‡et stop disku = 40
346e  1e             push   ds                   ; £schova DS
346f  57             push   di                   ; adresa tabulky n sleduj¡c¡ diskov‚ jednotky
3470  52             push   dx                   ; DL=‡¡slo disku, DH=typ disku
3471  51             push   cx                   ; CX=0
3472  06             push   es                   ; £schova ES
3473  b408           mov    ah,08                ; funkce poskytnut¡ disk. parametr–
3475  cd13           int    13                   ; poskytnut¡ diskov˜ch parametr–
3477  7303           jnc    347c                 ; funkce OK
3479  eb70           jmp    34eb                 ; chyba - nen¡ disket. mechanika
347b  90             nop
347c  80fd00       * cmp    ch,00                ; maxim ln¡ hodnota pro v lce
347f  7506           jnz    3487                 ; je nˆjak‚ ‡¡slo - funkce je podporov na
3481  b527           mov    ch,27                ; max. ‡¡slo v lce = 39  disketa 180 KB
3483  b109           mov    cl,09                ; max. ‡¡slo sektoru = 9
3485  b601           mov    dh,01                ; max. ‡¡slo hlavy = 1
3487  fec6         * inc    dh                   ; po‡et hlav
3489  fec5           inc    ch                   ; po‡et stop
348b  88362031       mov    [3120],dh            ; po‡et hlav
348f  80e13f         and    cl,3f                ; po‡et sektor– na stopu
3492  880e2131       mov    [3121],cl            ; po‡et sektor– na stopu
3496  882e2231       mov    [3122],ch            ; po‡et stop na disku celkem
349a  3a0e6002       cmp    cl,[0260]            ; kontrola dosud max. po‡tu sektor–
349e  7604           jna    34a4                 ; nen¡ vˆt¨¡ - d le
34a0  880e6002       mov    [0260],cl            ; nov  hodnota max. po‡tu sektor– na stopu
34a4  07           * pop    es                   ; n vrat ES
34a5  59             pop    cx                   ; n vrat CX
34a6  5a             pop    dx                   ; n vrat DX
34a7  5f             pop    di                   ; n vrat DI
34a8  1f             pop    ds                   ; n vrat DS
34a9  b415           mov    ah,15                ; funkce ‡ten¡ typu DASD
34ab  cd13           int    13                   ; ‡ten¡ typu DASD
34ad  720d           jc     34bc                 ; chyba
34af  80fc02         cmp    ah,02                ; je disketa, mo‘n  indikace v˜mˆny ?
34b2  7508           jnz    34bc                 ; nen¡ mo‘n  indikace v˜mˆny
34b4  80c902         or     cl,02                ; 0002=p©¡znak mo‘n‚ indikace v˜mˆny
34b7  c606c30101     mov    [01c3],01            ; p©¡znak - je mo‘n  indikace v˜mˆny
34bc  803e223128   * cmp    [3122],28            ; po‡et stop = 40 ?
34c1  750b           jnz    34ce                 ; nen¡ disketa 40 stop
34c3  803e213109     cmp    [3121],09            ; po‡et sektor– = 9 ?
34c8  761f           jna    34e9                 ; nen¡ vˆt¨¡ po‡et sektor–
34ca  b607         * mov    dh,07                ; nezn m˜ typ diskety
34cc  eb1b           jmp    34e9                 ; pokra‡ov n¡
34ce  803e223150   * cmp    [3122],50            ; po‡et stop = 80 ?
34d3  75f5           jnz    34ca                 ; nen¡ po‡et stop 80 - nezn m˜ typ
34d5  803e21310f     cmp    [3121],0f            ; je po‡et sektor– = 15 ?
34da  740b           jz     34e7                 ; je disketa HD 1.2MB
34dc  803e213109     cmp    [3121],09            ; po‡et sektor– = 9 ?
34e1  75e7           jnz    34ca                 ; nen¡ - nezn m˜ typ diskety
34e3  b602           mov    dh,02                ; je disketa 720 KB
34e5  eb02           jmp    34e9                 ; pokra‡ov n¡
34e7  b601         * mov    dh,01                ; disketa HD 1.2 MB
34e9  eb2a         * jmp    3515
34eb  07           * pop    es                   ; chyba - nen¡ disket. mechanika
34ec  59             pop    cx
34ed  5a             pop    dx
34ee  5f             pop    di
34ef  1f             pop    ds
34f0  b415           mov    ah,15                ; funkce ‡ten¡ typu DASD
34f2  cd13           int    13                   ; ‡ten¡ typu DASD
34f4  721f           jc     3515                 ; chyba
34f6  80fc02         cmp    ah,02                ; je disketa s indikac¡ v˜mˆny ?
34f9  751a           jnz    3515                 ; nen¡ - pokra‡ov n¡
34fb  80c902         or     cl,02                ; 02=p©¡znak mo‘n‚ indikace v˜mˆny
34fe  c606c30101     mov    [01c3],01            ; p©¡znak, ‘e je mo‘n  indikace v˜mˆny
3503  c606223150     mov    [3122],50            ; po‡et stop = 80
3508  b601           mov    dh,01                ; disketa HD 1.2 MB
350a  b00f           mov    al,0f                ; po‡et sektor– na stopu = 15
350c  3a066002       cmp    al,[0260]            ; je vˆt¨¡ ne‘ nalezen˜ max. po‡et sektor– ?
3510  7603           jna    3515                 ; nen¡ vˆt¨¡
3512  a26002         mov    [0260],al            ; nastaven¡ nov‚ho max. po‡tu sektor– na stopu
3515  80c920       * or     cl,20                ; p©¡znak - nen¡ log. disk
3518  8afa           mov    bh,dl                ; ‡¡slo disku
351a  803ec40102     cmp    [01c4],02            ; p©¡znak - je nˆjak˜ logick˜ disk ?
351f  7505           jnz    3526                 ; nen¡ logick˜ disk
3521  fecf           dec    bh                   ; ‡¡slo disku - 1 (fyzick˜ disk)
3523  80f120         xor    cl,20                ; 20h=nen¡ logick˜ disk,02=mo‘n  indikace v˜mˆny
3526  33c0         * xor    ax,ax                ; AX <- 0
3528  a02031         mov    al,[3120]            ; po‡et hlav disku
352b  894536         mov    [di+36],ax           ; po‡et hlav
352e  a02131         mov    al,[3121]            ; po‡et sektor– na stopu
3531  894534         mov    [di+34],ax           ; po‡et sektor– na stopu
3534  894d23         mov    [di+23],cx           ; 20h=nen¡ logick˜ disk,02=mo‘n  indikace v˜mˆny
3537  887522         mov    [di+22],dh           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
353a  885505         mov    [di+05],dl           ; ‡¡slo log. disku
353d  887d04         mov    [di+04],bh           ; fyzick˜ disk
3540  8a1e2231       mov    bl,[3122]            ; po‡et stop disku
3544  885d25         mov    [di+25],bl           ; celkov˜ po‡et v lc– na disku
3547  803ec40101     cmp    [01c4],01            ; p©¡znak - je log. disk ?
354c  7511           jnz    355f                 ; nen¡ logick˜ disk
354e  c606c40102     mov    [01c4],02            ; p©¡znak - log. disk
3553  83c910         or     cx,10h
3556  094d23         or     [di+23h],cx          ; 20h=nen¡ logick˜ disk,02=mo‘n  indikace v˜mˆny
3559  8b3d           mov    di,[di]              ; adresa n sleduj¡c¡ tabulky disk–
355b  fec2           inc    dl                   ; zv˜¨en¡ ‡¡sla disku
355d  ebb6           jmp    3515                 ; nastaven¡ dal¨¡ho log. disku
355f  fec2         * inc    dl                   ; zv˜¨en¡ fyzick‚ho disku
3561  e9f6fe         jmp    345a                 ; dal¨¡ fyzick˜ disk
3564  b8ffff       * mov    ax,ffff              ; koncov‚ ozna‡en¡ tabulek disk–
3567  8905           mov    [di],ax              ; ozna‡en¡ konce tabulky disk–

þ
3569  803e692000   * cmp    [2069],00            ; po‡et pevn˜ch disk–
356e  7e4f           jng    35bf                 ; je=0
                                                 ; inicializace pevn‚ho disku 1
3570  b280           mov    dl,80                ; ‡¡slo pevn‚ho disku 1
3572  bf6c20         mov    di,206c              ; tabulka parametr– pevn‚ho disku 1
3575  8a1e5a02       mov    bl,[025a]            ; po‡et diskov˜ch mechanik
3579  e82202         call   379e                 ; inicializace tabulky pevn‚ho disku 1
357c  730d           jnc    358b                 ; operace probˆhla OK
357e  fe0e6920       dec    b/[2069]             ; sn¡‘en¡ po‡tu pevn˜ch disk– (chyba - disk nelze pou‘¡t)
3582  803e692000     cmp    [2069],00            ; je je¨tˆ nˆjak˜ pevn˜ disk ?
3587  7f15           jg     359e                 ; jsou je¨tˆ dal¨¡ disky - disk 2
3589  eb34           jmp    35bf                 ; konec inicializac¡ pevn‚ho disku
358b  e8d9e9         call   1f67                 ; nastaven¡ posledn¡ho disku
358e  803e692002     cmp    [2069],02            ; po‡et pevn˜ch disk–
3593  7219           jc     35ae                 ; je jenom 1 pevn˜ disk
3595  8a1e5a02       mov    bl,[025a]            ; po‡et diskov˜ch mechanik celkem
3599  fec3           inc    bl                   ; zv˜¨en¡ ‡¡ta‡e diskov˜ch mechanik
359b  bfd020         mov    di,20d0              ; tabulka parametr– pevn‚ho disku 2
                                                 ; inicializace pevn‚ho disku 2
359e  b281         * mov    dl,81                ; ‡¡slo pevn‚ho disku 2
35a0  e8fb01         call   379e                 ; inicializace tabulky pevn‚ho disku 2
35a3  7306           jnc    35ab                 ; inicializace probˆhla OK
35a5  fe0e6920       dec    b/[2069]             ; sn¡‘en¡ po‡tu pevn˜ch disk– (chyba - disk nelze pou‘¡t)
35a9  eb03           jmp    35ae                 ; konec inicializace pevn˜ch disk–
35ab  e8b9e9       * call   1f67                 ; nastaven¡ posledn¡ho disku
35ae  a06920       * mov    al,[2069]            ; po‡et pevn˜ch disk–
35b1  0ac0           or     al,al                ; jsou nˆjak‚ pevn‚ disky ?
35b3  740a           jz     35bf                 ; nejsou ‘ dn‚ pevn‚ disky
35b5  02065a02       add    al,[025a]            ; p©i‡ten¡ disketov˜ch mechanik
35b9  a2c001         mov    [01c0],al            ; celkov˜ po‡et disk–
35bc  e8ca06         call   3c89                 ; inicializace tabulek odd¡l– pevn˜ch disk–
35bf  50           * push   ax                   ; £schova AX
35c0  b81824         mov    ax,2418              ; konec ‡ sti 1 IO.SYS (tabulka logick˜ch disk–)
35c3  803ec30100     cmp    [01c3],00            ; je mo‘n  indikace v˜mˆny ?
35c8  751b           jnz    35e5                 ; je mo‘n  indikace v˜mˆny
35ca  b83421         mov    ax,2134              ; konec ‡ sti 1 IO.SYS (funkce otev©en¡ za©¡zen¡)
35cd  803e692001     cmp    [2069],01            ; po‡et pevn˜ch disk– = 1 ?
35d2  7603           jna    35d7                 ; nen¡ vˆt¨¡ po‡et pevn˜ch disk–
35d4  eb2f           jmp    3605                 ; je vˆt¨¡ po‡et pevn˜ch disk– ne‘ 1
35d6  90             nop
35d7  b8d020       * mov    ax,20d0              ; konec ‡ sti 1 IO.SYS (tabulka parametr– pevn‚ho disku 2)
35da  7503           jnz    35df                 ; nen¡ ‘ dn˜ pevn˜ disk
35dc  eb27           jmp    3605                 ; je 1 pevn˜ disk
35de  90             nop
35df  b86920       * mov    ax,2069              ; konec ‡ sti 1 IO.SYS (adresa po‡tu pevn˜ch disk–)
35e2  eb31           jmp    3615
35e4  90             nop
                                                 ; zde je mo‘n  indikace v˜mˆny disku (disk je v˜mˆnn˜)
                                                 ; - nastav¡ se obsluha INT 13h, kter 
                                                 ;   bude hl¡dat, zda do¨lo k v˜mˆnˆ m‚dia
35e5  50             push   ax                   ; £schova AX
35e6  1e             push   ds                   ; £schova DS
35e7  33c0           xor    ax,ax                ; AX <- 0000
35e9  8ed8           mov    ds,ax                ; DS <- 0000
35eb  a14c00         mov    ax,[004c]            ; INT 13h - offset
35ee  2ea37e22       mov    cs:[227e],ax         ; £schova adresy INT 13h
35f2  a14e00         mov    ax,[004e]            ; INT 13h - segment
35f5  2ea38022       mov    cs:[2280],ax         ; £schova adresy INT 13h
35f9  c7064c008822   mov    [004c],2288          ; adresa obsluhy INT 13h
35ff  8c0e4e00       mov    [004e],cs            ; segment adresy obsluhy INT 13h
3603  1f             pop    ds                   ; n vrat DS
3604  58             pop    ax                   ; n vrat AX

3605  50           * push   ax                   ; £schova AX
3606  a05a02         mov    al,[025a]            ; po‡et disketov˜ch mechanik
3609  02066920       add    al,[2069]            ; + po‡et pevn˜ch disk–
360d  02069631       add    al,[3196]            ; + po‡et odd¡l– na pevn‚m disku
3611  a2c001         mov    [01c0],al            ; celkov˜ po‡et disk–
3614  58             pop    ax                   ; n vrat AX

3615  e85201       * call   376a                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec
3618  0e             push   cs
3619  07             pop    es                   ; ES <- CS
361a  fc             cld                         ; smˆr p©enosu dol–
361b  803e963100     cmp    [3196],00            ; po‡et odd¡l– na pevn‚m disku = 0 ?
3620  7406           jz     3628                 ; nejsou ‘ dn‚ odd¡ly na pevn‚m disku
3622  a19231         mov    ax,[3192]            ; adresa n sleduj¡c¡ nepou‘it‚ tabulky disku
3625  e84201         call   376a                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec
3628  803e0c1dfc   * cmp    [1d0c],fc            ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
362d  7535           jnz    3664                 ; nen¡ ozna‡en typ po‡¡ta‡e
362f  803e692000     cmp    [2069],00            ; po‡et pevn˜ch disk–
3634  742e           jz     3664                 ; nen¡ ‘ dn˜ pevn˜ disk
3636  be00f0         mov    si,f000              ; segment ROM
3639  8ec6           mov    es,si                ; segment ROM
363b  be9e31         mov    si,319e              ; datum 10.1.84
363e  bff5ff         mov    di,fff5              ; ozna‡en¡ syst‚mu BIOS
3641  a6             cmpsb                       ; je datum BIOS 10.1.84 ?
3642  7520           jnz    3664                 ; nen¡ BIOS 10.1.84
3644  807cff00       cmp    [si-01],00
3648  75f7           jnz    3641
                                                 ; instalace dopl¤ku driveru pro BIOS 10.1.84
364a  0e             push   cs
364b  07             pop    es                   ; ES <- CS
364c  a3b400         mov    [00b4],ax            ; vlastn¡ adresa INT 13H - LOW
364f  8c0eb600       mov    [00b6],cs            ; vlastn¡ adresa INT 13H - HIGH
3653  b9522e         mov    cx,2e52              ; konec obslu‘n‚ ‡ sti INT 13h
3656  be242d         mov    si,2d24              ; adresa obsluhy INT 13h
3659  2bce           sub    cx,si                ; d‚lka obslu‘n‚ ‡ sti INT 13h
365b  8bf8           mov    di,ax                ; c¡lov  adresa pro obsluhu INT 13h
365d  f3a4           rep    movsb                ; p©enos programu obsluhy INT 13h
365f  8bc7           mov    ax,di                ; nov  adresa konce ‡ sti 1 IO.SYS
3661  e80601         call   376a                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec

3664  0e           * push   cs
3665  07             pop    es                   ; ES <- CS
3666  803e5a0901     cmp    [095a],01            ; syst‚mov‚ hodiny bˆ‘¡ ?
366b  7528           jnz    3695                 ; hodiny nebˆ‘¡
366d  a36b09         mov    [096b],ax            ; konec 1. ‡ sti IO.SYS
3670  b9242f         mov    cx,2f24              ; konec modulu pro obsluhu hodin
3673  be522e         mov    si,2e52              ; za‡ tek modulu pro obsluhu hodin
3676  2bce           sub    cx,si                ; d‚lka modulu pro obsluhu hodin
3678  8bf8           mov    di,ax                ; ukl dac¡ adresa (konec IO.SYS)
367a  f3a4           rep    movsb                ; p©enos obsluhy hodin
367c  8bc7           mov    ax,di                ; nov  c¡lov  adresa (za 1. ‡ st¡ IO.SYS)
367e  e8e900         call   376a                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec
3681  a36909         mov    [0969],ax            ; adresa obsluhy hodin

3684  b9332f         mov    cx,2f33              ; konec modulu pro p©evod dekadick‚ ‡¡slice na BCD
3687  be242f         mov    si,2f24              ; modul pro p©evod dekadick‚ ‡¡slice na BCD
368a  2bce           sub    cx,si                ; d‚lka modulu pro p©evod dekadick‚ ‡¡slice na BCD
368c  8bf8           mov    di,ax                ; ukl dac¡ adresa modulu
368e  f3a4           rep    movsb                ; p©enos modulu pro p©evod dekadick‚ ‡¡slice na BCD
3690  8bc7           mov    ax,di                ; nov  ukl dac¡ adresa
3692  e8d500         call   376a                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec
3695  50           * push   ax                   ; nov  adresa konce IO.SYS
3696  b80041         mov    ax,4100              ; funkce ‡ek n¡ na vnˆj¨¡ ud lost
3699  b300           mov    bl,00                ; nen¡ ‘ dn˜ TIME-OUT
369b  cd15           int    15                   ; ‡ek n¡ na vnˆj¨¡ ud lost
369d  58             pop    ax                   ; nov  adresa konce IO.SYS
369e  7228           jc     36c8                 ; nenastala vnˆj¨¡ ud lost - nen¡ konvertabiln¡ PC
                                                 ; ponech  se program pro inicializaci hodin
36a0  be342f         mov    si,2f34              ; inicializace syst‚mov‚ho data a ‡asu
36a3  b90c31         mov    cx,310c              ; konec modulu inicializace syst‚mov‚ho data a ‡asu
36a6  2bce           sub    cx,si                ; d‚lka modulu
36a8  8bf8           mov    di,ax                ; ukl dac¡ adresa
36aa  57             push   di                   ; £schova DI
36ab  f3a4           rep    movsb                ; p©enos modulu inicializace hodin
36ad  8bc7           mov    ax,di                ; nov  adresa konce modulu IO.SYS
36af  e8b800         call   376a                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec
36b2  5f             pop    di                   ; n vrat DI
36b3  50             push   ax                   ; £schova AX
36b4  1e             push   ds                   ; £schova DS
36b5  c606c50101     mov    [01c5],01            ; p©¡znak - prov d¡ se inicializace hodin konvert. PC
36ba  33c0           xor    ax,ax                ; AX <- 0000
36bc  8ed8           mov    ds,ax                ; DS <- 0000
36be  893eb001       mov    [01b0],di            ; INT 6CH (pokra‡ov n¡ syst‚mu konvertabiln¡ PC)
36c2  8c0eb201       mov    [01b2],cs            ; segment INT 6CH
36c6  1f             pop    ds                   ; n vrat DS
36c7  58             pop    ax                   ; n vrat AX

36c8  ba5804       * mov    dx,0458              ; adresa sou‡asn‚ho segmentu druh‚ ‡ sti programu
36cb  8eda           mov    ds,dx                ; DS = segment 0458h
36cd  2d0000         sub    ax,0000              ; ode‡ten¡ po‡ te‡n¡ho offsetu ‡ sti 1 IO.SYS
36d0  050f00         add    ax,000f              ; zaokrouhlen¡ na vy¨¨¡ odstavec
36d3  d1d8           rcr    ax,1                 ; AX / 2
36d5  d1e8           shr    ax,1                 ; AX / 4
36d7  d1e8           shr    ax,1                 ; AX / 8
36d9  d1e8           shr    ax,1                 ; AX / 16 - po‡et odstavc– 1. ‡ sti IO.SYS
36db  a3fb07         mov    [07fb],ax            ; d‚lka 1. ‡ sti IO.SYS v odstavc¡ch
36de  58             pop    ax                   ; po‡et pevn˜ch disk–
36df  8106fb077000   add    [07fb],0070          ; + segmentu 1. ‡ sti -> segment 2. ‡ sti po p©esunu
36e5  0e             push   cs
36e6  1f             pop    ds                   ; DS <- CS
36e7  803ec30100     cmp    [01c3],00            ; 1=p©¡znak, ‘e je mo‘n  indikace v˜mˆny
36ec  7503           jnz    36f1                 ; je mo‘n  indikace v˜mˆny diskety
þ36ee  e87605         call   3c67                 ; vynulov n¡ ‡ st¡ programu indikace v˜mˆny m‚dia
36f1  a10c31       * mov    ax,[310c]            ; po‡et disketov˜ch mechanik
36f4  e802d7         call   0df9                 ; nalezen¡ disku v tabulce
36f7  e8cfd4         call   0bc9                 ; aktualizace parametr– diskety, pokud byla vymˆnˆna
36fa  33ff           xor    di,di                ; DI <- 0000 (tabulka FAT)
36fc  268a05         mov    al,es:[di]           ; popisova‡ m‚dia
36ff  a20d31         mov    [310d],al            ; popisova‡ m‚dia
3702  a10c31         mov    ax,[310c]            ; po‡et disketov˜ch mechanik
3705  e8f1d6         call   0df9                 ; nalezen¡ disku v tabulce
3708  8b5d06         mov    bx,[di+06]           ; po‡et bajt– na sektor
370b  2e891e1a31     mov    cs:[311a],bx         ; po‡et bajt– na sektor
3710  8a5d1f         mov    bl,[di+1f]           ; typ FAT (40h=FAT16)
3713  881e1431       mov    [3114],bl            ; typ FAT
3717  8a4d08         mov    cl,[di+08]           ; po‡et sektor– na aloka‡n¡ blok
371a  8b4517         mov    ax,[di+17]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
371d  29060e31       sub    [310e],ax            ; sektor za IO.SYS (LOW)
3721  8b4519         mov    ax,[di+19]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
3724  19061031       sbb    [3110],ax            ; relativn¡ sektor (HIGH)
3728  32ed           xor    ch,ch                ; CH <- 00
372a  1e             push   ds                   ; £schova DS
372b  33ff           xor    di,di                ; DI <- 0000
372d  8edf           mov    ds,di                ; DS <- 0000
372f  8b1e3a05       mov    bx,[053a]            ; ???
3733  1f             pop    ds                   ; n vrat DS
3734  b8773e       * mov    ax,3e77              ; AX <- 3e77h offset 2. ‡ sti IO.SYS
3737  2d0000         sub    ax,0000              ; - offset 1. ‡ sti IO.SYS
373a  050f00         add    ax,000f              ; zaokrouhlen¡ na odstavec
373d  d1d8           rcr    ax,1                 ; AX / 2
373f  d1e8           shr    ax,1                 ; AX / 4
3741  d1e8           shr    ax,1                 ; AX / 8
3743  d1e8           shr    ax,1                 ; AX / 16 - po‡et odstavc– 1. ‡ sti IO.SYS
3745  050005         add    ax,0500
3748  057000         add    ax,0070              ; + segment 1. ‡ sti IO.SYS
374b  8ec0           mov    es,ax                ; c¡lov  adresa
þ374d  e81c04         call   3b6c                 ; na‡ten¡ bloku z disku
3750  f606143140     test   [3114],40            ; je FAT16 ?
3755  7506           jnz    375d                 ; je FAT16
3757  81fbf70f       cmp    bx,0ff7
375b  eb03           jmp    3760
375d  83fbf7       * cmp    bx,fff7
3760  72d2         * jc     3734
3762  e85a03         call   3abf
3765  eaf2075804     jmp    0458:07f2            ; skok do 2. ‡ sti IO.SYS

                                                 ; zaokrouhlen¡ AX na vy¨¨¡ odstavec
376a  050f00       * add    ax,000f              ; zaokrouhlen¡ na odstavec
376d  d1d8           rcr    ax,1                 ; = AX / 2
376f  d1e8           shr    ax,1                 ; = AX / 4
3771  d1e8           shr    ax,1                 ; = AX / 8
3773  d1e8           shr    ax,1                 ; = AX / 16
3775  d1e0           shl    ax,1                 ; = AX * 8
3777  d1e0           shl    ax,1                 ; = AX * 4
3779  d1e0           shl    ax,1                 ; = AX * 2
377b  d1e0           shl    ax,1                 ; = AX
377d  c3             ret

                                                 ; na‡ten¡ zav dˆc¡ho sektoru
377e  2ea11731       mov    ax,cs:[3117]         ; segment pro na‡ten¡ zav dˆc¡ho sektoru
3782  8ec0           mov    es,ax                ; segment pro na‡ten¡ zav dˆc¡ho sektoru
3784  bb0002         mov    bx,0200              ; ukl dac¡ adresa pro na‡ten¡ sektoru
3787  b80102         mov    ax,0201              ; funkce na‡ten¡ 1 sektoru z disku
378a  32f6           xor    dh,dh                ; hlava 0
378c  b90100         mov    cx,0001              ; v lec 0, sektor 1
378f  cd13           int    13                   ; na‡ten¡ zav dˆc¡ho sektoru
3791  7209           jc     379c                 ; chyba zaveden¡ sektoru
3793  26813efe0355aa cmp    es:[03fe],aa55       ; je zav dˆc¡ sektor ?
379a  7401           jz     379d                 ; je - OK
379c  f9             stc                         ; nen¡ - chyba
379d  c3             ret

                                                 ; inicializace tabulky pevn‚ho disku
                                                 ; VSTUP: DL=‡¡slo pevn‚ho disku
                                                 ;        DI=tabulka parametr– pevn‚ho disku
                                                 ;        BL=‡¡slo posledn¡ disket. mechaniky
379e  57             push   di
379f  53             push   bx
37a0  1e             push   ds
37a1  885d05         mov    [di+05],bl           ; logick˜ disk (‡¡slo posledn¡ disket. mechaniky)
37a4  885504         mov    [di+04],dl           ; fyzick˜ disk
37a7  33c0           xor    ax,ax
37a9  0c01           or     al,01                ; 01=p©¡znak - je pevn˜ disk
37ab  094523         or     [di+23],ax           ; nastaven¡ p©¡znaku disku
37ae  c6452205       mov    [di+22],05           ; typ disku (1=1.2M, 2=720K, 5=pevn˜ disk, 7=nezn m˜)
37b2  c606143100     mov    [3114],00            ; p©¡znak p©ete‡en¡ po‡tu sektor–
37b7  52             push   dx                   ; DL=‡¡slo pevn‚ho disku
37b8  b408           mov    ah,08                ; funkce poskytnut¡ diskov˜ch parametr–
37ba  cd13           int    13                   ; poskutnut¡ diskov˜ch parametr–
37bc  fec6           inc    dh                   ; maxim ln¡ ‡¡slo hlavy
37be  887515         mov    [di+15],dh           ; po‡et hlav pevn‚ho disku
37c1  5a             pop    dx                   ; DL=¡slo pevn‚ho disku
37c2  7229           jc     37ed                 ; chyba - nezn m˜ pevn˜ disk
37c4  80e13f         and    cl,3f                ; po‡et sektor– na stopu
37c7  884d13         mov    [di+13],cl           ; po‡et sektor– na stopu
37ca  e8b1ff         call   377e                 ; na‡ten¡ zav dˆc¡ho sektoru pevn‚ho disku
37cd  721e           jc     37ed                 ; sektor nenalezen nebo nespr vn˜
37cf  bbc203         mov    bx,03c2              ; typ FAT 1.odd¡lu pevn‚ho disku

37d2  26803f01     * cmp    es:[bx],01           ; je FAT12 ?
37d6  7419           jz     37f1                 ; je FAT12
37d8  26803f04       cmp    es:[bx],04           ; je FAT16 ?
37dc  7413           jz     37f1                 ; je FAT16
37de  26803f06       cmp    es:[bx],06           ; je FATxx ?
37e2  740d           jz     37f1                 ; je FATxx
37e4  83c310         add    bx,0010              ; dal¨¡ odd¡l
37e7  81fb0204       cmp    bx,0402              ; byl to ji‘ posledn¡ odd¡l ?
37eb  75e5           jnz    37d2                 ; nen¡ - dal¨¡ odd¡l pevn‚ho disku
37ed  f9           * stc                         ; p©¡znak chyby - neplatn˜ odd¡l disku
37ee  e98d02         jmp    3a7e                 ; nenalezen platn˜ odd¡l disku
37f1  2e88161931     mov    cs:[3119],dl         ; £schova ‡¡sla pevn‚ho disku
37f6  268b4704       mov    ax,es:[bx+04]        ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
37fa  268b5706       mov    dx,es:[bx+06]        ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
37fe  2d0100         sub    ax,0001              ; po‡et sektor– p©ed odd¡lem - LOW
3801  83da00         sbb    dx,0000              ; po‡et sektor– p©ed odd¡lem - HIGH
3804  26034708       add    ax,es:[bx+08]        ; + d‚lka = konec odd¡lu - LOW
3808  2613570a       adc    dx,es:[bx+0a]        ; + d‚lka = konec odd¡lu - HIGH
380c  7305           jnc    3813                 ; nen¡ p©ete‡en¡ po‡tu sektor–
380e  800e143180     or     [3114],80            ; p©ete‡en¡ po‡tu sektor– disku
3813  268b4704     * mov    ax,es:[bx+04]        ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
3817  894517         mov    [di+17],ax           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
381a  268b4706       mov    ax,es:[bx+06]        ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
381e  894519         mov    [di+19],ax           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
3821  268b570a       mov    dx,es:[bx+0a]        ; d‚lka odd¡lu v sektorech - HIGH
3825  268b4708       mov    ax,es:[bx+08]        ; d‚lka odd¡lu v sektorech - LOW
3829  89551d         mov    [di+1d],dx           ; celkov˜ po‡et sektor– odd¡lu - HIGH
382c  89451b         mov    [di+1b],ax           ; celkov˜ po‡et sektor– odd¡lu - LOW
382f  83fa00         cmp    dx,0000              ; je po‡et sektor– > FFFFh ?
3832  7705           ja     3839                 ; je vˆt¨¡ (mus¡ se zadat 2-slovnˆ)
3834  3d4000         cmp    ax,0040              ; je po‡et sektor– < 64 ?
3837  72b4           jc     37ed                 ; je men¨¡ - neplatn˜ odd¡l pevn‚ho disku
3839  8b5519       * mov    dx,[di+19]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
383c  8b4517         mov    ax,[di+17]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
383f  33db           xor    bx,bx                ; BX <- 0000
3841  8a5d13         mov    bl,[di+13]           ; po‡et sektor– na stopu
3844  50             push   ax                   ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
3845  8bc2           mov    ax,dx                ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
3847  33d2           xor    dx,dx                ; DX <- 0000
3849  f7f3           div    bx                   ; /po‡et sektor– -> ‡¡slo po‡ te‡n¡ stopy - HIGH
384b  2ea3890a       mov    cs:[0a89],ax         ; ‡¡slo po‡ te‡n¡ stopy odd¡lu - HIGH
384f  58             pop    ax                   ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
3850  f7f3           div    bx                   ; /po‡et sektor– -> ‡¡slo po‡ te‡n¡ stopy - LOW
3852  8aca           mov    cl,dl                ; ‡¡slo po‡ te‡n¡ho sektoru odd¡lu - 1
3854  fec1           inc    cl                   ; ‡¡slo po‡ te‡n¡ho sektoru odd¡lu
3856  33db           xor    bx,bx                ; BX <- 0000
3858  8a5d15         mov    bl,[di+15]           ; po‡et stran m‚dia
385b  50             push   ax                   ; ‡¡slo po‡ te‡n¡ stopy odd¡lu - LOW
385c  33d2           xor    dx,dx                ; DX <- 0000
385e  2ea1890a       mov    ax,cs:[0a89]         ; ‡¡slo po‡ te‡n¡ stopy odd¡lu - HIGH
3862  f7f3           div    bx                   ; /po‡et stran -> po‡ te‡n¡ v lec odd¡lu - HIGH
3864  2ea3890a       mov    cs:[0a89],ax         ; ‡¡slo po‡ te‡n¡ho v lce odd¡lu - HIGH
3868  58             pop    ax                   ; ‡¡slo po‡ te‡n¡ stopy odd¡lu - LOW
3869  f7f3           div    bx                   ; /po‡et stran -> po‡ te‡n¡ v lec odd¡lu - LOW
386b  2e833e890a00   cmp    cs:[0a89],0000       ; ‡¡slo po‡ te‡n¡ho v lce odd¡lu - HIGH = 0000 ?
3871  7775           ja     38e8                 ; je nˆjak  hodnota ‡¡sla v lce HIGH - chyba
3873  3d0004         cmp    ax,0400              ; ‡¡slo po‡ te‡n¡ho v lce odd¡lu je < 1024 ?
3876  7770           ja     38e8                 ; ‡¡slo po‡ te‡n¡ho v lce je > 1024 - chyba
3878  837d4701       cmp    [di+47],0001         ; ‡as posledn¡ operace s diskem - LOW
387c  7503           jnz    3881
387e  034549         add    ax,[di+49]
3881  d0cc         * ror    ah,1
3883  d0cc           ror    ah,1                 ; nejvy¨¨¡ 2 bity ‡¡sla v lce
3885  80e4c0         and    ah,c0                ; nejvy¨¨¡ 2 bity ‡¡sla v lce
3888  0acc           or     cl,ah                ; ‡¡slo sektoru + nejvy¨¨¡ 2 bity ‡¡sla v lce
388a  8ae8           mov    ch,al                ; ‡¡slo v lce-ni‘¨¡ch 8 bit–
388c  8af2           mov    dh,dl                ; ‡¡slo hlavy
388e  2e8a161931     mov    dl,cs:[3119]         ; ‡¡slo disku
3893  0e             push   cs
3894  07             pop    es                   ; ES <- CS
3895  bb8402         mov    bx,0284              ; adresa bufferu pro na‡ten¡ sektoru
3898  b80102         mov    ax,0201              ; funkce na‡ten¡ 1 sektoru
389b  cd13           int    13                   ; na‡ten¡ sektoru do pamˆti
389d  bb8402         mov    bx,0284              ; buffer se zav dˆc¡m sektorem
                                                 ; test, zda je ozna‡en¡ "MS DOS"
38a0  2e817f034d53   cmp    cs:[bx+03],534d      ; identifikace "MS"
38a6  750f           jnz    38b7                 ; nen¡ "MS DOS"
38a8  2e817f05444f   cmp    cs:[bx+05],4f44      ; identifikace "DO"
38ae  7507           jnz    38b7                 ; nen¡ "MS DOS"
38b0  2e807f0753     cmp    cs:[bx+07],53        ; identifikace "S"
38b5  7420           jz     38d7                 ; je ozna‡en¡ "MS DOS"
                                                 ; test, zda je ozna‡en¡ "IBM "
38b7  2e817f034942 * cmp    cs:[bx+03],4249      ; identifikace "IB"
38bd  7508           jnz    38c7                 ; nen¡ "IBM "
38bf  2e817f054d20   cmp    cs:[bx+05],204d      ; identifikace "M "
38c5  7410           jz     38d7                 ; je ozna‡en¡ "IBM "
                                                 ; test, zda je ozna‡en¡ "OS2 "
38c7  2e817f034f53 * cmp    cs:[bx+03],534f      ; identifikace "OS"
38cd  751c           jnz    38eb                 ; nen¡ "OS2 "
38cf  2e817f053220   cmp    cs:[bx+05],2032      ; identifikace "2 "
38d5  7514           jnz    38eb                 ; nen¡ "OS2 "
                                                 ; test verze zavadˆ‡e disku "2.0"
38d7  2e817f08322e * cmp    cs:[bx+08],2e32      ; verze "2." ?
38dd  7512           jnz    38f1                 ; nen¡ verze "2.0"
38df  2e807f0a30     cmp    cs:[bx+0a],30        ; podverze "0" ?
38e4  750b           jnz    38f1                 ; nen¡ verze "2.0"
38e6  eb2f           jmp    3917                 ; je verze zavadˆ‡e "2.0"
38e8  e902ff       * jmp    37ed                 ; chyba - velk˜ po‡et v lc–
38eb  e9c400       * jmp    39b2                 ; nezn m˜ typ identifik toru disku
38ee  e9c100         jmp    39b2                 ; je n¡zk  verze zavadˆ‡e disku
                                                 ; nen¡ verze zavadˆ‡e "2.0"
38f1  e88e01       * call   3a82                 ; £prava £daje sektor– pro star¨¡ verze zavadˆ‡e
38f4  2e817f073130   cmp    cs:[bx+07],3031      ; je verze "10" ?
38fa  750a           jnz    3906                 ; nen¡ verze "10"
38fc  2e807f092e     cmp    cs:[bx+09],2e        ; oddˆlova‡ ‡¡sla verze "." ?
3901  7414           jz     3917                 ; je oddˆlova‡ "."
3903  e9ac00         jmp    39b2                 ; je nezn m  verze zavadˆ‡e disku

3906  2e817f08332e   cmp    cs:[bx+08],2e33      ; je verze "3." ?
390c  72e0           jc     38ee                 ; je men¨¡ verze ne‘ "3."
390e  7507           jnz    3917                 ; nen¡ verze "3."
3910  2e807f0a31     cmp    cs:[bx+0a],31        ; je verze "3.1" ?
3915  72d7           jc     38ee                 ; je men¨¡
                                                 ; je verze zavadˆ‡e "2.0" nebo vy¨¨¡
3917  2e803eaa0229 * cmp    cs:[02aa],29         ; je identifik tor s‚riov‚ho ‡¡sla disku ?
391d  7521           jnz    3940                 ; nen¡ s‚riov‚ ‡¡slo disku
391f  2e803e940200   cmp    cs:[0294],00         ; je ud n po‡et aloka‡n¡ch tabulek FAT ?
3925  7519           jnz    3940                 ; je ud n po‡et tabulek FAT
3927  57             push   di                   ; £schova DI (ukazatel parametr– disku)
3928  1e             push   ds                   ; £schova DS
3929  1e             push   ds
392a  07             pop    es                   ; ES <- DS
392b  0e             push   cs
392c  1f             pop    ds                   ; DS <- CS
392d  be8f02         mov    si,028f              ; tabulka parametr– disku
3930  83c706         add    di,0006              ; tabulka parametr– disku
3933  b91900         mov    cx,0019              ; d‚lka tabulky parametr– disku
3936  f3a4           rep    movsb                ; p©enos tabulky parametr– disku
3938  1f             pop    ds                   ; n vrat DS
3939  5f             pop    di                   ; n vrat DI
393a  e8e1d3         call   0d1e                 ; na‡ten¡ identifikace z disku
393d  e92101         jmp    3a61
3940  33d2         * xor    dx,dx                ; DX <- 0000
3942  be8f02         mov    si,028f              ; tabulka parametr– v zav dˆc¡m sektoru disku
3945  2e8b4408       mov    ax,cs:[si+08]        ; celkov˜ po‡et sektor–
3949  3d0000         cmp    ax,0000              ; je ud n po‡et sektor– pomoc¡ 1 slova ?
394c  7508           jnz    3956                 ; je ud n po‡et sektor–
394e  2e8b4415       mov    ax,cs:[si+15]        ; celkov˜ po‡et sektor– - LOW
3952  268b5417       mov    dx,es:[si+17]        ; celkov˜ po‡et sektor– - HIGH
3956  2d0100       * sub    ax,0001              ; maxim ln¡ ‡¡slo sektoru - LOW
3959  83da00         sbb    dx,0000              ; maxim ln¡ ‡¡slo sektoru - LOW
395c  2e8b5c0b       mov    bx,cs:[si+0b]        ; po‡et sektor– v jednom FAT
3960  895d11         mov    [di+11],bx           ; po‡et sektor– v jedn‚ tabulce FAT
3963  d1e3           shl    bx,1                 ; po‡et sektor– v jedn‚ FAT * 2
3965  2bc3           sub    ax,bx                ; - po‡et sektor– FAT -> po‡et datov˜ch sektor– disku
3967  83da00         sbb    dx,0000              ; po‡et datov˜ch sektor– disku (+adres ©)
396a  2e8b5c06       mov    bx,cs:[si+06]        ; max. po‡et polo‘ek z kladn¡ho adres ©e
396e  895d0c         mov    [di+0c],bx           ; max. po‡et polo‘ek z kl. adres ©e
3971  b104           mov    cl,04                ; po‡et rotac¡
3973  d3eb           shr    bx,cl                ; -> po‡et sektor– na adres ©
3975  2bc3           sub    ax,bx                ; -> po‡et datov˜ch sektor– LOW
3977  83da00         sbb    dx,0000              ; -> po‡et datov˜ch sektor– HIGH
397a  33c9           xor    cx,cx                ; CX <- 0000
397c  2e8a4c02       mov    cl,cs:[si+02]        ; velikost aloka‡n¡ho bloku v sektorech
3980  884d08         mov    [di+08],cl           ; po‡et sektor– na aloka‡n¡ blok
3983  50             push   ax                   ; po‡et datov˜ch sektor– - LOW
3984  8bc2           mov    ax,dx                ; po‡et datov˜ch sektor– - HIGH
3986  33d2           xor    dx,dx                ; DX <- 0000
3988  f7f1           div    cx                   ; -> celkov˜ po‡et aloka‡n¡ch blok– - LOW
398a  2ea3890a       mov    cs:[0a89],ax         ; po‡et aloka‡n¡ch blok–
398e  58             pop    ax                   ; po‡et datov˜ch sektor– - LOW
398f  f7f1           div    cx                   ; -> celkov˜ po‡et aloka‡n¡ch blok– - HIGH
3991  2e833e890a00   cmp    cs:[0a89],0000       ; celkov˜ po‡et aloka‡n¡ch blok– LOW = 0 ?
3997  7710           ja     39a9                 ; po‡et alok. blok– je > 0ffffh
3999  3df60f         cmp    ax,0ff6              ; po‡et alok. blok– je > 4086 ?
399c  7205           jc     39a3                 ; je men¨¡ ne‘ 4086
399e  800e143140     or     [3114],40            ; 40=p©¡znak pot©eby tabulky FAT16
39a3  e878d3       * call   0d1e                 ; na‡ten¡ identifikace z disku
39a6  e99700         jmp    3a40
39a9  2e800e143180 * or     cs:[3114],80         ; 80=chyba - bloky nelze adresovat
39af  e9af00         jmp    3a61                 ; konec
39b2  8b551d         mov    dx,[di+1d]           ; celkov˜ po‡et sektor– odd¡lu - HIGH
39b5  8b451b         mov    ax,[di+1b]           ; celkov˜ po‡et sektor– odd¡lu - LOW
39b8  be4c31         mov    si,314c              ; tabulky pro nastaven¡ odd¡l– disku
39bb  2e3b14         cmp    dx,cs:[si]           ; celkov˜ po‡et sektor– odd¡lu - HIGH
39be  720d           jc     39cd                 ; je men¨¡ po‡et - nalezena polo‘ka
39c0  7706           ja     39c8                 ; je vˆt¨¡ po‡et ne‘ povolen˜ - dal¨¡ ukazatel
39c2  2e3b4402       cmp    ax,cs:[si+02]        ; celkov˜ po‡et sektor– odd¡lu - LOW
39c6  7605           jna    39cd                 ; nen¡ vˆt¨¡ po‡et - OK
39c8  83c60a         add    si,000a              ; dal¨¡ ukazatel
39cb  ebee           jmp    39bb
39cd  8a4c08       * mov    cl,[si+08]           ; typ FAT (40=FAT16, 00=FAT12)
39d0  080e1431       or     [3114],cl            ; typ FAT (40=FAT16, 00=FAT12)
39d4  2e8b4c04       mov    cx,cs:[si+04]        ; CH=sektor– na blok, CL=po‡et rotac¡ pro p©epo‡et
39d8  2e8b5406       mov    dx,cs:[si+06]        ; po‡et polo‘ek z kladn¡ho adres ©e
39dc  89550c         mov    [di+0c],dx           ; max. po‡et polo‘ek z kl. adres ©e
39df  8b551d         mov    dx,[di+1d]           ; celkov˜ po‡et sektor– odd¡lu - HIGH
39e2  8b451b         mov    ax,[di+1b]           ; celkov˜ po‡et sektor– odd¡lu - LOW
39e5  886d08         mov    [di+08],ch           ; po‡et sektor– na aloka‡n¡ blok
39e8  f606143140     test   [3114],40            ; je typ FAT16 ?
39ed  751e           jnz    3a0d                 ; je FAT16
                                                 ; zde se vypo‡te po‡et sektor– tabulky FAT12
39ef  33db           xor    bx,bx                ; BX <- 0000
39f1  8add           mov    bl,ch                ; po‡et sektor– na aloka‡n¡ blok
39f3  4b             dec    bx                   ; ‡¡slo posledn¡ho sektoru v alok. bloku
39f4  03d8           add    bx,ax                ; celkov˜ po‡et sektor– - LOW
39f6  d3eb           shr    bx,cl                ; rotace o dan˜ po‡et bit– -> po‡et blok–
39f8  43             inc    bx                   ; celkov˜ po‡et blok– + 1
39f9  80e3fe         and    bl,fe                ; zaokrouhlen¡ na sud‚ ‡¡slo
39fc  8bf3           mov    si,bx                ; celkov˜ po‡et blok–
39fe  d1eb           shr    bx,1                 ; po‡et blok– / 2
3a00  03de           add    bx,si                ; po‡et blok– * 1.5
3a02  81c3ff01       add    bx,01ff              ; zaokrouhlen¡ na cel˜ sektor
3a06  d0ef           shr    bh,1                 ; /2 -> v BH po‡et sektor– na FAT
3a08  887d11         mov    [di+11],bh           ; po‡et sektor– v jedn‚ tabulce FAT
3a0b  eb33           jmp    3a40                 ; p©esko‡en¡ zpracov n¡ FAT16
                                                 ; zde se vypo‡te po‡et sektor– tabulky FAT16
3a0d  b104         * mov    cl,04                ; po‡et rotac¡
3a0f  52             push   dx                   ; celkov˜ po‡et sektor– odd¡lu - HIGH
3a10  8b550c         mov    dx,[di+0c]           ; max. po‡et polo‘ek z kl. adres ©e
3a13  d3ea           shr    dx,cl                ; polo‘ek z kl. adres./16 -> po‡et sektor–
3a15  2bc2           sub    ax,dx                ; ode‡ten¡ sektor– z kl. adres.
3a17  5a             pop    dx                   ; celkov˜ po‡et sektor– odd¡lu - HIGH
3a18  83da00         sbb    dx,0000              ; p©enos do vy¨¨¡ho slova
3a1b  2d0100         sub    ax,0001              ; sn¡‘en¡ o zav dˆc¡ sektor
3a1e  83da00         sbb    dx,0000              ; p©enos do vy¨¨¡ho slova
3a21  b302           mov    bl,02
3a23  8a7d08         mov    bh,[di+08]           ; po‡et sektor– na aloka‡n¡ blok
3a26  03c3           add    ax,bx
3a28  83d200         adc    dx,0000
3a2b  2d0100         sub    ax,0001
3a2e  83da00         sbb    dx,0000
3a31  f7f3           div    bx
3a33  894511         mov    [di+11],ax           ; po‡et sektor– v jedn‚ tabulce FAT
3a36  8a1e1431       mov    bl,[3114]            ; p©¡znak nastaven¡ typu FAT
3a3a  885d1f         mov    [di+1f],bl           ; nastaven¡ typu FAT; 80h=chyba, 40h=je FAT16
3a3d  e84ad1         call   0b8a                 ; nastaven¡ ozna‡en¡ disku v tabulce disku
3a40  8b551d       * mov    dx,[di+1d]           ; celkov˜ po‡et sektor– odd¡lu - HIGH
3a43  8b451b         mov    ax,[di+1b]           ; celkov˜ po‡et sektor– odd¡lu - LOW
3a46  83fa00         cmp    dx,0000              ; je vy¨¨¡ slovo po‡tu sektor– ?
3a49  7716           ja     3a61                 ; je vy¨¨¡ ne‘ 0ffffh sektor–
3a4b  837d1900       cmp    [di+19],0000         ; ‡¡slo po‡ te‡n¡ho rel. sektoru - HIGH
3a4f  7710           ja     3a61                 ; je vy¨¨¡ ne‘ 0ffffh
3a51  034517         add    ax,[di+17]           ; ‡¡slo po‡ te‡n¡ho rel. sektoru - LOW
3a54  720b           jc     3a61                 ; kone‡n˜ rel. sektor odd¡lu > 0ffffh
3a56  8b451b         mov    ax,[di+1b]           ; celkov˜ po‡et sektor– odd¡lu - LOW
3a59  89450e         mov    [di+0e],ax           ; po‡et sektor– na m‚diu pro 1-slovn¡ zad n¡
3a5c  c7451b0000     mov    [di+1b],0000         ; celkov˜ po‡et sektor– odd¡lu - LOW
3a61  837d1d00     * cmp    [di+1d],0000         ; celkov˜ po‡et sektor– odd¡lu - HIGH
3a65  760f           jna    3a76                 ; nen¡ dvouslovn¡ £daj
3a67  06             push   es                   ; £schova ES
3a68  50             push   ax                   ; £schova AX
3a69  b85804         mov    ax,0458              ; segment 2. ‡ sti IO.SYS
3a6c  8ec0           mov    es,ax                ; segment 2. ‡ sti IO.SYS
3a6e  26c606060801   mov    es:[0806],01         ; p©¡znak dvouslovn¡ adresace sektor–
3a74  58             pop    ax                   ; n vrat AX
3a75  07             pop    es                   ; n vrat ES
3a76  8a1e1431     * mov    bl,[3114]            ; p©¡znak nastaven¡ typu FAT
3a7a  885d1f         mov    [di+1f],bl           ; nastaven¡ typu FAT; 80h=chyba, 40h=je FAT16
3a7d  f8             clc                         ; p©¡znak bezchybn‚ operace
3a7e  1f             pop    ds
3a7f  5b             pop    bx
3a80  5f             pop    di
3a81  c3             ret

                                                 ; £prava £daje sektor– pro star¨¡ verze zavadˆ‡e
3a82  50             push   ax
3a83  52             push   dx
3a84  56             push   si
3a85  2e803eaa0229   cmp    cs:[02aa],29         ; identifikace s‚riov‚ho ‡¡sla disku
3a8b  742e           jz     3abb                 ; identifikace OK
3a8d  2e817f073130   cmp    cs:[bx+07],3031      ; je verze "10" ?
3a93  7507           jnz    3a9c                 ; nen¡ verze "10"
3a95  2e807f0a30     cmp    cs:[bx+0a],30        ; je podverze "0" ?
3a9a  751f           jnz    3abb                 ; nen¡ verze "10.0"
3a9c  be8f02       * mov    si,028f              ; tabulka parametr–
3a9f  2e837c0800     cmp    cs:[si+08],0000      ; celkov˜ po‡et sektor– - je £daj 2-slovn¡ ?
3aa4  7415           jz     3abb                 ; je 2-slovn¡ £daj po‡tu sektor–
3aa6  2e8b4408       mov    ax,cs:[si+08]        ; celkov˜ po‡et sektor–
3aaa  2e034411       add    ax,cs:[si+11]        ; p©i‡ten¡ po‡ te‡n¡ho rel. sektoru
3aae  730b           jnc    3abb                 ; nen¡ p©enos do HIGH
3ab0  33c0           xor    ax,ax
3ab2  7507           jnz    3abb
3ab4  2eff4c08       dec    w/cs:[si+08]
3ab8  ff4d1b         dec    w/[di+1b]            ; celkov˜ po‡et sektor– odd¡lu - LOW
3abb  5e           * pop    si
3abc  5a             pop    dx
3abd  58             pop    ax
3abe  c3             ret


3abf  33db         * xor    bx,bx
3ac1  2ec43e4c02     les    di,cs:[024c]
3ac6  83ffff         cmp    di,ffff
3ac9  7501           jnz    3acc
3acb  c3             ret
3acc  06             push   es
3acd  57             push   di
3ace  268a5d22       mov    bl,es:[di+22]        ; typ disku (1=1.2M, 2=720K, 7=nezn m˜)
3ad2  80fb05         cmp    bl,05
3ad5  753f           jnz    3b16
3ad7  33d2           xor    dx,dx
3ad9  268b450e       mov    ax,es:[di+0e]        ; po‡et sektor– na m‚diu pro 1-slovn¡ zad n¡
3add  3d0000         cmp    ax,0000
3ae0  7508           jnz    3aea
3ae2  268b551d       mov    dx,es:[di+1d]        ; celkov˜ po‡et sektor– odd¡lu - HIGH
3ae6  268b451b       mov    ax,es:[di+1b]        ; celkov˜ po‡et sektor– odd¡lu - LOW
3aea  52             push   dx
3aeb  50             push   ax
3aec  268b4515       mov    ax,es:[di+15]        ; po‡et stran m‚dia
3af0  26f76513       mul    w/es:[di+13]         ; po‡et sektor– na stopu
3af4  8bc8           mov    cx,ax
3af6  58             pop    ax
3af7  5a             pop    dx
3af8  50             push   ax
3af9  8bc2           mov    ax,dx
3afb  33d2           xor    dx,dx
3afd  f7f1           div    cx
3aff  2ea3890a       mov    cs:[0a89],ax         ; ‡¡slo po‡ te‡n¡ stopy odd¡lu - HIGH
3b03  58             pop    ax
3b04  f7f1           div    cx
3b06  0bd2           or     dx,dx
3b08  7401           jz     3b0b
3b0a  40             inc    ax
3b0b  26894525       mov    es:[di+25],ax        ; celkov˜ po‡et v lc– na disku
3b0f  06             push   es
3b10  1f             pop    ds
3b11  8d7506         lea    si,[di+06]
3b14  eb40           jmp    3b56
3b16  0e             push   cs
3b17  1f             pop    ds
3b18  2e803e233101   cmp    cs:[3123],01         ; 1=nen¡ disketov  mechanika
3b1e  743e           jz     3b5e
3b20  80fb07         cmp    bl,07
3b23  752a           jnz    3b4f
3b25  33d2           xor    dx,dx
3b27  8b4525         mov    ax,[di+25]           ; celkov˜ po‡et v lc– na disku
3b2a  8b5d36         mov    bx,[di+36]
3b2d  f7e3           mul    bx
3b2f  8b5d34         mov    bx,[di+34]
3b32  f7e3           mul    bx
3b34  89452f         mov    [di+2f],ax
3b37  48             dec    ax
3b38  bb0300         mov    bx,0003
3b3b  f7e3           mul    bx
3b3d  bb0200         mov    bx,0002
3b40  f7f3           div    bx
3b42  33d2           xor    dx,dx
3b44  bb0002         mov    bx,0200
3b47  f7f3           div    bx
3b49  40             inc    ax
3b4a  894532         mov    [di+32],ax
3b4d  eb0f           jmp    3b5e
3b4f  d1e3           shl    bx,1
3b51  bef631         mov    si,31f6
3b54  8b30           mov    si,[bx+si]
3b56  8d7d27         lea    di,[di+27]
3b59  b91900         mov    cx,0019
3b5c  f3a4           rep    movsb
3b5e  5f             pop    di
3b5f  07             pop    es
3b60  268b5d02       mov    bx,es:[di+02]
3b64  268b3d         mov    di,es:[di]
3b67  8ec3           mov    es,bx
3b69  e95aff         jmp    3ac6

þ
                                                 ; na‡ten¡ bloku z disku
                                                 ; VSTUP: DI=ukl dac¡ adresa

3b6c  51             push   cx                   ; po‡et sektor– na aloka‡n¡ blok
3b6d  57             push   di                   ; ukl dac¡ adresa pro ‡ten¡
3b6e  890e1231       mov    [3112],cx            ; ‡¡ta‡ sektor– pro ‡ten¡
3b72  8bc3           mov    ax,bx                ; ‡¡slo bloku pro dal¨¡ operaci
3b74  48             dec    ax
3b75  48             dec    ax                   ; ‡¡slo bloku - 2
3b76  f7e1           mul    cx                   ; * sektor– na blok -> ‡¡slo sektoru
3b78  2e03060e31     add    ax,cs:[310e]         ; relativn¡ sektor za‡ tku dat - LOW
3b7d  2e13161031     adc    dx,cs:[3110]         ; relativn¡ sektor za‡ tku dat - HIGH
3b82  1e             push   ds                   ; £schova DS = 0000
3b83  50             push   ax
3b84  53             push   bx                   ; ‡¡slo bloku
3b85  8b361531       mov    si,[3115]            ; segment pro na‡ten¡ tabulky FAT
3b89  8ede           mov    ds,si                ; segment pro na‡ten¡ tabulky FAT
3b8b  8bf3           mov    si,bx                ; ‡¡slo po‘adovan‚ho bloku
3b8d  2ef606143140   test   cs:[3114],40         ; je tabulka FAT16 ?
3b93  7536           jnz    3bcb                 ; je tabulka FAT16
                                                 ; zde se na‡te tabulka FAT12
3b95  d1ee           shr    si,1                 ; ‡¡slo bloku / 2
3b97  03f3           add    si,bx                ; ‡¡slo bloku * 1.5
3b99  e86600         call   3c02                 ; na‡ten¡ tabulky FAT z disku
3b9c  8b07           mov    ax,[bx]
3b9e  7515           jnz    3bb5
3ba0  8a07           mov    al,[bx]
3ba2  2ea21c31       mov    cs:[311c],al
3ba6  46             inc    si
3ba7  e85800         call   3c02
3baa  a00000         mov    al,[0000]
3bad  2ea21d31       mov    cs:[311d],al
3bb1  2ea11c31       mov    ax,cs:[311c]
3bb5  5b             pop    bx
3bb6  53             push   bx
3bb7  d1eb           shr    bx,1
3bb9  7308           jnc    3bc3
3bbb  d1e8           shr    ax,1
3bbd  d1e8           shr    ax,1
3bbf  d1e8           shr    ax,1
3bc1  d1e8           shr    ax,1
3bc3  8bd8           mov    bx,ax
3bc5  81e3ff0f       and    bx,0fff              ; ‡¡slo n sleduj¡c¡ho bloku
3bc9  eb07           jmp    3bd2
                                                 ; zde je FAT16
3bcb  d1e6         * shl    si,1                 ; SI * 2
3bcd  e83200         call   3c02                 ; na‡ten¡ tabulky FAT z disku
3bd0  8b1f           mov    bx,[bx]              ; ‡¡slo n sleduj¡c¡ho bloku
3bd2  5e           * pop    si
3bd3  58             pop    ax
3bd4  1f             pop    ds
3bd5  2bf3           sub    si,bx
3bd7  83feff         cmp    si,ffff
3bda  7506           jnz    3be2
3bdc  010e1231       add    [3112],cx
3be0  eba0           jmp    3b82
3be2  53             push   bx
3be3  52             push   dx
3be4  50             push   ax
3be5  a10c31         mov    ax,[310c]            ; AL=‡¡slo disku,po‡et disketov˜ch mechanik
3be8  8b0e1231       mov    cx,[3112]            ; po‡et sektor– ke ‡ten¡
3bec  5a             pop    dx
3bed  2e8f068b0a     pop    cs:[0a8b]
3bf2  e8cfd2         call   0ec4                 ; ‡ten¡ dat z disku
3bf5  5b             pop    bx
3bf6  5f             pop    di
3bf7  a11231         mov    ax,[3112]            ; po‡et sektor– ke ‡ten¡
3bfa  86e0           xchg   ah,al                ; = AX * 256
3bfc  d1e0           shl    ax,1                 ; = po‡et bajt– p©e‡ten˜ch dat
3bfe  03f8           add    di,ax                ; nov  ukl dac¡ adresa
3c00  59             pop    cx                   ; n vrat po‡tu sektor– ke ‡ten¡
3c01  c3             ret


þ                                                 ; na‡ten¡ tabulky FAT z disku
3c02  50             push   ax
3c03  51             push   cx
3c04  52             push   dx
3c05  57             push   di
3c06  56             push   si
3c07  06             push   es
3c08  1e             push   ds
3c09  33d2           xor    dx,dx
3c0b  8bc6           mov    ax,si
3c0d  2e8b0e1a31     mov    cx,cs:[311a]         ; po‡et bajt– na sektor
3c12  f7f1           div    cx
3c14  40             inc    ax
3c15  2e3b061e31     cmp    ax,cs:[311e]
3c1a  7422           jz     3c3e
3c1c  2ea31e31       mov    cs:[311e],ax
3c20  52             push   dx
3c21  2ec7068b0a0000 mov    cs:[0a8b],0000
3c28  8bd0           mov    dx,ax
3c2a  b90100         mov    cx,0001
3c2d  2ea10c31       mov    ax,cs:[310c]         ; po‡et disketov˜ch mechanik
3c31  1e             push   ds
3c32  07             pop    es
3c33  33ff           xor    di,di
3c35  e88cd2         call   0ec4                 ; ‡ten¡ dat z disku
3c38  5a             pop    dx
3c39  2e8b0e1a31     mov    cx,cs:[311a]         ; po‡et bajt– na sektor
3c3e  49             dec    cx
3c3f  3bd1           cmp    dx,cx
3c41  8bda           mov    bx,dx
3c43  1f             pop    ds
3c44  07             pop    es
3c45  5e             pop    si
3c46  5f             pop    di
3c47  5a             pop    dx
3c48  59             pop    cx
3c49  58             pop    ax
3c4a  c3             ret

; -----------------------------------------------------------------------------

                                                 ; inicializace portu LPT
                                                 ; VSTUP: SI=z hlav¡ za©¡zen¡

3c4b  e80f00       * call   3c5d                 ; nastaven¡ ‡¡sla portu LPT
3c4e  b401           mov    ah,01                ; funkce inicializace tisk rny
3c50  cd17           int    17                   ; inicializace tisk rny
3c52  c3             ret

                                                 ; inicializace portu COM
                                                 ;  (2400 Baud, bez parity,
                                                 ;  jeden stop-bit, 8 datov˜ch bit–)
                                                 ; VSTUP: SI=z hlav¡ za©¡zen¡

3c53  e80700       * call   3c5d                 ; nastaven¡ ‡¡sla portu COM
3c56  b0a3           mov    al,a3                ; parametry
3c58  b400           mov    ah,00                ; funkce inicializace portu COM
3c5a  cd14           int    14                   ; inicializace portu COM
3c5c  c3             ret

                                                 ; nastaven¡ ‡¡sla portu COM, LPT
3c5d  2e8a440d     * mov    al,cs:[si+0d]        ; ‡¡slo ASCII portu COM, LPT
3c61  2c31           sub    al,31                ; korekce na ‡¡slo
3c63  98             cbw                         ; AX <- AL
3c64  8bd0           mov    dx,ax                ; ‡¡slo portu COM, LPT
3c66  c3             ret

; -----------------------------------------------------------------------------

                                                 ; vynulov n¡ ‡ st¡ programu pro
                                                 ; indikaci v˜mˆny m‚dia

3c67  1e           * push   ds                   ; £schova DS
3c68  06             push   es                   ; £schova ES
3c69  0e             push   cs
3c6a  07             pop    es                   ; ES <- CS
3c6b  0e             push   cs
3c6c  1f             pop    ds                   ; DS <- CS
3c6d  befc31         mov    si,31fc              ; za‡ tek tabulky nulov n¡ programu
3c70  ad           * lodsw                       ; po‡et bajt– k vynulov n¡
3c71  8bc8           mov    cx,ax                ; po‡et bajt– k vynulov n¡
3c73  e309           jcxz   3c7e                 ; je ji‘ konec tabulky
3c75  ad             lodsw                       ; adresa k vynulov n¡ progamu
3c76  8bf8           mov    di,ax                ; adresa k vynulov n¡ progamu
3c78  b090           mov    al,90                ; instrukce NOP k vynulov n¡ porgramu
3c7a  f3aa           rep    stosb                ; vynulov n¡ ‡ sti programu
3c7c  ebf2           jmp    3c70                 ; dal¨¡ adresa programu
3c7e  bf1e00       * mov    di,001e              ; adresa otev©en¡ a uzav©en¡ diskov‚ho za©¡zen¡
3c81  b8f706         mov    ax,06f7              ; n vratov  adresa
3c84  ab             stosw                       ; zru¨en¡ funkce otev©en¡ diskov‚ho za©¡zen¡
3c85  ab             stosw                       ; zru¨en¡ funkce uzav©en¡ diskov‚ho za©¡zen¡
3c86  07             pop    es                   ; n vrat ES
3c87  1f             pop    ds                   ; n vrat DS
3c88  c3             ret


                                                 ; inicializace tabulek odd¡l– pevn˜ch disk–
3c89  0e             push   cs
3c8a  07             pop    es
3c8b  0e             push   cs
3c8c  1f             pop    ds
3c8d  50             push   ax
3c8e  bf1824         mov    di,2418              ; tabulka logick˜ch disk–
3c91  b280           mov    dl,80                ; prvn¡ pevn˜ disk
3c93  b408           mov    ah,08                ; funkce poskytnut¡ parametr– disku
3c95  cd13           int    13                   ; poskytnut¡ diskov˜ch parametr–
3c97  80fa00         cmp    dl,00                ; jsou nˆjak‚ pevn‚ disky ?
3c9a  7451           jz     3ced                 ; nen¡ ‘ dn˜ pevn˜ disk - konec
3c9c  88169431       mov    [3194],dl            ; po‡et pevn˜ch disk– v syst‚mu
3ca0  33c0           xor    ax,ax                ; AX <- 0000
3ca2  a0c001         mov    al,[01c0]            ; celkov˜ po‡et disk–
3ca5  a29531         mov    [3195],al            ; celkov˜ po‡et disk–
3ca8  d1e0           shl    ax,1                 ; celkov˜ po‡et disk– * 2
3caa  53             push   bx                   ; £schova BX
3cab  bb4c1d         mov    bx,1d4c              ; tabulka adres BPB disk–
3cae  03d8           add    bx,ax                ; adresa BPB posledn¡ho pevn‚ho disku
3cb0  891e9c31       mov    [319c],bx            ; adresa BPB v tabulce za posledn¡m diskem
3cb4  5b             pop    bx
3cb5  c606973180     mov    [3197],80            ; ‡¡slo 1. disku = pevn˜ disk 80h
3cba  fec6         * inc    dh                   ; po‡et hlav disku
3cbc  33c0           xor    ax,ax                ; AX <- 0000
3cbe  8ac6           mov    al,dh                ; po‡et hlav disku
3cc0  a39831         mov    [3198],ax            ; po‡et hlav pevn‚ho disku
3cc3  33c0           xor    ax,ax                ; AX <- 0000
3cc5  80e13f         and    cl,3f                ; po‡et sektor– na stopu
3cc8  8ac1           mov    al,cl                ; po‡et sektor– na stopu
3cca  a39a31         mov    [319a],ax            ; po‡et sektor– na stopu
3ccd  8a169731       mov    dl,[3197]            ; ‡¡slo pevn‚ho disku
3cd1  e8aafa         call   377e                 ; na‡ten¡ zav dˆc¡ho sektoru pevn‚ho disku
3cd4  7203           jc     3cd9                 ; chyba na‡ten¡ zav dˆc¡ho sektoru
3cd6  e81600         call   3cef                 ; vytvo©en¡ tabulek disk– pro odd¡ly pevn‚ho disku
3cd9  fe0e9431     * dec    b/[3194]             ; po‡et pevn˜ch disk– v syst‚mu
3cdd  740e           jz     3ced                 ; nen¡ ji‘ dal¨¡ pevn˜ disk
3cdf  fe069731       inc    b/[3197]             ; zv˜¨en¡ ‡¡sla pevn‚ho disku
3ce3  8a169731       mov    dl,[3197]            ; ‡¡slo pevn‚ho disku
3ce7  b408           mov    ah,08                ; funkce poskytnut¡ parametr– disku
3ce9  cd13           int    13                   ; poskytnut¡ diskov˜ch parametr–
3ceb  ebcd           jmp    3cba                 ; inicializace tabulek dal¨¡ho pevn‚ho disku
3ced  58           * pop    ax                   ; konec
3cee  c3             ret

                                                 ; vytvo©en¡ tabulek disk– pro odd¡ly pevn‚ho disku
                                                 ; ES:BX zavadˆ‡ pevn‚ho disku

3cef  81c3c201     * add    bx,01c2              ; typ tabulky FAT - 1. odd¡l
3cf3  26803f05     * cmp    es:[bx],05           ; je typ FAT 5 ?
3cf7  740c           jz     3d05                 ; je FAT typu 5
3cf9  83c310         add    bx,0010              ; dal¨¡ odd¡l disku
3cfc  81fb0204       cmp    bx,0402              ; byl to ji‘ posledn¡ odd¡l ?
3d00  75f1           jnz    3cf3                 ; nebyl - dal¨¡ odd¡l
3d02  e99300         jmp    3d98                 ; nen¡ ‘ dn˜ odd¡l s typem FAT = 5
                                                 ; zde byl nalezen odd¡l s typem FAT = 5
3d05  33c0         * xor    ax,ax                ; AX <- 0000
3d07  0c01           or     al,01                ; AX <- 0001
3d09  094523         or     [di+23],ax           ; nastaven¡ bitu 0
3d0c  c6452205       mov    [di+22],05           ; typ disku 05 = pevn˜ disk
3d10  c606143100     mov    [3114],00            ; je typ FAT12
3d15  a19831         mov    ax,[3198]            ; po‡et hlav pevn‚ho disku
3d18  894515         mov    [di+15],ax           ; po‡et stran m‚dia
3d1b  a19a31         mov    ax,[319a]            ; po‡et sektor– na stopu
3d1e  894513         mov    [di+13],ax           ; po‡et sektor– na stopu
3d21  a09731         mov    al,[3197]            ; ‡¡slo pevn‚ho disku
3d24  884504         mov    [di+04],al           ; fyzick˜ disk = pevn˜ disk
3d27  a09531         mov    al,[3195]            ; celkov˜ po‡et disk–
3d2a  884505         mov    [di+05],al           ; logick˜ disk
3d2d  26837f0a00     cmp    es:[bx+0a],0000      ; po‡et sektor– odd¡lu - HIGH
3d32  7707           ja     3d3b                 ; je 2 slovn¡ £daj po‡tu sektor–
3d34  26837f0840     cmp    es:[bx+08],0040      ; po‡et sektor– odd¡lu - LOW
3d39  725d           jc     3d98                 ; je men¨¡ ne‘ 64 sektor– - chyba
3d3b  83eb04         sub    bx,0004              ; adresa za‡ tku tabulky odd¡lu
3d3e  268a7702       mov    dh,es:[bx+02]        ; sektor za‡ tku odd¡lu
3d42  80e6c0         and    dh,c0                ; vy¨¨¡ 2 bity ‡¡sla stopy
3d45  d0c6           rol    dh,1
3d47  d0c6           rol    dh,1                 ; DH-vy¨¨¡ 2 bity ‡¡sla stopy
3d49  268a5703       mov    dl,es:[bx+03]        ; stopa za‡ tku odd¡lu
3d4d  895549         mov    [di+49],dx           ; po‡ te‡n¡ stopa odd¡lu pevn‚ho disku
3d50  268b4f02       mov    cx,es:[bx+02]        ; ‡¡slo v lce a ‡¡slo sektoru za‡ tku odd¡lu
3d54  268a7701       mov    dh,es:[bx+01]        ; ‡¡slo hlavy za‡ tku odd¡lu
3d58  8a169731       mov    dl,[3197]            ; ‡¡slo pevn‚ho disku
3d5c  bb0002         mov    bx,0200              ; buffer pro na‡ten¡ sektoru zavadˆ‡e pevn‚ho disku
3d5f  b80102         mov    ax,0201              ; funkce pro na‡ten¡ sektoru
3d62  cd13           int    13                   ; na‡ten¡ zav dˆc¡ho sektoru pevn‚ho disku
3d64  7232           jc     3d98                 ; chyba ‡ten¡ sektoru
3d66  bbc203         mov    bx,03c2              ; typ FAT odd¡lu 1
3d69  06             push   es
3d6a  e82c00         call   3d99                 ;
3d6d  07             pop    es
3d6e  7225           jc     3d95                 ; chyba
                                                 ; zde se za‡len¡ disk do tabulek disk–
3d70  e82c00         call   3d9f                 ; za©azen¡ disku do tabulky disk–
3d73  fe069531       inc    b/[3195]             ; zv˜¨en¡ celkov‚ho po‡tu disk–
3d77  fe069631       inc    b/[3196]             ; zv˜¨en¡ po‡tu odd¡l– na pevn‚m disku
3d7b  53             push   bx                   ; £schova BX
3d7c  8b1e9c31       mov    bx,[319c]            ; adresa v tabulce BPB za posledn¡m diskem
3d80  8d7506         lea    si,[di+06]           ; adresa BPB tohoto disku
3d83  8937           mov    [bx],si              ; nastaven¡ adresy BPB v tabulce adres BPB
3d85  ff069c31       inc    w/[319c]             ; zv˜¨en¡ ukazatele na konec tabulky BPB
3d89  ff069c31       inc    w/[319c]             ; zv˜¨en¡ ukazatele na konec tabulky BPB
3d8d  5b             pop    bx                   ; n vrat BX
3d8e  83c764         add    di,0064              ; zv˜¨en¡ ukazatele na n sleduj¡c¡ disk
3d91  893e9231       mov    [3192],di            ; adresa n sleduj¡c¡ nepou‘it‚ tabulky disku
3d95  e95bff       * jmp    3cf3

3d98  c3           * ret

3d99  57             push   di
3d9a  53             push   bx
3d9b  1e             push   ds
3d9c  e933fa         jmp    37d2


                                                 ; za©azen¡ disku do tabulky disk–
                                                 ; VSTUP: DS:DI=adresa tabulky disku

3d9f  50           * push   ax                   ; £schova AX
3da0  56             push   si                   ; £schova SI
3da1  06             push   es                   ; £schova ES
3da2  2ec4364c02     les    si,cs:[024c]         ; adresa tabulky 1. diskov‚ jednotky
3da7  26833cff     * cmp    es:[si],ffff         ; nalezen ji‘ posledn¡ disk v tabulce ?
3dab  740b           jz     3db8                 ; nalezen posledn¡ disk v tabulce
3dad  268b34         mov    si,es:[si]           ; offset adresy n sleduj¡c¡ho disku
3db0  268b4402       mov    ax,es:[si+02]        ; segment adresy n sleduj¡c¡ho disku
3db4  8ec0           mov    es,ax                ; segment adresy n sleduj¡c¡ho disku
3db6  ebef           jmp    3da7                 ; dal¨¡ disk v tabulce
3db8  8cd8         * mov    ax,ds                ; segment adresy nov‚ho disku
3dba  894502         mov    [di+02],ax           ; nastaven¡ segmentu tohoto disku
3dbd  26894402       mov    es:[si+02],ax        ; nastaven¡ segmentu n sleduj¡c¡ho disku
3dc1  26893c         mov    es:[si],di           ; odkaz na adresu nov‚ho disku
3dc4  c705ffff       mov    [di],ffff            ; ozna‡en¡ nov‚ho disku jako posledn¡ disk
3dc8  07             pop    es                   ; n vrat ES
3dc9  5e             pop    si                   ; n vrat SI
3dca  58             pop    ax                   ; n vrat AX
3dcb  c3             ret

; -----------------------------------------------------------------------------
;                      Inicializace syst‚mov˜ch hodin
; -----------------------------------------------------------------------------

                                                 ; inicializace syst‚mov˜ch hodin
                                                 ; - pokud jsou p©i ‡ten¡ hodin
                                                 ; navr ceny registry = 0 je
                                                 ; buƒ ‡as po p–lnoci nebo
                                                 ; hodiny nebˆ‘¡. Proto se provede
                                                 ; po chvilce je¨tˆ druh‚ ‡ten¡
3dcc  50           * push   ax
3dcd  51             push   cx
3dce  52             push   dx
3dcf  55             push   bp
3dd0  33ed           xor    bp,bp                ; ‡¡ta‡ pokus– o ‡ten¡ ‡asu
3dd2  33c9         * xor    cx,cx                ; po‡ te‡n¡ nastaven¡ CX=0
3dd4  33d2           xor    dx,dx                ; po‡ te‡n¡ nastaven¡ DX=0
3dd6  b402           mov    ah,02                ; funkce ‡ten¡ re ln‚ho ‡asu
3dd8  cd1a           int    1a                   ; ‡ten¡ re ln‚ho ‡asu
3dda  83f900         cmp    cx,0000              ; je ‡as 00:00 ?
3ddd  7512           jnz    3df1                 ; nen¡ - pokra‡ov n¡
3ddf  83fa00         cmp    dx,0000              ; jsou sekundy tak‚ 00.00 ?
3de2  750d           jnz    3df1                 ; nejsou - pokra‡ov n¡
3de4  83fd01         cmp    bp,0001              ; ‡¡ta‡ pokus– o ‡ten¡ ‡asu
3de7  741c           jz     3e05                 ; byl ji‘ druh˜ pokus - konec
3de9  45             inc    bp                   ; bude dal¨¡ ‡ten¡
3dea  b90040         mov    cx,4000              ; doba prodlevy
3ded  e2fe         * loop   3ded                 ; prodleva
3def  ebe1           jmp    3dd2                 ; druh˜ pokus o ‡ten¡ ‡asu
3df1  2ec6065a0901 * mov    cs:[095a],01         ; p©¡znak - hodiny bˆ‘¡
3df7  e81000         call   3e0a                 ; inicializace hodin CMOS
3dfa  56             push   si                   ; £schova SI
3dfb  e857f1         call   2f55                 ; zji¨tˆn¡ po‡tu dn– od 1.1.1980
3dfe  fa             cli                         ; z kaz p©eru¨en¡
3dff  89362806       mov    [0628],si            ; po‡et dn– od 1.1.1980
3e03  fb             sti                         ; povolen¡ p©eru¨en¡
3e04  5e             pop    si
3e05  5d           * pop    bp
3e06  5a             pop    dx
3e07  59             pop    cx
3e08  58             pop    ax
3e09  c3             ret

                                                 ; inicializace hodin CMOS

3e0a  50           * push   ax                   ; £schova AX
3e0b  2e803e0c1dfc   cmp    cs:[1d0c],fc         ; ‡¡slo syst‚mov‚ho modelu po‡¡ta‡e
3e11  7525           jnz    3e38                 ; nen¡ po‡¡ta‡ AT (=nejsou hodiny CMOS)
3e13  2e803e0d1d06   cmp    cs:[1d0d],06         ; ‡¡slo podmodelu=06 ?
3e19  7408           jz     3e23                 ; je podmodel 06
3e1b  2e803e0d1d04   cmp    cs:[1d0d],04         ; ‡¡slo podmodelu
3e21  7315           jnc    3e38                 ; je podmodel 04 nebo vy¨¨¡ - nepot©ebuje inicializaci
3e23  b08a         * mov    al,8a                ; adresa - stavov˜ registr hodin
3e25  b426           mov    ah,26                ; nastaven¡ rychlosti dˆli‡ky
3e27  e83000         call   3e5a                 ; z pis dat do pamˆti CMOS
3e2a  b08b           mov    al,8b                ; adresa - stavov˜ registr hodin
3e2c  e80b00         call   3e3a                 ; ‡ten¡ dat z pamˆti CMOS
3e2f  2407           and    al,07                ; z kaz v¨ech p©eru¨en¡
3e31  8ae0           mov    ah,al                ; nov  hodnota stavov‚ho bajtu
3e33  b00b           mov    al,0b                ; adresa - stavov˜ registr hodin
3e35  e82200         call   3e5a                 ; z pis dat do pamˆti CMOS
3e38  58           * pop    ax                   ; n vrat AX
3e39  c3             ret

                                                 ; ‡ten¡ dat z pamˆti CMOS
                                                 ; VSTUP: AL=adresa
                                                 ; VSTUP:AL=data

3e3a  9c           * pushf                       ; F do z sobn¡ku (pro instrukci IRET)
3e3b  fa             cli                         ; z kaz p©eru¨en¡
3e3c  53             push   bx                   ; £schova BX
3e3d  50             push   ax                   ; £schova AX
3e3e  0c80           or     al,80                ; z kaz NMI
3e40  e670           out    [70],al              ; nastaven¡ adresy CMOS
3e42  90             nop                         ; ust len¡ dat
3e43  e471           in     al,[71]              ; p©e‡ten¡ obsahu pamˆti CMOS
3e45  8bd8           mov    bx,ax                ; £schova p©e‡ten˜ch dat
3e47  58             pop    ax                   ; n vrat AX
3e48  2480           and    al,80                ; p–vodn¡ hodnota NMI
3e4a  0c0f           or     al,0f                ; adresa 0FH
3e4c  e670           out    [70],al              ; nastaven¡ adresy 0FH
3e4e  90             nop                         ; ust len¡ dat
3e4f  e471           in     al,[71]              ; ‡ten¡ stavov‚ho bajtu p©eru¨en¡
3e51  8bc3           mov    ax,bx                ; n vrat p©e‡ten˜ch dat
3e53  5b             pop    bx                   ; n vrat registru BX
3e54  0e             push   cs                   ; CS -> z sobn¡k (pro instrukci IRET)
3e55  e80100         call   3e59                 ; proveden¡ instrukce IRET (pro n vrat registru F)
3e58  c3             ret

3e59  cf           * iret

                                                 ; z pis dat do pamˆti CMOS
                                                 ; VSTUP: AL=adresa, AH=data

3e5a  9c           * pushf                       ; £schova F pro instrukci IRET
3e5b  50             push   ax                   ; £schova AX
3e5c  fa             cli                         ; z kaz p©eru¨en¡
3e5d  50             push   ax                   ; £schova AX (adresa)
3e5e  0c80           or     al,80                ; z kaz p©eru¨en¡ NMI, adresa v AL
3e60  e670           out    [70],al              ; nastaven¡ adresy CMOS
3e62  90             nop                         ; ust len¡ dat
3e63  8ac4           mov    al,ah                ; bajt k z pisu do CMOS
3e65  e671           out    [71],al              ; z pis dat do CMOS pamˆti
3e67  58             pop    ax                   ; n vrat adresy v CMOS
3e68  2480           and    al,80                ; po‘adovan‚ nastaven¡ NMI
3e6a  0c0f           or     al,0f                ; adresa 0fh
3e6c  e670           out    [70],al              ; nastaven¡ adresy 0FH
3e6e  90             nop                         ; ust len¡ dat
3e6f  e471           in     al,[71]              ; ‡ten¡ stavov‚ho bajtu p©eru¨en¡
3e71  58             pop    ax                   ; n vrat nastaven¡ AX
3e72  0e             push   cs                   ; CS -> z sobn¡k (pro instrukci IRET)
3e73  e8e3ff         call   3e59                 ; proveden¡ instrukce IRET (n vrat registru F)
3e76  c3             ret

; -----------------------------------------------------------------------------

                                                 ; za‡ tek 2. ‡ sti IO.SYS
3e77               *
